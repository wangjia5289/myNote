

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/ba.jpg">
  <link rel="icon" href="/img/ba.jpg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#373737">
  <meta name="author" content="霸天">
  <meta name="keywords" content="">
  
    <meta name="description" content="一、理论1. 导图：Map：ElasticSearch 2. ElasticSearch 概述elasticsearch是一款非常强大的开源搜索引擎，可以帮助我们从海量数据中快速找到需要的内容  3. ES 语法 3.3. 索引命令3.3.1. 创建索引3.3.1.1. 创建索引考虑事项 &#x3D;&#x3D;索引库名称&#x3D;&#x3D;： ES索引通常对应数据库中的一张表，一个表根据业务">
<meta property="og:type" content="article">
<meta property="og:title" content="笔记：ElasticSearch 基础">
<meta property="og:url" content="https://wangjia5289.github.io/2025/04/13/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/index.html">
<meta property="og:site_name" content="夜阑卧听风吹雨,一枝梨花压心头">
<meta property="og:description" content="一、理论1. 导图：Map：ElasticSearch 2. ElasticSearch 概述elasticsearch是一款非常强大的开源搜索引擎，可以帮助我们从海量数据中快速找到需要的内容  3. ES 语法 3.3. 索引命令3.3.1. 创建索引3.3.1.1. 创建索引考虑事项 &#x3D;&#x3D;索引库名称&#x3D;&#x3D;： ES索引通常对应数据库中的一张表，一个表根据业务">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250427210357524.png">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250416201625864.png">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250417090125699.png">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250417102403638.png">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250501142642453.png">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250417121921514.png">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/PixPin_2025-04-27_11-26-54_PhotoGrid.png">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/PixPin_2025-04-27_11-22-54_PhotoGrid.png">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250418184544203.png">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250417122657685.png">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250417122752564.png">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250417122922783.png">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250416192542363.png">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250416192834497.png">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250416194752833.png">
<meta property="article:published_time" content="2025-04-12T16:00:00.000Z">
<meta property="article:modified_time" content="2025-06-28T09:31:50.810Z">
<meta property="article:author" content="Ba Tian">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250427210357524.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>笔记：ElasticSearch 基础 - 夜阑卧听风吹雨,一枝梨花压心头</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"wangjia5289.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 100vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/%E3%80%90%E5%93%B2%E9%A3%8E%E5%A3%81%E7%BA%B8%E3%80%91%E5%85%89%E5%BD%B1%E7%BE%8E%E5%AD%A6-%E5%90%8A%E5%B8%A6%E8%A3%99.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="笔记：ElasticSearch 基础"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-04-13 00:00" pubdate>
          April 13, 2025 am
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          18k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          150 mins
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> views
        </span>
        

      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">笔记：ElasticSearch 基础</h1>
            
              <p id="updated-time" class="note note-info" style="display: none">
                
                  
                    Last updated on 2025-06-28T17:31:50+08:00
                  
                  

                
              </p>
            
            
              <div class="markdown-body">
                
                <h1 id="一、理论"><a href="#一、理论" class="headerlink" title="一、理论"></a>一、理论</h1><h3 id="1-导图：Map：ElasticSearch"><a href="#1-导图：Map：ElasticSearch" class="headerlink" title="1. 导图：Map：ElasticSearch"></a>1. 导图：<a href="../../maps/Map%EF%BC%9AElasticSearch.xmind">Map：ElasticSearch</a></h3><hr>
<h3 id="2-ElasticSearch-概述"><a href="#2-ElasticSearch-概述" class="headerlink" title="2. ElasticSearch 概述"></a>2. ElasticSearch 概述</h3><p>elasticsearch是一款非常强大的开源搜索引擎，可以帮助我们从海量数据中快速找到需要的内容</p>
<hr>
<h3 id="3-ES-语法"><a href="#3-ES-语法" class="headerlink" title="3. ES 语法"></a>3. ES 语法</h3><hr>
<h4 id="3-3-索引命令"><a href="#3-3-索引命令" class="headerlink" title="3.3. 索引命令"></a>3.3. 索引命令</h4><h5 id="3-3-1-创建索引"><a href="#3-3-1-创建索引" class="headerlink" title="3.3.1. 创建索引"></a>3.3.1. 创建索引</h5><h6 id="3-3-1-1-创建索引考虑事项"><a href="#3-3-1-1-创建索引考虑事项" class="headerlink" title="3.3.1.1. 创建索引考虑事项"></a>3.3.1.1. 创建索引考虑事项</h6><ol>
<li>&#x3D;&#x3D;索引库名称&#x3D;&#x3D;：<ol>
<li>ES索引通常对应数据库中的一张表，一个表根据业务需求可以对应多个ES索引</li>
<li>这里是一个模版：<ol>
<li><code>[项目名]_[表名] _ [业务名] _ [时间分片] _ [环境标识]</code>，例如： <code>myproject_order_transaction_20250427_prod</code></li>
<li><font color="#00b0f0">表名</font>：<ol>
<li>使用数据库表名的简化版或直接版</li>
<li>表名较短时可直接使用，如 <code>t_user</code> → <code>user</code>；</li>
<li>表名较长时可适当简化</li>
</ol>
</li>
<li><font color="#00b0f0">业务名</font>：<ol>
<li>表示索引解决的具体业务，如 <code>email</code>、<code>profile</code>、<code>address</code> 等</li>
</ol>
</li>
<li><font color="#00b0f0">时间分片</font>：<ol>
<li>便于管理大规模数据，如订单表每年10亿数据，可以按月、周、日进行分片</li>
</ol>
</li>
<li><font color="#00b0f0">环境标识</font>：<ol>
<li>用于区分不同环境，如 <code>local</code>、<code>dev</code>、<code>test</code>、<code>perf</code>、<code>prod</code> 等</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>&#x3D;&#x3D;分片和副本数量&#x3D;&#x3D;</li>
<li>&#x3D;&#x3D;自定义分词器&#x3D;&#x3D;：<ol>
<li>分词器通常由三部分组成：<code>character filter</code>、<code>tokenizer</code> 和 <code>tokenizer filter</code>（简称 <code>filter</code>）</li>
<li>因此，在自定义分词器时，通常先分别自定义 <code>char_filter</code>、<code>tokenizer</code> 和 <code>filter</code>，然后再基于这些组件创建自定义的 <code>analyzer</code>。</li>
<li>当然，自定义分词器并不一定要包含所有三种组件，具体可以根据实际需求选择其中两种或全部三种进行配置</li>
</ol>
</li>
<li>&#x3D;&#x3D;刷新时间&#x3D;&#x3D;：</li>
<li>&#x3D;&#x3D;字段定义&#x3D;&#x3D;：<ol>
<li><font color="#00b0f0">字段名称</font>：<ol>
<li>通常与数据库字段名保持一致</li>
</ol>
</li>
<li><font color="#00b0f0">字段数据类型</font>：<ol>
<li>参照 <a target="_blank" rel="noopener" href="https://blog.wangjia.xin/2025/04/12/%E7%AC%94%E8%AE%B0%EF%BC%9A%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%92%8C%E4%BC%A0%E5%8F%82/#MySQL-ES">笔记：数据类型和传参</a></li>
</ol>
</li>
<li><font color="#00b0f0">插入文档时使用的分词器</font>：<ol>
<li>用于对文档内容进行分词，一般是使用自定义分词器</li>
<li>主要适用于 <code>text</code> 类型字段，非 <code>text</code> 字段无需且不能指定分词器，不打算使用这个 <code>text</code> 检索，也不需要指定分词器</li>
</ol>
</li>
<li><font color="#00b0f0">查询文档时使用的分词器</font>：<ol>
<li>用于对搜索内容进行分词，一般是使用 <code>ik_smart</code> 和 <code>ik_max_word</code></li>
<li>如果未显式指定，则默认使用该字段插入文档时使用的分词器</li>
</ol>
</li>
<li><font color="#00b0f0">是否为该字段创建倒排索引库</font>：<ol>
<li>如果只打算通过 <code>all</code> 字段进行搜索，而不需要对该字段进行精确查询，可以设置 <code>index: false</code>，以避免为该字段单独建立倒排索引，节省存储空间和索引构建时间。</li>
</ol>
</li>
<li><font color="#00b0f0">其他的 Mapping 属性</font><ol>
<li>参照 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/8.18/mapping-params.html">ElasticSearch 文档</a></li>
</ol>
</li>
</ol>
</li>
</ol>
<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>一个索引库中并非只存在一份倒排索引，每个字段在设置了 <code>index: true</code> 后，都会单独创建一份倒排索引：<ul>
<li>各字段的倒排索引分别收集该字段在所有文档中的内容</li>
<li>搜索时，实际是通过每个字段对应的倒排索引查找匹配的文档，并按相关性打分，从高到低返回对应的文档 ID，最终返回文档内容</li>
</ul>
</li>
<li>为了简化跨字段搜索，我们通常会使用 <code>copy_to</code> 将多个字段的内容复制到一个统一的字段（如 <code>all</code> 字段），实现“一网打尽式”的搜索。但这种方式也带来一些问题：<ul>
<li><font color="#00b0f0">不该分词的字段分词了</font>：<ul>
<li><code>all</code> 字段通常是 <code>text</code> 类型，会进行分词处理。如果将 <code>keyword</code> 类型的字段内容也 <code>copy_to</code> 到 <code>all</code> 字段，它们在 <code>all</code> 中会被分词，破坏了原本用于精确匹配的特性，完全背离了它精确匹配的初衷</li>
<li>为了规避这种混乱，我们可以：<ul>
<li>可以将 <code>keyword</code> 字段复制到 <code>all</code> 字段，但自身仍保留独立索引（<code>index: true</code>）</li>
<li>精确查询时使用原字段，全文搜索时使用 <code>all</code> 字段，各司其职，互不干扰</li>
</ul>
</li>
</ul>
</li>
<li><font color="#00b0f0">索引浪费问题</font>：<ul>
<li>如果仅通过 <code>all</code> 字段进行搜索，而其他字段不进行单独查询，则可以将这些字段的 <code>index</code> 属性设置为 <code>false</code>，避免为每个字段建立独立的倒排索引，从而节省存储和提升索引效率。</li>
</ul>
</li>
</ul>
</li>
</ol>
</blockquote>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs applescript">PUT /&lt;索引库名称&gt;                                       <span class="hljs-comment"># 索引库名称</span><br>&#123;<br>    <span class="hljs-string">&quot;settings&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;number_of_shards&quot;</span>: <span class="hljs-number">3</span>,                         <span class="hljs-comment"># 分片数量</span><br>        <span class="hljs-string">&quot;number_of_replicas&quot;</span>: <span class="hljs-number">1</span>,                       <span class="hljs-comment"># 每个分片的副本数量</span><br>        <span class="hljs-string">&quot;refresh_interval&quot;</span>: <span class="hljs-string">&quot;1s&quot;</span>,                      <span class="hljs-comment"># 刷新时间</span><br>        <span class="hljs-string">&quot;analysis&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;char_filter&quot;</span>: &#123;                           <span class="hljs-comment"># 自定义 character filter</span><br>                <span class="hljs-string">&quot;my_char_filter&quot;</span>: &#123;<br>                &#125;<br>            &#125;,<br>            <span class="hljs-string">&quot;tokenizer&quot;</span>: &#123;                             <span class="hljs-comment"># 自定义 tokenizer</span><br>                <span class="hljs-string">&quot;my_tokenizer&quot;</span>: &#123;<br>                &#125;<br>            &#125;,<br>            <span class="hljs-string">&quot;filter&quot;</span>: &#123;                                <span class="hljs-comment"># 自定义 tokenizer filter</span><br>                <span class="hljs-string">&quot;my_tokenizer_filter&quot;</span>: &#123;<br>                &#125;<br>            &#125;,<br>            <span class="hljs-string">&quot;analyzer&quot;</span>: &#123;                              <span class="hljs-comment"># 自定义过滤器</span><br>                <span class="hljs-string">&quot;my_analyzer&quot;</span> : &#123;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;,<br>    <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;&lt;字段名1&gt;&quot;</span>: &#123;                              <span class="hljs-comment"># 字段名称</span><br>                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;&lt;字段数据类型&gt;&quot;</span>,<br>                <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;&lt;插入文档时使用的分词器&gt;&quot;</span>,<br>                <span class="hljs-string">&quot;search_analyzer&quot;</span>: <span class="hljs-string">&quot;&lt;查询文档时使用的分词器&gt;&quot;</span>,<br>                <span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-literal">true</span>                          <span class="hljs-comment"># 创建倒排索引库</span><br>            &#125;,<br>            <span class="hljs-string">&quot;&lt;字段名2&gt;&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>                <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;standard&quot;</span>,<br>                <span class="hljs-string">&quot;search_analyzer&quot;</span>: <span class="hljs-string">&quot;standard&quot;</span>,<br>                <span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-literal">true</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="3-3-1-2-Copy-To-小技巧"><a href="#3-3-1-2-Copy-To-小技巧" class="headerlink" title="3.3.1.2. Copy To 小技巧"></a>3.3.1.2. Copy To 小技巧</h6><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"># <span class="hljs-number">1.</span> <span class="hljs-keyword">Copy</span> <span class="hljs-keyword">To</span> <span class="hljs-keyword">All</span>（）<br>PUT /user_index<br>&#123;<br>  &quot;mappings&quot;: &#123;<br>    &quot;properties&quot;: &#123;<br>      &quot;username&quot;: &#123;<br>        &quot;type&quot;: &quot;text&quot;,<br>        &quot;analyzer&quot;: &quot;ik_smart&quot;,<br>        &quot;copy_to&quot;: &quot;all&quot;<br>      &#125;,<br>      &quot;email&quot;: &#123;<br>        &quot;type&quot;: &quot;keyword&quot;,<br>        &quot;index&quot;: <span class="hljs-keyword">false</span>,<br>        &quot;copy_to&quot;: &quot;all&quot;<br>      &#125;,<br>      &quot;profile&quot;: &#123;<br>        &quot;properties&quot;: &#123;<br>          &quot;gender&quot;: &#123;<br>            &quot;type&quot;: &quot;keyword&quot;,<br>	        &quot;index&quot;: <span class="hljs-keyword">false</span>,                         // <span class="hljs-keyword">Object</span> 类型中的字段分别管理索引<br>            &quot;copy_to&quot;: &quot;all&quot;<br>          &#125;,<br>          &quot;age&quot;: &#123;<br>            &quot;type&quot;: &quot;integer&quot;,<br>			&quot;index&quot;: <span class="hljs-keyword">false</span>,<br>            &quot;copy_to&quot;: &quot;all&quot;<br>          &#125;<br>        &#125;<br>      &#125;,<br>      &quot;all&quot;: &#123;<br>        &quot;type&quot;: &quot;text&quot;,<br>        &quot;analyzer&quot;: &quot;ik_max_word&quot;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br><br><br># <span class="hljs-number">2.</span> 使用 <span class="hljs-keyword">Copy</span> <span class="hljs-keyword">To</span> 之前的搜索<br><span class="hljs-keyword">GET</span> /user_index/_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;bool&quot;: &#123;<br>      &quot;should&quot;: [<br>        &#123; &quot;match&quot;: &#123; &quot;username&quot;: &quot;johndoe&quot; &#125; &#125;,<br>        &#123; &quot;match&quot;: &#123; &quot;profile.gender&quot;: &quot;male&quot; &#125; &#125;,<br>        &#123; &quot;match&quot;: &#123; &quot;profile.age&quot;: &quot;18&quot; &#125; &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br><br><br># <span class="hljs-number">3.</span> 使用 <span class="hljs-keyword">Copy</span> <span class="hljs-keyword">To</span> 之后的搜索<br><span class="hljs-keyword">GET</span> /user_index/_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;match&quot;: &#123;<br>      &quot;all&quot;: &quot;johndoe male 18&quot;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h4 id="4-4-自定义分词器"><a href="#4-4-自定义分词器" class="headerlink" title="4.4. 自定义分词器"></a>4.4. 自定义分词器</h4><p>自定义分词器</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs axapta"><span class="hljs-meta"># 1. 模版</span><br>PUT /&lt;索引库名称&gt;<br>&#123;<br>  <span class="hljs-string">&quot;settings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;analysis&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;analyzer&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;my_analyzer&quot;</span>: &#123;                      <span class="hljs-comment">// 分词器名称（自定义）</span><br>          <span class="hljs-string">&quot;tokenizer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span>,<br>          <span class="hljs-string">&quot;filter&quot;</span>: <span class="hljs-string">&quot;pinyin&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br><br><br><span class="hljs-meta"># 2. 示例（一个还不错的可生产用的自定义分词器，很好解决了我们的问题）</span><br>PUT /&lt;索引库名称&gt;<br>&#123;<br>  <span class="hljs-string">&quot;settings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;analysis&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;analyzer&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;my_analyzer&quot;</span>: &#123; <br>          <span class="hljs-string">&quot;tokenizer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span>,<br>          <span class="hljs-string">&quot;filter&quot;</span>: <span class="hljs-string">&quot;py&quot;</span><br>        &#125;<br>      &#125;,<br>      <span class="hljs-string">&quot;filter&quot;</span>: &#123;                           <span class="hljs-comment">// 自定义 tokenizer filter</span><br>        <span class="hljs-string">&quot;py&quot;</span>: &#123; <br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;pinyin&quot;</span>, <br>          <span class="hljs-string">&quot;keep_full_pinyin&quot;</span>: <span class="hljs-literal">false</span>,<br>          <span class="hljs-string">&quot;keep_joined_full_pinyin&quot;</span>: <span class="hljs-literal">true</span>,<br>          <span class="hljs-string">&quot;keep_original&quot;</span>: <span class="hljs-literal">true</span>,<br>          <span class="hljs-string">&quot;limit_first_letter_length&quot;</span>: <span class="hljs-number">16</span>,<br>          <span class="hljs-string">&quot;remove_duplicated_term&quot;</span>: <span class="hljs-literal">true</span>,<br>          <span class="hljs-string">&quot;none_chinese_pinyin_tokenize&quot;</span>: <span class="hljs-literal">false</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意：</p>
<ol>
<li>拼音分词器的更多配置可以上官网查阅</li>
</ol>
</blockquote>
<p>如家酒店还不错 -&gt; <code>[&quot;如家&quot;, &quot;rujia&quot;, &quot;rj&quot;, &quot;酒店&quot;, &quot;jiudian&quot;, &quot;jd&quot;, &quot;还不&quot;, &quot;haibu&quot;, &quot;hb&quot;, &quot;不错&quot;, &quot;bucuo&quot;, &quot;bc&quot;</code></p>
<p>感觉并没有实现r家这种搜索，虽然自定义分词器在创建索引的时候很好，插入文档后能很好的分词，很不错，，但是如果查询的时候还用这个分词器就不太好了，因为拼音有很多的同声字，例如shizi 有狮子、十字、师资、柿子、虱子等等等等<br><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250427210357524.png" srcset="/img/loading.gif" lazyload></p>
<p>为了解决这个问头，我们只能创建索引时使用自定义索引，但是查询时不使用自定义索引，应该用户输入拼音，你就那拼音搜，输入中文，就拿中文搜</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">PUT <span class="hljs-string">/test</span><br>&#123;<br>  <span class="hljs-string">&quot;settings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;analysis&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;analyzer&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;my_analyzer&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;tokenizer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span>,<br>          <span class="hljs-string">&quot;filter&quot;</span>: <span class="hljs-string">&quot;py&quot;</span><br>        &#125;<br>      &#125;,<br>      <span class="hljs-string">&quot;filter&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;py&quot;</span>: &#123; <span class="hljs-string">...</span> &#125;<br>      &#125;<br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;name&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>        <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;my_analyzer&quot;</span>,             <span class="hljs-string">//</span> 创建索引、插入文档<br>        <span class="hljs-string">&quot;search_analyzer&quot;</span>: <span class="hljs-string">&quot;ik_smart&quot;</span>          <span class="hljs-string">//</span> 搜索时<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h4 id="4-5-如何抉择分词器"><a href="#4-5-如何抉择分词器" class="headerlink" title="4.5. 如何抉择分词器"></a>4.5. 如何抉择分词器</h4><p>在为文档进行分词的时候，我们希望尽可能的分词，并且还希望同样为阴雨进行分词，例如：<code>[&quot;如家&quot;, &quot;rujia&quot;, &quot;rj&quot;, &quot;酒店&quot;, &quot;jiudian&quot;, &quot;jd&quot;, &quot;还不&quot;, &quot;haibu&quot;, &quot;hb&quot;, &quot;不错&quot;, &quot;bucuo&quot;, &quot;bc&quot;</code></p>
<p>所以在文档分词，即创建索引时，为字段的分词器为自定义分词器<br>但是在查询时，我们可能会输入 如家、rj、r家等等，如果还使用自定义分词器，发现如果还使用自定义分词器，我们输入 rj可能会查询到 人机、如家、软件、肉鸡等等，啊？？是这样吗？你再补充点，对了，如果r家这该怎么办，好像分词的时候没考虑这些问题啊。等等等等，一系列问题，你要为我总结出来用户可能输入的所有可能，然后我该怎么解决</p>
<p>所以为了避免这些一系列问题，我们推荐使用 ik_max_word 或者 ik_smart</p>
<hr>
<h3 id="5-ES-中文搜索优化方案"><a href="#5-ES-中文搜索优化方案" class="headerlink" title="5. ES 中文搜索优化方案"></a>5. ES 中文搜索优化方案</h3><h4 id="5-1-用户输入搜索信息的常见形式"><a href="#5-1-用户输入搜索信息的常见形式" class="headerlink" title="5.1. 用户输入搜索信息的常见形式"></a>5.1. 用户输入搜索信息的常见形式</h4><ol>
<li>&#x3D;&#x3D;全称&#x3D;&#x3D;：<ol>
<li>如家</li>
</ol>
</li>
<li>&#x3D;&#x3D;拼音全拼&#x3D;&#x3D;：<ol>
<li>rujia</li>
</ol>
</li>
<li>&#x3D;&#x3D;拼音缩写&#x3D;&#x3D;：<ol>
<li>rj</li>
</ol>
</li>
<li>&#x3D;&#x3D;汉字 + 拼音混合&#x3D;&#x3D;：<ol>
<li>r家</li>
</ol>
</li>
<li>&#x3D;&#x3D;谐音字&#x3D;&#x3D;：<ol>
<li>如加、如佳</li>
</ol>
</li>
<li>&#x3D;&#x3D;错别字&#x3D;&#x3D;：<ol>
<li>如加</li>
</ol>
</li>
</ol>
<hr>
<h1 id="Elasticsearch-处理谐音字和错别字的解决方案"><a href="#Elasticsearch-处理谐音字和错别字的解决方案" class="headerlink" title="Elasticsearch 处理谐音字和错别字的解决方案"></a>Elasticsearch 处理谐音字和错别字的解决方案</h1><p>在 Elasticsearch 中处理谐音字和错别字是中文搜索场景中的常见需求。针对您提到的”如加、如佳”谐音字问题和”如加”错别字问题，以下是完整的解决方案。</p>
<h2 id="谐音字处理方案"><a href="#谐音字处理方案" class="headerlink" title="谐音字处理方案"></a>谐音字处理方案</h2><h2 id="拼音分词器配置"><a href="#拼音分词器配置" class="headerlink" title="拼音分词器配置"></a>拼音分词器配置</h2><p>处理谐音字的核心是使用拼音分词器，通过将中文转换为拼音来实现同音字的匹配<a target="_blank" rel="noopener" href="https://blog.csdn.net/LINING_GG/article/details/128212935">1</a>。</p>
<p>json</p>
<p><code>PUT /test_index &#123;   &quot;settings&quot;: &#123;    &quot;analysis&quot;: &#123;      &quot;analyzer&quot;: &#123;        &quot;my_pinyin_analyzer&quot;: &#123;          &quot;tokenizer&quot;: &quot;ik_max_word&quot;,          &quot;filter&quot;: [&quot;pinyin_filter&quot;]        &#125;      &#125;,      &quot;filter&quot;: &#123;        &quot;pinyin_filter&quot;: &#123;          &quot;type&quot;: &quot;pinyin&quot;,          &quot;keep_full_pinyin&quot;: true,          &quot;keep_original&quot;: true,          &quot;keep_first_letter&quot;: true,          &quot;keep_separate_first_letter&quot;: false,          &quot;limit_first_letter_length&quot;: 16,          &quot;lowercase&quot;: true,          &quot;remove_duplicated_term&quot;: true        &#125;      &#125;    &#125;  &#125;,  &quot;mappings&quot;: &#123;    &quot;properties&quot;: &#123;      &quot;content&quot;: &#123;        &quot;type&quot;: &quot;text&quot;,        &quot;analyzer&quot;: &quot;my_pinyin_analyzer&quot;,        &quot;search_analyzer&quot;: &quot;ik_smart&quot;      &#125;    &#125;  &#125; &#125;</code></p>
<h2 id="解决同音字问题的关键配置"><a href="#解决同音字问题的关键配置" class="headerlink" title="解决同音字问题的关键配置"></a>解决同音字问题的关键配置</h2><p>为了避免同音字过度匹配的问题，需要合理配置索引和搜索分析器<a target="_blank" rel="noopener" href="https://blog.csdn.net/LINING_GG/article/details/128212935">1</a><a target="_blank" rel="noopener" href="https://elasticsearch.cn/question/11575">2</a>：</p>
<ul>
<li><p><strong>索引时</strong>：使用包含拼音的分析器，同时保留原始中文</p>
</li>
<li><p><strong>搜索时</strong>：使用不包含拼音的分析器，避免中文搜索时匹配到所有同音字</p>
</li>
</ul>
<p>json</p>
<p><code>&#123;   &quot;content&quot;: &#123;    &quot;type&quot;: &quot;text&quot;,    &quot;analyzer&quot;: &quot;my_pinyin_analyzer&quot;,    &quot;search_analyzer&quot;: &quot;ik_smart&quot;  &#125; &#125;</code></p>
<h2 id="多字段搜索策略"><a href="#多字段搜索策略" class="headerlink" title="多字段搜索策略"></a>多字段搜索策略</h2><p>为了平衡搜索的准确性和召回率，可以使用多字段搜索策略<a target="_blank" rel="noopener" href="https://blog.csdn.net/AiMaiShanHuHai/article/details/144430879">3</a>：</p>
<p>json</p>
<p><code>&#123;   &quot;query&quot;: &#123;    &quot;multi_match&quot;: &#123;      &quot;query&quot;: &quot;如加&quot;,      &quot;fields&quot;: [        &quot;content^5&quot;,        &quot;content.pinyin^2&quot;      ],      &quot;operator&quot;: &quot;or&quot;    &#125;  &#125; &#125;</code></p>
<h2 id="错别字处理方案"><a href="#错别字处理方案" class="headerlink" title="错别字处理方案"></a>错别字处理方案</h2><h2 id="模糊查询（Fuzzy-Query）"><a href="#模糊查询（Fuzzy-Query）" class="headerlink" title="模糊查询（Fuzzy Query）"></a>模糊查询（Fuzzy Query）</h2><p>Elasticsearch 提供了基于莱文斯坦距离（Levenshtein Distance）的模糊查询功能来处理拼写错误<a target="_blank" rel="noopener" href="https://blog.csdn.net/Flying_Fish_roe/article/details/142754951">4</a><a target="_blank" rel="noopener" href="https://elasticsearch.cn/article/14056">5</a>。</p>
<p>json</p>
<p><code>&#123;   &quot;query&quot;: &#123;    &quot;fuzzy&quot;: &#123;      &quot;content&quot;: &#123;        &quot;value&quot;: &quot;如加&quot;,        &quot;fuzziness&quot;: &quot;AUTO&quot;      &#125;    &#125;  &#125; &#125;</code></p>
<h2 id="核心参数配置"><a href="#核心参数配置" class="headerlink" title="核心参数配置"></a>核心参数配置</h2><p><strong>fuzziness 参数</strong>：控制编辑距离的大小<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42692506/article/details/101555035">6</a><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/eb5665a9fd70">7</a></p>
<ul>
<li><p><code>AUTO</code>：自动模式，根据词长度调整编辑距离</p>
</li>
<li><p><code>0,1,2</code>：固定的编辑距离值</p>
</li>
<li><p><code>AUTO:3,6</code>：自定义阈值的自动模式</p>
</li>
</ul>
<p><strong>prefix_length 参数</strong>：设置前缀匹配长度，提高查询性能<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/eb5665a9fd70">7</a></p>
<p>json</p>
<p><code>&#123;   &quot;query&quot;: &#123;    &quot;match&quot;: &#123;      &quot;content&quot;: &#123;        &quot;query&quot;: &quot;如加&quot;,        &quot;fuzziness&quot;: &quot;AUTO&quot;,        &quot;prefix_length&quot;: 1      &#125;    &#125;  &#125; &#125;</code></p>
<h2 id="建议器（Suggester）纠错"><a href="#建议器（Suggester）纠错" class="headerlink" title="建议器（Suggester）纠错"></a>建议器（Suggester）纠错</h2><p>使用 Term Suggester 进行拼写纠错<a target="_blank" rel="noopener" href="https://elasticsearch.cn/article/14056">5</a>：</p>
<p>json</p>
<p><code>&#123;   &quot;suggest&quot;: &#123;    &quot;text_suggest&quot;: &#123;      &quot;text&quot;: &quot;如加&quot;,      &quot;term&quot;: &#123;        &quot;field&quot;: &quot;content&quot;,        &quot;suggest_mode&quot;: &quot;always&quot;,        &quot;min_word_length&quot;: 2,        &quot;max_edits&quot;: 2      &#125;    &#125;  &#125; &#125;</code></p>
<h2 id="综合解决方案"><a href="#综合解决方案" class="headerlink" title="综合解决方案"></a>综合解决方案</h2><h2 id="完整的索引配置"><a href="#完整的索引配置" class="headerlink" title="完整的索引配置"></a>完整的索引配置</h2><p>json</p>
<p><code>PUT /comprehensive_index &#123;   &quot;settings&quot;: &#123;    &quot;analysis&quot;: &#123;      &quot;analyzer&quot;: &#123;        &quot;pinyin_analyzer&quot;: &#123;          &quot;tokenizer&quot;: &quot;ik_max_word&quot;,          &quot;filter&quot;: [&quot;pinyin_filter&quot;]        &#125;,        &quot;search_analyzer&quot;: &#123;          &quot;tokenizer&quot;: &quot;ik_smart&quot;        &#125;      &#125;,      &quot;filter&quot;: &#123;        &quot;pinyin_filter&quot;: &#123;          &quot;type&quot;: &quot;pinyin&quot;,          &quot;keep_full_pinyin&quot;: true,          &quot;keep_original&quot;: true,          &quot;keep_first_letter&quot;: true,          &quot;lowercase&quot;: true,          &quot;remove_duplicated_term&quot;: true        &#125;      &#125;    &#125;  &#125;,  &quot;mappings&quot;: &#123;    &quot;properties&quot;: &#123;      &quot;content&quot;: &#123;        &quot;type&quot;: &quot;text&quot;,        &quot;analyzer&quot;: &quot;pinyin_analyzer&quot;,        &quot;search_analyzer&quot;: &quot;search_analyzer&quot;,        &quot;fields&quot;: &#123;          &quot;keyword&quot;: &#123;            &quot;type&quot;: &quot;keyword&quot;          &#125;,          &quot;pinyin&quot;: &#123;            &quot;type&quot;: &quot;text&quot;,            &quot;analyzer&quot;: &quot;pinyin_analyzer&quot;          &#125;        &#125;      &#125;    &#125;  &#125; &#125;</code></p>
<h2 id="多策略搜索查询"><a href="#多策略搜索查询" class="headerlink" title="多策略搜索查询"></a>多策略搜索查询</h2><p>结合模糊查询和拼音搜索的综合查询策略<a target="_blank" rel="noopener" href="https://blog.csdn.net/AiMaiShanHuHai/article/details/144430879">3</a>：</p>
<p>json</p>
<p><code>&#123;   &quot;query&quot;: &#123;    &quot;bool&quot;: &#123;      &quot;should&quot;: [        &#123;          &quot;match&quot;: &#123;            &quot;content&quot;: &#123;              &quot;query&quot;: &quot;如加&quot;,              &quot;boost&quot;: 3            &#125;          &#125;        &#125;,        &#123;          &quot;match&quot;: &#123;            &quot;content.pinyin&quot;: &#123;              &quot;query&quot;: &quot;如加&quot;,              &quot;boost&quot;: 2            &#125;          &#125;        &#125;,        &#123;          &quot;fuzzy&quot;: &#123;            &quot;content&quot;: &#123;              &quot;value&quot;: &quot;如加&quot;,              &quot;fuzziness&quot;: &quot;AUTO&quot;,              &quot;boost&quot;: 1            &#125;          &#125;        &#125;      ]    &#125;  &#125; &#125;</code></p>
<h2 id="最佳实践建议"><a href="#最佳实践建议" class="headerlink" title="最佳实践建议"></a>最佳实践建议</h2><ol>
<li><p><strong>性能优化</strong>：使用 <code>prefix_length</code> 参数减少模糊查询的计算量<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/eb5665a9fd70">7</a></p>
</li>
<li><p><strong>准确性平衡</strong>：合理设置 <code>fuzziness</code> 值，避免过度匹配<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42692506/article/details/101555035">6</a></p>
</li>
<li><p><strong>权重调整</strong>：通过 <code>boost</code> 参数调整不同匹配策略的权重<a target="_blank" rel="noopener" href="https://blog.csdn.net/AiMaiShanHuHai/article/details/144430879">3</a></p>
</li>
<li><p><strong>索引优化</strong>：根据业务需求选择合适的分词器组合<a target="_blank" rel="noopener" href="https://blog.csdn.net/LINING_GG/article/details/128212935">1</a></p>
</li>
</ol>
<p>通过以上配置和策略，可以有效处理”如加、如佳”等谐音字问题和”如加”等错别字问题，提升中文搜索的用户体验和准确性<a target="_blank" rel="noopener" href="https://elastic-search-in-action.medcl.com/3.site_search/3.3.search_box/pinyin_support/">8</a><a target="_blank" rel="noopener" href="https://developer.baidu.com/article/details/2817267">9</a>。</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/LINING_GG/article/details/128212935">https://blog.csdn.net/LINING_GG&#x2F;article&#x2F;details&#x2F;128212935</a></li>
<li><a target="_blank" rel="noopener" href="https://elasticsearch.cn/question/11575">https://elasticsearch.cn/question/11575</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/AiMaiShanHuHai/article/details/144430879">https://blog.csdn.net/AiMaiShanHuHai/article/details/144430879</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/Flying_Fish_roe/article/details/142754951">https://blog.csdn.net/Flying_Fish_roe&#x2F;article&#x2F;details&#x2F;142754951</a></li>
<li><a target="_blank" rel="noopener" href="https://elasticsearch.cn/article/14056">https://elasticsearch.cn/article/14056</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42692506/article/details/101555035">https://blog.csdn.net/weixin_42692506&#x2F;article&#x2F;details&#x2F;101555035</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/eb5665a9fd70">https://www.jianshu.com/p/eb5665a9fd70</a></li>
<li><a target="_blank" rel="noopener" href="https://elastic-search-in-action.medcl.com/3.site_search/3.3.search_box/pinyin_support/">https://elastic-search-in-action.medcl.com/3.site_search&#x2F;3.3.search_box&#x2F;pinyin_support&#x2F;</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.baidu.com/article/details/2817267">https://developer.baidu.com/article/details/2817267</a></li>
<li><a target="_blank" rel="noopener" href="https://elastic-search-in-action.medcl.com/3.site_search/3.3.search_box/fuzzy_query/">https://elastic-search-in-action.medcl.com/3.site_search&#x2F;3.3.search_box&#x2F;fuzzy_query&#x2F;</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/u013041642/article/details/94416631">https://blog.csdn.net/u013041642/article/details/94416631</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wufengtinghai/p/15800498.html">https://www.cnblogs.com/wufengtinghai/p/15800498.html</a></li>
<li><a target="_blank" rel="noopener" href="https://elasticsearch.cn/question/11351">https://elasticsearch.cn/question/11351</a></li>
<li><a target="_blank" rel="noopener" href="https://www.xiaoyeshiyu.com/post/f969d9e9.html">https://www.xiaoyeshiyu.com/post/f969d9e9.html</a></li>
<li><a target="_blank" rel="noopener" href="https://hackernoon.com/how-to-use-fuzzy-query-matches-in-elasticsearch-dh1h3167">https://hackernoon.com/how-to-use-fuzzy-query-matches-in-elasticsearch-dh1h3167</a></li>
<li><a target="_blank" rel="noopener" href="https://abhishek376.wordpress.com/2017/09/30/correcting-typos-and-spelling-mistakes-using-elasticsearch/">https://abhishek376.wordpress.com/2017/09/30/correcting-typos-and-spelling-mistakes-using-elasticsearch/</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/tsx668899/article/details/135041636">https://blog.csdn.net/tsx668899/article/details/135041636</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2220244">https://cloud.tencent.com/developer/article/2220244</a></li>
<li><a target="_blank" rel="noopener" href="https://patents.google.com/patent/CN106202153A/zh">https://patents.google.com/patent/CN106202153A/zh</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/Li_services/article/details/119052731">https://blog.csdn.net/Li_services&#x2F;article&#x2F;details&#x2F;119052731</a></li>
<li><a target="_blank" rel="noopener" href="https://wjw465150.github.io/Elasticsearch/4_1_Dealing_with_language.html">https://wjw465150.github.io/Elasticsearch/4_1_Dealing_with_language.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wufengtinghai/p/15811554.html">https://www.cnblogs.com/wufengtinghai/p/15811554.html</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/1331418">https://developer.aliyun.com/article/1331418</a></li>
<li><a target="_blank" rel="noopener" href="https://www.aliyun.com/sswb/channel_535235_8.html">https://www.aliyun.com/sswb/channel_535235_8.html</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1509405">https://cloud.tencent.com/developer/article/1509405</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.51cto.com/topic/eszhongwenjiucuosuggest.html">https://blog.51cto.com/topic/eszhongwenjiucuosuggest.html</a></li>
</ol>
<h1 id="二、实操：搭建-ES-环境"><a href="#二、实操：搭建-ES-环境" class="headerlink" title="二、实操：搭建 ES 环境"></a>二、实操：搭建 ES 环境</h1><h3 id="1-ES-高可用实现"><a href="#1-ES-高可用实现" class="headerlink" title="1. ES 高可用实现"></a>1. ES 高可用实现</h3><h4 id="1-1-ES-组件"><a href="#1-1-ES-组件" class="headerlink" title="1.1. ES 组件"></a>1.1. ES 组件</h4><p>ES 中的集群节点有不同的职责划分，每个节点都可以有以下角色：</p>
<ol>
<li>&#x3D;&#x3D;Master&#x3D;&#x3D;：<ol>
<li><font color="#00b0f0">配置参数</font>：<ol>
<li>node.master</li>
</ol>
</li>
<li><font color="#00b0f0">默认值</font>：<ol>
<li>true</li>
</ol>
</li>
<li><font color="#00b0f0">角色职责</font>：<ol>
<li>Master 角色本身不直接执行业务操作，仅参与 Leader（主节点）的选举。</li>
<li>Leader 的核心职责：<ol>
<li><font color="#7030a0">集群状态维护</font><ol>
<li>接收并处理各节点的心跳，实时跟踪节点的加入与离开</li>
<li>持集群元数据的最新视图，确保集群一致性</li>
</ol>
</li>
<li><font color="#7030a0">分片与副本管理</font><ol>
<li>负责分片（primary 和 replica）的分配、重分配和均衡</li>
<li>监控副本健康状况，触发副本恢复或重建</li>
</ol>
</li>
<li><font color="#7030a0">索引管理</font><ol>
<li>管理所有索引的元数据信息（名称、设置、映射等）</li>
<li>处理索引的创建、删除、修改请求，保证操作原子性</li>
</ol>
</li>
<li><font color="#7030a0">全局配置管理</font><ol>
<li>管理 ILM（Index Lifecycle Management）、Index Templates、Component Templates 等全局配置</li>
<li>协调集群范围内的参数变更，广播至所有节点</li>
</ol>
</li>
</ol>
</li>
<li>注意事项：<ol>
<li>ES 中的 Master 实际上是 Master-eligible（候选主节点），真正的主节点（Leader）由候选节点通过选举产生，这里我说由 Master 选举 Leader 是方便记忆</li>
<li>Master 节点必须获得 <strong>超过</strong> N&#x2F;2 + 1 的投票（不含“等于”）才能成为 Leader，N 为历史上加入过集群的节点总数，即使节点已下线，其记录仍计入 N。因此我们必须保证集群中大多数节点存活时才可完成选举，例如 3 节点必须保证 2 节点存活。</li>
<li>此外我们需要注意，Master 节点的数量一般为奇数个，这样能有效防止脑裂</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>&#x3D;&#x3D;Data&#x3D;&#x3D;：<ol>
<li><font color="#00b0f0">配置参数</font>：<ol>
<li>node.data</li>
</ol>
</li>
<li><font color="#00b0f0">默认值</font>：<ol>
<li>true</li>
</ol>
</li>
<li><font color="#00b0f0">角色职责</font>：<ol>
<li>存储文档数据，持有 primary 和 replica 分片。</li>
<li>执行数据相关的操作，如 CRUD、查询、聚合分析等。</li>
<li>处理分片级别的恢复、快照和搜索请求，通常负载较高</li>
</ol>
</li>
</ol>
</li>
<li>&#x3D;&#x3D;Ingest&#x3D;&#x3D;：<ol>
<li><font color="#00b0f0">配置参数</font>：<ol>
<li>node.ingest</li>
</ol>
</li>
<li><font color="#00b0f0">默认值</font>：<ol>
<li>true</li>
</ol>
</li>
<li><font color="#00b0f0">角色职责</font>：<ol>
<li>在文档数据存储之前进行预处理，通过 Ingest Pipelines 应用各种 Processor（如 grok、date、set、geoip 等）对文档进行解析、转换、清洗。</li>
<li>将处理后的文档转发到 Data 节点，减轻客户端或外部系统的预处理压力。</li>
</ol>
</li>
</ol>
</li>
<li>&#x3D;&#x3D;Coordinating&#x3D;&#x3D;：<ol>
<li><font color="#00b0f0">配置参数</font>：<ol>
<li>无需显式配置，所有节点默认为协调节点。</li>
</ol>
</li>
<li><font color="#00b0f0">默认值</font>：<ol>
<li>默认开启，无法修改</li>
</ol>
</li>
<li><font color="#00b0f0">角色职责</font>：<ol>
<li>路作为客户端请求的入口，解析和路由请求到 Master、Data 或 Ingest 节点。</li>
<li>将各分片返回的部分结果进行聚合、排序、分页等操作后，统一返回给用户。</li>
<li>管理 Scroll、Search After、Multi-Search 等跨分片的复杂查询流程。</li>
</ol>
</li>
</ol>
</li>
</ol>
<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>默认情况下，每个节点都同时承担上述四种角色，这对测试环境足够；</li>
<li>在大型生产环境中，建议拆分角色：<ul>
<li><strong>Data</strong> 角色负载最重，应部署在 CPU 与内存资源充足的服务器上；</li>
<li><strong>Master</strong> 角色建议部署在轻量节点或专用节点上，避免与数据节点争抢资源；</li>
<li><strong>Ingest</strong> 角色可根据吞吐量高低独立部署，以优化预处理性能；</li>
<li><strong>Coordinating</strong> 角色可部署在与客户端网络延迟低的节点上，提升请求路由效率</li>
</ul>
</li>
</ol>
</blockquote>
<hr>
<h4 id="1-2-ES-精细化把控（ES-本身）"><a href="#1-2-ES-精细化把控（ES-本身）" class="headerlink" title="1.2. ES 精细化把控（ES 本身）"></a>1.2. ES 精细化把控（ES 本身）</h4><p>&#x3D;&#x3D;1.一个 ES 索引库最多能存储多少数据量&#x3D;&#x3D;<br>ES 索引库的数据量是所有主分片数据量的总和，理论上来说一个 ES 索引库的数据量是无上限的</p>
<p>&#x3D;&#x3D;2.一个 ES 索引库推荐存储多少数据量&#x3D;&#x3D;<br>将单个索引库的存储量控制在几十 GB 到数百 GB之间，既能保证查询和恢复效率，又方便管理与扩展。</p>
<p>&#x3D;&#x3D;3.一个分片最多能存储多少数据量&#x3D;&#x3D;<br>Lucene引擎对单个分片设定了21.47亿文档的硬性限制（Integer.MAX_VALUE - 128）。假设平均文档大小为1KB，单分片理论存储上限可达20TB，但实际生产环境中受以下因素制约：</p>
<ol>
<li><font color="#00b0f0">内存分配</font>：<ol>
<li>JVM堆内存需满足倒排索引与文档值的驻留需求，建议每GB堆内存对应不超过20GB索引数据</li>
</ol>
</li>
<li><font color="#00b0f0">磁盘性能</font>：<ol>
<li>机械硬盘场景下单个分片超过100GB时，查询延迟可能呈指数级增长</li>
</ol>
</li>
<li><font color="#00b0f0">恢复时效</font>：<ol>
<li>50GB分片在万兆网络环境下恢复时间约为30分钟，超过该阈值将影响故障转移效率</li>
</ol>
</li>
</ol>
<p>&#x3D;&#x3D;4.一个分片建议存储多少数据量&#x3D;&#x3D;<br>单分片数据量建议 10 - 50 GB，极端场景下不超过 100GB，下面是特殊场景：</p>
<ol>
<li><font color="#00b0f0">日志分析</font>：<ol>
<li>可将单分片扩容至 100 GB，但需配合冷热节点架构</li>
</ol>
</li>
<li><font color="#00b0f0">向量搜索</font>：<ol>
<li>单分片建议上限压缩至20GB，以确保高维数据检索效率；</li>
</ol>
</li>
<li><font color="#00b0f0">时序数据</font>：<ol>
<li>热数据分片控制在30GB，温&#x2F;冷数据可放大至80GB。</li>
</ol>
</li>
</ol>
<p>&#x3D;&#x3D;5.建议怎样分片、副本&#x3D;&#x3D;<br>主分片数 &#x3D; 总数据量 &#x2F; 单分片最大数据量，一般是总数据量 &#x2F; 50GB<br>副本数，你要有这个概念，一个超高可以的集群，副本数建议2-3个，50GB 以下你就一个副本数就行了<br>注意事项：<br>    1. 主分片数应尽量是节点数的整数倍，以确保负载均衡<br>    2. 主分片数一旦设置无法更改，需提前规划数据增长<br>    3. 每个节点的分片数 + 副本数建议 20~30个（官方建议是20 ~ 40）个</p>
<p>&#x3D;&#x3D;数据一致性&#x3D;&#x3D;</p>
<p>&#x3D;&#x3D;节点安排&#x3D;&#x3D;</p>
<hr>
<h4 id="1-3-ES-企业级高可用集群要求"><a href="#1-3-ES-企业级高可用集群要求" class="headerlink" title="1.3. ES 企业级高可用集群要求"></a>1.3. ES 企业级高可用集群要求</h4><p>&#x3D;&#x3D;6.建议怎样安排节点&#x3D;&#x3D;<br>Master 节点数为奇数个</p>
<hr>
<h3 id="2-环境搭建"><a href="#2-环境搭建" class="headerlink" title="2. 环境搭建"></a>2. 环境搭建</h3><h4 id="2-1-分布式集群环境搭建"><a href="#2-1-分布式集群环境搭建" class="headerlink" title="2.1. 分布式集群环境搭建"></a>2.1. 分布式集群环境搭建</h4><h5 id="2-1-1-架构说明"><a href="#2-1-1-架构说明" class="headerlink" title="2.1.1. 架构说明"></a>2.1.1. 架构说明</h5><hr>
<h5 id="2-1-2-环境要求"><a href="#2-1-2-环境要求" class="headerlink" title="2.1.2. 环境要求"></a>2.1.2. 环境要求</h5><ol>
<li>&#x3D;&#x3D;硬件要求&#x3D;&#x3D;：<ol>
<li>3 台服务器</li>
<li>2 核 CPU</li>
<li>4 GB 内存</li>
<li>50 GB 可用存储空间</li>
</ol>
</li>
<li>&#x3D;&#x3D;系统、软件要求&#x3D;&#x3D;：<ol>
<li>Ubuntu 22.04</li>
<li>ElasticSearch 8.18</li>
<li>相关工具<ol>
<li>openssl<ol>
<li>导出 CA 公钥</li>
</ol>
</li>
<li>dos2unix<ol>
<li>将 脚本转化为 Unix 格式</li>
</ol>
</li>
<li>chrony<ol>
<li>时间同步</li>
</ol>
</li>
</ol>
</li>
<li>时间同步</li>
<li>创建 es 用户</li>
<li>关闭 Swap 分区</li>
<li>开放 9200、9300 TCP端口</li>
<li>设置主机名、主机名解析</li>
</ol>
</li>
</ol>
<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>由于可能在 192.168.136.8 部署 <code>Kibana</code>，CPU 和内存可稍多些</li>
</ol>
</blockquote>
<hr>
<h5 id="2-1-3-节点列表"><a href="#2-1-3-节点列表" class="headerlink" title="2.1.3. 节点列表"></a>2.1.3. 节点列表</h5><table>
<thead>
<tr>
<th>IP</th>
<th>主机名</th>
<th>角色</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.136.8</td>
<td>es-node1</td>
<td>master-eligible、data、ingest、coordinating</td>
</tr>
<tr>
<td>192.168.136.9</td>
<td>es-node2</td>
<td>master-eligible、data、ingest、coordinating</td>
</tr>
<tr>
<td>192.168.136.10</td>
<td>es-node3</td>
<td>master-eligible、data、ingest、coordinating</td>
</tr>
</tbody></table>
<hr>
<h5 id="2-1-4-相关工具"><a href="#2-1-4-相关工具" class="headerlink" title="2.1.4. 相关工具"></a>2.1.4. 相关工具</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. openssl</span><br><span class="hljs-built_in">command</span> -v openssl &gt;/dev/null 2&gt;&amp;1 || <span class="hljs-built_in">sudo</span> apt-get install -y openssl<br><br><br><span class="hljs-comment"># 2. dos2unix</span><br><span class="hljs-built_in">command</span> -v dos2unix &gt;/dev/null 2&gt;&amp;1 || <span class="hljs-built_in">sudo</span> apt-get install -y dos2unix<br><br><br><span class="hljs-comment"># 3. chrony</span><br><span class="hljs-built_in">command</span> -v chrony &gt;/dev/null 2&gt;&amp;1 || <span class="hljs-built_in">sudo</span> apt-get install -y chrony<br></code></pre></td></tr></table></figure>

<hr>
<h5 id="2-1-5-时间同步"><a href="#2-1-5-时间同步" class="headerlink" title="2.1.5. 时间同步"></a>2.1.5. 时间同步</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. 安装 chrony</span><br><span class="hljs-built_in">sudo</span> apt install -y chrony<br><br><br><span class="hljs-comment"># 2. 启动并开启自启动 chrony</span><br><span class="hljs-built_in">sudo</span> systemctl <span class="hljs-built_in">enable</span> chrony &amp;&amp; <span class="hljs-built_in">sudo</span> systemctl start chrony<br></code></pre></td></tr></table></figure>

<hr>
<h5 id="2-1-6-创建-es-用户"><a href="#2-1-6-创建-es-用户" class="headerlink" title="2.1.6. 创建 es 用户"></a>2.1.6. 创建 es 用户</h5><p>由于 ES 不允许以 root 用户身份运行（我们仅在运行 ES 时使用 es 用户），因此我们需要创建一个名为 <code>es</code> 的用户，并使用该用户进行后续的操作和配置。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"># <span class="hljs-number">1</span>. 删除已存在 <span class="hljs-built_in">es</span> 用户（包括其主目录）<br>userdel -r <span class="hljs-built_in">es</span><br><br><br># <span class="hljs-number">2</span>. 新增 <span class="hljs-built_in">es</span> 用户<br>useradd <span class="hljs-built_in">es</span><br><br><br># <span class="hljs-number">3</span>. 为 <span class="hljs-built_in">es</span> 用户设置密码（wq666）<br>passwd <span class="hljs-built_in">es</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>为用户设置密码时，两次回车键就是无密码，我们这里设置 <code>wq666</code></li>
</ol>
</blockquote>
<hr>
<h5 id="2-1-7-关闭-Swap-分区"><a href="#2-1-7-关闭-Swap-分区" class="headerlink" title="2.1.7. 关闭 Swap 分区"></a>2.1.7. 关闭 Swap 分区</h5><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 1. 将 内容注释</span><br>vim <span class="hljs-regexp">/etc/</span>fstab<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">## 将此内容进行注释</span><br><span class="hljs-string">## /swap.img       none    swap    sw      0       0</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br><span class="hljs-comment"># 2. 立即关闭 Swap 分区</span><br>swapoff -a<br></code></pre></td></tr></table></figure>

<hr>
<h5 id="2-1-8-开放-9200、9300-TCP-端口"><a href="#2-1-8-开放-9200、9300-TCP-端口" class="headerlink" title="2.1.8. 开放 9200、9300 TCP 端口"></a>2.1.8. 开放 9200、9300 TCP 端口</h5><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">sudo</span> ufw <span class="hljs-literal">allow</span> <span class="hljs-number">9200</span>/tcp &amp;&amp; sudo ufw <span class="hljs-literal">allow</span> <span class="hljs-number">9300</span>/tcp<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>TCP 端口就是我们常说的 HTTP 端口</li>
</ol>
</blockquote>
<hr>
<h5 id="2-1-9-设置主机名、主机名互相解析"><a href="#2-1-9-设置主机名、主机名互相解析" class="headerlink" title="2.1.9. 设置主机名、主机名互相解析"></a>2.1.9. 设置主机名、主机名互相解析</h5><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs dsconfig"><span class="hljs-comment"># 1. 设置主机名</span><br><span class="hljs-comment"># 1.1. 192.168.136.8</span><br><span class="hljs-string">sudo</span> <span class="hljs-string">hostnamectl</span> <span class="hljs-built_in">set-hostname</span> <span class="hljs-string">es-node1</span><br><br><span class="hljs-comment"># 1.2. 192.168.136.9</span><br><span class="hljs-string">sudo</span> <span class="hljs-string">hostnamectl</span> <span class="hljs-built_in">set-hostname</span> <span class="hljs-string">es-node2</span><br><br><span class="hljs-comment"># 1.3. 192.168.136.10</span><br><span class="hljs-string">sudo</span> <span class="hljs-string">hostnamectl</span> <span class="hljs-built_in">set-hostname</span> <span class="hljs-string">es-node3</span><br><br><br><span class="hljs-comment"># 2. 设置主机名互相解析</span><br><span class="hljs-string">sudo</span> <span class="hljs-string">vim</span> /<span class="hljs-string">etc</span>/<span class="hljs-string">hosts</span><br><span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">192.168.136.8 es-node1</span><br><span class="hljs-string">192.168.136.9 es-node2</span><br><span class="hljs-string">192.168.136.10 es-node3</span><br><span class="hljs-string">&quot;</span><span class="hljs-string">&quot;&quot;</span><br></code></pre></td></tr></table></figure>

<hr>
<h5 id="2-1-10-创建-mystudy-es-目录"><a href="#2-1-10-创建-mystudy-es-目录" class="headerlink" title="2.1.10. 创建 mystudy&#x2F;es 目录"></a>2.1.10. 创建 mystudy&#x2F;es 目录</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p /mystudy/es<br></code></pre></td></tr></table></figure>

<hr>
<h5 id="2-1-11-下载并安装-ES"><a href="#2-1-11-下载并安装-ES" class="headerlink" title="2.1.11. 下载并安装 ES"></a>2.1.11. 下载并安装 ES</h5><p>&#x3D;&#x3D;1.下载 ES&#x3D;&#x3D;<br>从 <a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/past-releases#elasticsearch">ES 下载地址</a>下载 ES 安装包：<br><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250416201625864.png" srcset="/img/loading.gif" lazyload></p>
<p>&#x3D;&#x3D;2.安装 ES&#x3D;&#x3D;</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># 1. 将 ES 安装包上传至 /mystudy/es 目录</span><br><br><br><span class="hljs-comment"># 2. 进入 /mystudy/es 目录</span><br><span class="hljs-attribute">cd</span> /mystudy/es<br><br><br><span class="hljs-comment"># 3. 删除已存在 ES 目录</span><br><span class="hljs-attribute">rm</span> -rf /mystudy/es/elasticsearch<br><br><br><span class="hljs-comment"># 4. 解压</span><br><span class="hljs-attribute">tar</span> -zxvf  elasticsearch-<span class="hljs-number">8</span>.<span class="hljs-number">18</span>.<span class="hljs-number">0</span>-linux-x86_64.tar.gz -C /mystudy/es<br><br><br><span class="hljs-comment"># 5. 重命名</span><br><span class="hljs-attribute">mv</span> elasticsearch-<span class="hljs-number">8</span>.<span class="hljs-number">18</span>.<span class="hljs-number">0</span> elasticsearch<br></code></pre></td></tr></table></figure>

<hr>
<h5 id="2-1-12-创建存放-ES-数据的目录"><a href="#2-1-12-创建存放-ES-数据的目录" class="headerlink" title="2.1.12. 创建存放 ES 数据的目录"></a>2.1.12. 创建存放 ES 数据的目录</h5><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">mkdir -p <span class="hljs-regexp">/mystudy/</span>es<span class="hljs-regexp">/elasticsearch/</span>data<br></code></pre></td></tr></table></figure>

<hr>
<h5 id="2-1-13-生成-SSL-证书"><a href="#2-1-13-生成-SSL-证书" class="headerlink" title="2.1.13. 生成 SSL 证书"></a>2.1.13. 生成 SSL 证书</h5><h6 id="2-1-13-1-创建存放证书的目录"><a href="#2-1-13-1-创建存放证书的目录" class="headerlink" title="2.1.13.1. 创建存放证书的目录"></a>2.1.13.1. 创建存放证书的目录</h6><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">mkdir -p /mystudy/es/elasticsearch/config/certs<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="2-1-13-2-生成-CA-证书（CA-私钥和-CA-公钥）、CA-公钥"><a href="#2-1-13-2-生成-CA-证书（CA-私钥和-CA-公钥）、CA-公钥" class="headerlink" title="2.1.13.2. 生成 CA 证书（CA 私钥和 CA 公钥）、CA 公钥"></a>2.1.13.2. 生成 CA 证书（CA 私钥和 CA 公钥）、CA 公钥</h6><p>Elasticsearch 要通过 HTTPS 提供服务，因此若要让用户正常访问 <code>https://192.168.136.8:9200</code>，就需要为其配置一份 HTTPS 证书，且该证书中必须包含 IP 地址 <code>192.168.136.8</code>。</p>
<p>尽管我们可以手动生成自签名证书，Elasticsearch 也提供了更便捷的工具来自动生成 HTTPS 证书。这个工具的第一步是生成一个 CA 证书。需要注意，这个 CA 证书不仅仅包含公钥，还包含私钥，和我们平常所说的“仅包含公钥”的 CA 根证书有所不同。</p>
<p>关于 CA 证书的去向：我们在决定 CA 证书的去向前，必须先明确它包含了 CA 公钥和 CA 私钥，其中 CA 私钥是用来签署其他证书的，签完后一般不会再用，但极其重要，不能泄露，所以不能将包含私钥的 CA 证书放入项目中，而 CA 公钥是用来验证其他证书是否由该 CA 签发的，经常需要用到，因此我们应当将 CA 公钥从 CA 证书中导出用于使用，而原始 CA 证书则需要妥善保管。</p>
<p>这个操作可以在任意一台节点上完成，比如在 es-node1 上执行即可。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 1. 进入 ES 目录</span><br>cd <span class="hljs-regexp">/mystudy/</span>es/elasticsearch<br><br><span class="hljs-comment"># 2. 签发 ca 证书</span><br>sudo bin/elasticsearch-certutil ca<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 要求输入：</span><br><span class="hljs-string">	1. Please enter the desired output file [elastic-stack-ca.p12]:</span><br><span class="hljs-string">		1. 让你设置证书文件名</span><br><span class="hljs-string">		2. 我们直接 Enter，他会默认使用 elastic-stack-ca.p12</span><br><span class="hljs-string">	2. Enter password for elastic-stack-ca.p12:</span><br><span class="hljs-string">		1. 让你为 CA 证书设置一个密码</span><br><span class="hljs-string">		2. 这里不设置</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br><span class="hljs-comment"># 3. 导出 CA 公钥</span><br>openssl pkcs12 -<span class="hljs-keyword">in</span> elastic-stack-ca.p12 -nokeys -out ca.crt<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 要求输入：</span><br><span class="hljs-string">	1. Enter Import Password</span><br><span class="hljs-string">		1. 让你输入 CA 证书的密码</span><br><span class="hljs-string">		2. 这里不填写</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br><span class="hljs-comment"># 4. 将 CA 证书、CA 公钥放到存放证书目录下</span><br>mv elastic-stack-ca.p12 ca.crt config/certs<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="2-1-13-3-签发节点证书"><a href="#2-1-13-3-签发节点证书" class="headerlink" title="2.1.13.3. 签发节点证书"></a>2.1.13.3. 签发节点证书</h6><p>由于 Elasticsearch 强调分布式节点间的安全通信，要求各节点使用节点证书实现双向认证和数据加密，因此我们需要为节点生成证书。</p>
<p>这一操作可以在任意拥有 CA 私钥的节点上执行，而我们的 CA 私钥保存在 es-node1，所以就在 es-node1 上完成。</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># 1. 进入 ES 目录</span><br>cd /mystudy/es/elasticsearch<br><br><br><span class="hljs-section"># 2. 批量签发节点证书</span><br><br><span class="hljs-section"># 2.1. 创建并编辑 instances.yml（书写节点信息）</span><br>vim instances.yml<br>&quot;&quot;&quot;<br><span class="hljs-bullet">1.</span> 模版写法<br>instances:<br><span class="hljs-bullet">  -</span> name: es-node1<br><span class="hljs-code">    dns: [es-node.example.com]</span><br><span class="hljs-code">    ip:  [192.168.136.8, 192.168.136.9, 192.168.136.10]</span><br><span class="hljs-code">  - name: es-node2</span><br><span class="hljs-code">    dns: [es-node.example.com]</span><br><span class="hljs-code">    ip:  [192.168.136.8, 192.168.136.9, 192.168.136.10]</span><br><span class="hljs-code">  - name: es-node3</span><br><span class="hljs-code">    dns: [es-node.example.com]</span><br><span class="hljs-code">    ip:  [192.168.136.8, 192.168.136.9, 192.168.136.10]</span><br><span class="hljs-code"></span><br><span class="hljs-bullet">2.</span> 我的写法<br>instances:<br><span class="hljs-bullet">  -</span> name: es-node1<br><span class="hljs-code">    ip:  [192.168.136.8]</span><br><span class="hljs-code">  - name: es-node2</span><br><span class="hljs-code">    ip:  [192.168.136.9]</span><br><span class="hljs-code">  - name: es-node3</span><br><span class="hljs-code">    ip:  [192.168.136.10]</span><br><span class="hljs-code">&quot;&quot;&quot;</span><br><span class="hljs-code"></span><br><span class="hljs-section"># 2.2. 进行批量签发</span><br>bin/elasticsearch-certutil cert \<br>  --silent \<br>  --in instances.yml \<br>  --ca config/certs/elastic-stack-ca.p12 \<br>  --pem \<br>  --out certs.zip<br>&quot;&quot;&quot;<br><span class="hljs-bullet">1.</span> 参数说明：<br><span class="hljs-bullet">	1.</span> --silent：<br><span class="hljs-bullet">		1.</span> 不加 --silent 时，如果某些参数没写，会提示你输入<br><span class="hljs-bullet">		2.</span> 加了 --silent 时，不输出任何交互提示或额外信息，如果参数不完整会直接失败<br><span class="hljs-bullet">	2.</span> --in：<br><span class="hljs-bullet">		1.</span> 从 YAML 中读取节点列表<br><span class="hljs-bullet">	3.</span> --ca config/certs/elastic-stack-ca.p12：<br><span class="hljs-bullet">		1.</span> CA 私钥的位置，这里使用 CA 证书<br><span class="hljs-bullet">	4.</span> --pem：<br><span class="hljs-bullet">		1.</span> 输出 PEM 格式的节点证书和节点私钥<br><span class="hljs-bullet">	5.</span> --out certs.zip<br><span class="hljs-bullet">		1.</span> 输出为 certs.zip<br><span class="hljs-bullet">		2.</span> 解压后有多个文件夹，例如 es-node1、es-node2、es-node3<br><span class="hljs-bullet">		3.</span> 每个文件夹中都有独自的节点证书和节点私钥，例如 es-node1.key、es-node1.crt<br><span class="hljs-bullet">2.</span> 要求输入：<br><span class="hljs-bullet">	1.</span> Enter password for CA (config/certs/elastic-stack-ca.p12)：<br><span class="hljs-bullet">		1.</span> 让你输入 CA 证书的密码<br><span class="hljs-bullet">		2.</span> 这里不填写<br>&quot;&quot;&quot;&quot;<br><br><span class="hljs-section"># 2.3. 将 certs.zip 放到存放证书目录下，到时候与 HTTPS 证书一起处理</span><br>mv certs.zip config/certs<br><br><br><span class="hljs-section"># 3. 单独为节点进行签发</span><br><span class="hljs-section"># 3.1. 进行单独签发</span><br>bin/elasticsearch-certutil cert \<br>  --name es-node1 \<br>  --dns es-node1 \<br>  --ip 192.168.136.8 \<br>  --ca config/certs/elastic-stack-ca.p12 \<br>  --out es-node1.zip<br>&quot;&quot;&quot;<br><span class="hljs-bullet">1.</span> 要求输入：<br><span class="hljs-bullet">	1.</span> Enter password for CA (config/certs/elastic-stack-ca.p12)：<br><span class="hljs-bullet">		1.</span> 让你输入 CA 证书的密码<br><span class="hljs-bullet">		2.</span> 这里不填写<br><span class="hljs-bullet">	2.</span> Enter password for es-node1.zip：<br><span class="hljs-bullet">		1.</span> 让你输入 es-node1.zip 的加密密码<br><span class="hljs-bullet">		2.</span> 只有输入你刚设的密码才能解压，我们直接 Enter<br>&quot;&quot;&quot;<br><br><span class="hljs-section"># 3.3. 将 certs.zip 放到存放证书目录下，到时候与 HTTPS 证书一起处理</span><br>mv es-node1.zip config/certs<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="2-1-13-4-签发-HTTPS-证书"><a href="#2-1-13-4-签发-HTTPS-证书" class="headerlink" title="2.1.13.4. 签发 HTTPS 证书"></a>2.1.13.4. 签发 HTTPS 证书</h6><p>这一操作可以在任意拥有 CA 私钥的节点上执行，而我们的 CA 私钥保存在 es-node1，所以同样在 es-node1 上完成。</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs stata"># 1. 进入 ES 目录<br><span class="hljs-keyword">cd</span> /mystudy/es/elasticsearch<br><br><br># 2. 批量签发 HTTPS 证书<br><br># 2.1. 创建并编辑 http-instances.yml<br>vim http-instances.yml<br><span class="hljs-string">&quot;&quot;</span>&quot;<br>1. 模版写法<br>instances:<br>  - name: es-node1-http<br>    dns: [ <span class="hljs-string">&quot;es-node1&quot;</span> ]<br>    ip:  [ <span class="hljs-string">&quot;192.168.136.8&quot;</span> ]<br>  - name: es-node2-http<br>    dns: [ <span class="hljs-string">&quot;es-node2&quot;</span> ]<br>    ip:  [ <span class="hljs-string">&quot;192.168.136.9&quot;</span> ]<br>  - name: es-node3-http<br>    dns: [ <span class="hljs-string">&quot;es-node3&quot;</span> ]<br>    ip:  [ <span class="hljs-string">&quot;192.168.136.10&quot;</span> ]<br><br>2.我的写法<br>instances:<br>  - name: es-node1-http<br>    ip:  [ <span class="hljs-string">&quot;192.168.136.8&quot;</span> ]<br>  - name: es-node2-http<br>    ip:  [ <span class="hljs-string">&quot;192.168.136.9&quot;</span> ]<br>  - name: es-node3-http<br>    ip:  [ <span class="hljs-string">&quot;192.168.136.10&quot;</span> ]<br><span class="hljs-string">&quot;&quot;</span>&quot;<br><br># 2.2. 进行批量签发<br>bin/elasticsearch-certutil cert \<br>  --silent \<br>  --<span class="hljs-keyword">in</span> http-instances.yml \<br>  --<span class="hljs-keyword">ca</span>  config/certs/elastic-<span class="hljs-keyword">stack</span>-<span class="hljs-keyword">ca</span>.p12 \<br>  --pem \<br>  --<span class="hljs-keyword">out</span> http-certs.<span class="hljs-keyword">zip</span><br><span class="hljs-string">&quot;&quot;</span>&quot;<br>1. 要求输入：<br>	1. Enter password <span class="hljs-keyword">for</span> <span class="hljs-keyword">CA</span> (config/certs/elastic-<span class="hljs-keyword">stack</span>-<span class="hljs-keyword">ca</span>.p12)：<br>		1. 让你输入 <span class="hljs-keyword">CA</span> 证书的密码<br>		2. 这里不填写<br><span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;&quot;</span><br><br># 2.3. 将 http-certs.<span class="hljs-keyword">zip</span> 放到存放证书目录下，到时候与 节点 证书一起处理<br>mv http-certs.<span class="hljs-keyword">zip</span> config/certs<br><br><br># 3. 单独为节点进行签发<br># 3.1. 进行单独签发<br>bin/elasticsearch-certutil cert \<br>  --name es-node1 \<br>  --dns es-node1 \<br>  --ip 192.168.136.8 \<br>  --<span class="hljs-keyword">ca</span> config/certs/elastic-<span class="hljs-keyword">stack</span>-<span class="hljs-keyword">ca</span>.p12 \<br>  --pem \<br>  --<span class="hljs-keyword">out</span> es-node1-https.<span class="hljs-keyword">zip</span><br><span class="hljs-string">&quot;&quot;</span>&quot;<br>1. 要求输入：<br>	1. Enter password <span class="hljs-keyword">for</span> <span class="hljs-keyword">CA</span> (config/certs/elastic-<span class="hljs-keyword">stack</span>-<span class="hljs-keyword">ca</span>.p12)：<br>		1. 让你输入 <span class="hljs-keyword">CA</span> 证书的密码<br>		2. 这里不填写<br>	2. Enter password <span class="hljs-keyword">for</span> es-node3.<span class="hljs-keyword">zip</span>：<br>		1. 让你输入 es-node1.<span class="hljs-keyword">zip</span> 的加密密码<br>		2. 只有输入你刚设的密码才能解压，我们直接 Enter<br><span class="hljs-string">&quot;&quot;</span>&quot;<br><br># 3.3. 将 http-certs.<span class="hljs-keyword">zip</span> 放到存放证书目录下，到时候与 节点 证书一起处理<br>mv es-node1.<span class="hljs-keyword">zip</span> config/certs<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="2-1-13-5-分发证书"><a href="#2-1-13-5-分发证书" class="headerlink" title="2.1.13.5. 分发证书"></a>2.1.13.5. 分发证书</h6><ol>
<li>&#x3D;&#x3D;CA 证书&#x3D;&#x3D;：<ol>
<li>由于 CA 证书中包含 CA 私钥，因此我们需要妥善保管，等到下次需要签发新证书时再取出来使用，否则就让它静静躺在仓库里“吃灰”吧。  </li>
<li>你可能会问，那我验证这些证书是不是由本 CA 签发的，不也得有 CA 公钥吗？是的，CA 证书中确实同时包含了私钥和公钥。虽然私钥要严密保存，但没有公钥也不行。  </li>
<li>别担心，我们在生成节点证书的时候，已经从 CA 证书中提取了公钥部分，也就是 <code>ca.crt</code> 文件，这就是 CA 的公钥，用这个来验证签名就可以了。</li>
</ol>
</li>
<li>&#x3D;&#x3D;CA 公钥（ca.crt）&#x3D;&#x3D;：<ol>
<li>同步到所有节点</li>
</ol>
</li>
<li>&#x3D;&#x3D;节点证书&#x3D;&#x3D;<ol>
<li>各节点就用自己证书。比如 <code>es-node1</code> 的证书，别传给 <code>es-node2</code> 去用，各用各的，别串。</li>
</ol>
</li>
<li>&#x3D;&#x3D;HTTPS 证书&#x3D;&#x3D;：<ol>
<li>同样是各节点使用自己的证书，各用各的，别串。<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs gradle"># <span class="hljs-number">1</span>. 进入存放证书的目录<br>cd <span class="hljs-regexp">/mystudy/</span>es<span class="hljs-regexp">/elasticsearch/</span>config/certs<br><br><br># <span class="hljs-number">2</span>. 将 CA 证书好好保管，以后需要签发证书再拿出来<br><br><br># <span class="hljs-number">3</span>. 解压 节点 证书，分配到各自服务器的 <span class="hljs-regexp">/mystudy/</span>es<span class="hljs-regexp">/elasticsearch/</span>config/certs 目录下<br>unzip certs.zip <br><br><br># <span class="hljs-number">4</span>. 解压 HTTPS 证书，分配到各自服务器的 <span class="hljs-regexp">/mystudy/</span>es<span class="hljs-regexp">/elasticsearch/</span>config/certs 目录下<br>unzip http-certs.zip<br><br><br># <span class="hljs-number">5</span>. 将 CA 公钥（ca.crt）分配到每个服务器的 <span class="hljs-regexp">/mystudy/</span>es<span class="hljs-regexp">/elasticsearch/</span>config/certs 目录下<br></code></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<hr>
<h5 id="2-1-14-修改-ES-文件拥有者为-es"><a href="#2-1-14-修改-ES-文件拥有者为-es" class="headerlink" title="2.1.14. 修改 ES 文件拥有者为 es"></a>2.1.14. 修改 ES 文件拥有者为 es</h5><p>因为要启动 ES 了，所以7要将 ES 文件拥有者设置为 es，用 es 用户启动 ES</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">chown -R <span class="hljs-built_in">es</span>:<span class="hljs-built_in">es</span> /mystudy/<span class="hljs-built_in">es</span>/elasticsearch<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>为用户设置密码时，两次回车键就是无密码</li>
</ol>
</blockquote>
<hr>
<h5 id="2-1-15-启动第一个-ES"><a href="#2-1-15-启动第一个-ES" class="headerlink" title="2.1.15. 启动第一个 ES"></a>2.1.15. 启动第一个 ES</h5><h6 id="2-1-15-1-前言"><a href="#2-1-15-1-前言" class="headerlink" title="2.1.15.1. 前言"></a>2.1.15.1. 前言</h6><p>第一个 ES的启动至关重要，因为要初始化 ES 集群的元数据状态，后续要加入集群的节点也要找第一个节点当做中间人。</p>
<hr>
<h6 id="2-1-15-2-配置主配置文件：config-elasticsearch-yml"><a href="#2-1-15-2-配置主配置文件：config-elasticsearch-yml" class="headerlink" title="2.1.15.2. 配置主配置文件：config&#x2F;elasticsearch.yml"></a>2.1.15.2. 配置主配置文件：config&#x2F;elasticsearch.yml</h6><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-comment"># 1. 修改 ES 配置文件</span><br><span class="hljs-attribute">vim /mystudy/es/elasticsearch/config/elasticsearch.yml</span><br><span class="hljs-attribute">&quot;&quot;&quot;</span><br><span class="hljs-attribute">1. 注解版本</span><br><span class="hljs-attribute"># ================== 基础配置 ==================</span><br><span class="hljs-attribute"># 设置 ES 集群名称</span><br><span class="hljs-attribute">cluster.name</span><span class="hljs-punctuation">:</span> <span class="hljs-string">es-cluster                           # 同集群内的所有节点，集群名称必须一致</span><br><br><span class="hljs-comment"># 设置当前节点名称</span><br><span class="hljs-attribute">node.name</span><span class="hljs-punctuation">:</span> <span class="hljs-string">es-node1                                # 每个 ES 节点在 ES 集群中唯一的名字（不必须主机名，但推荐）</span><br><br><span class="hljs-comment"># 设置数据和日志文件路径</span><br><span class="hljs-attribute">path.data</span><span class="hljs-punctuation">:</span> <span class="hljs-string">/mystudy/es/elasticsearch/data</span><br><span class="hljs-attribute">path.logs</span><span class="hljs-punctuation">:</span> <span class="hljs-string">/mystudy/es/elasticsearch/log</span><br><br><span class="hljs-comment"># 设置网络访问地址和端口</span><br><span class="hljs-attribute">network.host</span><span class="hljs-punctuation">:</span> <span class="hljs-string">                                     # 配置 Elasticsearch 监听的网卡地址，影响 HTTP（9200）和节点通信（9300）</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">_local_</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">_site_      </span><br><span class="hljs-attribute">http.port</span><span class="hljs-punctuation">:</span> <span class="hljs-string">9200                                    # HTTP 接口已默认使用 9200 端口，如果需要更换可在此修改；</span><br><span class="hljs-attribute">http.host</span><span class="hljs-punctuation">:</span> <span class="hljs-string">[&quot;_local_&quot;, &quot;_site_&quot;]                   # 进一步细化 HTTP 的监听地址，会覆盖 network.host 的 HTTP 设置，通常无需单独配置 http.host，除非你希望 HTTP 和 Transport 分别绑定在不同的地址（如 HTTP 对外暴露，Transport 用于内网通信）</span><br><br><span class="hljs-comment"># 设置初始发现节点（后续节点加入集群中，需要这些节点作为中间人）</span><br><span class="hljs-attribute">discovery.seed_hosts</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;192.168.136.8&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;192.168.136.9&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;192.168.136.10&quot;</span><br><br><span class="hljs-comment"># 指定集群初始化主节点名称</span><br><span class="hljs-attribute">cluster.initial_master_nodes</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;es-node1&quot;                                      # 需注意，应填节点名称，不能填写 IP、主机名，并且只需要在第一个节点启动时指定。是用于指定集群初始化时的主节点，负责创建和初始化集群的元数据。一旦集群稳定并完成初始化后，该配置将不再起作用，随后通过内部选举选出的主节点将接管</span><br><br><span class="hljs-comment"># ================== 安全配置 ==================</span><br><span class="hljs-comment"># 开启安全认证</span><br><span class="hljs-attribute">xpack.security.enabled</span><span class="hljs-punctuation">:</span> <span class="hljs-string">true                        # 启用后，要使用 ES 内置的用户和角色进行身份验证才能访问集群资源。</span><br><span class="hljs-attribute">xpack.security.enrollment.enabled</span><span class="hljs-punctuation">:</span> <span class="hljs-string">true             # 启用后，开启节点间安全通信和身份验证</span><br><br><span class="hljs-comment"># 配置 HTTPS（HTTP 层 SSL）</span><br><span class="hljs-attribute">xpack.security.http.ssl</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">enabled</span><span class="hljs-punctuation">:</span> <span class="hljs-string">true</span><br>  <span class="hljs-attribute">certificate</span><span class="hljs-punctuation">:</span> <span class="hljs-string">/mystudy/es/elasticsearch/config/certs/es-node1-http.crt</span><br>  <span class="hljs-attribute">key</span><span class="hljs-punctuation">:</span> <span class="hljs-string">/mystudy/es/elasticsearch/config/certs/es-node1-http.key</span><br>  <span class="hljs-attribute">certificate_authorities</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">/mystudy/es/elasticsearch/config/certs/ca.crt</span><br>  <span class="hljs-attribute">client_authentication</span><span class="hljs-punctuation">:</span> <span class="hljs-string">none                       # 是否要求客户端上传证书</span><br>   <br><span class="hljs-comment"># 配置节点间通信加密（Transport 层 SSL）</span><br><span class="hljs-attribute">xpack.security.transport.ssl</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">enabled</span><span class="hljs-punctuation">:</span> <span class="hljs-string">true</span><br>  <span class="hljs-attribute">verification_mode</span><span class="hljs-punctuation">:</span> <span class="hljs-string">certificate</span><br>  <span class="hljs-attribute">certificate</span><span class="hljs-punctuation">:</span> <span class="hljs-string">/mystudy/es/elasticsearch/config/certs/es-node1.crt</span><br>  <span class="hljs-attribute">key</span><span class="hljs-punctuation">:</span> <span class="hljs-string">/mystudy/es/elasticsearch/config/certs/es-node1.key</span><br>  <span class="hljs-attribute">certificate_authorities</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">/mystudy/es/elasticsearch/config/certs/ca.crt</span><br><br><span class="hljs-attribute">2. 精简版本</span><br><span class="hljs-attribute"># 集群与节点</span><br><span class="hljs-attribute">cluster.name</span><span class="hljs-punctuation">:</span> <span class="hljs-string">es-cluster</span><br><span class="hljs-attribute">node.name</span><span class="hljs-punctuation">:</span> <span class="hljs-string">es-node1</span><br><br><span class="hljs-comment"># 存储路径</span><br><span class="hljs-attribute">path.data</span><span class="hljs-punctuation">:</span> <span class="hljs-string">/mystudy/es/elasticsearch/data</span><br><span class="hljs-attribute">path.logs</span><span class="hljs-punctuation">:</span> <span class="hljs-string">/mystudy/es/elasticsearch/log</span><br><br><span class="hljs-comment"># 网络配置</span><br><span class="hljs-attribute">network.host</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">_local_</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">_site_</span><br><span class="hljs-attribute">http.port</span><span class="hljs-punctuation">:</span> <span class="hljs-string">9200</span><br><br><span class="hljs-comment"># 集群发现</span><br><span class="hljs-attribute">discovery.seed_hosts</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;192.168.136.8&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;192.168.136.9&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;192.168.136.10&quot;</span><br><span class="hljs-attribute">cluster.initial_master_nodes</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;es-node1&quot;</span><br><br><span class="hljs-comment"># 可选：关闭 GeoIP 自动下载</span><br><span class="hljs-attribute">ingest.geoip.downloader.enabled</span><span class="hljs-punctuation">:</span> <span class="hljs-string">false</span><br><br><span class="hljs-comment"># 安全配置</span><br><span class="hljs-attribute">xpack.security.enabled</span><span class="hljs-punctuation">:</span> <span class="hljs-string">true</span><br><span class="hljs-attribute">xpack.security.enrollment.enabled</span><span class="hljs-punctuation">:</span> <span class="hljs-string">true</span><br><br><span class="hljs-comment"># HTTP 层 TLS</span><br><span class="hljs-attribute">xpack.security.http.ssl</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">enabled</span><span class="hljs-punctuation">:</span> <span class="hljs-string">true</span><br>  <span class="hljs-attribute">certificate</span><span class="hljs-punctuation">:</span> <span class="hljs-string">/mystudy/es/elasticsearch/config/certs/es-node1-http.crt</span><br>  <span class="hljs-attribute">key</span><span class="hljs-punctuation">:</span> <span class="hljs-string">/mystudy/es/elasticsearch/config/certs/es-node1-http.key</span><br>  <span class="hljs-attribute">certificate_authorities</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">/mystudy/es/elasticsearch/config/certs/ca.crt</span><br>  <span class="hljs-attribute">client_authentication</span><span class="hljs-punctuation">:</span> <span class="hljs-string">none</span><br><br><span class="hljs-comment"># Transport 层 TLS</span><br><span class="hljs-attribute">xpack.security.transport.ssl</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">enabled</span><span class="hljs-punctuation">:</span> <span class="hljs-string">true</span><br>  <span class="hljs-attribute">verification_mode</span><span class="hljs-punctuation">:</span> <span class="hljs-string">certificate</span><br>  <span class="hljs-attribute">certificate</span><span class="hljs-punctuation">:</span> <span class="hljs-string">/mystudy/es/elasticsearch/config/certs/es-node1.crt</span><br>  <span class="hljs-attribute">key</span><span class="hljs-punctuation">:</span> <span class="hljs-string">/mystudy/es/elasticsearch/config/certs/es-node1.key</span><br>  <span class="hljs-attribute">certificate_authorities</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">/mystudy/es/elasticsearch/config/certs/ca.crt</span><br>&quot;&quot;&quot;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项：</p>
<ol>
<li><code>network.host</code> 和 <code>http.host</code> 常用值<ol>
<li>见 IP 笔记</li>
</ol>
</li>
</ol>
</blockquote>
<hr>
<h6 id="2-1-15-3-启动第一个-ES"><a href="#2-1-15-3-启动第一个-ES" class="headerlink" title="2.1.15.3. 启动第一个 ES"></a>2.1.15.3. 启动第一个 ES</h6><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-comment"># 1. 切换 es 用户</span><br>su es<br><br><br><span class="hljs-comment"># 2. 进入 ES 目录</span><br>cd <span class="hljs-symbol">/mystudy/es/elasticsearch</span><br><br><br><span class="hljs-comment"># 3. 启动 ES（初次启动推荐前台启动）</span><br><span class="hljs-comment"># 3.1. 前台启动</span><br>bin<span class="hljs-symbol">/elasticsearch</span><br><br><span class="hljs-comment"># 3.2. 后台启动</span><br>bin<span class="hljs-symbol">/elasticsearch</span> <span class="hljs-operator">-</span>d<br><br><br><span class="hljs-comment"># 4. 保存密码信息</span><br>━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━<br>✅ Elasticsearch security features have been automatically configured<span class="hljs-operator">!</span><br>✅ Authentication is enabled and cluster connections are encrypted.<br><br>ℹ️  Password for the elastic user (reset <span class="hljs-keyword">with</span> `bin<span class="hljs-symbol">/elasticsearch-reset-password</span> <span class="hljs-operator">-</span>u elastic`):<br>  dc1hGRVxrQ<span class="hljs-operator">*</span>QR6rozhaJ<br><br><br><br>❌ Unable to generate an enrollment token for Kibana instances, try invoking `bin<span class="hljs-symbol">/elasticsearch-create-enrollment-token</span> <span class="hljs-operator">-</span>s kibana`.<br><br>❌ An enrollment token to enroll new nodes wasn&#x27;t generated. To add nodes and enroll them into this <span class="hljs-params">cluster:</span><br>• On this <span class="hljs-params">node:</span><br>  ⁃ Create an enrollment token <span class="hljs-keyword">with</span> `bin<span class="hljs-symbol">/elasticsearch-create-enrollment-token</span> <span class="hljs-operator">-</span>s node`.<br>  ⁃ Restart Elasticsearch.<br>• On other <span class="hljs-params">nodes:</span><br>  ⁃ Start Elasticsearch <span class="hljs-keyword">with</span> `bin<span class="hljs-symbol">/elasticsearch</span> <span class="hljs-operator">-</span>-enrollment-token <span class="hljs-symbol">&lt;token&gt;</span>`, using the enrollment token that you generated.<br>━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━<br><br><br><span class="hljs-comment"># 5. 提取主要内容</span><br>用户名（默认的超级管理员用户）：elastic<br>初始密码：dc1hGRVxrQ<span class="hljs-operator">*</span>QR6rozhaJ<br><br><br><span class="hljs-comment"># 6. 重设 elastic 密码（如果忘记密码或未记录密码，执行此命令将会设置一个随机密码）</span><br>bin<span class="hljs-symbol">/elasticsearch-reset-password</span> <span class="hljs-operator">-</span>u elastic<br><br><br><span class="hljs-comment"># 7. 重设 elastic 密码（适用于已知当前密码的情况，若不记得密码请先通过第 6 步设置随机密码）</span><br>curl <span class="hljs-operator">-</span>k <span class="hljs-operator">-</span>u elastic:<span class="hljs-operator">&lt;</span>当前密码<span class="hljs-operator">&gt;</span> <span class="hljs-operator">-</span>X POST <span class="hljs-string">&quot;https://&lt;本 ES 节点IP&gt;:9200/_security/user/elastic/_password&quot;</span> <span class="hljs-operator">-</span>H &#x27;<span class="hljs-params">Content-Type:</span> application<span class="hljs-operator">/</span>json&#x27; <span class="hljs-operator">-</span>d &#x27;&#123;<br>  <span class="hljs-string">&quot;password&quot;</span> : <span class="hljs-string">&quot;&lt;新密码&gt;&quot;</span><br>&#125;&#x27;<br><br><br><span class="hljs-comment"># 8. 补充：如何停止 ES</span><br>ps aux | grep elasticsearch<br><br>kill <span class="hljs-operator">-</span><span class="hljs-number">9</span> <span class="hljs-number">123456</span><br><br><br><span class="hljs-comment"># 9. 补充：如何重置 ES（删除 ES 数据即可）</span><br>sudo rm <span class="hljs-operator">-</span>rf <span class="hljs-operator">/</span>mystudy<span class="hljs-operator">/</span>es<span class="hljs-operator">/</span>elasticsearch<span class="hljs-operator">/</span>data<span class="hljs-comment">/*</span><br></code></pre></td></tr></table></figure>

<hr>
<h6 id="2-1-15-4-访问服务器节点"><a href="#2-1-15-4-访问服务器节点" class="headerlink" title="2.1.15.4. 访问服务器节点"></a>2.1.15.4. 访问服务器节点</h6><p>访问服务器节点，返回下述内容即证明部署成功： <a target="_blank" rel="noopener" href="https://192.168.136.8:9200/">https://192.168.136.8:9200</a></p>
<p><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250417090125699.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<h5 id="2-1-16-启动其他-ES"><a href="#2-1-16-启动其他-ES" class="headerlink" title="2.1.16. 启动其他 ES"></a>2.1.16. 启动其他 ES</h5><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-comment"># 1. 修改 ES 配置文件</span><br><span class="hljs-attribute">vim /mystudy/es/elasticsearch/config/elasticsearch.yml</span><br><span class="hljs-attribute">&quot;&quot;&quot;</span><br><span class="hljs-attribute">1. 注意事项</span><br><span class="hljs-attribute">	1. 配置内容基本上与第一个节点一致，只需要改这三处</span><br><span class="hljs-attribute">		1. 设置节点名称：</span><br><span class="hljs-attribute">			1. node.name</span><span class="hljs-punctuation">:</span> <span class="hljs-string">es-nodeX</span><br>		<span class="hljs-attribute">2. 去掉 cluster.initial_master_nodes</span><br><span class="hljs-attribute">		3. TLS 证书配置中，node1 改成nodeX</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">2. 我的写法</span><br><span class="hljs-attribute"># 集群与节点</span><br><span class="hljs-attribute">cluster.name</span><span class="hljs-punctuation">:</span> <span class="hljs-string">es-cluster</span><br><span class="hljs-attribute">node.name</span><span class="hljs-punctuation">:</span> <span class="hljs-string">es-node1</span><br><br><span class="hljs-comment"># 存储路径</span><br><span class="hljs-attribute">path.data</span><span class="hljs-punctuation">:</span> <span class="hljs-string">/mystudy/es/elasticsearch/data</span><br><span class="hljs-attribute">path.logs</span><span class="hljs-punctuation">:</span> <span class="hljs-string">/mystudy/es/elasticsearch/log</span><br><br><span class="hljs-comment"># 网络配置</span><br><span class="hljs-attribute">network.host</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">_local_</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">_site_</span><br><span class="hljs-attribute">http.port</span><span class="hljs-punctuation">:</span> <span class="hljs-string">9200</span><br><br><span class="hljs-comment"># 集群发现</span><br><span class="hljs-attribute">discovery.seed_hosts</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;192.168.136.8&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;192.168.136.9&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;192.168.136.10&quot;</span><br><br><span class="hljs-comment"># 可选：关闭 GeoIP 自动下载</span><br><span class="hljs-attribute">ingest.geoip.downloader.enabled</span><span class="hljs-punctuation">:</span> <span class="hljs-string">false</span><br><br><span class="hljs-comment"># 安全配置</span><br><span class="hljs-attribute">xpack.security.enabled</span><span class="hljs-punctuation">:</span> <span class="hljs-string">true</span><br><span class="hljs-attribute">xpack.security.enrollment.enabled</span><span class="hljs-punctuation">:</span> <span class="hljs-string">true</span><br><br><span class="hljs-comment"># HTTP 层 TLS</span><br><span class="hljs-attribute">xpack.security.http.ssl</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">enabled</span><span class="hljs-punctuation">:</span> <span class="hljs-string">true</span><br>  <span class="hljs-attribute">certificate</span><span class="hljs-punctuation">:</span> <span class="hljs-string">/mystudy/es/elasticsearch/config/certs/es-node1-http.crt</span><br>  <span class="hljs-attribute">key</span><span class="hljs-punctuation">:</span> <span class="hljs-string">/mystudy/es/elasticsearch/config/certs/es-node1-http.key</span><br>  <span class="hljs-attribute">certificate_authorities</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">/mystudy/es/elasticsearch/config/certs/ca.crt</span><br>  <span class="hljs-attribute">client_authentication</span><span class="hljs-punctuation">:</span> <span class="hljs-string">none</span><br><br><span class="hljs-comment"># Transport 层 TLS</span><br><span class="hljs-attribute">xpack.security.transport.ssl</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">enabled</span><span class="hljs-punctuation">:</span> <span class="hljs-string">true</span><br>  <span class="hljs-attribute">verification_mode</span><span class="hljs-punctuation">:</span> <span class="hljs-string">certificate</span><br>  <span class="hljs-attribute">certificate</span><span class="hljs-punctuation">:</span> <span class="hljs-string">/mystudy/es/elasticsearch/config/certs/es-node1.crt</span><br>  <span class="hljs-attribute">key</span><span class="hljs-punctuation">:</span> <span class="hljs-string">/mystudy/es/elasticsearch/config/certs/es-node1.key</span><br>  <span class="hljs-attribute">certificate_authorities</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">/mystudy/es/elasticsearch/config/certs/ca.crt</span><br>&quot;&quot;&quot;<br><br><br><span class="hljs-comment"># 2. 切换 es 用户</span><br>su es<br><br><br><span class="hljs-comment"># 3. 进入 ES 目录</span><br>cd /mystudy/es/elasticsearch<br><br><br><span class="hljs-comment"># 4. 启动 Node ES（后台启动）</span><br>bin/elasticsearch -d<br><br><br><span class="hljs-comment"># 5. 访问服务器节点</span><br>https://192.168.136.X:9200/<br></code></pre></td></tr></table></figure>

<hr>
<h5 id="2-1-17-脚本大帝"><a href="#2-1-17-脚本大帝" class="headerlink" title="2.1.17. 脚本大帝"></a>2.1.17. 脚本大帝</h5><h6 id="2-1-17-1-步骤"><a href="#2-1-17-1-步骤" class="headerlink" title="2.1.17.1. 步骤"></a>2.1.17.1. 步骤</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. 配置 SSH 密钥对认证</span><br><span class="hljs-built_in">sudo</span> ssh-keygen -t rsa -b 4096 -C <span class="hljs-string">&quot;your_email@example.com&quot;</span><br><br>ssh-keyscan -H 192.168.136.9 &gt;&gt; ~/.ssh/known_hosts <br><br>ssh-keyscan -H 192.168.136.10 &gt;&gt; ~/.ssh/known_hosts<br><br>ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.136.9<br><br>ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.136.10<br><br>ssh root@192.168.136.9<br><br><span class="hljs-built_in">exit</span><br><br><br><span class="hljs-comment"># 2. 设置代理，启动 NAT 服务</span><br><span class="hljs-built_in">export</span> http_proxy=<span class="hljs-string">&quot;http://172.20.10.3:7890&quot;</span> &amp;&amp; <span class="hljs-built_in">export</span> https_proxy=<span class="hljs-string">&quot;http://172.20.10.3:7890&quot;</span> &amp;&amp; <span class="hljs-built_in">export</span> no_proxy=<span class="hljs-string">&quot;localhost,127.0.0.1,.svc,.cluster.local,192.168.136.0/24,10.96.0.1,10.244.0.0/16&quot;</span> &amp;&amp; <span class="hljs-built_in">export</span> HTTP_PROXY=<span class="hljs-variable">$http_proxy</span> &amp;&amp; <span class="hljs-built_in">export</span> HTTPS_PROXY=<span class="hljs-variable">$https_proxy</span> &amp;&amp; <span class="hljs-built_in">export</span> NO_PROXY=<span class="hljs-variable">$no_proxy</span><br><br><br><span class="hljs-comment"># 3. 创建 /mystudy/es 目录</span><br><span class="hljs-built_in">mkdir</span> -p /mystudy/es<br><br><br><span class="hljs-comment"># 4. 进入 /mystudy/es 目录</span><br><span class="hljs-built_in">cd</span> /mystudy/es<br><br><br><span class="hljs-comment"># 5. 上传 ES 文件到 /mystudy/es 目录</span><br><br><br><span class="hljs-comment"># 6. 创建并编写 Shell 脚本</span><br><span class="hljs-built_in">sudo</span> vim es-shell.sh<br><br><br><span class="hljs-comment"># 7. 添加可执行权限</span><br><span class="hljs-built_in">chmod</span> +x es-shell.sh<br><br><br><span class="hljs-comment"># 8. 安装 dos2unix</span><br><span class="hljs-built_in">command</span> -v dos2unix &gt;/dev/null 2&gt;&amp;1 || <span class="hljs-built_in">sudo</span> apt-get install -y dos2unix<br><br><br><span class="hljs-comment"># 9. 将脚本转为 Unix 格式</span><br>dos2unix es-shell.sh<br><br><br><span class="hljs-comment"># 10. 执行 Shell 脚本</span><br>./es-shell.sh<br><br><br><span class="hljs-comment"># 11. 从 启动第一个 ES 继续向下手动执行</span><br></code></pre></td></tr></table></figure>

<hr>
<h6 id="2-1-17-2-脚本精简版"><a href="#2-1-17-2-脚本精简版" class="headerlink" title="2.1.17.2. 脚本精简版"></a>2.1.17.2. 脚本精简版</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-comment"># -------------------------------- 开启严格模式 ---------------------------------------------</span><br><span class="hljs-built_in">set</span> -euo pipefail<br><br><span class="hljs-comment"># -------------------------------- 检查是否以 root 权限运行 ---------------------------------------------</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-subst">$(id -u)</span>&quot;</span> != <span class="hljs-string">&quot;0&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;这个脚本需要以 root 用户运行&quot;</span> &gt;&amp;2<br>    <span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># -------------------------------- 声明变量 ---------------------------------------------</span><br><br>work_directory=<span class="hljs-string">&quot;/mystudy/es/elasticsearch&quot;</span><br>es_package=<span class="hljs-string">&quot;elasticsearch-8.18.0-linux-x86_64.tar.gz&quot;</span><br>es_init_name=<span class="hljs-string">&quot;elasticsearch-8.18.0&quot;</span><br><br><span class="hljs-comment"># -------------------------------- 安装 openssl ---------------------------------------------</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始安装 openssl&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;检查 openssl 是否已安装&quot;</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v openssl &gt;/dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;openssl 已安装，跳过安装&quot;</span><br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;未检测到 openssl，正在安装...&quot;</span><br>    max_retries=3<br>    retry_count=0<br>    <span class="hljs-keyword">until</span> apt-get install -y openssl; <span class="hljs-keyword">do</span><br>        retry_count=$((retry_count + <span class="hljs-number">1</span>))<br>        <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$retry_count</span>&quot;</span> -ge <span class="hljs-string">&quot;<span class="hljs-variable">$max_retries</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>            <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;安装 openssl 已尝试 <span class="hljs-variable">$&#123;retry_count&#125;</span> 次，仍然失败&quot;</span> &gt;&amp;2<br>            <span class="hljs-built_in">exit</span> 1<br>        <span class="hljs-keyword">fi</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;安装失败，第 <span class="hljs-variable">$&#123;retry_count&#125;</span> 次重试，立即重新尝试...&quot;</span><br>    <span class="hljs-keyword">done</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;openssl 安装完成&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># -------------------------------- 安装 chrony ---------------------------------------------</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始安装 chrony&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;检查 chrony 是否已安装&quot;</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v chronyd &gt;/dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;chrony 已安装，跳过安装&quot;</span><br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;未检测到 chrony，正在安装...&quot;</span><br>    max_retries=3<br>    retry_count=0<br>    <span class="hljs-keyword">until</span> apt-get update &amp;&amp; apt-get install -y chrony; <span class="hljs-keyword">do</span><br>        retry_count=$((retry_count + <span class="hljs-number">1</span>))<br>        <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$retry_count</span>&quot;</span> -ge <span class="hljs-string">&quot;<span class="hljs-variable">$max_retries</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>            <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;安装 chrony 已尝试 <span class="hljs-variable">$&#123;retry_count&#125;</span> 次，仍然失败&quot;</span> &gt;&amp;2<br>            <span class="hljs-built_in">exit</span> 1<br>        <span class="hljs-keyword">fi</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;安装失败，第 <span class="hljs-variable">$&#123;retry_count&#125;</span> 次重试，立即重新尝试...&quot;</span><br>        <span class="hljs-built_in">sleep</span> 2<br>    <span class="hljs-keyword">done</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;chrony 安装完成&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># -------------------------------- 时间同步 ---------------------------------------------</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始时间同步&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;正在启动 chrony 服务...&quot;</span><br><span class="hljs-keyword">if</span> systemctl <span class="hljs-built_in">enable</span> chrony &amp;&amp; systemctl start chrony; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;chrony 服务已启动&quot;</span><br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;启动 chrony 失败&quot;</span> &gt;&amp;2<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># -------------------------------- 创建 es 用户 ---------------------------------------------</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始创建 es 用户&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;删除已有 es 用户（包括其主目录）&quot;</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">id</span> <span class="hljs-string">&quot;es&quot;</span> &amp;&gt;/dev/null; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;检测到已有 es 用户，正在删除...&quot;</span><br>    userdel -r es<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;已删除旧的 es 用户&quot;</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;新增 es 用户&quot;</span><br>useradd -m -s /bin/bash es<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;为 es 用户设置密码（wq666）&quot;</span><br>passwd es<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;创建 es 用户完成&quot;</span><br><br><span class="hljs-comment"># -------------------------------- 关闭 Swap 分区 ---------------------------------------------</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始关闭 Swap 分区&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;将 内容注释&quot;</span><br>sed -i <span class="hljs-string">&#x27;/^[^#].*\bswap\b/ s/^/#/&#x27;</span> /etc/fstab<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;立即关闭 Swap 分区&quot;</span><br>swapoff -a<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;关闭 Swap 分区完成&quot;</span><br><br><span class="hljs-comment"># -------------------------------- 开放 9200、9300 TCP 端口 ---------------------------------------------</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始开放 9200、9300 TCP 端口&quot;</span><br>ufw allow 9200/tcp &amp;&amp; ufw allow 9300/tcp<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开放 9200、9300 TCP 端口完成&quot;</span><br><br><span class="hljs-comment"># -------------------------------- 设置主机名、主机名互相解析 ---------------------------------------------</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始设置主机名、主机名互相解析&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;获取本机内网 IP 地址&quot;</span><br>INTERFACE=$(ip <span class="hljs-built_in">link</span> | grep -oP <span class="hljs-string">&#x27;^[0-9]+: \K[^:]+&#x27;</span> | grep -v lo | <span class="hljs-built_in">head</span> -1)<br>LOCAL_IP=$(ip addr show <span class="hljs-string">&quot;<span class="hljs-variable">$INTERFACE</span>&quot;</span> | grep -oP <span class="hljs-string">&#x27;inet \K[\d.]+&#x27;</span> | <span class="hljs-built_in">head</span> -1)<br><span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$LOCAL_IP</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;不能获取本机 IP 地址&quot;</span> &gt;&amp;2<br>    <span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;本机内网 IP 地址获取成功：<span class="hljs-variable">$LOCAL_IP</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;设置本机主机名&quot;</span><br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;<span class="hljs-variable">$LOCAL_IP</span>&quot;</span> <span class="hljs-keyword">in</span><br>    <span class="hljs-string">&quot;192.168.136.8&quot;</span>)<br>        HOSTNAME=<span class="hljs-string">&quot;es-node1&quot;</span><br>        ;;<br>    <span class="hljs-string">&quot;192.168.136.9&quot;</span>)<br>        HOSTNAME=<span class="hljs-string">&quot;es-node2&quot;</span><br>        ;;<br>    <span class="hljs-string">&quot;192.168.136.10&quot;</span>)<br>        HOSTNAME=<span class="hljs-string">&quot;es-node3&quot;</span><br>        ;;<br>    *)<br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;IP <span class="hljs-variable">$LOCAL_IP</span> does not match any configured hostname&quot;</span> &gt;&amp;2<br>        <span class="hljs-built_in">exit</span> 1<br>        ;;<br><span class="hljs-keyword">esac</span><br>hostnamectl set-hostname <span class="hljs-string">&quot;<span class="hljs-variable">$HOSTNAME</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;设置主机名互相解析&quot;</span><br>HOSTS_CONTENT=<span class="hljs-string">&quot;</span><br><span class="hljs-string">192.168.136.8   es-node1</span><br><span class="hljs-string">192.168.136.9   es-node2</span><br><span class="hljs-string">192.168.136.10  es-node3&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;检查 /etc/hosts 是否已包含指定追加内容&quot;</span><br><span class="hljs-keyword">if</span> grep -Fx <span class="hljs-string">&quot;<span class="hljs-variable">$HOSTS_CONTENT</span>&quot;</span> /etc/hosts &gt; /dev/null; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;主机名解析记录已存在，跳过添加&quot;</span><br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$HOSTS_CONTENT</span>&quot;</span> &gt;&gt; /etc/hosts<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;主机名解析记录已添加&quot;</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;设置主机名、主机名互相解析完成&quot;</span><br><br><span class="hljs-comment"># -------------------------------- 安装 ES ---------------------------------------------</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始安装 ES&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;进入 /mystudy/es 目录&quot;</span><br><span class="hljs-built_in">cd</span> /mystudy/es<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;删除已存在 ES 目录&quot;</span><br><span class="hljs-keyword">if</span> [ -d <span class="hljs-string">&quot;<span class="hljs-variable">$work_directory</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;检测到已存在 ES 目录，准备删除...&quot;</span><br>    <span class="hljs-built_in">rm</span> -rf <span class="hljs-string">&quot;<span class="hljs-variable">$work_directory</span>&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;ES 目录已删除&quot;</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;检查是否存在 ES 安装包&quot;</span><br><span class="hljs-keyword">if</span> [ ! -f <span class="hljs-string">&quot;<span class="hljs-variable">$es_package</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;ES 安装包不存在&quot;</span> &gt;&amp;2<br>    <span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;解压&quot;</span><br>tar -zxvf <span class="hljs-variable">$es_package</span> -C /mystudy/es<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;重命名&quot;</span><br><span class="hljs-built_in">mv</span> <span class="hljs-string">&quot;<span class="hljs-variable">$es_init_name</span>&quot;</span> elasticsearch<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;安装 ES 完成&quot;</span><br><br><span class="hljs-comment"># -------------------------------- 创建存放 ES 数据的目录 ---------------------------------------------</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始创建存放 ES 数据的目录&quot;</span><br><span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$work_directory</span>/data<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;创建存放 ES 数据的目录完成&quot;</span><br><br><span class="hljs-comment"># -------------------------------- 创建存放证书的目录 ---------------------------------------------</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始创建存放证书的目录&quot;</span><br><span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$work_directory</span>/config/certs<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;创建存放证书的目录完成&quot;</span><br><br><span class="hljs-comment"># -------------------------------- 生成 CA 证书、CA 公钥（192.168.136.8） ---------------------------------------------</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$LOCAL_IP</span>&quot;</span> = <span class="hljs-string">&quot;192.168.136.8&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始在 192.168.136.8 上生成 CA 证书、CA 公钥&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;进入 ES 目录&quot;</span><br>    <span class="hljs-built_in">cd</span> <span class="hljs-variable">$work_directory</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;签发 ca 证书&quot;</span><br>    bin/elasticsearch-certutil ca<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;导出 CA 公钥&quot;</span><br>    openssl pkcs12 -<span class="hljs-keyword">in</span> elastic-stack-ca.p12 -nokeys -out ca.crt<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;将 CA 证书、CA 公钥放到存放证书目录下&quot;</span><br>    <span class="hljs-built_in">mv</span> elastic-stack-ca.p12 ca.crt <span class="hljs-variable">$work_directory</span>/config/certs/<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;生成 CA 证书、CA 公钥完成&quot;</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-comment"># -------------------------------- 签发节点证书（192.168.136.8） ---------------------------------------------</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$LOCAL_IP</span>&quot;</span> = <span class="hljs-string">&quot;192.168.136.8&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始在 192.168.136.8 上签发节点证书&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;进入 ES 目录&quot;</span><br>    <span class="hljs-built_in">cd</span> <span class="hljs-variable">$work_directory</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;批量签发节点证书&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;创建并编辑 instances.yml&quot;</span><br>    <span class="hljs-built_in">cat</span> &gt; instances.yml &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">instances:</span><br><span class="hljs-string">  - name: es-node1</span><br><span class="hljs-string">    ip:</span><br><span class="hljs-string">      - &quot;192.168.136.8&quot;</span><br><span class="hljs-string">  - name: es-node2</span><br><span class="hljs-string">    ip:</span><br><span class="hljs-string">      - &quot;192.168.136.9&quot;</span><br><span class="hljs-string">  - name: es-node3</span><br><span class="hljs-string">    ip:</span><br><span class="hljs-string">      - &quot;192.168.136.10&quot;</span><br><span class="hljs-string">EOF</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;进行批量签发&quot;</span><br>    bin/elasticsearch-certutil cert \<br>        --silent \<br>        --<span class="hljs-keyword">in</span> instances.yml \<br>        --ca config/certs/elastic-stack-ca.p12 \<br>        --pem \<br>        --out certs.zip<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;将 certs.zip 放到存放证书目录下&quot;</span><br>    <span class="hljs-built_in">mv</span> certs.zip config/certs/<br>    <span class="hljs-built_in">rm</span> -rf instances.yml<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;签发节点证书完成&quot;</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-comment"># -------------------------------- 签发 HTTPS 证书（192.168.136.8） ---------------------------------------------</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$LOCAL_IP</span>&quot;</span> = <span class="hljs-string">&quot;192.168.136.8&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始在192.168.136.8 上签发 HTTPS 证书&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;进入 ES 目录&quot;</span><br>    <span class="hljs-built_in">cd</span> <span class="hljs-variable">$work_directory</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;批量签发 HTTPS 证书&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;创建并编辑 http-instances.yml&quot;</span><br>    <span class="hljs-built_in">cat</span> &gt; http-instances.yml &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">instances:</span><br><span class="hljs-string">  - name: es-node1-http</span><br><span class="hljs-string">    ip:</span><br><span class="hljs-string">      - &quot;192.168.136.8&quot;</span><br><span class="hljs-string">  - name: es-node2-http</span><br><span class="hljs-string">    ip:</span><br><span class="hljs-string">      - &quot;192.168.136.9&quot;</span><br><span class="hljs-string">  - name: es-node3-http</span><br><span class="hljs-string">    ip:</span><br><span class="hljs-string">      - &quot;192.168.136.10&quot;</span><br><span class="hljs-string">EOF</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;进行批量签发&quot;</span><br>    bin/elasticsearch-certutil cert \<br>      --silent \<br>      --<span class="hljs-keyword">in</span> http-instances.yml \<br>      --ca  config/certs/elastic-stack-ca.p12 \<br>      --pem \<br>      --out http-certs.zip<br>    <span class="hljs-built_in">mv</span> http-certs.zip config/certs/<br>    <span class="hljs-built_in">rm</span> -rf http-instances.yml<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;签发 HTTPS 证书完成&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># -------------------------------- 分发证书（192.168.136.8） ---------------------------------------------</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$LOCAL_IP</span>&quot;</span> = <span class="hljs-string">&quot;192.168.136.8&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始在 192.168.136.8 上分发证书&quot;</span><br>    <span class="hljs-built_in">cd</span> <span class="hljs-variable">$work_directory</span>/config/certs<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;分发节点证书&quot;</span><br>    unzip certs.zip <br>    <span class="hljs-built_in">mv</span> <span class="hljs-variable">$work_directory</span>/config/certs/es-node1/es-node1.&#123;crt,key&#125; <span class="hljs-variable">$work_directory</span>/config/certs/<br>    scp <span class="hljs-variable">$work_directory</span>/config/certs/es-node2/es-node2.&#123;crt,key&#125; \<br>        root@192.168.136.9:<span class="hljs-variable">$work_directory</span>/config/certs/<br>    scp <span class="hljs-variable">$work_directory</span>/config/certs/es-node3/es-node3.&#123;crt,key&#125; \<br>        root@192.168.136.10:<span class="hljs-variable">$work_directory</span>/config/certs/<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;分发HTTPS 证书&quot;</span><br>    unzip http-certs.zip<br>    <span class="hljs-built_in">mv</span> <span class="hljs-variable">$work_directory</span>/config/certs/es-node1-http/es-node1-http.&#123;crt,key&#125; <span class="hljs-variable">$work_directory</span>/config/certs/<br>    scp <span class="hljs-variable">$work_directory</span>/config/certs/es-node2-http/es-node2-http.&#123;crt,key&#125; \<br>        root@192.168.136.9:<span class="hljs-variable">$work_directory</span>/config/certs/<br>    scp <span class="hljs-variable">$work_directory</span>/config/certs/es-node3-http/es-node3-http.&#123;crt,key&#125; \<br>        root@192.168.136.10:<span class="hljs-variable">$work_directory</span>/config/certs/<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;分发 CA 公钥&quot;</span><br>    scp <span class="hljs-variable">$work_directory</span>/config/certs/ca.crt \<br>        root@192.168.136.9:<span class="hljs-variable">$work_directory</span>/config/certs/<br>    scp <span class="hljs-variable">$work_directory</span>/config/certs/ca.crt \<br>        root@192.168.136.10:<span class="hljs-variable">$work_directory</span>/config/certs/<br>    <span class="hljs-built_in">rm</span> -rf es-node1 es-node1-http es-node2 es-node2-http es-node3 es-node3-http certs.zip http-certs.zip<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;分发证书完成&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># -------------------------------- 修改 ES 文件拥有者为 es ---------------------------------------------</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始修改 ES 文件拥有者为 es&quot;</span><br><span class="hljs-built_in">chown</span> -R es:es <span class="hljs-variable">$work_directory</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;修改 ES 文件拥有者为 es 完成&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;本节点脚本执行结束&quot;</span><br></code></pre></td></tr></table></figure>

<hr>
<h6 id="2-1-17-3-脚本注释版"><a href="#2-1-17-3-脚本注释版" class="headerlink" title="2.1.17.3. 脚本注释版"></a>2.1.17.3. 脚本注释版</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-comment"># -------------------------------- 开启严格模式 ---------------------------------------------</span><br><span class="hljs-built_in">set</span> -euo pipefail<br><br><span class="hljs-comment"># -------------------------------- 检查是否以 root 权限运行 ---------------------------------------------</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-subst">$(id -u)</span>&quot;</span> != <span class="hljs-string">&quot;0&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;这个脚本需要以 root 用户运行&quot;</span> &gt;&amp;2<br>    <span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># -------------------------------- 声明变量 ---------------------------------------------</span><br><br>work_directory=<span class="hljs-string">&quot;/mystudy/es/elasticsearch&quot;</span><br>es_package=<span class="hljs-string">&quot;elasticsearch-8.18.0-linux-x86_64.tar.gz&quot;</span><br>es_init_name=<span class="hljs-string">&quot;elasticsearch-8.18.0&quot;</span><br><br><span class="hljs-comment"># -------------------------------- 安装 openssl ---------------------------------------------</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始安装 openssl&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;检查 openssl 是否已安装&quot;</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v openssl &gt;/dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;openssl 已安装，跳过安装&quot;</span><br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;未检测到 openssl，正在安装...&quot;</span><br>    max_retries=3<br>    retry_count=0<br>    <span class="hljs-keyword">until</span> apt-get install -y openssl; <span class="hljs-keyword">do</span><br>        retry_count=$((retry_count + <span class="hljs-number">1</span>))<br>        <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$retry_count</span>&quot;</span> -ge <span class="hljs-string">&quot;<span class="hljs-variable">$max_retries</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>            <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;安装 openssl 已尝试 <span class="hljs-variable">$&#123;retry_count&#125;</span> 次，仍然失败&quot;</span> &gt;&amp;2<br>            <span class="hljs-built_in">exit</span> 1<br>        <span class="hljs-keyword">fi</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;安装失败，第 <span class="hljs-variable">$&#123;retry_count&#125;</span> 次重试，立即重新尝试...&quot;</span><br>    <span class="hljs-keyword">done</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;openssl 安装完成&quot;</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">1. command -v openssl：</span><br><span class="hljs-string">	1. command -v openssl 用于检测 openssl 命令是否存在于当前系统的环境变量 PATH 指定的路径中</span><br><span class="hljs-string">	2. 如果找到了，会输出完整路径（例如 /usr/bin/openssl），并返回退出码 0（true），表示命令执行成功、任务也成功（即找到了）</span><br><span class="hljs-string">	3. 如果找不到，不会输出任何内容，但命令本身仍然成功执行，只是任务失败（未找到命令），这时返回退出码为 1（false）</span><br><span class="hljs-string">2. &gt;/dev/null</span><br><span class="hljs-string">	1. &gt; 是输出重定向符，默认只作用于标准输出（stdout）。</span><br><span class="hljs-string">	2. /dev/null 是 Linux 中的“黑洞”文件，任何输出重定向到这里都会被吞掉，相当于“我不想看到这个输出”。</span><br><span class="hljs-string">	3. 因此，&gt;/dev/null 表示：将命令的标准输出重定向到黑洞中，不显示在终端上。</span><br><span class="hljs-string">3. 2&gt;&amp;1</span><br><span class="hljs-string">	1. 1 表示标准输出，2 表示标准错误输出</span><br><span class="hljs-string">	2. 2&gt;&amp;1 的意思是：“将标准错误重定向到标准输出的输出位置上”</span><br><span class="hljs-string">	3. 因为前面已经执行了 &gt;/dev/null，所以标准输出已经被扔进黑洞了，这时候标准错误也跟着一起被重定向到黑洞。</span><br><span class="hljs-string">4. if...then...else...fi</span><br><span class="hljs-string">5. max_retries=3</span><br><span class="hljs-string">	1. 最大重试次数，总共 3 + 1 次</span><br><span class="hljs-string">6. retry_count=0</span><br><span class="hljs-string">	1. 已重试的次数</span><br><span class="hljs-string">7. until apt-get install -y openssl; do</span><br><span class="hljs-string">	1. 执行 apt-get install -y openssl; 成功就退出循环，不成功就继续循环</span><br><span class="hljs-string">&quot;</span><span class="hljs-string">&quot;&quot;</span><br><br><span class="hljs-comment"># -------------------------------- 安装 chrony ---------------------------------------------</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始安装 chrony&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;检查 chrony 是否已安装&quot;</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v chronyd &gt;/dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;chrony 已安装，跳过安装&quot;</span><br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;未检测到 chrony，正在安装...&quot;</span><br>    max_retries=3<br>    retry_count=0<br>    <span class="hljs-keyword">until</span> apt-get update &amp;&amp; apt-get install -y chrony; <span class="hljs-keyword">do</span><br>        retry_count=$((retry_count + <span class="hljs-number">1</span>))<br>        <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$retry_count</span>&quot;</span> -ge <span class="hljs-string">&quot;<span class="hljs-variable">$max_retries</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>            <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;安装 chrony 已尝试 <span class="hljs-variable">$&#123;retry_count&#125;</span> 次，仍然失败&quot;</span> &gt;&amp;2<br>            <span class="hljs-built_in">exit</span> 1<br>        <span class="hljs-keyword">fi</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;安装失败，第 <span class="hljs-variable">$&#123;retry_count&#125;</span> 次重试，立即重新尝试...&quot;</span><br>        <span class="hljs-built_in">sleep</span> 2<br>    <span class="hljs-keyword">done</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;chrony 安装完成&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># -------------------------------- 时间同步 ---------------------------------------------</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始时间同步&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;正在启动 chrony 服务...&quot;</span><br><span class="hljs-keyword">if</span> systemctl <span class="hljs-built_in">enable</span> chrony &amp;&amp; systemctl start chrony; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;chrony 服务已启动&quot;</span><br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;启动 chrony 失败&quot;</span> &gt;&amp;2<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># -------------------------------- 创建 es 用户 ---------------------------------------------</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始创建 es 用户&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;删除已有 es 用户（包括其主目录）&quot;</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">id</span> <span class="hljs-string">&quot;es&quot;</span> &amp;&gt;/dev/null; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;检测到已有 es 用户，正在删除...&quot;</span><br>    userdel -r es<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;已删除旧的 es 用户&quot;</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;新增 es 用户&quot;</span><br>useradd -m -s /bin/bash es<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;为 es 用户设置密码（wq666）&quot;</span><br>passwd es<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;创建 es 用户完成&quot;</span><br><span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">1. id &quot;</span>es<span class="hljs-string">&quot;</span><br><span class="hljs-string">	1. 用于检查 es 用户是否存在</span><br><span class="hljs-string">	2. 如果存在，会输出例如：uid=1001(es) gid=1001(es) groups=1001(es)</span><br><span class="hljs-string">2. userdel -r es</span><br><span class="hljs-string">	1. 删除用户和其主目录</span><br><span class="hljs-string">&quot;</span><span class="hljs-string">&quot;&quot;</span><br><br><span class="hljs-comment"># -------------------------------- 关闭 Swap 分区 ---------------------------------------------</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始关闭 Swap 分区&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;将 内容注释&quot;</span><br>sed -i <span class="hljs-string">&#x27;/^[^#].*\bswap\b/ s/^/#/&#x27;</span> /etc/fstab<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;立即关闭 Swap 分区&quot;</span><br>swapoff -a<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;关闭 Swap 分区完成&quot;</span><br><br><span class="hljs-comment"># -------------------------------- 开放 9200、9300 TCP 端口 ---------------------------------------------</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始开放 9200、9300 TCP 端口&quot;</span><br>ufw allow 9200/tcp &amp;&amp; ufw allow 9300/tcp<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开放 9200、9300 TCP 端口完成&quot;</span><br><br><span class="hljs-comment"># -------------------------------- 设置主机名、主机名互相解析 ---------------------------------------------</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始设置主机名、主机名互相解析&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;获取本机内网 IP 地址&quot;</span><br>INTERFACE=$(ip <span class="hljs-built_in">link</span> | grep -oP <span class="hljs-string">&#x27;^[0-9]+: \K[^:]+&#x27;</span> | grep -v lo | <span class="hljs-built_in">head</span> -1)<br>LOCAL_IP=$(ip addr show <span class="hljs-string">&quot;<span class="hljs-variable">$INTERFACE</span>&quot;</span> | grep -oP <span class="hljs-string">&#x27;inet \K[\d.]+&#x27;</span> | <span class="hljs-built_in">head</span> -1)<br><span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$LOCAL_IP</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;不能获取本机 IP 地址&quot;</span> &gt;&amp;2<br>    <span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;本机内网 IP 地址获取成功：<span class="hljs-variable">$LOCAL_IP</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;设置本机主机名&quot;</span><br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;<span class="hljs-variable">$LOCAL_IP</span>&quot;</span> <span class="hljs-keyword">in</span><br>    <span class="hljs-string">&quot;192.168.136.8&quot;</span>)<br>        HOSTNAME=<span class="hljs-string">&quot;es-node1&quot;</span><br>        ;;<br>    <span class="hljs-string">&quot;192.168.136.9&quot;</span>)<br>        HOSTNAME=<span class="hljs-string">&quot;es-node2&quot;</span><br>        ;;<br>    <span class="hljs-string">&quot;192.168.136.10&quot;</span>)<br>        HOSTNAME=<span class="hljs-string">&quot;es-node3&quot;</span><br>        ;;<br>    *)<br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;IP <span class="hljs-variable">$LOCAL_IP</span> does not match any configured hostname&quot;</span> &gt;&amp;2<br>        <span class="hljs-built_in">exit</span> 1<br>        ;;<br><span class="hljs-keyword">esac</span><br>hostnamectl set-hostname <span class="hljs-string">&quot;<span class="hljs-variable">$HOSTNAME</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;设置主机名互相解析&quot;</span><br>HOSTS_CONTENT=<span class="hljs-string">&quot;</span><br><span class="hljs-string">192.168.136.8   es-node1</span><br><span class="hljs-string">192.168.136.9   es-node2</span><br><span class="hljs-string">192.168.136.10  es-node3&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;检查 /etc/hosts 是否已包含指定追加内容&quot;</span><br><span class="hljs-keyword">if</span> grep -Fx <span class="hljs-string">&quot;<span class="hljs-variable">$HOSTS_CONTENT</span>&quot;</span> /etc/hosts &gt; /dev/null; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;主机名解析记录已存在，跳过添加&quot;</span><br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$HOSTS_CONTENT</span>&quot;</span> &gt;&gt; /etc/hosts<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;主机名解析记录已添加&quot;</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;设置主机名、主机名互相解析完成&quot;</span><br><br><span class="hljs-comment"># -------------------------------- 安装 ES ---------------------------------------------</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始安装 ES&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;进入 /mystudy/es 目录&quot;</span><br><span class="hljs-built_in">cd</span> /mystudy/es<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;删除已存在 ES 目录&quot;</span><br><span class="hljs-keyword">if</span> [ -d <span class="hljs-string">&quot;<span class="hljs-variable">$work_directory</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;检测到已存在 ES 目录，准备删除...&quot;</span><br>    <span class="hljs-built_in">rm</span> -rf <span class="hljs-string">&quot;<span class="hljs-variable">$work_directory</span>&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;ES 目录已删除&quot;</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;检查是否存在 ES 安装包&quot;</span><br><span class="hljs-keyword">if</span> [ ! -f <span class="hljs-string">&quot;<span class="hljs-variable">$es_package</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;ES 安装包不存在&quot;</span> &gt;&amp;2<br>    <span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;解压&quot;</span><br>tar -zxvf <span class="hljs-variable">$es_package</span> -C /mystudy/es<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;重命名&quot;</span><br><span class="hljs-built_in">mv</span> <span class="hljs-string">&quot;<span class="hljs-variable">$es_init_name</span>&quot;</span> elasticsearch<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;安装 ES 完成&quot;</span><br><span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">1. [ -d &quot;</span>path<span class="hljs-string">&quot; ]:</span><br><span class="hljs-string">	1. path 是一个存在的目录吗？</span><br><span class="hljs-string">	2. 类似的有：</span><br><span class="hljs-string">		1. -f &quot;</span>path<span class="hljs-string">&quot;：</span><br><span class="hljs-string">			1. path 是一个存在的文件吗？</span><br><span class="hljs-string">		2. -e &quot;</span>path<span class="hljs-string">&quot;：</span><br><span class="hljs-string">			1. path 是一个存在的路径吗？（文件或目录）</span><br><span class="hljs-string">&quot;</span><span class="hljs-string">&quot;&quot;</span><br><br><span class="hljs-comment"># -------------------------------- 创建存放 ES 数据的目录 ---------------------------------------------</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始创建存放 ES 数据的目录&quot;</span><br><span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$work_directory</span>/data<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;创建存放 ES 数据的目录完成&quot;</span><br><br><span class="hljs-comment"># -------------------------------- 创建存放证书的目录 ---------------------------------------------</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始创建存放证书的目录&quot;</span><br><span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$work_directory</span>/config/certs<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;创建存放证书的目录完成&quot;</span><br><br><span class="hljs-comment"># -------------------------------- 生成 CA 证书、CA 公钥（192.168.136.8） ---------------------------------------------</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$LOCAL_IP</span>&quot;</span> = <span class="hljs-string">&quot;192.168.136.8&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始在 192.168.136.8 上生成 CA 证书、CA 公钥&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;进入 ES 目录&quot;</span><br>    <span class="hljs-built_in">cd</span> <span class="hljs-variable">$work_directory</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;签发 ca 证书&quot;</span><br>    bin/elasticsearch-certutil ca<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;导出 CA 公钥&quot;</span><br>    openssl pkcs12 -<span class="hljs-keyword">in</span> elastic-stack-ca.p12 -nokeys -out ca.crt<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;将 CA 证书、CA 公钥放到存放证书目录下&quot;</span><br>    <span class="hljs-built_in">mv</span> elastic-stack-ca.p12 ca.crt <span class="hljs-variable">$work_directory</span>/config/certs/<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;生成 CA 证书、CA 公钥完成&quot;</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-comment"># -------------------------------- 签发节点证书（192.168.136.8） ---------------------------------------------</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$LOCAL_IP</span>&quot;</span> = <span class="hljs-string">&quot;192.168.136.8&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始在 192.168.136.8 上签发节点证书&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;进入 ES 目录&quot;</span><br>    <span class="hljs-built_in">cd</span> <span class="hljs-variable">$work_directory</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;批量签发节点证书&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;创建并编辑 instances.yml&quot;</span><br>    <span class="hljs-built_in">cat</span> &gt; instances.yml &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">instances:</span><br><span class="hljs-string">  - name: es-node1</span><br><span class="hljs-string">    ip:</span><br><span class="hljs-string">      - &quot;192.168.136.8&quot;</span><br><span class="hljs-string">  - name: es-node2</span><br><span class="hljs-string">    ip:</span><br><span class="hljs-string">      - &quot;192.168.136.9&quot;</span><br><span class="hljs-string">  - name: es-node3</span><br><span class="hljs-string">    ip:</span><br><span class="hljs-string">      - &quot;192.168.136.10&quot;</span><br><span class="hljs-string">EOF</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;进行批量签发&quot;</span><br>    bin/elasticsearch-certutil cert \<br>        --silent \<br>        --<span class="hljs-keyword">in</span> instances.yml \<br>        --ca config/certs/elastic-stack-ca.p12 \<br>        --pem \<br>        --out certs.zip<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;将 certs.zip 放到存放证书目录下&quot;</span><br>    <span class="hljs-built_in">mv</span> certs.zip config/certs/<br>    <span class="hljs-built_in">rm</span> -rf instances.yml<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;签发节点证书完成&quot;</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-comment"># -------------------------------- 签发 HTTPS 证书（192.168.136.8） ---------------------------------------------</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$LOCAL_IP</span>&quot;</span> = <span class="hljs-string">&quot;192.168.136.8&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始在192.168.136.8 上签发 HTTPS 证书&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;进入 ES 目录&quot;</span><br>    <span class="hljs-built_in">cd</span> <span class="hljs-variable">$work_directory</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;批量签发 HTTPS 证书&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;创建并编辑 http-instances.yml&quot;</span><br>    <span class="hljs-built_in">cat</span> &gt; http-instances.yml &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">instances:</span><br><span class="hljs-string">  - name: es-node1-http</span><br><span class="hljs-string">    ip:</span><br><span class="hljs-string">      - &quot;192.168.136.8&quot;</span><br><span class="hljs-string">  - name: es-node2-http</span><br><span class="hljs-string">    ip:</span><br><span class="hljs-string">      - &quot;192.168.136.9&quot;</span><br><span class="hljs-string">  - name: es-node3-http</span><br><span class="hljs-string">    ip:</span><br><span class="hljs-string">      - &quot;192.168.136.10&quot;</span><br><span class="hljs-string">EOF</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;进行批量签发&quot;</span><br>    bin/elasticsearch-certutil cert \<br>      --silent \<br>      --<span class="hljs-keyword">in</span> http-instances.yml \<br>      --ca  config/certs/elastic-stack-ca.p12 \<br>      --pem \<br>      --out http-certs.zip<br>    <span class="hljs-built_in">mv</span> http-certs.zip config/certs/<br>    <span class="hljs-built_in">rm</span> -rf http-instances.yml<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;签发 HTTPS 证书完成&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># -------------------------------- 分发证书（192.168.136.8） ---------------------------------------------</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$LOCAL_IP</span>&quot;</span> = <span class="hljs-string">&quot;192.168.136.8&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始在 192.168.136.8 上分发证书&quot;</span><br>    <span class="hljs-built_in">cd</span> <span class="hljs-variable">$work_directory</span>/config/certs<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;分发节点证书&quot;</span><br>    unzip certs.zip <br>    <span class="hljs-built_in">mv</span> <span class="hljs-variable">$work_directory</span>/config/certs/es-node1/es-node1.&#123;crt,key&#125; <span class="hljs-variable">$work_directory</span>/config/certs/<br>    scp <span class="hljs-variable">$work_directory</span>/config/certs/es-node2/es-node2.&#123;crt,key&#125; \<br>        root@192.168.136.9:<span class="hljs-variable">$work_directory</span>/config/certs/<br>    scp <span class="hljs-variable">$work_directory</span>/config/certs/es-node3/es-node3.&#123;crt,key&#125; \<br>        root@192.168.136.10:<span class="hljs-variable">$work_directory</span>/config/certs/<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;分发HTTPS 证书&quot;</span><br>    unzip http-certs.zip<br>    <span class="hljs-built_in">mv</span> <span class="hljs-variable">$work_directory</span>/config/certs/es-node1-http/es-node1-http.&#123;crt,key&#125; <span class="hljs-variable">$work_directory</span>/config/certs/<br>    scp <span class="hljs-variable">$work_directory</span>/config/certs/es-node2-http/es-node2-http.&#123;crt,key&#125; \<br>        root@192.168.136.9:<span class="hljs-variable">$work_directory</span>/config/certs/<br>    scp <span class="hljs-variable">$work_directory</span>/config/certs/es-node3-http/es-node3-http.&#123;crt,key&#125; \<br>        root@192.168.136.10:<span class="hljs-variable">$work_directory</span>/config/certs/<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;分发 CA 公钥&quot;</span><br>    scp <span class="hljs-variable">$work_directory</span>/config/certs/ca.crt \<br>        root@192.168.136.9:<span class="hljs-variable">$work_directory</span>/config/certs/<br>    scp <span class="hljs-variable">$work_directory</span>/config/certs/ca.crt \<br>        root@192.168.136.10:<span class="hljs-variable">$work_directory</span>/config/certs/<br>    <span class="hljs-built_in">rm</span> -rf es-node1 es-node1-http es-node2 es-node2-http es-node3 es-node3-http certs.zip http-certs.zip<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;分发证书完成&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># -------------------------------- 修改 ES 文件拥有者为 es ---------------------------------------------</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始修改 ES 文件拥有者为 es&quot;</span><br><span class="hljs-built_in">chown</span> -R es:es <span class="hljs-variable">$work_directory</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;修改 ES 文件拥有者为 es 完成&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;本节点脚本执行结束&quot;</span><br></code></pre></td></tr></table></figure>

<hr>
<h3 id="3-高可用生产集群搭建"><a href="#3-高可用生产集群搭建" class="headerlink" title="3. 高可用生产集群搭建"></a>3. 高可用生产集群搭建</h3><h3 id="4-常见问题"><a href="#4-常见问题" class="headerlink" title="4. 常见问题"></a>4. 常见问题</h3><h4 id="4-1-停掉几个节点之后，ES-集群不可用"><a href="#4-1-停掉几个节点之后，ES-集群不可用" class="headerlink" title="4.1. 停掉几个节点之后，ES 集群不可用"></a>4.1. 停掉几个节点之后，ES 集群不可用</h4><p>在停掉几个节点后，发现 Elasticsearch 和 Kibana 都无法使用，这很可能是由于 Elasticsearch 集群不可用，可能原因是无法选出主节点。</p>
<p>我们之前说：Master 节点必须获得 <strong>超过</strong> N&#x2F;2 + 1 的投票（不含“等于”）才能成为 Leader，N 为历史上加入过集群的节点总数，即使节点已下线，其记录仍计入 N。因此我们必须保证集群中大多数节点存活时才可完成选举，例如 3 节点必须保证 2 节点存活。</p>
<p>所以，通过启动两台服务器，问题应该能得到解决。</p>
<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>以上说明的前提是：每个节点都是 Master 节点</li>
</ol>
</blockquote>
<hr>
<h1 id="三、工具"><a href="#三、工具" class="headerlink" title="三、工具"></a>三、工具</h1><h3 id="1-Kibana"><a href="#1-Kibana" class="headerlink" title="1. Kibana"></a>1. Kibana</h3><h4 id="1-1-Kibana-概述"><a href="#1-1-Kibana-概述" class="headerlink" title="1.1. Kibana 概述"></a>1.1. Kibana 概述</h4><p>Kibana 是 ELK 三件套中的 “K”：</p>
<ul>
<li><strong>E</strong>lasticsearch：负责数据的存储、计算与搜索</li>
<li><strong>L</strong>ogstash（或 Filebeat）：负责数据抓取</li>
<li><strong>K</strong>ibana：负责数据的可视化与分析</li>
</ul>
<hr>
<h4 id="1-2-Kibana-高可用实现"><a href="#1-2-Kibana-高可用实现" class="headerlink" title="1.2. Kibana 高可用实现"></a>1.2. Kibana 高可用实现</h4><h5 id="1-2-1-节点规划"><a href="#1-2-1-节点规划" class="headerlink" title="1.2.1. 节点规划"></a>1.2.1. 节点规划</h5><p>Kibana 的部署数量没有强制要求，也不需要必须部署在 Elasticsearch 所在的服务器上。只要 Kibana 能访问 Elasticsearch 集群，就可以部署在任意一台服务器上。根据集群规模和可用性需求，推荐的部署数量如下：</p>
<table>
<thead>
<tr>
<th>ES 节点数量</th>
<th>Kibana 节点数量</th>
</tr>
</thead>
<tbody><tr>
<td>1 ~ 3 个</td>
<td>1 个 Kibana 实例即可满足需求</td>
</tr>
<tr>
<td>3 ~ 10 个</td>
<td>1 ~ 2 个 Kibana + 反向代理 + 负载均衡</td>
</tr>
<tr>
<td>高可用场景</td>
<td>多个 Kibana 实例 + 反向代理 + 负载均衡</td>
</tr>
</tbody></table>
<hr>
<h4 id="1-3-Kibana-使用"><a href="#1-3-Kibana-使用" class="headerlink" title="1.3. Kibana 使用"></a>1.3. Kibana 使用</h4><h5 id="1-3-1-节点列表"><a href="#1-3-1-节点列表" class="headerlink" title="1.3.1. 节点列表"></a>1.3.1. 节点列表</h5><p>由于当前处于测试学习阶段，且节点资源有限，暂不考虑实现高可用架构。此处仅部署一个 Kibana 实例，部署位置为服务器 <code>192.168.136.8</code>。</p>
<table>
<thead>
<tr>
<th>IP</th>
<th>主机名</th>
<th>介绍</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.136.8</td>
<td>node1</td>
<td>master-eligible、data、ingest、coordinating、kibana</td>
</tr>
</tbody></table>
<hr>
<h5 id="1-3-2-下载-Kibana-安装包"><a href="#1-3-2-下载-Kibana-安装包" class="headerlink" title="1.3.2. 下载 Kibana 安装包"></a>1.3.2. 下载 Kibana 安装包</h5><p>从 <a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/past-releases#kibana">Kibana 下载地址</a>下载 Kibana 安装包，注意要和 ES 版本一致：<br><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250417102403638.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<h5 id="1-3-3-将-Kibana-安装包上传到机器并解压"><a href="#1-3-3-将-Kibana-安装包上传到机器并解压" class="headerlink" title="1.3.3. 将 Kibana 安装包上传到机器并解压"></a>1.3.3. 将 Kibana 安装包上传到机器并解压</h5><p>在此步骤中，我将 Kibana 安装包上传至 <code>/mystudy/kibana</code> 目录，并直接在该目录中进行了解压。</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># 1. 进入目录</span><br><span class="hljs-attribute">cd</span> /mystudy/kibana<br><br><br><span class="hljs-comment"># 2. 解压</span><br><span class="hljs-attribute">tar</span> -zxvf  kibana-<span class="hljs-number">8</span>.<span class="hljs-number">18</span>.<span class="hljs-number">0</span>-linux-x86_64.tar.gz -C /mystudy/kibana<br><br><br><span class="hljs-comment"># 3. 重命名</span><br><span class="hljs-attribute">mv</span> kibana-<span class="hljs-number">8</span>.<span class="hljs-number">18</span>.<span class="hljs-number">0</span> kibana<br></code></pre></td></tr></table></figure>

<hr>
<h5 id="1-3-4-为-Kibana-生成-HTTPS-证书"><a href="#1-3-4-为-Kibana-生成-HTTPS-证书" class="headerlink" title="1.3.4. 为 Kibana 生成 HTTPS 证书"></a>1.3.4. 为 Kibana 生成 HTTPS 证书</h5><p>由于我们需要通过浏览器访问 Kibana，并要以 HTTPS 的方式进行安全访问，因此需要为 Kibana 配置 HTTPS 证书。</p>
<p>如果 kibana 和 es 在同一台服务器上，我们完全可以服用es 的https 证书，当然，如果 es 和 kibana 不在同一服务器上，我们需要为 kibana 整一个https 证书，我们可以使用es 提供的ca签发https 证书，也可以使用自己的方式签发 https 证书，这都无所谓，因为是我们客户端访问kibana，无需ca 一致，当然这是私网，如果公网访问还是要正儿八经去权威ca申请https 证书</p>
<p>但是建议 ca 一致，如果 Kibana 使用的证书和 Elasticsearch 使用的证书都来自同一个 CA，Elasticsearch 会默认信任来自 Kibana 的请求（如果开启了 <code>xpack.security</code> 和 <code>ssl</code>）。</p>
<p>那我们用 ca 证书签一个吧，一般在 ca 服务器上，因为有es 提供的cert 工具</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /mystudy/es/elasticsearch<br><br>bin/elasticsearch-certutil cert \<br>  --name kibana1 \<br>  --ip 192.168.136.8 \<br>  --ca config/certs/elastic-stack-ca.p12 \<br>  --pem \<br>  --out kibana1-certs.zip<br><br><br><br>拿到 kibana1-certs.zip<br><br>解压文件<br>unzip kibana1-certs.zip<br><br><br><span class="hljs-comment"># 4. 将解压后的文件移动到 kibana 的 config 目录</span><br><span class="hljs-built_in">cd</span> /mystudy/kibana/kibana/config<br><br><span class="hljs-built_in">mv</span> kibana/kibana.csr kibana/kibana.key /mystudy/kibana/kibana/config/<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. 进入 ES 目录</span><br><span class="hljs-built_in">cd</span> /mystudy/es/elasticsearch<br><br><br><span class="hljs-comment"># 2. 为 Kibana 生成 csr（一次空格）</span><br>bin/elasticsearch-certutil csr -name kibana -dns node1<br><br><br><span class="hljs-comment"># 3. 解压文件</span><br>unzip csr-bundle.zip<br><br><br><span class="hljs-comment"># 4. 将解压后的文件移动到 kibana 的 config 目录</span><br><span class="hljs-built_in">mv</span> kibana/kibana.csr kibana/kibana.key /mystudy/kibana/kibana/config/<br><br><br><span class="hljs-comment"># 5. 进入 Kibana/config 目录</span><br><span class="hljs-built_in">cd</span> /mystudy/kibana/kibana/config<br><br><br><span class="hljs-comment"># 6. 生成自签名证书</span><br>openssl x509 -req -<span class="hljs-keyword">in</span> kibana.csr -signkey kibana.key -out kibana.crt<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>上面的移动，是基于 ES 节点和 Kibana 节点相同，如果不同，自己想办法</li>
</ol>
</blockquote>
<hr>
<h5 id="1-3-5-为-Kibana-配置服务用户"><a href="#1-3-5-为-Kibana-配置服务用户" class="headerlink" title="1.3.5. 为 Kibana 配置服务用户"></a>1.3.5. 为 Kibana 配置服务用户</h5><p>服务账户专用于 Kibana 与 Elasticsearch 之间的通信，登录 Kibana 时使用的也是这个账户。</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-comment"># 1. 进入 ES 目录</span><br><span class="hljs-keyword">cd</span> <span class="hljs-string">/mystudy/es/elasticsearch</span><br><br><br><span class="hljs-comment"># 2. 设置 kibana 密码（自定义密码）</span><br>curl -k -u elastic:&lt;elastic 密码&gt; -X POST <span class="hljs-string">&quot;https://&lt;随意 ES 节点IP&gt;:9200/_security/user/kibana/_password&quot;</span> \<br>  -H <span class="hljs-string">&quot;Content-Type: application/json&quot;</span> \<br>  -d &#x27;&#123;<br>    <span class="hljs-string">&quot;password&quot;</span>: <span class="hljs-string">&quot;&lt;新密码&gt;&quot;</span><br>&#125;&#x27;<br><br>curl -k -u elastic<span class="hljs-function">:wq666666</span> -X POST <span class="hljs-string">&quot;https://192.168.136.8:9200/_security/user/kibana/_password&quot;</span> \<br>  -H <span class="hljs-string">&quot;Content-Type: application/json&quot;</span> \<br>  -d &#x27;&#123;<br>    <span class="hljs-string">&quot;password&quot;</span>: <span class="hljs-string">&quot;wq666666&quot;</span><br>&#125;&#x27;<br></code></pre></td></tr></table></figure>

<hr>
<h5 id="1-3-6-修改-Kibana-主配置文件：config-kibana-yml"><a href="#1-3-6-修改-Kibana-主配置文件：config-kibana-yml" class="headerlink" title="1.3.6. 修改 Kibana 主配置文件：config&#x2F;kibana.yml"></a>1.3.6. 修改 Kibana 主配置文件：config&#x2F;kibana.yml</h5><p>Kibana 的连接流程（关键原理）<br>Kibana 启动时，它做的是：</p>
<ol>
<li><p><strong>连接你在 <code>elasticsearch.hosts</code> 配置里写的节点</strong>之一；</p>
</li>
<li><p>如果连上了，Kibana 会调用该节点的 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster.html"><strong>Cluster Info API</strong></a>；</p>
</li>
<li><p>从集群返回的响应里，它能看到整个集群的节点列表，包括你后来加的新节点；</p>
</li>
<li><p>然后 Kibana 后续的请求，就可以分发到整个集群的任意节点（由 Elasticsearch 自己决定）。</p>
</li>
</ol>
<p>所以 <strong>不是每次新增节点都要改 <code>kibana.yml</code><strong>，</strong>只要原来配置的节点还活着</strong>，看似<code>elasticsearch.hosts: [&quot;https://192.168.136.8:9200&quot;, &quot;https://192.168.136.9:9200&quot;, &quot;https://192.168.136.10:9200&quot;]</code>只配置了三个，只要我们连接上一个，就能获得最新的信息，但是如果三个都连接不上就坏事了</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-comment"># 1. 修改配置文件</span><br>vim <span class="hljs-symbol">/mystudy/kibana/kibana/config/kibana.yml</span><br><br><br><span class="hljs-comment"># 2. 添加下述内容</span><br><span class="hljs-comment"># 服务端口</span><br>server.<span class="hljs-params">port:</span> <span class="hljs-number">5601</span><br><br><span class="hljs-comment"># Kibana 服务主机地址</span><br>server.<span class="hljs-params">host:</span> <span class="hljs-string">&quot;192.168.136.8&quot;</span><br><br><span class="hljs-comment"># 国际化 - 中文</span><br>i18n.<span class="hljs-params">locale:</span> <span class="hljs-string">&quot;zh-CN&quot;</span><br><br><span class="hljs-comment"># Elasticsearch 服务主机地址</span><br>elasticsearch.<span class="hljs-params">hosts:</span> [<span class="hljs-string">&quot;https://192.168.136.8:9200&quot;</span>, <span class="hljs-string">&quot;https://192.168.136.9:9200&quot;</span>, <span class="hljs-string">&quot;https://192.168.136.10:9200&quot;</span>]<br><br><br><span class="hljs-comment"># 访问 Elasticsearch 服务的账号密码</span><br>elasticsearch.<span class="hljs-params">username:</span> <span class="hljs-string">&quot;kibana&quot;</span><br>elasticsearch.<span class="hljs-params">password:</span> <span class="hljs-string">&quot;wq666666&quot;</span><br><br><span class="hljs-comment"># Elasticsearch SSL 设置</span><br>elasticsearch.ssl.<span class="hljs-params">verificationMode:</span> none<br>elasticsearch.ssl.<span class="hljs-params">certificateAuthorities:</span><br>  <span class="hljs-operator">-</span> <span class="hljs-string">&quot;/mystudy/es/elasticsearch/config/certs/ca.crt&quot;</span><br><br><span class="hljs-comment"># Kibana 服务 SSL 设置</span><br>server.ssl.<span class="hljs-params">enabled:</span> <span class="hljs-literal">true</span><br>server.ssl.<span class="hljs-params">certificate:</span> <span class="hljs-string">&quot;/mystudy/kibana/kibana/config/kibana1.crt&quot;</span><br>server.ssl.<span class="hljs-params">key:</span> <span class="hljs-string">&quot;/mystudy/kibana/kibana/config/kibana1.key&quot;</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li><code>kibana</code> 是 Elasticsearch 默认提供的服务账号，专用于 Kibana 与 ES 通信，不应使用具有最高权限的 <code>elastic</code> 超管账号进行配置</li>
</ol>
</blockquote>
<p><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250501142642453.png" srcset="/img/loading.gif" lazyload></p>
<p>监听的地址，监听的网卡，与es 的http.host类似，但是没有_local_ 这种那么灵活的</p>
<p>Kibana 会按你 <code>elasticsearch.hosts</code> 列表的顺序尝试连接：它会逐一 ping 列表里的地址，直到找到一个能连通的节点才算启动成功。</p>
<p>如果当前连接的挂掉，他可能需要一段时间反应，来连接下一个，只要还有至少一个 ES 实例可用，Kibana 本身就不会中断服务，也不会让你下线或重新登录，当然，如果kibana 本身依赖的 ES 不可用，那 Kibana 也不能用了</p>
<p>例如你Kibana 部署在136.8，虽然你136.8还启动，但是 ES 集群不可用，那你访问 <code>https://192.168.136.8:5601/spaces/enter</code> 很大可能进不去，然后我们可能需要启动多台es 服务器，才能重新进去kibana</p>
<hr>
<h5 id="1-3-7-创建-kibana-用户"><a href="#1-3-7-创建-kibana-用户" class="headerlink" title="1.3.7. 创建 kibana 用户"></a>1.3.7. 创建 kibana 用户</h5><p>该账户不同于前面提到的服务账户。服务账户专用于 Kibana 与 Elasticsearch 之间的通信，登录 Kibana 时使用的也是这个账户。</p>
<p>这里的账户是由于 Kibana 也不允许以 root 用户身份运行，因此我们需要创建一个名为 <code>kibana</code> 的用户，并使用该用户进行后续的操作和配置。</p>
<p>但是由于我们的 Elasticsearch 和 Kibana 部署在同一台主机上，因此我们可以直接复用 <code>es</code> 用户来启动 Kibana，而不需要单独创建 <code>kibana</code> 用户啦</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. 切换 root 用户</span><br>su root<br><br><br><span class="hljs-comment"># 2. 修改 Kibana 文件拥有者为 es</span><br><span class="hljs-built_in">chown</span> -R es:es /mystudy/kibana/kibana<br><br><br><span class="hljs-comment"># 3. 切换回 es 用户</span><br>su es<br></code></pre></td></tr></table></figure>

<hr>
<h5 id="1-3-8-启动-Kibana"><a href="#1-3-8-启动-Kibana" class="headerlink" title="1.3.8. 启动 Kibana"></a>1.3.8. 启动 Kibana</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. 切换 es 用户</span><br>su es<br><br><br><span class="hljs-comment"># 2. 进入 Kibana 目录</span><br><span class="hljs-built_in">cd</span> /mystudy/kibana/kibana<br><br><br><span class="hljs-comment"># 3. 启动 Kibana</span><br><span class="hljs-comment"># 3.1. 前台启动</span><br>bin/kibana<br><br><span class="hljs-comment"># 3.2. 后台启动</span><br><span class="hljs-built_in">nohup</span> /mystudy/kibana/kibana/bin/kibana &gt;kibana.log 2&gt;&amp;1 &amp;<br><br><br><span class="hljs-comment"># 4. 补充：停止后台 Kibana</span><br>ps aux | grep kibana<br><br><span class="hljs-built_in">kill</span> -9 123456<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li><code>Kibana</code> 并不支持使用 <code>kibana -d</code> 进行后台启动</li>
</ol>
</blockquote>
<hr>
<h5 id="1-3-9-访问-Kibana-节点"><a href="#1-3-9-访问-Kibana-节点" class="headerlink" title="1.3.9. 访问 Kibana 节点"></a>1.3.9. 访问 Kibana 节点</h5><p>访问 Kibana 节点： <a target="_blank" rel="noopener" href="https://192.168.136.8:5601/">https://192.168.136.8:5601</a><br><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250417121921514.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<h1 id="四、补充"><a href="#四、补充" class="headerlink" title="四、补充"></a>四、补充</h1><h3 id="1-相关网站"><a href="#1-相关网站" class="headerlink" title="1. 相关网站"></a>1. 相关网站</h3><ol>
<li>&#x3D;&#x3D;ElasticSearch 官方地址&#x3D;&#x3D;：<ol>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/cn/">https://www.elastic.co/cn/</a></li>
</ol>
</li>
<li>&#x3D;&#x3D;ElasticSearch 文档&#x3D;&#x3D;：<ol>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/8.18/mapping-params.html">https://www.elastic.co/guide/en/elasticsearch/reference/8.18/mapping-params.html</a></li>
</ol>
</li>
<li>&#x3D;&#x3D;ElasticSearch 下载地址&#x3D;&#x3D;：<ol start="2">
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/past-releases#elasticsearch">https://www.elastic.co/cn/downloads/past-releases#elasticsearch</a></li>
</ol>
</li>
<li>&#x3D;&#x3D;Kibana 下载地址&#x3D;&#x3D;：<ol>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/past-releases#kibana">https://www.elastic.co/cn/downloads/past-releases#kibana</a></li>
</ol>
</li>
<li>&#x3D;&#x3D;IK 分词器下载地址&#x3D;&#x3D;：<ol>
<li><a target="_blank" rel="noopener" href="https://release.infinilabs.com/analysis-ik/stable/">https://release.infinilabs.com/analysis-ik/stable/</a></li>
</ol>
</li>
<li>&#x3D;&#x3D;拼音分词器下载地址&#x3D;&#x3D;：<ol>
<li><a target="_blank" rel="noopener" href="https://release.infinilabs.com/analysis-pinyin/stable/">https://release.infinilabs.com/analysis-pinyin/stable/</a></li>
</ol>
</li>
<li>&#x3D;&#x3D;拼音分词器文档&#x3D;&#x3D;：<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/infinilabs/analysis-pinyin">https://github.com/infinilabs/analysis-pinyin</a></li>
</ol>
</li>
<li>手都有<ol>
<li><a target="_blank" rel="noopener" href="https://release.infinilabs.com/">https://release.infinilabs.com/</a></li>
</ol>
</li>
</ol>
<hr>
<h3 id="2-ES-目录结构"><a href="#2-ES-目录结构" class="headerlink" title="2. ES 目录结构"></a>2. ES 目录结构</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs nix">elasticsearch <span class="hljs-symbol">/</span><br>|<br>|-- bin <span class="hljs-symbol">/</span>                                             <span class="hljs-comment"># ES 的可执行脚本</span><br>|<br>|-- config <span class="hljs-symbol">/</span>                                          <span class="hljs-comment"># ES 的配置目录</span><br>|<br>|-- jdk <span class="hljs-symbol">/</span>                                             <span class="hljs-comment"># 内置 JDK </span><br>|<br>|-- lib <span class="hljs-symbol">/</span>                                             <span class="hljs-comment"># ES 依赖的类库</span><br>|<br>|-- logs <span class="hljs-symbol">/</span>                                            <span class="hljs-comment"># 日志目录</span><br>|<br>|-- modules <span class="hljs-symbol">/</span>                                         <span class="hljs-comment"># 模块目录</span><br>|<br>|-- plugins <span class="hljs-symbol">/</span>                                         <span class="hljs-comment"># 插件目录</span><br></code></pre></td></tr></table></figure>

<hr>
<h3 id="3-正排索引"><a href="#3-正排索引" class="headerlink" title="3. 正排索引"></a>3. 正排索引</h3><hr>
<table>
<thead>
<tr>
<th>词条</th>
<th>ID</th>
</tr>
</thead>
<tbody><tr>
<td>Elasticsearch</td>
<td>…….</td>
</tr>
<tr>
<td>是</td>
<td>…….</td>
</tr>
<tr>
<td>一个</td>
<td>…….</td>
</tr>
<tr>
<td>开源</td>
<td>…….</td>
</tr>
<tr>
<td>搜索引擎</td>
<td>…….</td>
</tr>
<tr>
<td>适合</td>
<td>…….</td>
</tr>
<tr>
<td>处理</td>
<td>…….</td>
</tr>
<tr>
<td>大规模</td>
<td>…….</td>
</tr>
<tr>
<td>结构化</td>
<td>…….</td>
</tr>
<tr>
<td>非结构化</td>
<td>…….</td>
</tr>
<tr>
<td>数据</td>
<td>…….</td>
</tr>
</tbody></table>
<h3 id="4-倒排索引"><a href="#4-倒排索引" class="headerlink" title="4. 倒排索引"></a>4. 倒排索引</h3><hr>
<h3 id="5-ES-Mapping-属性"><a href="#5-ES-Mapping-属性" class="headerlink" title="5. ES Mapping 属性"></a>5. ES Mapping 属性</h3><p>Mapping 是对索引库中文档的约束，相当于 MySQL 中列名的属性，常见的 Mapping 属性包括：</p>
<ol>
<li>&#x3D;&#x3D;type&#x3D;&#x3D;：<ol>
<li>字段数据类型</li>
</ol>
</li>
<li>&#x3D;&#x3D;index&#x3D;&#x3D;：<ol>
<li>是否创建索引（是否参与搜索），默认为 true</li>
<li>可以简单理解为：“是否需要被搜索 -&gt; 决定是否需要倒排索引”</li>
</ol>
</li>
<li>&#x3D;&#x3D;analyzer&#x3D;&#x3D;：<ol>
<li>使用的分词器</li>
</ol>
</li>
<li>&#x3D;&#x3D;properties&#x3D;&#x3D;：<ol>
<li>该字段的子字段</li>
</ol>
</li>
</ol>
<p>注意：这里只是列举了常见的 Mapping 属性，其他的可以查询 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/8.18/mapping-params.html">ES 文档</a></p>
<hr>
<h3 id="6-ES-字段数据类型"><a href="#6-ES-字段数据类型" class="headerlink" title="6. ES 字段数据类型"></a>6. ES 字段数据类型</h3><ol>
<li>&#x3D;&#x3D;字符串&#x3D;&#x3D;：<ol>
<li><font color="#00b0f0">可分词文本</font>：<ol>
<li>text</li>
</ol>
</li>
<li><font color="#00b0f0">精确值</font>：<ol>
<li>keyword</li>
</ol>
</li>
</ol>
</li>
<li>&#x3D;&#x3D;数值&#x3D;&#x3D;：<ol>
<li><font color="#00b0f0">整数类型</font>：<ol>
<li><font color="#7030a0">byte</font>：<ul>
<li>1 字节，-128 到 127</li>
</ul>
</li>
<li><font color="#7030a0">short</font>：<ul>
<li>2 字节，-32768 到 32767</li>
</ul>
</li>
<li><font color="#7030a0">integer</font>：<ul>
<li>4 字节，-2³¹ 到 2³¹-1</li>
</ul>
</li>
<li><font color="#7030a0">long</font>：<ul>
<li>8 字节，-2⁶³ 到 2⁶³-1</li>
</ul>
</li>
</ol>
</li>
<li><font color="#00b0f0">浮点数类型</font>：<ol>
<li><font color="#7030a0">half_float</font>：<ul>
<li>2字节，3~5 位十进制精度</li>
</ul>
</li>
<li><font color="#7030a0">float</font>：<ul>
<li>4字节，7 位十进制精度</li>
</ul>
</li>
<li><font color="#7030a0">double</font>：<ul>
<li>8字节，15~16 位十进制精度</li>
</ul>
</li>
</ol>
</li>
</ol>
</li>
<li>&#x3D;&#x3D;布尔&#x3D;&#x3D;：<ol>
<li>boolean</li>
</ol>
</li>
<li>&#x3D;&#x3D;日期&#x3D;&#x3D;：<ol>
<li>date</li>
</ol>
</li>
<li>&#x3D;&#x3D;对象&#x3D;&#x3D;：<ol>
<li>object</li>
</ol>
</li>
</ol>
<hr>
<hr>
<h3 id="7-ES-打分算法"><a href="#7-ES-打分算法" class="headerlink" title="7. ES 打分算法"></a>7. ES 打分算法</h3><p>ES 5.0 之前选用 TF-IDF 打分算法，但是该算法有个缺点，打分会随着词频的增加而越来越大，在 ES 5.0 之后选用 BM 2.5 算法，虽然也会随着词频增加而增大，但增长曲线会逐渐趋于水平</p>
<p><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/PixPin_2025-04-27_11-26-54_PhotoGrid.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/PixPin_2025-04-27_11-22-54_PhotoGrid.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>在以后设计的时候也需要注意，参与算分的条件越多，性能就越差</li>
</ol>
</blockquote>
<hr>
<h3 id="8-常见距离单位"><a href="#8-常见距离单位" class="headerlink" title="8. 常见距离单位"></a>8. 常见距离单位</h3><ol>
<li>&#x3D;&#x3D;米&#x3D;&#x3D;：<ol>
<li><code>m</code></li>
</ol>
</li>
<li>&#x3D;&#x3D;千米&#x3D;&#x3D;：<ol>
<li><code>km</code></li>
</ol>
</li>
<li>&#x3D;&#x3D;英里&#x3D;&#x3D;：<ol>
<li><code>mi</code></li>
</ol>
</li>
<li>&#x3D;&#x3D;码&#x3D;&#x3D;：<ol>
<li><code>yd</code></li>
</ol>
</li>
</ol>
<hr>
<h1 id="麻烦"><a href="#麻烦" class="headerlink" title="麻烦"></a>麻烦</h1><p><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250418184544203.png" srcset="/img/loading.gif" lazyload alt="|500"></p>
<p><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250417122657685.png" srcset="/img/loading.gif" lazyload><br><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250417122752564.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250417122922783.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<h1 id="补充，企业级高可用"><a href="#补充，企业级高可用" class="headerlink" title="补充，企业级高可用"></a>补充，企业级高可用</h1><p>构建企业级高可用（High Availability, HA）集群时，需要从多个方面进行综合考虑，以确保系统在各种故障场景下仍能提供稳定、可靠的服务。以下是高可用集群设计和部署时需要关注的核心方面：</p>
<hr>
<h3 id="1-1-架构设计"><a href="#1-1-架构设计" class="headerlink" title="1. 1. 架构设计"></a>1. <strong>1. 架构设计</strong></h3><ul>
<li><strong>冗余性</strong>：<ul>
<li>确保系统中没有单点故障（Single Point of Failure, SPOF）。例如，RabbitMQ 集群需要多节点，负载均衡器（如 HAProxy）需要通过 Keepalived 实现主备切换。</li>
<li>使用多副本机制（如 RabbitMQ 的队列镜像）保证数据冗余。</li>
</ul>
</li>
<li><strong>分布式部署</strong>：<ul>
<li>考虑跨机房或跨数据中心部署，以应对区域性故障。</li>
<li>使用 Federation 或 Shovel 插件实现 RabbitMQ 跨地域的数据同步。</li>
</ul>
</li>
<li><strong>负载均衡</strong>：<ul>
<li>配置负载均衡器（如 HAProxy、Nginx、F5）将请求分发到多个后端节点。</li>
<li>选择合适的负载均衡算法（如轮询、最少连接）以优化性能。</li>
</ul>
</li>
<li><strong>可扩展性</strong>：<ul>
<li>设计时考虑集群的水平扩展能力，确保新增节点不会影响现有服务。</li>
<li>评估系统在高负载下的性能瓶颈，如网络带宽、磁盘 I&#x2F;O 等。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="2-2-故障转移与恢复"><a href="#2-2-故障转移与恢复" class="headerlink" title="2. 2. 故障转移与恢复"></a>2. <strong>2. 故障转移与恢复</strong></h3><ul>
<li><strong>自动故障转移</strong>：<ul>
<li>使用 Keepalived 或类似工具实现虚拟 IP（VIP）漂移，确保前端服务的高可用。</li>
<li>配置 RabbitMQ 集群的队列镜像，确保节点故障时数据不丢失。</li>
</ul>
</li>
<li><strong>健康检查</strong>：<ul>
<li>配置负载均衡器的健康检查机制（如 HAProxy 的 <code>check</code> 选项），及时剔除故障节点。</li>
<li>监控 RabbitMQ 节点的运行状态（如通过 <code>rabbitmqctl cluster_status</code> 或管理插件）。</li>
</ul>
</li>
<li><strong>快速恢复</strong>：<ul>
<li>制定故障恢复流程（如节点重启、数据同步）。</li>
<li>测试恢复时间目标（RTO, Recovery Time Objective），确保满足业务需求。</li>
</ul>
</li>
<li><strong>备份与灾难恢复</strong>：<ul>
<li>定期备份关键数据和配置（如 RabbitMQ 的元数据、队列定义）。</li>
<li>制定灾难恢复计划（DR, Disaster Recovery），并定期演练。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="3-3-性能优化"><a href="#3-3-性能优化" class="headerlink" title="3. 3. 性能优化"></a>3. <strong>3. 性能优化</strong></h3><ul>
<li><strong>资源分配</strong>：<ul>
<li>确保服务器硬件（CPU、内存、磁盘）满足集群需求，特别是在高并发场景下。</li>
<li>优化 RabbitMQ 的内存和磁盘使用（如调整 <code>vm_memory_high_watermark</code> 参数）。</li>
</ul>
</li>
<li><strong>网络优化</strong>：<ul>
<li>使用高带宽、低延迟的网络，减少节点间通信开销。</li>
<li>配置合适的 TCP 参数（如增大连接数、优化超时时间）。</li>
</ul>
</li>
<li><strong>队列管理</strong>：<ul>
<li>合理设置队列的持久化策略和镜像策略，避免过多副本导致性能下降。</li>
<li>使用 Lazy Queues 减少内存占用，适合大数据量场景。</li>
</ul>
</li>
<li><strong>负载均衡优化</strong>：<ul>
<li>根据业务特点选择合适的负载均衡策略（如基于会话的粘性连接或动态权重）。</li>
<li>调整 HAProxy 的 <code>maxconn</code> 和超时参数，适应高并发场景。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="4-4-监控与告警"><a href="#4-4-监控与告警" class="headerlink" title="4. 4. 监控与告警"></a>4. <strong>4. 监控与告警</strong></h3><ul>
<li><strong>实时监控</strong>：<ul>
<li>部署监控系统（如 Prometheus + Grafana、Zabbix）跟踪集群的运行状态。</li>
<li>监控关键指标：<ul>
<li>RabbitMQ：队列长度、消息速率、连接数、内存&#x2F;磁盘使用率。</li>
<li>HAProxy：请求速率、后端节点健康状态、响应时间。</li>
<li>Keepalived：VIP 状态、主备切换事件。</li>
<li>服务器：CPU、内存、磁盘 I&#x2F;O、网络流量。</li>
</ul>
</li>
</ul>
</li>
<li><strong>告警机制</strong>：<ul>
<li>配置告警规则（如队列积压、节点故障、VIP 漂移），通过邮件、短信或企业微信通知运维团队。</li>
<li>设置多级告警阈值（如警告、严重），避免误报或漏报。</li>
</ul>
</li>
<li><strong>日志管理</strong>：<ul>
<li>收集和分析系统日志（RabbitMQ、HAProxy、Keepalived），使用集中式日志系统（如 ELK Stack、Loki）。</li>
<li>定期审查日志，排查潜在问题。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="5-5-安全性"><a href="#5-5-安全性" class="headerlink" title="5. 5. 安全性"></a>5. <strong>5. 安全性</strong></h3><ul>
<li><strong>网络安全</strong>：<ul>
<li>配置防火墙，仅开放必要端口（如 RabbitMQ 的 5672、15672，HAProxy 的 80&#x2F;443）。</li>
<li>使用 VPC 或专用网络隔离集群，防止未经授权的访问。</li>
</ul>
</li>
<li><strong>数据加密</strong>：<ul>
<li>为 RabbitMQ 和 HAProxy 配置 TLS&#x2F;SSL，加密客户端与服务器的通信。</li>
<li>确保节点间通信（如 Erlang 通信）也启用加密。</li>
</ul>
</li>
<li><strong>访问控制</strong>：<ul>
<li>配置 RabbitMQ 的用户权限，限制客户端的操作范围（如只允许特定用户访问特定队列）。</li>
<li>使用强密码或集成 LDAP&#x2F;SSO 进行认证。</li>
</ul>
</li>
<li><strong>漏洞管理</strong>：<ul>
<li>定期更新 RabbitMQ、HAProxy、Keepalived 和操作系统，修复已知漏洞。</li>
<li>订阅安全公告，及时响应新的威胁。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="6-6-数据一致性与可靠性"><a href="#6-6-数据一致性与可靠性" class="headerlink" title="6. 6. 数据一致性与可靠性"></a>6. <strong>6. 数据一致性与可靠性</strong></h3><ul>
<li><strong>数据冗余</strong>：<ul>
<li>配置 RabbitMQ 的队列镜像（Mirrored Queues），确保数据在多个节点上有副本。</li>
<li>评估镜像策略（如 <code>ha-mode: all</code> 或 <code>ha-mode: exactly</code>），平衡可靠性和性能。</li>
</ul>
</li>
<li><strong>消息持久化</strong>：<ul>
<li>启用队列和消息的持久化（<code>durable: true</code>, <code>delivery_mode: 2</code>），确保消息在故障后不丢失。</li>
<li>注意持久化对性能的影响，必要时优化磁盘 I&#x2F;O。</li>
</ul>
</li>
<li><strong>事务与确认机制</strong>：<ul>
<li>使用 Publisher Confirms 或 Consumer Acknowledgements 确保消息可靠投递。</li>
<li>根据业务需求权衡性能和可靠性（如批量确认 vs 逐条确认）。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="7-7-运维管理"><a href="#7-7-运维管理" class="headerlink" title="7. 7. 运维管理"></a>7. <strong>7. 运维管理</strong></h3><ul>
<li><strong>自动化运维</strong>：<ul>
<li>使用 Ansible、Terraform 或 Kubernetes 自动化集群的部署和配置。</li>
<li>配置 CI&#x2F;CD 流程，简化版本升级和补丁应用。</li>
</ul>
</li>
<li><strong>容量规划</strong>：<ul>
<li>定期评估集群的负载和增长趋势，提前规划扩容。</li>
<li>测试集群在峰值负载下的表现，确保满足 SLA（Service Level Agreement）。</li>
</ul>
</li>
<li><strong>文档与培训</strong>：<ul>
<li>维护详细的架构文档、运维手册和故障处理流程。</li>
<li>定期培训运维团队，确保熟悉集群的维护和应急响应。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="8-8-测试与验证"><a href="#8-8-测试与验证" class="headerlink" title="8. 8. 测试与验证"></a>8. <strong>8. 测试与验证</strong></h3><ul>
<li><strong>高可用性测试</strong>：<ul>
<li>模拟各种故障场景（如节点宕机、网络分区、VIP 切换），验证故障转移是否正常。</li>
<li>测试数据一致性，确保故障后无消息丢失或重复。</li>
</ul>
</li>
<li><strong>性能测试</strong>：<ul>
<li>使用工具（如 JMeter、PerfKit）模拟高并发场景，评估集群的吞吐量和响应时间。</li>
<li>识别瓶颈（如网络、磁盘、队列配置）并优化。</li>
</ul>
</li>
<li><strong>灾难恢复演练</strong>：<ul>
<li>定期进行灾难恢复演练，验证备份和恢复流程的有效性。</li>
<li>记录演练结果，优化恢复时间和流程。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="9-9-成本与资源管理"><a href="#9-9-成本与资源管理" class="headerlink" title="9. 9. 成本与资源管理"></a>9. <strong>9. 成本与资源管理</strong></h3><ul>
<li><strong>资源成本</strong>：<ul>
<li>评估硬件、云服务和 лицен费用，优化资源分配（如选择合适的实例类型）。</li>
<li>使用自动化伸缩（如果在云端部署）降低闲置资源成本。</li>
</ul>
</li>
<li><strong>运维成本</strong>：<ul>
<li>通过自动化和监控减少人工干预，降低运维成本。</li>
<li>选择开源工具（如 HAProxy、Keepalived）或性价比高的商业解决方案。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="10-10-业务需求与-SLA"><a href="#10-10-业务需求与-SLA" class="headerlink" title="10. 10. 业务需求与 SLA"></a>10. <strong>10. 业务需求与 SLA</strong></h3><ul>
<li><strong>可用性目标</strong>：<ul>
<li>根据业务需求定义可用性目标（如 99.9% 或 99.99% 的 uptime）。</li>
<li>计算允许的宕机时间，确保架构设计满足要求。</li>
</ul>
</li>
<li><strong>延迟与吞吐量</strong>：<ul>
<li>明确业务对消息延迟和吞吐量的要求，优化配置以满足这些指标。</li>
</ul>
</li>
<li><strong>数据保留策略</strong>：<ul>
<li>根据业务需求设置消息的保留时间和队列的清理策略（如 TTL、最大长度）。</li>
</ul>
</li>
<li><strong>合规性</strong>：<ul>
<li>确保集群满足行业法规（如 GDPR、HIPAA），特别是在数据隐私和审计方面。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="11-总结"><a href="#11-总结" class="headerlink" title="11. 总结"></a>11. <strong>总结</strong></h3><p>高可用集群的设计和维护需要从架构、故障转移、性能、监控、安全、数据可靠性、运维、测试、成本和业务需求等多个维度综合考虑。对于 RabbitMQ 集群搭配 HAProxy + Keepalived 的场景，核心是确保无单点故障、数据冗余和快速恢复，同时通过监控和自动化运维降低风险。建议根据具体业务场景（如消息量、延迟要求、预算）进一步细化配置，并定期进行测试和优化。</p>
<p>如果你有某个方面需要深入探讨（例如具体配置、工具选型或测试方法），请告诉我！</p>
<p><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250416192542363.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250416192834497.png" srcset="/img/loading.gif" lazyload></p>
<p>有 ES 脑裂问题<br><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AElasticSearch%20%E5%9F%BA%E7%A1%80/image-20250416194752833.png" srcset="/img/loading.gif" lazyload></p>
<p>偶数的话，可能出现问题和脑裂</p>
<hr>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/" class="category-chain-item">数据管理</a>
  
  
    <span>></span>
    
  <a href="/categories/%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/ELK-%E4%B8%89%E4%BB%B6%E5%A5%97/" class="category-chain-item">ELK 三件套</a>
  
  
    <span>></span>
    
  <a href="/categories/%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/ELK-%E4%B8%89%E4%BB%B6%E5%A5%97/ElasticSearch/" class="category-chain-item">ElasticSearch</a>
  
  
    <span>></span>
    
  <a href="/categories/%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/ELK-%E4%B8%89%E4%BB%B6%E5%A5%97/ElasticSearch/Elasticsearch-%E5%9F%BA%E7%A1%80/" class="category-chain-item">Elasticsearch 基础</a>
  
  

  

  

  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>笔记：ElasticSearch 基础</div>
      <div>https://wangjia5289.github.io/2025/04/13/笔记：ElasticSearch 基础/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>霸天</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>April 13, 2025</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/04/15/%E7%AC%94%E8%AE%B0%EF%BC%9AVMware/" title="笔记：VMware">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">笔记：VMware</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/04/13/%E7%AC%94%E8%AE%B0%EF%BC%9AGit%20%E5%AE%B6%E6%97%8F/" title="笔记：Git 家族">
                        <span class="hidden-mobile">笔记：Git 家族</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  



  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.utils.listenDOMLoaded(function() {
      Fluid.events.registerRefreshCallback(function() {
        if ('mermaid' in window) {
          mermaid.init();
        }
      });
    });
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  var relativeDate = function() {
    var updatedTime = document.getElementById('updated-time');
    if (updatedTime) {
      var text = updatedTime.textContent;
      var reg = /\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:Z|[+-]\d{2}:\d{2})/;
      var matchs = text.match(reg);
      if (matchs) {
        var relativeTime = moment(matchs[0]).fromNow();
        updatedTime.textContent = text.replace(reg, relativeTime);
      }
      updatedTime.style.display = '';
    }
  };
  Fluid.utils.createScript('https://lib.baomitu.com/moment.js/2.29.4/moment.min.js', function() {
    if (!'en'.startsWith('en')) {
      Fluid.utils.createScript('https://lib.baomitu.com/moment.js/2.29.4/locale/en.min.js', function() {
        relativeDate();
      });
    } else {
      relativeDate();
    }
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"display":{"superSample":2,"width":200,"height":350,"position":"left","hOffset":40,"vOffset":-20},"mobile":{"show":false,"scale":0.5},"react":{"opacityDefault":1,"opacityOnHover":0.5},"log":false});</script></body>
</html>
