

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>




<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/ba.jpg">
  <link rel="icon" href="/img/ba.jpg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#373737">
  <meta name="author" content="霸天">
  <meta name="keywords" content="">
  
    <meta name="description" content="一、理论1. 导图：Map：K8S 2. K8S 概述K8S 是 Kubernetes 的缩写（中间的 “8” 代表 “ubernete” 这 8 个字母），它是目前最流行的容器编排系统，用于自动化部署、扩展和管理容器化应用（如 Docker 容器）  3. K8S 组件我们说 K8S 实际上就是指的 K8S 集群，其组件分 Master 节点和 Worker 节点：  &#x3D;&#x3D;M">
<meta property="og:type" content="article">
<meta property="og:title" content="笔记：Kubernetes 基础">
<meta property="og:url" content="https://wangjia5289.github.io/2025/03/12/%E7%AC%94%E8%AE%B0%EF%BC%9AKubernetes%20%E5%9F%BA%E7%A1%80/index.html">
<meta property="og:site_name" content="夜阑卧听风吹雨,一枝梨花压心头">
<meta property="og:description" content="一、理论1. 导图：Map：K8S 2. K8S 概述K8S 是 Kubernetes 的缩写（中间的 “8” 代表 “ubernete” 这 8 个字母），它是目前最流行的容器编排系统，用于自动化部署、扩展和管理容器化应用（如 Docker 容器）  3. K8S 组件我们说 K8S 实际上就是指的 K8S 集群，其组件分 Master 节点和 Worker 节点：  &#x3D;&#x3D;M">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AK8s/image-20250324091041496.png">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AK8s/image-20250404155459306.png">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AK8s/image-20250404145519072.png">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AK8s/image-20250402174618934.png">
<meta property="article:published_time" content="2025-03-11T16:00:00.000Z">
<meta property="article:modified_time" content="2025-06-28T10:49:06.123Z">
<meta property="article:author" content="Ba Tian">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AK8s/image-20250324091041496.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>笔记：Kubernetes 基础 - 夜阑卧听风吹雨,一枝梨花压心头</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"wangjia5289.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 100vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/%E3%80%90%E5%93%B2%E9%A3%8E%E5%A3%81%E7%BA%B8%E3%80%91%E5%85%89%E5%BD%B1%E7%BE%8E%E5%AD%A6-%E5%90%8A%E5%B8%A6%E8%A3%99.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="笔记：Kubernetes 基础"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-03-12 00:00" pubdate>
          March 12, 2025 am
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          29k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          239 mins
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> views
        </span>
        

      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">笔记：Kubernetes 基础</h1>
            
              <p id="updated-time" class="note note-info" style="display: none">
                
                  
                    Last updated on 2025-06-28T18:49:06+08:00
                  
                  

                
              </p>
            
            
              <div class="markdown-body">
                
                <h1 id="一、理论"><a href="#一、理论" class="headerlink" title="一、理论"></a>一、理论</h1><h3 id="1-导图：Map：K8S"><a href="#1-导图：Map：K8S" class="headerlink" title="1. 导图：Map：K8S"></a>1. 导图：<a href="Map%EF%BC%9AK8S.xmind">Map：K8S</a></h3><hr>
<h3 id="2-K8S-概述"><a href="#2-K8S-概述" class="headerlink" title="2. K8S 概述"></a>2. K8S 概述</h3><p>K8S 是 <strong>Kubernetes</strong> 的缩写（中间的 “8” 代表 “ubernete” 这 8 个字母），它是目前最流行的<strong>容器编排系统</strong>，用于自动化部署、扩展和管理容器化应用（如 Docker 容器）</p>
<hr>
<h3 id="3-K8S-组件"><a href="#3-K8S-组件" class="headerlink" title="3. K8S 组件"></a>3. K8S 组件</h3><p>我们说 K8S 实际上就是指的 K8S 集群，其组件分 Master 节点和 Worker 节点：</p>
<ol>
<li>&#x3D;&#x3D;Master 节点&#x3D;&#x3D;<ol>
<li><font color="#00b0f0">containerd（☆☆☆）</font>:<ol>
<li>容器运行时，负责管理<strong>本机容器</strong>的生命周期，例如拉取镜像、启动和停止容器。</li>
</ol>
</li>
<li><font color="#00b0f0">crictl</font>：<ol>
<li>K8S 提供的容器运行时的命令行工具，用于与 containerd 交互，常用于调试容器。例如，<code>crictl ps</code> 查看容器状态，<code>crictl pull</code> 拉取镜像。</li>
</ol>
</li>
<li><font color="#00b0f0">kubeadm</font>：<ol>
<li>用于简化 Kubernetes 集群的初始化和管理。例如，<code>kubeadm init</code> 初始化集群，<code>kubeadm join</code> 添加新节点。</li>
</ol>
</li>
<li><font color="#00b0f0">kubelet（☆☆☆）</font>：<ol>
<li>kubelet 负责创建和运行 Pod，它会监听 etcd 的变更，当 Kubernetes 调度 Pod 至本节点时，<code>kubelet</code> 通过 <code>containerd</code> 启动容器，并确保其持续运行。</li>
</ol>
</li>
<li><font color="#00b0f0">kubectl</font>：<ol>
<li>命令行工具，用于与 API Server 交互。例如，<code>kubectl get pods</code> 查看集群中的 Pods。</li>
</ol>
</li>
<li><font color="#00b0f0">calico-kube-controllers</font>：<ol>
<li>Calico 控制器，负责管理网络策略和 IP 地址分配。</li>
</ol>
</li>
<li><font color="#00b0f0">etcd（☆☆☆）</font>：<ol>
<li>分布式键值存储，保存 Kubernetes 集群的所有配置和状态。例如，你创建 Deployment、Pod、Service，它们的配置信息都会存入 etcd，并在多个 Master 节点间保持一致。</li>
</ol>
</li>
<li><font color="#00b0f0">kube-apiserver（☆☆☆）</font>：<ol>
<li><font color="#7030a0">处理 kubectl 命令</font>：<ol>
<li>接收并处理所有 <code>kubectl</code> 命令</li>
</ol>
</li>
<li><font color="#7030a0">进行认证（☆☆☆）</font>：<ol>
<li>根据执行 <code>kubectl</code> 命令时传递的 <code>Service Account</code> 或 用户证书，进行用户的身份验证认证</li>
<li>如果认证通过，则继续执行后续操作（如鉴权、操作 etcd、推送变更等）</li>
<li>如果认证失败，则返回 401 错误。</li>
</ol>
</li>
<li><font color="#7030a0">进行鉴权（☆☆☆）</font>：<ol>
<li>根据我们使用 RBAC 为 <code>Service</code> 或 用户证书绑定的用户，判断他是否有权限执行这个 kubectl 命令</li>
<li>如果没有该权限，返回 403 错误</li>
</ol>
</li>
<li><font color="#7030a0">与 etcd 交互</font>：<ol>
<li>API Server 对 etcd 进行增删改查操作，例如读取 Deployment 配置或更新 Service 状态</li>
<li>在进行写入或修改操作（例如更新 Pod、Service 或 Controller 配置）时，API Server 会先将配置转换成 JSON 格式，然后写入 etcd</li>
</ol>
</li>
<li><font color="#7030a0">推送变更</font>：<ol>
<li>当 etcd 中的数据发生变更时，API Server 通过 Watch 机制向 Controller Manager、Scheduler 和 Kubelet 推送事件。</li>
<li>需要注意的是，API Server 不会主动”通知组件”，而是组件主动监听 API Server 的资源变更。</li>
</ol>
</li>
</ol>
</li>
<li><font color="#00b0f0">kube-controller-manager（☆☆☆）</font>：<ol>
<li>负责运行和管理各个 Controller</li>
<li>Controller 监听 <code>etcd</code> 变更，并通过 Scheduler 和 Kubelet 管理 Pod 的生命周期，确保集群中始终保持指定数量的运行 Pod：<ol>
<li>在 Pod 故障时，自动重启 Pod</li>
<li>当 节点 故障时，触发 Pod 迁移</li>
</ol>
</li>
</ol>
</li>
<li><font color="#00b0f0">kube-scheduler（☆☆☆）</font>：<ol>
<li>监听 API Server，检测是否有待调度的 Pod。</li>
<li>如果存在待调度 Pod，Scheduler 根据资源需求（如 CPU&#x2F;内存）、亲和性（<code>nodeAffinity</code>）、污点（<code>Taint</code>）等策略选择目标 Worker 节点。</li>
<li>确定目标节点后，<code>kube-scheduler</code> 将 Pod 的 <code>nodeName</code> 字段更新，并写入 etcd。当 kubelet 监听到 etcd biang后，调用 <code>containerd</code> 创建容器并运行 Pod。</li>
</ol>
</li>
<li><font color="#00b0f0">kube-proxy</font>：<ol>
<li>负责 Kubernetes 内部的<strong>网络路由</strong>和<strong>服务负载均衡</strong>，实现 Service 的 IP 和端口映射，确保流量正确转发到目标 Pod。例如，你访问<code>ClusterIP</code>，流量会被 kube-proxy 代理到实际的 Pod</li>
</ol>
</li>
<li><font color="#00b0f0">coredns</font>：<ol>
<li>Kubernetes 内部的 DNS 服务器，提供<strong>服务发现</strong>。例如，Pod 访问 <code>my-service.default.svc.cluster.local</code>，CoreDNS 解析其 IP 地址。</li>
</ol>
</li>
</ol>
</li>
<li>&#x3D;&#x3D;Worker 节点&#x3D;&#x3D;<ol>
<li><font color="#00b0f0">containerd</font></li>
<li><font color="#00b0f0">crictl</font></li>
<li><font color="#00b0f0">kubeadm</font></li>
<li><font color="#00b0f0">kubelet</font></li>
<li><font color="#00b0f0">kubectl</font></li>
<li><font color="#00b0f0">calico-node</font></li>
</ol>
</li>
</ol>
<hr>
<h3 id="4-K8S-最佳实践"><a href="#4-K8S-最佳实践" class="headerlink" title="4. K8S 最佳实践"></a>4. K8S 最佳实践</h3><h4 id="4-1-高可用实现"><a href="#4-1-高可用实现" class="headerlink" title="4.1. 高可用实现"></a>4.1. 高可用实现</h4><ol>
<li>&#x3D;&#x3D;主从之间&#x3D;&#x3D;<ol>
<li>K8S 采用主从架构，是主控制从的架构，Master 节点负责全局调度和决策，而 Worker 节点负责执行具体的任务</li>
<li>K8S 不支持 Worker 上位 Master</li>
</ol>
</li>
<li>&#x3D;&#x3D;主主之间&#x3D;&#x3D;<ol>
<li>多个主节点之间通过 <code>etcd</code> 实现信息同步，保证每个主节点都能及时获取到集群的最新状态信息。</li>
<li>主节点之间会通过会通过 <strong>Raft 算法</strong>选举出一个 <strong>Leader</strong>，只有 Leader 的各项组件（如 API Server、Scheduler 等）真正起作用，其他主节点的组件不起作用。这主要是为了避免多个主节点同时操作 etcd，重复调度 Pod，导致冲突，当 Leader 挂掉之后，会重新选举新的 Leader</li>
</ol>
</li>
<li>&#x3D;&#x3D;负载均衡&#x3D;&#x3D;<ol>
<li>使用 Keepalived 为 Haproxy 绑定 VIP，并使用 Haproxy 负载均衡到 Master，确保每个 Master 都有执行管理员命令的权利</li>
</ol>
</li>
</ol>
<hr>
<h4 id="4-2-流程图"><a href="#4-2-流程图" class="headerlink" title="4.2. 流程图"></a>4.2. 流程图</h4><h5 id="4-2-1-用户访问应用（通过浏览器）"><a href="#4-2-1-用户访问应用（通过浏览器）" class="headerlink" title="4.2.1. 用户访问应用（通过浏览器）"></a>4.2.1. 用户访问应用（通过浏览器）</h5><ol>
<li>&#x3D;&#x3D;用户请求&#x3D;&#x3D;：<ol>
<li>用户在浏览器中输入请求地址，例如 <code>blog.wagnjia.xin</code>。</li>
</ol>
</li>
<li>&#x3D;&#x3D;公共 DNS 服务器处理&#x3D;&#x3D;：<ol>
<li>请求首先到达公共 DNS 服务器，DNS 将域名解析为由 MetalLB 分配给 <code>Ingress Controller Service</code> 的 VIP 地址</li>
</ol>
</li>
<li>&#x3D;&#x3D;请求到达 Ingress Controller Serviece&#x3D;&#x3D;:<ol>
<li>用户请求通过解析得到的 VIP 地址被路由到 <code>Ingress Controller Service</code>。</li>
</ol>
</li>
<li>&#x3D;&#x3D;请求到达 Ingress Controller Pod&#x3D;&#x3D;：<ol>
<li><code>Ingress Controller Service</code> 根据负载均衡策略，将请求分发到某个 <code>Ingress Controller Pod</code> 实例</li>
</ol>
</li>
<li>&#x3D;&#x3D;请求到达 应用 Service&#x3D;&#x3D;：<ol>
<li><code>Ingress Controller Pod</code> 会按照 <code>Ingress</code> 资源配置的域名规则，将请求发送到相应的 应用 Service</li>
</ol>
</li>
<li>&#x3D;&#x3D;请求到达 应用 Pod&#x3D;&#x3D;：<ol>
<li>应用 Service 接受到请求后，会把请求负载均衡到一个其管理的应用 Pod 实例</li>
</ol>
</li>
<li>&#x3D;&#x3D;应用 Pod 完成业务处理&#x3D;&#x3D;：<ol>
<li>然后，将由应用 Pod 完成真正的业务处理<pre class="mermaid">graph TD
 A[用户请求] --> B["公共 DNS"]
 B -->|"DNS 解析出 VIP(由 MetalLB 为 LoadBalancer Service 提供)"| C["VIP"]
 C -->|"VIP 绑定在 Ingress Controller Service"| D["Ingress Controller Service(LoadBalancer 类型)"]
 D -->|"将流量转发至其 Pod"| E["Ingress Controller Pod"]
 E -->|"根据 Ingress 规则将流量转发至应用 Service"| F["应用 Service"]
 F -->|"将流量负载均衡至其 Pod"| G[应用 Pod]
 G --> H["应用 Pod 完成业务处理"]</pre></li>
</ol>
</li>
</ol>
<hr>
<h5 id="4-2-2-管理员执行命令（Master-终端-管理机终端）"><a href="#4-2-2-管理员执行命令（Master-终端-管理机终端）" class="headerlink" title="4.2.2. 管理员执行命令（Master 终端 &#x2F; 管理机终端）"></a>4.2.2. 管理员执行命令（Master 终端 &#x2F; 管理机终端）</h5><ol>
<li>&#x3D;&#x3D;管理员执行命令&#x3D;&#x3D;<ol>
<li>管理员在 Master 节点的终端执行 <code>kubectl</code> 命令，该命令会读取本机 <code>~/.kube/admin.conf</code> 中的 <code>API Server</code> 字段，以定位本机的 API Server，通常是由 Keepalived 提供的 VIP（<code>192.168.136.100</code>）。</li>
<li><code>admin.conf</code> 会自动携带用户证书，并将请求发送至 API Server。（<code>admin.conf</code> 默认的用户证书是由 <code>kubeadm</code> 在初始化集群时自动生成，拥有最高权限，可操作集群中的所有资源。）</li>
<li>注意：虽然 <code>kubeadm</code> 在 <code>/etc/kubernetes/</code> 下生成了 <code>admin.conf</code>，但 <code>kubectl</code> 实际使用的是 <code>~/.kube/</code> 下的 <code>admin.conf</code>。前者更像是一个模板，供管理员配置使用。</li>
</ol>
</li>
<li>&#x3D;&#x3D;命令到达 Haproxy&#x3D;&#x3D;：<ol>
<li>由于 <code>admin.conf</code> 指定的 VIP（<code>192.168.136.100</code>）通常绑定在 HAProxy 服务器上，因此命令会先到达 HAProxy。</li>
</ol>
</li>
<li>&#x3D;&#x3D;命令到达 Master&#x3D;&#x3D;<ol>
<li>HAProxy 负责将请求负载均衡至某个 Master 节点，并转发至 Kubernetes API Server 监听的 <code>6443</code> 端口。</li>
</ol>
</li>
<li>&#x3D;&#x3D;命令到达 API Server&#x3D;&#x3D;：<ol>
<li>目标 Master 节点上的 API Server 接收请求，并通过 <code>6443</code> 端口进行处理。</li>
<li>API Server 验证用户证书的有效性，并检查权限，完成认证与鉴权。</li>
</ol>
</li>
<li>&#x3D;&#x3D;API Server 与 etcd 交互&#x3D;&#x3D;<ol>
<li>API Server 通过 etcd 客户端库，将请求操作（如资源创建、更新）写入 etcd 分布式数据库集群。</li>
</ol>
</li>
<li>&#x3D;&#x3D;组件响应 etced 变更&#x3D;&#x3D;：<ol>
<li>作为集群 Leader 的 Master 节点上，Scheduler、Controller Manager 等组件监听 etcd 的数据变更，并执行相应操作</li>
<li>Master 和 Worker 节点上的 Kubelet 也会监听 etcd 变更，在需要操作容器时，调用 <code>containerd</code> 以执行相应的任务<pre class="mermaid">graph TD
 A["Master 终端 / 管理机终端 上执行 kubectl 命令"] --> |"携带 Master 机的 ~/.kube/admin.conf，并根据其配置的 API Server 地址(VIP)"| B["VIP(192.168.136.100)"]
 B -->|"VIP 在 Haproxy 上漂移"| C["Haproxy 集群"]
 C --> C1["Haproxy1(192.168.136.14)"]
 C --> C2["Haproxy2(192.168.136.15)"]
 C1 -->|"进行负载均衡"| D1["Master1(192.168.136.8)"]
 C1 -->|"进行负载均衡"| D2["Master2(192.168.136.9)"]
 C2 -->|"进行负载均衡"| D1
 C2 -->|"进行负载均衡"| D2
 D1 -->|"访问 6443 端口"| E1["Master1 上的 API Server"]
 D2 -->|"访问 6443 端口"| E2["Master2 上的 API Server"]
 E1 -->|"API Server 验证 config 文件，完成认证与鉴权"| F["API Server 与 etcd 交互"]
 E2 -->|"API Server 验证 config 文件，完成认证与鉴权"| F["API Server 与 etcd 交互"]
 F --> |"组件响应 etcd 变更"| G["组件响应 etcd 变更（Scheduler、Controller Manager、Kubelet）"]</pre></li>
</ol>
</li>
</ol>
<hr>
<h5 id="4-2-3-管理员执行命令（Pod-内部）"><a href="#4-2-3-管理员执行命令（Pod-内部）" class="headerlink" title="4.2.3. 管理员执行命令（Pod 内部）"></a>4.2.3. 管理员执行命令（Pod 内部）</h5><ol>
<li>&#x3D;&#x3D;管理员执行命令&#x3D;&#x3D;：<ol>
<li>管理员在 Pod 内部执行 <code>kubectl</code> 命令，默认通过 <code>https://kubernetes.default.svc:443</code> <strong>负载均衡</strong>到集群中的某个 Master 节点的 API Server（这是一个 K8S 内部 DNS URL，由 K8S DNS 解析）</li>
<li>必须 <strong>手动</strong> 携带 Pod 挂载的 <code>Service Account</code> 的 <code>Token</code> 令牌（☆☆☆）。</li>
</ol>
</li>
<li>&#x3D;&#x3D;命令到达 Master 节点&#x3D;&#x3D;：<ol>
<li>通过 Kubernetes DNS 解析 <code>kubernetes.default.svc</code>，请求被路由至某个 Master 节点，并访问其 <code>6443</code> 端口</li>
</ol>
</li>
<li>&#x3D;&#x3D;命令到达 API Server&#x3D;&#x3D;：<ol>
<li>目标 Master 节点上的 API Server 接收请求，并通过 <code>6443</code> 端口进行处理。</li>
<li>API Server 验证 <code>Service Account</code> 的有效性，并检查其权限，完成认证与鉴权</li>
</ol>
</li>
<li>&#x3D;&#x3D;API Server 与 etcd 交互&#x3D;&#x3D;：<ol>
<li>API Server 通过 etcd 客户端库，将请求操作（如资源创建、更新）写入 etcd 分布式数据库集群。</li>
</ol>
</li>
<li>&#x3D;&#x3D;组件响应 etcd 变更&#x3D;&#x3D;<ol>
<li>作为集群 Leader 的 Master 节点上，Scheduler、Controller Manager 等组件监听 etcd 的数据变更，并执行相应操作</li>
<li>Master 和 Worker 节点上的 Kubelet 也会监听 etcd 变更，在需要操作容器时，调用 <code>containerd</code> 以执行相应的任务</li>
</ol>
</li>
<li>&#x3D;&#x3D;注意事项&#x3D;&#x3D;：<ol>
<li>该操作与管理员的个人身份<strong>无关</strong>，权限完全取决于 Pod 绑定的 <code>Service Account</code>。<pre class="mermaid">graph TD 
 A["Pod 内部执行 kubectl 命令"] -->|"需携带该 Pod 的 Service Account Token"| B["访问 https:// kubernetes.default.svc:6443"]
 B -->|"负载均衡"| D1["Master1(192.168.136.8)"]
 B -->|"负载均衡"| D2["Master2(192.168.136.9)"]
 D1 -->|"访问 6443 端口"| E1["Master1 上的 API Server"]
 D2 -->|"访问 6443 端口"| E2["Master1 上的 API Server"]
 E1 -->|"API Server 验证 Service Account，完整认证与鉴权"| G["API Server 与 etcd 交互"]
 E2 -->|"API Server 验证 Service Account，完整认证与鉴权"| G["API Server 与 etcd 交互"]
 G --> |"组件响应 etcd 变更"| H["组件响应 etcd 变更（Scheduler、Controller Manager、Kubelet）"]</pre></li>
</ol>
</li>
</ol>
<hr>
<h4 id="4-3-节点规划"><a href="#4-3-节点规划" class="headerlink" title="4.3. 节点规划"></a>4.3. 节点规划</h4><ol>
<li>Master 节点的数量应为奇数（如 1、3、5、7 等），这是为了避免在选举过程中出现投票平局的情况，确保集群能够正常选举出 Leader。</li>
<li>在生产环境中，建议至少部署 3 个 Master 节点，这是最常见的高可用部署方式，可以提高集群的稳定性和容错能力。</li>
<li>根据不同的工作负载，可以对 Worker 节点进行合理划分，结合亲和性、反亲和性、污点和容忍性等策略，让调度器（Scheduler）将 Pod 调度到适合的节点。例如，计算密集型应用可以分配到高 CPU 性能的节点，而内存密集型应用可以分配到内存更大的节点，从而实现资源的最优利用。</li>
</ol>
<hr>
<h4 id="4-4-安全规划"><a href="#4-4-安全规划" class="headerlink" title="4.4. 安全规划"></a>4.4. 安全规划</h4><ol>
<li><code>kubeadm</code> 在 <code>/etc/kubernetes/</code> 目录下自动生成的 <code>admin.conf</code> 文件包含了对 Kubernetes 集群的最高权限，因此必须由集群管理员严格保管，不要长期保留在 <code>Master</code> 节点中。</li>
<li><code>Master</code> 节点上的 <code>~/.kube/admin.conf</code> 应该仅允许授权的管理员访问，其他人严格限制访问</li>
</ol>
<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li><code>kubeadm</code> 自动在 <code>/etc/kubernetes/</code> 下生成的 <code>admin.conf</code>，更像是一个模板，供管理员配置使用。</li>
<li>而 <code>kubectl</code> 的执行，实际使用的是 <code>~/.kube/</code> 下的 <code>admin.conf</code></li>
</ol>
</blockquote>
<hr>
<h3 id="5-K8S-核心概念：Pod"><a href="#5-K8S-核心概念：Pod" class="headerlink" title="5. K8S 核心概念：Pod"></a>5. K8S 核心概念：Pod</h3><h4 id="5-1-Pod-概述"><a href="#5-1-Pod-概述" class="headerlink" title="5.1. Pod 概述"></a>5.1. Pod 概述</h4><p>在 Kubernetes（K8S）体系中，它并非直接对容器进行操作，而是以操作 Pod 为主要形式。Pod 作为 K8S 最小的操作单元，犹如一个功能完备的 “封装舱”，将一个或多个容器封装其中，同时为这些容器提供共享的存储资源、统一的网络环境以及一致的配置信息。可以说，Pod 是 Kubernetes 运行应用程序的基础载体，应用依托 Pod 得以在 K8S 集群中稳定运行和调度。</p>
<hr>
<h4 id="5-2-Pod-的生命周期"><a href="#5-2-Pod-的生命周期" class="headerlink" title="5.2. Pod 的生命周期"></a>5.2. Pod 的生命周期</h4><table>
<thead>
<tr>
<th>状态值</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Pending</strong></td>
<td align="left">Pod 已创建，但 Pod 中的一个或多个容器的镜像还没有创建</td>
</tr>
<tr>
<td><strong>Running</strong></td>
<td align="left">Pod 内所有容器已创建，且至少一个容器处于运行状态</td>
</tr>
<tr>
<td><strong>Succeed</strong></td>
<td align="left">Pod 内所有容器均成功执行退出，且不会再重启</td>
</tr>
<tr>
<td><strong>Failed</strong></td>
<td align="left">Pod 内所有容器均已退出，但至少一个容器退出失败</td>
</tr>
<tr>
<td><strong>Unknown</strong></td>
<td align="left">由于某种原因无法获取 Pod 状态，例如网络通信不畅</td>
</tr>
</tbody></table>
<hr>
<h4 id="5-3-Pod-资源的写法"><a href="#5-3-Pod-资源的写法" class="headerlink" title="5.3. Pod 资源的写法"></a>5.3. Pod 资源的写法</h4><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> v1<br><br><span class="hljs-params">kind:</span> Pod<br><br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> string<br>  <span class="hljs-params">namespace:</span> string<br>  <span class="hljs-params">labels:</span><br>    <span class="hljs-params">name:</span> string<br>  <span class="hljs-params">annotations:</span><br>    <span class="hljs-params">name:</span> string<br><br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">containers:</span><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> string<br>      <span class="hljs-params">image:</span> string<br>      <span class="hljs-params">imagePullPolicy:</span> Always | Never | IfNotPresent  <br>	   <span class="hljs-params">workingDir:</span> string<br>      <span class="hljs-params">command:</span> [<span class="hljs-string">&quot;string&quot;</span>]<br>      <span class="hljs-params">args:</span> [<span class="hljs-string">&quot;string&quot;</span>]<br><br><br>      <span class="hljs-params">volumeMounts:</span><br>        <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> string<br>          <span class="hljs-params">mountPath:</span> string<br>          <span class="hljs-params">subPath:</span> string<br>          <span class="hljs-params">readOnly:</span> boolean<br><br>      <span class="hljs-params">ports:</span><br>          <span class="hljs-params">containerPort:</span> int<br>          <span class="hljs-params">hostPort:</span> int<br>          <span class="hljs-params">protocol:</span> TCP | UDP<br>          <br>	  <span class="hljs-params">envFrom:</span><br>		  configMapRef | secretRef<br>		  <br>      <span class="hljs-params">env:</span><br>        <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> string<br>          <span class="hljs-params">value:</span> string<br>          <span class="hljs-params">valueFrom:</span><br>            configMapRef | secretKeyRef | fieldRef | resourceFieldRef<br><br>      <span class="hljs-params">resources:</span><br>        <span class="hljs-params">limits:</span><br>          <span class="hljs-params">cpu:</span> string<br>          <span class="hljs-params">memory:</span> string<br>        <span class="hljs-params">requests:</span><br>          <span class="hljs-params">cpu:</span> string<br>          <span class="hljs-params">memory:</span> string<br><br>      <span class="hljs-params">livenessProbe:</span><br>	    httpGet | tcpSocket | exec<br>	    <br>	  <span class="hljs-params">readinessProbe:</span><br>	    httpGet | tcpSocket | exec<br>        <br><br>  <span class="hljs-params">restartPolicy:</span> Always | Never | OnFailure<br><br>  <span class="hljs-params">imagePullSecrets:</span><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> string<br><br>  <span class="hljs-params">hostNetwork:</span> <span class="hljs-literal">false</span><br><br>  <span class="hljs-params">volumes:</span><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> string<br>      emptyDir | hostPath | nfs | persistentVolumeClaim | configMap | ......<br></code></pre></td></tr></table></figure>
<ol>
<li>&#x3D;&#x3D;apiVersiion&#x3D;&#x3D;：<ol>
<li>指定 API 版本，告诉 Kubernetes <strong>如何解析</strong> 这个 YAML 文件</li>
<li>可以使用 <code>kubectl api-versions</code> 查询支持的 API 版本。</li>
</ol>
</li>
<li>&#x3D;&#x3D;kind&#x3D;&#x3D;：<ol>
<li>定义 <strong>资源类型</strong>，即这个 YAML 文件要创建的 Kubernetes 资源，如 <code>Pod</code>、<code>Service</code>、<code>Deployment</code> 等。</li>
</ol>
</li>
<li>&#x3D;&#x3D;metadata&#x3D;&#x3D;：<ol>
<li><font color="#00b0f0">name</font>：<ol>
<li>资源的唯一名称，在同一命名空间下不能重复。</li>
</ol>
</li>
<li><font color="#00b0f0">namespace</font>：<ol start="2">
<li>资源所属的命名空间，未指定时默认使用当前 <code>kubectl</code> 上下文的命名空间。</li>
<li>若未切换到其他 <code>kubectl</code> 上下文，则使用默认上下文，其命名空间为 <code>default</code>。</li>
</ol>
</li>
<li><font color="#00b0f0">labels</font>：<ol>
<li>资源的标签，用于分类和筛选资源，可通过 <code>selector</code> 进行匹配。</li>
<li>详细见下文：K8S 核心概念：Labels</li>
</ol>
</li>
<li><font color="#00b0f0">annotations</font>：<ol>
<li>不要误将其理解为“注解”。虽然名字上像是注解，但 <code>annotations</code> 是用来存储<strong>额外元数据</strong>的字段，这些数据不会影响资源的实际运行或行为，但可以被外部工具、系统或用户读取和使用。</li>
</ol>
</li>
</ol>
</li>
<li>&#x3D;&#x3D;spec&#x3D;&#x3D;：<ol>
<li><font color="#00b0f0">containers</font>：<ol>
<li>定义该 Pod 内部运行的所有容器</li>
<li><font color="#7030a0">name</font>：<ol>
<li>容器的名称，同一个 Pod 下必须唯一</li>
</ol>
</li>
<li><font color="#7030a0">image</font>：<ol>
<li>容器的镜像，通常是 Docker Hub 或私有镜像仓库中的镜像</li>
</ol>
</li>
<li><font color="#7030a0">imagePullPolicy</font>：<ol start="2">
<li>定义 Pod 拉取镜像的策略</li>
<li><font color="#00b050">Always（默认）</font>：<ol>
<li>每次创建 Pod 都强制拉取镜像</li>
</ol>
</li>
<li><font color="#00b050">IfNotPresent</font>：<ol start="2">
<li>如果本地已有镜像，不会重新拉取</li>
</ol>
</li>
<li><font color="#00b050">Never</font>：<ol start="3">
<li>绝对不拉取进行，只使用本地的已有镜像</li>
</ol>
</li>
</ol>
</li>
<li><font color="#7030a0">workingDir</font>:<ol>
<li>容器内的工作目录，相当于 cd 进入某个目录再运行 <code>command</code>，如果不指定，则使用默认的 <code>/</code> 根目录</li>
</ol>
</li>
<li><font color="#7030a0">command</font>:<ol start="2">
<li>用于覆盖镜像内部默认的启动命令（<code>Entrypoint</code>），如果不指定，容器会使用镜像内部的默认命令</li>
<li>通常，<code>command</code> 与 <code>args</code> 结合使用，<code>command</code> 作为可执行文件，<code>args</code> 作为传递给 <code>command</code> 的参数：<ol>
<li>例如：<code>command: [&quot;/bin/sh&quot;,&quot;-c&quot;],args: [&quot;echo Hello &amp;&amp; sleep 3600&quot;]</code> ，最终效果是：<code>/bin/sh -c &quot;echo Hello &amp;&amp; sleep 3600&quot;</code></li>
</ol>
</li>
<li>如果你想查看容器的默认启动命令，你可以借助 Docker：<code>docker inspect &lt;image-name / image-id&gt;</code>，返回的 JSON 结果中，你可以找到 <code>Cmd</code> 和 <code>Entrypoint</code><ol start="2">
<li>如果 <code>Entrypoint</code> 是 <code>null</code> ，则使用 <code>Cmd</code> 作为默认命令</li>
<li>如果 <code>Entrypoint</code> 存在，则 <code>Cmd</code> 作为其参数</li>
</ol>
</li>
</ol>
</li>
<li><font color="#7030a0">args</font>：<ol>
<li>用于覆盖镜像内部默认的启动命令的参数（<code>Cmd</code>），如果不指定，容器会使用镜像内部的默认参数</li>
</ol>
</li>
<li><font color="#7030a0">volumeMounts</font>：<ol>
<li>容器内卷的挂载配置，用于将 <code>volumes</code> 中定义的存储卷挂载到容器内的指定目录。</li>
<li><font color="#00b050">name</font>：<ol>
<li>指定要挂载的存储卷的名称，必须与 <code>volumes</code> 中定义的名称匹配。</li>
</ol>
</li>
<li><font color="#00b050">mountPath</font>：<ol start="2">
<li>挂载点，即存储卷挂载到容器内的哪个目录。</li>
</ol>
</li>
<li><font color="#00b050">subPath</font>：<ol start="3">
<li>只挂载卷内的某个子路径或特定文件，而不是整个卷</li>
</ol>
</li>
<li><font color="#00b050">readOnly</font>：<ol start="4">
<li>是否以只读的方式挂载。<code>true</code> 表示卷只能读取，不能写入；<code>false</code> 表示可读写（默认值）。</li>
</ol>
</li>
<li>注意：如果容器中的挂载点已经有文件，挂载存储卷后，原有文件会被暂时替代</li>
<li>详细见下文：K8S 核心概念：K8S存储 &#x2F; 补充：Volume 挂载方法</li>
</ol>
</li>
<li><font color="#7030a0">ports</font>：<ol>
<li><font color="#00b050">containerPort</font>：<ol>
<li>容器内应用监听的端口</li>
</ol>
</li>
<li><font color="#00b050">hostPort</font>：<ol start="2">
<li>容器所在宿主机端口与容器监听的端口映射</li>
</ol>
</li>
<li><font color="#00b050">protocol</font>：<ol>
<li>指定端口的协议类型，通常是 <code>TCP</code> 或 <code>UDP</code>。</li>
<li><font color="#e36c09">TCP（默认）</font>：<ol>
<li>一般我们都用这个，是传输控制协议，面向连接，可靠的通信。</li>
</ol>
</li>
<li><font color="#e36c09">UDP</font> ：<ol>
<li>用户数据报协议，无连接，适用于不需要可靠性保障的应用（例如视频流、游戏等）。</li>
</ol>
</li>
</ol>
</li>
<li>注意：推荐在 Service 中统一管理，而不是在 Pod 中直接使用</li>
</ol>
</li>
<li><font color="#7030a0">envFrom</font>:<ol>
<li>从外部源（如 ConfigMap、Secret）加载多个环境变量</li>
<li><font color="#00b050">configMapRef</font>：<ol>
<li>引用一个 configMap，将其中的所有键值对加载为环境变量</li>
</ol>
</li>
<li><font color="#00b050">secretRef</font>：<ol>
<li>引用一个 secret，将其中的所有键值对加载为环境变量</li>
</ol>
</li>
<li>详细见下文：K8S 核心概念：K8S存储 &#x2F; 补充：Env 挂载方法和相关命令</li>
</ol>
</li>
<li><font color="#7030a0">env</font>:<ol>
<li>手动 <strong>指定 &#x2F; 覆盖 &#x2F; 获取</strong> 环境变量，在容器内的应用程序可以通过 <code>$&#123;env-name&#125;</code> 进行输出</li>
<li><font color="#00b050">name</font>：<ol>
<li>指定环境变量的名称</li>
</ol>
</li>
<li><font color="#00b050">value</font>：<ol>
<li>手动 <strong>指定 &#x2F; 覆盖</strong> 环境变量的值</li>
<li>若变量不存在，则设置为指定值；若变量已存在，则覆盖原有值</li>
</ol>
</li>
<li><font color="#00b050">valueFrom</font>:<ol start="2">
<li>从外部源 <strong>获取</strong> 环境变量的值</li>
<li><font color="#e36c09">configMapRef</font>:<ol>
<li>从 configMap 中 获取 某个键的值</li>
</ol>
</li>
<li><font color="#e36c09">secretKeyRef</font>：<ol start="2">
<li>从 secret 中 获取 某个键的值</li>
</ol>
</li>
<li><font color="#e36c09">fieldRef</font>：<ol start="3">
<li>从当前 Pod 的 <code>metadata</code> 中 获取 值</li>
</ol>
</li>
<li><font color="#e36c09">resourceFieldRef</font>：<ol start="4">
<li>从当前 Pod 的<code>resources</code> 下的 <code>limits</code> 或 <code>requests</code> 中 获取 值</li>
</ol>
</li>
</ol>
</li>
<li>详细见下文：K8S 核心概念：K8S存储 &#x2F; 补充：Env 挂载方法和相关命令</li>
</ol>
</li>
<li><font color="#7030a0">resources</font>:<ol>
<li>容器的资源请求和限制</li>
<li><font color="#00b050">request</font>：<ol>
<li><font color="#e36c09">cpu</font>：<ol>
<li>容器请求的 CPU 数量，如 “500m” 是 0.5 核</li>
</ol>
</li>
<li><font color="#e36c09">memory</font>：<ol start="2">
<li>容器请求的 内存 大小，如 “512Mi”、”2Gi”</li>
</ol>
</li>
</ol>
</li>
<li><font color="#00b050">limits</font><ol>
<li><font color="#e36c09">cpu</font>:<ol>
<li>限制容器的 CPU 数量</li>
</ol>
</li>
<li><font color="#e36c09">memory</font>：<ol start="2">
<li>限制容器的 内存 大小</li>
</ol>
</li>
</ol>
</li>
<li>详细见下文：K8S 核心概念：Controller &#x2F; Deployment 实战步骤</li>
</ol>
</li>
<li><font color="#7030a0">livenessProbe</font>：<ol>
<li>存活探针，判断容器是否存活</li>
<li><font color="#00b050">tcpSocket</font>：<ol>
<li>使用 tcp socket 探针</li>
</ol>
</li>
<li><font color="#00b050">httpGet</font>：<ol>
<li>使用 http get 探针</li>
</ol>
</li>
<li><font color="#00b050">exec</font>：<ol start="2">
<li>使用命令行探针</li>
</ol>
</li>
<li>详细见下文：K8S 核心概念：K8S 探针 &#x2F; 存活探针实战步骤</li>
</ol>
</li>
<li><font color="#7030a0">readinessProbe</font>：<ol>
<li>就绪探针，判断容器是否准备好接受流量</li>
<li><font color="#00b050">tcpSocket</font>：<ol>
<li>使用 tcp socket 探针</li>
</ol>
</li>
<li><font color="#00b050">httpGet</font>：<ol start="2">
<li>使用 http get 探针</li>
</ol>
</li>
<li><font color="#00b050">exec</font>：<ol>
<li>使用命令行探针</li>
</ol>
</li>
<li>详细见下文：K8S 核心概念：K8S 探针 &#x2F; 就绪探针实战步骤</li>
</ol>
</li>
</ol>
</li>
<li><font color="#00b0f0">restartPolicy</font>：<ol>
<li>Pod 的重启策略</li>
<li><font color="#7030a0">Always（默认）</font>：<ol>
<li>当容器失效时（无论正常退出还是异常退出），由 kubelet 自动重启该容器</li>
</ol>
</li>
<li><font color="#7030a0">OnFailure</font>：<ol start="2">
<li>当容器终止运行且推出码不为 0 时（异常退出），由 kubelet 自动重启该容器</li>
</ol>
</li>
<li><font color="#7030a0">Never</font>：<ol start="3">
<li>不论容器运行状态如何，kubelete 都不会重启该容器</li>
</ol>
</li>
</ol>
</li>
<li><font color="#00b0f0">imagePullSecrets</font>：<ol>
<li>指定拉取私有镜像的秘钥，通常是指向 dockerconfigjson Secret</li>
<li>详细见下文：K8S 核心概念：K8S 存储 &#x2F; Secret 实战步骤 &#x2F; dockerconfigjson Secret 实战步骤</li>
<li>注意：假如你指定了阿里云的私钥，但尝试从 Docker Hub 拉取镜像，这不会产生任何影响，因为 <code>imagePullSecrets</code> 只会用于认证指定的镜像仓库。</li>
</ol>
</li>
<li><font color="#00b0f0">hostNetwork</font>：<ol>
<li>决定 Pod 是使用 Kubernetes 默认的网络隔离模式，还是直接复用主机的网络。虽然使用主机网络（<code>hostNetwork: true</code>）可以减少网络转发的开销，从而提升访问速度，但通常我们会保持默认设置（<code>false</code>），以保证良好的网络隔离性和应用的可移植性。</li>
<li><font color="#7030a0">true</font>：<ol>
<li>容器将直接使用主机的网络资源，包括主机的 IP 和端口。</li>
<li>这种方式能提升网络性能，适用于高并发的场景（比如数据库），但通常我们会避免使用，特别是在像 Spring Boot 或 Spring Cloud 这样的应用中。默认情况下我们更倾向于保持网络隔离性和可移植性。</li>
</ol>
</li>
<li><font color="#7030a0">false（默认）</font>：<ol>
<li>使用 Kubernetes 提供的默认网络隔离，容器有独立的网络环境，无法直接访问主机的网络。</li>
<li>大多数情况下，我们会选择这个选项，以确保容器和主机网络的隔离。</li>
</ol>
</li>
</ol>
</li>
<li><font color="#00b0f0">volumes</font>：<ol>
<li>定义 Pod 级别的存储卷</li>
<li><font color="#7030a0">name</font>：<ol>
<li>存储卷名称</li>
</ol>
</li>
<li><font color="#7030a0">emptyDir</font>：<ol>
<li>使用 <code>emptyDir</code> 存储方式</li>
</ol>
</li>
<li><font color="#7030a0">hostPath</font>：<ol start="2">
<li>使用 <code>hostPath</code> 存储方式</li>
</ol>
</li>
<li><font color="#7030a0">nfs</font>：<ol>
<li>使用 <code>nfs</code> 存储方式</li>
</ol>
</li>
<li><font color="#7030a0">persistentVolumeClaim</font>：<ol start="2">
<li>使用 <code>pv + pvc</code> 存储方式</li>
</ol>
</li>
<li><font color="#7030a0">configMap</font>：<ol>
<li>使用 <code>configMap</code> 存储方式</li>
</ol>
</li>
<li><font color="#7030a0">其他存储方式</font>：<ol start="2">
<li>除了上述的存储方式，还有其他很多的存储方式</li>
</ol>
</li>
<li>详细见下文：K8S 核心概念：K8S 存储 &#x2F; 补充：Volume 挂载方法</li>
</ol>
</li>
</ol>
</li>
</ol>
<hr>
<h3 id="6-K8S-核心概念：Controller"><a href="#6-K8S-核心概念：Controller" class="headerlink" title="6. K8S 核心概念：Controller"></a>6. K8S 核心概念：Controller</h3><h4 id="6-1-Controller-引入的原因"><a href="#6-1-Controller-引入的原因" class="headerlink" title="6.1. Controller 引入的原因"></a>6.1. Controller 引入的原因</h4><p>在 前面的 Pod 中，我们虽然可以成功启动 Pod，但整个过程依赖手动管理。如果某个 Pod 发生故障，我们需要手动检测并重启，不仅繁琐，还影响效率。</p>
<p>而 Controller 的作用正是自动管理 Pod。它会监听 <code>etcd</code> 的变更，并通过 Scheduler 和 Kubelet 来管理 Pod 的生命周期，确保集群中的 Pod 数量符合预期：</p>
<ol>
<li>当 Pod 发生故障时，根据其 <code>restartPolicy</code> 自动重启（是否重启取决于策略设定）。</li>
<li>当节点发生故障时，触发 Pod 迁移，确保应用的高可用性。</li>
</ol>
<hr>
<h4 id="6-2-Controller-的类型"><a href="#6-2-Controller-的类型" class="headerlink" title="6.2. Controller 的类型"></a>6.2. Controller 的类型</h4><p>Controller 主要分为以下几类：</p>
<ol>
<li>&#x3D;&#x3D;ReplicationController（过时）&#x3D;&#x3D;：<ol>
<li><code>ReplicationController</code> 可确保指定数量的 Pod <strong>始终保持运行</strong>，即使某些 Pod 发生故障，也会自动补充。同时，它<strong>支持手动调整 Pod 副本数量</strong>，方便进行扩容或缩容</li>
<li>然而，该过滤器已过时，不建议在新项目中使用。原因在于它仅支持基于 等值匹配（equality-based） 的标签选择器（如 <code>app=my-nginx</code>），而无法兼容集合匹配（set-based） 选择器（如 <code>app in (nginx, web)</code>）</li>
</ol>
</li>
<li>&#x3D;&#x3D;ReplicaSet&#x3D;&#x3D;：<ol>
<li><code>ReplicaSet</code> 是 <code>ReplicationController</code> 的<strong>升级版</strong>，提供了更强的标签匹配功能（如支持基于集合的 Label Selector），比 RC 更灵活</li>
<li><code>ReplicaSet</code> 很少单独使用，通常是作为 <code>Deployment</code> 的一部分，由 <code>Deployment</code> 来管理</li>
</ol>
</li>
<li>&#x3D;&#x3D;Deployment&#x3D;&#x3D;：<ol>
<li><code>Deployment</code> 通过管理 <code>ReplicaSet</code>，负责 Pod 的创建、删除和更新。当你创建一个 <code>Deployment</code> 时，实际上他会自动创建并管理一个 <code>ReplicaSet</code> ，<code>Deployment</code> 通过控制 <code>ReplicaSet</code> 来间接管理 Pod 的创建、删除和更新等操作。</li>
<li>此外，<code>Deployment</code> 还支持<strong>滚动更新</strong>（平稳升级，避免服务中断）、回滚、暂停&#x2F;恢复更新等功能，并能与 HPA 和 Service 配合使用，实现弹性扩缩容和流量管理</li>
</ol>
</li>
<li>&#x3D;&#x3D;HPA&#x3D;&#x3D;：<ol>
<li><code>Horizontal Pod Autoscaler（HPA）</code>用于根据 CPU 使用率、内存使用率或自定义指标自动调整 Deployment 等资源的 Pod 副本数量，以实现资源的<strong>弹性伸缩</strong>。</li>
<li>举例来说，若让 HPA 监控 CPU 使用率，当 CPU 使用率超出设定的阈值（如 50%）时，HPA 会自动增加 Pod 的数量，以应对更高的负载；而当 CPU 使用率低于设定阈值时，HPA 则会减少 Pod 的数量，从而节省资源。</li>
</ol>
</li>
<li>&#x3D;&#x3D;Deployment + HPA&#x3D;&#x3D;：<ol>
<li>当前主流，强烈推荐，其口诀是，先创 Deployment 再创 HPA</li>
</ol>
</li>
</ol>
<hr>
<h4 id="6-3-RC-实战步骤"><a href="#6-3-RC-实战步骤" class="headerlink" title="6.3. RC 实战步骤"></a>6.3. RC 实战步骤</h4><p>&#x3D;&#x3D;1.编写 RC 资源 yaml 文件&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> v1<br><span class="hljs-params">kind:</span> ReplicaController<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> nginx-rc<br>  <span class="hljs-params">namespace:</span> default<br>  <span class="hljs-params">labels:</span><br>    <span class="hljs-params">controller:</span> nginx-rc<br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">replicas:</span> <span class="hljs-number">3</span>                                        <span class="hljs-comment"># 期望始终有几个 Pod</span><br>  <span class="hljs-params">selector:</span>                                          <span class="hljs-comment"># 指定该控制器负责哪些标签的 Pod</span><br>    <span class="hljs-params">app:</span> nginx<br>  <span class="hljs-params">template:</span>                                          <span class="hljs-comment"># Pod 模版，用来定义 Pod</span><br>    <span class="hljs-params">metadata:</span><br>      <span class="hljs-params">labels:</span><br>        <span class="hljs-params">app:</span> nginx<br>    <span class="hljs-params">spec:</span><br>      <span class="hljs-params">containers:</span><br>        <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> nginx-container<br>          <span class="hljs-params">image:</span> nginx:<span class="hljs-number">1.23</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li><code>ReplicationController</code> 允许在 <code>spec.template</code> 中定义 <code>Pod</code> 资源，除了 <code>apiVersion</code>、<code>kind</code>、<code>metadata.namespace</code>，其他字段均可在 <code>spec.template</code> 中指定</li>
<li>Pod 模版中不能单独指定 <code>kind</code>，因为他的类型只能是 Pod</li>
<li><font color="#ff0000">Pod 模版中不能单独指定 <code>namespace</code>，它会自动继承其所属 <code>Controller</code> 的 <code>namespace</code>。（☆☆☆）</font></li>
<li>Pod 的 <code>labels</code> 与 Controller 的 <code>labels</code> 互不相关：<code>Pod</code> 的 <code>labels</code> 仅用于标识 Pod 本身，而 <code>Controller</code> 的 <code>labels</code> 仅用于标识 Controller 本身，二者不会相互继承。</li>
</ol>
</blockquote>
<p>&#x3D;&#x3D;2.创建 RC 资源&#x3D;&#x3D;</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">kubectl <span class="hljs-built_in">apply</span> -f rc.yaml<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;3.检查 RC 资源状态&#x3D;&#x3D;</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">kubectl <span class="hljs-keyword">get</span> rc -n &lt;rc-<span class="hljs-keyword">namespace</span>&gt;<br></code></pre></td></tr></table></figure>

<hr>
<h4 id="6-4-RS-实战步骤"><a href="#6-4-RS-实战步骤" class="headerlink" title="6.4. RS 实战步骤"></a>6.4. RS 实战步骤</h4><p>&#x3D;&#x3D;1.编辑 RS 资源 yaml 文件&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> apps<span class="hljs-symbol">/v1</span><br><span class="hljs-params">kind:</span> ReplicaSet<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> my-rs<br>  <span class="hljs-params">labels:</span> <br>    <span class="hljs-params">controller:</span> nginx-rs<br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">replicas:</span> <span class="hljs-number">3</span>                                      <span class="hljs-comment"># 期望始终有几个 Pod                        </span><br>  <span class="hljs-params">selector:</span>                                        <span class="hljs-comment"># 指定该控制器负责管理哪些标签的 Pod          </span><br>    <span class="hljs-params">matchLabels:</span>                                   <span class="hljs-comment"># 根据 Labels 筛选 Pod               </span><br>      <span class="hljs-params">app:</span> nginx<br>  <span class="hljs-params">template:</span>                                        <span class="hljs-comment"># Pod 模版，用来定义 Pod                 </span><br>    <span class="hljs-params">metadata:</span> <br>      <span class="hljs-params">labels:</span><br>        <span class="hljs-params">app:</span> nginx<br>    <span class="hljs-params">spec:</span><br>      <span class="hljs-params">containers:</span><br>      <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> nginx<br>        <span class="hljs-params">image:</span> nginx<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项：更强的标签匹配功能该怎么写</p>
</blockquote>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">spec</span><span class="hljs-punctuation">:                                           </span><br>  <span class="hljs-attribute">selector</span><span class="hljs-punctuation">:                                                        </span><br>    <span class="hljs-attribute">matchExpressions</span><span class="hljs-punctuation">:                                                </span><br>	  <span class="hljs-bullet">-</span> <span class="hljs-string">key: app</span><br>	    <span class="hljs-attribute">operator</span><span class="hljs-punctuation">:</span> <span class="hljs-string">In                                # operator 操作符</span><br>	    <span class="hljs-attribute">values</span><span class="hljs-punctuation">:</span><br>	      <span class="hljs-bullet">-</span> <span class="hljs-string">my-app</span><br>	      <span class="hljs-bullet">-</span> <span class="hljs-string">another-app</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;2.创建 RS 资源&#x3D;&#x3D;</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">kubectl <span class="hljs-built_in">apply</span> -f rs.yaml<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;3.检查 RS 资源状态&#x3D;&#x3D;</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">kubectl <span class="hljs-keyword">get</span> rs -n &lt;controller-<span class="hljs-keyword">namespace</span>&gt;<br></code></pre></td></tr></table></figure>

<hr>
<h4 id="6-5-Deployment-实战步骤"><a href="#6-5-Deployment-实战步骤" class="headerlink" title="6.5. Deployment 实战步骤"></a>6.5. Deployment 实战步骤</h4><p>&#x3D;&#x3D;1.编写 Deployment 资源 yaml 文件&#x3D;&#x3D;</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">apiVersion:</span> apps/v1<br><span class="hljs-symbol">kind:</span> Deployment<br><span class="hljs-symbol">metadata:</span><br><span class="hljs-symbol">  name:</span> nginx-deployment<br><span class="hljs-symbol">  namespace:</span> default<br><span class="hljs-symbol">  labels:</span><br><span class="hljs-symbol">    app:</span> nginx<br><span class="hljs-symbol">spec:</span><br><span class="hljs-symbol">  replicas:</span> <span class="hljs-number">3</span>                             <span class="hljs-meta"># 期望始终有几个 Pod（若使用 HPA，该值会动态调整）</span><br><span class="hljs-symbol">  selector:</span>                               <span class="hljs-meta"># 指定该控制器负责管理哪些标签的 Pod</span><br><span class="hljs-symbol">    matchLabels:</span>                          <span class="hljs-meta"># 根据 Labels 筛选 Pod</span><br><span class="hljs-symbol">      app:</span> nginx<br><span class="hljs-symbol">  strategy:</span>                               <span class="hljs-meta"># 更新策略</span><br><span class="hljs-symbol">    type:</span> RollingUpdate                   <span class="hljs-meta"># 采用滚动更新策略</span><br><span class="hljs-symbol">    rollingUpdate:</span>                        <span class="hljs-meta"># 滚动更新策略配置</span><br><span class="hljs-symbol">      maxUnavailable:</span> <span class="hljs-number">1</span>                   <span class="hljs-meta"># 更新时最多允许几个 Pod 不可用，如1、25%</span><br><span class="hljs-symbol">      maxSurge:</span> <span class="hljs-number">1</span>                         <span class="hljs-meta"># 更新时最多额外创建几个新 Pod，如1、25%</span><br><span class="hljs-symbol">  template:</span>                               <span class="hljs-meta"># Pod 模版，用来定义 Pod</span><br><span class="hljs-symbol">    metadata:</span><br><span class="hljs-symbol">      labels:</span><br><span class="hljs-symbol">        app:</span> nginx<br><span class="hljs-symbol">    spec:</span><br><span class="hljs-symbol">      containers:</span><br>        - name: nginx-container<br><span class="hljs-symbol">          image:</span> nginx:<span class="hljs-number">1.25</span><br><span class="hljs-symbol">          resources:</span>                      <span class="hljs-meta"># 资源限制，容器不能超过该值</span><br><span class="hljs-symbol">            requests:</span><br><span class="hljs-symbol">              cpu:</span> <span class="hljs-string">&quot;250m&quot;</span>                 <span class="hljs-meta"># 资源请求的 CPU 数量，如 <span class="hljs-string">&quot;500m&quot;</span>（0.5核）</span><br><span class="hljs-symbol">              memory:</span> <span class="hljs-string">&quot;128Mi&quot;</span>             <span class="hljs-meta"># 资源请求的内存大小，如 <span class="hljs-string">&quot;512Mi&quot;</span>、<span class="hljs-string">&quot;2Gi&quot;</span></span><br><span class="hljs-symbol">            limits:</span><br><span class="hljs-symbol">              cpu:</span> <span class="hljs-string">&quot;500m&quot;</span>                 <span class="hljs-meta"># 限制资源的 CPU 数量，如 <span class="hljs-string">&quot;500m&quot;</span>（0.5核）</span><br><span class="hljs-symbol">              memory:</span> <span class="hljs-string">&quot;256Mi&quot;</span>             <span class="hljs-meta"># 限制资源的内存大小，如 <span class="hljs-string">&quot;512Mi&quot;</span>、<span class="hljs-string">&quot;2Gi&quot;</span></span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项：<code>RollingUpdate</code> 更新流程：</p>
<ol>
<li>首先创建新的 Pod（基于新的 <code>image</code> 版本）</li>
<li>等待新 Pod 运行正常（通过探针检测健康状况）</li>
<li>逐步删除旧的 Pod，直到所有的 Pod 都被替换成新版本</li>
</ol>
</blockquote>
<p>&#x3D;&#x3D;2.创建 Deployment 资源&#x3D;&#x3D;</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">kubectl <span class="hljs-built_in">apply</span> -f deployment.yaml<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;3.检查 Deployment 资源状态&#x3D;&#x3D;</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">kubectl <span class="hljs-keyword">get</span> deployment -n &lt;controller-<span class="hljs-keyword">namespace</span>&gt;<br></code></pre></td></tr></table></figure>


<hr>
<h4 id="6-6-HPA-实战步骤"><a href="#6-6-HPA-实战步骤" class="headerlink" title="6.6. HPA 实战步骤"></a>6.6. HPA 实战步骤</h4><h5 id="6-6-1-编写-HPA-资源-yaml-文件"><a href="#6-6-1-编写-HPA-资源-yaml-文件" class="headerlink" title="6.6.1. 编写 HPA 资源 yaml 文件"></a>6.6.1. 编写 HPA 资源 yaml 文件</h5><p>&#x3D;&#x3D;1.基于 CPU 使用率&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> autoscaling<span class="hljs-symbol">/v2</span><br><span class="hljs-params">kind:</span> HorizontalPodAutoscaler<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> hpa-cpu<br>  <span class="hljs-params">namespace:</span> default<br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">scaleTargetRef:</span><br>    <span class="hljs-params">apiVersion:</span> apps<span class="hljs-symbol">/v1</span>                                   <span class="hljs-comment"># 目标 API 版本（Deployment 的 API 版本）</span><br>    <span class="hljs-params">kind:</span> Deployment                                      <span class="hljs-comment"># 目标资源类型，如 Deployment</span><br>    <span class="hljs-params">name:</span> my-deployment                                   <span class="hljs-comment"># 目标资源名称，如 Deployment-name</span><br>  <span class="hljs-params">minReplicas:</span> <span class="hljs-number">2</span>                                          <span class="hljs-comment"># 最小 Pod 数量</span><br>  <span class="hljs-params">maxReplicas:</span> <span class="hljs-number">10</span>                                         <span class="hljs-comment"># 最大 Pod 数量</span><br>  <span class="hljs-params">metrics:</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">type:</span> Resource                                        <span class="hljs-comment"># 指定资源指标</span><br>    <span class="hljs-params">resource:</span><br>      <span class="hljs-params">name:</span> cpu                                           <span class="hljs-comment"># 监控 CPU 资源</span><br>      <span class="hljs-params">target:</span><br>        <span class="hljs-params">type:</span> Utilization                                 <span class="hljs-comment"># 使用利用率模式</span><br>        <span class="hljs-params">averageUtilization:</span> <span class="hljs-number">80</span>                            <span class="hljs-comment"># 当平均 CPU 利用率达到 80% 时触发扩容</span><br></code></pre></td></tr></table></figure>

<hr>
<p>&#x3D;&#x3D;2.基于 内存使用率&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> autoscaling<span class="hljs-symbol">/v2</span><br><span class="hljs-params">kind:</span> HorizontalPodAutoscaler<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> hpa-memory<br>  <span class="hljs-params">namespace:</span> default<br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">scaleTargetRef:</span><br>    <span class="hljs-params">apiVersion:</span> apps<span class="hljs-symbol">/v1</span>                                  <span class="hljs-comment"># 目标 API 版本</span><br>    <span class="hljs-params">kind:</span> Deployment                                     <span class="hljs-comment"># 目标资源类型，如 Deployment</span><br>    <span class="hljs-params">name:</span> my-deployment                                  <span class="hljs-comment"># 目标资源名称，如 Deployment-name</span><br>  <span class="hljs-params">minReplicas:</span> <span class="hljs-number">2</span>                                         <span class="hljs-comment"># 最小 Pod 数量</span><br>  <span class="hljs-params">maxReplicas:</span> <span class="hljs-number">10</span>                                        <span class="hljs-comment"># 最大 Pod 数量</span><br>  <span class="hljs-params">metrics:</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">type:</span> Resource                                       <span class="hljs-comment"># 指定资源指标</span><br>    <span class="hljs-params">resource:</span><br>      <span class="hljs-params">name:</span> memory                                       <span class="hljs-comment"># 监控内存资源</span><br>      <span class="hljs-params">target:</span><br>        <span class="hljs-params">type:</span> Utilization                                <span class="hljs-comment"># 使用利用率模式</span><br>        <span class="hljs-params">averageUtilization:</span> <span class="hljs-number">80</span>                           <span class="hljs-comment"># 当平均内存使用率达到 80% 时触发扩容</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>想要使用内存指标，你必须确保集群中已经安装并正常运行 <code>metrics-server</code></li>
</ol>
</blockquote>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"># <span class="hljs-number">1.</span> 检查 metrices-<span class="hljs-keyword">server</span> 是否已安装<br>kubectl <span class="hljs-keyword">get</span> deployment metrics-<span class="hljs-keyword">server</span> -n kube-<span class="hljs-keyword">system</span><br><br><br># <span class="hljs-number">2.</span> 安装 metrices-<span class="hljs-keyword">server</span> <br>kubectl apply -f https://github.com/kubernetes-sigs/metrics-<span class="hljs-keyword">server</span>/releases/download/v0<span class="hljs-number">.6</span><span class="hljs-number">.1</span>/components.yaml<br><br><br># <span class="hljs-number">3.</span> 确认 metrics-<span class="hljs-keyword">server</span> 部署情况<br>kubectl <span class="hljs-keyword">get</span> deployment metrics-<span class="hljs-keyword">server</span> -n kube-<span class="hljs-keyword">system</span><br><br><br># <span class="hljs-number">4.</span> 验证 metrics-<span class="hljs-keyword">server</span> 是否工作正常<br>kubectl top nodes<br>kubectl top pods<br></code></pre></td></tr></table></figure>

<hr>
<p>&#x3D;&#x3D;3.基于 自定义指标&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> autoscaling<span class="hljs-symbol">/v2</span><br><span class="hljs-params">kind:</span> HorizontalPodAutoscaler<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> hpa-custom<br>  <span class="hljs-params">namespace:</span> default<br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">scaleTargetRef:</span><br>    <span class="hljs-params">apiVersion:</span> apps<span class="hljs-symbol">/v1</span>                                <span class="hljs-comment"># 目标 API 版本</span><br>    <span class="hljs-params">kind:</span> Deployment                                   <span class="hljs-comment"># 目标资源类型，如 Deployment</span><br>    <span class="hljs-params">name:</span> my-deployment                                <span class="hljs-comment"># 目标资源名称，如 Deployment-name</span><br>  <span class="hljs-params">minReplicas:</span> <span class="hljs-number">2</span>                                       <span class="hljs-comment"># 最小 Pod 数量</span><br>  <span class="hljs-params">maxReplicas:</span> <span class="hljs-number">10</span>                                      <span class="hljs-comment"># 最大 Pod 数量</span><br>  <span class="hljs-params">metrics:</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">type:</span> Pods                                         <span class="hljs-comment"># 指定 Pod 级别的自定义指标</span><br>    <span class="hljs-params">pods:</span><br>      <span class="hljs-params">metric:</span><br>        <span class="hljs-params">name:</span> requests_per_second                      <span class="hljs-comment"># 自定义指标的名称</span><br>      <span class="hljs-params">target:</span><br>        <span class="hljs-params">type:</span> AverageValue                             <span class="hljs-comment"># 目标类型为平均值</span><br>        <span class="hljs-params">averageValue:</span> <span class="hljs-string">&quot;100&quot;</span>                            <span class="hljs-comment"># 每个 Pod 的指标平均值达到 100 时触发扩容</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>定义 HPA 相对简单，指标可以根据需求自由定义，但真正的挑战在于如何将这些指标暴露给 Kubernetes，以便它能够基于这些指标进行弹性伸缩，这里先不展开。</li>
</ol>
</blockquote>
<hr>
<h5 id="6-6-2-创建-HPA-资源"><a href="#6-6-2-创建-HPA-资源" class="headerlink" title="6.6.2. 创建 HPA 资源"></a>6.6.2. 创建 HPA 资源</h5><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">kubectl <span class="hljs-built_in">apply</span> -f hpa.yaml<br></code></pre></td></tr></table></figure>

<hr>
<h5 id="6-6-3-检查-HPA-资源状态"><a href="#6-6-3-检查-HPA-资源状态" class="headerlink" title="6.6.3. 检查 HPA 资源状态"></a>6.6.3. 检查 HPA 资源状态</h5><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">kubectl <span class="hljs-keyword">get</span> hpa -n &lt;controller-<span class="hljs-keyword">namespace</span>&gt;<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="7-K8S-核心概念：Labels"><a href="#7-K8S-核心概念：Labels" class="headerlink" title="7. K8S 核心概念：Labels"></a>7. K8S 核心概念：Labels</h3><h4 id="7-1-Labels-引入的原因"><a href="#7-1-Labels-引入的原因" class="headerlink" title="7.1. Labels 引入的原因"></a>7.1. Labels 引入的原因</h4><p>假设你有一个复杂的系统，包含多个微服务，每个服务有多个 Pod 实例。例如，你的系统有以下服务：<code>web</code>、<code>api</code>、<code>database</code>，每个服务对应多个实例：</p>
<ul>
<li><code>web-1</code>、<code>web-2</code>、<code>web-3</code></li>
<li><code>api-1</code>、<code>api-2</code>、<code>api-3</code></li>
<li><code>db-1</code>、<code>db-2</code>、<code>db-3</code><br>在传统的管理方式中，你可能只能通过 <strong>Pod 的名称或 ID</strong> 来定位它们，甚至可能需要进入每个 Pod 查看详细信息，这样既麻烦又低效。<br>但如果你在创建 Pod 时 <strong>为它们打上标签</strong>（例如 <code>app=web</code>、<code>app=api</code>、<code>app=db</code>），你就能通过 <strong>标签快速筛选</strong> 出相关的资源，无需逐个查找或进入 Pod，极大地提高了效率。</li>
</ul>
<hr>
<h4 id="7-2-Labels-常见的约定"><a href="#7-2-Labels-常见的约定" class="headerlink" title="7.2. Labels 常见的约定"></a>7.2. Labels 常见的约定</h4><p>尽管标签可以自定义，但我们通常将其与 <code>Namespace</code> 结合使用，并遵循一些常见的约定，具体如下：</p>
<ol>
<li>&#x3D;&#x3D;Namespace&#x3D;&#x3D;：<ol>
<li><code>Namespace</code> 用于隔离不同的环境、团队或应用，每个资源只能属于一个 <code>Namespace</code>。常见的约定包括：</li>
<li><font color="#00b0f0">隔离环境</font>：<ol>
<li><code>namespace: env_dev</code>：开发环境</li>
<li><code>namespace: env_test</code>：测试环境</li>
<li><code>namespace: env_staging</code>：预生产环境</li>
<li><code>namespace: env_prod</code>：生产环境</li>
</ol>
</li>
<li><font color="#00b0f0">开发团队</font>：<ol>
<li><code>namespace: team_tencent</code>：腾讯团队</li>
</ol>
</li>
<li><font color="#00b0f0">应用名称</font>：<ol start="2">
<li><code>namespace: app_qqrobot</code>：QQ 机器人应用</li>
</ol>
</li>
</ol>
</li>
<li>&#x3D;&#x3D;Labels&#x3D;&#x3D;：<ol>
<li><code>Labels</code> 用于标识资源的具体业务、版本、角色等，一个资源可以具有多个标签。常见的约定如下：</li>
<li><font color="#00b0f0">业务</font>：<ol>
<li><code>bussiness: nginx</code>：负载均衡业务</li>
<li><code>bussiness: payment</code>：支付业务</li>
</ol>
</li>
<li><font color="#00b0f0">版本</font>：<ol>
<li><code>version: v1.0</code>：版本 v1.0</li>
</ol>
</li>
<li><font color="#00b0f0">角色</font>：<ol start="2">
<li><code>role: batian</code>：开发人员”霸天”</li>
</ol>
</li>
</ol>
</li>
</ol>
<hr>
<h3 id="8-K8S-核心概念：Namespace"><a href="#8-K8S-核心概念：Namespace" class="headerlink" title="8. K8S 核心概念：Namespace"></a>8. K8S 核心概念：Namespace</h3><h4 id="8-1-Namespace-引入的原因"><a href="#8-1-Namespace-引入的原因" class="headerlink" title="8.1. Namespace 引入的原因"></a>8.1. Namespace 引入的原因</h4><p>Namespace 为不同环境、团队或应用的资源（例如 Pod、Service 等）提供了一个<strong>逻辑分组</strong>，使得资源管理、权限控制和配额设置更加清晰高效。</p>
<p><font color="#ff0000">需要注意的是，在 K8S 中，一个资源只能归属于一个命名空间，但可以携带多个标签（Labels）。</font></p>
<hr>
<h4 id="8-2-Namespace-常见的约定"><a href="#8-2-Namespace-常见的约定" class="headerlink" title="8.2. Namespace 常见的约定"></a>8.2. Namespace 常见的约定</h4><p>尽管 <code>Namespace</code> 可以自定义，但我们通常将其与 <code>Labels</code> 结合使用，并遵循一些常见的约定，具体如下：</p>
<ol>
<li>&#x3D;&#x3D;Namespace&#x3D;&#x3D;：<ol>
<li><code>Namespace</code> 用于隔离不同的环境、团队或应用，每个资源只能属于一个 <code>Namespace</code>。常见的约定包括：</li>
<li><font color="#00b0f0">隔离环境</font>：<ol>
<li><code>namespace: env_dev</code>：开发环境</li>
<li><code>namespace: env_test</code>：测试环境</li>
<li><code>namespace: env_staging</code>：预生产环境</li>
<li><code>namespace: env_prod</code>：生产环境</li>
</ol>
</li>
<li><font color="#00b0f0">开发团队</font>：<ol>
<li><code>namespace: team_tencent</code>：腾讯团队</li>
</ol>
</li>
<li><font color="#00b0f0">应用名称</font>：<ol start="2">
<li><code>namespace: app_qqrobot</code>：QQ 机器人应用</li>
</ol>
</li>
</ol>
</li>
<li>&#x3D;&#x3D;Labels&#x3D;&#x3D;：<ol>
<li><code>Labels</code> 用于标识资源的具体业务、版本、角色等，一个资源可以具有多个标签。常见的约定如下：</li>
<li><font color="#00b0f0">业务</font>：<ol>
<li><code>bussiness: nginx</code>：负载均衡业务</li>
<li><code>bussiness: payment</code>：支付业务</li>
</ol>
</li>
<li><font color="#00b0f0">版本</font>：<ol>
<li><code>version: v1.0</code>：版本 v1.0</li>
</ol>
</li>
<li><font color="#00b0f0">角色</font>：<ol start="2">
<li><code>role: batian</code>：开发人员”霸天”</li>
</ol>
</li>
</ol>
</li>
</ol>
<hr>
<h4 id="8-3-创建-Namespace-资源"><a href="#8-3-创建-Namespace-资源" class="headerlink" title="8.3. 创建 Namespace 资源"></a>8.3. 创建 Namespace 资源</h4><p>&#x3D;&#x3D;1.编写 Namespace 资源 yaml 文件&#x3D;&#x3D;</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs vbnet"><span class="hljs-symbol">apiVersion:</span> v1<br><span class="hljs-symbol">kind:</span> <span class="hljs-keyword">Namespace</span><br><span class="hljs-symbol">metadata:</span><br>  name: my-<span class="hljs-keyword">namespace</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;2.创建 Namespace 资源&#x3D;&#x3D;</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tcl">kubectl <span class="hljs-keyword">apply</span> -f <span class="hljs-keyword">namespace</span>.yaml<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;3.检查 Namespace 资源状态&#x3D;&#x3D;</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">kubectl <span class="hljs-keyword">get</span> <span class="hljs-keyword">namespace</span> &lt;<span class="hljs-keyword">namespace</span>-name&gt;<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="9-K8S-核心概念：K8S-调度器"><a href="#9-K8S-核心概念：K8S-调度器" class="headerlink" title="9. K8S 核心概念：K8S 调度器"></a>9. K8S 核心概念：K8S 调度器</h3><h4 id="9-1-调度器-引入的原因"><a href="#9-1-调度器-引入的原因" class="headerlink" title="9.1. 调度器 引入的原因"></a>9.1. 调度器 引入的原因</h4><p>上面的 <code>Namespace</code> 仅实现了逻辑分区，但不同的 <code>Pod</code> 仍然可能运行在同一台主机上。而调度器的作用在于实现物理隔离，即决定 <code>Pod</code> 应该运行在哪台主机上，以及主机如何主动将 <code>Pod</code> 驱逐。</p>
<hr>
<h4 id="9-2-调度器-的调度因素"><a href="#9-2-调度器-的调度因素" class="headerlink" title="9.2. 调度器 的调度因素"></a>9.2. 调度器 的调度因素</h4><p>调度器主要受以下三部分因素的影响：</p>
<ol>
<li>&#x3D;&#x3D;节点亲和度&#x3D;&#x3D;：<ol>
<li>调度器会主动将 Pod 分配到满足特定条件的节点上，即根据节点的特性来选择合适的运行环境。</li>
</ol>
</li>
<li>&#x3D;&#x3D;Pod 亲和度&#x3D;&#x3D;：<ol>
<li>调度器会将彼此具有亲和关系的 Pod 调度到同一台服务器上，这样可以缩短它们之间的通信延迟，提高整体性能</li>
</ol>
</li>
<li>&#x3D;&#x3D;污点和容忍性&#x3D;&#x3D;：<ol>
<li>节点不断被赋予污点，如果 Pod 没有相应的容忍度，就无法适应这种环境，最终会被节点主动驱逐。</li>
<li><font color="#00b0f0">污点（Taints）  </font><ol>
<li>定义在节点上，为节点“打上污点”，让它显示出不欢迎普通 Pod 的特性。</li>
</ol>
</li>
<li><font color="#00b0f0">容忍度（Tolerations）</font><ol>
<li>定义在 Pod 上，用来说明该 Pod 能接受节点上的特殊污点，从而允许其在带有污点的节点上运行。</li>
</ol>
</li>
</ol>
</li>
</ol>
<hr>
<h4 id="9-3-K8S-调度工作流程"><a href="#9-3-K8S-调度工作流程" class="headerlink" title="9.3. K8S 调度工作流程"></a>9.3. K8S 调度工作流程</h4><p>Kubernetes 调度器（kube-scheduler）就好比集群的“大脑”，它不断观察 API Server 的“呼救信号”，将那些还没有座位（即 PodSpec.NodeName 为空）的 Pod 逐一分配到合适的节点上。整个调度过程大致分为三个阶段：</p>
<ol>
<li>&#x3D;&#x3D;预选阶段（Predicates）&#x3D;&#x3D;<ol>
<li>在这个阶段，调度器先像严格的门卫一样过滤掉那些“不符合要求”的节点。比如：</li>
<li><font color="#00b0f0">PodFitsResources</font>：<ol>
<li>检查节点是否有足够的资源（CPU、内存、存储等）来满足 Pod 的需求。</li>
</ol>
</li>
<li><font color="#00b0f0">PodFitsHostPorts</font>：<ol>
<li>检查节点是否存在与 Pod 端口冲突的情况，确保所请求的端口没有被其他 Pod 使用。</li>
</ol>
</li>
<li><font color="#00b0f0">NoDiskConflict</font>：<ol start="2">
<li>检查节点上的磁盘是否存在冲突，确保没有磁盘资源冲突。</li>
</ol>
</li>
<li><font color="#00b0f0">CheckNodeDiskPressure</font>：<ol>
<li>检查节点是否因为磁盘压力（磁盘满了等问题）而不能调度 Pod。</li>
</ol>
</li>
<li><font color="#00b0f0">CheckNodeMemoryPressure</font>：<ol start="2">
<li>检查节点是否因为内存压力而不能调度 Pod。</li>
</ol>
</li>
<li><font color="#00b0f0">TaintToleration</font>：<ol>
<li><font color="#ff0000">检查节点是否有污点（taint）。如果节点上存在污点，调度器会检查 Pod 是否具有与该污点匹配的容忍度（toleration）。如果 Pod 没有匹配的容忍度，则该 Pod 将无法调度到该节点（☆☆☆）</font></li>
</ol>
</li>
<li>如果所有节点都不合适，Pod 就只能站在门口等候（Pending 状态），直到有节点“空出座位”。</li>
</ol>
</li>
<li>&#x3D;&#x3D;优选阶段（Priorities）&#x3D;&#x3D;  <ol>
<li>通过预选后，调度器会为剩下的节点打分，就像给各个餐桌打分：哪个桌子环境好、资源充足、服务棒？打分高的节点将更有机会获得这个 Pod 的“订单”。常见的优选策略有：</li>
<li><font color="#00b0f0">LeastRequestedPriority</font>：<ol>
<li>资源使用越低，得分越高，就像优先安排那些桌子空闲的区域。</li>
</ol>
</li>
<li><font color="#00b0f0">SelectorSpreadPriority</font>：<ol>
<li>为了高可用，尽量把同一组 Pod 分散在不同节点上。</li>
</ol>
</li>
<li><font color="#00b0f0">ImageLocalityPriority</font>：<ol start="2">
<li>如果某个节点上已经下载了需要的镜像，那么“就餐速度”更快，得分自然上升。</li>
</ol>
</li>
<li><font color="#00b0f0">NodeAffinityPriority</font>：<ol>
<li><font color="#ff0000">根据节点亲和性打分（☆☆☆）</font></li>
</ol>
</li>
</ol>
</li>
<li>&#x3D;&#x3D;Binding 阶段&#x3D;&#x3D;  <ol>
<li>最后，调度器会选择打分最高的节点，并通过绑定操作（binding）把 Pod 安排到这个节点上，最终记录到 etcd 中。随后，该节点上的 kubelet 会监听到 etcd 的变更，并创建 Pod。</li>
</ol>
</li>
</ol>
<hr>
<h4 id="9-4-节点亲和度实战步骤"><a href="#9-4-节点亲和度实战步骤" class="headerlink" title="9.4. 节点亲和度实战步骤"></a>9.4. 节点亲和度实战步骤</h4><h5 id="9-4-1-节点硬亲和度"><a href="#9-4-1-节点硬亲和度" class="headerlink" title="9.4.1. 节点硬亲和度"></a>9.4.1. 节点硬亲和度</h5><p>节点必须满足这个条件，否则 Pod 就不会被安排在这个节点上</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> v1<br><span class="hljs-params">kind:</span> Pod<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> <span class="hljs-keyword">with</span>-required-nodeaffinity<br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">affinity:</span>                                                            <span class="hljs-comment"># 配置 亲和性</span><br>    <span class="hljs-params">nodeAffinity:</span>                                                      <span class="hljs-comment"># 配置 节点亲和性</span><br>      <span class="hljs-params">requiredDuringSchedulingIgnoredDuringExecution:</span>                  <span class="hljs-comment"># 配置 节点硬亲和性</span><br>        <span class="hljs-params">nodeSelectorTerms:</span>                                             <span class="hljs-comment"># 定义匹配节点的规则</span><br>          <span class="hljs-operator">-</span> <span class="hljs-params">matchExpressions:</span>                                          <span class="hljs-comment"># 用于匹配节点</span><br>              <span class="hljs-operator">-</span> &#123; <span class="hljs-params">key:</span> zone, <span class="hljs-params">operator:</span> In, <span class="hljs-params">values:</span> [<span class="hljs-string">&quot;foo&quot;</span>] &#125;           <span class="hljs-comment"># 调度到 zone=foo 的节点</span><br>  <span class="hljs-params">containers:</span><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> myapp<br>      <span class="hljs-params">image:</span> ikubernetes<span class="hljs-operator">/</span>myapp:v1<br><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项：<code>requiredDuringSchedulingInnoredDuringExecution</code></p>
<ol>
<li><font color="#00b0f0">调度时</font>：<ul>
<li>在调度时，Pod 会要求节点满足特定的条件，否则调度器不会将 Pod 调度到该节点。</li>
</ul>
</li>
<li><font color="#00b0f0">调度后</font>：<ul>
<li>一旦 Pod 被调度到节点，即使节点的条件发生变化，Pod 仍会继续运行，不会受到影响，直到 Pod 被删除或重新调度</li>
</ul>
</li>
</ol>
</blockquote>
<hr>
<h5 id="9-4-2-节点软亲和度"><a href="#9-4-2-节点软亲和度" class="headerlink" title="9.4.2. 节点软亲和度"></a>9.4.2. 节点软亲和度</h5><p>为符合条件的节点指定权重（1-100），权重越高优先级越高仅仅是“推荐”而已，就像餐厅服务员建议你坐靠窗的位置，但你坐哪儿都行。</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> apps<span class="hljs-symbol">/v1</span><br><span class="hljs-params">kind:</span> Deployment<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> myapp-deploy-<span class="hljs-keyword">with</span>-node-affinity<br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">replicas:</span> <span class="hljs-number">2</span><br>  <span class="hljs-params">selector:</span><br>    <span class="hljs-params">matchLabels:</span><br>      <span class="hljs-params">app:</span> myapp<br>  <span class="hljs-params">template:</span><br>    <span class="hljs-params">metadata:</span><br>      <span class="hljs-params">labels:</span><br>        <span class="hljs-params">app:</span> myapp<br>    <span class="hljs-params">spec:</span><br>      <span class="hljs-params">affinity:</span><br>        <span class="hljs-params">nodeAffinity:</span><br>          <span class="hljs-params">preferredDuringSchedulingIgnoredDuringExecution:</span><br>            <span class="hljs-operator">-</span> <span class="hljs-params">weight:</span> <span class="hljs-number">60</span><br>              <span class="hljs-params">preference:</span><br>                <span class="hljs-params">matchExpressions:</span><br>                  <span class="hljs-operator">-</span> &#123; <span class="hljs-params">key:</span> zone, <span class="hljs-params">operator:</span> In, <span class="hljs-params">values:</span> [<span class="hljs-string">&quot;foo&quot;</span>] &#125;<br>            <span class="hljs-operator">-</span> <span class="hljs-params">weight:</span> <span class="hljs-number">30</span><br>              <span class="hljs-params">preference:</span><br>                <span class="hljs-params">matchExpressions:</span><br>                  <span class="hljs-operator">-</span> &#123; <span class="hljs-params">key:</span> ssd, <span class="hljs-params">operator:</span> Exists, <span class="hljs-params">values:</span> [] &#125;<br>      <span class="hljs-params">containers:</span><br>        <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> myapp<br>          <span class="hljs-params">image:</span> ikubernetes<span class="hljs-operator">/</span>myapp:v1<br></code></pre></td></tr></table></figure>

<hr>
<h4 id="9-5-Pod-亲合度实战步骤"><a href="#9-5-Pod-亲合度实战步骤" class="headerlink" title="9.5. Pod 亲合度实战步骤"></a>9.5. Pod 亲合度实战步骤</h4><h5 id="9-5-1-Pod-硬亲合度"><a href="#9-5-1-Pod-硬亲合度" class="headerlink" title="9.5.1. Pod 硬亲合度"></a>9.5.1. Pod 硬亲合度</h5><p>要求当前 Pod 必须与特定标签的 Pod “同桌用餐”，Node 上必须事先存在被依赖的 Pod。</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> v1<br><span class="hljs-params">kind:</span> Pod<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> <span class="hljs-keyword">with</span>-pod-affinity<br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">affinity:</span><br>    <span class="hljs-params">podAffinity:</span><br>      <span class="hljs-params">requiredDuringSchedulingIgnoredDuringExecution:</span><br>        <span class="hljs-operator">-</span> <span class="hljs-params">labelSelector:</span><br>            <span class="hljs-params">matchExpressions:</span><br>              <span class="hljs-operator">-</span> &#123; <span class="hljs-params">key:</span> app, <span class="hljs-params">operator:</span> In, <span class="hljs-params">values:</span> [<span class="hljs-string">&quot;tomcat&quot;</span>] &#125;<br>          <span class="hljs-params">topologyKey:</span> kubernetes.io<span class="hljs-symbol">/hostname</span><br>  <span class="hljs-params">containers:</span><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> myapp<br>      <span class="hljs-params">image:</span> ikubernetes<span class="hljs-operator">/</span>myapp:v1<br></code></pre></td></tr></table></figure>

<hr>
<h5 id="9-5-2-Pod-软亲合度"><a href="#9-5-2-Pod-软亲合度" class="headerlink" title="9.5.2. Pod 软亲合度"></a>9.5.2. Pod 软亲合度</h5><p>建议同一类应用尽量“拉近关系”，比如把缓存（cache）和数据库（db）的 Pod 放在一起，但不是强制要求。</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> apps<span class="hljs-symbol">/v1</span><br><span class="hljs-params">kind:</span> Deployment<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> myapp-<span class="hljs-keyword">with</span>-preferred-pod-affinity<br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">replicas:</span> <span class="hljs-number">3</span><br>  <span class="hljs-params">selector:</span><br>    <span class="hljs-params">matchLabels:</span><br>      <span class="hljs-params">app:</span> myapp<br>  <span class="hljs-params">template:</span><br>    <span class="hljs-params">metadata:</span><br>      <span class="hljs-params">labels:</span><br>        <span class="hljs-params">app:</span> myapp<br>    <span class="hljs-params">spec:</span><br>      <span class="hljs-params">affinity:</span><br>        <span class="hljs-params">podAffinity:</span><br>          <span class="hljs-params">preferredDuringSchedulingIgnoredDuringExecution:</span><br>            <span class="hljs-operator">-</span> <span class="hljs-params">weight:</span> <span class="hljs-number">80</span><br>              <span class="hljs-params">podAffinityTerm:</span><br>                <span class="hljs-params">labelSelector:</span><br>                  <span class="hljs-params">matchExpressions:</span><br>                    <span class="hljs-operator">-</span> &#123; <span class="hljs-params">key:</span> app, <span class="hljs-params">operator:</span> In, <span class="hljs-params">values:</span> [<span class="hljs-string">&quot;cache&quot;</span>] &#125;<br>                <span class="hljs-params">topologyKey:</span> zone<br>            <span class="hljs-operator">-</span> <span class="hljs-params">weight:</span> <span class="hljs-number">20</span><br>              <span class="hljs-params">podAffinityTerm:</span><br>                <span class="hljs-params">labelSelector:</span><br>                  <span class="hljs-params">matchExpressions:</span><br>                    <span class="hljs-operator">-</span> &#123; <span class="hljs-params">key:</span> app, <span class="hljs-params">operator:</span> In, <span class="hljs-params">values:</span> [<span class="hljs-string">&quot;db&quot;</span>] &#125;<br>                <span class="hljs-params">topologyKey:</span> zone<br>      <span class="hljs-params">containers:</span><br>        <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> myapp<br>          <span class="hljs-params">image:</span> ikubernetes<span class="hljs-operator">/</span>myapp:v1<br><br></code></pre></td></tr></table></figure>

<hr>
<h5 id="9-5-3-Pod-反硬亲合度"><a href="#9-5-3-Pod-反硬亲合度" class="headerlink" title="9.5.3. Pod 反硬亲合度"></a>9.5.3. Pod 反硬亲合度</h5><ul>
<li>用来把相同或相似的应用分开，就像避免一桌全是亲戚，避免“群体过热”。</li>
<li><strong>配置方式</strong>：将 <code>podAffinity</code> 替换为 <code>podAntiAffinity</code>，可以配置强制要求（硬反亲和）或建议性要求（软反亲和）。</li>
</ul>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">apiVersion</span><span class="hljs-punctuation">:</span> <span class="hljs-string">v1</span><br><span class="hljs-attribute">kind</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attribute">metadata</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">name</span><span class="hljs-punctuation">:</span> <span class="hljs-string">pod-first</span><br>  <span class="hljs-attribute">labels</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">app</span><span class="hljs-punctuation">:</span> <span class="hljs-string">myapp</span><br>    <span class="hljs-attribute">tier</span><span class="hljs-punctuation">:</span> <span class="hljs-string">fronted</span><br><span class="hljs-attribute">spec</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">containers</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">name: myapp</span><br>      <span class="hljs-attribute">image</span><span class="hljs-punctuation">:</span> <span class="hljs-string">ikubernetes/myapp:v1</span><br></code></pre></td></tr></table></figure>

<hr>
<h5 id="9-5-4-Pod-反软亲和度"><a href="#9-5-4-Pod-反软亲和度" class="headerlink" title="9.5.4. Pod 反软亲和度"></a>9.5.4. Pod 反软亲和度</h5><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> v1<br><span class="hljs-params">kind:</span> Pod<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> pod-second<br>  <span class="hljs-params">labels:</span><br>    <span class="hljs-params">app:</span> backend<br>    <span class="hljs-params">tier:</span> db<br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">containers:</span><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> busybox<br>      <span class="hljs-params">image:</span> busybox:latest<br>      <span class="hljs-params">imagePullPolicy:</span> IfNotPresent<br>      <span class="hljs-params">command:</span> [<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;sleep 3600&quot;</span>]<br>  <span class="hljs-params">affinity:</span><br>    <span class="hljs-params">podAntiAffinity:</span><br>      <span class="hljs-params">requiredDuringSchedulingIgnoredDuringExecution:</span><br>        <span class="hljs-operator">-</span> <span class="hljs-params">labelSelector:</span><br>            <span class="hljs-params">matchExpressions:</span><br>              <span class="hljs-operator">-</span> &#123; <span class="hljs-params">key:</span> app, <span class="hljs-params">operator:</span> In, <span class="hljs-params">values:</span> [<span class="hljs-string">&quot;myapp&quot;</span>] &#125;<br>          <span class="hljs-params">topologyKey:</span> zone<br></code></pre></td></tr></table></figure>

<hr>
<h4 id="9-6-污点和容忍性实战步骤"><a href="#9-6-污点和容忍性实战步骤" class="headerlink" title="9.6. 污点和容忍性实战步骤"></a>9.6. 污点和容忍性实战步骤</h4><p>&#x3D;&#x3D;1.为 Node 节点添加污点&#x3D;&#x3D;</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir">kubectl taint node &lt;node-name&gt; &lt;taint-key&gt;=&lt;taint-value&gt;<span class="hljs-symbol">:&lt;taint-effect&gt;</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;2.配置 Pod 的容忍性&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> v1<br><span class="hljs-params">kind:</span> Pod<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> goproxy<br>  <span class="hljs-params">labels:</span><br>    <span class="hljs-params">app:</span> goproxy<br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">containers:</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> goproxy<br>    <span class="hljs-params">image:</span> k8s.gcr.io<span class="hljs-operator">/</span>goproxy:<span class="hljs-number">0.1</span><br><br>  <span class="hljs-params">tolerations:</span><br>    <span class="hljs-operator">-</span> <span class="hljs-params">key:</span> <span class="hljs-string">&quot;taint-key&quot;</span>               <span class="hljs-comment"># Pod 容忍的 污点 key</span><br>	  <span class="hljs-params">operator:</span> <span class="hljs-string">&quot;Equal&quot;</span>              <span class="hljs-comment"># 使用等值判断，当 key、value、effect 都相同，即具有被要求的容忍度</span><br>	  <span class="hljs-params">value:</span> <span class="hljs-string">&quot;taint-value&quot;</span>           <span class="hljs-comment"># Pod 容忍的 污点 value</span><br>	  <span class="hljs-params">effect:</span> <span class="hljs-string">&quot;taint-effect&quot;</span>         <span class="hljs-comment"># Pod 容忍的 污点 effect</span><br>	  <span class="hljs-params">tolerationSeconds:</span> <span class="hljs-number">3600</span>        <span class="hljs-comment"># Pod 被驱逐的时间倒计时，这里是 3600s</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li><font color="#00b0f0">tolerationSeconds</font>：<ul>
<li>在 <code>NoExecute</code> 情况下，Pod 会在指定的时间（<code>tolerationSeconds</code>）后被驱逐，即使它已经容忍了该污点。</li>
<li>如果没有设置 <code>tolerationSeconds</code>，则 Pod 不会被驱逐，直到 Pod 不再容忍</li>
</ul>
</li>
<li><font color="#00b0f0">存在性判断</font>：<ul>
<li>在前面的示例中，我们使用了 <code>operator: &quot;Equal&quot;</code> 进行等值判断，表示 Pod 只有在 <code>key</code>、<code>value</code> 和 <code>effect</code> 都匹配时，才具备被要求的容忍度</li>
<li>也可以将 <code>operator</code> 配置为 <code>Exists</code>，这时 Pod 只需要匹配 <code>key</code> 和 <code>effect</code>，即具有被要求的容忍度</li>
</ul>
</li>
</ol>
</blockquote>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">tolerations:</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">key:</span> <span class="hljs-string">&quot;key1&quot;</span><br>    <span class="hljs-params">operator:</span> <span class="hljs-string">&quot;Exists&quot;</span><br>    <span class="hljs-params">effect:</span> <span class="hljs-string">&quot;NoExecute&quot;</span><br>    <span class="hljs-params">tolerationSeconds:</span> <span class="hljs-number">3600</span><br></code></pre></td></tr></table></figure>

<hr>
<h4 id="9-7-补充：Node-节点“自污"><a href="#9-7-补充：Node-节点“自污" class="headerlink" title="9.7. 补充：Node 节点“自污"></a>9.7. 补充：Node 节点“自污</h4><p><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AK8s/image-20250324091041496.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<h3 id="10-K8S-核心概念：K8S-网络"><a href="#10-K8S-核心概念：K8S-网络" class="headerlink" title="10. K8S 核心概念：K8S 网络"></a>10. K8S 核心概念：K8S 网络</h3><h4 id="10-1-K8S-网络-引入的原因"><a href="#10-1-K8S-网络-引入的原因" class="headerlink" title="10.1. K8S 网络 引入的原因"></a>10.1. K8S 网络 引入的原因</h4><p>K8S 网络的核心作用，就是实现 <strong>容器间的通信</strong>，和 <strong>外部访问容器中的服务</strong>。</p>
<hr>
<h4 id="10-2-K8S-网络-的组成"><a href="#10-2-K8S-网络-的组成" class="headerlink" title="10.2. K8S 网络 的组成"></a>10.2. K8S 网络 的组成</h4><p>K8S 网络主要由以下几部分组成：</p>
<ol>
<li>&#x3D;&#x3D;hostNetWork&#x3D;&#x3D;：<ol>
<li>决定 Pod 是使用 Kubernetes 默认的网络隔离模式，还是直接复用主机的网络。虽然使用主机网络（<code>hostNetwork: true</code>）可以减少网络转发的开销，从而提升访问速度，但通常我们会保持默认设置（<code>false</code>），以保证良好的网络隔离性和应用的可移植性。</li>
<li><font color="#00b0f0">true</font>：<ol>
<li>容器将直接使用主机的网络资源，包括主机的 IP 和端口。</li>
<li>这种方式能提升网络性能，适用于高并发的场景（比如数据库），但通常我们会避免使用，特别是在像 Spring Boot 或 Spring Cloud 这样的应用中。默认情况下我们更倾向于保持网络隔离性和可移植性。</li>
</ol>
</li>
<li><font color="#00b0f0">false（默认）</font>：<ol>
<li>使用 Kubernetes 提供的默认网络隔离，容器有独立的网络环境，无法直接访问主机的网络。</li>
<li>大多数情况下，我们会选择这个选项，以确保容器和主机网络的隔离。</li>
</ol>
</li>
</ol>
</li>
<li>&#x3D;&#x3D;ContainerPort、hostPort 和 protocol&#x3D;&#x3D;：<ol>
<li>通过配置容器应用监听的端口（<code>containerPort</code>）以及将其映射到 Pod 所在宿主机端口（<code>hostPort</code>），<strong>可以实现外部通过 <code>http://&lt;host-ip&gt;:&lt;host-port&gt;</code> 的形式访问容器内的应用</strong>。</li>
<li>这两类端口既可以在 Pod 配置中直接声明，也可以通过 Service 的 <code>port</code> 和 <code>targetPort</code> 实现统一的端口管理。但为了提升可维护性和可扩展性，<strong>强烈建议通过 Service 来统一管理容器端口及其映射关系</strong>，而不是直接在 Pod 中显式绑定 <code>hostPort</code>。</li>
<li><font color="#00b0f0">ContainerPort</font>：<ol>
<li>容器内应用监听的端口</li>
</ol>
</li>
<li><font color="#00b0f0">hostPort</font>：<ol>
<li>容器所在宿主机端口与容器监听的端口映射</li>
</ol>
</li>
<li><font color="#00b0f0">protocol</font>：<ol>
<li>指定端口的协议类型，通常是 <code>TCP</code> 或 <code>UDP</code>。</li>
<li><font color="#7030a0">TCP（默认）</font>：<ol>
<li>一般我们都用这个，是传输控制协议，面向连接，可靠的通信。</li>
</ol>
</li>
<li><font color="#7030a0">UDP</font>：<ol>
<li>用户数据报协议，无连接，适用于不需要可靠性保障的应用（例如视频流、游戏等）。</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>&#x3D;&#x3D;Service&#x3D;&#x3D;：<ol>
<li>使用 <code>http://&lt;host-ip&gt;:&lt;host-port&gt;</code> 访问 Pod 存在一些问题：<ol>
<li>只能访问某个固定的 Pod，其他 Pod 如何处理？</li>
<li>如果 Pod 迁移，你需要重新查找该 Pod 的 <code>hostIP</code>，这非常麻烦。</li>
</ol>
</li>
<li>而 <code>Service</code> 功能强大，它内置了负载均衡机制，能够将请求均匀分配到所有可用的 Pod，从而解决了只能访问单个 Pod 的问题，更高效地利用集群中的所有 Pod 资源。</li>
<li>此外，<code>Service</code> 提供多种类型，能够满足不同的需求。它既有类型支持集群内部服务间的调用，也有类型为外部访问提供稳定的 IP 地址，从而确保外部能够稳定访问 Pod<ol>
<li><font color="#00b0f0">内部访问</font>：<ol>
<li><font color="#7030a0">访问 Service IP + Service Port</font>：<code>http://&lt;service-ip&gt;:&lt;service-port&gt;</code></li>
<li><font color="#7030a0">访问 Service 内部域名</font>：<code>http://&lt;service-name.&lt;Service-namesapce&gt;.svc.cluster.local&gt;</code></li>
</ol>
</li>
<li><font color="#00b0f0">外部访问</font>：<ol>
<li>访问 VIP + Service Port：<code>http://&lt;VIP&gt;:&lt;service-port&gt;</code></li>
</ol>
</li>
</ol>
</li>
<li>需要注意的是，<code>Service IP</code> 不是某个具体主机的物理 IP，而是由 Kubernetes 提供的虚拟 IP（☆☆☆）</li>
</ol>
</li>
<li>&#x3D;&#x3D;Ingress&#x3D;&#x3D;：<ol>
<li>尽管 <code>Service Port</code> 功能强大，但外部访问时必须携带 <code>Service Port</code>。然而，我们通常通过 <code>www.example.com/search</code>、<code>www.example.com/main</code> 等 URL 直接访问，而不是像 <code>www.example.com/search:7090</code> 这样输入端口号，这该如何实现呢？</li>
<li>因此，<code>Ingress Controller</code> 可以作为外部流量的统一入口，可以根据 <code>Ingress</code> 资源中域名转发配置，将流量路由到对应的 Service，再由 Service 定位到具体的 Pod。这就避免了手动输入端口号的麻烦，因此相当于 Kubernetes 内部的反向代理或 API 网关。</li>
</ol>
</li>
<li>&#x3D;&#x3D;当前主流&#x3D;&#x3D;：<ol>
<li>将 <code>hostNetwork</code> 设置为 <code>false</code>，<strong>保持默认的网络隔离</strong>，同时通过 Service <strong>统一管理容器端口及其映射关系</strong>。</li>
<li>通过 <code>Ingress Controller LoadBalancer Service</code> 接收外部请求，并将请求负载均衡到 <code>Ingress Controller Pod</code>。然后，按照 <code>Ingress</code> 配置的域名转发规则，将请求转发到相应的 <code>Pod Service</code>，接着将请求负载均衡到具体的 <code>Pod</code>，由 <code>Pod</code> 中的服务进行业务处理。</li>
</ol>
</li>
</ol>
<hr>
<h4 id="10-3-hostNetWork-实战步骤"><a href="#10-3-hostNetWork-实战步骤" class="headerlink" title="10.3. hostNetWork 实战步骤"></a>10.3. hostNetWork 实战步骤</h4><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> v1<br><br><span class="hljs-params">kind:</span> Pod<br><br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> my-pod<br>  <span class="hljs-params">namespace:</span> default<br>  <br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">hostNetwork:</span> <span class="hljs-literal">false</span>                              <span class="hljs-comment"># 是否使用宿主机网络，默认 false，一般也使用 false</span><br>  <span class="hljs-params">containers:</span><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> my-container<br>      <span class="hljs-params">image:</span> nginx:latest<br></code></pre></td></tr></table></figure>

<hr>
<h4 id="10-4-ContainerPort、hostPort-和-protocol-实战步骤"><a href="#10-4-ContainerPort、hostPort-和-protocol-实战步骤" class="headerlink" title="10.4. ContainerPort、hostPort 和 protocol 实战步骤"></a>10.4. ContainerPort、hostPort 和 protocol 实战步骤</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-pod</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">xxxxxx</span><br>  <br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">my-container</span><br>      <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:latest</span><br>      <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span>                          <span class="hljs-comment"># 容器内应用监听的端口</span><br>          <span class="hljs-attr">hostPort:</span> <span class="hljs-number">8080</span>                             <span class="hljs-comment"># 容器所在宿主机端口与容器监听的端口映射</span><br>          <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>                              <span class="hljs-comment"># 端口的协议类型，为 TCP 或 UDP</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>这里选择在 Pod 中进行配置仅作为示例，生产环境中强烈不推荐如此配置。</li>
<li>推荐在 Service 中进行统一配置，以确保更好的管理和维护。</li>
</ol>
</blockquote>
<hr>
<h4 id="10-5-Service-实战步骤"><a href="#10-5-Service-实战步骤" class="headerlink" title="10.5. Service 实战步骤"></a>10.5. Service 实战步骤</h4><h5 id="10-5-1-Service-的分类"><a href="#10-5-1-Service-的分类" class="headerlink" title="10.5.1. Service 的分类"></a>10.5.1. Service 的分类</h5><p><code>Service</code> 由以下四种类型组成：</p>
<ol>
<li>&#x3D;&#x3D;ClusterIP 类型（默认）&#x3D;&#x3D;：<ol>
<li>该类型的 Service 仅在集群内部暴露服务，即内部 Pod 可以互相访问调用，而外部客户端无法直接访问</li>
<li><font color="#00b0f0">内部访问</font>：<ol>
<li><font color="#7030a0">访问 Service IP + Service Port</font>：<code>http://&lt;service-ip&gt;:&lt;service-port&gt;</code></li>
<li><font color="#7030a0">访问 Service 内部域名</font>：<code>http://&lt;service-name&gt;.&lt;service-namespace&gt;.svc.cluster.local</code></li>
</ol>
</li>
<li><font color="#00b0f0">注意事项</font>：<ol>
<li>由于 Service IP 是固定的，所以为访问 Pod 提供了稳定的入口</li>
<li>内部访问时，Service 会采用轮询（Round Robin）的方式，将请求均匀分发到所有功能相同的 Pod。</li>
</ol>
</li>
</ol>
</li>
<li>&#x3D;&#x3D;NodePort 类型&#x3D;&#x3D;：<ol>
<li><code>NodePort</code> 类型的 Service 不仅可以在集群内部暴露服务，还允许集群外部的客户端访问。然而，由于外部访问的 IP 地址不稳定，通常不推荐使用这种类型。</li>
<li><font color="#00b0f0">内部访问</font>：<ol>
<li><font color="#7030a0">访问 Service IP + Service Port</font>：<code>http://10.96.12.34:80</code></li>
<li><font color="#7030a0">访问 Service 内部域名</font>：<code>http://&lt;service-name&gt;.&lt;service-namespace&gt;.svc.cluster.local</code></li>
<li><font color="#7030a0">注意事项</font>：<ol>
<li>由于 Service 的 IP 是固定的，所以为访问 Pod 提供了稳定的入口</li>
<li>同样，内部访问时 Service 会自动采用轮询（Round Robin）的方式，将请求均匀分发到所有对应的 Pod。</li>
</ol>
</li>
</ol>
</li>
<li><font color="#00b0f0">外部访问</font>：<ol>
<li><font color="#7030a0">访问 Node IP + Node Port</font>：<code>http://192.168.100.210:32600</code></li>
<li>在每台运行 Pod 的宿主机上，Kubernetes 会分配一个介于 <code>30000~32767</code> 之间的 NodePort，外部客户端通过 <code>NodeIP + NodePort</code> 访问服务时，<font color="#ff0000">请求会经过 <code>NodeIP:NodePort -&gt; ServiceIP:ServicePort -&gt; Pod:PodPort</code></font></li>
<li><font color="#7030a0">注意事项</font>：<ol>
<li><font color="#c00000">由于 Pod 所在 Node 的 IP 可能变化，因此直接依赖 Node IP 无法提供完全稳定的访问入口（☆☆☆）</font></li>
<li>尽管外部访问看似连接到固定的 Pod，Service 依旧会以轮询（Round Robin）的方式分发请求到所有具备相同功能的 Pod，而非固定转发到某个特定 Node</li>
<li>如果一台服务器上运行多个 Pod，则可能会分配多个不同的 NodePort，只要不发生 <code>Service Port</code> 和 <code>NodePort</code> 端口冲突即可。</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>&#x3D;&#x3D;LoadBalancer 类型&#x3D;&#x3D;：<ol>
<li><code>LoadBalancer</code> 类型的 Service，其特点在于，一旦创建该类型的 Service，系统（MetalLB 或 云服务）会自动为其分配一个固定的 VIP</li>
<li>该类型主要用于云环境（如阿里云、AWS、Google Cloud 等），在内网或裸机部署的 Kubernetes 集群中，可以借助 MetalLB 来模拟云环境下的负载均衡器。</li>
<li><font color="#00b0f0">内部访问</font>：<ol>
<li><font color="#7030a0">访问 Service IP + Service Port</font>：<code>http://10.96.12.34:80</code></li>
<li><font color="#7030a0">访问 Service 内部域名</font>：<code>http://&lt;service-name&gt;.&lt;service-namespace&gt;.svc.cluster.local</code></li>
</ol>
</li>
<li><font color="#00b0f0">外部访问</font>：<ol>
<li><font color="#7030a0">访问 VIP + Service Port</font>：<code>http://192.168.136.210:80</code></li>
</ol>
</li>
</ol>
</li>
<li>&#x3D;&#x3D;ExternalName 类型&#x3D;&#x3D;<ol>
<li>该类型的 <code>Service</code> 相对特殊，主要用于访问 集群外部 的服务，而 不是 让外部访问集群内部的服务。</li>
<li>当前阶段可暂不深入学习，日后有时间再了解。</li>
</ol>
</li>
<li>&#x3D;&#x3D;当前主流&#x3D;&#x3D;：<ol>
<li>对于集群内部通信（即 Pod 之间的访问），选择 <code>ClusterIP</code>。</li>
<li>若需将服务暴露给外部访问，或者在云平台上运行，选择 <code>LoadBalancer</code>。</li>
<li>若集群内部需要访问外部服务，则选择 <code>ExternalName</code>。</li>
</ol>
</li>
</ol>
<hr>
<h5 id="10-5-2-ClusterIP-Service-实战步骤"><a href="#10-5-2-ClusterIP-Service-实战步骤" class="headerlink" title="10.5.2. ClusterIP Service 实战步骤"></a>10.5.2. ClusterIP Service 实战步骤</h5><p>&#x3D;&#x3D;1.编写 ClusterIP Service 资源 yaml 文件&#x3D;&#x3D;</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-clusterip-service</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span>                                  <span class="hljs-comment"># 指定 Service 类型为 ClusterIP</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">my-app</span>                                    <span class="hljs-comment"># 选择标签为 app=my-app 的 Pod</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">80</span>                                     <span class="hljs-comment"># Service 暴露的端口（Serivce Port）</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span>                             <span class="hljs-comment"># 容器内应用监听的端口</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;2.创建 CluserIP Service 资源&#x3D;&#x3D;</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">kubectl apply -f <span class="hljs-keyword">my</span>-clusterip-service.yaml<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;3.检查 ClusterIP Service 资源状态&#x3D;&#x3D;</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 检查状态的同时，也可获取 Service IP</span><br>kubectl <span class="hljs-built_in">get</span><span class="hljs-built_in"> service </span>&lt;service-name&gt; -n &lt;service-namespace&gt;<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;4.内部访问 Pod&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-comment"># 1. 查询 Service IP 和 Service Port</span><br>kubectl get service <span class="hljs-symbol">&lt;service-name&gt;</span> <span class="hljs-operator">-</span>n <span class="hljs-symbol">&lt;namespace&gt;</span><br><br><br><span class="hljs-comment"># 2. 随便找到运行中的 Pod</span><br>kubectl get pod <span class="hljs-operator">-</span>n <span class="hljs-symbol">&lt;namespace&gt;</span><br><br><br><span class="hljs-comment"># 3. 进入到该 Pod 中</span><br>kubectl exec <span class="hljs-operator">-</span>it <span class="hljs-symbol">&lt;Pod-name&gt;</span> <span class="hljs-operator">-</span>- <span class="hljs-symbol">/bin/bash</span><br><br><br><span class="hljs-comment"># 4. 内部访问 Pod</span><br>curl http:<span class="hljs-operator">//</span><span class="hljs-symbol">&lt;service-name&gt;</span>.<span class="hljs-symbol">&lt;service-namespace&gt;</span>.svc.cluster.local<br>curl http:<span class="hljs-operator">//</span><span class="hljs-symbol">&lt;service-ip&gt;</span>:<span class="hljs-symbol">&lt;service-port&gt;</span><br></code></pre></td></tr></table></figure>

<hr>
<h5 id="10-5-3-NodePort-Service-实战步骤"><a href="#10-5-3-NodePort-Service-实战步骤" class="headerlink" title="10.5.3. NodePort Service 实战步骤"></a>10.5.3. NodePort Service 实战步骤</h5><p>&#x3D;&#x3D;1.编写 NodePort Service 资源 yaml 文件&#x3D;&#x3D;</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-nodeport-service</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span>                                             <span class="hljs-comment"># 通过宿主机的 NodePort 访问</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">my-app</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">80</span>                                               <span class="hljs-comment"># Service 暴露的端口</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span>                                       <span class="hljs-comment"># 容器内应用监听的端口</span><br>      <span class="hljs-attr">nodePort:</span> <span class="hljs-number">30080</span>                                        <span class="hljs-comment"># Pod 所在 Node 上暴露的端口(NodePort)</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;2.创建 NodePort Service 资源&#x3D;&#x3D;</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">kubectl <span class="hljs-built_in">apply</span> -f your-service.yaml<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;3.检查 NodePort Service 资源状态&#x3D;&#x3D;</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 检查状态的同时，也可获取 Service IP</span><br>kubectl <span class="hljs-built_in">get</span><span class="hljs-built_in"> service </span>&lt;service-name&gt; -n &lt;service-namespace&gt;<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;4.内部访问 Pod&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-comment"># 1. 查询 Service IP 和 Service Port</span><br>kubectl get service <span class="hljs-symbol">&lt;service-name&gt;</span> <span class="hljs-operator">-</span>n <span class="hljs-symbol">&lt;namespace&gt;</span><br><br><br><span class="hljs-comment"># 2. 随便找到运行中的 Pod</span><br>kubectl get pod <span class="hljs-operator">-</span>n <span class="hljs-symbol">&lt;namespace&gt;</span><br><br><br><span class="hljs-comment"># 3. 进入到该 Pod 中</span><br>kubectl exec <span class="hljs-operator">-</span>it <span class="hljs-symbol">&lt;Pod-name&gt;</span> <span class="hljs-operator">-</span>- <span class="hljs-symbol">/bin/bash</span><br><br><br><span class="hljs-comment"># 4. 内部访问 Pod</span><br>curl http:<span class="hljs-operator">//</span><span class="hljs-symbol">&lt;service-name&gt;</span>.<span class="hljs-symbol">&lt;service-namespace&gt;</span>.svc.cluster.local<br>curl http:<span class="hljs-operator">//</span><span class="hljs-symbol">&lt;service-ip&gt;</span>:<span class="hljs-symbol">&lt;service-port&gt;</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;5.外部访问 Pod&#x3D;&#x3D;</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir">curl <span class="hljs-symbol">http:</span>//&lt;node-ip&gt;<span class="hljs-symbol">:&lt;node-port&gt;</span><br></code></pre></td></tr></table></figure>

<hr>
<h5 id="10-5-4-LoadBalancer-Service（MetalLB）实战步骤"><a href="#10-5-4-LoadBalancer-Service（MetalLB）实战步骤" class="headerlink" title="10.5.4. LoadBalancer Service（MetalLB）实战步骤"></a>10.5.4. LoadBalancer Service（MetalLB）实战步骤</h5><h6 id="10-5-4-1-安装-MetalLB"><a href="#10-5-4-1-安装-MetalLB" class="headerlink" title="10.5.4.1. 安装 MetalLB"></a>10.5.4.1. 安装 MetalLB</h6><p>&#x3D;&#x3D;1.开启 ARP 模式&#x3D;&#x3D;<br>仅需在当前 Master 节点启用 ARP 模式即可</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-comment"># 1. 编辑 kube-proxy 配置文件</span><br>kubectl edit configmap -n kube-<span class="hljs-keyword">system</span> kube-proxy<br><br><br><span class="hljs-comment"># 2. 修改 ipvs.strictARP 为 true</span><br>strictARP: <span class="hljs-literal">false</span>  -&gt; strictARP: <span class="hljs-literal">true</span><br><br><br><span class="hljs-comment"># 3. 重启 Kube-proxy pod</span><br>kubectl rollout restart daemonset -n kube-<span class="hljs-keyword">system</span> kube-proxy<br></code></pre></td></tr></table></figure>
<p><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AK8s/image-20250404155459306.png" srcset="/img/loading.gif" lazyload></p>
<p>&#x3D;&#x3D;2.安装 MetalLB&#x3D;&#x3D;</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 1. 查询 K8S 版本</span><br>kubectl version<br><br><br><span class="hljs-comment"># 2. 安装适配 K8S 版本的 MetalLB（这里适配 1.28.2 版本的 K8S）</span><br>kubectl apply -f https:<span class="hljs-regexp">//</span>raw.githubusercontent.com<span class="hljs-regexp">/metallb/m</span>etallb<span class="hljs-regexp">/v0.14.9/</span>config<span class="hljs-regexp">/manifests/m</span>etallb-native.yaml<br><br><br><span class="hljs-comment"># 3. 补充：删除 MetalLB</span><br>kubectl <span class="hljs-keyword">delete</span> -f https:<span class="hljs-regexp">//</span>raw.githubusercontent.com<span class="hljs-regexp">/metallb/m</span>etallb<span class="hljs-regexp">/v0.14.9/</span>config<span class="hljs-regexp">/manifests/m</span>etallb-native.yaml<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项：资源清单中的主要内容</p>
<ol>
<li>资源清单中的内容主要包括：<ul>
<li><font color="#00b0f0">创建命名空间</font>：<ul>
<li>创建 <code>metallb-system</code> 命名空间，隔离 MetalLB 资源。</li>
</ul>
</li>
<li><font color="#00b0f0">定义 CRD（自定义资源）</font><ul>
<li><code>IPAddressPool</code>：IP 地址池。</li>
<li><code>L2Advertisement</code>：Layer2 广播配置。</li>
<li><code>BGPAdvertisement</code>：BGP 广播配置（BGP 模式下）。</li>
</ul>
</li>
<li><font color="#00b0f0">创建 RBAC 权限</font><ul>
<li>使用 <code>ServiceAccount</code>、<code>ClusterRole</code> 和 <code>ClusterRoleBinding</code>，保证 MetalLB 能访问集群资源。</li>
</ul>
</li>
<li><font color="#00b0f0">部署核心组件</font><ul>
<li><code>Controller</code>（Deployment）：负责将 MetalLB 配置资源（如 IP 池）同步到 Kubernetes。</li>
<li><code>Speaker</code>（DaemonSet）：负责监听 Service 变化并向外部广播 IP 地址。</li>
</ul>
</li>
<li><font color="#00b0f0">创建 Service</font><ul>
<li>用于暴露 webhook 服务。</li>
</ul>
</li>
</ul>
</li>
<li>资源清单的示例：<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/metallb/metallb/v0.14.3/config/manifests/metallb-native.yaml">MetalLB 资源清单示例</a></li>
</ol>
</blockquote>
<p>&#x3D;&#x3D;3.查看 MetalLB 状态&#x3D;&#x3D;</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">kubectl <span class="hljs-keyword">get</span> <span class="hljs-keyword">all</span> <span class="hljs-operator">-</span>n metallb<span class="hljs-operator">-</span><span class="hljs-keyword">system</span><br></code></pre></td></tr></table></figure>

<hr>
<h6 id="10-5-4-2-配置-IP-地址池"><a href="#10-5-4-2-配置-IP-地址池" class="headerlink" title="10.5.4.2. 配置 IP 地址池"></a>10.5.4.2. 配置 IP 地址池</h6><p>&#x3D;&#x3D;1.编写 IPAddressPool 资源 yaml 文件&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> metallb.io<span class="hljs-symbol">/v1beta1</span><br><span class="hljs-params">kind:</span> IPAddressPool<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> public-ips <br>  <span class="hljs-params">namespace:</span> metallb-system                      <span class="hljs-comment"># 命名空间，要为 metallb-system</span><br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">addresses:</span><br>  <span class="hljs-operator">-</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">136.20</span>0-<span class="hljs-number">192.168</span>.<span class="hljs-number">136.250</span>              <span class="hljs-comment"># 分配的 IP 范围</span><br>  <span class="hljs-params">autoAssign:</span> <span class="hljs-literal">true</span>                               <span class="hljs-comment"># 自动分配 IP</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项：IP 范围</p>
<ol>
<li>这里配置的 IP 范围用于自动为 LoadBalancer 类型 Service 分配 VIP。也就是说，创建该类型的 Service 后，MetalLB 会从此范围内自动挑选一个 IP 地址作为其 VIP</li>
</ol>
</blockquote>
<p>&#x3D;&#x3D;2.创建 IPAddressPool 资源&#x3D;&#x3D;</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">kubectl</span> apply -f <span class="hljs-built_in">ip</span>-pool.yaml<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;3.检查 IPAddressPool 资源状态&#x3D;&#x3D;</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">kubectl <span class="hljs-built_in">get</span> ipaddresspool -n metallb-<span class="hljs-keyword">system</span><br></code></pre></td></tr></table></figure>

<hr>
<h6 id="10-5-4-3-配置-L2-广播"><a href="#10-5-4-3-配置-L2-广播" class="headerlink" title="10.5.4.3. 配置 L2 广播"></a>10.5.4.3. 配置 L2 广播</h6><p>&#x3D;&#x3D;1.编写 L2Advertisement 资源 yaml 文件&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> metallb.io<span class="hljs-symbol">/v1beta1</span><br><span class="hljs-params">kind:</span> L2Advertisement<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> l2-advert<br>  <span class="hljs-params">namespace:</span> metallb-system         <span class="hljs-comment"># 命名空间，要为 metallb-system</span><br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">ipAddressPools:</span>                   <span class="hljs-comment"># 使用的 IP 地址池</span><br>  <span class="hljs-operator">-</span> public-ips                      <span class="hljs-comment"># IP 池的名称</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>简单来说，只有在配置了 L2 广播的情况下，Service 才会自动分配地址，否则不会分配。</li>
</ol>
</blockquote>
<p>&#x3D;&#x3D;2.创建 L2Advertisement 资源&#x3D;&#x3D;</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">kubectl <span class="hljs-built_in">apply</span> -f l2-advert.yaml<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;3.检查 L2Advertisement 资源状态&#x3D;&#x3D;</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">kubectl <span class="hljs-built_in">get</span> l2advertisement -n metallb-<span class="hljs-keyword">system</span><br></code></pre></td></tr></table></figure>

<hr>
<h6 id="10-5-4-4-创建-LoadBalancer-Service-资源"><a href="#10-5-4-4-创建-LoadBalancer-Service-资源" class="headerlink" title="10.5.4.4. 创建 LoadBalancer Service 资源"></a>10.5.4.4. 创建 LoadBalancer Service 资源</h6><p>&#x3D;&#x3D;1.编写 LoadBalancer Service 资源 yaml 文件&#x3D;&#x3D;</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-web</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">my-web-app</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">LoadBalancer</span>                  <span class="hljs-comment"># 使用负载均衡器类型</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;2.创建 LoadBalancer Service 资源&#x3D;&#x3D;</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">kubectl apply -f <span class="hljs-keyword">my</span>-loadbalancer-service.yaml<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;3.检查 LoadBalancer Service 资源状态&#x3D;&#x3D;</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">kubectl <span class="hljs-keyword">get</span> svc <span class="hljs-keyword">my</span>-web -o wide<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;4.内部访问 Pod&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-comment"># 1. 查询 Service IP 和 Service Port</span><br>kubectl get service <span class="hljs-symbol">&lt;service-name&gt;</span> <span class="hljs-operator">-</span>n <span class="hljs-symbol">&lt;namespace&gt;</span><br><br><br><span class="hljs-comment"># 2. 随便找到运行中的 Pod</span><br>kubectl get pod <span class="hljs-operator">-</span>n <span class="hljs-symbol">&lt;namespace&gt;</span><br><br><br><span class="hljs-comment"># 3. 进入到该 Pod 中</span><br>kubectl exec <span class="hljs-operator">-</span>it <span class="hljs-symbol">&lt;Pod-name&gt;</span> <span class="hljs-operator">-</span>- <span class="hljs-symbol">/bin/bash</span><br><br><br><span class="hljs-comment"># 4. 内部访问 Pod</span><br>curl http:<span class="hljs-operator">//</span><span class="hljs-symbol">&lt;service-name&gt;</span>.<span class="hljs-symbol">&lt;service-namespace&gt;</span>.svc.cluster.local<br>curl http:<span class="hljs-operator">//</span><span class="hljs-symbol">&lt;service-ip&gt;</span>:<span class="hljs-symbol">&lt;service-port&gt;</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;5.外部访问 Pod&#x3D;&#x3D;</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir">curl <span class="hljs-symbol">http:</span>//&lt;<span class="hljs-title class_">VIP</span>&gt;<span class="hljs-symbol">:&lt;service-port&gt;</span><br></code></pre></td></tr></table></figure>

<hr>
<h5 id="10-5-5-补充：查看-Service-IP"><a href="#10-5-5-补充：查看-Service-IP" class="headerlink" title="10.5.5. 补充：查看 Service IP"></a>10.5.5. 补充：查看 Service IP</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl <span class="hljs-built_in">get</span><span class="hljs-built_in"> service </span>&lt;service-name&gt; -n namespace<br></code></pre></td></tr></table></figure>
<p><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AK8s/image-20250404145519072.png" srcset="/img/loading.gif" lazyload></p>
<ol>
<li>&#x3D;&#x3D;Cluster-IP&#x3D;&#x3D;：<ol>
<li>可以理解为 <code>Service IP</code>，它不是某个具体主机的物理 IP，而是由 Kubernetes 提供的虚拟 IP。</li>
</ol>
</li>
<li>&#x3D;&#x3D;EXTERNAL-IP&#x3D;&#x3D;：<ol>
<li>可以理解为 VIP，由 MetalLB 或云服务商为 <code>LoadBalancer</code> 类型的 Service 自动分配。</li>
</ol>
</li>
<li>&#x3D;&#x3D;PORT(S)&#x3D;&#x3D;：<ol>
<li>可以理解为 <code>Service Port</code>，是 <code>Service</code> 暴露出的端口</li>
</ol>
</li>
<li>&#x3D;&#x3D;SELECTOR&#x3D;&#x3D;：<ol>
<li>Service 将请求负载均衡到匹配的 Pod。</li>
</ol>
</li>
</ol>
<hr>
<h4 id="10-6-Ingress-实战步骤"><a href="#10-6-Ingress-实战步骤" class="headerlink" title="10.6. Ingress 实战步骤"></a>10.6. Ingress 实战步骤</h4><h5 id="10-6-1-Ingress-的类型"><a href="#10-6-1-Ingress-的类型" class="headerlink" title="10.6.1. Ingress 的类型"></a>10.6.1. Ingress 的类型</h5><p><code>Ingress</code> 是用于<strong>定义域名路由规则</strong>的资源，但它本身不具备流量转发能力。要让流量真正转发到对应的服务，<strong>还需要部署</strong> <code>Ingress Controller Pod</code> 来执行实际的流量转发。常见的 Ingress Controller 有：</p>
<ol>
<li>&#x3D;&#x3D;NGINX Ingress Controller&#x3D;&#x3D;</li>
<li>&#x3D;&#x3D;Traefik&#x3D;&#x3D;</li>
<li>&#x3D;&#x3D;HAProxy&#x3D;&#x3D;</li>
<li>&#x3D;&#x3D;Istio Gateway&#x3D;&#x3D;</li>
</ol>
<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>这些 Controller 本质上都是运行在集群中的 Pod，它们会自动监听集群内的 <code>Ingress</code> 资源，并根据配置规则执行流量转发</li>
<li>要先部署 <code>Ingress Controller</code> 再创建 <code>Ingress</code> 资源（☆☆☆）</li>
</ol>
</blockquote>
<hr>
<h5 id="10-6-2-NGINX-Ingress-Controller-实战步骤"><a href="#10-6-2-NGINX-Ingress-Controller-实战步骤" class="headerlink" title="10.6.2. NGINX Ingress Controller 实战步骤"></a>10.6.2. NGINX Ingress Controller 实战步骤</h5><h6 id="10-6-2-1-安装metalab"><a href="#10-6-2-1-安装metalab" class="headerlink" title="10.6.2.1. 安装metalab"></a>10.6.2.1. 安装metalab</h6><p>见上文：K8S 核心概念：K8S 网络 &#x2F; Service 实战步骤 &#x2F; LoadBalancer Service（MetalLB）实战步骤</p>
<hr>
<h6 id="10-6-2-2-安装-Nginx-Ingress-Controller"><a href="#10-6-2-2-安装-Nginx-Ingress-Controller" class="headerlink" title="10.6.2.2. 安装 Nginx Ingress Controller"></a>10.6.2.2. 安装 Nginx Ingress Controller</h6><p>&#x3D;&#x3D;1.安装 Nginx Ingress Controller&#x3D;&#x3D;</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 1. 查询 K8S 版本</span><br>kubectl version<br><br><br><span class="hljs-comment"># 2. 安装适配 K8s 版本的 Nginx Ingress Controller（这里适配 1.28.2 版本的 K8S）</span><br>kubectl apply -f https:<span class="hljs-regexp">//</span>raw.githubusercontent.com<span class="hljs-regexp">/kubernetes/i</span>ngress-nginx<span class="hljs-regexp">/controller-v1.8.4/</span>deploy<span class="hljs-regexp">/static/</span>provider<span class="hljs-regexp">/cloud/</span>deploy.yaml<br><br><br><span class="hljs-comment"># 3. 补充：删除 Nginx Ingress Controller</span><br>kubectl <span class="hljs-keyword">delete</span> -f https:<span class="hljs-regexp">//</span>raw.githubusercontent.com<span class="hljs-regexp">/kubernetes/i</span>ngress-nginx<span class="hljs-regexp">/controller-v1.8.4/</span>deploy<span class="hljs-regexp">/static/</span>provider<span class="hljs-regexp">/cloud/</span>deploy.yaml<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>部署时需根据 K8S 版本选择与之匹配的 NGINX Ingress Controller 资源清单，确保兼容性（☆☆☆）</li>
<li>资源清单中的内容主要包括：<ul>
<li><font color="#00b0f0">创建命名空间</font>：<ul>
<li>在集群中创建 <code>ingress-nginx</code> 命名空间，隔离 NGINX Ingress 资源</li>
</ul>
</li>
<li><font color="#00b0f0">创建 RBAC 权限</font>：<ul>
<li>使用 <code>ServiceAccount</code>、<code>ClusterRole</code> 和 <code>ClusterRoleBinding</code>，确保 NGINX Ingress 能访问集群资源</li>
</ul>
</li>
<li><font color="#00b0f0">部署核心组件</font>：<ul>
<li><code>Controller</code>（Deployment）：负责监听 Ingress 资源，将外部请求根据域名规则转发至对应的应用 Service。</li>
</ul>
</li>
<li><font color="#00b0f0">创建 Service</font>：<ul>
<li>用于管理 NGINX Ingress Pod 并对外暴露流量入口。</li>
</ul>
</li>
</ul>
</li>
<li>资源清单示例：<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/baremetal/deploy.yaml">Nginx Ingress Controller 资源清单示例</a></li>
<li>版本资源对照列表：<a target="_blank" rel="noopener" href="https://gitcode.com/gh_mirrors/in/ingress-nginx?utm_source=csdn_github_accelerator">版本资源对照列表</a></li>
</ol>
</blockquote>
<p>&#x3D;&#x3D;2.检查 Nginx Ingress Controller 状态&#x3D;&#x3D;</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">kubectl <span class="hljs-keyword">get</span> <span class="hljs-keyword">all</span> -n ingress-nginx<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="10-6-2-3-Ingress-域名路由配置"><a href="#10-6-2-3-Ingress-域名路由配置" class="headerlink" title="10.6.2.3. Ingress 域名路由配置"></a>10.6.2.3. Ingress 域名路由配置</h6><p>&#x3D;&#x3D;1.编写 Ingress 资源 yaml 文件&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> networking.k8s.io<span class="hljs-symbol">/v1</span><br><span class="hljs-params">kind:</span> Ingress<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> demo-ingress                          <span class="hljs-comment"># Ingress 的名称</span><br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">ingressClassName:</span> nginx                     <span class="hljs-comment"># 使用的 Ingress Controller 这里是 Nginx Ingress</span><br>  <br>  <span class="hljs-params">rules:</span>                                      <span class="hljs-comment"># 定义具体的流量路由规则</span><br>    <span class="hljs-operator">-</span> <span class="hljs-params">host:</span> demo.example.com                  <span class="hljs-comment"># 域名</span><br>      <span class="hljs-params">http:</span><br>        <span class="hljs-params">paths:</span><br>          <span class="hljs-operator">-</span> <span class="hljs-params">path:</span> <span class="hljs-symbol">/</span>                           <span class="hljs-comment"># HTTP 路由 1</span><br>            <span class="hljs-params">pathType:</span> Prefix<br>            <span class="hljs-params">backend:</span><br>              <span class="hljs-params">service:</span><br>                <span class="hljs-params">name:</span> demo-app-http-<span class="hljs-number">1</span>         <span class="hljs-comment"># 分发的 Service</span><br>                <span class="hljs-params">namespace:</span> namespace-<span class="hljs-number">1</span>        <span class="hljs-comment"># 显式指定命名空间</span><br>                <span class="hljs-params">port:</span><br>                  <span class="hljs-params">number:</span> <span class="hljs-number">80</span>                  <span class="hljs-comment"># Service 的端口</span><br>          <span class="hljs-operator">-</span> <span class="hljs-params">path:</span> <span class="hljs-symbol">/path2</span>                      <span class="hljs-comment"># HTTP 路由 2</span><br>            <span class="hljs-params">pathType:</span> Prefix<br>            <span class="hljs-params">backend:</span><br>              <span class="hljs-params">service:</span><br>                <span class="hljs-params">name:</span> demo-app-http-<span class="hljs-number">2</span><br>                <span class="hljs-params">namespace:</span> namespace-<span class="hljs-number">2</span>        <span class="hljs-comment"># 显式指定命名空间</span><br>                <span class="hljs-params">port:</span><br>                  <span class="hljs-params">number:</span> <span class="hljs-number">80</span><br>          <span class="hljs-operator">-</span> <span class="hljs-params">path:</span> <span class="hljs-symbol">/path3</span>                      <span class="hljs-comment"># HTTP 路由 3</span><br>            <span class="hljs-params">pathType:</span> Prefix<br>            <span class="hljs-params">backend:</span><br>              <span class="hljs-params">service:</span><br>                <span class="hljs-params">name:</span> demo-app-http-<span class="hljs-number">3</span><br>                <span class="hljs-params">namespace:</span> namespace-<span class="hljs-number">1</span>        <span class="hljs-comment"># 显式指定命名空间</span><br>                <span class="hljs-params">port:</span><br>                  <span class="hljs-params">number:</span> <span class="hljs-number">80</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>关于 HTTPS 的使用，还有自动续签证书、重写、限流、认证等高级用法，以及相关插件等内容，可以在后续进一步学习。</li>
<li>这些被分发的应用服务 Service 不需要与 Nginx Ingress Controller 位于同一命名空间。然而，如果在多个命名空间下存在相同名称的服务（例如，多个命名空间中都有 <code>demo-app-http-3</code>），我们可以通过显式指定服务的命名空间来避免冲突。</li>
</ol>
</blockquote>
<p>&#x3D;&#x3D;2.创建 Ingress 资源&#x3D;&#x3D;</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">kubectl <span class="hljs-built_in">apply</span> -f <span class="hljs-built_in">demo</span>-ingress.yaml<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;3.检查 Ingress 资源状态&#x3D;&#x3D;</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">kubectl <span class="hljs-built_in">describe</span> ingress <span class="hljs-built_in">demo</span>-ingress<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="11-K8S-核心概念：K8S-存储"><a href="#11-K8S-核心概念：K8S-存储" class="headerlink" title="11. K8S 核心概念：K8S 存储"></a>11. K8S 核心概念：K8S 存储</h3><h4 id="11-1-K8S-存储-的组成"><a href="#11-1-K8S-存储-的组成" class="headerlink" title="11.1. K8S 存储 的组成"></a>11.1. K8S 存储 的组成</h4><p>K8S 存储由以下几部分组成：</p>
<ol>
<li>&#x3D;&#x3D;EmptyDir&#x3D;&#x3D;：<ol>
<li><code>EmptyDir</code> 是当 Pod 创建时，Kubernetes 会自动在 Pod 所在宿主机上为其分配一个临时目录（ <code>/var/lib/kubelet/pods/&lt;pod-id&gt;/volumes/kubernetes.io~empty-dir/</code> ）该 Pod 内的所有容器都可以读写这个目录。</li>
<li>然而，<font color="#ff0000">一旦 Pod 挂掉或迁移，数据将不可被访问</font>，直到 Kubelet 定期清理 <code>/var/lib/kubelet</code> 下的无用数据时才会被删除。</li>
</ol>
</li>
<li>&#x3D;&#x3D;HostPath&#x3D;&#x3D;：<ol>
<li><code>HostPath</code> 允许 Pod 内的容器访问 Pod 所在宿主机的特定目录，如果多个 Pod 在同一个 Node 上，可以共享该数据，即便 Pod 挂掉或迁移，数据仍然在宿主机上</li>
<li>然而，由于数据存储在宿主机上，当 Pod 迁移到其他节点时，就无法访问原节点上的数据，无法访问原宿主机上的 HostPath 存储卷，只能访问当前节点的 HostPath 路径下的数据，每个节点上的 HostPath 存储卷数据可能不同，这可能导致数据不一致。</li>
<li>需要特别注意的是，K8S 不会自动创建目录，我们必须手动在宿主机上预先创建目录。如果目录不存在，可能会导致问题。</li>
</ol>
</li>
<li>&#x3D;&#x3D;NFS&#x3D;&#x3D;：<ol>
<li><code>NFS</code> 可以让 Pod 从远程 NFS 服务器中读写数据，可以跨多个 Pod 和 Node 共享数据</li>
<li>需要特别注意的是，通常情况下，NFS 不需要由 Kubernetes 管理或配置，它是一个独立的外部服务，负责数据存储和共享。</li>
<li>同样的，K8S 不会自动创建目录，我们必须手动在宿主机上预先创建目录。如果目录不存在，可能会导致问题。</li>
</ol>
</li>
<li>&#x3D;&#x3D;PV&#x2F;PVC&#x3D;&#x3D;：<ol>
<li>传统存储方式（如 HostPath、EmptyDir、NFS）需要在 Pod 配置中直接指定数据存储路径。而 PV 和 PVC 是 Kubernetes 对存储资源的统一抽象和管理机制。PV 负责定义存储位置和大小，PVC 则负责申请这些存储资源，Pod 只需挂载 PVC 即可。</li>
<li>即使底层存储发生变化（例如从 NFS 更换为云存储），其他配置无需修改。管理员只需更新 PV 配置即可，无需修改 Pod 或 PVC 配置</li>
<li>同样的，K8S 不会自动创建目录，我们必须手动在宿主机上预先创建目录。如果目录不存在，可能会导致问题。</li>
</ol>
</li>
<li>&#x3D;&#x3D;ConfigMap&#x3D;&#x3D;：<ol>
<li><code>ConfigMap</code> <strong>用于存储非敏感的配置信息</strong>，如应用配置、环境变量和配置文件等。它可以包含配置文件、属性对，甚至 JSON 对象。设计初衷是方便多个 Pod 共享和管理配置。</li>
<li>如果应用的配置文件较小（例如小于 1MB），推荐使用 <code>ConfigMap</code>，而不是通过 NFS 挂载</li>
</ol>
</li>
<li>&#x3D;&#x3D;Secret&#x3D;&#x3D;：<ol>
<li>与 <code>ConfigMap</code> 不同，<code>Secret</code> <strong>通过 RBAC 控制访问</strong>，<strong>用于存储敏感信息</strong>，如密码、Token 和私钥等，具有更高的安全性。</li>
</ol>
</li>
</ol>
<hr>
<h4 id="11-2-EmptyDir（Volume-挂载）实战步骤"><a href="#11-2-EmptyDir（Volume-挂载）实战步骤" class="headerlink" title="11.2. EmptyDir（Volume 挂载）实战步骤"></a>11.2. EmptyDir（Volume 挂载）实战步骤</h4><p><code>EmptyDir</code> 需要在 Pod 中通过 Volume 挂载才能使用。</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> v1<br><span class="hljs-params">kind:</span> Pod<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> test-pd<br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">volumes:</span>                                     <span class="hljs-comment"># 定义 Pod 级别的存储卷</span><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> cache-volume                       <span class="hljs-comment"># 存储卷名称</span><br>      <span class="hljs-params">emptyDir:</span> &#123;&#125;                             <span class="hljs-comment"># 使用 emptyDir 存储方式</span><br><br>  <span class="hljs-params">containers:</span><br>    <span class="hljs-operator">-</span> <span class="hljs-params">image:</span> docker.io<span class="hljs-symbol">/nazarpc/webserver</span><br>      <span class="hljs-params">name:</span> test-container<br>      <span class="hljs-params">volumeMounts:</span>                            <span class="hljs-comment"># 容器内卷的挂载配置</span><br>        <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> cache-volume                   <span class="hljs-comment"># 指定要挂载的存储卷的名称</span><br>          <span class="hljs-params">mountPath:</span> <span class="hljs-symbol">/cache</span>                    <span class="hljs-comment"># 挂载点，即存储卷挂载到容器内的哪个目录</span><br>          <span class="hljs-params">readOnly:</span> <span class="hljs-literal">false</span>                      <span class="hljs-comment"># 是否以只读的方式挂载</span><br></code></pre></td></tr></table></figure>

<hr>
<h4 id="11-3-HostPath（Volume-挂载）实战步骤"><a href="#11-3-HostPath（Volume-挂载）实战步骤" class="headerlink" title="11.3. HostPath（Volume 挂载）实战步骤"></a>11.3. HostPath（Volume 挂载）实战步骤</h4><p><code>HostPath</code> 需要在 Pod 中通过 Volume 挂载才能使用。</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> v1<br><span class="hljs-params">kind:</span> Pod<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> test-pd<br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">volumes:</span><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> test-volume<br>      <span class="hljs-params">hostPath:</span>                              <span class="hljs-comment"># 使用 hostPath 存储方式</span><br>        <span class="hljs-params">path:</span> <span class="hljs-symbol">/data</span>                          <span class="hljs-comment"># 需要挂载的宿主机的目录</span><br>        <br>  <span class="hljs-params">containers:</span><br>    <span class="hljs-operator">-</span> <span class="hljs-params">image:</span> docker.io<span class="hljs-symbol">/nazarpc/webserver</span><br>      <span class="hljs-params">name:</span> test-container<br>      <span class="hljs-params">volumeMounts:</span><br>        <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> test-volume<br>          <span class="hljs-params">mountPath:</span> <span class="hljs-symbol">/test-pd</span><br>          <span class="hljs-params">readOnly:</span> <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure>

<hr>
<h4 id="11-4-NFS-实战步骤"><a href="#11-4-NFS-实战步骤" class="headerlink" title="11.4. NFS 实战步骤"></a>11.4. NFS 实战步骤</h4><h5 id="11-4-1-NFS-环境搭建"><a href="#11-4-1-NFS-环境搭建" class="headerlink" title="11.4.1. NFS 环境搭建"></a>11.4.1. NFS 环境搭建</h5><p>NFS 环境搭建见：<a target="_blank" rel="noopener" href="https://blog.wangjia.xin/2025/03/22/%E7%AC%94%E8%AE%B0%EF%BC%9ANFS/">Categories&#x2F;数据管理&#x2F;NFS</a></p>
<hr>
<h5 id="11-4-2-挂载-NFS-共享目录"><a href="#11-4-2-挂载-NFS-共享目录" class="headerlink" title="11.4.2. 挂载 NFS 共享目录"></a>11.4.2. 挂载 NFS 共享目录</h5><p><code>NFS</code> 需要在 Pod 中通过 Volume 挂载才能使用。</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> v1<br><span class="hljs-params">kind:</span> Pod<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> redis<br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">volumes:</span><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> redis-persistent-storage<br>      <span class="hljs-params">nfs:</span>                                    <span class="hljs-comment"># 使用 NFS 存储方式</span><br>        <span class="hljs-params">path:</span> <span class="hljs-symbol">/k8s-nfs/redis/data</span>             <span class="hljs-comment"># NFS 服务器上的共享目录路径</span><br>        <span class="hljs-params">server:</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">126.112</span>               <span class="hljs-comment"># NFS 服务器的 IP 地址（推荐使用域名）</span><br><br>  <span class="hljs-params">containers:</span><br>    <span class="hljs-operator">-</span> <span class="hljs-params">image:</span> redis<br>      <span class="hljs-params">name:</span> redis<br>      <span class="hljs-params">volumeMounts:</span>                           <span class="hljs-comment"># 挂载存储卷到容器内</span><br>        <span class="hljs-operator">-</span> <span class="hljs-params">mountPath:</span> <span class="hljs-symbol">/data</span>                    <span class="hljs-comment"># 将存储卷的目录挂载到容器的 /data 目录</span><br>          <span class="hljs-params">name:</span> redis-persistent-storage      <span class="hljs-comment"># 对应上面定义的存储卷名称，确保正确挂载</span><br></code></pre></td></tr></table></figure>

<hr>
<h4 id="11-5-PV-PVC（Volume-挂载）-实战步骤"><a href="#11-5-PV-PVC（Volume-挂载）-实战步骤" class="headerlink" title="11.5. PV + PVC（Volume 挂载） 实战步骤"></a>11.5. PV + PVC（Volume 挂载） 实战步骤</h4><h5 id="11-5-1-基于-阿里云-NAS"><a href="#11-5-1-基于-阿里云-NAS" class="headerlink" title="11.5.1. 基于 阿里云 NAS"></a>11.5.1. 基于 阿里云 NAS</h5><h6 id="11-5-1-1-所有节点安装-NFS-客户端"><a href="#11-5-1-1-所有节点安装-NFS-客户端" class="headerlink" title="11.5.1.1. 所有节点安装 NFS 客户端"></a>11.5.1.1. 所有节点安装 NFS 客户端</h6><p>安装 NFS 客户端见：<a target="_blank" rel="noopener" href="https://blog.wangjia.xin/2025/03/22/%E7%AC%94%E8%AE%B0%EF%BC%9ANFS/">Categories&#x2F;数据管理&#x2F;NFS</a></p>
<hr>
<h6 id="11-5-1-2-基于-StorageClass-资源（可选）"><a href="#11-5-1-2-基于-StorageClass-资源（可选）" class="headerlink" title="11.5.1.2. 基于 StorageClass 资源（可选）"></a>11.5.1.2. 基于 StorageClass 资源（可选）</h6><p>&#x3D;&#x3D;1.StorageClass 的作用&#x3D;&#x3D;<br><code>StorageClass</code> 可以根据 PVC 动态创建 PV，无需手动预先定义 PV 资源</p>
<p>&#x3D;&#x3D;2.安装阿里云 NAS CSI 插件&#x3D;&#x3D;</p>
<p><a target="_blank" rel="noopener" href="https://help.aliyun.com/zh/nas/user-guide/mount-nas-by-using-alibaba-cloud-csi-storage-components-recommend#8936ec00590ea">https://help.aliyun.com/zh/nas/user-guide/mount-nas-by-using-alibaba-cloud-csi-storage-components-recommend#8936ec00590ea</a></p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs stata"># 1. 下载部署文件<br>wget https:<span class="hljs-comment">//github.com/kubernetes-sigs/alibaba-cloud-csi-driver/archive/refs/tags/v1.2.1.tar.gz</span><br><br>tar -zxvf v1.2.1.tar.gz<br><br><br>下载 <span class="hljs-keyword">zip</span>上传<br><br>uzip alibaba-cloud-<span class="hljs-keyword">csi</span>-driver-release-v1.1.0.<span class="hljs-keyword">zip</span><br><br><span class="hljs-keyword">cd</span> alibaba-cloud-<span class="hljs-keyword">csi</span>-driver-release-v1.1.0/deploy<br><br><br>kubectl create -f ./rbac.yaml<br><br>kubectl create -f ./deploy/nas/nas-<span class="hljs-keyword">plugin</span>.yaml<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项：</p>
<ol>
<li>选版本：<a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver">github&#x2F;alibaba-cloud-csi-driver</a>，code -&gt;branches &#x2F; tags 然后加个xxx.git就行了用tages 就行了<br>标签用于表示代码的一个固定快照，通常用于发布版本。<br>该过程碎石可能变化，详细你还是要看 README 文档啊，看 NAS  CSI 的</li>
</ol>
</blockquote>
<p>步骤都在文档中了，用哪个版本的就看那个版本的文档，看 nas csi 的<br>找他妈release 的，mlgb</p>
<p>&#x3D;&#x3D;2.编写 StorageClass 资源 yaml 文件&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> storage.k8s.io<span class="hljs-symbol">/v1</span><br><span class="hljs-params">kind:</span> StorageClass<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> nas-storage                              <span class="hljs-comment"># StorageClass 的名称</span><br><span class="hljs-params">provisioner:</span> nasplugin.csi.alibabacloud.com      <span class="hljs-comment"># 使用阿里云 NAS CSI 插件</span><br><span class="hljs-params">reclaimPolicy:</span> Retain<br><span class="hljs-params">volumeBindingMode:</span> Immediate<br><span class="hljs-params">allowVolumeExpansion:</span> <span class="hljs-literal">true</span><br><span class="hljs-params">parameters:</span><br>  <span class="hljs-params">server:</span> <span class="hljs-string">&quot;xxx.cn-hangzhou.nas.aliyuncs.com&quot;</span>     <span class="hljs-comment"># NAS 服务地址</span><br>  <span class="hljs-params">path:</span> <span class="hljs-string">&quot;/k8s-data&quot;</span>                              <span class="hljs-comment"># NAS 挂载路径</span><br>  <span class="hljs-params">vers:</span> <span class="hljs-string">&quot;4.0&quot;</span>                                    <span class="hljs-comment"># NFS 协议版本</span><br>  <span class="hljs-params">archiveOnDelete:</span> <span class="hljs-string">&quot;false&quot;</span>                       <span class="hljs-comment"># 删除 PVC 时不自动归档</span><br><span class="hljs-params">mountOptions:</span>                                    <span class="hljs-comment"># NFS 挂载参数</span><br>  <span class="hljs-operator">-</span> nolock<br>  <span class="hljs-operator">-</span> vers<span class="hljs-operator">=</span><span class="hljs-number">4.0</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;3.创建 StorageClass 资源&#x3D;&#x3D;</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">kubectl apply <span class="hljs-operator">-f</span> <span class="hljs-built_in">sc</span><span class="hljs-literal">-nas</span>.yaml<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;4.检查 StorageClass 资源状态&#x3D;&#x3D;</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl <span class="hljs-built_in">get</span> storageclass<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="11-5-1-3-创建-PV-资源"><a href="#11-5-1-3-创建-PV-资源" class="headerlink" title="11.5.1.3. 创建 PV 资源"></a>11.5.1.3. 创建 PV 资源</h6><p>&#x3D;&#x3D;1.编写 PV 资源 yaml 文件&#x3D;&#x3D;<br>如果使用了 StorageClass，则无需手动创建 PV 资源；否则，需要手动创建 PV 资源。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">apiVersion:</span> v1<br><span class="hljs-symbol">kind:</span> PersistentVolume<br><span class="hljs-symbol">metadata:</span><br><span class="hljs-symbol">  name:</span> nas-pv<br><span class="hljs-symbol">spec:</span><br><span class="hljs-symbol">  capacity:</span><br><span class="hljs-symbol">    storage:</span> <span class="hljs-number">20</span>Gi<br><span class="hljs-symbol">  accessModes:</span><br>    - ReadWriteMany<br><span class="hljs-symbol">  persistentVolumeReclaimPolicy:</span> Retain<br><span class="hljs-symbol">  storageClassName:</span> nas-storage                       <span class="hljs-meta"># 指定 StorageClass</span><br><span class="hljs-symbol">  csi:</span>                                                <span class="hljs-meta"># 存储后端配置，这里使用 CSI 插件对接阿里云 NAS</span><br><span class="hljs-symbol">    driver:</span> nasplugin.csi.alibabacloud.com            <span class="hljs-meta"># 指定使用阿里云 NAS CSI 驱动</span><br><span class="hljs-symbol">    volumeHandle:</span> nas-pv                              <span class="hljs-meta"># 唯一标识符，用于 K8S 与 NAS 之间建立联系</span><br><span class="hljs-symbol">    volumeAttributes:</span>                                 <span class="hljs-meta"># NAS 存储相关属性配置</span><br><span class="hljs-symbol">      server:</span> <span class="hljs-string">&quot;xxx.cn-hangzhou.nas.aliyuncs.com&quot;</span>      <span class="hljs-meta"># NAS 挂载点地址</span><br><span class="hljs-symbol">      path:</span> <span class="hljs-string">&quot;/k8s_share&quot;</span>                              <span class="hljs-meta"># NAS 文件系统内的子路径</span><br><span class="hljs-symbol">      vers:</span> <span class="hljs-string">&quot;4.0&quot;</span>                                     <span class="hljs-meta"># NFS 协议版本</span><br><span class="hljs-symbol">      options:</span>                                        <span class="hljs-meta"># NFS 挂载参数</span><br>	    - nolock<br>	    - noresvport<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li><font color="#00b0f0">唯一标识符</font>：<ul>
<li><code>volumeHandle</code> 是一个唯一标识符，用来在存储系统（如阿里云NAS）和 Kubernetes 集群之间建立联系。</li>
</ul>
</li>
<li><font color="#00b0f0">NAS 子路径</font>：<ul>
<li>需要我们提前创建好</li>
</ul>
</li>
<li><font color="#00b0f0">NFS 协议版本</font>：<ul>
<li>阿里云 NAS 推荐使用 NFS 4.0 或 4.1</li>
<li><font color="#7030a0">4.0</font>：单通道传输，适合中小规模数据访问。</li>
<li><font color="#7030a0">4.1</font>：支持多通道传输，适合高并发和大规模分布式存储场景</li>
</ul>
</li>
<li><font color="#00b0f0">NFS 挂载参数</font>：<ul>
<li>无论你使用的是 NAS 还是 Ceph，只要你的服务基于 NFS 协议提供存储服务，就可以配置 NFS 挂载参数。</li>
</ul>
</li>
</ol>
</blockquote>
<p>&#x3D;&#x3D;2.创建 PV 资源&#x3D;&#x3D;</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">kubectl <span class="hljs-built_in">apply</span> -f nas-<span class="hljs-built_in">pv</span>.yaml<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;3.检查 PV 资源状态&#x3D;&#x3D;</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">kubectl <span class="hljs-built_in">get</span> <span class="hljs-built_in">pv</span><br></code></pre></td></tr></table></figure>

<hr>
<h6 id="11-5-1-4-创建-PVC-资源"><a href="#11-5-1-4-创建-PVC-资源" class="headerlink" title="11.5.1.4. 创建 PVC 资源"></a>11.5.1.4. 创建 PVC 资源</h6><p>&#x3D;&#x3D;1.编写 PVC 资源 yaml 文件&#x3D;&#x3D;</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">apiVersion:</span> v1<br><span class="hljs-symbol">kind:</span> PersistentVolumeClaim<br><span class="hljs-symbol">metadata:</span><br><span class="hljs-symbol">  name:</span> nas-pvc<br><span class="hljs-symbol">spec:</span><br><span class="hljs-symbol">  accessModes:</span><br>    - ReadWriteMany<br><span class="hljs-symbol">  storageClassName:</span> nas-storage                   <span class="hljs-meta"># 指定 StorageClass</span><br><span class="hljs-symbol">  resources:</span><br><span class="hljs-symbol">    requests:</span><br><span class="hljs-symbol">      storage:</span> <span class="hljs-number">20</span>Gi<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;2.创建 PVC 资源&#x3D;&#x3D;</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">kubectl <span class="hljs-built_in">apply</span> -f nas-pvc.yaml<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;3.检查 PVC 资源状态&#x3D;&#x3D;</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl <span class="hljs-built_in">get</span> pvc<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="11-5-1-5-Pod-挂载-PVC"><a href="#11-5-1-5-Pod-挂载-PVC" class="headerlink" title="11.5.1.5. Pod 挂载 PVC"></a>11.5.1.5. Pod 挂载 PVC</h6><p>&#x3D;&#x3D;1.Pod 挂载 PVC&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> v1<br><span class="hljs-params">kind:</span> Pod<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> test-nfs<br>  <span class="hljs-params">namespace:</span> dev<br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">volumes:</span>                                 <span class="hljs-comment"># 定义 Pod 使用的卷</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> nfs-volume                       <span class="hljs-comment"># 卷的名称</span><br>    <span class="hljs-params">persistentVolumeClaim:</span>                 <span class="hljs-comment"># 卷的数据来源，这里是来自 PVC</span><br>      <span class="hljs-params">claimName:</span> nfs-pvc                   <span class="hljs-comment"># PVC 的名称</span><br>      <br>  <span class="hljs-params">containers:</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> app<br>    <span class="hljs-params">image:</span> nginx<br>    <span class="hljs-params">volumeMounts:</span>                          <span class="hljs-comment"># 容器内卷的挂载配置                     </span><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> nfs-volume                     <span class="hljs-comment"># 指定挂载的卷名称</span><br>      <span class="hljs-params">mountPath:</span> <span class="hljs-symbol">/usr/share/nginx/html</span>     <span class="hljs-comment"># 挂载点，即容器内的目标路径</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li><font color="#00b0f0">namespace 必须指定</font>：<ul>
<li>Pod 在挂载 PVC 时，必须与 PVC 在同一个命名空间，否则挂载会失败</li>
</ul>
</li>
<li><font color="#00b0f0">无需指定 readOnly</font>：<ul>
<li>不需要在 Pod 中再指定 <code>readOnly</code>，因为 <code>accessModes</code> 已经定义了存储的访问模式。</li>
</ul>
</li>
</ol>
</blockquote>
<p>&#x3D;&#x3D;2.检查 Pod 资源状态&#x3D;&#x3D;</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">kubectl describe pod <span class="hljs-keyword">my</span>-pod<br></code></pre></td></tr></table></figure>

<hr>
<h5 id="11-5-2-补充：PV-资源的写法"><a href="#11-5-2-补充：PV-资源的写法" class="headerlink" title="11.5.2. 补充：PV 资源的写法"></a>11.5.2. 补充：PV 资源的写法</h5><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> v1<br><span class="hljs-params">kind:</span> PersistentVolume<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> nfs-pv<br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">capacity:</span><br>    <span class="hljs-params">storage:</span> <span class="hljs-number">10</span>Gi                            <span class="hljs-comment"># 定义 PV 的存储容量，这里为 10Gi</span><br>    <span class="hljs-params">volumeMode:</span> Filesystem                   <span class="hljs-comment"># 存储模式，这里使用文件系统模式</span><br>  <span class="hljs-params">storageClassName:</span> nas-storage              <span class="hljs-comment"># 指定 StorageClass</span><br>  <span class="hljs-params">accessModes:</span>                               <br>    <span class="hljs-operator">-</span> ReadWriteMany                          <span class="hljs-comment"># 访问模式，这里是多个节点可同时读写</span><br>  <span class="hljs-params">persistentVolumeReclaimPolicy:</span> Retain      <span class="hljs-comment"># 回收策略，这里是PVC 释放后，PV 保留不删除</span><br>  <span class="hljs-params">nfs:</span>                                       <span class="hljs-comment"># 存储后端配置，不同存储类型配置方式不同，这里使用 NFS 存储</span><br>    <span class="hljs-params">path:</span> <span class="hljs-symbol">/data</span>                              <span class="hljs-comment"># NFS 服务上的导出目录路径</span><br>    <span class="hljs-params">server:</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">1.100</span>                    <span class="hljs-comment"># NFS 服务器地址</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li><font color="#00b0f0">手动创建存储路径</font>：<ul>
<li>由于 K8S 不会自动创建存储路径，因此我们需要手动创建存储路径。</li>
</ul>
</li>
<li><font color="#00b0f0">无需指定 namespace</font>：<ul>
<li>PV 是集群范围的资源，不属于任何命名空间。因此在创建 PV 时，不需要指定 <code>metadata.namespace</code> 字段</li>
</ul>
</li>
<li><font color="#00b0f0">storageClassName、accessModes 必须指定</font><ul>
<li><font color="#7030a0">PV + PVC 模式下</font>：<ul>
<li>只有当两者的 <code>storageClassName</code> 和 <code>accessModes</code> 与 PV 一致时，绑定才会成功，否则 PVC 将始终处于 <code>Pending</code> 状态，无法绑定到 PV</li>
</ul>
</li>
<li><font color="#7030a0">StorageClass + PVC 模式下</font>：<ul>
<li>只有当 PVC 的 <code>storageClassName</code> 指定对应的 <code>StorageClass</code> 时，绑定才会成功，否则 PVC 将始终处于 <code>Pending</code> 状态，无法绑定到 PV</li>
</ul>
</li>
</ul>
</li>
<li><font color="#00b0f0">存储模式的配置（<code>volumeMode</code>）</font>：<ul>
<li><font color="#7030a0">Filesystem</font>：将该 PV 挂载为文件系统，类似于普通硬盘，一般都是使用此方式</li>
<li><font color="#7030a0">Block</font>：将该 PV 作为原始磁盘块进行挂载，<strong>很少使用，如果不是内核开发者，否则永远不要碰它</strong></li>
</ul>
</li>
<li><font color="#00b0f0">访问模式的配置（<code>accessModes</code>）</font>：<ul>
<li><font color="#7030a0">ReadWriteOnce</font>：允许单个节点对 PV 进行读写</li>
<li><font color="#7030a0">ReadOnlyMany</font>：允许多个节点以只读模式访问 PV</li>
<li><font color="#7030a0">ReadWriteMany</font>：允许多个节点对 PV 进行读写</li>
</ul>
</li>
<li><font color="#00b0f0">回收策略的配置（<code>persistentVolumeReclaimPolicy</code>）</font>：<ul>
<li><font color="#7030a0">Retain</font>：释放 PVC 时，PV 保留，不会删除。</li>
<li><font color="#7030a0">Delete</font>：释放 PVC 时，PV 会被删除</li>
<li><font color="#7030a0">Recycle</font>：释放 PVC 时，PV 的数据会被清空并重新回收到存储池</li>
</ul>
</li>
</ol>
</blockquote>
<hr>
<h5 id="11-5-3-补充：PVC-资源的写法"><a href="#11-5-3-补充：PVC-资源的写法" class="headerlink" title="11.5.3. 补充：PVC 资源的写法"></a>11.5.3. 补充：PVC 资源的写法</h5><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">apiVersion:</span> v1<br><span class="hljs-symbol">kind:</span> PersistentVolumeClaim<br><span class="hljs-symbol">metadata:</span><br><span class="hljs-symbol">  name:</span> nfs-pvc                                   <span class="hljs-meta"># PVC 名称</span><br><span class="hljs-symbol">  namespace:</span> dev                                  <span class="hljs-meta"># PVC 所属命名空间</span><br><span class="hljs-symbol">spec:</span><br><span class="hljs-symbol">  accessModes:</span><br>    - ReadWriteMany                               <span class="hljs-meta"># 定义 PVC 的访问模式，这里是允许多节点对 PVC 进行读写</span><br><span class="hljs-symbol">  storageClassName:</span> nas-storage                   <span class="hljs-meta"># 指定 StorageClass</span><br><span class="hljs-symbol">  resources:</span><br><span class="hljs-symbol">    requests:</span><br><span class="hljs-symbol">      storage:</span> <span class="hljs-number">5</span>Gi                                <span class="hljs-meta"># 向 PV 请求 5Gi 的存储空间</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li><font color="#00b0f0">namespace 必须指定</font>：<ul>
<li>Pod 在挂载 PVC 时，必须与 PVC 在同一个命名空间，否则挂载会失败，或挂载其他 PVC</li>
</ul>
</li>
<li><font color="#00b0f0">storageClassName、accessModes 必须指定</font><ul>
<li><font color="#7030a0">PV + PVC 模式下</font>：<ul>
<li>只有当 PVC 的 <code>storageClassName</code> 和 <code>accessModes</code> 与 PV 一致时，绑定才会成功，否则 PVC 将始终处于 <code>Pending</code> 状态，无法绑定到 PV</li>
</ul>
</li>
<li><font color="#7030a0">StorageClass + PVC 模式下</font>：<ul>
<li>只有当 PVC 的 <code>storageClassName</code> 和 <code>StorageClass</code>的名称一致时，绑定才会成功，否则 PVC 将始终处于 <code>Pending</code> 状态，无法绑定到 PV</li>
</ul>
</li>
</ul>
</li>
</ol>
</blockquote>
<hr>
<h5 id="11-5-4-补充：StorageClass-资源的写法"><a href="#11-5-4-补充：StorageClass-资源的写法" class="headerlink" title="11.5.4. 补充：StorageClass 资源的写法"></a>11.5.4. 补充：StorageClass 资源的写法</h5><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> storage.k8s.io<span class="hljs-symbol">/v1</span><br><span class="hljs-params">kind:</span> StorageClass<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> fast-storage<br><span class="hljs-params">provisioner:</span> kubernetes.io<span class="hljs-symbol">/aws-ebs</span>          <span class="hljs-comment"># 存储插件，指定由那个存储系统来提供 PV</span><br><span class="hljs-params">reclaimPolicy:</span> Retain                       <span class="hljs-comment"># 回收策略，这里是PVC 释放后，PV 保留不删除</span><br><span class="hljs-params">volumeBindingMode:</span> Immediate                <span class="hljs-comment"># 绑定模式，这里是立即分配存储</span><br><span class="hljs-params">allowVolumeExpansion:</span> <span class="hljs-literal">true</span>                  <span class="hljs-comment"># 是否允许扩展卷的大小，true 表示允许</span><br><span class="hljs-params">parameters:</span>                                 <span class="hljs-comment"># 存储参数，不同存储插件参数不同</span><br>  <span class="hljs-params">type:</span> gp2                                 <span class="hljs-comment"># AWS EBS 存储类型，gp2 为通用型 SSD</span><br>  <span class="hljs-params">fsType:</span> ext4                              <span class="hljs-comment"># 文件系统类型，ext4 是常用的 Linux 文件系统</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li><font color="#00b0f0">手动创建存储路径</font>：<ul>
<li>由于 K8S 不会自动创建存储路径，因此我们需要手动创建存储路径。</li>
</ul>
</li>
<li><font color="#00b0f0">无需指定 namespace</font>：<ul>
<li>StorageClass 是集群范围的资源，不属于任何命名空间。因此在创建 StorageClass 时，不需要指定 <code>metadata.namespace</code> 字段</li>
</ul>
</li>
<li><font color="#00b0f0">无需指定 accessModes</font>：<ul>
<li>使用 StorageClass 无需指定 accessModes，让 PVC 完全按照 StorageClass 的名称进行匹配</li>
</ul>
</li>
<li><font color="#00b0f0">允许扩展卷大小</font>：<ul>
<li><font color="#7030a0">true</font>：<ul>
<li>允许修改 PVC 来增加已绑定的卷大小，可以动态扩展卷的容量</li>
</ul>
</li>
<li>f<font color="#7030a0">alse</font>：<ul>
<li>不允许修改 PVC 来增加已绑定的卷大小</li>
</ul>
</li>
</ul>
</li>
<li><font color="#00b0f0">绑定模式的配置（<code>volumeBindingMode</code>）</font><ul>
<li><font color="#7030a0">Immediate</font>：<ul>
<li>PVC 创建后，立刻为其创建和分配 PV</li>
</ul>
</li>
<li><font color="#7030a0">WaitForFirstConsumer</font>：<ul>
<li>PVC 常见后，不立刻为其创建和分配 PV，而是在 Pod 挂载 PVC 后再为其创建和分配</li>
</ul>
</li>
</ul>
</li>
<li><font color="#00b0f0">回收策略的配置（<code>reclaimPolicy</code>）</font>：<ul>
<li><font color="#7030a0">Retain</font>：释放 PVC 时，PV 保留，不会删除。</li>
<li><font color="#7030a0">Delete</font>：释放 PVC 时，PV 会被删除</li>
<li><font color="#7030a0">Recycle</font>：释放 PVC 时，PV 的数据会被清空并重新回收到存储池</li>
</ul>
</li>
</ol>
</blockquote>
<hr>
<h4 id="11-6-ConfigMap-实战步骤"><a href="#11-6-ConfigMap-实战步骤" class="headerlink" title="11.6. ConfigMap 实战步骤"></a>11.6. ConfigMap 实战步骤</h4><h5 id="11-6-1-以-Env-挂载"><a href="#11-6-1-以-Env-挂载" class="headerlink" title="11.6.1. 以 Env 挂载"></a>11.6.1. 以 Env 挂载</h5><h6 id="11-6-1-1-编写配置信息文件（properties-文件）"><a href="#11-6-1-1-编写配置信息文件（properties-文件）" class="headerlink" title="11.6.1.1. 编写配置信息文件（properties 文件）"></a>11.6.1.1. 编写配置信息文件（properties 文件）</h6><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># variate.properties</span><br><br><span class="hljs-attr">enemies</span>=aliens<br><span class="hljs-attr">lives</span>=<span class="hljs-number">3</span><br><span class="hljs-attr">enemies.cheat</span>=<span class="hljs-literal">true</span><br><span class="hljs-attr">enemies.cheat.level</span>=noGoodRotten<br><span class="hljs-attr">secret.code.passphrase</span>=UUDDLRLRBABAS<br><span class="hljs-attr">secret.code.allowed</span>=<span class="hljs-literal">true</span><br><span class="hljs-attr">secret.code.lives</span>=<span class="hljs-number">30</span><br></code></pre></td></tr></table></figure>

<hr>
<h6 id="11-6-1-2-创建-ConfigMap-资源"><a href="#11-6-1-2-创建-ConfigMap-资源" class="headerlink" title="11.6.1.2. 创建 ConfigMap 资源"></a>11.6.1.2. 创建 ConfigMap 资源</h6><p>&#x3D;&#x3D;1.创建 ConfigMap 资源&#x3D;&#x3D;</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">kubectl <span class="hljs-built_in">create</span> configmap variate-<span class="hljs-built_in">config</span> <span class="hljs-comment">--from-file=variate.properties</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;2.检查 ConfigMap 资源状态&#x3D;&#x3D;</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">kubectl get configmap variate-config -o yaml<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="11-6-1-3-Pod-挂载-ConfigMap（以-Env-挂载）"><a href="#11-6-1-3-Pod-挂载-ConfigMap（以-Env-挂载）" class="headerlink" title="11.6.1.3. Pod 挂载 ConfigMap（以 Env 挂载）"></a>11.6.1.3. Pod 挂载 ConfigMap（以 Env 挂载）</h6><p>&#x3D;&#x3D;1.加载所有键值对成环境变量（推荐）&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> v1<br><br><span class="hljs-params">kind:</span> Pod<br><br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> my-pod<br>  <span class="hljs-params">namespace:</span> xxxxxx<br>  <br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">containers:</span><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> my-container<br>      <span class="hljs-params">image:</span> nginx:latest<br>	  <span class="hljs-params">envFrom:</span>                       <span class="hljs-comment"># 从外部源（这里是 ConfigMap）加载多个环境bianlaing</span><br>		<span class="hljs-operator">-</span> <span class="hljs-params">configMapRef:</span>              <span class="hljs-comment"># 引用一个 ConfigMap，将其中的所欲键值对加载为环境变量</span><br>			<span class="hljs-params">name:</span> bianliang-config<br>	  <span class="hljs-params">env:</span>                           <span class="hljs-comment"># 手动 指定 / 覆盖  环境变量</span><br>	    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> user                 <span class="hljs-comment"># 指定环境变量的名称</span><br>	      <span class="hljs-params">value:</span> <span class="hljs-string">&quot;nginx_admin&quot;</span>       <span class="hljs-comment"># 手动 指定 / 覆盖 环境变量的值</span><br></code></pre></td></tr></table></figure>

<hr>
<h6 id="11-6-1-4-使用-ConfigMap（以-Env-输出）"><a href="#11-6-1-4-使用-ConfigMap（以-Env-输出）" class="headerlink" title="11.6.1.4. 使用 ConfigMap（以 Env 输出）"></a>11.6.1.4. 使用 ConfigMap（以 Env 输出）</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Secret code allowed: <span class="hljs-variable">$SECRET_CODE_allowed</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Lives remaining: <span class="hljs-variable">$SECRET_CODE_LIVES</span>&quot;</span><br></code></pre></td></tr></table></figure>

<hr>
<h5 id="11-6-2-以-Volume-挂载"><a href="#11-6-2-以-Volume-挂载" class="headerlink" title="11.6.2. 以 Volume 挂载"></a>11.6.2. 以 Volume 挂载</h5><h6 id="11-6-2-1-编写配置信息文件（格式不限）"><a href="#11-6-2-1-编写配置信息文件（格式不限）" class="headerlink" title="11.6.2.1. 编写配置信息文件（格式不限）"></a>11.6.2.1. 编写配置信息文件（格式不限）</h6><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># nginx.conf</span><br><br><span class="hljs-attribute">user</span>  nobody;<br><span class="hljs-attribute">worker_processes</span>  <span class="hljs-number">1</span>;<br><span class="hljs-attribute">error_log</span>  logs/<span class="hljs-literal">error</span>.log <span class="hljs-literal">error</span>;<br><span class="hljs-attribute">pid</span>        logs/nginx.pid;<br><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;                                          <span class="hljs-comment"># 监听的端口</span><br>    <span class="hljs-attribute">server_name</span> <span class="hljs-number">192.168.136.8</span>;                          <span class="hljs-comment"># 代理服务器 IP（你的 Nginx 服务器 IP）</span><br>    <br>    <span class="hljs-section">location</span> / &#123;<br>        <span class="hljs-attribute">proxy_pass</span> http://myserver;                     <span class="hljs-comment"># 被代理的服务器</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="11-6-2-2-创建-ConfigMap-资源"><a href="#11-6-2-2-创建-ConfigMap-资源" class="headerlink" title="11.6.2.2. 创建 ConfigMap 资源"></a>11.6.2.2. 创建 ConfigMap 资源</h6><p>&#x3D;&#x3D;1.创建 ConfigMap 资源&#x3D;&#x3D;</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">kubectl <span class="hljs-built_in">create</span> configmap nginx-<span class="hljs-built_in">config</span> <span class="hljs-comment">--from-file=nginx.conf</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;2.检查 ConfigMap 资源状态&#x3D;&#x3D;</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">kubectl get configmap nginx-config -o yaml<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="11-6-2-3-Pod-挂载-ConfigMap（以-Volume-挂载）"><a href="#11-6-2-3-Pod-挂载-ConfigMap（以-Volume-挂载）" class="headerlink" title="11.6.2.3. Pod 挂载 ConfigMap（以 Volume 挂载）"></a>11.6.2.3. Pod 挂载 ConfigMap（以 Volume 挂载）</h6><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> v1<br><br><span class="hljs-params">kind:</span> Pod<br><br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> my-pod<br>  <span class="hljs-params">namespace:</span> xxxxxx<br>  <br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">containers:</span><br>	<span class="hljs-operator">-</span> <span class="hljs-params">name:</span> nginx<br>	  <span class="hljs-params">image:</span> nginx:latest<br>	  <span class="hljs-params">volumeMounts:</span>                                      <span class="hljs-comment"># 容器内卷的挂载配置</span><br>		<span class="hljs-operator">-</span> <span class="hljs-params">name:</span> config-volume                            <span class="hljs-comment"># 指定要挂载的存储卷的名称</span><br>		  <span class="hljs-params">mountPath:</span> <span class="hljs-symbol">/etc/nginx/nginx.conf</span>               <span class="hljs-comment"># 挂载点，即存储卷挂载容器内的哪个目录</span><br>		  <span class="hljs-params">subPath:</span> nginx.conf                            <span class="hljs-comment"># 只挂载卷内的某个子路径或特定文件</span><br>		<br>  <span class="hljs-params">volumes:</span>                                               <span class="hljs-comment"># 定义 Pod 级别的存储卷</span><br>	<span class="hljs-operator">-</span> <span class="hljs-params">name:</span> config-volume                                <span class="hljs-comment"># 存储卷的名称                        </span><br>	  <span class="hljs-params">configMap:</span>                                         <span class="hljs-comment"># 使用 ConfigMap 存储方式</span><br>		<span class="hljs-params">name:</span> nginx-config                               <span class="hljs-comment"># ConfigMap 的名称为</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li><code>subPath: nginx.conf</code>：<ul>
<li>表示只挂载 ConfigMap 中名为 <code>nginx.conf</code> 的文件，而不是整个 ConfigMap。这意味着容器中 <code>/etc/nginx/nginx.conf</code> 文件会被替换为 ConfigMap 中 <code>nginx.conf</code> 文件的内容。</li>
</ul>
</li>
</ol>
</blockquote>
<hr>
<h5 id="11-6-3-补充：ConfigMap-更新"><a href="#11-6-3-补充：ConfigMap-更新" class="headerlink" title="11.6.3. 补充：ConfigMap 更新"></a>11.6.3. 补充：ConfigMap 更新</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 1. 编辑完配置文件后，重新创建 ConfigMap，并应用此更新</span><br>kubectl create configmap bianliang-config <span class="hljs-attribute">--from-file</span>=bianliang.properties <span class="hljs-attribute">--dry-run</span>=client -o yaml | kubectl apply -f -<br><br><br><span class="hljs-comment"># 2. 为相关的 Deployment 触发滚动更新，应用最新的 ConfigMap</span><br>kubectl rollout restart deployment &lt;deployment-name&gt;<br></code></pre></td></tr></table></figure>

<hr>
<h4 id="11-7-Secret-实战步骤"><a href="#11-7-Secret-实战步骤" class="headerlink" title="11.7. Secret 实战步骤"></a>11.7. Secret 实战步骤</h4><h5 id="11-7-1-Secret-的组成"><a href="#11-7-1-Secret-的组成" class="headerlink" title="11.7.1. Secret 的组成"></a>11.7.1. Secret 的组成</h5><p>Secret 主要由以下三部分组成：</p>
<ol>
<li>&#x3D;&#x3D;Service Account Secret&#x3D;&#x3D;：<ol>
<li>当在 Pod 内部需要执行 <code>kubectl</code> 命令的时候，需要携带本 Pod 所绑定的 <code>Service Account</code> 的 <code>Token</code> ，用于 <code>API Server</code> 对其执行认证和鉴权</li>
</ol>
</li>
<li>&#x3D;&#x3D;Opaque Secret&#x3D;&#x3D;：<ol>
<li>适用于存储<strong>密码、密钥、API Key 等敏感信息</strong>。可由用户自定义创建和管理。</li>
<li><code>Opaque Secret</code> 中的数据必须以 <code>base64</code> 编码的形式存储，虽然不能完全防止恶意用户访问，但它能够确保数据在配置文件中是以编码的方式存储的，从而增加了一定的安全性。</li>
<li>需要注意的是，Base64 编码只是使其适合在文本中传输，不提供任何加密功能，任何人都可以轻松解码回原始数据。</li>
</ol>
</li>
<li>&#x3D;&#x3D;dockerconfigjson&#x3D;&#x3D;：<ol>
<li>当 Pod 需要从<strong>私有仓库（例如阿里云或 Docker Hub 私有仓库）拉取镜像</strong>时，用于存储 Docker 认证信息。</li>
</ol>
</li>
</ol>
<hr>
<h5 id="11-7-2-Service-Account-Secret-实战步骤"><a href="#11-7-2-Service-Account-Secret-实战步骤" class="headerlink" title="11.7.2. Service Account Secret 实战步骤"></a>11.7.2. Service Account Secret 实战步骤</h5><h6 id="11-7-2-1-创建-Service-Account-资源"><a href="#11-7-2-1-创建-Service-Account-资源" class="headerlink" title="11.7.2.1. 创建 Service Account 资源"></a>11.7.2.1. 创建 Service Account 资源</h6><p>&#x3D;&#x3D;1.编写 Service Account 资源 yaml 文件&#x3D;&#x3D;</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">apiVersion:</span> v1<br><span class="hljs-symbol">kind:</span> ServiceAccount<br><span class="hljs-symbol">metadata:</span><br><span class="hljs-symbol">  name:</span> my-service-account            <span class="hljs-meta"># Service Account 名称</span><br><span class="hljs-symbol">  namespace:</span> default                  <span class="hljs-meta"># Service Account 的 namespace</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li><font color="#00b0f0">必须指定 namespace</font>：<ul>
<li>因为使用 Pod 指定 Service Account，会去找 Pod 所在的 namespace 中的 Service Account</li>
</ul>
</li>
</ol>
</blockquote>
<p>&#x3D;&#x3D;2.创建 Service Account 资源&#x3D;&#x3D;</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">kubectl <span class="hljs-built_in">apply</span> -f service-account.yaml<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;3.查看 Service Account 资源状态&#x3D;&#x3D;</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl <span class="hljs-built_in">get</span> serviceaccount<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="11-7-2-2-使用-RBAC-为-Service-Account-绑定权限"><a href="#11-7-2-2-使用-RBAC-为-Service-Account-绑定权限" class="headerlink" title="11.7.2.2. 使用 RBAC 为 Service Account 绑定权限"></a>11.7.2.2. 使用 RBAC 为 Service Account 绑定权限</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Role</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pod-reader</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]<br>    <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;pods&quot;</span>]<br>    <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>]<br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">RoleBinding</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pod-reader-binding</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">subjects:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">my-sa</span><br>    <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">Role</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pod-reader</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项：关于 Service Account 授权的理解</p>
<ol>
<li>Service Account 需要与 Pod 绑定，一个 Pod 只能绑定一个 Service Account，但一个 Service Account 可以绑定多个 Pod</li>
<li>绑定 Service Account 到 Pod 后，在该 Pod 内执行 <code>kubectl</code> 命令时，权限取决于 Role 的设置。<ul>
<li>如果使用的是 RoleBinding，那么只能操作或访问该 Role 和 RoleBinding 所在 namespace 下的资源；</li>
<li>如果使用的是 ClusterRoleBinding，则可以操作或访问 ClusterRole 所指定的所有 namespace 下的资源。</li>
</ul>
</li>
</ol>
</blockquote>
<hr>
<h6 id="11-7-2-3-Pod-指定-Service-Account"><a href="#11-7-2-3-Pod-指定-Service-Account" class="headerlink" title="11.7.2.3. Pod 指定 Service Account"></a>11.7.2.3. Pod 指定 Service Account</h6><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> v1<br><span class="hljs-params">kind:</span> Pod<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> mypod<br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">serviceAccountName:</span> my-service-account                  <span class="hljs-comment"># 指定要使用的 Service Account</span><br>  <span class="hljs-params">containers:</span><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> mycontainer<br>      <span class="hljs-params">image:</span> nginx<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="11-7-2-4-在-Pod-中访问-API-Server"><a href="#11-7-2-4-在-Pod-中访问-API-Server" class="headerlink" title="11.7.2.4. 在 Pod 中访问 API Server"></a>11.7.2.4. 在 Pod 中访问 API Server</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. 进入 Pod</span><br>kubectl <span class="hljs-built_in">exec</span> -it &lt;pod-name&gt;<br><br><br><span class="hljs-comment"># 2. 获取 Token</span><br>kubectl <span class="hljs-built_in">exec</span> -it &lt;pod-name&gt; -- <span class="hljs-built_in">ls</span> /run/secrets/kubernetes.io/serviceaccount<br><br><br><span class="hljs-comment"># 3. 在 Pod 内部访问 API Server</span><br>TOKEN=$(<span class="hljs-built_in">cat</span> /run/secrets/kubernetes.io/serviceaccount/token)<br>curl -k -H <span class="hljs-string">&quot;Authorization: Bearer <span class="hljs-variable">$TOKEN</span>&quot;</span> https://kubernetes.default.svc/api/v1/nodes<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="11-7-2-5-补充：Service-Account-相关命令"><a href="#11-7-2-5-补充：Service-Account-相关命令" class="headerlink" title="11.7.2.5. 补充：Service Account 相关命令"></a>11.7.2.5. 补充：Service Account 相关命令</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. 获取某 Pod 的 Service Account 的 Token</span><br>kubectl <span class="hljs-built_in">exec</span> -it &lt;pod-name&gt; -n &lt;namespace&gt; -- <span class="hljs-built_in">ls</span> /run/secrets/kubernetes.io/serviceaccount<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li><code>/run/secrets/kubernetes.io/serviceaccount</code> 可能包含：<ul>
<li><font color="#00b0f0">ca.crt</font>：<ul>
<li>K8s API 服务器的 CA 证书（用于验证 API Server 的身份）</li>
</ul>
</li>
<li><font color="#00b0f0">namespace</font>：<ul>
<li>Pod 所在的 Namespace</li>
</ul>
</li>
<li><font color="#00b0f0">token</font>：<ul>
<li>Pod 内部访问 Kubernetes API 的认证 Token</li>
</ul>
</li>
</ul>
</li>
</ol>
</blockquote>
<hr>
<h6 id="11-7-2-6-补充：默认-Service-Account"><a href="#11-7-2-6-补充：默认-Service-Account" class="headerlink" title="11.7.2.6. 补充：默认 Service Account"></a>11.7.2.6. 补充：默认 Service Account</h6><p>K8S 会为每个 namespace 自动创建一个默认的 Service Account。如果该 namespace 下的 Pod 未指定 Service Account，默认将使用该 Service Account。</p>
<p>Service Account 会被挂载到 Pod 的 <code>/var/run/secrets/kubernetes.io/serviceaccount/token</code> 路径中。</p>
<p>默认情况下，默认的 Service Account 没有绑定任何角色，这意味着它几乎没有任何权限。</p>
<hr>
<h5 id="11-7-3-Opaque-Secret-实战步骤"><a href="#11-7-3-Opaque-Secret-实战步骤" class="headerlink" title="11.7.3. Opaque Secret 实战步骤"></a>11.7.3. Opaque Secret 实战步骤</h5><h6 id="11-7-3-1-为铭感数据进行-base64-编码"><a href="#11-7-3-1-为铭感数据进行-base64-编码" class="headerlink" title="11.7.3.1. 为铭感数据进行 base64 编码"></a>11.7.3.1. 为铭感数据进行 base64 编码</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> -n <span class="hljs-string">&quot;admin&quot;</span> | <span class="hljs-built_in">base64</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>也可以使用其他工具进 base64 编码，编码的方式不限</li>
</ol>
</blockquote>
<hr>
<h6 id="11-7-3-2-创建-Secret-资源"><a href="#11-7-3-2-创建-Secret-资源" class="headerlink" title="11.7.3.2. 创建 Secret 资源"></a>11.7.3.2. 创建 Secret 资源</h6><p>&#x3D;&#x3D;1.编写 Secret 资源 yaml 文件&#x3D;&#x3D;</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">apiVersion: v1<br>kind: Secret<br>metadata:<br>  name: my-secret<br>  <span class="hljs-keyword">namespace</span>: <span class="hljs-symbol">default</span><br><span class="hljs-symbol">type</span>: <span class="hljs-symbol">Opaque</span><br><span class="hljs-symbol">data</span>:<br>  <span class="hljs-symbol">username</span>: <span class="hljs-symbol">YWRtaW4</span>=                               # <span class="hljs-symbol">base64</span> 编码后的 &quot;<span class="hljs-symbol">admin</span>&quot;<br>  <span class="hljs-symbol">password</span>: <span class="hljs-symbol">c2VjcmV0MTIz</span>                           # <span class="hljs-symbol">base64</span> 编码后的 &quot;<span class="hljs-symbol">secret123</span>&quot;<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;2.创建 Secret 资源&#x3D;&#x3D;</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">kubectl <span class="hljs-built_in">apply</span> -f opaque-secret.yaml<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;3.查看 Secret 资源状态&#x3D;&#x3D;</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl <span class="hljs-built_in">get</span><span class="hljs-built_in"> secret </span> -o yaml<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="11-7-3-3-Pod-挂载-Opaque-Secret（以-Env-挂载）"><a href="#11-7-3-3-Pod-挂载-Opaque-Secret（以-Env-挂载）" class="headerlink" title="11.7.3.3. Pod 挂载 Opaque Secret（以 Env 挂载）"></a>11.7.3.3. Pod 挂载 Opaque Secret（以 Env 挂载）</h6><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> v1<br><span class="hljs-params">kind:</span> Pod<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> pod-<span class="hljs-keyword">with</span>-secret-env<br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">containers:</span><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> my-container<br>      <span class="hljs-params">image:</span> nginx<br>      <span class="hljs-params">env:</span><br>        <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> USERNAME<br>          <span class="hljs-params">valueFrom:</span><br>            <span class="hljs-params">secretKeyRef:</span><br>              <span class="hljs-params">name:</span> my-secret<br>              <span class="hljs-params">key:</span> username<br>        <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> PASSWORD<br>          <span class="hljs-params">valueFrom:</span><br>            <span class="hljs-params">secretKeyRef:</span><br>              <span class="hljs-params">name:</span> my-secret<br>              <span class="hljs-params">key:</span> password<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>由于 <code>Secret</code> 中的数据是 Base64 编码的，Kubernetes 会在容器启动时自动解码。例如：<code>DATABASE_USER</code> 环境变量的值会被解码为 <code>&quot;admin</code></li>
</ol>
</blockquote>
<hr>
<h6 id="11-7-3-4-在-Pod-中使用-Opaque-Secret（以-Env-输出）"><a href="#11-7-3-4-在-Pod-中使用-Opaque-Secret（以-Env-输出）" class="headerlink" title="11.7.3.4. 在 Pod 中使用 Opaque Secret（以 Env 输出）"></a>11.7.3.4. 在 Pod 中使用 Opaque Secret（以 Env 输出）</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-variable">$USERNAME</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$PASSWORD</span><br></code></pre></td></tr></table></figure>

<hr>
<h5 id="11-7-4-dockerconfigjson-Secret-实战步骤"><a href="#11-7-4-dockerconfigjson-Secret-实战步骤" class="headerlink" title="11.7.4. dockerconfigjson Secret 实战步骤"></a>11.7.4. dockerconfigjson Secret 实战步骤</h5><h6 id="11-7-4-1-准备-Docker-仓库认证信息"><a href="#11-7-4-1-准备-Docker-仓库认证信息" class="headerlink" title="11.7.4.1. 准备 Docker 仓库认证信息"></a>11.7.4.1. 准备 Docker 仓库认证信息</h6><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">export</span> <span class="hljs-attribute">DOCKER_REGISTRY_SERVER</span>=<span class="hljs-string">&quot;your-docker-registry-server&quot;</span><br><span class="hljs-built_in">export</span> <span class="hljs-attribute">DOCKER_USERNAME</span>=<span class="hljs-string">&quot;your-docker-username&quot;</span><br><span class="hljs-built_in">export</span> <span class="hljs-attribute">DOCKER_PASSWORD</span>=<span class="hljs-string">&quot;your-docker-password&quot;</span><br><span class="hljs-built_in">export</span> <span class="hljs-attribute">DOCKER_EMAIL</span>=<span class="hljs-string">&quot;your-docker-email&quot;</span><br></code></pre></td></tr></table></figure>

<hr>
<h6 id="11-7-4-2-创建-Secret-资源"><a href="#11-7-4-2-创建-Secret-资源" class="headerlink" title="11.7.4.2. 创建 Secret 资源"></a>11.7.4.2. 创建 Secret 资源</h6><p>&#x3D;&#x3D;1.创建 Secret 资源&#x3D;&#x3D;</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl create<span class="hljs-built_in"> secret </span>docker-registry myregistrykey \<br>  <span class="hljs-attribute">--docker-server</span>=<span class="hljs-variable">$DOCKER_REGISTRY_SERVER</span> \<br>  <span class="hljs-attribute">--docker-username</span>=<span class="hljs-variable">$DOCKER_USERNAME</span> \<br>  <span class="hljs-attribute">--docker-password</span>=<span class="hljs-variable">$DOCKER_PASSWORD</span> \<br>  <span class="hljs-attribute">--docker-email</span>=<span class="hljs-variable">$DOCKER_EMAIL</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;2.查看 Secret 资源状态&#x3D;&#x3D;</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl <span class="hljs-built_in">get</span><span class="hljs-built_in"> secret </span>-o yaml<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="11-7-4-3-Pod-中指定-dockerconfigjson-Secret"><a href="#11-7-4-3-Pod-中指定-dockerconfigjson-Secret" class="headerlink" title="11.7.4.3. Pod 中指定 dockerconfigjson Secret"></a>11.7.4.3. Pod 中指定 dockerconfigjson Secret</h6><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> v1<br><span class="hljs-params">kind:</span> Pod<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> foo<br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">containers:</span>                                      <span class="hljs-comment"># 使用 dockerconfigjson Secret 拉取进行</span><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> foo<br>      <span class="hljs-params">image:</span> <span class="hljs-symbol">&lt;your-docker-registry-server&gt;</span><span class="hljs-operator">/</span><span class="hljs-symbol">&lt;your-image&gt;</span>:<span class="hljs-symbol">&lt;tag&gt;</span><br>  <span class="hljs-params">imagePullSecrets:</span>                                <span class="hljs-comment"># 指定 dockerconfigjson Secret</span><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> myregistrykey                          <br></code></pre></td></tr></table></figure>

<hr>
<h4 id="11-8-补充：Volume-挂载方法"><a href="#11-8-补充：Volume-挂载方法" class="headerlink" title="11.8. 补充：Volume 挂载方法"></a>11.8. 补充：Volume 挂载方法</h4><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">spec:</span><br>  <span class="hljs-params">volumes:</span>                                        <span class="hljs-comment"># 定义 Pod 级别的存储卷</span><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> config-volume                         <span class="hljs-comment"># 存储卷名称</span><br>      xxxxxxxxx                                   <span class="hljs-comment"># 指定卷的存储方式，即数据来源</span><br><br>  <span class="hljs-params">containers:</span><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> nginx<br>      <span class="hljs-params">image:</span> nginx:latest<br>      <span class="hljs-params">volumeMounts:</span>                               <span class="hljs-comment"># 容器内卷的挂载配置</span><br>        <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> config-volume                     <span class="hljs-comment"># 指定要挂载的存储卷的名称</span><br>          <span class="hljs-params">mountPath:</span> <span class="hljs-symbol">/etc/nginx/nginx.conf</span>        <span class="hljs-comment"># 挂载点，即存储卷挂载到容器内的哪个目录</span><br>          <span class="hljs-params">subPath:</span> nginx.conf                     <span class="hljs-comment"># 只挂载卷内的某个子路径或特定文件，而不是整个卷</span><br>          <span class="hljs-params">readOnly:</span> <span class="hljs-literal">false</span>                         <span class="hljs-comment"># 指定是否以只读方式挂载（false 表示可读写）</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li><font color="#00b0f0">subPath: nginx.conf</font>：<ul>
<li>用于只挂载卷中的某个特定子路径（例如 ConfigMap 中的单个文件），而不是整个卷的内容。这样可以实现对特定配置文件的精确覆盖。</li>
<li>这意味着容器中的 <code>/etc/nginx/nginx.conf</code> 文件将被 ConfigMap 中的 <code>nginx.conf</code> 文件内容<strong>替代</strong>。</li>
</ul>
</li>
<li><font color="#00b0f0">常见卷的存储方式</font>：<ul>
<li>emptyDir</li>
<li>hostPath</li>
<li>nfs</li>
<li>persistentVolumeClaim</li>
</ul>
</li>
<li><font color="#00b0f0">注意事项</font>：<ul>
<li>如果容器中的挂载点已经有文件，挂载存储卷后，原有文件会被暂时替代</li>
</ul>
</li>
</ol>
</blockquote>
<hr>
<h4 id="11-9-补充：Env-挂载方法和相关命令"><a href="#11-9-补充：Env-挂载方法和相关命令" class="headerlink" title="11.9. 补充：Env 挂载方法和相关命令"></a>11.9. 补充：Env 挂载方法和相关命令</h4><p>&#x3D;&#x3D;1.挂载方法&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">spec:</span><br>  <span class="hljs-params">containers:</span><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> my-container<br>      <span class="hljs-params">image:</span> nginx:latest<br>      <span class="hljs-params">envFrom:</span>                          <span class="hljs-comment"># 从外部源（如 ConfigMap、Secret）加载多个环境变量</span><br>        <span class="hljs-operator">-</span> <span class="hljs-params">configMapRef:</span>                 <span class="hljs-comment"># 引用一个 ConfigMap，将其中的所有键值对加载为环境变量</span><br>            <span class="hljs-params">name:</span> my-variate-config1    <span class="hljs-comment"># ConfigMap 的名称</span><br>		<span class="hljs-operator">-</span> <span class="hljs-params">secretRef:</span>                    <span class="hljs-comment"># 引用一个 Secret，将其中的所有键值对加载为环境变量</span><br>		    <span class="hljs-params">name:</span> my-opaque-secret1     <span class="hljs-comment"># Secret 的名称</span><br>      <span class="hljs-params">env:</span>                              <span class="hljs-comment"># 手动 指定 / 覆盖 / 获取环境变量</span><br>        <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> USER                    <span class="hljs-comment"># 指定环境变量的名称</span><br>          <span class="hljs-params">value:</span> <span class="hljs-string">&quot;nginx_admin&quot;</span>          <span class="hljs-comment"># 手动 指定 / 覆盖 环境变量的值</span><br><br>	    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> MY_ENV <br>	      <span class="hljs-params">valueFrom:</span>                    <span class="hljs-comment"># 从外部源获取环境变量的值</span><br>	        <span class="hljs-params">configMapKeyRef:</span>            <span class="hljs-comment"># 从 ConfigMap 中获取某键个值</span><br>	          <span class="hljs-params">name:</span> my-variate-config2  <span class="hljs-comment"># ConfigMap 的名称</span><br>	          <span class="hljs-params">key:</span> my-key               <span class="hljs-comment"># CconfigMap 键的名称</span><br>			<span class="hljs-params">secretKeyRef:</span>               <span class="hljs-comment"># 从 Secret 中获取某个键的值（一般是 Opaque Secret）</span><br>			  <span class="hljs-params">name:</span> my-opaque-secret2   <span class="hljs-comment"># Secret 的名称</span><br>			  <span class="hljs-params">key:</span> my-key               <span class="hljs-comment"># Secret 键的名称</span><br>		    <span class="hljs-params">fieldRef:</span>                   <span class="hljs-comment"># 从当前 Pod 的 metadata 中获取值</span><br>		      <span class="hljs-params">fieldPath:</span> metadata.name  <span class="hljs-comment"># 获取 metadata.name</span><br>		    <span class="hljs-params">resourceFieldRef:</span>           <span class="hljs-comment"># 从当前 Pod 的 resources 下的 limits 或 requests 中获取值</span><br>		      <span class="hljs-params">resource:</span> limits.cpu      <span class="hljs-comment"># 获取 limits.cpu</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项：指定 &#x2F; 覆盖</p>
<ol>
<li>若环境变量不存在，则设置为指定值；</li>
<li>若环境变量已存在，则覆盖原有值</li>
</ol>
</blockquote>
<blockquote>
<p>[!NOTE] 注意事项：<code>env</code></p>
<ol>
<li><code>env</code> 用于手动设置环境变量</li>
<li>如果 ConfigMap 中存在与 <code>env</code> 中相同名称的环境变量，则 <code>env</code> 中的值将覆盖 ConfigMap 中的值。</li>
<li>如果 ConfigMap 中没有与 <code>env</code> 中同名的环境变量，则 <code>env</code> 中的值将成为最终值。</li>
</ol>
</blockquote>
<p>&#x3D;&#x3D;2.相关命令&#x3D;&#x3D;<br>这些命令的前提是，先进入 Pod：<code>kubectl exec -it &lt;pod-name&gt; -- /bin/bash</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. 查看当前 Pod 的环境变量</span><br><span class="hljs-built_in">env</span><br><br><br><span class="hljs-comment"># 2. 输出环境变量</span><br><span class="hljs-variable">$&#123;xxxxx&#125;</span><br></code></pre></td></tr></table></figure>

<hr>
<h4 id="11-10-补充：Volume-和-Env-挂载的区别"><a href="#11-10-补充：Volume-和-Env-挂载的区别" class="headerlink" title="11.10. 补充：Volume 和 Env 挂载的区别"></a>11.10. 补充：Volume 和 Env 挂载的区别</h4><ol>
<li>&#x3D;&#x3D;Volume 挂载&#x3D;&#x3D;：适用于将整个<strong>文件</strong>或多个文件一次性挂载到容器中，它的文件类型不限</li>
<li>&#x3D;&#x3D;Env 挂载&#x3D;&#x3D;：适用于将文件中的部分或全部<strong>键值对</strong>加载为环境变量，之后可以通过 <code>$&#123;xxxx&#125;</code> 的方式引用这些值，一般是使用 <code>properties</code> 类型的文件</li>
</ol>
<hr>
<h3 id="12-K8S-核心概念：K8S-探针"><a href="#12-K8S-核心概念：K8S-探针" class="headerlink" title="12. K8S 核心概念：K8S 探针"></a>12. K8S 核心概念：K8S 探针</h3><h4 id="12-1-K8S-探针-的组成"><a href="#12-1-K8S-探针-的组成" class="headerlink" title="12.1. K8S 探针 的组成"></a>12.1. K8S 探针 的组成</h4><p>在 K8s 中，探针有以下两位明星：</p>
<ol>
<li>&#x3D;&#x3D;liveness probe（存活探针）&#x3D;&#x3D;<ol>
<li><code>Liveness Probe</code> 用于检测容器是否还活着，如果容器的存活探针失败，Kubernetes 会认为该容器处于故障状态并尝试重启它（是否重启还要根据容器的重启策略，如果你设置不重启，那没办法重启）。</li>
</ol>
</li>
<li>&#x3D;&#x3D;readiness probe（就绪探针）&#x3D;&#x3D;<ol start="2">
<li><code>Readiness Probe</code> 用于检测容器是否已经准备好接收流量，只有当就绪探针成功时，Kubernetes Service 才会将流量路由到该容器。</li>
</ol>
</li>
</ol>
<hr>
<h4 id="12-2-存活探针实战步骤"><a href="#12-2-存活探针实战步骤" class="headerlink" title="12.2. 存活探针实战步骤"></a>12.2. 存活探针实战步骤</h4><h5 id="12-2-1-HTTP-GET-探针"><a href="#12-2-1-HTTP-GET-探针" class="headerlink" title="12.2.1. HTTP GET 探针"></a>12.2.1. HTTP GET 探针</h5><p>适用于容器内部有提供 HTTP 服务的应用程序，尤其是 Web 服务，容器响应的 HTTP 状态码可以用于判断健康（如 <code>200 OK</code> 表示健康，<code>500</code> 或 <code>404</code> 等表示不健康）。</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> v1<br><span class="hljs-params">kind:</span> Pod<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> goproxy<br>  <span class="hljs-params">labels:</span><br>    <span class="hljs-params">app:</span> goproxy<br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">containers:</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> goproxy<br>    <span class="hljs-params">image:</span> k8s.gcr.io<span class="hljs-operator">/</span>goproxy:<span class="hljs-number">0.1</span><br><br>	<span class="hljs-params">livenessProbe:</span>                                <span class="hljs-comment"># 配置存活探针</span><br>	  <span class="hljs-params">httpGet:</span>                                    <span class="hljs-comment"># 使用 http get 探针</span><br>	    <span class="hljs-params">path:</span> <span class="hljs-symbol">/healthz</span><br>	    <span class="hljs-params">port:</span> <span class="hljs-number">8080</span><br>	  <span class="hljs-params">initialDelaySeconds:</span> <span class="hljs-number">3</span>                      <span class="hljs-comment"># 容器启动后，第一次探测钱等待多少秒，这里是 3s</span><br>	  <span class="hljs-params">periodSeconds:</span> <span class="hljs-number">10</span>                           <span class="hljs-comment"># 探测的频率，这里是 10s</span><br>	  <span class="hljs-params">timeoutSeconds:</span> <span class="hljs-number">1</span>                           <span class="hljs-comment"># 探测超时时间，超时代表本次探测失败，这里是 1s</span><br>	  successThreshold：<span class="hljs-number">1</span>                         <span class="hljs-comment"># 需要**连续**几次探测成功，才认为存活，这里是 1次</span><br>	  failureThreshold：<span class="hljs-number">3</span>                         <span class="hljs-comment"># 需要**连续**几次探测失败，才认为不存活，这里是 3次</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li><code>/healthz</code> 需要我们自己提供，如：</li>
</ol>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HealthController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/healthz&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> ResponseEntity&lt;String&gt; healthCheck() &#123;<br>        <span class="hljs-comment">// 返回 200 OK，表示健康（不健康让 spring boot 自己返回去吧）</span><br>        <span class="hljs-keyword">return</span> ResponseEntity.ok(<span class="hljs-string">&quot;Healthy&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h5 id="12-2-2-TCP-Socket-探针"><a href="#12-2-2-TCP-Socket-探针" class="headerlink" title="12.2.2. TCP Socket 探针"></a>12.2.2. TCP Socket 探针</h5><p>适用于数据库、消息队列等服务，它们可能没有 HTTP 接口，所以我们只需要检查其端口的可用性，能否建立连接</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">goproxy</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">goproxy</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">goproxy</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">k8s.gcr.io/goproxy:0.1</span><br><br>	<span class="hljs-attr">livenessProbe:</span>                                <span class="hljs-comment"># 配置存活探针</span><br>	  <span class="hljs-attr">tcpSocket:</span>                                  <span class="hljs-comment"># 使用 tcp socket 探针</span><br>	    <span class="hljs-attr">port:</span> <span class="hljs-number">3306</span>                                <span class="hljs-comment"># 连接的端口，推荐与容器内的应用监听的一致           </span><br>	  <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">3</span>                      <span class="hljs-comment"># 容器启动后，第一次探测钱等待多少秒，这里是 3s</span><br>	  <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>                           <span class="hljs-comment"># 探测的频率，这里是 10s</span><br>	  <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">1</span>                           <span class="hljs-comment"># 探测超时时间，超时代表本次探测失败，这里是 1s</span><br>	  <span class="hljs-string">successThreshold：1</span>                         <span class="hljs-comment"># 需要**连续**几次探测成功，才认为存活，这里是 1次</span><br>	  <span class="hljs-string">failureThreshold：3</span>                         <span class="hljs-comment"># 需要**连续**几次探测失败，才认为不存活，这里是 3次</span><br></code></pre></td></tr></table></figure>

<hr>
<h5 id="12-2-3-命令探针"><a href="#12-2-3-命令探针" class="headerlink" title="12.2.3. 命令探针"></a>12.2.3. 命令探针</h5><p>适用于需要执行特定命令来判断容器健康状态的场景。应用程序没有 HTTP 服务或 TCP 服务，但可以通过执行某些命令检查应用状态。</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> v1<br><span class="hljs-params">kind:</span> Pod<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> goproxy<br>  <span class="hljs-params">labels:</span><br>    <span class="hljs-params">app:</span> goproxy<br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">containers:</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> goproxy<br>    <span class="hljs-params">image:</span> k8s.gcr.io<span class="hljs-operator">/</span>goproxy:<span class="hljs-number">0.1</span><br><br>	<span class="hljs-params">livenessProbe:</span>                                <span class="hljs-comment"># 配置存活探针</span><br>	  <span class="hljs-params">exec:</span>                                       <span class="hljs-comment"># 使用命令探针</span><br>	    <span class="hljs-params">command:</span><br>	      <span class="hljs-operator">-</span> <span class="hljs-string">&quot;sh&quot;</span><br>	      <span class="hljs-operator">-</span> <span class="hljs-string">&quot;-c&quot;</span><br>	      <span class="hljs-operator">-</span> <span class="hljs-string">&quot;curl -f http://localhost:8080/healthz || exit 1&quot;</span>       <br>	  <span class="hljs-params">initialDelaySeconds:</span> <span class="hljs-number">3</span>                      <span class="hljs-comment"># 容器启动后，第一次探测钱等待多少秒，这里是 3s</span><br>	  <span class="hljs-params">periodSeconds:</span> <span class="hljs-number">10</span>                           <span class="hljs-comment"># 探测的频率，这里是 10s</span><br>	  <span class="hljs-params">timeoutSeconds:</span> <span class="hljs-number">1</span>                           <span class="hljs-comment"># 探测超时时间，超时代表本次探测失败，这里是 1s</span><br>	  successThreshold：<span class="hljs-number">1</span>                         <span class="hljs-comment"># 需要**连续**几次探测成功，才认为存活，这里是 1次</span><br>	  failureThreshold：<span class="hljs-number">3</span>                         <span class="hljs-comment"># 需要**连续**几次探测失败，才认为不存活，这里是 3次</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>上面三种探针可以结合使用，并不是说只能使用一种探针</li>
</ol>
</blockquote>
<hr>
<h4 id="12-3-就绪探针实战步骤"><a href="#12-3-就绪探针实战步骤" class="headerlink" title="12.3. 就绪探针实战步骤"></a>12.3. 就绪探针实战步骤</h4><h5 id="12-3-1-HTTP-GET-探针"><a href="#12-3-1-HTTP-GET-探针" class="headerlink" title="12.3.1. HTTP GET 探针"></a>12.3.1. HTTP GET 探针</h5><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> v1<br><span class="hljs-params">kind:</span> Pod<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> goproxy<br>  <span class="hljs-params">labels:</span><br>    <span class="hljs-params">app:</span> goproxy<br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">containers:</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> goproxy<br>    <span class="hljs-params">image:</span> k8s.gcr.io<span class="hljs-operator">/</span>goproxy:<span class="hljs-number">0.1</span><br><br>	<span class="hljs-params">readinessProbe:</span><br>	  <span class="hljs-params">httpGet:</span><br>	    <span class="hljs-params">path:</span> <span class="hljs-symbol">/readiness</span><br>	    <span class="hljs-params">port:</span> <span class="hljs-number">8080</span><br>	  <span class="hljs-params">initialDelaySeconds:</span> <span class="hljs-number">3</span><br>	  <span class="hljs-params">periodSeconds:</span> <span class="hljs-number">10</span><br>	  <span class="hljs-params">timeoutSeconds:</span> <span class="hljs-number">1</span><br>	  successThreshold：<span class="hljs-number">1</span><br>	  failureThreshold：<span class="hljs-number">3</span><br></code></pre></td></tr></table></figure>

<hr>
<h5 id="12-3-2-TCP-Socket-探针"><a href="#12-3-2-TCP-Socket-探针" class="headerlink" title="12.3.2. TCP Socket 探针"></a>12.3.2. TCP Socket 探针</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">goproxy</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">goproxy</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">goproxy</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">k8s.gcr.io/goproxy:0.1</span><br><br>	<span class="hljs-attr">readinessProbe:</span><br>	  <span class="hljs-attr">tcpSocket:</span><br>	    <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br>	  <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">3</span><br>	  <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span><br>	  <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">1</span><br>	  <span class="hljs-string">successThreshold：1</span><br>	  <span class="hljs-string">failureThreshold：3</span><br></code></pre></td></tr></table></figure>

<hr>
<h5 id="12-3-3-命令探针"><a href="#12-3-3-命令探针" class="headerlink" title="12.3.3. 命令探针"></a>12.3.3. 命令探针</h5><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">apiVersion</span><span class="hljs-punctuation">:</span> <span class="hljs-string">v1</span><br><span class="hljs-attribute">kind</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attribute">metadata</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">name</span><span class="hljs-punctuation">:</span> <span class="hljs-string">goproxy</span><br>  <span class="hljs-attribute">labels</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">app</span><span class="hljs-punctuation">:</span> <span class="hljs-string">goproxy</span><br><span class="hljs-attribute">spec</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">containers</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">name: goproxy</span><br>    <span class="hljs-attribute">image</span><span class="hljs-punctuation">:</span> <span class="hljs-string">k8s.gcr.io/goproxy:0.1</span><br><br>	<span class="hljs-attribute">readinessProbe</span><span class="hljs-punctuation">:</span><br>	  <span class="hljs-attribute">exec</span><span class="hljs-punctuation">:</span><br>	    <span class="hljs-attribute">command</span><span class="hljs-punctuation">:</span><br>	      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;sh&quot;</span><br>	      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;-c&quot;</span><br>	      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;curl -f http://localhost:8080/ready || exit 1</span><br>	  <span class="hljs-attribute">initialDelaySeconds</span><span class="hljs-punctuation">:</span> <span class="hljs-string">3</span><br>	  <span class="hljs-attribute">periodSeconds</span><span class="hljs-punctuation">:</span> <span class="hljs-string">10</span><br>	  <span class="hljs-attribute">timeoutSeconds</span><span class="hljs-punctuation">:</span> <span class="hljs-string">1</span><br>	  successThreshold：1<br>	  failureThreshold：3<br></code></pre></td></tr></table></figure>

<hr>
<h4 id="12-4-补充：探针的结果"><a href="#12-4-补充：探针的结果" class="headerlink" title="12.4. 补充：探针的结果"></a>12.4. 补充：探针的结果</h4><p>探针的结果就像是你给容器的成绩单，有三种可能：</p>
<ol>
<li>&#x3D;&#x3D;Success（成功）&#x3D;&#x3D;：<ol>
<li>容器通过了健康检查，继续干活！</li>
</ol>
</li>
<li>&#x3D;&#x3D;Failure（失败）&#x3D;&#x3D;：<ol start="2">
<li>容器没通过检查，需要处理一下问题。</li>
</ol>
</li>
<li>&#x3D;&#x3D;Unknown（未知）&#x3D;&#x3D;：<ol>
<li>检查无法执行，K8s 没有采取任何行动。</li>
</ol>
</li>
</ol>
<hr>
<h3 id="13-K8S-核心概念：-K8S-Helm"><a href="#13-K8S-核心概念：-K8S-Helm" class="headerlink" title="13. K8S 核心概念： K8S Helm"></a>13. K8S 核心概念： K8S Helm</h3><h4 id="13-1-Helm-引入的原因"><a href="#13-1-Helm-引入的原因" class="headerlink" title="13.1. Helm 引入的原因"></a>13.1. Helm 引入的原因</h4><hr>
<h3 id="14-K8S-核心概念：RBAC-权限管理"><a href="#14-K8S-核心概念：RBAC-权限管理" class="headerlink" title="14. K8S 核心概念：RBAC 权限管理"></a>14. K8S 核心概念：RBAC 权限管理</h3><h4 id="14-1-RBAC-权限管理引入的原因"><a href="#14-1-RBAC-权限管理引入的原因" class="headerlink" title="14.1. RBAC 权限管理引入的原因"></a>14.1. RBAC 权限管理引入的原因</h4><p>在使用 <code>kubectl</code> 命令时，API Server 并不会随意执行任何请求。它首先会<strong>认证身份</strong>，接着对权限进行<strong>鉴权</strong>，最后才根据 <code>kubectl</code> 命令执行相应操作。</p>
<p>那么，API Server 是如何进行身份认证和权限鉴权的呢？这与我们执行 <code>kubectl</code> 命令时携带的认证信息密切相关：</p>
<ol>
<li><font color="#00b0f0">在 Master 节点终端执行 <code>kubectl</code> 命令</font>：<ol>
<li>我们在 Master 节点的终端执行 <code>kubectl</code> 时，<code>kubeconfig</code> 文件会<strong>自动携带认证信息</strong>，此认证信息通常是<strong>用户证书</strong>。</li>
<li>API Server 会先对该证书进行<strong>身份认证</strong>，验证该用户是否存在。</li>
<li>认证通过后，API Server 会根据我们使用 RBAC（基于角色的访问控制）为该用户绑定的权限，判断其是否有执行该命令的权限。</li>
</ol>
</li>
<li><font color="#00b0f0">在 Pod 内部执行 <code>kubectl</code> 命令</font>：<ol start="4">
<li>在 Pod 内执行 <code>kubectl</code> 命令时，我们需要<strong>手动携带当前 Pod 的 Service Account Token</strong>。</li>
<li>API Server 会先认证该 Token，确认对应的 Service Account 身份。</li>
<li>认证通过后，API Server 再依据 RBAC 为该 Service Account 绑定的权限，判断其是否有权限执行该命令。</li>
<li>注意：每个 Pod 只会挂载一个 Service Account，其 Token 会被自动挂载到 <code>/var/run/secrets/kubernetes.io/serviceaccount/token</code> 中。</li>
</ol>
</li>
</ol>
<p>而 RBAC 权限管理就是负责为<strong>用户</strong>、<strong>用户组</strong>或者<strong>Service Account</strong>授予执行 <code>kubectl</code> 命令的<strong>权限</strong>。</p>
<hr>
<h4 id="14-2-为-用户-用户组-授权"><a href="#14-2-为-用户-用户组-授权" class="headerlink" title="14.2. 为 用户 &#x2F; 用户组 授权"></a>14.2. 为 用户 &#x2F; 用户组 授权</h4><h5 id="14-2-1-创建用户证书"><a href="#14-2-1-创建用户证书" class="headerlink" title="14.2.1. 创建用户证书"></a>14.2.1. 创建用户证书</h5><p>在 K8S 中创建用户证书时，不能像创建 HTTPS 自签名证书那样随意生成用户证书，因为 K8S 会验证用户证书的有效性。</p>
<p>K8S 如何检测用户证书是否有效呢？它需要我们将 K8S 当作一个权威的 CA 机构，并为其创建一个 CA 证书，用它的 CA 证书为我们的用户证书签名请求（CSR）进行签署，然后将签署后的用户证书提供给需要的用户。</p>
<p>如果我们使用 kubeadm 部署 K8S 集群，他会默认为我们生成 CA 证书，CA 证书和其秘钥一般存放在 Master 节点的 <code>/etc/kubernetes/pki/</code> 目录下，文件名通常为 <code>ca.crt</code> 和 <code>ca.key</code></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment"># 1. 安装 OpenSSL 服务</span><br>sudo apt install openssl        <span class="hljs-comment"># Ubuntu</span><br><br><br><span class="hljs-comment"># 2. 生成 用户私钥</span><br>openssl genpkey -algorithm RSA -out alice.key -pkeyopt rsa_keygen_bits:2048 -aes256<br><br><br><span class="hljs-comment"># 3. 创建CSR配置文件 csr_alice.conf，并进行配置</span><br>[ req ]<br>default_bits = 2048              <span class="hljs-comment"># 密钥长度设置为 2048 位</span><br>prompt = no                      <span class="hljs-comment"># 禁用交互式提示</span><br>default_md = sha256              <span class="hljs-comment"># 使用 SHA-256 作为默认哈希算法</span><br>distinguished_name = dn          <span class="hljs-comment"># 指定 DN（Distinguished Name）部分</span><br>req_extensions = v3_ext          <span class="hljs-comment"># 启用扩展字段</span><br><br>[ dn ]<br>CN = alice                       <span class="hljs-comment"># 用户名（Common Name）</span><br>O = dev-team                     <span class="hljs-comment"># 用户组（Organization），用于 RBAC 角色绑定</span><br><br>[ v3_ext ]<br>basicConstraints = CA:FALSE      <span class="hljs-comment"># 标记为非 CA 证书</span><br>keyUsage = digitalSignature, keyEncipherment  <span class="hljs-comment"># 密钥用途：数字签名和密钥加密</span><br>extendedKeyUsage = clientAuth    <span class="hljs-comment"># 扩展密钥用途：客户端认证（必须包含）</span><br><br><br><span class="hljs-comment"># 4. 生成含扩展的用户证书签名请求（CSR）</span><br>openssl req -new -key alice.key -out alice.csr -config csr.conf<br><br><br><span class="hljs-comment"># 5. 使用 CA 证书为 CSR 进行签署</span><br>openssl x509 -req -in alice.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out alice.crt -days 365 -extensions v3_ext -sha256<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>不能用 <code>openssl req -new -key user.key -out user.csr</code> 直接生成用户证书签名请求（CSR），因为默认缺少Kubernetes所需的扩展字段（如<code>clientAuth</code>），可能导致证书认证失败。</li>
</ol>
</blockquote>
<hr>
<h5 id="14-2-2-将用户证书配置到-kubeconfig-中"><a href="#14-2-2-将用户证书配置到-kubeconfig-中" class="headerlink" title="14.2.2. 将用户证书配置到 kubeconfig 中"></a>14.2.2. 将用户证书配置到 kubeconfig 中</h5><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-comment"># 1. 将 admin.conf 复制并作为用户的 config 模板，重命名为 config，不加任何后缀。</span><br>cp etc<span class="hljs-symbol">/kubernetes/admin.conf</span> etc<span class="hljs-symbol">/kubernetes/userconfig/alice/config</span><br><br><br><span class="hljs-comment"># 2. 修改 config 的关键字段</span><br><br><span class="hljs-params">users:</span>                                      <span class="hljs-comment"># 进行用户配置</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> alice@kubernetes                  <span class="hljs-comment"># 用户名称（本地标识，本文件中引用，推荐：&lt;用户&gt;@&lt;集群&gt;）</span><br>    <span class="hljs-params">user:</span><br>      <span class="hljs-params">client-certificate-data:</span> LS0tLS1CRUdJTiB...   <span class="hljs-comment"># 用户证书 Base64 编码（alice.crt）</span><br>      <span class="hljs-params">client-key-data:</span> LS0tLS1CRUdJ...              <span class="hljs-comment"># 用户私钥 Base64 编码（alice.key）</span><br>      <br><span class="hljs-params">clusters:</span>                                   <span class="hljs-comment"># 进行集群配置</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> env-cluster                       <span class="hljs-comment"># 开发集群名称（本地标识，本文件中引用，其他地方无效）</span><br>    <span class="hljs-params">cluster:</span><br>      <span class="hljs-params">certificate-authority-data:</span> LS0tLS1CRUd...    <span class="hljs-comment"># CA 证书 Base64 编码（ca.crt）</span><br>      <span class="hljs-params">server:</span> https:<span class="hljs-operator">//</span>env_vip.example.com:<span class="hljs-number">6443</span>      <span class="hljs-comment"># API Server 地址（DNS 解析到 VIP，6443 端口）</span><br>      <br>  <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> prod-cluster                     <span class="hljs-comment"># 生产集群名称（本地标识，本文件中引用，其他地方无效）</span><br>    <span class="hljs-params">cluster:</span><br>      <span class="hljs-params">certificate-authority-data:</span> LS0tLS1...<br>      <span class="hljs-params">server:</span> https:<span class="hljs-operator">//</span>prod_vip.example.com:<span class="hljs-number">6443</span><br><br><br><span class="hljs-params">contexts:</span>                                  <span class="hljs-comment"># 进行上下文配置，定义用户当前使用的集群、用户和命名空间</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> dev-team@production              <span class="hljs-comment"># 上下文名称（本地标识，本文件中引用，推荐：&lt;团队&gt;@&lt;集群&gt;）</span><br>    <span class="hljs-params">context:</span><br>      <span class="hljs-params">cluster:</span> production-cluster          <span class="hljs-comment"># 指向开发集群名称</span><br>      <span class="hljs-params">user:</span> alice@kubernetes               <span class="hljs-comment"># 指向用户名称</span><br>      <span class="hljs-params">namespace:</span> mynamespace               <span class="hljs-comment"># kubectl 命令默认操作的命名空间</span><br>      <br>  <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> prod@prod-cluster<br>    <span class="hljs-params">context:</span><br>      <span class="hljs-params">cluster:</span> prod-cluster                <span class="hljs-comment"># 指向生产集群名称</span><br>      <span class="hljs-params">user:</span> alice@kubernetes               <span class="hljs-comment"># 指向用户名称</span><br>      <span class="hljs-params">namespace:</span> mynamespace<br>      <br><br><span class="hljs-params">current-context:</span> dev-team@production       <span class="hljs-comment"># 指定默认生效的上下文，kubectl 将使用该上下文连接集群</span><br><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项：</p>
<ol>
<li><font color="#00b0f0">用户名称</font>：<ul>
<li>一个 <code>config</code> 文件中可以配置多个用户名称，但由于我们是将配置下发给员工，只需要提供一个用户名称即可</li>
</ul>
</li>
<li><font color="#00b0f0">对 crt、key 进行 Base64 编码</font><ul>
<li>Kubernetes 配置文件（如 <code>kubeconfig</code>）要求将证书和密钥的内容以字符串形式嵌入配置文件中</li>
<li>由于证书和密钥是二进制文件，所以需要将其转为 Base64 字符串（<code>base64 -w 0 user.crt </code>），以便写入配置。</li>
</ul>
</li>
<li><font color="#00b0f0">集群配置</font>：<ul>
<li>如果我们配置了多个 Kubernetes 集群，可以使用同一批用户证书在多个集群中进行操作，无需重新生成用户证书。</li>
<li>主要是通过配置不同集群的 <code>server</code> 地址，分别指向对应的 API Server，实现跨集群操作。</li>
<li>但如果规模较小，实际上没必要搭建多个集群，直接使用命名空间（namespace）+调度器（Scheduler）进行逻辑和物理隔离即可，简单又高效。</li>
</ul>
</li>
<li><font color="#00b0f0">上下文配置</font>：<ul>
<li>切换到某个上下文配置时，<code>kubectl</code> 会自动使用该上下文中指定的：集群（API Server）、用户（user）、命名空间</li>
<li>举个栗子，就像 Master 主机上的 <code>admin.conf</code>，默认操作当前主机的 API Server，默认使用 admin 用户，默认操作 default 命名空间，如果你想使用其他用户或操作其他命名空间，就需要通过参数挂载</li>
<li>当然，这只是举个例子，<code>admin.conf</code> 仅包含 <code>admin</code> 用户，你无法切换其他用户，因为根本就没有其他用户</li>
</ul>
</li>
</ol>
</blockquote>
<figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ldif"><span class="hljs-comment"># 使用其他用户 的参数挂载</span><br><span class="hljs-literal">-</span>-user=alice@kubernetes<br><br><br><span class="hljs-comment"># 操作其他命名空间 的参数挂载</span><br><span class="hljs-literal">-</span>n mynamespace<br></code></pre></td></tr></table></figure>

<hr>
<h5 id="14-2-3-将-config-文件下发到用户管理机"><a href="#14-2-3-将-config-文件下发到用户管理机" class="headerlink" title="14.2.3. 将 config 文件下发到用户管理机"></a>14.2.3. 将 config 文件下发到用户管理机</h5><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs arduino"># <span class="hljs-number">1.</span> 使用直接复制或者 ssh 等操作，将 config 下发到用户管理机<br><br><br># <span class="hljs-number">2.</span> 将 config 配置文件复制到默认路径 ~/.kube/config，以便 kubectl 自动加载使用<br><br><br># <span class="hljs-number">3.</span> 在管理机上为 config 设置文件权限<br>chmod <span class="hljs-number">600</span> ~/.kube/config<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>通过这样的配置，管理机无需安装 <code>K8S</code>，即可直接使用 <code>kubectl</code> 命令，并且自动携带 <code>~/.kube/config</code> 文件进行集群访问</li>
</ol>
</blockquote>
<hr>
<h5 id="14-2-4-使用-Role-RoleBinding-为-用户-用户组-授权"><a href="#14-2-4-使用-Role-RoleBinding-为-用户-用户组-授权" class="headerlink" title="14.2.4. 使用 Role + RoleBinding 为 用户 &#x2F; 用户组 授权"></a>14.2.4. 使用 Role + RoleBinding 为 用户 &#x2F; 用户组 授权</h5><p>&#x3D;&#x3D;1.编写 Role 资源 yaml 文件&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> rbac.authorization.k8s.io<span class="hljs-symbol">/v1</span><br><span class="hljs-params">kind:</span> Role<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> pod-reader<br>  <span class="hljs-params">namespace:</span> frontend                     <span class="hljs-comment"># 指定作用的命名空间</span><br><span class="hljs-params">rules:</span>                                    <span class="hljs-comment"># 权限规则</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]                       <span class="hljs-comment"># API 组（&quot;&quot; 表示核心资源，如 Pod、Service）</span><br>    <span class="hljs-params">resources:</span> [<span class="hljs-string">&quot;pods&quot;</span>]                   <span class="hljs-comment"># 资源名称</span><br>    <span class="hljs-params">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>]                <span class="hljs-comment"># 操作权限</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;2.创建 Role 资源&#x3D;&#x3D;</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">kubectl <span class="hljs-built_in">apply</span> -f role.yaml               # 使用 <span class="hljs-built_in">apply</span> 创建 Role<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;3.检查 Role 资源状态&#x3D;&#x3D;</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">kubectl <span class="hljs-keyword">get</span> <span class="hljs-keyword">role</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;4.编写 RoleBinding 资源 yaml 文件&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> rbac.authorization.k8s.io<span class="hljs-symbol">/v1</span><br><span class="hljs-params">kind:</span> RoleBinding<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> alice-pod-reader<br>  <span class="hljs-params">namespace:</span> frontend                      <span class="hljs-comment"># 指定作用的命名空间</span><br><span class="hljs-params">subjects:</span>                                  <span class="hljs-comment"># 授权的用户、组或 ServiceAccount</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">kind:</span> User                             <span class="hljs-comment"># 类型：用户</span><br>    <span class="hljs-params">name:</span> alice                            <span class="hljs-comment"># 授权给 alice 用户（与 用户证书 中的 CN 一致）</span><br>    <span class="hljs-params">apiGroup:</span> rbac.authorization.k8s.io    <span class="hljs-comment"># 指定 RBAC API 组</span><br><span class="hljs-params">roleRef:</span>                                   <span class="hljs-comment"># 引用已有的 Role</span><br>  <span class="hljs-params">kind:</span> Role                               <span class="hljs-comment"># 引用角色的类型</span><br>  <span class="hljs-params">name:</span> pod-reader                         <span class="hljs-comment"># 引用的 Role 名称（需已存在）</span><br>  <span class="hljs-params">apiGroup:</span> rbac.authorization.k8s.io      <span class="hljs-comment"># 指定 RBAC API 组</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>我们可以直接为用户组授权，这样用户组中的所有成员都会自动获得该用户组的权限：</li>
</ol>
</blockquote>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">subjects:</span>                                  <span class="hljs-comment"># 授权的用户、组或 ServiceAccount</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">kind:</span> Grop                             <span class="hljs-comment"># 类型：用户组</span><br>    <span class="hljs-params">name:</span> dev-team                         <span class="hljs-comment"># 授权给 dev-team 用户组（与 用户证书 中的 O 一致）</span><br>    <span class="hljs-params">apiGroup:</span> rbac.authorization.k8s.io    <span class="hljs-comment"># 指定 RBAC API 组</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;5.创建 RoleBinding 资源状态&#x3D;&#x3D;</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">kubectl <span class="hljs-built_in">apply</span> -f rolebinding.yaml          # 使用 <span class="hljs-built_in">apply</span> 创建 RoleBinding<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;6.检查 RoleBinding 资源状态&#x3D;&#x3D;</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl <span class="hljs-built_in">get</span> rolebinding<br></code></pre></td></tr></table></figure>

<hr>
<h5 id="14-2-5-使用-ClusterRole-ClusterRoleBinding-为用户-用户组授权"><a href="#14-2-5-使用-ClusterRole-ClusterRoleBinding-为用户-用户组授权" class="headerlink" title="14.2.5. 使用 ClusterRole + ClusterRoleBinding 为用户 &#x2F; 用户组授权"></a>14.2.5. 使用 ClusterRole + ClusterRoleBinding 为用户 &#x2F; 用户组授权</h5><p>&#x3D;&#x3D;1.编写 ClusterRole 资源 yaml 文件&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> rbac.authorization.k8s.io<span class="hljs-symbol">/v1</span><br><span class="hljs-params">kind:</span> ClusterRole<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> pod-reader                          <span class="hljs-comment"># 指定角色名称</span><br><span class="hljs-params">rules:</span>                                      <span class="hljs-comment"># 权限规则</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]                         <span class="hljs-comment"># API 组（&quot;&quot; 表示核心资源，如 Pod、Service）</span><br>    <span class="hljs-params">resources:</span> [<span class="hljs-string">&quot;pods&quot;</span>]                     <span class="hljs-comment"># 资源名称</span><br>    <span class="hljs-params">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>]                  <span class="hljs-comment"># 操作权限</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;2.创建 ClusterRole 资源&#x3D;&#x3D;</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">kubectl <span class="hljs-built_in">apply</span> -f clusterrole.yaml          # 使用 <span class="hljs-built_in">apply</span> 创建 ClusterRole<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;3.检查 ClusterRole 资源状态&#x3D;&#x3D;</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl <span class="hljs-built_in">get</span> clusterrole<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;4.编写 ClusterRoleBinding 资源 yaml 文件&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> rbac.authorization.k8s.io<span class="hljs-symbol">/v1</span><br><span class="hljs-params">kind:</span> ClusterRoleBinding<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> alice-pod-reader-binding            <span class="hljs-comment"># 绑定名称</span><br><span class="hljs-params">subjects:</span>                                   <span class="hljs-comment"># 授权的用户、组或 ServiceAccount</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">kind:</span> User                              <span class="hljs-comment"># 类型：用户</span><br>    <span class="hljs-params">name:</span> alice                             <span class="hljs-comment"># 授权给 alice 用户（与 用户证书 中的 CN 一致）</span><br>    <span class="hljs-params">apiGroup:</span> rbac.authorization.k8s.io     <span class="hljs-comment"># 指定 RBAC API 组</span><br><span class="hljs-params">roleRef:</span>                                    <span class="hljs-comment"># 引用已有的 ClusterRole</span><br>  <span class="hljs-params">kind:</span> ClusterRole                         <span class="hljs-comment"># 引用角色的类型</span><br>  <span class="hljs-params">name:</span> pod-reader                          <span class="hljs-comment"># 引用的 ClusterRole 名称（需已存在）</span><br>  <span class="hljs-params">apiGroup:</span> rbac.authorization.k8s.io       <span class="hljs-comment"># 指定 RBAC API 组</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>我们可以直接为用户组授权，这样用户组中的所有成员都会自动获得该用户组的权限：</li>
</ol>
</blockquote>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">subjects:</span>                                  <span class="hljs-comment"># 授权的用户、组或 ServiceAccount</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">kind:</span> Grop                             <span class="hljs-comment"># 类型：用户组</span><br>    <span class="hljs-params">name:</span> dev-team                         <span class="hljs-comment"># 授权给 dev-team 用户组（与 用户证书 中的 O 一致）</span><br>    <span class="hljs-params">apiGroup:</span> rbac.authorization.k8s.io    <span class="hljs-comment"># 指定 RBAC API 组</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;5.创建 ClusterRoleBinding 资源&#x3D;&#x3D;</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">kubectl <span class="hljs-built_in">apply</span> -f clusterrolebinding.yaml    # 使用 <span class="hljs-built_in">apply</span> 创建 ClusterRoleBinding<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;6.检查 ClusterRoleBinding 资源状态&#x3D;&#x3D;</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl <span class="hljs-built_in">get</span> clusterrolebinding<br></code></pre></td></tr></table></figure>

<hr>
<h4 id="14-3-为-Service-Account-授权"><a href="#14-3-为-Service-Account-授权" class="headerlink" title="14.3. 为 Service Account 授权"></a>14.3. 为 Service Account 授权</h4><h5 id="14-3-1-创建-Service-Account"><a href="#14-3-1-创建-Service-Account" class="headerlink" title="14.3.1. 创建 Service Account"></a>14.3.1. 创建 Service Account</h5><p>&#x3D;&#x3D;1.编写 Service Account 资源 yaml 文件&#x3D;&#x3D;</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">apiVersion:</span> v1<br><span class="hljs-symbol">kind:</span> ServiceAccount<br><span class="hljs-symbol">metadata:</span><br><span class="hljs-symbol">  name:</span> my-service-account            <span class="hljs-meta"># Service Account 名称</span><br><span class="hljs-symbol">  namespace:</span> default                  <span class="hljs-meta"># Service Account 的 namespace</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li><font color="#00b0f0">必须指定 namespace</font>：<ul>
<li>因为使用 Pod 指定 Service Account，会去找 Pod 所在的 namespace 中的 Service Account</li>
</ul>
</li>
</ol>
</blockquote>
<p>&#x3D;&#x3D;2.创建 Service Account 资源&#x3D;&#x3D;</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">kubectl <span class="hljs-built_in">apply</span> -f service-account.yaml<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;3.查看 Service Account 资源状态&#x3D;&#x3D;</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl <span class="hljs-built_in">get</span> serviceaccount<br></code></pre></td></tr></table></figure>

<hr>
<h5 id="14-3-2-使用-Role-RoleBinding-为-Service-Accoount-授权"><a href="#14-3-2-使用-Role-RoleBinding-为-Service-Accoount-授权" class="headerlink" title="14.3.2. 使用 Role + RoleBinding 为 Service Accoount 授权"></a>14.3.2. 使用 Role + RoleBinding 为 Service Accoount 授权</h5><p>&#x3D;&#x3D;1.编写 Role 资源 yaml 文件&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> rbac.authorization.k8s.io<span class="hljs-symbol">/v1</span><br><span class="hljs-params">kind:</span> Role<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> pod-reader<br>  <span class="hljs-params">namespace:</span> frontend                     <span class="hljs-comment"># 指定作用的命名空间</span><br><span class="hljs-params">rules:</span>                                    <span class="hljs-comment"># 权限规则</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]                       <span class="hljs-comment"># API 组（&quot;&quot; 表示核心资源，如 Pod、Service）</span><br>    <span class="hljs-params">resources:</span> [<span class="hljs-string">&quot;pods&quot;</span>]                   <span class="hljs-comment"># 资源名称</span><br>    <span class="hljs-params">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>]                <span class="hljs-comment"># 操作权限</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;2.创建 Role 资源&#x3D;&#x3D;</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">kubectl <span class="hljs-built_in">apply</span> -f role.yaml               # 使用 <span class="hljs-built_in">apply</span> 创建 Role<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;3.检查 Role 资源状态&#x3D;&#x3D;</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">kubectl <span class="hljs-keyword">get</span> <span class="hljs-keyword">role</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;4.编写 RoleBinding 资源 yaml 文件&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> rbac.authorization.k8s.io<span class="hljs-symbol">/v1</span><br><span class="hljs-params">kind:</span> RoleBinding<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> my-service-account-pod-reader<br>  <span class="hljs-params">namespace:</span> frontend                      <span class="hljs-comment"># 指定作用的命名空间</span><br><span class="hljs-params">subjects:</span>                                  <span class="hljs-comment"># 授权的用户、组或 ServiceAccount</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">kind:</span> ServiceAccount                   <span class="hljs-comment"># 类型：ServiceAccount</span><br>    <span class="hljs-params">name:</span> my-service-account               <span class="hljs-comment"># 授权给 my-service-account ServiceAccount</span><br>    <span class="hljs-params">namespace:</span> frontend                    <span class="hljs-comment"># 确保指定正确的命名空间</span><br><span class="hljs-params">roleRef:</span>                                   <span class="hljs-comment"># 引用已有的 Role</span><br>  <span class="hljs-params">kind:</span> Role                               <span class="hljs-comment"># 引用角色的类型</span><br>  <span class="hljs-params">name:</span> pod-reader                         <span class="hljs-comment"># 引用的 Role 名称（需已存在）</span><br>  <span class="hljs-params">apiGroup:</span> rbac.authorization.k8s.io      <span class="hljs-comment"># 指定 RBAC API 组</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>不要将 Service Account 的namespace 和</li>
</ol>
</blockquote>
<p>&#x3D;&#x3D;5.创建 RoleBinding 资源状态&#x3D;&#x3D;</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">kubectl <span class="hljs-built_in">apply</span> -f rolebinding.yaml          # 使用 <span class="hljs-built_in">apply</span> 创建 RoleBinding<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;6.检查 RoleBinding 资源状态&#x3D;&#x3D;</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl <span class="hljs-built_in">get</span> rolebinding<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="14-3-2-1-使用-ClusterRole-ClusterRoleBinding-为-Service-Account-授权"><a href="#14-3-2-1-使用-ClusterRole-ClusterRoleBinding-为-Service-Account-授权" class="headerlink" title="14.3.2.1. 使用 ClusterRole + ClusterRoleBinding 为 Service Account 授权"></a>14.3.2.1. 使用 ClusterRole + ClusterRoleBinding 为 Service Account 授权</h6><p>&#x3D;&#x3D;1.编写 ClusterRole 资源 yaml 文件&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> rbac.authorization.k8s.io<span class="hljs-symbol">/v1</span><br><span class="hljs-params">kind:</span> ClusterRole<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> pod-reader                            <span class="hljs-comment"># 指定角色名称</span><br><span class="hljs-params">rules:</span>                                        <span class="hljs-comment"># 权限规则</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]                           <span class="hljs-comment"># API 组（&quot;&quot; 表示核心资源，如 Pod、Service）</span><br>    <span class="hljs-params">resources:</span> [<span class="hljs-string">&quot;pods&quot;</span>]                       <span class="hljs-comment"># 资源名称</span><br>    <span class="hljs-params">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>]                    <span class="hljs-comment"># 操作权限</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;2.创建 ClusterRole 资源&#x3D;&#x3D;</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">kubectl <span class="hljs-built_in">apply</span> -f clusterrole.yaml             # 使用 <span class="hljs-built_in">apply</span> 创建 ClusterRole<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;3.检查 ClusterRole 资源状态&#x3D;&#x3D;</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl <span class="hljs-built_in">get</span> clusterrole<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;4.编写 ClusterRoleBinding 资源 yaml 文件&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> rbac.authorization.k8s.io<span class="hljs-symbol">/v1</span><br><span class="hljs-params">kind:</span> ClusterRoleBinding<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> pod-reader-binding-to-sa                <span class="hljs-comment"># 绑定名称</span><br><span class="hljs-params">subjects:</span>                                       <span class="hljs-comment"># 授权的用户、组或 ServiceAccount</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">kind:</span> ServiceAccount                        <span class="hljs-comment"># 类型：ServiceAccount</span><br>    <span class="hljs-params">name:</span> my-service-account                    <span class="hljs-comment"># 授权给 my-service-account</span><br>    <span class="hljs-params">namespace:</span> default                          <span class="hljs-comment"># 指定 ServiceAccount 所在的命名空间</span><br>    <span class="hljs-params">apiGroup:</span> rbac.authorization.k8s.io         <span class="hljs-comment"># 指定 RBAC API 组</span><br><span class="hljs-params">roleRef:</span>                                        <span class="hljs-comment"># 引用已有的 ClusterRole</span><br>  <span class="hljs-params">kind:</span> ClusterRole                             <span class="hljs-comment"># 引用角色的类型</span><br>  <span class="hljs-params">name:</span> pod-reader                              <span class="hljs-comment"># 引用的 ClusterRole 名称（需已存在）</span><br>  <span class="hljs-params">apiGroup:</span> rbac.authorization.k8s.io           <span class="hljs-comment"># 指定 RBAC API 组</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;5.创建 ClusterRoleBinding 资源&#x3D;&#x3D;</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">kubectl <span class="hljs-built_in">apply</span> -f clusterrolebinding.yaml    # 使用 <span class="hljs-built_in">apply</span> 创建 ClusterRoleBinding<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;6.检查 ClusterRoleBinding 资源状态&#x3D;&#x3D;</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl <span class="hljs-built_in">get</span> clusterrolebinding<br></code></pre></td></tr></table></figure>

<hr>
<h4 id="14-4-补充：Role-资源的写法"><a href="#14-4-补充：Role-资源的写法" class="headerlink" title="14.4. 补充：Role 资源的写法"></a>14.4. 补充：Role 资源的写法</h4><h5 id="14-4-1-Role-资源的写法"><a href="#14-4-1-Role-资源的写法" class="headerlink" title="14.4.1. Role 资源的写法"></a>14.4.1. Role 资源的写法</h5><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> rbac.authorization.k8s.io<span class="hljs-symbol">/v1</span><br><span class="hljs-params">kind:</span> Role<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> pod-reader<br>  <span class="hljs-params">namespace:</span> frontend                     <span class="hljs-comment"># 指定作用的命名空间</span><br><span class="hljs-params">rules:</span>                                    <span class="hljs-comment"># 权限规则</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]                       <span class="hljs-comment"># API 组（&quot;&quot; 表示核心资源，如 Pod、Service）</span><br>    <span class="hljs-params">resources:</span> [<span class="hljs-string">&quot;pods&quot;</span>]                   <span class="hljs-comment"># 资源名称</span><br>    <span class="hljs-params">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>]                <span class="hljs-comment"># 操作权限</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li><code>namespace</code> 必须指定，并且要与 <code>RoleBinding</code> 的命名空间一致。这样，当我们使用 <code>RoleBinding</code> 将 <code>Role</code> 绑定到用户、用户组或 ServiceAccount 后，该用户在执行 <code>kubectl</code> 命令时，就能操作该命名空间下的资源。</li>
</ol>
</blockquote>
<hr>
<h5 id="14-4-2-API-组（apiGroups）和资源名称（resources）"><a href="#14-4-2-API-组（apiGroups）和资源名称（resources）" class="headerlink" title="14.4.2. API 组（apiGroups）和资源名称（resources）"></a>14.4.2. API 组（apiGroups）和资源名称（resources）</h5><p>&#x3D;&#x3D;1.所有资源组（apiGroups: “ * “）&#x3D;&#x3D;</p>
<p>&#x3D;&#x3D;2.核心资源组（apiGroup: “”）&#x3D;&#x3D;</p>
<table>
<thead>
<tr>
<th>资源名称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>pods</code></td>
<td>Pod 资源</td>
</tr>
<tr>
<td><code>services</code></td>
<td>Service 资源</td>
</tr>
<tr>
<td><code>endpoints</code></td>
<td>Service 的 Endpoint 信息</td>
</tr>
<tr>
<td><code>namespaces</code></td>
<td>命名空间</td>
</tr>
<tr>
<td><code>configmaps</code></td>
<td>ConfigMap 配置项</td>
</tr>
<tr>
<td><code>secrets</code></td>
<td>Secret 密钥</td>
</tr>
<tr>
<td><code>persistentvolumeclaims</code></td>
<td>PVC（持久卷声明）</td>
</tr>
<tr>
<td><code>persistentvolumes</code></td>
<td>PV（持久卷）</td>
</tr>
<tr>
<td><code>events</code></td>
<td>事件信息</td>
</tr>
<tr>
<td><code>nodes</code></td>
<td>节点信息</td>
</tr>
<tr>
<td><code>replicationcontrollers</code></td>
<td>副本控制器（RC）</td>
</tr>
<tr>
<td><code>serviceaccounts</code></td>
<td>ServiceAccount 服务账号</td>
</tr>
<tr>
<td><code>bindings</code></td>
<td>调度绑定信息</td>
</tr>
<tr>
<td><code>limitranges</code></td>
<td>限制范围</td>
</tr>
<tr>
<td><code>resourcequotas</code></td>
<td>资源配额</td>
</tr>
</tbody></table>
<p>&#x3D;&#x3D;3.工作负载组（apiGroup: “apps”）&#x3D;&#x3D;</p>
<table>
<thead>
<tr>
<th>资源名称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>deployments</code></td>
<td>Deployment 部署</td>
</tr>
<tr>
<td><code>daemonsets</code></td>
<td>DaemonSet 守护进程集</td>
</tr>
<tr>
<td><code>statefulsets</code></td>
<td>StatefulSet 有状态副本集</td>
</tr>
<tr>
<td><code>replicasets</code></td>
<td>ReplicaSet 副本集</td>
</tr>
<tr>
<td><code>controllerrevisions</code></td>
<td>控制器修订版本信息</td>
</tr>
</tbody></table>
<p>&#x3D;&#x3D;4.批处理资源组（apiGroup: “batch”）&#x3D;&#x3D;</p>
<table>
<thead>
<tr>
<th>资源名称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>jobs</code></td>
<td>Job 任务</td>
</tr>
<tr>
<td><code>cronjobs</code></td>
<td>CronJob 定时任务</td>
</tr>
</tbody></table>
<p>&#x3D;&#x3D;5.RBAC 权限资源组（apiGroup: “rbac.authorization.k8s.io”）&#x3D;&#x3D;</p>
<table>
<thead>
<tr>
<th>资源名称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>roles</code></td>
<td>Role 角色</td>
</tr>
<tr>
<td><code>rolebindings</code></td>
<td>RoleBinding 角色绑定</td>
</tr>
<tr>
<td><code>clusterroles</code></td>
<td>ClusterRole 集群角色</td>
</tr>
<tr>
<td><code>clusterrolebindings</code></td>
<td>ClusterRoleBinding 集群绑定</td>
</tr>
</tbody></table>
<p>&#x3D;&#x3D;6.自定义资源（CRD）组（apiGroup: “apiextensions.k8s.io”）&#x3D;&#x3D;</p>
<table>
<thead>
<tr>
<th>资源名称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>customresourcedefinitions</code></td>
<td>自定义资源定义（CRD）</td>
</tr>
</tbody></table>
<p>&#x3D;&#x3D;7.其他常见资源组&#x3D;&#x3D;</p>
<table>
<thead>
<tr>
<th>API 组</th>
<th>资源名称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>autoscaling</code></td>
<td><code>horizontalpodautoscalers</code></td>
<td>HPA 自动扩缩容</td>
</tr>
<tr>
<td><code>networking.k8s.io</code></td>
<td><code>networkpolicies</code></td>
<td>网络策略</td>
</tr>
<tr>
<td><code>storage.k8s.io</code></td>
<td><code>storageclasses</code></td>
<td>存储类</td>
</tr>
<tr>
<td><code>metrics.k8s.io</code></td>
<td><code>pods</code>, <code>nodes</code></td>
<td>指标（Pod、Node）</td>
</tr>
</tbody></table>
<hr>
<h5 id="14-4-3-操作权限（verbs）"><a href="#14-4-3-操作权限（verbs）" class="headerlink" title="14.4.3. 操作权限（verbs）"></a>14.4.3. 操作权限（verbs）</h5><p><code>verbs</code> 指定用户对资源的操作权限，包括：</p>
<ul>
<li><code>*</code> -&gt; 所有权限</li>
<li><code>get</code> → 获取资源信息。</li>
<li><code>list</code> → 列出资源列表。</li>
<li><code>watch</code> → 监听资源变化。</li>
<li><code>create</code> → 创建资源。</li>
<li><code>update</code> → 修改资源。</li>
<li><code>patch</code> → 部分修改资源。</li>
<li><code>delete</code> → 删除资源。</li>
<li><code>deletecollection</code> → 批量删除资源。</li>
<li><code>impersonate</code> → 模拟其他用户执行操作。</li>
<li><code>use</code> → 使用指定资源。</li>
<li><code>bind</code> → 将角色绑定到用户或组。</li>
</ul>
<hr>
<h4 id="14-5-补充：RoleBinding-资源的写法"><a href="#14-5-补充：RoleBinding-资源的写法" class="headerlink" title="14.5. 补充：RoleBinding 资源的写法"></a>14.5. 补充：RoleBinding 资源的写法</h4><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> rbac.authorization.k8s.io<span class="hljs-symbol">/v1</span><br><span class="hljs-params">kind:</span> RoleBinding<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> alice-pod-reader<br>  <span class="hljs-params">namespace:</span> frontend                      <span class="hljs-comment"># 指定作用的命名空间</span><br><span class="hljs-params">subjects:</span>                                  <span class="hljs-comment"># 授权的用户、组或 ServiceAccount</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">kind:</span> User                             <span class="hljs-comment"># 类型：用户</span><br>    <span class="hljs-params">name:</span> alice                            <span class="hljs-comment"># 授权给 alice 用户（与 kubeconfig 中的 CN 一致）</span><br>    <span class="hljs-params">apiGroup:</span> rbac.authorization.k8s.io    <span class="hljs-comment"># 指定 RBAC API 组</span><br><span class="hljs-params">roleRef:</span>                                   <span class="hljs-comment"># 引用已有的 Role</span><br>  <span class="hljs-params">kind:</span> Role                               <span class="hljs-comment"># 引用角色的类型</span><br>  <span class="hljs-params">name:</span> pod-reader                         <span class="hljs-comment"># 引用的 Role 名称（需已存在）</span><br>  <span class="hljs-params">apiGroup:</span> rbac.authorization.k8s.io      <span class="hljs-comment"># 指定 RBAC API 组</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项：</p>
<ol>
<li><font color="#00b0f0">apiGroup</font>：<ul>
<li>Kubernetes 中可能存在多种授权模型（如 ABAC、RBAC 等），这里的 <code>apiGroup: rbac.authorization.k8s.io</code> 是为了明确告诉 Kubernetes：我要绑定 RBAC 模型下的角色。</li>
</ul>
</li>
<li><font color="#00b0f0">subjects.kind</font>：<ul>
<li><font color="#7030a0">User</font>：授权给用户</li>
<li><font color="#7030a0">Group</font>：授权给用户组</li>
<li><font color="#7030a0">ServiceAccount</font>：授权给 Service Account</li>
</ul>
</li>
<li><font color="#00b0f0">roleRef.apiGroup</font>：<ul>
<li><font color="#7030a0">Role</font>：单个命名空间下的权限配置</li>
<li><font color="#7030a0">ClusterRole</font>：全集群范围下的权限配置</li>
</ul>
</li>
</ol>
</blockquote>
<hr>
<h4 id="14-6-补充：ClusterRole-资源的写法"><a href="#14-6-补充：ClusterRole-资源的写法" class="headerlink" title="14.6. 补充：ClusterRole 资源的写法"></a>14.6. 补充：ClusterRole 资源的写法</h4><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> rbac.authorization.k8s.io<span class="hljs-symbol">/v1</span><br><span class="hljs-params">kind:</span> ClusterRole<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> cluster-pod-reader<br><span class="hljs-params">rules:</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]<br>    <span class="hljs-params">resources:</span> [<span class="hljs-string">&quot;pods&quot;</span>]<br>    <span class="hljs-params">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>]<br>  <span class="hljs-operator">-</span> <span class="hljs-params">apiGroups:</span> [<span class="hljs-string">&quot;apps&quot;</span>]<br>    <span class="hljs-params">resources:</span> [<span class="hljs-string">&quot;deployments&quot;</span>, <span class="hljs-string">&quot;statefulsets&quot;</span>]<br>    <span class="hljs-params">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>]<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>无需指定 <code>namespace</code>，因为 <code>ClusterRole</code> 是集群级别的角色，作用于全集群和所有命名空间。</li>
</ol>
</blockquote>
<hr>
<h4 id="14-7-补充：ClusterRoleBinding-资源的写法"><a href="#14-7-补充：ClusterRoleBinding-资源的写法" class="headerlink" title="14.7. 补充：ClusterRoleBinding 资源的写法"></a>14.7. 补充：ClusterRoleBinding 资源的写法</h4><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> rbac.authorization.k8s.io<span class="hljs-symbol">/v1</span><br><span class="hljs-params">kind:</span> ClusterRoleBinding<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> alice-cluster-admin<br><span class="hljs-params">subjects:</span>                                 <span class="hljs-comment"># 授权的用户、组或 ServiceAccount</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">kind:</span> User                            <span class="hljs-comment"># 类型：用户</span><br>    <span class="hljs-params">name:</span> alice                           <span class="hljs-comment"># 授权给 alice 用户（与 kubeconfig 中的 CN 一致）</span><br>    <span class="hljs-params">apiGroup:</span> rbac.authorization.k8s.io   <span class="hljs-comment"># 指定 RBAC API 组</span><br><span class="hljs-params">roleRef:</span>                                  <span class="hljs-comment"># 引用已有的 ClusterRole</span><br>  <span class="hljs-params">kind:</span> ClusterRole                       <span class="hljs-comment"># 引用角色的类型</span><br>  <span class="hljs-params">name:</span> cluster-admin                     <span class="hljs-comment"># 引用的 ClusterRole 名称（必须已经存在）</span><br>  <span class="hljs-params">apiGroup:</span> rbac.authorization.k8s.io     <span class="hljs-comment"># 指定 RBAC API 组</span><br></code></pre></td></tr></table></figure>

<hr>
<h1 id="二、实操"><a href="#二、实操" class="headerlink" title="二、实操"></a>二、实操</h1><h3 id="1-环境准备"><a href="#1-环境准备" class="headerlink" title="1. 环境准备"></a>1. 环境准备</h3><h4 id="1-1-节点规划"><a href="#1-1-节点规划" class="headerlink" title="1.1. 节点规划"></a>1.1. 节点规划</h4><table>
<thead>
<tr>
<th>IP</th>
<th>主机名</th>
<th>硬件要求</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.136.8</td>
<td>k8s-master1</td>
<td>内存：2GB、CPU：2、硬盘：30GB</td>
</tr>
<tr>
<td>192.168.136.9</td>
<td>k8s-master2</td>
<td>内存：2GB、CPU：2、硬盘：30GB</td>
</tr>
<tr>
<td>192.168.136.10</td>
<td>k8s-worker1</td>
<td>内存：2GB、CPU：2、硬盘：30GB</td>
</tr>
<tr>
<td>192.168.136.11</td>
<td>k8s-worker2</td>
<td>内存：2GB、CPU：2、硬盘：30GB</td>
</tr>
<tr>
<td>192.168.136.53</td>
<td>bind-dns</td>
<td></td>
</tr>
<tr>
<td>192.168.136.12</td>
<td>keepalived1</td>
<td></td>
</tr>
<tr>
<td>192.168.136.13</td>
<td>keepalived2</td>
<td></td>
</tr>
<tr>
<td>192.168.136.14</td>
<td>haproxy1</td>
<td></td>
</tr>
<tr>
<td>192.168.136.15</td>
<td>haproxy2</td>
<td></td>
</tr>
</tbody></table>
<hr>
<h4 id="1-2-软件版本"><a href="#1-2-软件版本" class="headerlink" title="1.2. 软件版本"></a>1.2. 软件版本</h4><table>
<thead>
<tr>
<th>名称</th>
<th>版本</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Ubuntu</strong></td>
<td>24.04</td>
</tr>
<tr>
<td><strong>Containerd</strong></td>
<td>1.7.22</td>
</tr>
<tr>
<td><strong>Kubeadm</strong></td>
<td>1.28.2</td>
</tr>
<tr>
<td><strong>Kubelet</strong></td>
<td>1.28.2</td>
</tr>
<tr>
<td><strong>kubectl</strong></td>
<td>1.28.2</td>
</tr>
<tr>
<td><strong>Kubernetes</strong></td>
<td>1.28.2</td>
</tr>
<tr>
<td><strong>Calico</strong></td>
<td>3.28.2</td>
</tr>
</tbody></table>
<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>Kubeadm 和 Kubernetes 的版本最好一致</li>
</ol>
</blockquote>
<hr>
<h4 id="1-3-K8S-节点环境准备"><a href="#1-3-K8S-节点环境准备" class="headerlink" title="1.3. K8S 节点环境准备"></a>1.3. K8S 节点环境准备</h4><p>&#x3D;&#x3D;1.修改主机名&#x3D;&#x3D;</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dsconfig"><span class="hljs-string">hostnamectl</span> <span class="hljs-built_in">set-hostname</span> <span class="hljs-string">k8s-master1</span>        <span class="hljs-comment"># 根据上表配置主机名</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;4.编辑本地名称解析文件&#x3D;&#x3D;</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"># <span class="hljs-number">1</span>. 编辑文件<br>sudo vim /etc/hosts<br><br><br># <span class="hljs-number">2</span>. 添加内容  之类的？<br><span class="hljs-number">127.0.0.1</span> localhost xxxxx<br><span class="hljs-number">192.168.136.100</span> k8s-vip<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;5.关闭防火墙&#x3D;&#x3D;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> ufw <span class="hljs-built_in">disable</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;6.关闭 Swap 分区&#x3D;&#x3D;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> swapoff -a &amp;&amp; <span class="hljs-built_in">sudo</span> sed -i <span class="hljs-string">&#x27;/swap/s/^/#/&#x27;</span> /etc/fstab<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;7.配置内核转发&#x3D;&#x3D;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">EOF | sudo tee /etc/modules-load.d/k8s.conf </span><br><span class="hljs-string">overlay</span><br><span class="hljs-string">br_netfilter</span><br><span class="hljs-string">EOF</span><br><br><span class="hljs-built_in">sudo</span> modprobe overlay &amp;&amp; <span class="hljs-built_in">sudo</span> modprobe br_netfilter<br><br><span class="hljs-comment"># 查看是否加载</span><br>lsmod | grep br_netfilter<br><br><span class="hljs-comment"># 示例输出</span><br>user@k8s-master1:~$ lsmod | grep br_netfilter<br>br_netfilter           32768  0<br>bridge                421888  1 br_netfilter<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;8.配置网桥过滤&#x3D;&#x3D;</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">cat</span> &lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.<span class="hljs-keyword">conf</span><br>net.bridge.bridge-nf-<span class="hljs-keyword">call</span>-ip6tables = <span class="hljs-number">1</span><br>net.bridge.bridge-nf-<span class="hljs-keyword">call</span>-iptables = <span class="hljs-number">1</span><br>net.ipv4.ip_forward = <span class="hljs-number">1</span><br>net.ipv6.<span class="hljs-keyword">conf</span>.<span class="hljs-keyword">all</span>.forwarding=<span class="hljs-number">1</span><br><span class="hljs-keyword">vm</span>.swappiness = <span class="hljs-number">0</span><br>EOF<br><br>sudo sysctl --<span class="hljs-built_in">system</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>无需过于关注此命令的细节，关键是要知道它确保 Kubernetes 集群中的容器网络得到正确管理，从而实现容器之间的安全、顺畅通信。</li>
</ol>
</blockquote>
<p>&#x3D;&#x3D;9.安装 ipset 及 ipvsadm&#x3D;&#x3D;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. 安装 ipset 及 ipvsadm</span><br><span class="hljs-built_in">sudo</span> apt-get install -y ipset ipvsadm<br><br><br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">tee</span> /etc/modules-load.d/ipvs.conf &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">ip_vs</span><br><span class="hljs-string">ip_vs_lc</span><br><span class="hljs-string">ip_vs_wlc</span><br><span class="hljs-string">ip_vs_rr</span><br><span class="hljs-string">ip_vs_wrr</span><br><span class="hljs-string">ip_vs_lblc</span><br><span class="hljs-string">ip_vs_lblcr</span><br><span class="hljs-string">ip_vs_dh</span><br><span class="hljs-string">ip_vs_sh</span><br><span class="hljs-string">ip_vs_fo</span><br><span class="hljs-string">ip_vs_nq</span><br><span class="hljs-string">ip_vs_sed</span><br><span class="hljs-string">ip_vs_ftp</span><br><span class="hljs-string">nf_conntrack</span><br><span class="hljs-string">ip_tables</span><br><span class="hljs-string">ip_set</span><br><span class="hljs-string">xt_set</span><br><span class="hljs-string">ipt_set</span><br><span class="hljs-string">ipt_rpfilter</span><br><span class="hljs-string">ipt_REJECT</span><br><span class="hljs-string">ipip</span><br><span class="hljs-string">EOF</span><br><br><span class="hljs-built_in">sudo</span> systemctl restart systemd-modules-load.service &amp;&amp; <span class="hljs-built_in">sudo</span> systemctl <span class="hljs-built_in">enable</span>  systemd-modules-load.service<br></code></pre></td></tr></table></figure>



<p>&#x3D;&#x3D;8.安装容器运行时（Containerd）&#x3D;&#x3D;<br>从 Kubernetes 1.28 开始，<code>dockershim</code> 已经被移除，因此 <code>kubeadm</code> 无法使用 Docker 作为容器运行时。如果你希望继续使用 Docker，你需要明确地安装并启用正确的容器运行时，或者切换到使用 <code>containerd</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. 设置 Containerd 版本号环境变量</span><br>CONTAINERD_VERSION=1.7.22<br><br><br><span class="hljs-comment"># 2. 下载 Containerd 安装包（下载地址是经过代理的 GitHub 加速链接。）</span><br><span class="hljs-built_in">sudo</span> wget https://hub.openeeds.com/https://github.com/containerd/containerd/releases/download/v<span class="hljs-variable">$CONTAINERD_VERSION</span>/cri-containerd-cni-<span class="hljs-variable">$CONTAINERD_VERSION</span>-linux-amd64.tar.gz<br><br><br><span class="hljs-comment"># 3. 解压并安装 Containerd</span><br><span class="hljs-built_in">sudo</span> tar -zxvf cri-containerd-cni-<span class="hljs-variable">$CONTAINERD_VERSION</span>-linux-amd64.tar.gz -C /<br><br><br><span class="hljs-comment"># 4. 创建配置文件目录</span><br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">mkdir</span> -p /etc/containerd<br><br><br><span class="hljs-comment"># 5. 生成默认配置文件</span><br><span class="hljs-built_in">sudo</span> containerd config default | <span class="hljs-built_in">sudo</span> <span class="hljs-built_in">tee</span> /etc/containerd/config.toml &gt; /dev/null<br><br><br><span class="hljs-comment"># 6. 修改默认配置参数</span><br><span class="hljs-comment"># 6.1. 启用 Systemd 管理 Cgroup</span><br>sed -i <span class="hljs-string">&#x27;/SystemdCgroup/s/=\(.*\)/= true/g&#x27;</span> /etc/containerd/config.toml <br><br><span class="hljs-comment"># 6.2. 将 Pause:3.8 替换成 Pause:3.9</span><br>sed -i <span class="hljs-string">&#x27;/sandbox_image/s/=\(.*\)/= &quot;registry.aliyuncs.com\/google_containers\/pause:3.9&quot;/g&#x27;</span> /etc/containerd/config.toml <br><br><br><span class="hljs-comment"># 6.3. 手动修改镜像加速地址（DockerHub 源）</span><br><span class="hljs-built_in">sudo</span> vim /etc/containerd/config.toml <br><br>[plugins.<span class="hljs-string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors]<br>  [plugins.<span class="hljs-string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors.<span class="hljs-string">&quot;docker.io&quot;</span>]<br>    endpoint = [<span class="hljs-string">&quot;https://docker.m.daocloud.io&quot;</span>]<br><br><br><span class="hljs-comment"># 6.4. 配置 Containerd 代理</span><br>..........                            <span class="hljs-comment"># 遵纪守法，这里不展示</span><br><br><br><span class="hljs-comment"># 6.5. 重启并开机启动 containerd</span><br><span class="hljs-built_in">sudo</span> systemctl restart containerd &amp;&amp; <span class="hljs-built_in">sudo</span> systemctl <span class="hljs-built_in">enable</span> containerd<br></code></pre></td></tr></table></figure>

<p><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9AK8s/image-20250402174618934.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>如果镜像的源 不是 <code>docker.io</code>，那么你在 <code>containerd</code> 里配置的 <code>docker.io</code> 加速镜像是 <strong>无效</strong> 的。</li>
</ol>
</blockquote>
<p>&#x3D;&#x3D;9.配置 crictl 客户端&#x3D;&#x3D;<br><code>crictl</code> 是 Kubernetes 官方提供的命令行工具，用于直接操作容器运行时</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. 编辑配置文件</span><br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;runtime-endpoint: unix:///run/containerd/containerd.sock\nimage-endpoint: unix:///run/containerd/containerd.sock\ntimeout: 10\ndebug: false&quot;</span> | <span class="hljs-built_in">sudo</span> <span class="hljs-built_in">tee</span> /etc/crictl.yaml<br><br><br><span class="hljs-comment"># 2. 重启 containerd 服务</span><br><span class="hljs-built_in">sudo</span> systemctl daemon-reload &amp;&amp; systemctl restart containerd &amp;&amp; <span class="hljs-built_in">sudo</span> systemctl <span class="hljs-built_in">enable</span> containerd<br><br><br><span class="hljs-comment"># 3. 测试 containerd 是否正常工作</span><br><span class="hljs-built_in">sudo</span> crictl images<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;9.安装 kubeadm 等组件&#x3D;&#x3D;</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># 1. 导入 Kubernetes GPG 公钥（用于软件包签名验证）</span><br><span class="hljs-attribute">curl</span> -s https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  | sudo apt-key add -<br><br><br><span class="hljs-comment"># 2. 添加 Kubernetes 阿里云镜像源</span><br><span class="hljs-attribute">echo</span> <span class="hljs-string">&quot;deb https://mirrors.aliyun.com/kubernetes/apt/  kubernetes-xenial main&quot;</span> <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  | sudo tee /etc/apt/sources.list.d/kubernetes.list<br><br><br><span class="hljs-comment"># 3. 更新源并安装指定版本组件</span><br><span class="hljs-attribute">sudo</span> apt-get update &amp;&amp; sudo apt-get install -y <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  kubeadm=<span class="hljs-number">1</span>.<span class="hljs-number">28</span>.<span class="hljs-number">2</span>-<span class="hljs-number">00</span> <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  kubelet=<span class="hljs-number">1</span>.<span class="hljs-number">28</span>.<span class="hljs-number">2</span>-<span class="hljs-number">00</span> <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  kubectl=<span class="hljs-number">1</span>.<span class="hljs-number">28</span>.<span class="hljs-number">2</span>-<span class="hljs-number">00</span><br><br><br><span class="hljs-comment"># 4. 锁定版本，防止系统自动升级</span><br><span class="hljs-attribute">sudo</span> apt-mark hold kubelet kubeadm kubectl<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;10.配置kubelet&#x3D;&#x3D;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. 配置 kubelet 的 cgroup 驱动为 `systemd`</span><br><span class="hljs-built_in">cat</span> &gt; /etc/default/kubelet &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">KUBELET_EXTRA_ARGS=&quot;--cgroup-driver=systemd&quot;</span><br><span class="hljs-string">EOF</span><br><br><br><span class="hljs-comment"># 2. 重启并开机启动 containerd</span><br><span class="hljs-built_in">sudo</span> systemctl restart containerd &amp;&amp; <span class="hljs-built_in">sudo</span> systemctl <span class="hljs-built_in">enable</span> containerd<br></code></pre></td></tr></table></figure>

<hr>
<h4 id="1-4-Keepalived-节点环境准备"><a href="#1-4-Keepalived-节点环境准备" class="headerlink" title="1.4. Keepalived 节点环境准备"></a>1.4. Keepalived 节点环境准备</h4><p>Keepalived 节点无需任何准备，进行完 Ubuntu 初始化即可，但是 Keepalived 绑定 VIP 的服务器（Haproxy），必须进行下面的操作：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> apt install -y conntrack libseccomp2<br></code></pre></td></tr></table></figure>

<hr>
<h4 id="1-5-Haproxy-节点环境准备"><a href="#1-5-Haproxy-节点环境准备" class="headerlink" title="1.5. Haproxy 节点环境准备"></a>1.5. Haproxy 节点环境准备</h4><p>Haproxy 节点无需任何准备，进行完 Ubuntu 初始化即可</p>
<hr>
<h3 id="2-部署-Keepalived-集群"><a href="#2-部署-Keepalived-集群" class="headerlink" title="2. 部署 Keepalived 集群"></a>2. 部署 Keepalived 集群</h3><p>&#x3D;&#x3D;1.安装 Keepalived&#x3D;&#x3D;</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">sudo apt-<span class="hljs-built_in">get</span> install -y keepalived<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;2.编辑配置文件&#x3D;&#x3D;</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"># <span class="hljs-number">1.</span> 编辑 Keepalived 配置文件<br>sudo vim /etc/keepalived/keepalived.conf<br><br><br># <span class="hljs-number">2.</span> 添加以下内容<br>vrrp_script chk_haproxy1 &#123;<br>    script <span class="hljs-string">&quot;/bin/bash -c &#x27;echo &gt; /dev/tcp/192.168.136.14/16443&#x27;&quot;</span><br>    <span class="hljs-built_in">int</span>erval <span class="hljs-number">2</span><br>    weight <span class="hljs-number">-2</span><br>&#125;<br><br>vrrp_script chk_haproxy2 &#123;<br>    script <span class="hljs-string">&quot;/bin/bash -c &#x27;echo &gt; /dev/tcp/192.168.136.15/16443&#x27;&quot;</span><br>    <span class="hljs-built_in">int</span>erval <span class="hljs-number">2</span><br>    weight <span class="hljs-number">-2</span><br>&#125;<br><br>vrrp_instance VI_1 &#123;<br>    state MASTER                               # 主就写 Master，从就写 BACKUP<br>    <span class="hljs-keyword">interface</span> <span class="hljs-symbol">ens33</span><br>    <span class="hljs-symbol">virtual_router_id</span> <span class="hljs-symbol">51</span><br>    <span class="hljs-symbol">priority</span> <span class="hljs-symbol">100</span>                               # 主就写 <span class="hljs-symbol">100</span>，从就稍微低点 <span class="hljs-symbol">90</span><br>    <span class="hljs-symbol">advert_int</span> <span class="hljs-symbol">1</span><br><br>    <span class="hljs-symbol">authentication</span> &#123;<br>        auth_type PASS<br>        auth_pass wq666666<br>    &#125;<br><br>    virtual_ipaddress &#123;<br>        <span class="hljs-number">192.168</span><span class="hljs-number">.136</span><span class="hljs-number">.100</span>/<span class="hljs-number">24</span><br>    &#125;<br><br>    track_script &#123;<br>        chk_haproxy1<br>        chk_haproxy2<br>    &#125;<br>&#125;<br><br><br># <span class="hljs-number">3.</span> 重启和开机自启动 Keepalived<br>sudo systemctl start keepalived &amp;&amp; sudo systemctl enable keepalived<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;3.检查 Keepalived 状态&#x3D;&#x3D;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> systemctl status keepalived<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="3-部署-Haproxy-集群"><a href="#3-部署-Haproxy-集群" class="headerlink" title="3. 部署 Haproxy 集群"></a>3. 部署 Haproxy 集群</h3><p>&#x3D;&#x3D;1.安装 Haproxy&#x3D;&#x3D;</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">sudo apt-<span class="hljs-built_in">get</span> install -y haproxy<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;2.配置配置文件&#x3D;&#x3D;</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># 1. 编辑 Haproxy 配置文件</span><br><span class="hljs-attribute">sudo</span> vim /etc/haproxy/haproxy.cfg<br><br><br><span class="hljs-comment"># 2. 写入以下内容（）</span><br><span class="hljs-comment">#---------------------------------------------------------------------</span><br><span class="hljs-comment"># Global settings</span><br><span class="hljs-comment">#---------------------------------------------------------------------</span><br><span class="hljs-attribute">global</span><br>    <span class="hljs-comment"># 日志配置（需配置 rsyslog 接收 local2）</span><br>    <span class="hljs-attribute">log</span>         <span class="hljs-number">127.0.0.1</span> local2<br>    <span class="hljs-attribute">chroot</span>      /var/lib/haproxy<br>    <span class="hljs-attribute">pidfile</span>     /var/run/haproxy.pid<br>    <span class="hljs-attribute">maxconn</span>     <span class="hljs-number">4000</span><br>    <span class="hljs-attribute">user</span>        haproxy<br>    <span class="hljs-attribute">group</span>       haproxy<br>    <span class="hljs-attribute">daemon</span><br><br>    <span class="hljs-comment"># 开启本地统计 socket（供监控工具使用）</span><br>    <span class="hljs-attribute">stats</span> socket /var/lib/haproxy/stats<br><br><span class="hljs-comment">#---------------------------------------------------------------------</span><br><span class="hljs-comment"># 默认配置</span><br><span class="hljs-comment">#---------------------------------------------------------------------</span><br><span class="hljs-attribute">defaults</span><br>    <span class="hljs-attribute">mode</span>                    http<br>    <span class="hljs-attribute">log</span>                     global<br>    <span class="hljs-attribute">option</span>                  httplog<br>    <span class="hljs-attribute">option</span>                  dontlognull<br>    <span class="hljs-attribute">option</span>                  http-server-close<br>    <span class="hljs-attribute">option</span>                  redispatch<br>    <span class="hljs-attribute">retries</span>                 <span class="hljs-number">3</span><br>    <span class="hljs-attribute">timeout</span> http-request    <span class="hljs-number">10</span>s<br>    <span class="hljs-attribute">timeout</span> queue           <span class="hljs-number">1</span>m<br>    <span class="hljs-attribute">timeout</span> connect         <span class="hljs-number">10</span>s<br>    <span class="hljs-attribute">timeout</span> client          <span class="hljs-number">1</span>m<br>    <span class="hljs-attribute">timeout</span> server          <span class="hljs-number">1</span>m<br>    <span class="hljs-attribute">timeout</span> http-keep-alive <span class="hljs-number">10</span>s<br>    <span class="hljs-attribute">timeout</span> check           <span class="hljs-number">10</span>s<br>    <span class="hljs-attribute">maxconn</span>                 <span class="hljs-number">3000</span><br><br><span class="hljs-comment">#---------------------------------------------------------------------</span><br><span class="hljs-comment"># Kubernetes apiserver 前端配置，监听端口为 16443</span><br><span class="hljs-comment">#---------------------------------------------------------------------</span><br><span class="hljs-attribute">frontend</span> kubernetes-apiserver<br>    <span class="hljs-attribute">mode</span>            tcp<br>    <span class="hljs-attribute">bind</span>            *:<span class="hljs-number">16443</span><br>    <span class="hljs-attribute">option</span>          tcplog<br>    <span class="hljs-attribute">default_backend</span> kubernetes-apiserver<br><br><span class="hljs-comment">#---------------------------------------------------------------------</span><br><span class="hljs-comment"># Kubernetes apiserver 后端配置，使用轮询策略</span><br><span class="hljs-comment">#---------------------------------------------------------------------</span><br><span class="hljs-attribute">backend</span> kubernetes-apiserver<br>    <span class="hljs-attribute">mode</span>    tcp<br>    <span class="hljs-attribute">balance</span> roundrobin<br>    <span class="hljs-attribute">server</span>  master01.k8s.io <span class="hljs-number">192.168.136.8:6443</span> check inter <span class="hljs-number">2</span>s fall <span class="hljs-number">3</span> rise <span class="hljs-number">2</span><br>    <span class="hljs-attribute">server</span>  master02.k8s.io <span class="hljs-number">192.168.136.9:6443</span> check inter <span class="hljs-number">2</span>s fall <span class="hljs-number">3</span> rise <span class="hljs-number">2</span><br><br><span class="hljs-comment">#---------------------------------------------------------------------</span><br><span class="hljs-comment"># HAProxy 状态页面</span><br><span class="hljs-comment">#---------------------------------------------------------------------</span><br><span class="hljs-attribute">listen</span> stats<br>    <span class="hljs-attribute">bind</span>            *:<span class="hljs-number">1080</span><br>    <span class="hljs-attribute">stats</span> uri       /admin?stats<br>    <span class="hljs-attribute">stats</span> realm     HAProxy\\ Statistics<br>    <span class="hljs-attribute">stats</span> auth      admin:awesomePassword<br>    <span class="hljs-attribute">stats</span> refresh   <span class="hljs-number">5</span>s<br><span class="hljs-comment"># 这里需要补一个换行符，按一下 Enter 键 即可</span><br><br><br><br><span class="hljs-comment"># 3. 检查配置文件是否有语法错误</span><br><span class="hljs-attribute">haproxy</span> -c -f /etc/haproxy/haproxy.cfg<br><br><br><span class="hljs-comment"># 4. 重启和开机自启动 Haproxy</span><br><span class="hljs-attribute">sudo</span> systemctl start haproxy &amp;&amp; sudo systemctl enable haproxy<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;3.检查 Haproxy 状态&#x3D;&#x3D;</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-meta"># 1. 检查 Haproxy 状态</span><br>sudo systemctl status haproxy<br><br><br><span class="hljs-meta"># 2. 检查 Haproxy 监听的端口</span><br>netstat <span class="hljs-punctuation">-</span>lntup <span class="hljs-string">| grep haproxy</span><br><br><br><span class="hljs-meta"># 3. 访问 Haproxy 状态页面</span><br>http<span class="hljs-punctuation">:</span><span class="hljs-comment">//192.168.136.14:1080/admin?stats</span><br></code></pre></td></tr></table></figure>

<hr>
<h3 id="4-检查-VIP-是否正确绑定"><a href="#4-检查-VIP-是否正确绑定" class="headerlink" title="4. 检查 VIP 是否正确绑定"></a>4. 检查 VIP 是否正确绑定</h3><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">ip</span> <span class="hljs-keyword">addr</span> show<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="5-部署第一个-Master-节点"><a href="#5-部署第一个-Master-节点" class="headerlink" title="5. 部署第一个 Master 节点"></a>5. 部署第一个 Master 节点</h3><p>&#x3D;&#x3D;1.初始化控制平面&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-comment"># 1. 创建存放 K8S 配置的目录</span><br>sudo mkdir <span class="hljs-symbol">/usr/local/kubernetes/manifests</span> <span class="hljs-operator">-</span>p<br><br><br><span class="hljs-comment"># 2. 切换到刚刚创建的目录</span><br>cd <span class="hljs-operator">/</span>usr<span class="hljs-operator">/</span>local<span class="hljs-operator">/</span>kubernetes<span class="hljs-operator">/</span>manifests<span class="hljs-symbol">/</span><br><br><br><span class="hljs-comment"># 3. 查看 kubeadm 初始化时默认会用到哪些镜像</span><br>kubeadm config images list <span class="hljs-operator">-</span>-image-repository<span class="hljs-operator">=</span>registry.aliyuncs.com<span class="hljs-symbol">/google_containers</span><br><br><br><span class="hljs-comment"># 4. 获取当前 kubelet 的版本号</span><br>K<span class="hljs-attr">UBE_VERSION</span><span class="hljs-operator">=</span>$(kubelet <span class="hljs-operator">-</span>-version | awk &#x27;&#123;print $<span class="hljs-number">2</span>&#125;&#x27;)<br><br><br><span class="hljs-comment"># 5. 使用 crictl 工具批量拉取所有所需镜像</span><br>kubeadm config images list \<br>  <span class="hljs-operator">-</span>-image-repository<span class="hljs-operator">=</span>registry.aliyuncs.com<span class="hljs-symbol">/google_containers</span> \<br>  <span class="hljs-operator">-</span>-kubernetes-version<span class="hljs-operator">=</span>$KUBE_VERSION | xargs <span class="hljs-operator">-</span>n <span class="hljs-number">1</span> crictl pull<br><br><br><span class="hljs-comment"># 6. 查看已拉取的镜像，确认是否成功</span><br>sudo crictl images<br><br><br><span class="hljs-comment"># 7. 获取初始化默认配置中的 apiVersion，用于写入配置文件</span><br>A<span class="hljs-attr">PI_VERSION</span><span class="hljs-operator">=</span>$(kubeadm config print init-defaults | grep <span class="hljs-params">apiVersion:</span> | awk &#x27;NR<span class="hljs-operator">==</span><span class="hljs-number">1</span>&#x27;)<br><br><br><span class="hljs-comment"># 8. 再次获取 kubelet 的版本号，用于指定 Kubernetes 版本</span><br>K<span class="hljs-attr">UBE_VERSION</span><span class="hljs-operator">=</span>$(kubelet <span class="hljs-operator">-</span>-version | awk &#x27;&#123;print $<span class="hljs-number">2</span>&#125;&#x27;)<br><br><br><span class="hljs-comment"># 9. 创建 kubeadm 初始化所需的配置文件（kubeadm-config.yaml）</span><br>cat <span class="hljs-operator">&gt;</span> kubeadm-config.yaml <span class="hljs-operator">&lt;</span><span class="hljs-operator">&lt;</span>EOF<br>$API_VERSION<br><span class="hljs-params">kind:</span> ClusterConfiguration<br><span class="hljs-params">kubernetesVersion:</span> $KUBE_VERSION<br><span class="hljs-params">controlPlaneEndpoint:</span> <span class="hljs-string">&quot;192.168.136.100:6443&quot;</span><br><span class="hljs-params">imageRepository:</span> registry.aliyuncs.com<span class="hljs-symbol">/google_containers</span><br><span class="hljs-params">apiServer:</span><br>  <span class="hljs-params">certSANs:</span><br>  <span class="hljs-operator">-</span> <span class="hljs-string">&quot;k8s-vip&quot;</span><br>  <span class="hljs-operator">-</span> <span class="hljs-string">&quot;192.168.136.100&quot;</span><br>  <span class="hljs-operator">-</span> <span class="hljs-string">&quot;127.0.0.1&quot;</span><br>  <span class="hljs-operator">-</span> <span class="hljs-string">&quot;::1&quot;</span><br><span class="hljs-params">networking:</span><br>  <span class="hljs-params">dnsDomain:</span> cluster.local<br>  <span class="hljs-params">serviceSubnet:</span> <span class="hljs-number">10.96</span>.<span class="hljs-number">0.0</span><span class="hljs-symbol">/12</span><br>  <span class="hljs-params">podSubnet:</span> <span class="hljs-number">10.244</span>.<span class="hljs-number">0.0</span><span class="hljs-symbol">/16</span><br><span class="hljs-operator">-</span>--<br><span class="hljs-params">apiVersion:</span> kubeproxy.config.k8s.io<span class="hljs-symbol">/v1alpha1</span><br><span class="hljs-params">kind:</span> KubeProxyConfiguration<br><span class="hljs-params">mode:</span> ipvs<br>EOF<br><br><br><span class="hljs-comment"># 10. 使用指定的配置文件进行 Kubernetes 集群初始化</span><br>kubeadm init <span class="hljs-operator">-</span>-config kubeadm-config.yaml<br><br><span class="hljs-comment"># 查问题：</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项：</p>
<ol>
<li>如果初始化集群失败，我们可以：</li>
</ol>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. 查问题</span><br><span class="hljs-built_in">sudo</span> journalctl -u kubelet -f<br><br><span class="hljs-built_in">sudo</span> systemctl status kubelet<br><br><br><span class="hljs-comment"># 2. 清除相关文件和进程</span><br>kubeadm reset &amp;&amp; <span class="hljs-built_in">rm</span> -rf /etc/kubernetes/ &amp;&amp; <span class="hljs-built_in">rm</span> -rf /var/lib/cni &amp;&amp; <span class="hljs-built_in">rm</span> -rf /var/lib/kubelet &amp;&amp; <span class="hljs-built_in">rm</span> -rf /var/lib/etcd &amp;&amp; <span class="hljs-built_in">rm</span> -rf <span class="hljs-variable">$HOME</span>/.kube/config &amp;&amp; ipvsadm -C &amp;&amp; <span class="hljs-built_in">sudo</span> systemctl stop kubelet<br><br><br><span class="hljs-comment"># 3. 重新初始化</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;2.保存官方提示信息&#x3D;&#x3D;</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">Your Kubernetes control-plane has initialized successfully!<br><br>To <span class="hljs-built_in">start</span> <span class="hljs-keyword">using</span> your cluster, you need <span class="hljs-built_in">to</span> run <span class="hljs-keyword">the</span> following <span class="hljs-keyword">as</span> <span class="hljs-keyword">a</span> regular user:<br><br>  mkdir -p $HOME/.kube<br>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<br>  sudo chown $(id -u):$(id -g) $HOME/.kube/config<br><br>Alternatively, <span class="hljs-keyword">if</span> you are <span class="hljs-keyword">the</span> root user, you can run:<br><br>  export KUBECONFIG=/etc/kubernetes/admin.conf<br><br>You should now deploy <span class="hljs-keyword">a</span> pod network <span class="hljs-built_in">to</span> <span class="hljs-keyword">the</span> cluster.<br>Run <span class="hljs-string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> <span class="hljs-keyword">with</span> <span class="hljs-literal">one</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> options listed <span class="hljs-keyword">at</span>:<br>  <span class="hljs-keyword">https</span>://kubernetes.io/docs/concepts/cluster-administration/addons/<br><br>You can now join <span class="hljs-keyword">any</span> <span class="hljs-built_in">number</span> <span class="hljs-keyword">of</span> control-plane nodes <span class="hljs-keyword">by</span> copying certificate authorities<br><span class="hljs-keyword">and</span> service account <span class="hljs-built_in">keys</span> <span class="hljs-keyword">on</span> <span class="hljs-title">each</span> <span class="hljs-title">node</span> <span class="hljs-title">and</span> <span class="hljs-title">then</span> <span class="hljs-title">running</span> <span class="hljs-title">the</span> <span class="hljs-title">following</span> <span class="hljs-title">as</span> <span class="hljs-title">root</span>:<br><br>  kubeadm join <span class="hljs-number">192.168</span><span class="hljs-number">.136</span><span class="hljs-number">.100</span>:<span class="hljs-number">6443</span> <span class="hljs-comment">--token pgauot.eh1ad4drixh1z72b \</span><br>        <span class="hljs-comment">--discovery-token-ca-cert-hash sha256:3d27a9471694ab6159533f0d3ca0bc2ddffed8447358950f6732b0f10e770d70 \</span><br>        <span class="hljs-comment">--control-plane </span><br><br>Then you can join <span class="hljs-keyword">any</span> <span class="hljs-built_in">number</span> <span class="hljs-keyword">of</span> worker nodes <span class="hljs-keyword">by</span> running <span class="hljs-keyword">the</span> following <span class="hljs-keyword">on</span> <span class="hljs-title">each</span> <span class="hljs-title">as</span> <span class="hljs-title">root</span>:<br><br>kubeadm join <span class="hljs-number">192.168</span><span class="hljs-number">.136</span><span class="hljs-number">.100</span>:<span class="hljs-number">6443</span> <span class="hljs-comment">--token pgauot.eh1ad4drixh1z72b \</span><br>        <span class="hljs-comment">--discovery-token-ca-cert-hash sha256:3d27a9471694ab6159533f0d3ca0bc2ddffed8447358950f6732b0f10e770d70 </span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;3.配置 kubectl 的访问凭据&#x3D;&#x3D;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. 创建 .kube 目录（用于存放 kubectl 的配置文件）</span><br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$HOME</span>/.kube<br><br><br><span class="hljs-comment"># 2. 复制 kubeadm 初始化生成的管理员配置文件到当前用户目录</span><br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">cp</span> -i /etc/kubernetes/admin.conf  <span class="hljs-variable">$HOME</span>/.kube/config<br><br><br><span class="hljs-comment"># 3. 更改该配置文件的所有者为当前用户（否则你访问时可能会权限不足）</span><br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">chown</span> $(<span class="hljs-built_in">id</span> -u):$(<span class="hljs-built_in">id</span> -g) <span class="hljs-variable">$HOME</span>/.kube/config<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;4.calico 网络插件部署&#x3D;&#x3D;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. 设置 Calico 版本为 v3.28.2</span><br>CALICO_VERSION=v3.28.2<br><br><br><span class="hljs-comment"># 2. 从 OpenNeeds 镜像仓库下载指定版本的 Calico 配置文件</span><br><span class="hljs-built_in">sudo</span> wget https://hub.openeeds.com/https://raw.githubusercontent.com/projectcalico/calico/<span class="hljs-variable">$CALICO_VERSION</span>/manifests/calico.yaml<br><br><br><span class="hljs-comment"># 3. 替换 yaml 文件中的镜像源，将所有的 docker.io 替换为 hub.openeeds.com</span><br><span class="hljs-built_in">sudo</span> sed -i <span class="hljs-string">&#x27;s/docker.io/hub.openeeds.com/g&#x27;</span> calico.yaml<br><br><br><span class="hljs-comment"># 4. 从 OpenNeeds 镜像仓库拉取所有涉及的 Calico 镜像</span><br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">cat</span> calico.yaml | grep hub.openeeds.com | sed <span class="hljs-string">&#x27;s/          image://g&#x27;</span> | xargs -n 1 crictl pull<br><br><br><span class="hljs-comment"># 5. 使用 kubectl 应用 Calico 配置文件，部署 Calico 网络插件</span><br>kubectl apply -f calico.yaml<br><br><br><span class="hljs-comment"># 6. 查看 Calico 是否成功部署</span><br>kubectl get pod -n kube-system<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="6-部署其他-Master-节点"><a href="#6-部署其他-Master-节点" class="headerlink" title="6. 部署其他 Master 节点"></a>6. 部署其他 Master 节点</h3><p>&#x3D;&#x3D;1.复制 Kubernetes 集群配置和证书到其他节点&#x3D;&#x3D;<br>以下命令需要在第一个 Master 节点（192.168.136.9）上执行</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs elixir">ssh root<span class="hljs-variable">@192</span>.<span class="hljs-number">168.136</span>.<span class="hljs-number">9</span> mkdir -p /etc/kubernetes/pki/etcd<br><br>scp /etc/kubernetes/admin.conf root<span class="hljs-variable">@192</span>.<span class="hljs-number">168.136</span>.<span class="hljs-number">9</span><span class="hljs-symbol">:/etc/kubernetes</span><br><br>scp /etc/kubernetes/pki/&#123;ca.*,sa.*,front-proxy-ca.*&#125; root<span class="hljs-variable">@192</span>.<span class="hljs-number">168.136</span>.<span class="hljs-number">9</span><span class="hljs-symbol">:/etc/kubernetes/pki</span><br><br>scp /etc/kubernetes/pki/etcd/ca.* root<span class="hljs-variable">@192</span>.<span class="hljs-number">168.136</span>.<span class="hljs-number">9</span><span class="hljs-symbol">:/etc/kubernetes/pki/etcd</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;2.加入到集群&#x3D;&#x3D;<br>在保存信息中，加上 <code>--control-plane</code> 参数，表明这是一个 master</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">kubeadm</span> join <span class="hljs-number">192.168.136.100:6443</span> --token pgauot.eh1ad4drixh1z72b <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>      --discovery-token-ca-cert-hash sha256:<span class="hljs-number">3</span>d27a9471694ab6159533f0d3ca0bc2ddffed8447358950f6732b0f10e770d70 <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>      --control-plane <br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;3.配置 kubectl 的访问凭据&#x3D;&#x3D;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. 创建 .kube 目录（用于存放 kubectl 的配置文件）</span><br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$HOME</span>/.kube<br><br><br><span class="hljs-comment"># 2. 复制 kubeadm 初始化生成的管理员配置文件到当前用户目录</span><br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">cp</span> -i /etc/kubernetes/admin.conf  <span class="hljs-variable">$HOME</span>/.kube/config<br><br><br><span class="hljs-comment"># 3. 更改该配置文件的所有者为当前用户（否则你访问时可能会权限不足）</span><br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">chown</span> $(<span class="hljs-built_in">id</span> -u):$(<span class="hljs-built_in">id</span> -g) <span class="hljs-variable">$HOME</span>/.kube/config<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="7-部署-Node-节点"><a href="#7-部署-Node-节点" class="headerlink" title="7. 部署 Node 节点"></a>7. 部署 Node 节点</h3><p>在保存信息中，不加 <code>--control-plane</code> 参数，表明这是一个 node</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">kubeadm</span> join <span class="hljs-number">192.168.136.100:6443</span> --token pgauot.eh1ad4drixh1z72b <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>        --discovery-token-ca-cert-hash sha256:<span class="hljs-number">3</span>d27a9471694ab6159533f0d3ca0bc2ddffed8447358950f6732b0f10e770d70 <br></code></pre></td></tr></table></figure>

<hr>
<h1 id="三、工具"><a href="#三、工具" class="headerlink" title="三、工具"></a>三、工具</h1><h3 id="1-cAdvisor"><a href="#1-cAdvisor" class="headerlink" title="1. cAdvisor"></a>1. cAdvisor</h3><hr>
<h1 id="三、补充"><a href="#三、补充" class="headerlink" title="三、补充"></a>三、补充</h1><h3 id="1-Kubectl-命令"><a href="#1-Kubectl-命令" class="headerlink" title="1. Kubectl 命令"></a>1. Kubectl 命令</h3><p>&#x3D;&#x3D;1.创建资源&#x3D;&#x3D;</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 1. 创建单个 Pod（内部只有一个容器）</span><br>kubectl <span class="hljs-built_in">run</span> &lt;pod-name&gt; <span class="hljs-attribute">--image</span>=&lt;image&gt;<br><br><br><span class="hljs-comment"># 2. 根据 yaml 创建资源</span><br> kubectl apply -f resource.yaml<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;2.删除资源&#x3D;&#x3D;</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs vim"># <span class="hljs-number">1</span>. 根据资源名称删除资源<br>kubectl <span class="hljs-keyword">delete</span> <span class="hljs-symbol">&lt;resource-type&gt;</span> <span class="hljs-symbol">&lt;resource-name&gt;</span> -n <span class="hljs-symbol">&lt;namespace&gt;</span><br><br><br># <span class="hljs-number">2</span>. 根据标签删除资源（只要有该标签的资源，都会被删除）<br>kubectl <span class="hljs-keyword">delete</span>&lt;resource-<span class="hljs-built_in">type</span> -<span class="hljs-keyword">l</span> <span class="hljs-symbol">&lt;label-key&gt;</span>=<span class="hljs-symbol">&lt;label-value&gt;</span> -n <span class="hljs-symbol">&lt;namespace&gt;</span><br><br><br># <span class="hljs-number">3</span>. 根据 yaml 删除资源<br>kubectl <span class="hljs-keyword">delete</span> -<span class="hljs-keyword">f</span> /path/<span class="hljs-keyword">to</span>/myFile.yaml<br><br><br># <span class="hljs-number">4</span>. 删除某命名空间下的所有 pod<br>kubectl <span class="hljs-keyword">delete</span> pods --<span class="hljs-keyword">all</span> -n <span class="hljs-symbol">&lt;namespace&gt;</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项：</p>
<ol>
<li>Controller 可以附加参数 <code>--cascade=orphan</code>，表示仅删除 Controller 不删除关联的 Pod</li>
<li>可以附加参数 <code>--force --grace-period=0</code> ，表示强行删除</li>
</ol>
</blockquote>
<p>&#x3D;&#x3D;3.更新资源&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-comment"># 1. 简单更新（使用默认的编辑器编辑一个资源，重启后恢复原状态）</span><br>kubectl edit <span class="hljs-symbol">&lt;resource-type&gt;</span> <span class="hljs-symbol">&lt;resource-name&gt;</span> <span class="hljs-operator">-</span>n <span class="hljs-symbol">&lt;namespace&gt;</span><br><br><br><span class="hljs-comment"># 2. 复杂更新（修改 yaml 文件后重新 apply）</span><br>kubectl apply <span class="hljs-operator">-</span>f resource.yaml<br><br><br><span class="hljs-comment"># 3. 调整 Controller 管理的 Pod 数量</span><br>kubectl scale <span class="hljs-symbol">&lt;controller-type&gt;</span> <span class="hljs-symbol">&lt;controller-name&gt;</span> <span class="hljs-operator">-</span>n <span class="hljs-symbol">&lt;namespace&gt;</span> <span class="hljs-operator">-</span>-replicas<span class="hljs-operator">=</span><span class="hljs-symbol">&lt;number&gt;</span><br><br><br><span class="hljs-comment"># 4. 修改 Deployment 镜像（触发滚动更新）</span><br>kubectl set image deployment <span class="hljs-symbol">&lt;deployment-name&gt;</span> <span class="hljs-symbol">&lt;container-name&gt;</span><span class="hljs-operator">=</span><span class="hljs-symbol">&lt;new-image&gt;</span> <span class="hljs-operator">-</span>n <span class="hljs-symbol">&lt;namespace&gt;</span><br><br><br><span class="hljs-comment"># 5. 查看 Deployment 当前滚动更新状态</span><br>kubectl rollout status deployment <span class="hljs-symbol">&lt;deployment-name&gt;</span> <span class="hljs-operator">-</span>n <span class="hljs-symbol">&lt;namespace&gt;</span><br><br><br><span class="hljs-comment"># 6. 暂停 Deployment 滚动更新</span><br>kubectl rollout pause deployment <span class="hljs-symbol">&lt;deployment-name&gt;</span> <span class="hljs-operator">-</span>n <span class="hljs-symbol">&lt;namespace&gt;</span><br><br><br><span class="hljs-comment"># 7. 恢复 Deployment 滚动更新</span><br>kubectl rollout resume deployment <span class="hljs-symbol">&lt;deployment-name&gt;</span> <span class="hljs-operator">-</span>n <span class="hljs-operator">&lt;</span>amespace<br><br><br><span class="hljs-comment"># 8. 查看 Deployment 历史版本</span><br>kubectl rollout history deployment <span class="hljs-symbol">&lt;deployment-name&gt;</span> <span class="hljs-operator">-</span>n <span class="hljs-symbol">&lt;namespace&gt;</span><br><br><br><span class="hljs-comment"># 9. 回滚 Deployment 到上一个版本</span><br>kubectl rollout undo deployment <span class="hljs-symbol">&lt;deployment-name&gt;</span> <span class="hljs-operator">-</span>n <span class="hljs-symbol">&lt;namespace&gt;</span><br><br><br><span class="hljs-comment"># 10. 回滚 Deployment 到指定版本</span><br>kubectl rollout undo deployment <span class="hljs-symbol">&lt;deployment-name&gt;</span> <span class="hljs-operator">-</span>-to-revision<span class="hljs-operator">=</span><span class="hljs-symbol">&lt;revision-number&gt;</span> <span class="hljs-operator">-</span>n <span class="hljs-symbol">&lt;namespace&gt;</span><br><br><br><span class="hljs-comment"># 11. 强制重启 Deployment，触发滚动更新</span><br>kubectl rollout restart deployment <span class="hljs-symbol">&lt;deployment-name&gt;</span> <span class="hljs-operator">-</span>n <span class="hljs-symbol">&lt;namespace&gt;</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>对 <code>ReplicationController (RC)</code> 和 <code>ReplicaSet (RS)</code> 进行复杂更新时，新的 Pod 不会自动替换旧的 Pod，我们需要手动删除旧 Pod</li>
<li>但是对于 <code>Deployment</code> ，他会触发滚动更新，这些都不需要我们操心</li>
</ol>
</blockquote>
<p>&#x3D;&#x3D;4.查询资源&#x3D;&#x3D;</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs pf"><span class="hljs-comment"># 1. 获取资源概览信息（只显示核心字段，适用于快速查看资源状态）</span><br>kubectl get <span class="hljs-variable">&lt;resource-type&gt;</span> <span class="hljs-variable">&lt;resource-name&gt;</span> -o wide -n <span class="hljs-variable">&lt;namespace&gt;</span><br><br><br><span class="hljs-comment"># 2. 查看资源详细信息（显示完整的资源信息，适用于排查问题或查看详细配置）</span><br>kubectl describe <span class="hljs-variable">&lt;resource-type&gt;</span> <span class="hljs-variable">&lt;resource-name&gt;</span> -o wide -n <span class="hljs-variable">&lt;namespace&gt;</span><br><br><br><span class="hljs-comment"># 3. 查看某 namespace 下的所有资源</span><br>kubectl get <span class="hljs-literal">all</span> -n <span class="hljs-variable">&lt;namespace&gt;</span><br><br><br><span class="hljs-comment"># 4. 查看节点资源使用情况</span><br>kubectl top node<br><br><br><span class="hljs-comment"># 5. 查看 Pod 资源使用情况</span><br>kubectl top pod -n <span class="hljs-variable">&lt;namespace&gt;</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;5.执行命令到容器&#x3D;&#x3D;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. 模版</span><br>kubectl <span class="hljs-built_in">exec</span> &lt;pod-name&gt; -n &lt;namespace&gt; -- &lt;实际命令&gt;<br><br><br><span class="hljs-comment"># 2. 进入 Pod</span><br>kubectl <span class="hljs-built_in">exec</span> -it &lt;pod-name&gt; -- /bin/bash<br><br><br><span class="hljs-comment"># 3. 查看 Pod 内部的文件</span><br>kubectl <span class="hljs-built_in">exec</span> &lt;pod-name&gt; -- <span class="hljs-built_in">cat</span> /etc/hosts<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;6.节点相关命令&#x3D;&#x3D;</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs pf"><span class="hljs-comment"># 1. 查看 Node 列表（包含 Master 节点和 Worker 节点）</span><br>kubectl get nodes<br><br><br><span class="hljs-comment"># 2. 为 Node 节点添加 Label</span><br>kubectl <span class="hljs-keyword">label</span> nodes <span class="hljs-variable">&lt;node-name&gt;</span> <span class="hljs-variable">&lt;label-key&gt;</span>=<span class="hljs-variable">&lt;label-value&gt;</span><br><br><br><span class="hljs-comment"># 3. 为 Node 节点删除 Label</span><br>kubectl <span class="hljs-keyword">label</span> nodes <span class="hljs-variable">&lt;node-name&gt;</span> <span class="hljs-variable">&lt;label-key&gt;</span>-<br><br><br><span class="hljs-comment"># 4. 查看节点资源使用情况</span><br>kubectl top node<br><br><br><span class="hljs-comment"># 5. 查看 Node 节点详细信息（验证标签是否添加成功）</span><br>kubectl describe node <span class="hljs-variable">&lt;node-name&gt;</span><br><br><br><span class="hljs-comment"># 6. 将 Node 标记为不可调度（不会影响已运行的 Pod）</span><br>kubectl cordon <span class="hljs-variable">&lt;node-name&gt;</span><br><br><br><span class="hljs-comment"># 7. 将 Node 恢复为可调度</span><br>kubectl uncordon <span class="hljs-variable">&lt;node-name&gt;</span><br><br><br><span class="hljs-comment"># 8. 驱逐 Node 上的所有 Pod，并标记为不可调度</span><br>kubectl drain <span class="hljs-variable">&lt;node-name&gt;</span> --ignore-daemonsets --delete-emptydir-data<br><br><br><span class="hljs-comment"># 9. 为 Node 添加污点</span><br>kubectl taint nodes <span class="hljs-variable">&lt;node-name&gt;</span> <span class="hljs-variable">&lt;taint-key&gt;</span>=<span class="hljs-variable">&lt;taint-value&gt;</span>:<span class="hljs-variable">&lt;taint-effect&gt;</span><br><br><br><span class="hljs-comment"># 10. 为 Node 移除污点</span><br>kubectl taint nodes <span class="hljs-variable">&lt;node-name&gt;</span> <span class="hljs-variable">&lt;taint-key&gt;</span>-<br><br><br><span class="hljs-comment"># 11. 为 Node 移除所有污点</span><br>kubectl patch nodes <span class="hljs-variable">&lt;node-name&gt;</span> -p &#x27;&#123;<span class="hljs-string">&quot;spec&quot;</span>:&#123;<span class="hljs-string">&quot;taints&quot;</span>:[]&#125;&#125;&#x27;<br><br><br><span class="hljs-comment"># 12. 查看 Node 上的污点</span><br>kubectl get nodes <span class="hljs-variable">&lt;node-name&gt;</span> -o go-template=<span class="hljs-string">&quot;&#123;&#123;.spec.taints&#125;&#125;&quot;</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>[!NOTE] 注意事项：<code>taint-effect</code></p>
<ol>
<li><code>taint-effect</code> 表示排斥等级，主要有三种：<ul>
<li><font color="#00b0f0">NoSchedule</font>：<ul>
<li>调度器不会将不具备相应容忍度的 Pod 调度到该节点，但已经在该节点运行的 Pod 不受影响。</li>
</ul>
</li>
<li><font color="#00b0f0">PreferNoSchedule</font>：<ul>
<li>节点“建议”调度器不要将不具备相应容忍度的 Pod 调度到该节点，然而如果其他节点无法容纳，仍然可以将 Pod 调度到该节点</li>
</ul>
</li>
<li><font color="#00b0f0">NoExecute</font>：<ul>
<li>调度器不会将不具备相应容忍度的 Pod 调度到该节点，并且还会将已在该节点运行但不满足容忍度的 Pod 驱逐出去。</li>
<li>同时，还可以配置 <code>tolerationSeconds</code>，即使 Pod 已声明容忍该污点，也会在指定时间后被驱逐。</li>
</ul>
</li>
</ul>
</li>
</ol>
</blockquote>
<p>&#x3D;&#x3D;7.探针相关命令&#x3D;&#x3D;</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-comment"># 1. 查看探针状态</span><br>kubectl describe pod <span class="hljs-symbol">&lt;pod-name&gt;</span> <span class="hljs-operator">-</span>n <span class="hljs-symbol">&lt;namespace&gt;</span><br><br><br><span class="hljs-comment"># 2. 手动执行探针命令</span><br><span class="hljs-comment"># 2.1. 进入 Pod 内部</span><br>kubectl exec <span class="hljs-operator">-</span>it <span class="hljs-symbol">&lt;pod-name&gt;</span> <span class="hljs-operator">-</span>- <span class="hljs-symbol">/bin/sh</span><br><br><span class="hljs-comment"># 2.2. exec 探针</span><br><span class="hljs-symbol">/bin/sh</span> <span class="hljs-operator">-</span>c <span class="hljs-string">&quot;your_probe_command&quot;</span><br><br><span class="hljs-comment"># 2.3. HTTP 探针</span><br>curl <span class="hljs-operator">-</span>v http:<span class="hljs-operator">//</span>localhost:<span class="hljs-number">8080</span><span class="hljs-symbol">/health</span><br><br><span class="hljs-comment"># 2.4. TCP 探针</span><br><span class="hljs-params">nc:</span> connect to localhost port <span class="hljs-number">8080</span> (tcp) <span class="hljs-params">failed:</span> Connection refused<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;8.注意事项&#x3D;&#x3D;</p>
<ol>
<li>如果未指定 namespace，会使用当前上下文指定的 namespace</li>
<li>对于 <code>resource-type resource-name</code> 这种的，如果没指定 <code>resource-name</code> 会作用于全部 <code>resource-type</code> 的资源</li>
</ol>
<hr>
<h3 id="2-操作符-operator"><a href="#2-操作符-operator" class="headerlink" title="2. 操作符 operator"></a>2. 操作符 operator</h3><p><code>operator</code> 字段是用来判断的操作符，常见有以下几种：</p>
<ol>
<li>&#x3D;&#x3D;Equal&#x3D;&#x3D;：<ul>
<li>判断键值对是否相等。</li>
<li>适用于您需要完全匹配键和值的情况。</li>
<li>示例：<code>key: &quot;key1&quot;, operator: &quot;Equal&quot;, value: &quot;value1&quot;</code></li>
</ul>
</li>
<li>&#x3D;&#x3D;In&#x3D;&#x3D;：<ul>
<li>判断值是否在指定的集合中。</li>
<li>适用于多个可能值的容忍度判断。</li>
<li>示例：<code>key: &quot;key1&quot;, operator: &quot;In&quot;, values: [&quot;value1&quot;, &quot;value2&quot;]</code></li>
</ul>
</li>
<li>&#x3D;&#x3D;NotIn&#x3D;&#x3D;：<ul>
<li>判断值是否不在指定的集合中。</li>
<li>适用于您需要排除某些值的情况。</li>
<li>示例：<code>key: &quot;key1&quot;, operator: &quot;NotIn&quot;, values: [&quot;value1&quot;, &quot;value2&quot;]</code></li>
</ul>
</li>
<li>&#x3D;&#x3D;Exists&#x3D;&#x3D;：<ul>
<li>只检查键是否存在，而不关心它的值。</li>
<li>适用于您只关心键的存在性，而不关心具体的值。</li>
<li>示例：<code>key: &quot;key1&quot;, operator: &quot;Exists&quot;</code> （不需要指定 <code>value</code>）<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">tolerations:</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">key:</span> <span class="hljs-string">&quot;key1&quot;</span><br>    <span class="hljs-params">operator:</span> <span class="hljs-string">&quot;In&quot;</span><br>    <span class="hljs-params">values:</span> [<span class="hljs-string">&quot;value1&quot;</span>, <span class="hljs-string">&quot;value2&quot;</span>]<br>    <span class="hljs-params">effect:</span> <span class="hljs-string">&quot;NoExecute&quot;</span><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<hr>
<h3 id="3-K8S-中的常用单位"><a href="#3-K8S-中的常用单位" class="headerlink" title="3. K8S 中的常用单位"></a>3. K8S 中的常用单位</h3><ol>
<li>&#x3D;&#x3D;存储容器&#x3D;&#x3D;：<ol>
<li>Ki、Mi、Gi、Ti</li>
</ol>
</li>
<li>&#x3D;&#x3D;cpu&#x3D;&#x3D;：<ol>
<li>1000m 是 1 核（逻辑 CPU 的核数，不是物理核数）</li>
</ol>
</li>
<li>&#x3D;&#x3D;memory（内存）&#x3D;&#x3D;<ol>
<li>Ki、Mi、Gi、Ti</li>
</ol>
</li>
</ol>
<hr>
<h3 id="4-资源清单"><a href="#4-资源清单" class="headerlink" title="4. 资源清单"></a>4. 资源清单</h3><p>之前我们通常会在一个 YAML 文件中定义一个资源，之后通过 <code>kubectl apply</code> 命令进行应用。</p>
<p>其实，在一个 YAML 文件中可以定义多个资源，通过 <code>---</code> 来分隔各个资源。我们通常将这样的文件称为“资源清单”。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Namespace</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">ingress-nginx</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">ingress-nginx</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">ingress-nginx</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">ingress-nginx-controller</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">ingress-nginx</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">LoadBalancer</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">80</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">ingress-nginx-controller</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">ingress-nginx</span><br></code></pre></td></tr></table></figure>

<hr>
<h3 id="5-base64-编码"><a href="#5-base64-编码" class="headerlink" title="5. base64 编码"></a>5. base64 编码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. 对字符串进行 base64 编码</span><br><span class="hljs-built_in">echo</span> -n <span class="hljs-string">&quot;admin&quot;</span> | <span class="hljs-built_in">base64</span><br><br><br><span class="hljs-comment"># 2. 对文件内容进行 base64 编码，并输出编码后的结果</span><br><span class="hljs-built_in">base64</span> -w 0 user.crt              <span class="hljs-comment"># -w 0 选项表示不对输出进行换行，输出结果会是一个长的连续字符串</span><br><span class="hljs-built_in">base64</span> -w 0 user.key<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="6-NFS-挂载参数"><a href="#6-NFS-挂载参数" class="headerlink" title="6. NFS 挂载参数"></a>6. NFS 挂载参数</h3><p>&#x3D;&#x3D;1.文件锁相关&#x3D;&#x3D;</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
<th>使用场景</th>
</tr>
</thead>
<tbody><tr>
<td><code>nolock</code></td>
<td>禁用 NFS 文件锁，防止锁竞争问题</td>
<td>多节点读写时使用</td>
</tr>
<tr>
<td><code>lock</code></td>
<td>启用 NFS 文件锁（默认）</td>
<td>单节点挂载时推荐使用</td>
</tr>
<tr>
<td><code>nocto</code></td>
<td>不强制更新 <code>ctime</code> 和 <code>mtime</code> 缓存</td>
<td>提高性能，适合只读数据</td>
</tr>
<tr>
<td><code>actimeo=N</code></td>
<td>设置属性缓存时间，单位秒</td>
<td>提高性能，适合少改频读数据</td>
</tr>
</tbody></table>
<p>&#x3D;&#x3D;2.性能优化相关&#x3D;&#x3D;</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
<th>使用场景</th>
</tr>
</thead>
<tbody><tr>
<td><code>rsize=xxx</code></td>
<td>读取块大小，默认 <code>1048576</code> 字节</td>
<td>增大块大小提升吞吐量</td>
</tr>
<tr>
<td><code>wsize=xxx</code></td>
<td>写入块大小，默认 <code>1048576</code> 字节</td>
<td>增大块大小提升写入性能</td>
</tr>
<tr>
<td><code>async</code></td>
<td>异步写入数据（默认）</td>
<td>性能更高，但存在数据丢失风险</td>
</tr>
<tr>
<td><code>sync</code></td>
<td>同步写入数据，数据立即写入磁盘</td>
<td>数据一致性要求高时使用</td>
</tr>
<tr>
<td><code>noatime</code></td>
<td>不更新文件访问时间</td>
<td>提高性能，适合频繁读取的大量小文件</td>
</tr>
<tr>
<td><code>nodiratime</code></td>
<td>不更新目录访问时间</td>
<td>类似 <code>noatime</code>，作用于目录</td>
</tr>
</tbody></table>
<p>&#x3D;&#x3D;3.端口协议相关&#x3D;&#x3D;</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
<th>使用场景</th>
</tr>
</thead>
<tbody><tr>
<td><code>noresvport</code></td>
<td>使用非保留端口通信（1024 以上端口）</td>
<td>防止端口冲突，常用在容器环境</td>
</tr>
<tr>
<td><code>resvport</code></td>
<td>使用保留端口通信（默认）</td>
<td>默认端口（1024 以下），适合传统环境</td>
</tr>
<tr>
<td><code>proto=tcp</code></td>
<td>使用 TCP 协议（默认）</td>
<td>稳定性好，常用</td>
</tr>
<tr>
<td><code>proto=udp</code></td>
<td>使用 UDP 协议</td>
<td>低延迟，适合低丢包网络</td>
</tr>
<tr>
<td><code>vers=4.0</code></td>
<td>使用 NFS v4.0 协议</td>
<td>默认使用 4.0，性能更优</td>
</tr>
<tr>
<td><code>vers=3</code></td>
<td>使用 NFS v3 协议</td>
<td>兼容性更好，但性能稍差</td>
</tr>
</tbody></table>
<p>&#x3D;&#x3D;4.安全性相关&#x3D;&#x3D;</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
<th>使用场景</th>
</tr>
</thead>
<tbody><tr>
<td><code>sec=sys</code></td>
<td>使用本地 UID&#x2F;GID 进行身份验证</td>
<td>默认方式</td>
</tr>
<tr>
<td><code>sec=krb5</code></td>
<td>使用 Kerberos 认证</td>
<td>安全性更高</td>
</tr>
<tr>
<td><code>ro</code></td>
<td>挂载为只读</td>
<td>防止意外修改</td>
</tr>
<tr>
<td><code>rw</code></td>
<td>挂载为读写（默认）</td>
<td>可读可写，默认模式</td>
</tr>
<tr>
<td><code>anonuid=xxx</code></td>
<td>将匿名用户映射为指定 UID</td>
<td>提高安全性</td>
</tr>
<tr>
<td><code>anongid=xxx</code></td>
<td>将匿名用户映射为指定 GID</td>
<td>提高安全性</td>
</tr>
</tbody></table>
<hr>
<h3 id="7-对-角色（Role）的理解"><a href="#7-对-角色（Role）的理解" class="headerlink" title="7. 对 角色（Role）的理解"></a>7. 对 角色（Role）的理解</h3><p>角色是一系列权限的集合</p>
<hr>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%AE%B9%E5%99%A8%E5%8C%96/" class="category-chain-item">容器化</a>
  
  
    <span>></span>
    
  <a href="/categories/%E5%AE%B9%E5%99%A8%E5%8C%96/Kubernetes-%E5%9F%BA%E7%A1%80/" class="category-chain-item">Kubernetes 基础</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>笔记：Kubernetes 基础</div>
      <div>https://wangjia5289.github.io/2025/03/12/笔记：Kubernetes 基础/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>霸天</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>March 12, 2025</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/03/12/%E7%AC%94%E8%AE%B0%EF%BC%9AJava%20%E9%A1%B9%E7%9B%AE%E5%88%9B%E5%BB%BA%E5%92%8C%E7%BB%93%E6%9E%84/" title="笔记：Java 项目创建和结构">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">笔记：Java 项目创建和结构</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/03/12/%E7%AC%94%E8%AE%B0%EF%BC%9ASpring%20AI/" title="笔记：Spring AI">
                        <span class="hidden-mobile">笔记：Spring AI</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  



  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.utils.listenDOMLoaded(function() {
      Fluid.events.registerRefreshCallback(function() {
        if ('mermaid' in window) {
          mermaid.init();
        }
      });
    });
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  var relativeDate = function() {
    var updatedTime = document.getElementById('updated-time');
    if (updatedTime) {
      var text = updatedTime.textContent;
      var reg = /\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:Z|[+-]\d{2}:\d{2})/;
      var matchs = text.match(reg);
      if (matchs) {
        var relativeTime = moment(matchs[0]).fromNow();
        updatedTime.textContent = text.replace(reg, relativeTime);
      }
      updatedTime.style.display = '';
    }
  };
  Fluid.utils.createScript('https://lib.baomitu.com/moment.js/2.29.4/moment.min.js', function() {
    if (!'en'.startsWith('en')) {
      Fluid.utils.createScript('https://lib.baomitu.com/moment.js/2.29.4/locale/en.min.js', function() {
        relativeDate();
      });
    } else {
      relativeDate();
    }
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"display":{"superSample":2,"width":200,"height":350,"position":"left","hOffset":40,"vOffset":-20},"mobile":{"show":false,"scale":0.5},"react":{"opacityDefault":1,"opacityOnHover":0.5},"log":false});</script></body>
</html>
