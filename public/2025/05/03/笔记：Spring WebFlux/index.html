

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/ba.jpg">
  <link rel="icon" href="/img/ba.jpg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#373737">
  <meta name="author" content="霸天">
  <meta name="keywords" content="">
  
    <meta name="description" content="一、理论1. Spring WebFlux 概述&#x3D;&#x3D;1.现有问题&#x3D;&#x3D;随着互联网应用的日益复杂和用户对实时性要求的提高，传统的基于阻塞 I&#x2F;O 的Web框架在处理高并发和大数据流时逐渐显现出瓶颈。 &#x3D;&#x3D;2.响应式编程解决方案&#x3D;&#x3D;基于以上问题，响应式编程模型应运而生，响应式编程是一种处理异步数据流、变化传播、非阻">
<meta property="og:type" content="article">
<meta property="og:title" content="笔记：Spring WebFlux">
<meta property="og:url" content="https://wangjia5289.github.io/2025/05/03/%E7%AC%94%E8%AE%B0%EF%BC%9ASpring%20WebFlux/index.html">
<meta property="og:site_name" content="夜阑卧听风吹雨,一枝梨花压心头">
<meta property="og:description" content="一、理论1. Spring WebFlux 概述&#x3D;&#x3D;1.现有问题&#x3D;&#x3D;随着互联网应用的日益复杂和用户对实时性要求的提高，传统的基于阻塞 I&#x2F;O 的Web框架在处理高并发和大数据流时逐渐显现出瓶颈。 &#x3D;&#x3D;2.响应式编程解决方案&#x3D;&#x3D;基于以上问题，响应式编程模型应运而生，响应式编程是一种处理异步数据流、变化传播、非阻">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-05-02T16:00:00.000Z">
<meta property="article:modified_time" content="2025-05-08T09:01:52.445Z">
<meta property="article:author" content="Ba Tian">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>笔记：Spring WebFlux - 夜阑卧听风吹雨,一枝梨花压心头</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"wangjia5289.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 100vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/%E3%80%90%E5%93%B2%E9%A3%8E%E5%A3%81%E7%BA%B8%E3%80%91%E5%85%89%E5%BD%B1%E7%BE%8E%E5%AD%A6-%E5%90%8A%E5%B8%A6%E8%A3%99.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="笔记：Spring WebFlux"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-05-03 00:00" pubdate>
          May 3, 2025 am
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          15k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          128 mins
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> views
        </span>
        

      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">笔记：Spring WebFlux</h1>
            
              <p id="updated-time" class="note note-info" style="display: none">
                
                  
                    Last updated on 2025-05-08T17:01:52+08:00
                  
                  

                
              </p>
            
            
              <div class="markdown-body">
                
                <h1 id="一、理论"><a href="#一、理论" class="headerlink" title="一、理论"></a>一、理论</h1><h3 id="1-Spring-WebFlux-概述"><a href="#1-Spring-WebFlux-概述" class="headerlink" title="1. Spring WebFlux 概述"></a>1. Spring WebFlux 概述</h3><p>&#x3D;&#x3D;1.现有问题&#x3D;&#x3D;<br>随着互联网应用的日益复杂和用户对实时性要求的提高，传统的基于<strong>阻塞 I&#x2F;O</strong> 的Web框架在处理高并发和大数据流时逐渐显现出瓶颈。</p>
<p>&#x3D;&#x3D;2.响应式编程解决方案&#x3D;&#x3D;<br>基于以上问题，响应式编程模型应运而生，响应式编程是一种<strong>处理异步数据流</strong>、<strong>变化传播</strong>、<strong>非阻塞</strong>的编程范式，在响应式编程中，数据被建模为流，操作以非阻塞方式执行，从而保持应用程序在高负载下的响应性。</p>
<p>&#x3D;&#x3D;3.Spring WebFlux 是什么&#x3D;&#x3D;<br>Spring WebFlux，作为 Spring Framework 的响应式Web框架，基于 Reactive Streams 规范构建，采用事件驱动 + 非阻塞 I&#x2F;O 的架构设计，特别适合处理高并发、低延迟和 I&#x2F;O 密集型任务。</p>
<hr>
<h3 id="深入理解传统-Spring-Web（Servlet-栈）"><a href="#深入理解传统-Spring-Web（Servlet-栈）" class="headerlink" title="深入理解传统 Spring Web（Servlet 栈）"></a>深入理解传统 Spring Web（Servlet 栈）</h3><p>Spring Web 采用传统的阻塞式编程模型，基于 Servlet API，默认使用 Servlet 容器（如 Tomcat）。其线程模型为每个请求分配一个线程，并在请求处理期间阻塞该线程，直到响应生成完毕（线程阻塞）。其缺乏内建的流式数据处理支持，且依赖多线程调度，其内存开销较大。在高并发场景下，受限于线程池大小和阻塞模型，吞吐量较低。然而，其延迟较低，适合传统的请求&#x2F;响应模型，尤其是 CPU 计算密集型 或 请求阻塞不明显 的传统 Web 应用开发。</p>
<p>对线程阻塞的深入理解：</p>
<ol>
<li>一个请求通常由一个线程全程处理。当程序执行到某个耗时操作（如阻塞的网络请求、阻塞的数据库查询、文件读写、或 CPU 密集计算）时，这个线程会<strong>停下来等待</strong>，直到结果返回后才能继续往下执行。</li>
<li>在这段等待时间里，线程既不做其他事，又无法释放，造成<strong>严重的资源浪费</strong>，系统吞吐量受限。</li>
<li>虽然我们可以通过<strong>异步线程池</strong>来“解耦”这些耗时操作，把任务转交给其他线程执行，释放主线程，看起来像是实现“非阻塞”，但这其实只是<strong>线程的转移</strong>，本质上仍是阻塞，只不过阻塞发生在别的线程上。更糟的是：如果主线程还需要等待异步结果返回，等于主线程和工作线程<strong>两个线程都被卡住了</strong>，反而加重了系统开销。这种方式可以称为“<strong>伪非阻塞</strong>”。</li>
</ol>
<hr>
<h3 id="深入理解Spring-WebFlux（Reactive-栈）"><a href="#深入理解Spring-WebFlux（Reactive-栈）" class="headerlink" title="深入理解Spring WebFlux（Reactive 栈）"></a>深入理解Spring WebFlux（Reactive 栈）</h3><p>&#x3D;&#x3D;1.Spring WebFlux（Reactive 栈）概述&#x3D;&#x3D;<br>Spring WebFlux 基于 <strong>Reactive Streams 规范</strong>构建，采用<strong>事件驱动 + 非阻塞 I&#x2F;O</strong> 的架构设计，默认使用<strong>非阻塞 I&#x2F;O 服务器</strong>（默认 Netty），借助 Reactor 库 <strong>（Mono 和 Flux）</strong> 实现异步操作，能够以较少的线程处理更多请求，资源消耗显著降低。在 I&#x2F;O 密集型 场景下，其吞吐量和响应速度表现优异，尽管响应链较长可能导致延迟略高。Spring WebFlux 特别适合 高并发 和 大量 I&#x2F;O 请求 的应用场景，例如聊天系统、实时通知和数据流处理等。</p>
<p>&#x3D;&#x3D;2.Reactive Streams 规范&#x3D;&#x3D;<br>既然 Spring WebFlux 是基于 Reactive Streams 规范构建的，我们若想真正搞懂 WebFlux，就绕不开对 Reactive Streams 规范的理解。而这套规范简单来说就是定义了四个核心接口：</p>
<ol>
<li><font color="#00b0f0">Publiser</font>：<ol>
<li>也就是负责发布数据流的数据源。我们平时使用的 Flux 和 Mono 就是 Publisher 接口的实现类。</li>
<li>因此可以理解为：哪里创建了 Flux 或 Mono，哪里就是一个 Publisher。</li>
</ol>
</li>
<li><font color="#00b0f0">Subscriber</font>：<ol>
<li>也就是消费数据流的“消费者”，负责处理接收到的数据。</li>
<li>在学习 Flux 和 Mono 时，我们接触了它们的 <code>subscribe</code> 方法，只有调用这个方法，数据流才会真正开始流动。所以可以理解为：哪里调用了 <code>subscribe</code> 方法，哪里就是 Subscriber。</li>
<li>常见的 Subscriber 示例有：<ol>
<li>WebClient：<ol>
<li>发起请求并消费响应数据流；</li>
</ol>
</li>
<li>WebFlux 框架本身：<ol>
<li>当调用 API 时，WebFlux 框架会在响应阶段自动订阅 Reactive 类型的返回值，将数据转换为客户端需要的格式并发送出去。</li>
<li>不要误以为客户端是 Subscriber，其实是 WebFlux 帮你完成了订阅和数据推送。</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li><font color="#00b0f0">Subscription</font>：<ol>
<li>是 Publisher 与 Subscriber 之间的桥梁，负责建立连接并控制数据流速。</li>
<li>它可以防止 Publisher 生产太快、而 Subscriber 消费太慢，从而导致 Publisher 缓存堆积、内存暴涨，最终可能引发内存溢出。</li>
<li>这正是我们常说的“<strong>背压（Backpressure）控制</strong>”，具体我们可以看下文的被压部分。</li>
</ol>
</li>
<li><font color="#00b0f0">Processor</font>：<ol>
<li>是一种同时实现了 Publisher 和 Subscriber 的组件，承担中间处理的角色。</li>
<li>它能够接收上游的数据，进行加工处理后，再将结果发布给下游。</li>
</ol>
</li>
</ol>
<p>&#x3D;&#x3D;3.I&#x2F;O 是什么&#x3D;&#x3D;<br>I&#x2F;O，即输入&#x2F;输出（Input&#x2F;Output），是指计算机与外部世界的信息交换过程，包括但不限于：</p>
<ol>
<li><font color="#00b0f0">网络请求</font>：<ol>
<li>如调用其他 HTTP API 接口（RestTemplate、WebClient）、JDBC、R2DBC 等等</li>
</ol>
</li>
<li><font color="#00b0f0">文件操作</font>：<ol>
<li>读取或写入硬盘上的文件</li>
</ol>
</li>
<li><font color="#00b0f0">用户交互</font>：<ol>
<li>键盘、鼠标等输入设备的信号获取，以及向显示器等输出设备发送信息。</li>
</ol>
</li>
<li><font color="#00b0f0">硬件通信</font>：<ol>
<li>与打印机、扫描仪等外部设备的数据交换</li>
</ol>
</li>
</ol>
<p>&#x3D;&#x3D;4.事件驱动 + 非阻塞 I&#x2F;O 是什么&#x3D;&#x3D;<br>“非阻塞 I&#x2F;O”与“阻塞 I&#x2F;O”是一对相对概念。阻塞 I&#x2F;O 指的是：主线程在执行某个依赖外部响应的操作时（比如使用 <code>RestTemplate</code> 调用 HTTP 接口，或通过 JDBC 查询数据库），会<strong>卡在原地等待</strong>数据返回，不能继续执行其它任务。</p>
<p>而非阻塞 I&#x2F;O 的模式是：主线程在发起操作后不会等待结果，而是转身继续处理别的任务，等到数据返回时，再通过某种机制“通知”主线程回来继续处理。这种“通知”机制，就是事件驱动模型的核心所在（理想状态，Spring WebFlux + 异步阻塞操作、异步非阻塞操作）</p>
<p>举个例子，当主线程遇到一个耗时操作，如果这个操作是异步非阻塞的（比如非阻塞网络请求、非阻塞数据库查询），主线程执行之后，不会呆等结果返回，而是注册一个事件及其对应的回调函数，然后立刻去处理其他任务。一旦有数据返回，比如 R2DBC 查询返回结果，就会触发事件并执行回调。如果操作未完全完成，只返回了部分数据，主线程会继续处理其他任务，等下次数据返回后再继续回调、推进后续业务流程。</p>
<p>这是 Spring WebFlux 碰到异步非阻塞操作结合后展现的强大优势，但当遇到本质上是同步阻塞的操作时，情况就不同了。比如同步简单操作或者同步阻塞操作，主线程依然需要等待它们执行完才能继续处理其他任务。然而，这种做法显然不合理，因为主 Reactive 线程需要同时处理成千上万个请求。如果某个操作长时间阻塞，主线程将无法高效处理其他任务，这显然是不可接受的。<font color="#ff0000">因此，我们约定：在主 Reactive 流（如 <code>flatMap</code>、<code>doOnNext</code> 等操作符内部）中，禁止执行任何严重阻塞操作，允许出现三类操作：同步简单操作、异步阻塞操作、异步非阻塞操作</font>。</p>
<p>对于执行同步阻塞操作这类场景，WebFlux 推荐将其转移到一个专门的 “阻塞友好线程池” 中去执行。执行完成后再将结果返回主线程。和传统的阻塞模型不同的是，虽然线程池中的线程仍是阻塞的，但主线程不会被挂起，而是继续处理其他任务，等结果回来后再处理该请求。这有效避免了主 Reactive 线程的长时间占用，使其保持轻量、高效。</p>
<p>这样一来，除了主 Reactive 线程在执行同步简单操作时略有耗时，其它包括异步阻塞、异步非阻塞的操作都不会阻塞主线程。主线程可以继续处理更多任务，从而实现以少量线程支撑大量并发请求的目标。</p>
<p>综上所述，我们可以总结出以下规律：</p>
<ol>
<li>Spring WebFlux 虽然提供了非阻塞的能力，但能否真正实现非阻塞，取决于你的技术栈：<ol>
<li>Spring WebFlux + 异步非阻塞操作 &#x3D; 完全非阻塞操作（王炸组合、理想组合）</li>
<li>Spring WebFlux + 异步阻塞操作 &#x3D; 主线程非阻塞、异步线程池阻塞（虽然稍逊，但比同步阻塞要强的多）</li>
<li>Spring WebFlux + 同步简单操作 &#x3D; 主线程阻塞（主线程短暂阻塞（通常可接受）</li>
<li>Spring WebFlux + 同步阻塞操作 &#x3D; 主线程严重阻塞主线程严重阻塞（不可接受，必须避免）</li>
</ol>
</li>
<li>我们约定：在主 Reactive 流（如 <code>flatMap</code>、<code>doOnNext</code> 等操作符内部）中，禁止执行任何严重阻塞操作，允许出现三类操作：同步简单操作、异步阻塞操作、异步非阻塞操作</li>
</ol>
<p>&#x3D;&#x3D;5.非阻塞 I&#x2F;O 服务器&#x3D;&#x3D;<br>其实，Spring WebFlux 程序并非只能运行在非阻塞 I&#x2F;O 服务器上，它同样也可以部署在 Servlet 容器中。虽然在不同类型的服务器上，开发者编写的代码几乎一致，但它们在底层的执行机制上却截然不同，这一点我们必须清楚。</p>
<p>在上文中我们提到，Spring WebFlux 的主线程在遇到耗时操作时会“放下”当前任务，去处理其他请求，看起来好像是 WebFlux 本身很智能，但其实这并非 WebFlux 的功劳，而是它底层所依赖的非阻塞 I&#x2F;O 服务器（如 Netty）在发挥作用。只有在使用非阻塞服务器时，请求才能由单线程事件循环异步处理，从而实现真正的高并发与资源高效利用。</p>
<p>然而，如果将 WebFlux 部署在传统的 Servlet 容器上（例如 Tomcat），底层仍旧是“一请求一线程”的处理模型。这种线程池的方式违背了响应式架构的核心理念。以如下示例代码为例：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyController</span> &#123;<br>    <br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/flux&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> Mono&lt;String&gt; flux() &#123; <br>        <span class="hljs-keyword">return</span> Mono.just(<span class="hljs-string">&quot;WebFlux&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>尽管我们在接口中返回了 <code>Mono&lt;String&gt;</code>，但 Tomcat 并不具备真正的响应式、非阻塞能力，它仅通过 Servlet 3.1 的 Async API 对“异步”进行了模拟，流程上还是阻塞的。这种模拟虽可正常运行，但性能上无法真正发挥响应式编程的优势。</p>
<p>下图展示了 Servlet 与非阻塞服务器在模型上的根本差异：</p>
<table>
<thead>
<tr>
<th>对比点</th>
<th>阻塞 I&#x2F;O（如 Tomcat）</th>
<th>非阻塞 I&#x2F;O（如 Netty）</th>
</tr>
</thead>
<tbody><tr>
<td>请求处理模型</td>
<td>每个请求对应一个线程</td>
<td>单线程事件循环，异步处理所有连接</td>
</tr>
<tr>
<td>I&#x2F;O 行为</td>
<td>等数据可用或写入完成前线程阻塞</td>
<td>不等，先注册事件，数据到来再处理</td>
</tr>
<tr>
<td>并发连接能力</td>
<td>线程资源受限（线程多了开销大）</td>
<td>资源消耗极低，能处理非常多连接</td>
</tr>
<tr>
<td>内存压力</td>
<td>线程多了容易爆内存</td>
<td>单线程或少量线程，内存更可控</td>
</tr>
<tr>
<td>编程模型</td>
<td>同步、阻塞调用</td>
<td>响应式、异步调用</td>
</tr>
<tr>
<td>响应式支持</td>
<td>无响应式支持，流程阻塞</td>
<td>原生响应式，支持流式数据处理</td>
</tr>
<tr>
<td>吞吐量</td>
<td>中等，受限于线程池</td>
<td>高，利用非阻塞机制提高并发处理能力</td>
</tr>
<tr>
<td>延迟</td>
<td>低，线程直通，响应快速</td>
<td>略高，响应链长，调度复杂</td>
</tr>
</tbody></table>
<p>此外，在高并发场景下，Spring WebFlux 在不同服务器上的性能差异也非常明显：</p>
<table>
<thead>
<tr>
<th>服务器</th>
<th>最大并发量（4核8G）</th>
<th>最大并发量（4核16G）</th>
</tr>
</thead>
<tbody><tr>
<td>Tomcat</td>
<td>5000 连接</td>
<td>10000 连接</td>
</tr>
<tr>
<td>Netty</td>
<td>50000 连接</td>
<td>100000 连接</td>
</tr>
</tbody></table>
<p>&#x3D;&#x3D;6.Mono 和 Flux&#x3D;&#x3D;<br><code>Mono</code> 和 <code>Flux</code> 是 Reactor 的核心组件，Spring WebFlux 强烈建议我们所有的方法返回值都使用 <code>Mono</code> 或 <code>Flux</code>。简单来说，如果你希望执行异步非阻塞操作，就必须将其封装在 <code>Mono</code> 或 <code>Flux</code> 中，从而在响应式流中执行。</p>
<p>需要注意的是，即便你没有显式返回 <code>Mono</code> 或 <code>Flux</code>，比如直接写 <code>return &quot;data&quot;</code>，Spring WebFlux 也会自动将你的返回值包装成 <code>Mono</code> 或 <code>Flux</code>。虽然这样看似返回了 <code>Mono</code> 或 <code>Flux</code>，但这通常意味着你的代码逻辑仍是<strong>同步阻塞的</strong>（因为你无法使用异步非阻塞操作），无法真正利用 Spring WebFlux 提供的非阻塞能力和异步执行的优势，只是将结果进行了一层华丽的包装。例如，下面的代码就是一个典型的阻塞调用：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">@RestController<br><span class="hljs-built_in">public</span> <span class="hljs-keyword">class</span> UserController &#123;<br><br>    @GetMapping(&quot;/users/lazy&quot;)<br>    <span class="hljs-built_in">public</span> List&lt;<span class="hljs-keyword">User</span>&gt; getUsersLazily() &#123;<br>        List&lt;<span class="hljs-keyword">User</span>&gt; allUsers = <span class="hljs-built_in">new</span> ArrayList&lt;&gt;();<br>        <span class="hljs-type">int</span> pageSize = <span class="hljs-number">10</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> page = <span class="hljs-number">0</span>; page &lt; <span class="hljs-number">100</span>; page++) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-keyword">offset</span> = page * pageSize;<br>            List&lt;<span class="hljs-keyword">User</span>&gt; pageUsers = jdbcTemplate.query(<br>                &quot;SELECT * FROM users LIMIT ? OFFSET ?&quot;,<br>                <span class="hljs-built_in">new</span> <span class="hljs-keyword">Object</span>[]&#123;pageSize, <span class="hljs-keyword">offset</span>&#125;,<br>                (rs, rowNum) -&gt; <span class="hljs-built_in">new</span> <span class="hljs-keyword">User</span>(<br>                    rs.getInt(&quot;id&quot;),<br>                    rs.getString(&quot;name&quot;)<br>                )<br>            );<br>            <span class="hljs-keyword">if</span> (pageUsers.isEmpty()) &#123;<br>                break;<br>            &#125;<br>            allUsers.addAll(pageUsers);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> allUsers;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>如上所示，尽管 Spring WebFlux 会将返回值包装成 <code>Mono</code> 或 <code>Flux</code>，但由于内部仍使用了阻塞式的 <code>JDBC</code>，因此代码的执行依然是同步阻塞的，未能发挥出 WebFlux 的非阻塞特性。</p>
<p><font color="#ff0000">因此，我们约定：在 Spring WebFlux 中，所有方法的返回值应当返回 <code>Mono</code> 或 <code>Flux</code>，确保所有操作都在响应式流中异步执行</font>。</p>
<hr>
<h3 id="2-对-Spring-WebFlux-深入理解"><a href="#2-对-Spring-WebFlux-深入理解" class="headerlink" title="2. 对 Spring WebFlux 深入理解"></a>2. 对 Spring WebFlux 深入理解</h3><p>&#x3D;&#x3D;1.Spring Web（Servlet 栈）&#x3D;&#x3D;<br>Spring Web 采用传统的阻塞式编程模型，基于 Servlet API，默认使用 Servlet 容器（如 Tomcat）。其线程模型为每个请求分配一个线程，并在请求处理期间阻塞该线程，直到响应生成完毕（线程阻塞）。其缺乏内建的流式数据处理支持，且依赖多线程调度，其内存开销较大。在高并发场景下，受限于线程池大小和阻塞模型，吞吐量较低。然而，其延迟较低，适合传统的请求&#x2F;响应模型，尤其是 CPU 计算密集型 或 请求阻塞不明显 的传统 Web 应用开发。</p>
<p>对线程阻塞的深入理解：</p>
<ol>
<li>一个请求通常由一个线程全程处理。当程序执行到某个耗时操作（如阻塞的网络请求、阻塞的数据库查询、文件读写、或 CPU 密集计算）时，这个线程会<strong>停下来等待</strong>，直到结果返回后才能继续往下执行。</li>
<li>在这段等待时间里，线程既不做其他事，又无法释放，造成<strong>严重的资源浪费</strong>，系统吞吐量受限。</li>
<li>虽然我们可以通过<strong>异步线程池</strong>来“解耦”这些耗时操作，把任务转交给其他线程执行，释放主线程，看起来像是实现“非阻塞”，但这其实只是<strong>线程的转移</strong>，本质上仍是阻塞，只不过阻塞发生在别的线程上。更糟的是：如果主线程还需要等待异步结果返回，等于主线程和工作线程<strong>两个线程都被卡住了</strong>，反而加重了系统开销。这种方式可以称为“<strong>伪非阻塞</strong>”。</li>
</ol>
<p>&#x3D;&#x3D;2.Spring WebFlux（Reactive 栈）&#x3D;&#x3D;<br>Spring WebFlux 基于 Reactive Streams 规范构建，采用事件驱动 + 非阻塞 I&#x2F;O 的架构设计，使用非阻塞 I&#x2F;O 服务器（默认 Netty），借助 Reactor 库（Mono 和 Flux）实现异步操作，能够以较少的线程处理更多请求，资源消耗显著降低。在 I&#x2F;O 密集型 场景下，其吞吐量和响应速度表现优异，尽管响应链较长可能导致延迟略高。Spring WebFlux 特别适合 高并发 和 大量 I&#x2F;O 请求 的应用场景，例如聊天系统、实时通知和数据流处理等。</p>
<p>对非阻塞 I&#x2F;O 的深入理解：</p>
<ol>
<li>Spring WebFlux 的非阻塞 I&#x2F;O 模型有所不同。它不是通过线程切换来“回避阻塞”，而是以事件驱动 + 回调机制的方式从根本上规避阻塞。需要特别注意的是：“<font color="#ff0000">Spring WebFlux 仅提供非阻塞的能力，是否真正实现非阻塞，取决于你的整体技术栈，简单来说，Spring WebFlux + 异步非阻塞操作 &#x3D; 王炸</font>”。</li>
<li>举个例子，当主线程遇到一个耗时操作，如果这个操作是异步非阻塞的（比如非阻塞网络请求、非阻塞数据库查询），主线程不会呆等结果返回，而是注册一个事件及其对应的回调函数，然后立刻去处理其他任务。一旦有数据返回，比如 R2DBC 查询返回结果，就会触发事件并执行回调。如果操作未完全完成，只返回了部分数据，主线程会继续处理其他任务，等下次数据返回后再继续回调、推进后续业务流程。</li>
<li>但如果这个操作是同步简单操作或同步阻塞操作，主线程仍然必须等它执行完才能继续。要注意的是，主 Reactive 线程承担着成千上万个请求，如果它被某个操作长时间阻塞，显然是不可接受的。因此，<font color="#ff0000">我们约定：在主 Reactive 流（如 <code>flatMap</code>、<code>doOnNext</code> 等操作符内部）中，禁止执行任何阻塞操作，只允许出现两类操作：同步简单操作、异步非阻塞操作</font>。</li>
<li>那么问题来了，如果必须执行同步阻塞操作怎么办？对于这类场景，WebFlux 支持将其转移到一个专门的“阻塞友好线程池”中去执行。执行完成后再将结果返回主线程。和传统的阻塞模型不同的是，虽然线程池中的线程仍是阻塞的，但主线程不会被挂起，而是继续处理其他任务，等结果回来后再处理该请求。这有效避免了主 Reactive 线程的长时间占用，使其保持轻量、高效。</li>
<li>这样一来，除了主 Reactive 线程在执行同步简单操作时略有耗时，其它包括异步阻塞、异步非阻塞的操作都不会阻塞主线程。主线程可以继续处理更多任务，从而实现以少量线程支撑大量并发请求的目标。</li>
</ol>
<p>&#x3D;&#x3D;3.两者对比表&#x3D;&#x3D;</p>
<table>
<thead>
<tr>
<th>项目</th>
<th>Spring Web（Tomcat）</th>
<th>Spring WebFlux（Netty）</th>
</tr>
</thead>
<tbody><tr>
<td><strong>并发模型</strong></td>
<td>每请求一个线程（阻塞）</td>
<td>单线程事件驱动，非阻塞处理</td>
</tr>
<tr>
<td><strong>适用场景</strong></td>
<td>计算密集型 &#x2F; 阻塞不明显的中低并发场景</td>
<td>高并发、I&#x2F;O 密集、实时响应</td>
</tr>
<tr>
<td><strong>资源占用</strong></td>
<td>多线程调度，线程上下文开销大</td>
<td>少量线程处理大量请求，资源占用低</td>
</tr>
<tr>
<td><strong>响应式支持</strong></td>
<td>无响应式支持，流程阻塞</td>
<td>原生响应式，支持流式数据处理</td>
</tr>
<tr>
<td><strong>返回 JSON</strong></td>
<td>使用 Jackson + HttpMessageConverter</td>
<td>使用 Jackson + HttpMessageWriter</td>
</tr>
<tr>
<td><strong>编程风格</strong></td>
<td>命令式，流程清晰，开发简单</td>
<td>响应式，链式调用，开发思维门槛高</td>
</tr>
<tr>
<td><strong>学习曲线</strong></td>
<td>低，传统经验易迁移</td>
<td>高，需要理解响应式思想</td>
</tr>
<tr>
<td><strong>吞吐量</strong></td>
<td>中等，受限于线程池</td>
<td>高，利用非阻塞机制提高并发处理能力</td>
</tr>
<tr>
<td><strong>延迟（Latency）</strong></td>
<td>低，线程直通，响应快速</td>
<td>响应链长，调度复杂，延迟略高</td>
</tr>
</tbody></table>
<hr>
<h3 id="3-对-“流”-深入理解"><a href="#3-对-“流”-深入理解" class="headerlink" title="3. 对 “流” 深入理解"></a>3. 对 “流” 深入理解</h3><p>Reactor、Spring WebFlux 等框架的核心就是通过返回流（<code>Mono</code> 或 <code>Flux</code>）来管理异步操作的控制流。即便你在内部做的是阻塞操作，返回一个 <code>Mono</code> 或 <code>Flux</code> 也能保持与其他异步操作的协作性和合适的线程调度。</p>
<p>也就是，能返回流就返回流，不管你是执行异步阻塞操作，还是异步非阻塞</p>
<p>在 Spring WebFlux 中，真正的流式处理主要涉及两个方面：</p>
<ol>
<li>&#x3D;&#x3D;服务器接受流式数据&#x3D;&#x3D;：<ol>
<li>通常涉及数据库查询、网络请求等外部数据源返回数据给服务器。对于这类操作，我们不能依赖同步阻塞或异步阻塞机制。比如，JDBC 会一次性拉取所有数据并返回，HttpClient 调用外部服务时也会等待所有响应返回，这种方式属于“阻塞”模式，不适合流式数据处理。</li>
<li>为了实现真正的流式输出，我们需要采用异步非阻塞操作。例如，R2DBC 以逐行的方式从数据库返回数据，WebClient 也采用类似的机制。这也是为什么我们说：“Spring WebFlux + 异步非阻塞操作 &#x3D; 王炸”。</li>
</ol>
</li>
<li>&#x3D;&#x3D;服务器发送流式数据给客户端&#x3D;&#x3D;：<ol>
<li>默认情况下，Spring WebFlux 的返回并不是流式的，要实现真正的流式响应，必须满足以下四个条件：</li>
<li>使用 <code>Flux&lt;T&gt;</code> 返回多个元素</li>
<li><code>Flux</code> 必须懒生成（☆☆☆）</li>
<li>设置正确的 <code>Content-Type</code>（例如 <code>text/event-stream</code> 或 <code>application/stream+json</code>）</li>
<li>客户端需要支持 chunked transfer 或 SSE（服务器推送事件）</li>
<li>如果缺少任何一个条件，流式效果无法实现。例如，即使你使用了 <code>Flux</code>、懒加载，并且客户端支持，但如果没有正确设置 <code>Content-Type</code>，客户端会一直处于加载状态，直到最终一次性返回所有数据，这时数据会“哐哐”全部输出。</li>
</ol>
</li>
</ol>
<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li><font color="#00b0f0">懒加载</font>：<ol>
<li>Flux 或 Mono 在没有人订阅（subscribe）之前，它<strong>啥都不干</strong></li>
<li>只有当你调用 <code>.subscribe()</code> 的时候，它才真的发数据，这叫懒加载</li>
</ol>
</li>
<li><font color="#00b0f0">懒生成</font>：<ol>
<li>数据不是一次性准备好的，而是<strong>边订阅边生成</strong>的。</li>
<li>以 <code>Flux.just(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;)</code> 为例，一旦你订阅，虽然会按照 A -&gt; B -&gt; C 依次发出，但它把所有数据都已经准备好了，不是懒生成。</li>
<li>再以 <code>Flux.interval(Duration.ofSeconds(1))</code> 为例，是边订阅边生成的：它每秒生成一个数，是真·懒生成。</li>
</ol>
</li>
</ol>
</blockquote>
<p>Flux 依次发出数据</p>
<hr>
<h3 id="4-高并发环境下-WebFlux-性能表现"><a href="#4-高并发环境下-WebFlux-性能表现" class="headerlink" title="4. 高并发环境下 WebFlux 性能表现"></a>4. 高并发环境下 WebFlux 性能表现</h3><hr>
<h3 id="5-Mono"><a href="#5-Mono" class="headerlink" title="5. Mono"></a>5. Mono</h3><h4 id="5-1-Mono-概述"><a href="#5-1-Mono-概述" class="headerlink" title="5.1. Mono 概述"></a>5.1. Mono 概述</h4><p><code>Mono</code> 表示一个可能包含 0 或 1 个元素 的异步数据流。它可以承载一个元素或一个空值，例如下面代码中， <code>Hello, World!</code> 就是一个元素；</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">Mono&lt;String&gt; mono <span class="hljs-operator">=</span> Mono.just(<span class="hljs-string">&quot;Hello, World!&quot;</span>)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>“元素”的概念是基于 <code>Mono&lt;T&gt;</code> 中的泛型类型来理解的。比如 <code>Mono&lt;String&gt;</code> 中一个 <code>String</code> 类型就是一个元素；如果是 <code>Mono&lt;Object&gt;</code>，那一个 <code>Object</code> 类型就是一个元素。</li>
</ol>
</blockquote>
<hr>
<h4 id="5-2-Mono-相关方法"><a href="#5-2-Mono-相关方法" class="headerlink" title="5.2. Mono 相关方法"></a>5.2. Mono 相关方法</h4><h5 id="5-2-1-前言"><a href="#5-2-1-前言" class="headerlink" title="5.2.1. 前言"></a>5.2.1. 前言</h5><p>我们约定：在主 Reactive 流（如 <code>flatMap</code>、<code>doOnNext</code> 等操作符内部）中，不得放置任何阻塞操作，只允许包含两类操作：</p>
<ol>
<li>同步简单操作</li>
<li>异步非阻塞操作</li>
</ol>
<p>对于 同步阻塞操作，必须通过 <code>mono.subscribeOn</code> 将其调度到 “阻塞友好线程” 中，因此，以后我们提到 “异步阻塞操作” ，实际上是指：<strong>将原本是同步阻塞的操作，调度到阻塞友好线程中执行</strong>，从而避免阻塞 Reactor 的工作线程，保持响应式流的非阻塞特性。</p>
<hr>
<h5 id="5-2-2-Mono-实例创建方法"><a href="#5-2-2-Mono-实例创建方法" class="headerlink" title="5.2.2. Mono 实例创建方法"></a>5.2.2. Mono 实例创建方法</h5><ol>
<li><code>Mono.just(T data)</code>：<ol>
<li>从一个确定且非 <code>null</code> 的值创建 Mono（可以为空字符串 <code>&quot;&quot;</code>），直接发出该值</li>
</ol>
</li>
<li><code>Mono.justOrEmpty(T data)</code>：<ol>
<li>从一个可能为 <code>null</code> 的值创建 Mono，若为 <code>null</code> 则返回空 Mono</li>
</ol>
</li>
<li><code>Mono.empty()</code>：<ol>
<li>创建不发出任何元素且立即完成的空 Mono</li>
</ol>
</li>
<li><code>Mono.fromCallable(Callable&lt;R&gt;)</code>：<ol>
<li>从 <code>Callable</code> 创建 Mono，无论 <code>Callable</code> 返回值是什么，最终都将被包装为一个 Mono，适用于封装同步简单操作、异步阻塞操作、异步非阻塞操作</li>
<li>这里异步阻塞操作指的是结合 <code>subscribeOn</code> 异步化阻塞操作（使成为异步阻塞操作），避免占用主 Reactive 线程过多时间<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">&quot;/api&quot;</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MonoExamples</span> &#123;<br><br>    <span class="hljs-comment">// 1. Mono.just(T data)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/just&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">just</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; mono = <span class="hljs-title class_">Mono</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;Hello&quot;</span>);<br>        <span class="hljs-keyword">return</span> mono;<br>    &#125;<br><br>    <span class="hljs-comment">// 2. Mono.justOrEmpty(T data)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/justOrEmpty&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">justOrEmpty</span>(<span class="hljs-params"><span class="hljs-meta">@RequestParam</span>(required = <span class="hljs-literal">false</span>) <span class="hljs-title class_">String</span> input</span>) &#123;<br>        <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; mono = <span class="hljs-title class_">Mono</span>.<span class="hljs-title function_">justOrEmpty</span>(input);<br>        <span class="hljs-keyword">return</span> mono;<br>    &#125;<br><br>    <span class="hljs-comment">// 3. Mono.empty()</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/empty&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">empty</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; mono = <span class="hljs-title class_">Mono</span>.<span class="hljs-title function_">empty</span>();<br>        <span class="hljs-keyword">return</span> mono;<br>    &#125;<br><br>    <span class="hljs-comment">// 4. Mono.fromCallable(Callable&lt;R&gt;)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/fromCallable&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">fromCallable</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; mono = <span class="hljs-title class_">Mono</span>.<span class="hljs-title function_">fromCallable</span>(() -&gt; &#123;<br>	        <span class="hljs-comment">// 模拟阻塞操作</span><br>            <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">sleep</span>(<span class="hljs-number">1000</span>); <br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;data from callable&quot;</span>;<br>        &#125;).<span class="hljs-title function_">subscribeOn</span>(<span class="hljs-title class_">Schedulers</span>.<span class="hljs-title function_">boundedElastic</span>());<br>        <span class="hljs-keyword">return</span> mono;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<hr>
<h5 id="5-2-3-mono-对象实例方法"><a href="#5-2-3-mono-对象实例方法" class="headerlink" title="5.2.3. mono 对象实例方法"></a>5.2.3. mono 对象实例方法</h5><h6 id="5-2-3-1-实例方法一览图"><a href="#5-2-3-1-实例方法一览图" class="headerlink" title="5.2.3.1. 实例方法一览图"></a>5.2.3.1. 实例方法一览图</h6><table>
<thead>
<tr>
<th><strong>实例方法</strong></th>
<th><strong>功能描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>转换与映射方法</strong></td>
<td></td>
</tr>
<tr>
<td><code>map(Function&lt;? super T, ? extends R&gt; mapper)</code></td>
<td>对流中每个元素应用提供的函数（同步简单操作），将它从类型 T 变换成类型 R。<br>与 <code>flatMap</code> 不同点在于：<code>map</code> 是同步操作，结果通常是原始类型转换，没有异步流。</td>
</tr>
<tr>
<td><code>flatMap(Function&lt;? super T, ? extends Publisher&lt;? extends R&gt;&gt; mapper)</code></td>
<td>对每个元素执行一个异步操作（异步阻塞、异步非阻塞），返回一个新的异步流，并将所有这些异步流与元素合并成一个流。<br>“展平”的意思是把多个 Publisher 的流合成一个统一的 Flux。</td>
</tr>
<tr>
<td><code>cast(Class&lt;R&gt; clazz)</code></td>
<td>将流中元素强制转换为类型 R；若元素类型与 R 无继承或实现关系（即类型不兼容），将抛出 <code>ClassCastException</code> 异常。</td>
</tr>
<tr>
<td><code>ofType(Class&lt;U&gt; clazz)</code></td>
<td>仅保留属于指定类型 U 的元素，过滤掉其他类型的元素。</td>
</tr>
<tr>
<td><code>switchIfEmpty(Publisher&lt;? extends T&gt; alternate)</code></td>
<td>如果 Mono 为空（没有发出任何元素就完成），则切换到指定的备用 Publisher（如另一个 Flux 或 Mono）继续发出元素。<br></td>
</tr>
<tr>
<td><code>defaultIfEmpty(T defaultValue)</code></td>
<td>如果 Mono 为空（没有发出任何元素就完成），则发出指定的默认值（可以是流，也可以不是流）并完成。<br>与 <code>switchIfEmpty</code> 不同点在于：<code>defaultIfEmpty</code> 提供的是一个固定的同步值，而不是另一个异步流。适用于简单场景，如为空时返回默认字符串或对象。</td>
</tr>
<tr>
<td><strong>过滤方法</strong></td>
<td></td>
</tr>
<tr>
<td><code>filter(Predicate&lt;? super T&gt; predicate)</code></td>
<td>对每个元素执行断言函数，仅保留返回 <code>true</code> 的元素，返回 <code>false</code> 的元素将被过滤掉（满足条件的保留）。</td>
</tr>
<tr>
<td><strong>合并与组合方法</strong></td>
<td></td>
</tr>
<tr>
<td><code>zipWith(Mono&lt;? extends U&gt;other，BiFunction&lt;T，U，R&gt;combiner)</code></td>
<td>将当前 <code>Mono&lt;T&gt;</code> 与另一个 <code>Mono&lt;U&gt;</code> 组合，通过 <code>BiFunction</code> 合并为结果 <code>R</code>，返回 <code>Mono&lt;R&gt;</code><br/>任一 Mono 为空则返回空 Mono</td>
</tr>
<tr>
<td><code>zip(Mono&lt;? extends T1&gt; m1, Mono&lt;? extends T2&gt; m2, ...)</code></td>
<td>同上，打包多个 Mono 的结果为 <code>Tuple</code>，返回 <code>Mono&lt;TupleN&gt;</code><br/>任一 Mono 为空则返回空 Mono</td>
</tr>
<tr>
<td><strong>错误处理方法</strong></td>
<td></td>
</tr>
<tr>
<td><code>onErrorReturn(T fallback)</code></td>
<td>一旦上游发生错误，就发出一个默认值（可以是流也可以不是流），不再传递错误信号。</td>
</tr>
<tr>
<td><code>onErrorMap(Function&lt;Throwable, ? extends Throwable&gt; mapper)</code></td>
<td>捕获异常并将其包装或转换为另一种更具语义的异常类型，然后重新发出错误信号，便于统一上层错误处理策略。简单来说：异常 A -&gt; 异常 X，上层统一处理异常 X。</td>
</tr>
<tr>
<td><code>onErrorResume(Function&lt;Throwable, ? extends Publisher&lt;? extends T&gt;&gt; fallback)</code></td>
<td>错误发生时，切换到备用的 Publisher 继续发出元素，避免整个流被中断，可用于降级、重试或备用数据源。</td>
</tr>
<tr>
<td><code>onErrorContinue(BiConsumer&lt;Throwable, Object&gt; errorConsumer)</code></td>
<td>对单个元素处理出错时只执行指定副作用（如记录日志），并跳过该元素继续后续处理，下游不会收到错误；相当于「有容错的流水线」。</td>
</tr>
<tr>
<td><code>retry(long times)</code></td>
<td>出错时将重试整个 Mono 上游 <code>times</code> 次（总共尝试 1 + times 次）。</td>
</tr>
<tr>
<td><strong>延迟与调度方法</strong></td>
<td></td>
</tr>
<tr>
<td><code>delayElements(Duration delay)</code></td>
<td>给每个元素之间插入固定延迟，模拟节流或人为降速，就像每隔一秒钟才放一个包裹。</td>
</tr>
<tr>
<td><code>subscribeOn(Scheduler scheduler)</code></td>
<td>指定整个订阅过程在哪个调度器线程上运行（影响源的执行线程）<br>注意：多个 <code>subscribeOn</code> 只会生效第一个</td>
</tr>
<tr>
<td><code>publishOn(Scheduler scheduler)</code></td>
<td>指定 <code>publishOn</code> 之后的操作在那个线程池执行</td>
</tr>
<tr>
<td><code>timeout(Duration timeout)</code></td>
<td>设置超时时间，如果某个元素未在规定时间内到达，就抛出 <code>TimeoutException</code>，用于超时控制</td>
</tr>
<tr>
<td><strong>其他实用方法</strong></td>
<td></td>
</tr>
<tr>
<td><code>doOnNext(Consumer&lt;? super T&gt; onNext)</code></td>
<td>每当流发出一个元素时执行指定副作用（如日志、指标统计），但不改变元素本身；就像在传送带上做一次检查打标。</td>
</tr>
<tr>
<td><code>doOnError(Consumer&lt;? super Throwable&gt; onError)</code></td>
<td>流遇到错误时执行副作用（如记录日志、告警），然后再把错误继续抛给下游；适合在错误点插入埋点或监控。</td>
</tr>
<tr>
<td><code>doOnComplete(Runnable onComplete)</code></td>
<td>在流正常走完所有元素后执行一次副作用，如资源释放或完成通知；就像闭环操作中的收尾仪式。</td>
</tr>
<tr>
<td><code>doOnSubscribe(Consumer&lt;? super Subscription&gt; onSubscribe)</code></td>
<td>订阅者发起订阅时触发，用于记录或处理初次订阅行为，比如打日志或初始化状态。</td>
</tr>
<tr>
<td><code>doFinally(Consumer&lt;SignalType&gt; onFinally)</code></td>
<td>在流终止时（无论正常完成、取消、还是出错）都执行指定副作用，相当于 finally 块，常用于收尾清理等场景。</td>
</tr>
<tr>
<td><code>log()</code></td>
<td>自动在控制台打印 Mono 的信号轨迹，包括订阅、请求、发出元素、完成和错误，帮你像放监控摄像头一样随时看流水线状态。</td>
</tr>
<tr>
<td><code>cache()</code></td>
<td>将流转换为可重放的热流，缓存所有元素，后续订阅者会立刻看到之前的数据，无需再次执行上游逻辑；适合昂贵操作的结果复用。</td>
</tr>
<tr>
<td><code>share()</code></td>
<td>也会把 Cold Mono 变成 Hot Mono，但不缓存旧数据，所有订阅者共享同一份数据流，适合广播式分发；就像把演唱会直播送给多个观众同时观看。</td>
</tr>
<tr>
<td><strong>订阅方法</strong></td>
<td></td>
</tr>
<tr>
<td><code>subscribe()</code></td>
<td>触发流的执行，<strong>不处理任何信号</strong>（元素、错误、完成），</td>
</tr>
<tr>
<td><code>subscribe(Consumer&lt;? super T&gt; onNext)</code></td>
<td>触发流的执行，只处理正常发出的元素，不管错误或完成</td>
</tr>
<tr>
<td><code>subscribe(Consumer&lt;? super T&gt; onNext, Consumer&lt;? super Throwable&gt; onError, Runnable onComplete)</code></td>
<td>触发流的执行，分别处理元素、错误、完成 三种信号</td>
</tr>
</tbody></table>
<hr>
<h6 id="5-2-3-2-转换与映射方法"><a href="#5-2-3-2-转换与映射方法" class="headerlink" title="5.2.3.2. 转换与映射方法"></a>5.2.3.2. 转换与映射方法</h6><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">&quot;/api&quot;</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MonoOperators</span> &#123;<br>	<br>    <span class="hljs-comment">// 1. map(Function&lt;T, R&gt; mapper)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/map&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">map</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; mono = <span class="hljs-title class_">Mono</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;hello&quot;</span>)<br>                                 .<span class="hljs-title function_">map</span>(value -&gt; value.<span class="hljs-title function_">toUpperCase</span>()); <span class="hljs-comment">// 转为大写</span><br>        <span class="hljs-keyword">return</span> mono;<br>    &#125;<br><br>    <span class="hljs-comment">// 2. flatMap(Function&lt;T, Mono&lt;R&gt;&gt; mapper)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/flatMap&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">flatMap</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; mono = <span class="hljs-title class_">Mono</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;hello&quot;</span>)<br>                                 .<span class="hljs-title function_">flatMap</span>(value -&gt; <span class="hljs-title class_">Mono</span>.<span class="hljs-title function_">just</span>(value + <span class="hljs-string">&quot; world&quot;</span>));<br>        <span class="hljs-keyword">return</span> mono;<br>    &#125;<br><br>    <span class="hljs-comment">// 3. cast(Class&lt;R&gt; type)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/cast&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">Number</span>&gt; <span class="hljs-title function_">cast</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">Number</span>&gt; mono = <span class="hljs-title class_">Mono</span>.<span class="hljs-title function_">just</span>(<span class="hljs-number">123</span>)<br>                                 .<span class="hljs-title function_">cast</span>(<span class="hljs-title class_">Number</span>.<span class="hljs-property">class</span>); <br>        <span class="hljs-keyword">return</span> mono;<br>    &#125;<br><br>    <span class="hljs-comment">// 4. ofType(Class&lt;R&gt; type)</span><br>	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/ofType&quot;</span>)  <br>	<span class="hljs-keyword">public</span> <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">ofType</span>(<span class="hljs-params"></span>) &#123;  <br>	    <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; mono = <span class="hljs-title class_">Mono</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;I&#x27;m a string&quot;</span>)  <br>	            .<span class="hljs-title function_">ofType</span>(<span class="hljs-title class_">String</span>.<span class="hljs-property">class</span>);  <br>	    <span class="hljs-keyword">return</span> mono;  <br>	&#125;<br><br>    <span class="hljs-comment">// 5. switchIfEmpty(Mono&lt;? extends T&gt; fallback)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/switchIfEmpty&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">switchIfEmpty</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; mono = <span class="hljs-title class_">Mono</span>.<span class="hljs-title function_">empty</span>()<br>                                .<span class="hljs-title function_">switchIfEmpty</span>(<span class="hljs-title class_">Mono</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;Fallback value&quot;</span>)); <br>        <span class="hljs-keyword">return</span> mono;<br>    &#125;<br><br>    <span class="hljs-comment">// 6. defaultIfEmpty(T defaultValue)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/defaultIfEmpty&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">defaultIfEmpty</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; mono = <span class="hljs-title class_">Mono</span>.&lt;<span class="hljs-title class_">String</span>&gt;<span class="hljs-title function_">empty</span>()<br>                                 .<span class="hljs-title function_">defaultIfEmpty</span>(<span class="hljs-string">&quot;Default value&quot;</span>); <br>        <span class="hljs-keyword">return</span> mono;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="5-2-3-3-过滤方法"><a href="#5-2-3-3-过滤方法" class="headerlink" title="5.2.3.3. 过滤方法"></a>5.2.3.3. 过滤方法</h6><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@RestController</span>  <br><span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">&quot;/api&quot;</span>)  <br>public class ReactiveExample &#123;  <br>  <br>    <span class="hljs-comment">// 1. filter(Predicate&lt;? super T&gt; predicate)  </span><br>    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">&quot;/filter&quot;</span>)  <br>    public Mono&lt;String&gt; <span class="hljs-built_in">filterExample</span>() &#123;  <br>        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Mono</span><span class="hljs-selector-class">.just</span>(<span class="hljs-string">&quot;admin&quot;</span>)  <br>                <span class="hljs-selector-class">.filter</span>(role -&gt; role.<span class="hljs-built_in">equals</span>(<span class="hljs-string">&quot;admin&quot;</span>))  <span class="hljs-comment">// 等于 admin 才能通过</span><br>                <span class="hljs-selector-class">.map</span>(r -&gt; <span class="hljs-string">&quot;权限验证通过：&quot;</span> + r)  <br>                <span class="hljs-selector-class">.defaultIfEmpty</span>(<span class="hljs-string">&quot;无权限，拒绝访问&quot;</span>);  <br>    &#125;  <br>  <br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="5-2-3-4-合并与组合方法"><a href="#5-2-3-4-合并与组合方法" class="headerlink" title="5.2.3.4. 合并与组合方法"></a>5.2.3.4. 合并与组合方法</h6><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@RestController</span>  <br><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">&quot;/api&quot;</span>)  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactiveExample</span> &#123;  <br>  <br>    <span class="hljs-comment">// 1. zipWith(Mono&lt;? extends U&gt;other，BiFunction&lt;T，U，R&gt;combiner)  </span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/zipWith&quot;</span>)  <br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">zipWithExample</span>(<span class="hljs-params"></span>) &#123;  <br>        <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; usernameMono = <span class="hljs-title class_">Mono</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;Alice&quot;</span>);  <br>        <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">Integer</span>&gt; ageMono = <span class="hljs-title class_">Mono</span>.<span class="hljs-title function_">just</span>(<span class="hljs-number">30</span>);  <br>  <br>        <span class="hljs-keyword">return</span> usernameMono.<span class="hljs-title function_">zipWith</span>(ageMono, (name, age) -&gt; name + <span class="hljs-string">&quot; 的年龄是 &quot;</span> + age); <span class="hljs-comment">// 输出：Alice 的年龄是 30    &#125;  </span><br>  <br>    <span class="hljs-comment">// 2. zip(Mono&lt;? extends T1&gt; m1, Mono&lt;? extends T2&gt; m2, ...)  </span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/zip&quot;</span>)  <br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">zipExample</span>(<span class="hljs-params"></span>) &#123;  <br>        <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; name = <span class="hljs-title class_">Mono</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;Bob&quot;</span>);  <br>        <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">Integer</span>&gt; score = <span class="hljs-title class_">Mono</span>.<span class="hljs-title function_">just</span>(<span class="hljs-number">95</span>);  <br>        <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; level = <span class="hljs-title class_">Mono</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;A&quot;</span>);  <br>  <br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Mono</span>.<span class="hljs-title function_">zip</span>(name, score, level)  <br>                .<span class="hljs-title function_">map</span>(tuple -&gt; &#123;  <br>                    <span class="hljs-title class_">String</span> n = tuple.<span class="hljs-title function_">getT1</span>();  <br>                    <span class="hljs-title class_">Integer</span> s = tuple.<span class="hljs-title function_">getT2</span>();  <br>                    <span class="hljs-title class_">String</span> l = tuple.<span class="hljs-title function_">getT3</span>();  <br>                    <span class="hljs-keyword">return</span> n + <span class="hljs-string">&quot; 的成绩是 &quot;</span> + s + <span class="hljs-string">&quot;，评级为 &quot;</span> + l;  <br>                &#125;);  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="5-2-3-5-错误处理方法"><a href="#5-2-3-5-错误处理方法" class="headerlink" title="5.2.3.5. 错误处理方法"></a>5.2.3.5. 错误处理方法</h6><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">&quot;/api&quot;</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorHandlingExamples</span> &#123;<br><br>    <span class="hljs-comment">// 1. onErrorReturn(T fallback)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/onErrorReturn&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">onErrorReturnExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Mono</span>.&lt;<span class="hljs-title class_">String</span>&gt;<span class="hljs-title function_">error</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;出错了&quot;</span>))<br>                .<span class="hljs-title function_">onErrorReturn</span>(<span class="hljs-string">&quot;返回默认值&quot;</span>); <span class="hljs-comment">// 一旦发生错误，发出默认值</span><br>    &#125;<br><br>    <span class="hljs-comment">// 2. onErrorMap(Function&lt;Throwable, ? extends Throwable&gt; mapper)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/onErrorMap&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">onErrorMapExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Mono</span>.&lt;<span class="hljs-title class_">String</span>&gt;<span class="hljs-title function_">error</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;原始异常&quot;</span>))<br>                .<span class="hljs-title function_">onErrorMap</span>(e -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomAppException</span>(<span class="hljs-string">&quot;转换后的业务异常&quot;</span>, e)); <span class="hljs-comment">// 异常转换</span><br>    &#125;<br><br>    <span class="hljs-comment">// 3. onErrorResume(Function&lt;Throwable, ? extends Publisher&lt;? extends T&gt;&gt; fallback)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/onErrorResume&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">onErrorResumeExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Mono</span>.&lt;<span class="hljs-title class_">String</span>&gt;<span class="hljs-title function_">fromCallable</span>(() -&gt; &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;数据库挂了&quot;</span>);<br>                &#125;)<br>                .<span class="hljs-title function_">onErrorResume</span>(e -&gt; &#123;<br>                    <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;发生错误，切换数据源：&quot;</span> + e.<span class="hljs-title function_">getMessage</span>());<br>                    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Mono</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;来自备用数据源的数据&quot;</span>);<br>                &#125;);<br>    &#125;<br><br>    <span class="hljs-comment">// 4. onErrorContinue(BiConsumer&lt;Throwable, Object&gt; errorConsumer)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/onErrorContinue&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">onErrorContinueExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>, <span class="hljs-string">&quot;C&quot;</span>)<br>                .<span class="hljs-title function_">map</span>(value -&gt; &#123;<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;error&quot;</span>.<span class="hljs-title function_">equals</span>(value)) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;处理失败：&quot;</span> + value);<br>                    &#125;<br>                    <span class="hljs-keyword">return</span> value.<span class="hljs-title function_">toLowerCase</span>();<br>                &#125;)<br>                .<span class="hljs-title function_">onErrorContinue</span>((e, val) -&gt;<br>                        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;跳过出错元素：&quot;</span> + val + <span class="hljs-string">&quot;，错误：&quot;</span> + e.<span class="hljs-title function_">getMessage</span>()));<br>    &#125;<br><br>    <span class="hljs-comment">// 5. retry(long times)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/retry&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">retryExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Mono</span>.&lt;<span class="hljs-title class_">String</span>&gt;<span class="hljs-title function_">fromCallable</span>(() -&gt; &#123;<br>                    <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;尝试一次&quot;</span>);<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;临时异常&quot;</span>);<br>                &#125;)<br>                .<span class="hljs-title function_">retry</span>(<span class="hljs-number">3</span>) <span class="hljs-comment">// 总共尝试4次</span><br>                .<span class="hljs-title function_">onErrorReturn</span>(<span class="hljs-string">&quot;尝试失败，返回默认&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<hr>
<h6 id="5-2-3-6-延迟与调度方法"><a href="#5-2-3-6-延迟与调度方法" class="headerlink" title="5.2.3.6. 延迟与调度方法"></a>5.2.3.6. 延迟与调度方法</h6><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(<span class="hljs-string">&quot;/api&quot;</span>)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactiveControlOperators</span> &#123;<br><br>    <span class="hljs-comment">// 1. delayElements(Duration delay)</span><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/delay&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> Flux&lt;String&gt; delayExample() &#123;<br>        <span class="hljs-keyword">return</span> Flux.just(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;C&quot;</span>)<br>                .delayElements(Duration.ofSeconds(<span class="hljs-number">1</span>))  <span class="hljs-comment">// 每个元素延迟 1 秒发出</span><br>                .map(s -&gt; <span class="hljs-string">&quot;发出元素：&quot;</span> + s);<br>    &#125;<br><br>    <span class="hljs-comment">// 2. subscribeOn(Scheduler scheduler)</span><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/subscribeOn&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> Mono&lt;String&gt; subscribeOnExample() &#123;<br>        <span class="hljs-keyword">return</span> Mono.fromCallable(() -&gt; &#123;<br>                    System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;执行线程：&quot;</span> + Thread.currentThread().getName());<br>                    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;任务完成&quot;</span>;<br>                &#125;)<br>                .subscribeOn(Schedulers.boundedElastic()); <span class="hljs-comment">// 指定任务在线程池中执行</span><br>    &#125;<br><br>    <span class="hljs-comment">// 3. publishOn(Scheduler scheduler)</span><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/publishOn&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> Mono&lt;String&gt; publishOnExample() &#123;<br>        <span class="hljs-keyword">return</span> Mono.just(<span class="hljs-string">&quot;原始数据&quot;</span>)<br>                .doOnNext(<span class="hljs-keyword">data</span> -&gt; System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;步骤1线程：&quot;</span> + Thread.currentThread().getName()))<br>                .publishOn(Schedulers.parallel())  <span class="hljs-comment">// 后续操作切换线程</span><br>                .map(<span class="hljs-keyword">data</span> -&gt; &#123;<br>                    System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;步骤2线程：&quot;</span> + Thread.currentThread().getName());<br>                    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;处理后的数据：&quot;</span> + <span class="hljs-keyword">data</span>;<br>                &#125;);<br>    &#125;<br><br>    <span class="hljs-comment">// 4. timeout(Duration timeout)</span><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/timeout&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> Mono&lt;String&gt; timeoutExample() &#123;<br>        <span class="hljs-keyword">return</span> Mono.delay(Duration.ofSeconds(<span class="hljs-number">3</span>)) <span class="hljs-comment">// 故意延迟</span><br>                .map(time -&gt; <span class="hljs-string">&quot;数据来了&quot;</span>)<br>                .timeout(Duration.ofSeconds(<span class="hljs-number">2</span>))  <span class="hljs-comment">// 设置超时时间</span><br>                .onErrorReturn(<span class="hljs-string">&quot;请求超时，返回默认值&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<hr>
<h6 id="5-2-3-7-其他实用方法"><a href="#5-2-3-7-其他实用方法" class="headerlink" title="5.2.3.7. 其他实用方法"></a>5.2.3.7. 其他实用方法</h6><table>
<thead>
<tr>
<th><code>doOnNext(Consumer&lt;? super T&gt; onNext)</code></th>
<th>每当流发出一个元素时执行指定副作用（如日志、指标统计），但不改变元素本身；就像在传送带上做一次检查打标。</th>
</tr>
</thead>
<tbody><tr>
<td><code>doOnError(Consumer&lt;? super Throwable&gt; onError)</code></td>
<td>流遇到错误时执行副作用（如记录日志、告警），然后再把错误继续抛给下游；适合在错误点插入埋点或监控。</td>
</tr>
<tr>
<td><code>doOnComplete(Runnable onComplete)</code></td>
<td>在流正常走完所有元素后执行一次副作用，如资源释放或完成通知；就像闭环操作中的收尾仪式。</td>
</tr>
<tr>
<td><code>doOnSubscribe(Consumer&lt;? super Subscription&gt; onSubscribe)</code></td>
<td>订阅者发起订阅时触发，用于记录或处理初次订阅行为，比如打日志或初始化状态。</td>
</tr>
<tr>
<td><code>doFinally(Consumer&lt;SignalType&gt; onFinally)</code></td>
<td>在流终止时（无论正常完成、取消、还是出错）都执行指定副作用，相当于 finally 块，常用于收尾清理等场景。</td>
</tr>
<tr>
<td><code>log()</code></td>
<td>自动在控制台打印 Mono 的信号轨迹，包括订阅、请求、发出元素、完成和错误，帮你像放监控摄像头一样随时看流水线状态。</td>
</tr>
<tr>
<td><code>cache()</code></td>
<td>将流转换为可重放的热流，缓存所有元素，后续订阅者会立刻看到之前的数据，无需再次执行上游逻辑；适合昂贵操作的结果复用。</td>
</tr>
<tr>
<td><code>share()</code></td>
<td>也会把 Cold Mono 变成 Hot Mono，但不缓存旧数据，所有订阅者共享同一份数据流，适合广播式分发；就像把演唱会直播送给多个观众同时观看。</td>
</tr>
</tbody></table>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(<span class="hljs-string">&quot;/api&quot;</span>)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SideEffectOperators</span> &#123;<br><br>    <span class="hljs-comment">// 1. doOnNext(Consumer&lt;? super T&gt; onNext)</span><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/doOnNext&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> Flux&lt;String&gt; doOnNextExample() &#123;<br>        <span class="hljs-keyword">return</span> Flux.just(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;C&quot;</span>)<br>                .doOnNext(<span class="hljs-keyword">val</span> -&gt; System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;元素通过检查：&quot;</span> + <span class="hljs-keyword">val</span>))<br>                .map(String::toLowerCase);<br>    &#125;<br><br>    <span class="hljs-comment">// 2. doOnError(Consumer&lt;? super Throwable&gt; onError)</span><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/doOnError&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> Mono&lt;String&gt; doOnErrorExample() &#123;<br>        <span class="hljs-keyword">return</span> Mono.&lt;String&gt;error(new RuntimeException(<span class="hljs-string">&quot;模拟错误&quot;</span>))<br>                .doOnError(err -&gt; System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;记录错误日志：&quot;</span> + err.getMessage()));<br>    &#125;<br><br>    <span class="hljs-comment">// 3. doOnComplete(Runnable onComplete)</span><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/doOnComplete&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> Flux&lt;String&gt; doOnCompleteExample() &#123;<br>        <span class="hljs-keyword">return</span> Flux.just(<span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>, <span class="hljs-string">&quot;3&quot;</span>)<br>                .doOnComplete(() -&gt; System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;流处理完毕，收工！&quot;</span>));<br>    &#125;<br><br>    <span class="hljs-comment">// 4.doOnSubscribe(Consumer&lt;? super Subscription&gt; onSubscribe)</span><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/doOnSubscribe&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> Mono&lt;String&gt; doOnSubscribeExample() &#123;<br>        <span class="hljs-keyword">return</span> Mono.just(<span class="hljs-string">&quot;准备启动流程&quot;</span>)<br>                .doOnSubscribe(sub -&gt; System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;收到订阅请求，开始处理&quot;</span>));<br>    &#125;<br><br>    <span class="hljs-comment">// 5. doFinally(Consumer&lt;SignalType&gt; onFinally)</span><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/doFinally&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> Mono&lt;String&gt; doFinallyExample() &#123;<br>        <span class="hljs-keyword">return</span> Mono.just(<span class="hljs-string">&quot;最终操作&quot;</span>)<br>                .map(<span class="hljs-keyword">val</span> -&gt; &#123;<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">val</span>.equals(<span class="hljs-string">&quot;最终操作&quot;</span>)) <span class="hljs-keyword">throw</span> new RuntimeException(<span class="hljs-string">&quot;模拟终止&quot;</span>);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">val</span>;<br>                &#125;)<br>                .doFinally(signal -&gt; System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;流终止信号类型：&quot;</span> + signal));<br>    &#125;<br><br>    <span class="hljs-comment">// 6. log()</span><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/log&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> Flux&lt;String&gt; logExample() &#123;<br>        <span class="hljs-keyword">return</span> Flux.just(<span class="hljs-string">&quot;X&quot;</span>, <span class="hljs-string">&quot;Y&quot;</span>, <span class="hljs-string">&quot;Z&quot;</span>)<br>                .log(); <span class="hljs-comment">// 控制台打印信号日志（订阅、请求、发出、完成等）</span><br>    &#125;<br><br>    <span class="hljs-comment">// 7. cache()</span><br>    Mono&lt;String&gt; cachedMono = Mono.fromSupplier(() -&gt; &#123;<br>        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;执行昂贵操作...&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;昂贵结果&quot;</span>;<br>    &#125;).cache();<br><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/cache&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> Mono&lt;String&gt; cacheExample() &#123;<br>        <span class="hljs-keyword">return</span> cachedMono; <span class="hljs-comment">// 不会再次执行昂贵操作</span><br>    &#125;<br><br>    <span class="hljs-comment">// 8. share()</span><br>    Flux&lt;<span class="hljs-built_in">Long</span>&gt; sharedFlux = Flux.interval(Duration.ofSeconds(<span class="hljs-number">1</span>))<br>            .map(<span class="hljs-keyword">val</span> -&gt; <span class="hljs-keyword">val</span> + <span class="hljs-number">1</span>)<br>            .doOnSubscribe(sub -&gt; System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;开始生成直播数据&quot;</span>))<br>            .share();<br><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/share&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> Flux&lt;<span class="hljs-built_in">Long</span>&gt; shareExample() &#123;<br>        <span class="hljs-keyword">return</span> sharedFlux.take(<span class="hljs-number">5</span>); <span class="hljs-comment">// 每个订阅者看到的是“正在直播”的状态</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="5-2-3-8-订阅方法"><a href="#5-2-3-8-订阅方法" class="headerlink" title="5.2.3.8. 订阅方法"></a>5.2.3.8. 订阅方法</h6><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(<span class="hljs-string">&quot;/api&quot;</span>)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SubscribeVariants</span> &#123;<br><br>    <span class="hljs-comment">// 1. subscribe()</span><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/subscribe-empty&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> String subscribeEmptyExample() &#123;<br>        Flux&lt;String&gt; flux = Flux.just(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;C&quot;</span>)<br>                .doOnNext(<span class="hljs-keyword">val</span> -&gt; System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;处理元素：&quot;</span> + <span class="hljs-keyword">val</span>));<br><br>        flux.subscribe(); <span class="hljs-comment">// 什么都不处理，但触发了执行</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;subscribe() 执行完毕（请看控制台）&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 2. subscribe(Consumer&lt;? super T&gt; onNext)</span><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/subscribe-onNext&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> String subscribeOnNextExample() &#123;<br>        Flux&lt;String&gt; flux = Flux.just(<span class="hljs-string">&quot;X&quot;</span>, <span class="hljs-string">&quot;Y&quot;</span>, <span class="hljs-string">&quot;Z&quot;</span>);<br><br>        flux.subscribe(<span class="hljs-keyword">val</span> -&gt; System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;收到元素：&quot;</span> + <span class="hljs-keyword">val</span>));<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;subscribe(onNext) 执行完毕（请看控制台）&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 3. subscribe(Consumer&lt;? super T&gt; onNext, Consumer&lt;? super Throwable&gt; onError, Runnable onComplete)</span><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/subscribe-full&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> String subscribeFullExample() &#123;<br>        Flux&lt;String&gt; flux = Flux.just(<span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>, <span class="hljs-string">&quot;3&quot;</span>)<br>                .map(<span class="hljs-keyword">val</span> -&gt; &#123;<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">val</span>.equals(<span class="hljs-string">&quot;error&quot;</span>)) &#123;<br>                        <span class="hljs-keyword">throw</span> new RuntimeException(<span class="hljs-string">&quot;遇到非法值：&quot;</span> + <span class="hljs-keyword">val</span>);<br>                    &#125;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">val</span>;<br>                &#125;);<br><br>        flux.subscribe(<br>                <span class="hljs-keyword">val</span> -&gt; System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;接收到：&quot;</span> + <span class="hljs-keyword">val</span>),<br>                err -&gt; System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;发生错误：&quot;</span> + err.getMessage()),<br>                () -&gt; System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;流处理完成！&quot;</span>)<br>        );<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;subscribe(onNext, onError, onComplete) 执行完毕（请看控制台）&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="6-Flux"><a href="#6-Flux" class="headerlink" title="6. Flux"></a>6. Flux</h3><h4 id="6-1-Flux-相关方法"><a href="#6-1-Flux-相关方法" class="headerlink" title="6.1. Flux 相关方法"></a>6.1. Flux 相关方法</h4><h5 id="6-1-1-Flux-实例创建方法"><a href="#6-1-1-Flux-实例创建方法" class="headerlink" title="6.1.1. Flux 实例创建方法"></a>6.1.1. Flux 实例创建方法</h5><p>&#x3D;&#x3D;1.从已有数据构建流&#x3D;&#x3D;<br>当你手头已经有数据（数组、集合、Stream 等），直接封装成 Flux 发出去。</p>
<ol>
<li><code>Flux.just(T... data)</code><ol>
<li>从确定且非 <code>null</code> 的值创建 Flux（可以为空字符串 <code>&quot;&quot;</code>），<strong>依次</strong>发出各值所有元素，适合少量数据</li>
</ol>
</li>
<li><code>Flux.fromArray(T[] array)</code><ol>
<li>从 <code>Array</code> 数组创建 Flux</li>
</ol>
</li>
<li><code>Flux.fromIterable(Iterable&lt;T&gt; it)</code>：<ol>
<li>从 <code>Iterable</code>创建 Flux（List、Set、Queue），依次发出所有元素<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">&quot;/api&quot;</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactiveExample</span> &#123;<br><br>    <span class="hljs-comment">// 1. Flux.just(T... data)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/just&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">just</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;C&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 2. Flux.fromArray(T[] array)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/fromArray&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">fromArray</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">String</span>[] arr = &#123;<span class="hljs-string">&quot;X&quot;</span>, <span class="hljs-string">&quot;Y&quot;</span>, <span class="hljs-string">&quot;Z&quot;</span>&#125;;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">fromArray</span>(arr);<br>    &#125;<br><br>    <span class="hljs-comment">// 3. Flux.fromIterable(Iterable&lt;T&gt; it)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/fromIterable&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">Integer</span>&gt; <span class="hljs-title function_">fromIterable</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">Integer</span>&gt; list = <span class="hljs-title class_">Arrays</span>.<span class="hljs-title function_">asList</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">fromIterable</span>(list);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<p>&#x3D;&#x3D;2.按规则动态生成数据&#x3D;&#x3D;<br>不依赖已有数据，而是代码里一个个“造”出来，适合序列、状态机等。</p>
<ol>
<li><code>Flux.range(int start, int count)</code><ol>
<li>创建一个从 start 开始，连续发出 count 个整数的 Flux。</li>
</ol>
</li>
<li><code>Flux.generate(Callable&lt;S&gt; stateSupplier，BiFunction&lt;S，SynchronousSink&lt;T&gt;，S&gt;generator)</code><ol>
<li>动态生成元素，适合需要状态控制的场景。</li>
</ol>
</li>
<li><code>Flux.defer(Supplier&lt;? extends Publisher&lt;T&gt;&gt; supplier)</code><ol>
<li>延迟创建 <code>Flux</code>，每次订阅时重新生成数据<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs pf">@RestController<br>@RequestMapping(<span class="hljs-string">&quot;/api&quot;</span>)<br>public class ReactiveExample &#123;<br><br>    // <span class="hljs-number">1</span>. Flux.range(int start, int count)<br>    @GetMapping(<span class="hljs-string">&quot;/range&quot;</span>)<br>    public Flux<span class="hljs-variable">&lt;Integer&gt;</span> range() &#123;<br>        return Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>);<br>    &#125;<br><br>    // <span class="hljs-number">2</span>. Flux.generate(Callable<span class="hljs-variable">&lt;S&gt;</span> <span class="hljs-keyword">state</span>Supplier, BiFunction<span class="hljs-variable">&lt;S, SynchronousSink&lt;T&gt;</span>, S&gt; generator)<br>    @GetMapping(<span class="hljs-string">&quot;/generate&quot;</span>)<br>    public Flux<span class="hljs-variable">&lt;Integer&gt;</span> generate() &#123;<br>        return Flux.generate(<br>            () -&gt; <span class="hljs-number">0</span>,<br>            (<span class="hljs-keyword">state</span>, sink) -&gt; &#123;<br>                sink.next(<span class="hljs-keyword">state</span>);<br>                if (<span class="hljs-keyword">state</span> &gt;= <span class="hljs-number">4</span>) sink.complete();<br>                return <span class="hljs-keyword">state</span> + <span class="hljs-number">1</span>;<br>            &#125;<br>        );<br>    &#125;<br><br>    // <span class="hljs-number">3</span>. Flux.defer(Supplier<span class="hljs-variable">&lt;? extends Publisher&lt;T&gt;</span>&gt; supplier)<br>    @GetMapping(<span class="hljs-string">&quot;/defer&quot;</span>)<br>    public Flux<span class="hljs-variable">&lt;Long&gt;</span> defer() &#123;<br>        return Flux.defer(() -&gt; Flux.just(System.currentTimeMillis()));<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<p>&#x3D;&#x3D;3.基于异步回调的数据流&#x3D;&#x3D;<br>数据来自外部事件、回调、异步任务，推模式为主。</p>
<ol>
<li><code>Flux.create(Consumer&lt;FluxSink&lt;T&gt;&gt;emitter)</code><ol>
<li>提供更灵活的控制，适合异步或外部事件驱动的场景。<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@RestController</span><br><span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">&quot;/api&quot;</span>)<br>public class ReactiveExample &#123;<br><br>    <span class="hljs-comment">// 1. Flux.create(Consumer&lt;FluxSink&lt;T&gt;&gt; emitter)</span><br>    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">&quot;/create&quot;</span>)<br>    public Flux&lt;String&gt; <span class="hljs-built_in">create</span>() &#123;<br>        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Flux</span><span class="hljs-selector-class">.create</span>(emitter -&gt; &#123;<br>            <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">Thread</span>(() -&gt; &#123;<br>                <span class="hljs-selector-tag">emitter</span><span class="hljs-selector-class">.next</span>(<span class="hljs-string">&quot;async-1&quot;</span>);<br>                <span class="hljs-selector-tag">emitter</span><span class="hljs-selector-class">.next</span>(<span class="hljs-string">&quot;async-2&quot;</span>);<br>                <span class="hljs-selector-tag">emitter</span><span class="hljs-selector-class">.complete</span>();<br>            &#125;)<span class="hljs-selector-class">.start</span>();<br>        &#125;);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<p>&#x3D;&#x3D;4.基于时间调度创建流&#x3D;&#x3D;<br>按照固定时间间隔发出数据，用于轮询、心跳、定时任务等。</p>
<ol>
<li><code>Flux.interval(Duration period)</code><ol>
<li>按固定时间间隔发出递增的长整型数字（从 0 开始）</li>
</ol>
</li>
<li><code>Flux.interval(Duration delay, Duration period)</code><ol>
<li>指定初始延迟和间隔时间<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(<span class="hljs-string">&quot;/api&quot;</span>)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactiveExample</span> &#123;<br><br>    <span class="hljs-comment">// 1. Flux.interval(Duration period)</span><br>    <span class="hljs-meta">@GetMapping(value = <span class="hljs-string">&quot;/interval&quot;</span>, produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span><br>    <span class="hljs-keyword">public</span> Flux&lt;<span class="hljs-built_in">Long</span>&gt; interval() &#123;<br>        <span class="hljs-keyword">return</span> Flux.interval(Duration.ofSeconds(<span class="hljs-number">1</span>));<br>    &#125;<br><br>    <span class="hljs-comment">// 2. Flux.interval(Duration delay, Duration period)</span><br>    <span class="hljs-meta">@GetMapping(value = <span class="hljs-string">&quot;/intervalWithDelay&quot;</span>, produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span><br>    <span class="hljs-keyword">public</span> Flux&lt;<span class="hljs-built_in">Long</span>&gt; intervalWithDelay() &#123;<br>        <span class="hljs-keyword">return</span> Flux.interval(Duration.ofSeconds(<span class="hljs-number">3</span>), Duration.ofSeconds(<span class="hljs-number">1</span>));<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<p>&#x3D;&#x3D;5.控制型流（空流、异常、无限挂起）&#x3D;&#x3D;<br>不发真实数据，用于流程控制、占位、异常测试等。</p>
<ol>
<li><code>Flux.empty()</code><ol>
<li>创建一个不发出任何元素直接完成的 &#96;Flux</li>
</ol>
</li>
<li><code>Flux.error(Throwable throwable)</code><ol>
<li>创建一个发出错误信号的 <code>Flux</code>。</li>
</ol>
</li>
<li><code>Flux.never()</code><ol>
<li>创建一个不发出任何信号（不发出元素、不完成、不出错）的 <code>Flux</code>。<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">&quot;/api&quot;</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactiveExample</span> &#123;<br><br>    <span class="hljs-comment">// 1. Flux.empty()</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/empty&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">empty</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">empty</span>();<br>    &#125;<br><br>    <span class="hljs-comment">// 2. Flux.error(Throwable throwable)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/error&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">error</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">error</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Something went wrong&quot;</span>));<br>    &#125;<br><br>    <span class="hljs-comment">// 3. Flux.never()</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/never&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">never</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">never</span>();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<p>&#x3D;&#x3D;6.组合多个流&#x3D;&#x3D;<br>不生成新数据，而是对多个已有 Flux 进行组合或转换。</p>
<ol>
<li><code>Flux.from(Publisher&lt;? extends T&gt; source)</code><ol>
<li>从另一个 <code>Publisher</code>（如 <code>Mono</code> 或其他 <code>Flux</code>）创建 <code>Flux</code>。</li>
</ol>
</li>
<li><code>Flux.concat(Publisher&lt;? extends T&gt;... sources)</code><ol>
<li>按顺序连接多个 <code>Publisher</code>，依次发出它们的元素</li>
</ol>
</li>
<li><code>Flux.merge(Publisher&lt;? extends T&gt;... sources)</code><ol>
<li>合并多个 <code>Publisher</code>，异步发出元素（不保证顺序)）</li>
</ol>
</li>
<li><code>Flux.zip(Publisher&lt;? extends T1&gt; source1, Publisher&lt;? extends T2&gt; source2, ...)</code><ol>
<li>将多个 <code>Publisher</code> 的元素组合成元组。<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">&quot;/api&quot;</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactiveExample</span> &#123;<br><br>    <span class="hljs-comment">// 1. Flux.from(Publisher&lt;? extends T&gt; source)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/fromPublisher&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">fromPublisher</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">Mono</span>&lt;<span class="hljs-title class_">String</span>&gt; mono = <span class="hljs-title class_">Mono</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;Mono data&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">from</span>(mono);<br>    &#125;<br><br>    <span class="hljs-comment">// 2. Flux.concat(Publisher&lt;? extends T&gt;... sources)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/concat&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">concat</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; flux1 = <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>);<br>        <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; flux2 = <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;C&quot;</span>, <span class="hljs-string">&quot;D&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">concat</span>(flux1, flux2);<br>    &#125;<br><br>    <span class="hljs-comment">// 3. Flux.merge(Publisher&lt;? extends T&gt;... sources)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/merge&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">merge</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; flux1 = <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>);<br>        <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; flux2 = <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;C&quot;</span>, <span class="hljs-string">&quot;D&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">merge</span>(flux1, flux2);<br>    &#125;<br><br>    <span class="hljs-comment">// 4. Flux.zip(Publisher&lt;? extends T1&gt; source1, Publisher&lt;? extends T2&gt; source2, ...)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/zip&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">zip</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; flux1 = <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>);<br>        <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; flux2 = <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">zip</span>(flux1, flux2, (s1, s2) -&gt; s1 + s2);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<hr>
<h5 id="6-1-2-flux-对象实例方法"><a href="#6-1-2-flux-对象实例方法" class="headerlink" title="6.1.2. flux 对象实例方法"></a>6.1.2. flux 对象实例方法</h5><h6 id="6-1-2-1-实例方法一览表"><a href="#6-1-2-1-实例方法一览表" class="headerlink" title="6.1.2.1. 实例方法一览表"></a>6.1.2.1. 实例方法一览表</h6><table>
<thead>
<tr>
<th><strong>实例方法</strong></th>
<th><strong>功能描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>转换与映射方法</strong></td>
<td></td>
</tr>
<tr>
<td><code>map(Function&lt;? super T, ? extends R&gt; mapper)</code></td>
<td>对流中每个元素应用提供的函数（同步简单操作），将它从类型 T 变换成类型 R。<br>与 <code>flatMap</code> 不同点在于：<code>map</code> 是同步操作，结果通常是原始类型转换，没有异步流。</td>
</tr>
<tr>
<td><code>flatMap(Function&lt;? super T, ? extends Publisher&lt;? extends R&gt;&gt; mapper)</code></td>
<td>对每个元素执行一个异步操作（异步阻塞、异步非阻塞），返回一个新的异步流，并将所有这些异步流与元素合并成一个流。<br>“展平”的意思是把多个 Publisher 的流合成一个统一的 Flux。</td>
</tr>
<tr>
<td><code>cast(Class&lt;R&gt; clazz)</code></td>
<td>将流中元素强制转换为类型 R；若元素类型与 R 无继承或实现关系（即类型不兼容），将抛出 <code>ClassCastException</code> 异常。</td>
</tr>
<tr>
<td><code>ofType(Class&lt;U&gt; clazz)</code></td>
<td>仅保留属于指定类型 U 的元素，过滤掉其他类型的元素。</td>
</tr>
<tr>
<td><code>switchIfEmpty(Publisher&lt;? extends T&gt; alternate)</code></td>
<td>如果 Flux 为空（没有发出任何元素就完成），则切换到指定的备用 Publisher（如另一个 Flux 或 Mono）继续发出元素。<br>注意：是整个 Flux 为空，而不是某个元素为空</td>
</tr>
<tr>
<td><code>defaultIfEmpty(T defaultValue)</code></td>
<td>如果 Flux 为空（没有发出任何元素就完成），则发出指定的默认值（可以是流，也可以不是流）并完成。<br>与 <code>switchIfEmpty</code> 不同点在于：<code>defaultIfEmpty</code> 提供的是一个固定的同步值，而不是另一个异步流。适用于简单场景，如为空时返回默认字符串或对象。</td>
</tr>
<tr>
<td><strong>过滤方法</strong></td>
<td></td>
</tr>
<tr>
<td><code>filter(Predicate&lt;? super T&gt; predicate)</code></td>
<td>对每个元素执行断言函数，仅保留返回 <code>true</code> 的元素，返回 <code>false</code> 的元素将被过滤掉（满足条件的保留）。</td>
</tr>
<tr>
<td><code>distinct()</code></td>
<td>去重操作，移除重复元素，确保每个元素在流中只出现一次（对整个流去重，不论是否分批加载）。<br>核心机制：维护一个 <code>HashSet</code> 来记录已发出的元素。每当一个新元素准备推送时，都会先检查是否已存在于集合中。若处理的数据流非常大（如百万级），这个集合可能迅速膨胀，占用大量内存。</td>
</tr>
<tr>
<td><strong>收集与聚合方法</strong></td>
<td></td>
</tr>
<tr>
<td><code>collectList()</code></td>
<td>等到整个流执行完毕（无论是否分批加载），所有元素会被收集进一个 <code>List</code>，并最终通过 <code>Mono&lt;List&gt;</code> 一次性发送。例如：<code>Flux.just(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;).collectList();</code> 会返回 <code>[&quot;A&quot;, &quot;B&quot;, &quot;C&quot;]</code>。</td>
</tr>
<tr>
<td><code>collectMultimap(Function&lt;? super T, ? extends K&gt; keyMapper)</code></td>
<td>使用 keyMapper 为每个元素生成键，将元素本身作为值，汇聚到一个 <code>Map&lt;K, Collection&lt;T&gt;&gt;</code> 里，并封装成 <code>Mono&lt;Map&lt;K, Collection&lt;T&gt;&gt;&gt;</code> 返回，就像按标签分门别类地整理档案。</td>
</tr>
<tr>
<td><code>reduce(BiFunction&lt;T, T, T&gt; aggregator)</code></td>
<td>对流中元素进行两两累积，将前一次计算结果与下一个元素交给 aggregator 处理，最终合成一个值并通过 Mono 发出。常用于求和、拼接字符串、数据汇总等。</td>
</tr>
<tr>
<td><code>scan(BiFunction&lt;T, T, T&gt; accumulator)</code></td>
<td>类似 reduce，但每遇到一个新元素就会「打卡」一次，立刻把当前的累积结果发出来——就好比你在跑步时，每跑一公里就看一次手表，实时掌握进度。</td>
</tr>
<tr>
<td><strong>合并与组合方法</strong></td>
<td></td>
</tr>
<tr>
<td><code>mergeWith(Publisher&lt;? extends T&gt; other)</code></td>
<td>并行地把另一个流的元素插入当前流，不保证顺序——就像把两条河的水汇入同一个大江，水流混杂而不分先后。</td>
</tr>
<tr>
<td><code>concatWith(Publisher&lt;? extends T&gt; other)</code></td>
<td>先发完当前流所有元素，再按顺序接入另一个流，保证完全的先后顺序，就像礼貌地排队，前面的人走完后才轮到后面。</td>
</tr>
<tr>
<td><code>zipWith(Publisher&lt;? extends U&gt; other)</code></td>
<td>两个流按索引位置逐个配对生成 <code>Tuple2&lt;T, U&gt;</code>，如 flux1 的第一个元素配 flux2 的第一个元素；当任一流提前结束，组合流也会结束。适用于必须一一对应的场景。</td>
</tr>
<tr>
<td><code>combineLatest(Publisher&lt;? extends U&gt; other, BiFunction&lt;T, U, R&gt; combinator)</code></td>
<td>订阅两个流，并在任一流发出新元素时，取对方最新值一起合并发出。</td>
</tr>
<tr>
<td><strong>限制与截取方法</strong></td>
<td></td>
</tr>
<tr>
<td><code>take(long n)</code></td>
<td>只接收前 n 个元素，下游收到 n 个后就主动完成，适合取样或分页场景。</td>
</tr>
<tr>
<td><code>takeLast(int n)</code></td>
<td>缓存发出的所有元素，等整个流执行完毕才一次性发出最后 n 个元素；常用于需要尾部数据的情况，但要注意内存开销。</td>
</tr>
<tr>
<td><code>skip(long n)</code></td>
<td>忽略前 n 个元素，直接跳过，再把剩余元素发给下游。</td>
</tr>
<tr>
<td><code>skipLast(int n)</code></td>
<td>缓存发出的所有元素，等整个流执行完毕后丢弃最后 n 个元素，再把剩下的一起发出。</td>
</tr>
<tr>
<td><strong>错误处理方法</strong></td>
<td></td>
</tr>
<tr>
<td><code>onErrorReturn(T fallback)</code></td>
<td>一旦上游发生错误，就发出一个默认值（可以是流也可以不是流），不再传递错误信号。</td>
</tr>
<tr>
<td><code>onErrorMap(Function&lt;Throwable, ? extends Throwable&gt; mapper)</code></td>
<td>捕获异常并将其包装或转换为另一种更具语义的异常类型，然后重新发出错误信号，便于统一上层错误处理策略。简单来说：异常 A -&gt; 异常 X，上层统一处理异常 X。</td>
</tr>
<tr>
<td><code>onErrorResume(Function&lt;Throwable, ? extends Publisher&lt;? extends T&gt;&gt; fallback)</code></td>
<td>错误发生时，切换到备用的 Publisher 继续发出元素，避免整个流被中断，可用于降级、重试或备用数据源。</td>
</tr>
<tr>
<td><code>onErrorContinue(BiConsumer&lt;Throwable, Object&gt; errorConsumer)</code></td>
<td>对单个元素处理出错时只执行指定副作用（如记录日志），并跳过该元素继续后续处理，下游不会收到错误；相当于「有容错的流水线」。</td>
</tr>
<tr>
<td><code>retry(long times)</code></td>
<td>出错时将重试整个 Flux 上游 <code>times</code> 次（总共尝试 1 + times 次）。</td>
</tr>
<tr>
<td><strong>延迟与调度方法</strong></td>
<td></td>
</tr>
<tr>
<td><code>delayElements(Duration delay)</code></td>
<td>给每个元素之间插入固定延迟，模拟节流或人为降速，就像每隔一秒钟才放一个包裹。</td>
</tr>
<tr>
<td><code>subscribeOn(Scheduler scheduler)</code></td>
<td>指定整个订阅过程在哪个调度器线程上运行（影响源的执行线程）<br>注意：多个 <code>subscribeOn</code> 只会生效第一个</td>
</tr>
<tr>
<td><code>publishOn(Scheduler scheduler)</code></td>
<td>指定 <code>publishOn</code> 之后的操作在那个线程池执行</td>
</tr>
<tr>
<td><code>timeout(Duration timeout)</code></td>
<td>设置超时时间，如果某个元素未在规定时间内到达，就抛出 <code>TimeoutException</code>，用于超时控制</td>
</tr>
<tr>
<td><strong>其他实用方法</strong></td>
<td></td>
</tr>
<tr>
<td><code>doOnNext(Consumer&lt;? super T&gt; onNext)</code></td>
<td>每当流发出一个元素时执行指定副作用（如日志、指标统计），但不改变元素本身；就像在传送带上做一次检查打标。</td>
</tr>
<tr>
<td><code>doOnError(Consumer&lt;? super Throwable&gt; onError)</code></td>
<td>流遇到错误时执行副作用（如记录日志、告警），然后再把错误继续抛给下游；适合在错误点插入埋点或监控。</td>
</tr>
<tr>
<td><code>doOnComplete(Runnable onComplete)</code></td>
<td>在流正常走完所有元素后执行一次副作用，如资源释放或完成通知；就像闭环操作中的收尾仪式。</td>
</tr>
<tr>
<td><code>doOnSubscribe(Consumer&lt;? super Subscription&gt; onSubscribe)</code></td>
<td>订阅者发起订阅时触发，用于记录或处理初次订阅行为，比如打日志或初始化状态。</td>
</tr>
<tr>
<td><code>doFinally(Consumer&lt;SignalType&gt; onFinally)</code></td>
<td>在流终止时（无论正常完成、取消、还是出错）都执行指定副作用，相当于 finally 块，常用于收尾清理等场景。</td>
</tr>
<tr>
<td><code>log()</code></td>
<td>自动在控制台打印 Flux 的信号轨迹，包括订阅、请求、发出元素、完成和错误，帮你像放监控摄像头一样随时看流水线状态。</td>
</tr>
<tr>
<td><code>cache()</code></td>
<td>将流转换为可重放的热流，缓存所有元素，后续订阅者会立刻看到之前的数据，无需再次执行上游逻辑；适合昂贵操作的结果复用。</td>
</tr>
<tr>
<td><code>share()</code></td>
<td>也会把 Cold Flux 变成 Hot Flux，但不缓存旧数据，所有订阅者共享同一份数据流，适合广播式分发；就像把演唱会直播送给多个观众同时观看。</td>
</tr>
<tr>
<td><strong>订阅方法</strong></td>
<td></td>
</tr>
<tr>
<td><code>subscribe()</code></td>
<td>触发流的执行，<strong>不处理任何信号</strong>（元素、错误、完成），</td>
</tr>
<tr>
<td><code>subscribe(Consumer&lt;? super T&gt; onNext)</code></td>
<td>触发流的执行，只处理正常发出的元素，不管错误或完成</td>
</tr>
<tr>
<td><code>subscribe(Consumer&lt;? super T&gt; onNext, Consumer&lt;? super Throwable&gt; onError, Runnable onComplete)</code></td>
<td>触发流的执行，分别处理元素、错误、完成 三种信号</td>
</tr>
</tbody></table>
<hr>
<h6 id="6-1-2-2-转换与映射方法"><a href="#6-1-2-2-转换与映射方法" class="headerlink" title="6.1.2.2. 转换与映射方法"></a>6.1.2.2. 转换与映射方法</h6><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">&quot;/api/operators&quot;</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OperatorExamples</span> &#123;<br><br>    <span class="hljs-comment">// 1. map(Function&lt;? super T, ? extends R&gt; mapper)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/map&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">Integer</span>&gt; <span class="hljs-title function_">mapExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>, <span class="hljs-string">&quot;3&quot;</span>)<br>                   .<span class="hljs-title function_">map</span>(<span class="hljs-title class_">Integer</span>::<span class="hljs-built_in">parseInt</span>); <span class="hljs-comment">// 将 String 类型转换成 Integer 类型</span><br>    &#125;<br><br>    <span class="hljs-comment">// 2. flatMap(Function&lt;? super T, ? extends Publisher&lt;? extends R&gt;&gt; mapper)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/flatMap&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">flatMapExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;user1&quot;</span>, <span class="hljs-string">&quot;user2&quot;</span>)<br>                   .<span class="hljs-title function_">flatMap</span>(userId -&gt; <span class="hljs-title class_">Mono</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;Profile of &quot;</span> + userId)); <span class="hljs-comment">// 模拟异步调用</span><br>    &#125;<br><br>    <span class="hljs-comment">// 3. cast(Class&lt;R&gt; clazz)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/cast&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">Number</span>&gt; <span class="hljs-title function_">castExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2.0</span>, 3L)<br>                   .<span class="hljs-title function_">cast</span>(<span class="hljs-title class_">Number</span>.<span class="hljs-property">class</span>); <span class="hljs-comment">// 所有元素都可以被安全地转为 Number 类型</span><br>    &#125;<br><br>    <span class="hljs-comment">// 4. ofType(Class&lt;U&gt; clazz)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/ofType&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">Integer</span>&gt; <span class="hljs-title function_">ofTypeExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;two&quot;</span>, <span class="hljs-number">3</span>, <span class="hljs-string">&quot;four&quot;</span>)<br>                   .<span class="hljs-title function_">ofType</span>(<span class="hljs-title class_">Integer</span>.<span class="hljs-property">class</span>); <span class="hljs-comment">// 只保留 Integer 类型的元素</span><br>    &#125;<br>    <br>	<span class="hljs-comment">// 5. switchIfEmpty(Publisher&lt;? extends T&gt; alternate)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/switchIfEmpty&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">switchIfEmptyExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.&lt;<span class="hljs-title class_">String</span>&gt;<span class="hljs-title function_">empty</span>()<br>                   .<span class="hljs-title function_">switchIfEmpty</span>(<span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;default1&quot;</span>, <span class="hljs-string">&quot;default2&quot;</span>));<br>    &#125;<br><br>    <span class="hljs-comment">// 6. defaultIfEmpty(T defaultValue)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/defaultIfEmpty&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">defaultIfEmptyExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.&lt;<span class="hljs-title class_">String</span>&gt;<span class="hljs-title function_">empty</span>()<br>                   .<span class="hljs-title function_">defaultIfEmpty</span>(<span class="hljs-string">&quot;default-value&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="6-1-2-3-过滤方法"><a href="#6-1-2-3-过滤方法" class="headerlink" title="6.1.2.3. 过滤方法"></a>6.1.2.3. 过滤方法</h6><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(<span class="hljs-string">&quot;/api/operators&quot;</span>)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OperatorExamples</span> &#123;<br><br>    <span class="hljs-comment">// 1. filter(Predicate&lt;? super T&gt; predicate)</span><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/filter&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> Flux&lt;String&gt; filterExample() &#123;<br>        <span class="hljs-keyword">return</span> Flux.just(<span class="hljs-string">&quot;apple&quot;</span>, <span class="hljs-string">&quot;banana&quot;</span>, <span class="hljs-string">&quot;cherry&quot;</span>, <span class="hljs-string">&quot;date&quot;</span>)<br>                   .filter(fruit -&gt; fruit.startsWith(<span class="hljs-string">&quot;a&quot;</span>)); <span class="hljs-comment">// 只保留以 &quot;a&quot; 开头的元素</span><br>    &#125;<br><br>    <span class="hljs-comment">// 2. distinct()</span><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/distinct&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> Flux&lt;String&gt; distinctExample() &#123;<br>        <span class="hljs-keyword">return</span> Flux.just(<span class="hljs-string">&quot;apple&quot;</span>, <span class="hljs-string">&quot;banana&quot;</span>, <span class="hljs-string">&quot;apple&quot;</span>, <span class="hljs-string">&quot;cherry&quot;</span>, <span class="hljs-string">&quot;banana&quot;</span>)<br>                   .distinct(); <span class="hljs-comment">// 去除重复元素，确保每个元素只出现一次</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="6-1-2-4-收集与聚合方法"><a href="#6-1-2-4-收集与聚合方法" class="headerlink" title="6.1.2.4. 收集与聚合方法"></a>6.1.2.4. 收集与聚合方法</h6><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript">@RestController<br>@RequestMapping(<span class="hljs-string">&quot;/api/operators&quot;</span>)<br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">OperatorExamples</span> &#123;<br><br>    <span class="hljs-regexp">//</span> <span class="hljs-number">1.</span> collectList()<br>    @GetMapping(<span class="hljs-string">&quot;/collectList&quot;</span>)<br>    public Mono&lt;List&lt;<span class="hljs-built_in">String</span>&gt;&gt; collectListExample() &#123;<br>        <span class="hljs-keyword">return</span> Flux.just(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;C&quot;</span>)<br>                   .collectList(); <span class="hljs-regexp">//</span> 返回：[<span class="hljs-string">&quot;A&quot;</span>,<span class="hljs-string">&quot;B&quot;</span>,<span class="hljs-string">&quot;C&quot;</span>]<br>    &#125;<br><br>    <span class="hljs-regexp">//</span> <span class="hljs-number">2.</span> collectMultiMap(<span class="hljs-built_in">Function</span>&lt;? super T, ? <span class="hljs-keyword">extends</span> K&gt; keyMapper)<br>	@GetMapping(<span class="hljs-string">&quot;/collectMap&quot;</span>)  <br>	public Mono&lt;<span class="hljs-built_in">Map</span>&lt;Character, Collection&lt;<span class="hljs-built_in">String</span>&gt;&gt;&gt; collectMapExample() &#123;  <br>	    <span class="hljs-keyword">return</span> Flux.just(<span class="hljs-string">&quot;apple&quot;</span>, <span class="hljs-string">&quot;banana&quot;</span>, <span class="hljs-string">&quot;apricot&quot;</span>)  <br>            .collectMultimap(word -&gt; word.charAt(<span class="hljs-number">0</span>)); <span class="hljs-regexp">//</span> 用每个单词的首字母作为 key，返回：&#123;<span class="hljs-string">&quot;a&quot;</span>:[<span class="hljs-string">&quot;apple&quot;</span>,<span class="hljs-string">&quot;apricot&quot;</span>],<span class="hljs-string">&quot;b&quot;</span>:[<span class="hljs-string">&quot;banana&quot;</span>]&#125;<br>	&#125;<br>	<br>    <span class="hljs-regexp">//</span> <span class="hljs-number">3.</span> reduce(BiFunction&lt;T, T, T&gt; aggregator)<br>    @GetMapping(<span class="hljs-string">&quot;/reduce&quot;</span>)<br>    public Mono&lt;<span class="hljs-built_in">String</span>&gt; reduceExample() &#123;<br>        <span class="hljs-keyword">return</span> Flux.just(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;C&quot;</span>)<br>                   .reduce(<span class="hljs-function"><span class="hljs-params">(a, b)</span> -&gt;</span> a + b); <span class="hljs-regexp">//</span> 累加成一个字符串，返回：<span class="hljs-string">&quot;ABC&quot;</span><br>    &#125;<br><br>    <span class="hljs-regexp">//</span> <span class="hljs-number">4.</span> scan(BiFunction&lt;T, T, T&gt; accumulator)<br>    @GetMapping(<span class="hljs-string">&quot;/scan&quot;</span>)<br>    public Flux&lt;<span class="hljs-built_in">String</span>&gt; scanExample() &#123;<br>        <span class="hljs-keyword">return</span> Flux.just(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;C&quot;</span>)<br>                   .scan(<span class="hljs-function"><span class="hljs-params">(a, b)</span> -&gt;</span> a + b); <span class="hljs-regexp">//</span> 实时输出，返回：<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;AB&quot;</span>, <span class="hljs-string">&quot;ABC&quot;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="6-1-2-5-合并与组合方法"><a href="#6-1-2-5-合并与组合方法" class="headerlink" title="6.1.2.5. 合并与组合方法"></a>6.1.2.5. 合并与组合方法</h6><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">&quot;/api/operators&quot;</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OperatorExamples</span> &#123;<br><br>    <span class="hljs-comment">// 1. mergeWith(Publisher&lt;? extends T&gt; other)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/mergeWith&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">mergeWithExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; flux1 = <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>).<span class="hljs-title function_">delayElements</span>(<span class="hljs-title class_">Duration</span>.<span class="hljs-title function_">ofMillis</span>(<span class="hljs-number">100</span>));<br>        <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; flux2 = <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>).<span class="hljs-title function_">delayElements</span>(<span class="hljs-title class_">Duration</span>.<span class="hljs-title function_">ofMillis</span>(<span class="hljs-number">50</span>));<br>        <span class="hljs-keyword">return</span> flux1.<span class="hljs-title function_">mergeWith</span>(flux2); <span class="hljs-comment">// 并行混合输出，不保证顺序</span><br>    &#125;<br><br>    <span class="hljs-comment">// 2. concatWith(Publisher&lt;? extends T&gt; other)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/concatWith&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">concatWithExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; flux1 = <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>);<br>        <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; flux2 = <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>);<br>        <span class="hljs-keyword">return</span> flux1.<span class="hljs-title function_">concatWith</span>(flux2); <span class="hljs-comment">// 先发 flux1，再发 flux2，严格按顺序来</span><br>    &#125;<br><br>    <span class="hljs-comment">// 3. zipWith(Publisher&lt;? extends U&gt; other)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/zipWith&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">zipWithExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; flux1 = <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;C&quot;</span>);<br>        <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; flux2 = <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>);<br>        <span class="hljs-keyword">return</span> flux1.<span class="hljs-title function_">zipWith</span>(flux2) <span class="hljs-comment">// 执行结果：[&#123;&quot;t1&quot;:&quot;A&quot;,&quot;t2&quot;:&quot;1&quot;&#125;,&#123;&quot;t1&quot;:&quot;B&quot;,&quot;t2&quot;:&quot;2&quot;&#125;]</span><br>                    .<span class="hljs-title function_">map</span>(tuple -&gt; tuple.<span class="hljs-title function_">getT1</span>() + tuple.<span class="hljs-title function_">getT2</span>()); <span class="hljs-comment">// 输出 &quot;A1&quot;, &quot;B2&quot;</span><br>    &#125;<br><br>    <span class="hljs-comment">// 4. combineLatest(Publisher&lt;? extends U&gt; other, BiFunction&lt;T, U, R&gt; combinator)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/combineLatest&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">combineLatestExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; flux1 = <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>).<span class="hljs-title function_">delayElements</span>(<span class="hljs-title class_">Duration</span>.<span class="hljs-title function_">ofMillis</span>(<span class="hljs-number">100</span>));<br>        <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; flux2 = <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>, <span class="hljs-string">&quot;3&quot;</span>).<span class="hljs-title function_">delayElements</span>(<span class="hljs-title class_">Duration</span>.<span class="hljs-title function_">ofMillis</span>(<span class="hljs-number">50</span>));<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">combineLatest</span>(flux1, flux2, (s1, s2) -&gt; s1 + s2); <span class="hljs-comment">// 总是用“最新”组合，返回：A1A2A3B3</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="6-1-2-6-限制与截取方法"><a href="#6-1-2-6-限制与截取方法" class="headerlink" title="6.1.2.6. 限制与截取方法"></a>6.1.2.6. 限制与截取方法</h6><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(<span class="hljs-string">&quot;/api/operators&quot;</span>)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OperatorExamples</span> &#123;<br><br>    <span class="hljs-comment">// 1. take(long n)</span><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/take&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> Flux&lt;Integer&gt; takeExample() &#123;<br>        <span class="hljs-keyword">return</span> Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)<br>                   .take(<span class="hljs-number">3</span>); <span class="hljs-comment">// 只取前 3 个元素，输出：1, 2, 3</span><br>    &#125;<br><br>    <span class="hljs-comment">// 2. takeLast(int n)</span><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/takeLast&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> Flux&lt;Integer&gt; takeLastExample() &#123;<br>        <span class="hljs-keyword">return</span> Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)<br>                   .takeLast(<span class="hljs-number">3</span>); <span class="hljs-comment">// 等所有元素发完后再输出最后 3 个，输出：8, 9, 10</span><br>    &#125;<br><br>    <span class="hljs-comment">// 3. skip(long n)</span><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/skip&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> Flux&lt;Integer&gt; skipExample() &#123;<br>        <span class="hljs-keyword">return</span> Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)<br>                   .skip(<span class="hljs-number">4</span>); <span class="hljs-comment">// 跳过前 4 个，输出：5, 6, 7, 8, 9, 10</span><br>    &#125;<br><br>    <span class="hljs-comment">// 4. skipLast(int n)</span><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/skipLast&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> Flux&lt;Integer&gt; skipLastExample() &#123;<br>        <span class="hljs-keyword">return</span> Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)<br>                   .skipLast(<span class="hljs-number">4</span>); <span class="hljs-comment">// 丢弃最后 4 个，输出：1, 2, 3, 4, 5, 6</span><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<hr>
<h6 id="6-1-2-7-错误处理"><a href="#6-1-2-7-错误处理" class="headerlink" title="6.1.2.7. 错误处理"></a>6.1.2.7. 错误处理</h6><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">&quot;/api/operators&quot;</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorHandlingExamples</span> &#123;<br><br>    <span class="hljs-comment">// 1. onErrorReturn(T fallback)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/onErrorReturn&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">onErrorReturnExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;C&quot;</span>)<br>                   .<span class="hljs-title function_">concatWith</span>(<span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">error</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Boom!&quot;</span>)))<br>                   .<span class="hljs-title function_">onErrorReturn</span>(<span class="hljs-string">&quot;Fallback&quot;</span>); <span class="hljs-comment">// 出错时返回默认值：&quot;Fallback&quot;</span><br>    &#125;<br><br>    <span class="hljs-comment">// 2. onErrorMap(Function&lt;Throwable, ? extends Throwable&gt; mapper)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/onErrorMap&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">onErrorMapExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;C&quot;</span>)<br>                   .<span class="hljs-title function_">concatWith</span>(<span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">error</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Invalid input&quot;</span>)))<br>                   .<span class="hljs-title function_">onErrorMap</span>(e -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomException</span>(<span class="hljs-string">&quot;Mapped: &quot;</span> + e.<span class="hljs-title function_">getMessage</span>()));<br>    &#125;<br><br>    <span class="hljs-comment">// 3. onErrorResume(Function&lt;Throwable, ? extends Publisher&lt;? extends T&gt;&gt; fallback)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/onErrorResume&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">onErrorResumeExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;C&quot;</span>)<br>                   .<span class="hljs-title function_">concatWith</span>(<span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">error</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Service down&quot;</span>)))<br>                   .<span class="hljs-title function_">onErrorResume</span>(e -&gt; <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;Switched to backup&quot;</span>, <span class="hljs-string">&quot;Another item&quot;</span>)); <span class="hljs-comment">// 切换到备用 Flux</span><br>    &#125;<br><br>    <span class="hljs-comment">// 4. onErrorContinue(BiConsumer&lt;Throwable, Object&gt; errorConsumer)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/onErrorContinue&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">onErrorContinueExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;two&quot;</span>, <span class="hljs-string">&quot;3&quot;</span>)<br>                   .<span class="hljs-title function_">map</span>(<span class="hljs-title class_">Integer</span>::<span class="hljs-built_in">parseInt</span>)<br>                   .<span class="hljs-title function_">onErrorContinue</span>((e, value) -&gt;<br>                       <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;Skipping &#x27;&quot;</span> + value + <span class="hljs-string">&quot;&#x27; due to: &quot;</span> + e.<span class="hljs-title function_">getMessage</span>()));<br>        <span class="hljs-comment">// &quot;two&quot; 转换失败被跳过，继续处理 &quot;3&quot;</span><br>    &#125;<br><br>    <span class="hljs-comment">// 5. retry(long times)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/retry&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">retryExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;C&quot;</span>)<br>                   .<span class="hljs-title function_">concatWith</span>(<span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">error</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Temporary failure&quot;</span>)))<br>                   .<span class="hljs-title function_">retry</span>(<span class="hljs-number">3</span>) <span class="hljs-comment">// 错误信号会被 retry(3) 捕获并重试最多 3 次</span><br>                   .<span class="hljs-title function_">onErrorReturn</span>(<span class="hljs-string">&quot;After retries, fallback&quot;</span>); <span class="hljs-comment">// 若仍然失败，则返回默认值</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="6-1-2-8-延迟与调度方法"><a href="#6-1-2-8-延迟与调度方法" class="headerlink" title="6.1.2.8. 延迟与调度方法"></a>6.1.2.8. 延迟与调度方法</h6><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(<span class="hljs-string">&quot;/api/flux&quot;</span>)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FluxThreadingAndTiming</span> &#123;<br><br>    <span class="hljs-comment">// 1. delayElements(Duration delay)</span><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/delayElements&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> Flux&lt;String&gt; delayElementsExample() &#123;<br>        <span class="hljs-keyword">return</span> Flux.just(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;C&quot;</span>)<br>                   .delayElements(Duration.ofSeconds(<span class="hljs-number">1</span>)); <span class="hljs-comment">// 每个元素之间间隔 1 秒发出</span><br>    &#125;<br><br>    <span class="hljs-comment">// 2. subscribeOn(Scheduler scheduler)</span><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/subscribeOn&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> Flux&lt;String&gt; subscribeOnExample() &#123;<br>        <span class="hljs-keyword">return</span> Flux.defer(() -&gt; &#123;<br>                    System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;Subscribed on thread: &quot;</span> + Thread.currentThread().getName());<br>                    <span class="hljs-keyword">return</span> Flux.just(<span class="hljs-string">&quot;data1&quot;</span>, <span class="hljs-string">&quot;data2&quot;</span>);<br>                &#125;)<br>                .subscribeOn(Schedulers.boundedElastic()); <span class="hljs-comment">// 指定「数据源」运行在哪个线程池</span><br>    &#125;<br><br>    <span class="hljs-comment">// 3. publishOn(Scheduler scheduler)</span><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/publishOn&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> Flux&lt;String&gt; publishOnExample() &#123;<br>        <span class="hljs-keyword">return</span> Flux.just(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;C&quot;</span>)<br>                   .doOnNext(v -&gt; System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;Before publishOn: &quot;</span> + Thread.currentThread().getName()))<br>                   .publishOn(Schedulers.parallel()) <span class="hljs-comment">// 从这里开始切换执行线程</span><br>                   .doOnNext(v -&gt; System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;After publishOn: &quot;</span> + Thread.currentThread().getName()));<br>    &#125;<br>    <br>     <span class="hljs-comment">// 4. timeout(Duration timeout)</span><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/timeout&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> Flux&lt;String&gt; timeoutExample() &#123;<br>        <span class="hljs-keyword">return</span> Flux.just(<span class="hljs-string">&quot;X&quot;</span>, <span class="hljs-string">&quot;Y&quot;</span>, <span class="hljs-string">&quot;Z&quot;</span>)<br>                   .delayElements(Duration.ofSeconds(<span class="hljs-number">2</span>)) <span class="hljs-comment">// 每个元素延迟2秒</span><br>                   .timeout(Duration.ofSeconds(<span class="hljs-number">1</span>))       <span class="hljs-comment">// 如果超过1秒未发出新元素，则触发 TimeoutException</span><br>                   .onErrorResume(e -&gt; Flux.just(<span class="hljs-string">&quot;超时fallback&quot;</span>)); <span class="hljs-comment">// 错误降级处理</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li><code>.delayElements</code> 单位<ol>
<li><code>Duration.ofNanos(long)</code>：<ol>
<li>纳秒</li>
</ol>
</li>
<li><code>Duration.ofMillis(long)</code>：<ol>
<li>毫秒</li>
</ol>
</li>
<li><code>Duration.ofSeconds(long)</code>：<ol>
<li>秒</li>
</ol>
</li>
<li><code>Duration.ofMinutes(long)</code>：<ol>
<li>分钟</li>
</ol>
</li>
<li><code>Duration.ofHours(long)</code>：<ol>
<li>小时</li>
</ol>
</li>
<li><code>Duration.ofDays(long)</code>：<ol>
<li>天数</li>
</ol>
</li>
</ol>
</li>
<li>常见线程<ol>
<li><code>Schedulers.parallel()</code><ol>
<li>适用于 CPU 密集型任务，使用固定大小线程池</li>
</ol>
</li>
<li><code>Schedulers.boundedElastic()</code><ol>
<li>适用于 I&#x2F;O 密集型任务（如数据库、网络、文件操作）</li>
</ol>
</li>
<li><code>Schedulers.immediate()</code><ol>
<li>在当前线程中执行</li>
</ol>
</li>
<li><code>Schedulers.fromExecutor(Executor)</code><ol>
<li>使用自定义线程池调度任务</li>
</ol>
</li>
</ol>
</li>
</ol>
</blockquote>
<hr>
<h6 id="6-1-2-9-其他实用方法"><a href="#6-1-2-9-其他实用方法" class="headerlink" title="6.1.2.9. 其他实用方法"></a>6.1.2.9. 其他实用方法</h6><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">&quot;/api/flux&quot;</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FluxHooksController</span> &#123;<br><br>    <span class="hljs-comment">// 1. doOnNext(Consumer&lt;? super T&gt; onNext)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/doOnNext&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">doOnNextExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;apple&quot;</span>, <span class="hljs-string">&quot;banana&quot;</span>, <span class="hljs-string">&quot;orange&quot;</span>)<br>                   .<span class="hljs-title function_">doOnNext</span>(item -&gt; <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;处理前日志：&quot;</span> + item));<br>    &#125;<br><br>    <span class="hljs-comment">// 2. doOnError(Consumer&lt;? super Throwable&gt; onError)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/doOnError&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">doOnErrorExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>)<br>                   .<span class="hljs-title function_">concatWith</span>(<span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">error</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;故意错误&quot;</span>)))<br>                   .<span class="hljs-title function_">doOnError</span>(e -&gt; <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;错误发生：&quot;</span> + e.<span class="hljs-title function_">getMessage</span>()));<br>    &#125;<br><br>    <span class="hljs-comment">// 3. doOnComplete(Runnable onComplete)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/doOnComplete&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">doOnCompleteExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;X&quot;</span>, <span class="hljs-string">&quot;Y&quot;</span>)<br>                   .<span class="hljs-title function_">doOnComplete</span>(() -&gt; <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;流已完成&quot;</span>));<br>    &#125;<br><br>    <span class="hljs-comment">// 4. doOnSubscribe(Consumer&lt;? super Subscription&gt; onSubscribe)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/doOnSubscribe&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">doOnSubscribeExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;start&quot;</span>)<br>                   .<span class="hljs-title function_">doOnSubscribe</span>(sub -&gt; <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;订阅开始：&quot;</span> + sub));<br>    &#125;<br><br>    <span class="hljs-comment">// 5. doFinally(Consumer&lt;SignalType&gt; onFinally)</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/doFinally&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">doFinallyExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;keep&quot;</span>, <span class="hljs-string">&quot;going&quot;</span>)<br>                   .<span class="hljs-title function_">concatWith</span>(<span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">error</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Oops!&quot;</span>)))<br>                   .<span class="hljs-title function_">doFinally</span>(<span class="hljs-keyword">type</span> -&gt; <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;流终止，原因：&quot;</span> + <span class="hljs-keyword">type</span>));<br>    &#125;<br><br>    <span class="hljs-comment">// 6. log()</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/log&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">logExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;foo&quot;</span>, <span class="hljs-string">&quot;bar&quot;</span>).<span class="hljs-title function_">log</span>();<br>    &#125;<br><br>    <span class="hljs-comment">// 7. cache()</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; expensiveSource = <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">just</span>(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;C&quot;</span>)<br>                                               .<span class="hljs-title function_">doOnSubscribe</span>(sub -&gt; <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;上游被调用&quot;</span>))<br>                                               .<span class="hljs-title function_">cache</span>();<br><br>    <span class="hljs-comment">// 8. share()</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; sharedSource = <span class="hljs-title class_">Flux</span>.<span class="hljs-title function_">interval</span>(<span class="hljs-title class_">Duration</span>.<span class="hljs-title function_">ofSeconds</span>(<span class="hljs-number">1</span>))<br>                                            .<span class="hljs-title function_">map</span>(i -&gt; <span class="hljs-string">&quot;Tick-&quot;</span> + i)<br>                                            .<span class="hljs-title function_">take</span>(<span class="hljs-number">5</span>)<br>                                            .<span class="hljs-title function_">doOnSubscribe</span>(sub -&gt; <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;订阅共享流&quot;</span>))<br>                                            .<span class="hljs-title function_">share</span>();<br><br>    <span class="hljs-meta">@GetMapping</span>(value = <span class="hljs-string">&quot;/share&quot;</span>, produces = <span class="hljs-title class_">MediaType</span>.<span class="hljs-property">TEXT_EVENT_STREAM_VALUE</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">shareExample</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> sharedSource;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="6-1-2-10-订阅方法"><a href="#6-1-2-10-订阅方法" class="headerlink" title="6.1.2.10. 订阅方法"></a>6.1.2.10. 订阅方法</h6><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(<span class="hljs-string">&quot;/api/flux&quot;</span>)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FluxHooksController</span> &#123;<br><br>	<span class="hljs-comment">// 1. subscribe()</span><br>	<span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/subscribe&quot;</span>)</span><br>	<span class="hljs-keyword">public</span> Flux&lt;String&gt; subscribeExample() &#123;<br>	    <span class="hljs-keyword">return</span> Flux.just(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;C&quot;</span>)<br>	               .subscribe();<br>	&#125;<br>	<br>	<span class="hljs-comment">// 2. subscribe(onNext)</span><br>	<span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/subscribeOnNext&quot;</span>)</span><br>	<span class="hljs-keyword">public</span> Flux&lt;String&gt; subscribeOnNextExample() &#123;<br>	    <span class="hljs-keyword">return</span> Flux.just(<span class="hljs-string">&quot;Item 1&quot;</span>, <span class="hljs-string">&quot;Item 2&quot;</span>)<br>	               .subscribe(item -&gt; System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;接收到的元素: &quot;</span> + item));<br>	&#125;<br><br>	<span class="hljs-comment">// 3. subscribe(onNext, onError, onComplete)</span><br>	<span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/subscribeAll&quot;</span>)</span><br>	<span class="hljs-keyword">public</span> Flux&lt;String&gt; subscribeAllExample() &#123;<br>	    <span class="hljs-keyword">return</span> Flux.just(<span class="hljs-string">&quot;Task 1&quot;</span>, <span class="hljs-string">&quot;Task 2&quot;</span>)<br>	               .concatWith(Flux.error(new RuntimeException(<span class="hljs-string">&quot;Error in task&quot;</span>)))<br>	               .subscribe(<br>	                   item -&gt; System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;收到任务: &quot;</span> + item), <br>	                   error -&gt; System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;发生错误: &quot;</span> + error.getMessage()), <br>	                   () -&gt; System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;任务完成&quot;</span>)<br>	               );<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<blockquote>
<p>[!NOTE] 注意事项：已经有了 <code>subscribe(onNext, onError, onComplete)</code>，为什么还要使用 <code>doOnNext</code>、<code>doOnError</code>、<code>doOnComplete</code> 这些副作用操作</p>
<ol>
<li><strong><code>doOnNext</code>、<code>doOnError</code> 和 <code>doOnComplete</code></strong> 是为了在流处理过程中执行<strong>副作用</strong>（比如日志记录、统计、监控等），但它们不会直接影响流的最终输出。它们让你在流运行时插入额外的行为，而不改变流本身。</li>
<li><strong><code>subscribe(onNext, onError, onComplete)</code></strong> 是你处理流结果的地方。这是最终的反应——你是流的消费者，订阅流并处理实际的数据、错误和完成状态。</li>
</ol>
</blockquote>
<h1 id="二、实操"><a href="#二、实操" class="headerlink" title="二、实操"></a>二、实操</h1>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Java/" class="category-chain-item">Java</a>
  
  
    <span>></span>
    
  <a href="/categories/Java/Spring-%E7%94%9F%E6%80%81/" class="category-chain-item">Spring 生态</a>
  
  
    <span>></span>
    
  <a href="/categories/Java/Spring-%E7%94%9F%E6%80%81/Spring-WebFlux/" class="category-chain-item">Spring WebFlux</a>
  
  

  

  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>笔记：Spring WebFlux</div>
      <div>https://wangjia5289.github.io/2025/05/03/笔记：Spring WebFlux/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>霸天</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>May 3, 2025</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/05/03/%E7%AC%94%E8%AE%B0%EF%BC%9ASpring%20Cloud%20Alibaba/" title="笔记：Spring Cloud Alibaba">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">笔记：Spring Cloud Alibaba</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/05/03/%E7%AC%94%E8%AE%B0%EF%BC%9A%E4%B8%89%E6%98%8E%E6%B2%BB%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84/" title="笔记：三明治分层架构">
                        <span class="hidden-mobile">笔记：三明治分层架构</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  



  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.utils.listenDOMLoaded(function() {
      Fluid.events.registerRefreshCallback(function() {
        if ('mermaid' in window) {
          mermaid.init();
        }
      });
    });
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  var relativeDate = function() {
    var updatedTime = document.getElementById('updated-time');
    if (updatedTime) {
      var text = updatedTime.textContent;
      var reg = /\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:Z|[+-]\d{2}:\d{2})/;
      var matchs = text.match(reg);
      if (matchs) {
        var relativeTime = moment(matchs[0]).fromNow();
        updatedTime.textContent = text.replace(reg, relativeTime);
      }
      updatedTime.style.display = '';
    }
  };
  Fluid.utils.createScript('https://lib.baomitu.com/moment.js/2.29.4/moment.min.js', function() {
    if (!'en'.startsWith('en')) {
      Fluid.utils.createScript('https://lib.baomitu.com/moment.js/2.29.4/locale/en.min.js', function() {
        relativeDate();
      });
    } else {
      relativeDate();
    }
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"display":{"superSample":2,"width":200,"height":350,"position":"left","hOffset":40,"vOffset":-20},"mobile":{"show":false,"scale":0.5},"react":{"opacityDefault":1,"opacityOnHover":0.5},"log":false});</script></body>
</html>
