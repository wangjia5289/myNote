

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/ba.jpg">
  <link rel="icon" href="/img/ba.jpg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#373737">
  <meta name="author" content="霸天">
  <meta name="keywords" content="">
  
    <meta name="description" content="一、理论1. 导图  2. Spring Security 执行流程1. 用户请求（客户端请求）每次用户访问受 Spring Security 保护的资源，都会经过以下流程 2. SecurityContextPersistenceFilter 介入自动为本线程初始化 SecurityContextHolder 并根据 JSESSIONID 向 HttpSession 查找 SecurityCon">
<meta property="og:type" content="article">
<meta property="og:title" content="笔记：Spring Security">
<meta property="og:url" content="https://wangjia5289.github.io/2025/05/18/%E7%AC%94%E8%AE%B0%EF%BC%9ASpring%20Security/index.html">
<meta property="og:site_name" content="夜阑卧听风吹雨,一枝梨花压心头">
<meta property="og:description" content="一、理论1. 导图  2. Spring Security 执行流程1. 用户请求（客户端请求）每次用户访问受 Spring Security 保护的资源，都会经过以下流程 2. SecurityContextPersistenceFilter 介入自动为本线程初始化 SecurityContextHolder 并根据 JSESSIONID 向 HttpSession 查找 SecurityCon">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9ASpring%20Security/Map%EF%BC%9ASpringSecurity.xmind">
<meta property="og:image" content="https://wangjia5289.github.io/2025/05/12/%E6%9C%AA%E5%91%BD%E5%90%8D/pring%20Security/image-20250628224744251.png">
<meta property="og:image" content="https://wangjia5289.github.io/2025/05/12/%E6%9C%AA%E5%91%BD%E5%90%8D/pring%20Security/image-20250628210023140.png">
<meta property="og:image" content="https://wangjia5289.github.io/2025/05/12/%E6%9C%AA%E5%91%BD%E5%90%8D/pring%20Security/image-20250630183241212.png">
<meta property="article:published_time" content="2025-05-17T16:00:00.000Z">
<meta property="article:modified_time" content="2025-07-03T06:23:15.962Z">
<meta property="article:author" content="Ba Tian">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9ASpring%20Security/Map%EF%BC%9ASpringSecurity.xmind">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>笔记：Spring Security - 夜阑卧听风吹雨,一枝梨花压心头</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"wangjia5289.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 100vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/%E3%80%90%E5%93%B2%E9%A3%8E%E5%A3%81%E7%BA%B8%E3%80%91%E5%85%89%E5%BD%B1%E7%BE%8E%E5%AD%A6-%E5%90%8A%E5%B8%A6%E8%A3%99.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="笔记：Spring Security"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-05-18 00:00" pubdate>
          May 18, 2025 am
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          9.4k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          79 mins
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> views
        </span>
        

      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">笔记：Spring Security</h1>
            
              <p id="updated-time" class="note note-info" style="display: none">
                
                  
                    Last updated on 2025-07-03T14:23:15+08:00
                  
                  

                
              </p>
            
            
              <div class="markdown-body">
                
                <h1 id="一、理论"><a href="#一、理论" class="headerlink" title="一、理论"></a>一、理论</h1><h2 id="1-导图"><a href="#1-导图" class="headerlink" title="1. 导图"></a>1. 导图</h2><p><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9ASpring%20Security/Map%EF%BC%9ASpringSecurity.xmind" srcset="/img/loading.gif" lazyload></p>
<hr>
<h2 id="2-Spring-Security-执行流程"><a href="#2-Spring-Security-执行流程" class="headerlink" title="2. Spring Security 执行流程"></a>2. Spring Security 执行流程</h2><p><span style="background:#fff88f">1. 用户请求（客户端请求）</span><br>每次用户访问受 <code>Spring Security</code> 保护的资源，都会经过以下流程</p>
<p><span style="background:#fff88f">2. SecurityContextPersistenceFilter 介入</span><br>自动为本线程初始化 <code>SecurityContextHolder</code> 并根据 <code>JSESSIONID</code> 向 <code>HttpSession</code> 查找 <code>SecurityContext</code>（其内保存最重要的 <code>Authentication</code>）</p>
<ol>
<li>若存在 <code>SecurityContext</code>，便将其加载到本线程的 <code>SecurityContextHolder</code> 中（基于 HttpSession 实现 “记住我” 功能，我们也可基于 JWT 实现 “记住我” 功能）</li>
<li>若不存在 <code>SecurityContext</code>，则在本线程中自动初始化一个新的 <code>SecurityContext</code></li>
</ol>
<p>即使我们不打算通过 <code>HttpSession</code> 实现 “记住我” 功能（如使用 JWT），甚至完全不使用 <code>HttpSession</code>，我们仍然建议保留这个过滤器，因为它自动为本线程初始化 <code>SecurityContextHolder</code>、并自动创建 <code>SecurityContext</code>，这个能力实在太香了。<br><img src="/2025/05/12/%E6%9C%AA%E5%91%BD%E5%90%8D/pring%20Security/image-20250628224744251.png" srcset="/img/loading.gif" lazyload></p>
<p><span style="background:#fff88f">3. UsernamePasswordAuthenticationFilter 介入</span><br>该过滤器主要用于前后端未分离的场景，用于处理默认 <code>/login</code> 路径下的登录请求。  </p>
<p>在前后端分离的架构中无需深入关注其具体逻辑，只需了解其在过滤器链中的位置，以便在插入自定义过滤器时能准确定位。</p>
<p><span style="background:#fff88f">4. AnonymousAuthenticationFilter 介入</span><br>如果当前没有任何 <code>Authentication</code>，系统会自动创建一个匿名身份，以避免后续流程中出现空指针异常。</p>
<p><span style="background:#fff88f">5. FilterSecurityInterceptor 介入</span><br>首先检查当前线程中是否存在 <code>Authentication</code>（无论是否为匿名身份），如果不存在，则抛出 <code>AuthenticationException</code>，表示用户尚未进行认证。</p>
<p>接着判断是否为匿名用户访问受保护资源：即若用户尚未认证（即为匿名身份 <code>Authentication</code>），且访问的资源未被标注为 <code>permitAll</code>，则抛出 <code>AuthenticationException</code> 异常。</p>
<p>最后检查当前用户是否具备访问目标资源或方法的权限（包括资源级别和方法级别的访问控制），若权限不足，则抛出 <code>AccessDeniedException</code>。</p>
<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>整个流程中的异常由 <code>ExceptionTranslation</code> 过滤器统一处理，负责捕获<strong>整个过滤器链中</strong>抛出的 <code>AuthenticationException</code> 和 <code>AccessDeniedException</code> 异常，并执行相应的处理逻辑。</li>
</ol>
</blockquote>
<p><span style="background:#fff88f">6. 执行 API</span><br>在这一步，才真正开始执行我们的 API 逻辑；如果是登录 API，并且通过 AuthenticationManager 进行认证，流程如下：<br><img src="/2025/05/12/%E6%9C%AA%E5%91%BD%E5%90%8D/pring%20Security/image-20250628210023140.png" srcset="/img/loading.gif" lazyload></p>
<p><span style="background:#fff88f">7. SecurityContextPersistenceFilter 再次介入</span><br>它会自动将本线程的 <code>SecurityContext</code> 存入服务器的 <code>HttpSession</code>，以便在后续请求中维持用户身份（需要手动开启）</p>
<p> 随后，过滤器会清空本线程 <code>SecurityContextHolder</code>，防止 <code>SecurityContext</code> 在后续请求中被无意复用，从而确保每个请求都能独立执行认证和授权流程。</p>
<hr>
<h2 id="3-Spring-Security-配置"><a href="#3-Spring-Security-配置" class="headerlink" title="3. Spring Security 配置"></a>3. Spring Security 配置</h2><h3 id="3-1-配置模板"><a href="#3-1-配置模板" class="headerlink" title="3.1. 配置模板"></a>3.1. 配置模板</h3><p>Spring Security 的配置主要在 Java 配置类中进行，而不是在 <code>application.yml</code> 文件中，因为安全配置通常涉及到逻辑和条件判断，这些无法简单地通过属性文件表达，我们可以完成以下配置：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">package</span> com.example.securitywithhttpsession.configuration;<br><br><span class="hljs-keyword">import</span> com.example.securitywithhttpsession.service.CustomerUserDetailsImplService;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.annotation.NoClass;<br><span class="hljs-keyword">import</span> jakarta.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.security.authentication.AuthenticationManager;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.config.http.SessionCreationPolicy;<br><span class="hljs-keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;<br><span class="hljs-keyword">import</span> org.springframework.security.crypto.password.NoOpPasswordEncoder;<br><span class="hljs-keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;<br><span class="hljs-keyword">import</span> org.springframework.security.web.SecurityFilterChain;<br><span class="hljs-keyword">import</span> org.springframework.security.web.csrf.CsrfTokenRepository;<br><span class="hljs-keyword">import</span> org.springframework.security.web.csrf.HttpSessionCsrfTokenRepository;<br><span class="hljs-keyword">import</span> org.springframework.web.cors.CorsConfiguration;<br><span class="hljs-keyword">import</span> org.springframework.web.cors.CorsConfigurationSource;<br><span class="hljs-keyword">import</span> org.springframework.web.cors.UrlBasedCorsConfigurationSource;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableMethodSecurity</span> <span class="hljs-comment">// 1. 启用方法级别的访问控制</span><br><span class="hljs-meta">@EnableWebSecurity</span> <span class="hljs-comment">// 2. 启用 Spring Security 安全机制</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityConfiguration</span> </span>&#123;<br>    <br>    <span class="hljs-comment">// 详见下文：配置 CSRF 攻击防护</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function">CsrfTokenRepository <span class="hljs-title">csrfTokenRepository</span><span class="hljs-params">()</span> </span>&#123;<br><br>        HttpSessionCsrfTokenRepository repository = <span class="hljs-keyword">new</span> HttpSessionCsrfTokenRepository(); <span class="hljs-comment">// 在HttpSession 中存储</span><br><br>        repository.setHeaderName(<span class="hljs-string">&quot;X-CSRF-TOKEN&quot;</span>); <span class="hljs-comment">// 可自定义请求头名称</span><br>        repository.setParameterName(<span class="hljs-string">&quot;_csrfToken&quot;</span>); <span class="hljs-comment">// 可自定义请求参数名称</span><br>        <span class="hljs-keyword">return</span> repository;<br>    &#125;<br><br>    <span class="hljs-comment">// 3. 配置 CORS 跨域资源共享</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function">CorsConfigurationSource <span class="hljs-title">corsConfigurationSource</span><span class="hljs-params">()</span> </span>&#123;<br><br>        CorsConfiguration configuration = <span class="hljs-keyword">new</span> CorsConfiguration();<br>        configuration.addAllowedOrigin(<span class="hljs-string">&quot;http://frontend.example.com&quot;</span>); <span class="hljs-comment">// 只允许特定前端跨域</span><br>        configuration.addAllowedMethod(<span class="hljs-string">&quot;*&quot;</span>); <span class="hljs-comment">// 支持所有方法</span><br>        configuration.addAllowedHeader(<span class="hljs-string">&quot;*&quot;</span>); <span class="hljs-comment">// 支持所有头部</span><br>        configuration.setAllowCredentials(<span class="hljs-keyword">true</span>); <span class="hljs-comment">// 允许携带 Cookie、Session 等凭证</span><br><br>        UrlBasedCorsConfigurationSource source = <span class="hljs-keyword">new</span> UrlBasedCorsConfigurationSource();<br>        source.registerCorsConfiguration(<span class="hljs-string">&quot;/**&quot;</span>, configuration); <span class="hljs-comment">// 应用于本程序哪些路径</span><br>        <span class="hljs-keyword">return</span> source;<br>    &#125;<br><br>    <span class="hljs-comment">// 4. 配置 AuthenticationManager</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function">AuthenticationManager <span class="hljs-title">authenticationManager</span><span class="hljs-params">(AuthenticationConfiguration authenticationConfiguration)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-function"><span class="hljs-keyword">return</span> authenticationConfiguration.<span class="hljs-title">getAuthenticationManager</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">// 从 Spring Security 配置中获取其默认的 AuthenticationManager 实例</span><br>    &#125;<br><br>    <span class="hljs-comment">// 5. 配置 密码加密器</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function">PasswordEncoder <span class="hljs-title">passwordEncoder</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-function"><span class="hljs-keyword">return</span> NoOpPasswordEncoder.<span class="hljs-title">getInstance</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">// 返回合适的实现类</span><br>    &#125;<br><br>    <span class="hljs-comment">// 配置 SecurityFilterChain，即我们熟知的那些过滤器链</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function">SecurityFilterChain <span class="hljs-title">securityFilterChain</span><span class="hljs-params">(HttpSecurity httpSecurity)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        httpSecurity<br>                <span class="hljs-comment">// 6. 禁用默认表单登录，同时禁用 UsernamePasswordAuthenticationFilter 过滤器</span><br>                .formLogin(form -&gt; &#123;<br>                    form.disable();<br>                &#125;)<br>                <span class="hljs-comment">// 7. 禁用默认注销功能</span><br>                .logout(logout -&gt; &#123;<br>                    logout.disable();<br>                &#125;)<br>                <span class="hljs-comment">// 8. 配置资源级别的访问控制</span><br>                .authorizeHttpRequests(auth -&gt; &#123;<br>                    auth.requestMatchers(<span class="hljs-string">&quot;/public/**&quot;</span>).permitAll();<br>                &#125;)<br>                <span class="hljs-comment">// 9. 配置用户 未认证、权限不足 的处理</span><br>                .exceptionHandling(<span class="hljs-keyword">handler</span> -&gt; <span class="hljs-keyword">handler</span><br>                        <span class="hljs-comment">// 未认证时的响应（处理 AuthenticationException 异常）</span><br>                        .authenticationEntryPoint((request, response, authException) -&gt; &#123;<br>                                    response.setContentType(<span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>);<br>                                    response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);<br>                                    response.getWriter().write(<span class="hljs-string">&quot;&#123;\&quot;error\&quot;:\&quot;未认证，请先登录\&quot;&#125;&quot;</span>);<br>                                &#125;<br>                        )<br>                        <span class="hljs-comment">// 权限不足时的响应（处理 AccessDeniedException 异常）</span><br>                        .accessDeniedHandler((request, response, accessDeniedException) -&gt; &#123;<br>                                    response.setContentType(<span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>);<br>                                    response.setStatus(HttpServletResponse.SC_FORBIDDEN);<br>                                    response.getWriter().write(<span class="hljs-string">&quot;&#123;\&quot;error\&quot;:\&quot;权限不足，无法访问此资源\&quot;&#125;&quot;</span>);<br>                                &#125;<br>                        )<br>                )<br>                <span class="hljs-comment">// 10. 配置 HttpSession</span><br>                .sessionManagement(session -&gt; session<br>                        .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)<br>                )<br><br>                <span class="hljs-comment">// 11. 配置 SecurityContextPersistenceFilter 过滤器</span><br>                .securityContext(security -&gt; &#123;<br>                    security.requireExplicitSave(<span class="hljs-keyword">false</span>);<br>                &#125;)<br><br>                <span class="hljs-comment">// 12. 配置 CSRF 攻击防护</span><br>                .csrf(csrf -&gt; &#123;<br>                    csrf.ignoringRequestMatchers(<span class="hljs-string">&quot;/login&quot;</span>);<br>                    csrf.csrfTokenRepository(csrfTokenRepository());<br>                &#125;)<br><br>                <span class="hljs-comment">// 13. 添加自定义过滤器</span><br>                .addFilterAt(xxxx);<br>        <span class="hljs-function"><span class="hljs-keyword">return</span> httpSecurity.<span class="hljs-title">build</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">// 构建 SecurityFilterChain 对象</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="3-2-启用方法级别的访问控制"><a href="#3-2-启用方法级别的访问控制" class="headerlink" title="3.2. 启用方法级别的访问控制"></a>3.2. 启用方法级别的访问控制</h3><p>资源级别的访问控制是指：只有具备指定权限或身份的用户，才能访问特定路径下的资源，例如 <code>/api/admin/**</code> ，详见下文：资源级别的访问控制。</p>
<p>而方法级别的访问控制则是指：用户必须具备指定的权限或身份，才能调用该方法，详细步骤如下：</p>
<p><span style="background:#fff88f">1. 配置类上添加 @EnableMethodSecurity 注解</span></p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@Configuration</span>  <br><span class="hljs-variable">@EnableMethodSecurity</span>  <span class="hljs-comment">// 启用方法级别的访问控制  </span><br><span class="hljs-variable">@EnableWebSecurity</span>  <br>public class SecurityConfig &#123;  <br>  ......<br>&#125;<br></code></pre></td></tr></table></figure>


<p><span style="background:#fff88f">2. 使用方法级别的访问控制</span><br>需要注意的是，方法级别的访问控制，一般进行在服务层（Service 层）。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@Service</span><br>public class UserService &#123;<br>    <span class="hljs-variable">@PreAuthorize</span>(<span class="hljs-string">&quot;hasRole(&#x27;ADMIN&#x27;)&quot;</span>)<br>    public void <span class="hljs-built_in">adminMethod</span>() &#123;<br>        <span class="hljs-comment">// 只有 ROLE_ADMIN 角色可以执行该方法</span><br>    &#125;<br><br>    <span class="hljs-variable">@PreAuthorize</span>(<span class="hljs-string">&quot;hasAuthority(&#x27;user:user:select&#x27;)&quot;</span>) <br>    public void <span class="hljs-built_in">readUser</span>() &#123;<br>        <span class="hljs-comment">// 只有具有 user:user:select 权限的用户可以执行 用户模块的用户表的查询操作</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="3-3-启用-Spring-Security-安全机制"><a href="#3-3-启用-Spring-Security-安全机制" class="headerlink" title="3.3. 启用 Spring Security 安全机制"></a>3.3. 启用 Spring Security 安全机制</h3><p>在配置类中加上 <code>@EnableWebSecurity</code> 后，Spring 会自动注册一个叫做 <code>FilterChainProxy</code> 的安全过滤器链，包含十几个内置的安全过滤器，就是我们熟知的那些过滤器。</p>
<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>即使你不显式添加这个注解，只要引入了 <code>spring-boot-starter-security</code>，Spring Boot 就会自动注册默认的安全过滤器链。但如果你需要自定义安全配置类（例如我们自己的 <code>SecurityConfiguration</code>），就必须显式启用它，以确保你的配置生效</li>
</ol>
</blockquote>
<hr>
<h3 id="3-4-配置-AuthenticationManager"><a href="#3-4-配置-AuthenticationManager" class="headerlink" title="3.4. 配置 AuthenticationManager"></a>3.4. 配置 AuthenticationManager</h3><p>在 <code>WebSecurityConfigurerAdapter</code> 时代，<code>AuthenticationManager</code> 是由 Spring 官方默认注册为 Bean 的，因此我们可以直接注入使用。</p>
<p>但从 Spring Boot 3 开始，Spring 的设计理念发生了变化：“最少暴露、最少干预”，也就是说框架不再自动为你暴露未显式声明的组件，目的是减少默认暴露导致的 Bean 冲突或安全隐患。</p>
<p>也就是说，Spring 将配置的主动权交还给开发者，所有需要使用的组件开发者都必须通过 <code>@Bean</code> 显式声明，而不是官方为你偷偷注入。即使 Spring Security 已经内部实现了默认的 <code>AuthenticationManager</code>，但也不会自动将其注册为 Bean。例如它在源码中是这样定义的：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthenticationConfiguration</span> &#123;  <br>  <br>    <span class="hljs-keyword">private</span> AuthenticationManager getAuthenticationManagerBean() &#123;  <br>        <span class="hljs-keyword">return</span> (AuthenticationManager)<span class="hljs-keyword">this</span>.lazyBean(AuthenticationManager.<span class="hljs-keyword">class</span>);  <br>    &#125;  <br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果开发者想使用 <code>AuthenticationManager</code>，就需要自己显式地从官方配置中获取其默认实现，或者直接自定义一个。通常我们使用的 <code>AuthenticationManager</code> 实际上就是官方默认实现的那个，除非你有特殊需求需要进行自定义配置，因此我们可以这样手动声明：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-meta">@Bean</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-function">AuthenticationManager <span class="hljs-title">authenticationManager</span><span class="hljs-params">(AuthenticationConfiguration authenticationConfiguration)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;  <br>    <span class="hljs-function"><span class="hljs-keyword">return</span> authenticationConfiguration.<span class="hljs-title">getAuthenticationManager</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">// 从 Spring Security 配置中获取其默认的 AuthenticationManager 实例</span><br>&#125;<br></code></pre></td></tr></table></figure>


<hr>
<h3 id="3-5-配置-CORS-跨域资源共享"><a href="#3-5-配置-CORS-跨域资源共享" class="headerlink" title="3.5. 配置 CORS 跨域资源共享"></a>3.5. 配置 CORS 跨域资源共享</h3><p>Spring Security 默认关闭 CORS（跨域资源共享）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 2. 启用 CORS 跨域资源共享，并配置跨域规则</span><br><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> CorsConfigurationSource <span class="hljs-title function_">corsConfigurationSource</span><span class="hljs-params">()</span> &#123;<br><br>	<span class="hljs-type">CorsConfiguration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorsConfiguration</span>();<br>	configuration.addAllowedOrigin(<span class="hljs-string">&quot;http://frontend.example.com&quot;</span>); <span class="hljs-comment">// 只允许特定前端跨域</span><br>	configuration.addAllowedMethod(<span class="hljs-string">&quot;*&quot;</span>); <span class="hljs-comment">// 支持所有方法</span><br>	configuration.addAllowedHeader(<span class="hljs-string">&quot;*&quot;</span>); <span class="hljs-comment">// 支持所有头部</span><br>	configuration.setAllowCredentials(<span class="hljs-literal">true</span>); <span class="hljs-comment">// 允许携带 Cookie、Session 等凭证</span><br><br>	<span class="hljs-type">UrlBasedCorsConfigurationSource</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UrlBasedCorsConfigurationSource</span>();<br>	source.registerCorsConfiguration(<span class="hljs-string">&quot;/**&quot;</span>, configuration); <span class="hljs-comment">// 应用于本程序哪些路径</span><br>	<span class="hljs-keyword">return</span> source;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>CORS 只解决跨域访问问题，对于受保护资源的访问，仍需要完成认证，甚至需要校验 CSRF Token。建议在跨域请求时携带一个 JWT，这样可以自动完成身份认证，无需手动处理。</li>
</ol>
</blockquote>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs accesslog">@Bean<br>public CorsConfigurationSource corsConfigurationSource() &#123;<br>    CorsConfiguration config = new CorsConfiguration();<br>    config.setAllowedOrigins(List.of(<span class="hljs-string">&quot;http://localhost:3000&quot;</span>)); // 或 <span class="hljs-string">&quot;*&quot;</span><br>    config.setAllowedMethods(List.of(<span class="hljs-string">&quot;<span class="hljs-keyword">GET</span>&quot;</span>, <span class="hljs-string">&quot;<span class="hljs-keyword">POST</span>&quot;</span>, <span class="hljs-string">&quot;<span class="hljs-keyword">PUT</span>&quot;</span>, <span class="hljs-string">&quot;<span class="hljs-keyword">DELETE</span>&quot;</span>));<br>    config.setAllowedHeaders(List.of(<span class="hljs-string">&quot;*&quot;</span>));<br>    config.setAllowCredentials(true); // 如果你前端携带 cookie，这里要开启<br><br>    UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();<br>    source.registerCorsConfiguration(<span class="hljs-string">&quot;/**&quot;</span>, config);<br>    return source;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<hr>
<h3 id="3-6-配置密码加密器"><a href="#3-6-配置密码加密器" class="headerlink" title="3.6. 配置密码加密器"></a>3.6. 配置密码加密器</h3><h4 id="3-6-1-密码加密器概述"><a href="#3-6-1-密码加密器概述" class="headerlink" title="3.6.1. 密码加密器概述"></a>3.6.1. 密码加密器概述</h4><p>在实际应用中，用户密码绝不能以明文方式存储，因为这会带来极大的安全风险。为确保安全性，我们必须在存储前对密码进行加密处理。基于此，我们面临两大问题：</p>
<ol>
<li>如何实现密码加密，即如何将明文密码转换为<strong>不可逆</strong>的密文，从而保护用户密码安全</li>
<li>如何校验密码，即用户提交的明文密码如何与存储的密文密码进行对比，从而验证密码的正确性</li>
</ol>
<p><code>PasswordEncoder</code> 是 Spring Security 提供的一个接口，同时它也提供了该接口的很多实现类，能够解决上述两大问题</p>
<hr>
<h4 id="3-6-2-PaswordEncoder-常用实现类"><a href="#3-6-2-PaswordEncoder-常用实现类" class="headerlink" title="3.6.2. PaswordEncoder 常用实现类"></a>3.6.2. PaswordEncoder 常用实现类</h4><p>Spring Security 提供了几种常见的 <code>PasswordEncoder</code> 实现类，常用的有：</p>
<p><span style="background:#fff88f">1. BCryptPasswordEncoder</span><br>基于 BCrypt 算法的密码加密工具，<strong>不能解密，只能对比</strong>，是一种提供较高安全的密码加密方式，能够有效防止暴力破解，适用于大多数应用。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@Bean</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-title class_">PasswordEncoder</span> <span class="hljs-title function_">passwordEncoder</span>(<span class="hljs-params"></span>) &#123;  <br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();  <br>&#125;<br></code></pre></td></tr></table></figure>


<p><span style="background:#fff88f">2. NoOpPasswordEncoder</span><br>不对密码进行加密，直接返回原始密码，通常用于开发、测试环境，不建议在生产环境中使用。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-meta">@Bean</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-function">PasswordEncoder <span class="hljs-title">passwordEncoder</span><span class="hljs-params">()</span> </span>&#123;  <br>    <span class="hljs-function"><span class="hljs-keyword">return</span> NoOpPasswordEncoder.<span class="hljs-title">getInstance</span><span class="hljs-params">()</span></span>;  <br>&#125;<br></code></pre></td></tr></table></figure>


<p><span style="background:#fff88f">3. Pbkdf2PasswordEncoder</span><br>基于 PBKDF2 算法的密码加密工具</p>
<p><span style="background:#fff88f">4. SCryptPasswordEncoder</span><br>基于 scrypt 算法的密码加密工具。</p>
<hr>
<h4 id="3-6-3-PasswordEncoder-使用步骤"><a href="#3-6-3-PasswordEncoder-使用步骤" class="headerlink" title="3.6.3. PasswordEncoder 使用步骤"></a>3.6.3. PasswordEncoder 使用步骤</h4><p><span style="background:#fff88f">1. 配置 PasswordEncoder</span><br>就是将 <code>PasswordEncoder</code> 声明为一个 Bean，并指定返回一个合适的的实现类。这样当我们注入这个 Bean，并调用其接口方法时，实际执行的就是这个实现类的逻辑，这正体现了 Spring IoC 的核心理念：<strong>面向接口编程，运行时注入实现</strong>。不理解这一点，那确实建议回去复习一下 IoC。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@Configuration</span><br><span class="hljs-variable">@EnableWebSecurity</span> <br>public class SecurityConfig &#123;<br>    <span class="hljs-variable">@Bean</span> <br>    public PasswordEncoder <span class="hljs-built_in">passwordEncoder</span>() &#123;<br>        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">BCryptPasswordEncoder</span>(); <span class="hljs-comment">// 返回合适的实现类</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<p><span style="background:#fff88f">2. 使用 PasswordEncoder 实现密码加密</span></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-meta">@Controller</span>  <br><span class="hljs-meta">@RequestMapping(<span class="hljs-string">&quot;/security&quot;</span>)</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PasswordController</span> &#123;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PasswordEncoder passwordEncoder;  <br>  <br>    <span class="hljs-meta">@Autowired</span>  <br>    <span class="hljs-keyword">public</span> PasswordController(PasswordEncoder passwordEncoder) &#123;  <br>        <span class="hljs-keyword">this</span>.passwordEncoder = passwordEncoder;  <br>    &#125;  <br>      <br>    <span class="hljs-comment">// 通过方法处理密码加密  </span><br>    <span class="hljs-meta">@RequestMapping(<span class="hljs-string">&quot;/encode-password&quot;</span>)</span>  <br>    <span class="hljs-meta">@ResponseBody</span>  <br>    <span class="hljs-keyword">public</span> String encodePassword() &#123;  <br>        String password = <span class="hljs-string">&quot;myPasswordxxxxxxx&quot;</span>;  <br>        <span class="hljs-comment">// 在方法内调用 passwordEncoder 进行密码加密  </span><br>        String encodedPassword = passwordEncoder.encode(password);  <br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Encoded Password: &quot;</span> + encodedPassword;  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>


<p><span style="background:#fff88f">3. 校验密码匹配</span></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/security&quot;)</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PasswordController</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PasswordEncoder passwordEncoder;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PasswordController</span><span class="hljs-params">(PasswordEncoder passwordEncoder)</span> &#123;<br>        <span class="hljs-built_in">this</span>.passwordEncoder = passwordEncoder;<br>    &#125;<br><br>    <span class="hljs-comment">// 通过方法验证密码</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/verify-password&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">verifyPassword</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">rawPassword</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;myPasswordxxxxxxx&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">encodedPassword</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;xxxxxxxxxxxxxxxxxx&quot;</span>;  <span class="hljs-comment">// 模拟数据库中的加密密码</span><br><br>        <span class="hljs-comment">// 使用 matches 方法验证密码是否匹配</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">matches</span> <span class="hljs-operator">=</span> passwordEncoder.matches(rawPassword, encodedPassword);<br>        <br>        <span class="hljs-keyword">return</span> matches ? <span class="hljs-string">&quot;Password is valid&quot;</span> : <span class="hljs-string">&quot;Invalid password&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>使用 <code>matches</code> 方法时，实际上是<strong>先对 rawPassword 进行加密</strong>，然后再与数据库中的加密密码进行匹配）</li>
<li>如果我们是使用 <code>AuthenticationManager</code> 进行认证，它会自动将用户发送来的用户名和密码，与我们的 <code>CustomerUserDetailsImpl</code> 中返回的用户名和密码进行比对，这是我们已知的逻辑。那你可能会有疑问：它在比对前，肯定需要先用密码加密器对用户发送来的明文密码进行加密，然后再比对吧？可我并没有做任何相关配置，<code>AuthenticationManager</code> 怎么知道该使用哪个加密器？</li>
<li>其实，只要你注册了一个类型为 <code>PasswordEncoder</code> 的 接口 Bean，这个 接口 Bean 有一个具体实现，<code>AuthenticationManager</code> 就会知道使用这个 <code>PasswordEncoder</code> Bean 与其具体实现，对密码进行加密，<strong>无需我们手动配置</strong>。</li>
<li>同样的，只要你注册了一个类型为 <code>UserDetailsService</code> 的 Bean（接口 Bean），这个 接口 Bean 有一个具体的实现，<code>AuthenticationManager</code> 就会知道使用这个 <code>UserDetailsService</code> Bean 与其具体实现，去获取 <code>CustomerUserDetailsImpl</code> <strong>无需我们手动配置</strong>。</li>
<li>上述，只限于接口 Bean 只有一个具体实现，如果有多个具体实现，那就要我们进行配置了，因为 Spring Security 虽然知道用这个 Bean，但是并不知道使用哪一个具体实现</li>
</ol>
</blockquote>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-comment">// 1. 这种方式，同时注册了 UserDetailsService 接口类型的 Bean 和 CustomerUserDetailsImplService 实现类类型的 Bean，CustomerUserDetailsImplService 只是该接口的下的一个具体实现，可能存在多个这样的实现类类型的 Bean（此方式，支持一个接口 Bean 有多个实现类 Bean，当需要切换实现时，只需调整配置，指定使用的实现类即可）</span><br><span class="hljs-variable">@Service</span><br>public class CustomerUserDetailsImplService implements UserDetailsService &#123;<br>	......<br>&#125;<br><br><br><span class="hljs-comment">// 2. 这种方式仅注册了 UserDetailsService 类型的 Bean，返回的 CustomerUserDetailsImplService 实例是其具体实现类（此方式下，一个接口 Bean 只能绑定一个实现类，若要更换实现，需在此方法中直接修改返回的实例。）</span><br><span class="hljs-variable">@Bean</span><br>public UserDetailsService <span class="hljs-built_in">userDetailsService</span>() &#123;<br>    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">CustomerUserDetailsImplService</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="3-7-配置资源级别的访问控制"><a href="#3-7-配置资源级别的访问控制" class="headerlink" title="3.7. 配置资源级别的访问控制"></a>3.7. 配置资源级别的访问控制</h3><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-tag">http</span><span class="hljs-selector-class">.authorizeHttpRequests</span>(auth -&gt; auth<br>    .<span class="hljs-built_in">requestMatchers</span>(<span class="hljs-string">&quot;/public/**&quot;</span>, <span class="hljs-string">&quot;/error&quot;</span>).<span class="hljs-built_in">permitAll</span>()<br>    .<span class="hljs-built_in">requestMatchers</span>(<span class="hljs-string">&quot;/admin/**&quot;</span>).<span class="hljs-built_in">hasRole</span>(<span class="hljs-string">&quot;ADMIN&quot;</span>)<br>    .<span class="hljs-built_in">requestMatchers</span>(<span class="hljs-string">&quot;/manage/**&quot;</span>).<span class="hljs-built_in">hasAuthority</span>(<span class="hljs-string">&quot;MANAGE_PRIVILEGE&quot;</span>)<br>    .<span class="hljs-built_in">requestMatchers</span>(<span class="hljs-string">&quot;/special/**&quot;</span>).<span class="hljs-built_in">access</span>(<span class="hljs-string">&quot;hasRole(&#x27;ADMIN&#x27;) and hasIpAddress(&#x27;192.168.1.0/24&#x27;)&quot;</span>) <br>    .<span class="hljs-built_in">anyRequest</span>().<span class="hljs-built_in">authenticated</span>() <span class="hljs-comment">// 其他所有路径均需经过认证</span><br><span class="hljs-string">&quot;&quot;</span>&quot;<br><span class="hljs-number">1</span>. <span class="hljs-built_in">requestMatchers</span>()：<br>	<span class="hljs-number">1</span>. 设置 特定资源请求路径 访问控制规则<br><span class="hljs-number">2</span>. <span class="hljs-built_in">anyRequest</span>()：<br>	<span class="hljs-number">1</span>. 用于设置除上述规则外，其余 所有资源请求路径 的访问控制规则<br><span class="hljs-number">3</span>. <span class="hljs-built_in">permitAll</span>()：<br>	<span class="hljs-number">1</span>. 允许所有用户访问该资源（说是所有用户，其实你至少要有匿名的 Authentication）<br><span class="hljs-number">4</span>. <span class="hljs-built_in">denyAll</span>()：<br>	<span class="hljs-number">1</span>. 禁止所有用户访问该资源。<br><span class="hljs-number">5</span>. <span class="hljs-built_in">hasRole</span>()：<br>	<span class="hljs-number">1</span>. 要求用户必须具备指定角色才能访问<br>	<span class="hljs-number">2</span>. 注意：该方法会自动在角色名前添加 <span class="hljs-string">&quot;ROLE_&quot;</span> 前缀，即：<span class="hljs-built_in">hasRole</span>(<span class="hljs-string">&quot;ADMIN&quot;</span>) 代表 ROLE_ADMIN<br><span class="hljs-number">6</span>. <span class="hljs-built_in">hasAuthority</span>()：<br>	<span class="hljs-number">1</span>. 要求用户必须具备指定权限才能访问，我们用这个就好<br>	<span class="hljs-number">2</span>. 注意：不会自动添加前缀，提供完整权限名称即可<br><span class="hljs-number">7</span>. <span class="hljs-built_in">authenticated</span>()：<br>	<span class="hljs-number">1</span>. 要求用户已通过身份验证（即非匿名 Authenticated 而是认证 Authenticated）后才能访问。<br><span class="hljs-number">8</span>. <span class="hljs-built_in">access</span>()：<br>	<span class="hljs-number">1</span>. 支持使用 SpEL 表达式，实现更复杂的访问控制逻辑。<br>	<span class="hljs-number">2</span>. 例如：<span class="hljs-built_in">access</span>(<span class="hljs-string">&quot;hasRole(&#x27;ADMIN&#x27;) and hasIpAddress(&#x27;192.168.1.0/24&#x27;)&quot;</span>) ，是说此路径仅允许拥有 ADMIN 角色且 IP 地址位于 <span class="hljs-number">192.168</span>.<span class="hljs-number">1.0</span>/<span class="hljs-number">24</span> 网段的用户访问<br><span class="hljs-string">&quot;&quot;</span>&quot;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>如需放行所有请求，可配置为：</li>
</ol>
</blockquote>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-tag">http</span><span class="hljs-selector-class">.authorizeHttpRequests</span>(auth -&gt; auth.<span class="hljs-built_in">anyRequest</span>().<span class="hljs-built_in">permitAll</span>());<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="3-8-配置-HttpSession"><a href="#3-8-配置-HttpSession" class="headerlink" title="3.8. 配置 HttpSession"></a>3.8. 配置 HttpSession</h3><figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs julia">http.sessionManagement(session -&gt; session  <br>    .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)  <br>    .maximumSessions(<span class="hljs-number">1</span>)<br>    .maxSessionsPreventsLogin(<span class="hljs-literal">true</span>)<br>);<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. sessionCreationPolicy()：会话创建策略</span><br><span class="hljs-string">	1. SessionCreationPolicy.ALWAYS：</span><br><span class="hljs-string">		1. 始终创建会话。每个请求都会新建一个 HttpSession，覆盖之前的会话，并返回新的 JSESSIONID Cookie。</span><br><span class="hljs-string">	2. SessionCreationPolicy.IF_REQUIRED（默认）：</span><br><span class="hljs-string">		1. 按需创建会话。当需要使用 HttpSession 时，Spring Security 会自动创建会话，并返回对应的 JSESSIONID Cookie。</span><br><span class="hljs-string">	3. SessionCreationPolicy.STATELESS：</span><br><span class="hljs-string">		1. 不使用会话，适用于无状态应用场景（禁用 HttpSession，如 JWT）</span><br><span class="hljs-string">2. maximumSessions()：</span><br><span class="hljs-string">	1. 并发会话控制。限制每个用户在同一时间内的会话数量，也即用户可在多少台设备上同时登录（默认情况下，不限制）。</span><br><span class="hljs-string">3. maxSessionsPreventsLogin()：</span><br><span class="hljs-string">	1. 是否阻止新会话登录。</span><br><span class="hljs-string">	2. true：</span><br><span class="hljs-string">		1. 达到最大会话数后阻止新会话登录，不允许替换旧会话。</span><br><span class="hljs-string">	3. false(默认)：</span><br><span class="hljs-string">		1. 允许新会话登录并替换旧会话，此时旧会话将被注销，旧的 JSESSIONID 失效。通常系统会通知用户被挤下线，并重定向到登录页面要求重新登录。</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>Spring Security 本身不负责设置 <code>HttpSession</code> 的会话超时时间。会话超时时间由 Servlet 容器或 Spring Boot 配置决定。</li>
<li><code>HttpSession</code> 存储在服务器端，别误以为存储在用户端了</li>
<li>如果不希望使用会话，可以配置为：</li>
</ol>
</blockquote>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">http<span class="hljs-selector-class">.sessionManagement</span>()<span class="hljs-selector-class">.sessionCreationPolicy</span>(SessionCreationPolicy.STATELESS);<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="3-9-配置-SecurityContextPersistenceFilter-过滤器"><a href="#3-9-配置-SecurityContextPersistenceFilter-过滤器" class="headerlink" title="3.9. 配置 SecurityContextPersistenceFilter 过滤器"></a>3.9. 配置 SecurityContextPersistenceFilter 过滤器</h3><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-comment">// 1. 禁用 SecurityContextPersistenceFilter 过滤器</span><br><span class="hljs-function"><span class="hljs-title">http</span>.securityContext(securityContext -&gt;</span> securityContext.disable())  <br><br><br><span class="hljs-comment">// 2. 启用 线程中的 SecurityContext 保存在 HttpSession 策略</span><br><span class="hljs-function"><span class="hljs-title">http</span>.securityContext(securityContext -&gt;</span> securityContext.requireExplicitSave(<span class="hljs-literal">false</span>));<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li><code>SecurityContextPersistenceFilter</code> 过滤器，能自动将本线程的 <code>SecurityContext</code> 存入 <code>HttpSession</code>（前提是，这个发生变化），但是这个功能，不是默认开启的了，需要我们手动开启</li>
</ol>
</blockquote>
<hr>
<h3 id="3-10-配置-CSRF-攻击防护"><a href="#3-10-配置-CSRF-攻击防护" class="headerlink" title="3.10. 配置 CSRF 攻击防护"></a>3.10. 配置 CSRF 攻击防护</h3><p>Spring Security 默认启用跨站请求伪造（CSRF）防护机制，基于 <strong>CSRF Token</strong> 实现安全校验。其工作原理如下：</p>
<ol>
<li>用户首次登录页面时，需要我们手动生成一个随机的 CSRF Token，将其保存在服务器端的 <strong>HttpSession</strong> 中，并同步返回给前端。</li>
<li>前端需妥善保存该 Token，在执行修改服务器状态的敏感操作（如 POST、PUT、DELETE、PATCH 等）时，前端必须将该 Token 携带，通常以请求头（默认名称：<code>X-CSRF-TOKEN</code>）或请求参数（名称：<code>_csrf</code>）的方式携带。</li>
<li>服务器在接收到请求后，会比对请求中携带的 CSRF Token 与存储在 HTTP Session 中的 Token 是否一致。如果两者不匹配或者无 CSRF Token，则会抛出 <code>accessDeniedException</code>（无权限异常），从而阻止非法请求继续执行。</li>
<li>即使攻击者能利用用户的 Cookie 发起请求，由于敏感操作必须携带合法的 CSRF Token，而攻击者无法获取或伪造该 Token，因而能有效防止 CSRF 攻击。<figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs ceylon">@Bean <br>public CsrfTokenRepository csrfTokenRepository() &#123; <br><br>		HttpSessionCsrfTokenRepository repository = <span class="hljs-keyword">new</span> HttpSessionCsrfTokenRepository(); <span class="hljs-comment">// 在HttpSession 中存储</span><br>	<br>		repository.setHeaderName(<span class="hljs-string">&quot;X-CSRF-TOKEN&quot;</span>); <span class="hljs-comment">// 可自定义请求头名称 </span><br>		repository.setParameterName(<span class="hljs-string">&quot;_csrfToken&quot;</span>); <span class="hljs-comment">// 可自定义请求参数名称 </span><br>		<span class="hljs-keyword">return</span> repository; <br>&#125;<br><br>http.csrf(csrf -&gt; csrf<br>	.ignoringRequestMatchers(<span class="hljs-string">&quot;/login&quot;</span>,<span class="hljs-string">&quot;/websocket/**&quot;</span>, <span class="hljs-string">&quot;/api/public/**&quot;</span>); <span class="hljs-comment">// 忽略对这些路径的 CSRF 保护</span><br>	.csrfTokenRepository(csrfTokenRepository()) <span class="hljs-comment">// 使用我们自定义的 Token 存储库</span><br>)；<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. ignoringRequestMatchers()：</span><br><span class="hljs-string">	1. 忽略对这些路径的 CSRF 保护</span><br><span class="hljs-string">2. csrfTokenRepository()：</span><br><span class="hljs-string">	1. 指定 Token 的存储库，一般使用我们自定义的 Token 存储库</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></td></tr></table></figure></li>
</ol>
<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>如果基于 JWT，我们直接禁用 CSRF 防护</li>
<li>如果你莫名其妙返回 <code>&quot;error&quot;: &quot;权限不足，无法访问此资源&quot;</code> ，大概率是 CSRF 的问题</li>
<li>如果想要禁用 CSRF 防护，可以配置为：</li>
</ol>
</blockquote>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">http.csrf(csrf -&gt; csrf.<span class="hljs-built_in">disable</span>());<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="3-11-添加自定义过滤器"><a href="#3-11-添加自定义过滤器" class="headerlink" title="3.11. 添加自定义过滤器"></a>3.11. 添加自定义过滤器</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-comment">// 1. 直接添加过滤器，添加的过滤器必须是 Spring Security 提供的过滤器或其子类的实例</span><br>http.<span class="hljs-built_in">addFilter</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">CustomFilter</span>());<br><br><span class="hljs-comment">// 2. 在指定的过滤器位置添加过滤器，新添加的过滤器会替换指定位置的原有过滤器</span><br>http.<span class="hljs-built_in">addFilterAt</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">CustomFilter</span>(),UsernamePasswordAuthenticationFilter.<span class="hljs-keyword">class</span>);<br><br><span class="hljs-comment">// 3. 在指定过滤器之前添加过滤器，自定义过滤器会在指定过滤器之前执行。</span><br>http.<span class="hljs-built_in">addFilterBefore</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">CustomFilter</span>(),UsernamePasswordAuthenticationFilter.<span class="hljs-keyword">class</span>);<br><br><span class="hljs-comment">// 4. 在指定过滤器之后添加过滤器，自定义过滤器会在指定过滤器之后执行。</span><br>http.<span class="hljs-built_in">addFilterAfter</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">CustomFilter</span>(),UsernamePasswordAuthenticationFilter.<span class="hljs-keyword">class</span>);<br></code></pre></td></tr></table></figure>

<hr>
<h1 id="二、实操"><a href="#二、实操" class="headerlink" title="二、实操"></a>二、实操</h1><h2 id="1-基本使用"><a href="#1-基本使用" class="headerlink" title="1. 基本使用"></a>1. 基本使用</h2><h3 id="1-1-基于-HttpSession-的-Spring-Security"><a href="#1-1-基于-HttpSession-的-Spring-Security" class="headerlink" title="1.1. 基于 HttpSession 的 Spring Security"></a>1.1. 基于 HttpSession 的 Spring Security</h3><h4 id="1-1-1-创建-Spring-Web-项目，添加-Security-相关依赖"><a href="#1-1-1-创建-Spring-Web-项目，添加-Security-相关依赖" class="headerlink" title="1.1.1. 创建 Spring Web 项目，添加 Security 相关依赖"></a>1.1.1. 创建 Spring Web 项目，添加 Security 相关依赖</h4><ol>
<li>Web：<ol>
<li>Spring Web</li>
</ol>
</li>
<li>Security：<ol>
<li>Spring Security</li>
</ol>
</li>
<li>SQL<ol>
<li>JDBC API</li>
<li>MyBatis Framework</li>
<li>MySQL Driver</li>
</ol>
</li>
</ol>
<hr>
<h4 id="1-1-2-创建用户-角色-权限表"><a href="#1-1-2-创建用户-角色-权限表" class="headerlink" title="1.1.2. 创建用户-角色-权限表"></a>1.1.2. 创建用户-角色-权限表</h4><p>我们一般会创建五个表：<code>users</code> 表（用户表）存储所有注册用户的信息，<code>roles</code> 表（角色表）定义了系统中存在的各种角色，<code>user_role</code> 表（用户-角色关联表）用于建立用户和角色之间的多对多关系，<code>authorities</code> 表（权限表）定义了系统中的各种操作权限，<code>role_authoritie</code> 表（角色-权限表）用于建立角色和权限之间的多对多关系</p>
<p><span style="background:#fff88f">1. users 表（用户表）</span></p>
<table>
<thead>
<tr>
<th>列名</th>
<th>数据类型</th>
<th>约束</th>
<th>索引</th>
<th>默认值</th>
<th>示例值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>user_id</strong></td>
<td>int</td>
<td>主键约束、自增属性</td>
<td>主键索引</td>
<td>自增</td>
<td>1</td>
<td>用户唯一标识符（将 username 直接作为主键也是一种常见做法）</td>
</tr>
<tr>
<td><strong>username</strong></td>
<td>varchar(20)</td>
<td>唯一约束</td>
<td>唯一索引</td>
<td></td>
<td>john</td>
<td>用户名</td>
</tr>
<tr>
<td><strong>password</strong></td>
<td>varchar(80)</td>
<td></td>
<td></td>
<td></td>
<td>$2a$10$abcdefghijklmnopqrstuvwxyz</td>
<td>加密后密码，推荐长度设的长一些，以兼容现代加密算法（禁止明文密码直接入库）</td>
</tr>
<tr>
<td><strong>is_accountNonExpired</strong></td>
<td>tinyint(1)</td>
<td></td>
<td></td>
<td>1</td>
<td>1</td>
<td>账户是否没过期（1 代表没过期）</td>
</tr>
<tr>
<td><strong>is_accountNonLocked</strong></td>
<td>tinyint(1)</td>
<td></td>
<td></td>
<td>1</td>
<td>1</td>
<td>账户是否没锁定</td>
</tr>
<tr>
<td><strong>is_credentialsNonExpired</strong></td>
<td>tinyint(1)</td>
<td></td>
<td></td>
<td>1</td>
<td>1</td>
<td>密码是否没过期</td>
</tr>
<tr>
<td><strong>is_enabled</strong></td>
<td>tinyint(1)</td>
<td></td>
<td></td>
<td>1</td>
<td>1</td>
<td>用户是否启用</td>
</tr>
<tr>
<td><strong>email</strong></td>
<td>VARCHAR(20)</td>
<td>唯一约束</td>
<td>唯一索引</td>
<td></td>
<td><a href="mailto:&#x6a;&#x6f;&#104;&#110;&#x40;&#x65;&#x78;&#x61;&#x6d;&#x70;&#x6c;&#101;&#46;&#x63;&#x6f;&#109;">&#x6a;&#x6f;&#104;&#110;&#x40;&#x65;&#x78;&#x61;&#x6d;&#x70;&#x6c;&#101;&#46;&#x63;&#x6f;&#109;</a></td>
<td>邮箱</td>
</tr>
<tr>
<td><strong>phone_number</strong></td>
<td>VARCHAR(20)</td>
<td>唯一约束</td>
<td>唯一索引</td>
<td></td>
<td>13800138000</td>
<td>电话号码</td>
</tr>
</tbody></table>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"># <span class="hljs-number">1.</span> 创建表<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> users (<br>    user_id <span class="hljs-type">INT</span> AUTO_INCREMENT <span class="hljs-keyword">PRIMARY KEY</span>,<br>    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),<br>    <span class="hljs-keyword">password</span> <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">80</span>),<br>    is_accountNonExpired TINYINT(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span>,<br>    is_accountNonLocked TINYINT(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span>,<br>    is_credentialsNonExpired TINYINT(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span>,<br>    is_enabled TINYINT(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span>,<br>    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),<br>    phone_number <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>)<br>) ENGINE=InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET=utf8mb4;<br><br><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> users <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> unique_username <span class="hljs-keyword">UNIQUE</span> (username);<br><br><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> users <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> unique_email <span class="hljs-keyword">UNIQUE</span> (email);<br><br><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> users <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> unique_phone <span class="hljs-keyword">UNIQUE</span> (phone_number);<br><br><br># <span class="hljs-number">2.</span> 插入数据<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users (username, <span class="hljs-keyword">password</span>, email, phone_number)<br><span class="hljs-keyword">VALUES</span><br>    (<span class="hljs-string">&#x27;alice&#x27;</span>, <span class="hljs-string">&#x27;pass123&#x27;</span>, <span class="hljs-string">&#x27;alice@example.com&#x27;</span>, <span class="hljs-string">&#x27;13800000000&#x27;</span>),<br>    (<span class="hljs-string">&#x27;bob&#x27;</span>, <span class="hljs-string">&#x27;pass456&#x27;</span>, <span class="hljs-string">&#x27;bob@example.com&#x27;</span>, <span class="hljs-string">&#x27;13900000001&#x27;</span>),<br>    (<span class="hljs-string">&#x27;BaTian&#x27;</span>, <span class="hljs-string">&#x27;pass789&#x27;</span>, <span class="hljs-string">&#x27;batian@example.com&#x27;</span>, <span class="hljs-string">&#x27;13700000002&#x27;</span>);<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>username、password、isAccountNonExpired、isAccountNonLocked、isCredentialsNonExpired、isEnabled、authorities 这七个字段是 <code>userDetails</code> 接口的默认属性，一般在数据库表中要全部包含</li>
<li>email、phone_number 等字段，是我们自己扩展的字段。</li>
<li>虽然 camelCase 在 Java 中使用广泛，例如 phoneNumber，但在 SQL 表列名中更建议统一为 snake_case，例如 phone_number</li>
</ol>
</blockquote>
<p><span style="background:#fff88f">2. roles 表（角色表）</span></p>
<table>
<thead>
<tr>
<th>列名</th>
<th>数据类型</th>
<th>约束</th>
<th>默认值</th>
<th>索引</th>
<th>示例值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>role_id</strong></td>
<td>int</td>
<td>主键约束、自增属性</td>
<td>自增</td>
<td>主键索引</td>
<td>1</td>
<td>角色唯一标识符</td>
</tr>
<tr>
<td><strong>role_name</strong></td>
<td>varchar(20)</td>
<td>唯一约束</td>
<td></td>
<td>唯一索引</td>
<td>ROLE_ADMIN</td>
<td>角色名称，推荐全大写的格式 (Spring Security 约定以 <code>ROLE_</code> 开头)</td>
</tr>
</tbody></table>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"># <span class="hljs-number">1.</span> 创建表<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> roles (<br>    role_id <span class="hljs-type">INT</span> AUTO_INCREMENT <span class="hljs-keyword">PRIMARY KEY</span>,<br>    role_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">UNIQUE</span><br>) <span class="hljs-keyword">COMMENT</span>=<span class="hljs-string">&#x27;角色表&#x27;</span>;<br><br><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> roles <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> unique_role_name <span class="hljs-keyword">UNIQUE</span> (role_name);<br><br><br># <span class="hljs-number">2.</span> 插入数据<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> roles (role_name) <span class="hljs-keyword">VALUES</span> <br>	(<span class="hljs-string">&#x27;ROLE_ADMIN&#x27;</span>),<br>	(<span class="hljs-string">&#x27;ROLE_USER&#x27;</span>),<br>	(<span class="hljs-string">&#x27;ROLE_MANAGER&#x27;</span>),<br>	(<span class="hljs-string">&#x27;ROLE_GUEST&#x27;</span>);<br></code></pre></td></tr></table></figure>


<p><span style="background:#fff88f">3. user_role 表（用户-角色关联表）</span></p>
<table>
<thead>
<tr>
<th>列名</th>
<th>数据类型</th>
<th>约束</th>
<th>索引</th>
<th>默认值</th>
<th>示例值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>user_id</strong></td>
<td>int</td>
<td>主键约束（与 role_id 联合主键）<br>外键约束（指向 users 表中的 user_id）</td>
<td>联合主键索引</td>
<td></td>
<td>1</td>
<td>users 表中的 id</td>
</tr>
<tr>
<td><strong>role_id</strong></td>
<td>int</td>
<td>主键约束（与 user_id 联合主键）<br>外键约束（指向 roles 表中的 role_id）</td>
<td>联合主键索引</td>
<td></td>
<td>1</td>
<td>roles 表中的 id</td>
</tr>
</tbody></table>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"># <span class="hljs-number">1.</span> 创建表<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_role (<br>    user_id    <span class="hljs-type">INT</span>         <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    role_id    <span class="hljs-type">INT</span>         <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    <span class="hljs-keyword">PRIMARY KEY</span> (user_id, role_id),<br>    <span class="hljs-keyword">FOREIGN KEY</span> (user_id) <span class="hljs-keyword">REFERENCES</span> users (user_id),<br>    <span class="hljs-keyword">FOREIGN KEY</span> (role_id) <span class="hljs-keyword">REFERENCES</span> roles (role_id)<br>) ;<br><br><br># <span class="hljs-number">2.</span> 插入数据<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> user_role (user_id, role_id) <span class="hljs-keyword">VALUES</span><br>	(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>两表的关联表，一般是取其两表名的单数形式，以 <code>_</code> 进行衔接</li>
</ol>
</blockquote>
<p><span style="background:#fff88f">4. authorities 表（权限表）</span></p>
<table>
<thead>
<tr>
<th>列名</th>
<th>数据类型</th>
<th>约束</th>
<th>索引</th>
<th>默认值</th>
<th>示例值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>authority_id</strong></td>
<td>int</td>
<td>主键约束、自增属性</td>
<td>主键索引</td>
<td>自增</td>
<td>1</td>
<td>权限唯一标识</td>
</tr>
<tr>
<td><strong>authority_name</strong></td>
<td>varchar(50)</td>
<td>唯一约束</td>
<td>唯一索引</td>
<td></td>
<td>finance:invoice:approve</td>
<td>权限名称，推荐全小写的格式（常采用 模块：资源：操作 的命名方式）</td>
</tr>
</tbody></table>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"># <span class="hljs-number">1.</span> 创建表<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> authorities (<br>    authority_id <span class="hljs-type">INT</span> AUTO_INCREMENT <span class="hljs-keyword">PRIMARY KEY</span>,<br>    authority_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>)<br>) ENGINE=InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET=utf8mb4;<br><br><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> authorities <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> unique_authority_name <span class="hljs-keyword">UNIQUE</span> (authority_name);<br><br><br># <span class="hljs-number">2.</span> 插入数据<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> authorities (authority_name) <span class="hljs-keyword">VALUES</span><br>    (<span class="hljs-string">&#x27;test:test:test&#x27;</span>);<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>表名叫做 <code>authorities</code>，列名叫做 <code>authority_xxx</code></li>
</ol>
</blockquote>
<p><span style="background:#fff88f">5. role_authority 表（角色-权限关联表）</span></p>
<table>
<thead>
<tr>
<th>列名</th>
<th>数据类型</th>
<th>约束</th>
<th>索引</th>
<th>默认值</th>
<th>示例值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>role_id</strong></td>
<td>int</td>
<td>主键约束（与 authoritie_id 联合主键）<br>外键约束（指向 roles 表中的 role_id）</td>
<td>联合主键索引</td>
<td></td>
<td>1</td>
<td>roles 表中的 id</td>
</tr>
<tr>
<td><strong>authority_id</strong></td>
<td>int</td>
<td>主键约束（与 role_id 联合主键）<br>外键约束（指向 authorities 表中的 authoritie_id）</td>
<td>联合主键索引</td>
<td></td>
<td>1</td>
<td>authorities 表中的 id</td>
</tr>
</tbody></table>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"># <span class="hljs-number">1.</span> 创建表<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> role_authority (<br>    role_id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    authority_id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    <span class="hljs-keyword">PRIMARY KEY</span> (role_id, authority_id),<br>    <span class="hljs-keyword">FOREIGN KEY</span> (role_id) <span class="hljs-keyword">REFERENCES</span> roles(role_id),<br>    <span class="hljs-keyword">FOREIGN KEY</span> (authority_id) <span class="hljs-keyword">REFERENCES</span> authorities(authority_id)<br>) ;<br><br><br># <span class="hljs-number">2.</span> 插入数据<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> role_authority (role_id, authority_id) <span class="hljs-keyword">VALUES</span><br>    (<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure>

<hr>
<h4 id="1-1-3-使用-Spring-Data-MyBatis-实现查询用户的基本信息和权限"><a href="#1-1-3-使用-Spring-Data-MyBatis-实现查询用户的基本信息和权限" class="headerlink" title="1.1.3. 使用 Spring Data MyBatis 实现查询用户的基本信息和权限"></a>1.1.3. 使用 Spring Data MyBatis 实现查询用户的基本信息和权限</h4><h5 id="1-1-3-1-前置步骤"><a href="#1-1-3-1-前置步骤" class="headerlink" title="1.1.3.1. 前置步骤"></a>1.1.3.1. 前置步骤</h5><p>详见笔记：Spring Data MyBatis</p>
<hr>
<h5 id="1-1-3-2-编写-User-Entity-类"><a href="#1-1-3-2-编写-User-Entity-类" class="headerlink" title="1.1.3.2. 编写 User Entity 类"></a>1.1.3.2. 编写 User Entity 类</h5><p>User Entity 类位于 <code>com.example.securitywithhttpsession.entity</code> 包下</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs lasso"><span class="hljs-keyword">public</span> class User &#123;<br><br>	<span class="hljs-comment">// users 表中的数据（用户基本信息）</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Integer</span> userId;<br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">String</span> username;<br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">String</span> password;<br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Integer</span> isAccountNonExpired;<br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Integer</span> isAccountNonLocked;<br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Integer</span> isCredentialsNonExpired;<br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Integer</span> isEnabled;<br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">String</span> email;<br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">String</span> phoneNumber;<br>    <br>	<span class="hljs-comment">// authorities 表中的数据（用户的权限，不要忘记添加这个）</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">List</span>&lt;SimpleGrantedAuthority&gt; authorities;<br><br>    <span class="hljs-comment">// getter 方法</span><br>	<span class="hljs-comment">// setter 方法</span><br>	<span class="hljs-comment">// equals 方法</span><br>	<span class="hljs-comment">// hashCode 方法</span><br>	<span class="hljs-comment">// toString 方法</span><br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>与数据库表映射的类通常称为 Entity 类，也可称为 DO 类或 PO 类，统属 POJO 类，通常只包含 getter、setter 、equals、hashCode、toString 方法及构造方法，不应包含业务逻辑方法</li>
<li>使用 MyBatisX 插件生成的 POJO 类默认包含 getter、setter、equals、hashCode、toString 方法，但不包含构造方法。<ol>
<li>我们可以手动补全有参和无参构造方法；</li>
<li>同时我么也可以删除自动生成的 equals、hashCode、toString 方法，改为使用 IDEA 生成</li>
</ol>
</li>
<li>本 User 类不仅与 Users 表映射，还包含了 authorities 表中的 <code>authoritie_name</code> 字段。因此，别忘了添加 <code>private List&lt;String&gt; authorities;</code> 及其对应的方法（包括 getter、setter、equals、hashCode、toString 方法以及构造方法）</li>
<li>数据库中的表名一般使用复数形式，如 users，而在 Java 中则采用单数形式命名，如 User</li>
</ol>
</blockquote>
<p><img src="/2025/05/12/%E6%9C%AA%E5%91%BD%E5%90%8D/pring%20Security/image-20250630183241212.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<h5 id="1-1-3-3-编写-UserMapper-接口，并定义查询方法"><a href="#1-1-3-3-编写-UserMapper-接口，并定义查询方法" class="headerlink" title="1.1.3.3. 编写 UserMapper 接口，并定义查询方法"></a>1.1.3.3. 编写 UserMapper 接口，并定义查询方法</h5><p>User Entity 类位于 <code>com.example.securitywithhttpsession.mapper</code> 包下</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@Mapper</span>  <br>public interface UserMapper &#123;  <br><br>    <span class="hljs-selector-tag">User</span> <span class="hljs-selector-tag">getUserByUserName</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">&quot;username&quot;</span>) String username) ;  <br>  <br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h5 id="1-1-3-4-编写查询方法对应的-SQL-语句（编写-UserMapper-xml）"><a href="#1-1-3-4-编写查询方法对应的-SQL-语句（编写-UserMapper-xml）" class="headerlink" title="1.1.3.4. 编写查询方法对应的 SQL 语句（编写 UserMapper.xml）"></a>1.1.3.4. 编写查询方法对应的 SQL 语句（编写 UserMapper.xml）</h5><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="language-xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span></span></span><br><span class="hljs-meta"><span class="language-xml">        <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="hljs-meta"><span class="language-xml">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.example.securitywithhttpsession.mapper.UserMapper&quot;</span>&gt;</span></span><br><span class="language-xml"></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;BaseResultMap&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;com.example.securitywithhttpsession.entity.User&quot;</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;userId&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;user_id&quot;</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">&quot;INTEGER&quot;</span>/&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">&quot;VARCHAR&quot;</span>/&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">&quot;VARCHAR&quot;</span>/&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;isAccountnonexpired&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;is_accountNonExpired&quot;</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">&quot;TINYINT&quot;</span>/&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;isAccountnonlocked&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;is_accountNonLocked&quot;</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">&quot;TINYINT&quot;</span>/&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;isCredentialsnonexpired&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;is_credentialsNonExpired&quot;</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">&quot;TINYINT&quot;</span>/&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;isEnabled&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;is_enabled&quot;</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">&quot;TINYINT&quot;</span>/&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;email&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;email&quot;</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">&quot;VARCHAR&quot;</span>/&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;phoneNumber&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;phone_number&quot;</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">&quot;VARCHAR&quot;</span>/&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">collection</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;authorities&quot;</span> <span class="hljs-attr">ofType</span>=<span class="hljs-string">&quot;org.springframework.security.core.authority.SimpleGrantedAuthority&quot;</span>&gt;</span></span><br><span class="language-xml">                <span class="hljs-tag">&lt;<span class="hljs-name">constructor</span>&gt;</span></span><br><span class="language-xml">                    <span class="hljs-tag">&lt;<span class="hljs-name">arg</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;authority_name&quot;</span> <span class="hljs-attr">javaType</span>=<span class="hljs-string">&quot;java.lang.String&quot;</span> /&gt;</span></span><br><span class="language-xml">                <span class="hljs-tag">&lt;/<span class="hljs-name">constructor</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">collection</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span></span><br><span class="language-xml"></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;Base_Column_List&quot;</span>&gt;</span></span><br><span class="language-xml">        user_id,</span><br><span class="language-xml">        username,</span><br><span class="language-xml">        password,</span><br><span class="language-xml">        is_accountNonExpired,</span><br><span class="language-xml">        is_accountNonLocked,</span><br><span class="language-xml">        is_credentialsNonExpired,</span><br><span class="language-xml">        is_enabled,</span><br><span class="language-xml">        email,</span><br><span class="language-xml">        phone_number</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span></span><br><span class="language-xml"></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;getUserByUserName&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;BaseResultMap&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;String&quot;</span>&gt;</span></span><br><span class="language-xml">        SELECT</span><br><span class="language-xml">            users.user_id,</span><br><span class="language-xml">            users.username,</span><br><span class="language-xml">            users.password,</span><br><span class="language-xml">            users.is_accountNonExpired,</span><br><span class="language-xml">            users.is_accountNonLocked,</span><br><span class="language-xml">            users.is_credentialsNonExpired,</span><br><span class="language-xml">            users.is_enabled,</span><br><span class="language-xml">            users.email,</span><br><span class="language-xml">            users.phone_number,</span><br><span class="language-xml">            authorities.authority_name</span><br><span class="language-xml">        FROM users</span><br><span class="language-xml">                 LEFT JOIN user_role ON users.user_id = user_role.user_id</span><br><span class="language-xml">                 LEFT JOIN role_authority ON user_role.role_id = role_authority.role_id</span><br><span class="language-xml">                 LEFT JOIN authorities ON role_authority.authority_id = authorities.authority_id</span><br><span class="language-xml">        WHERE users.username = #</span><span class="hljs-template-variable">&#123;username&#125;</span><span class="language-xml"></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span><br><span class="language-xml"></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span></span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li><code>username</code>、<code>password</code>、<code>is_accountNonExpired</code>、<code>is_accountNonLocked</code>、<code>is_credentialsNonExpired</code>、<code>is_enabled</code> 以及 <code>authority_name</code> 是必须要查询的字段，因为这些字段会被封装到 <code>CustomerUserDetailsImpl</code> 中，供 Spring Security 进行认证与授权使用。</li>
<li>其他字段是否查询，可以根据实际需求灵活决定。即使你没有将 <code>email</code>、<code>phoneNumber</code> 等扩展信息封装进 <code>CustomerUserDetailsImpl</code>，这个方法依然可以作为一个通用的用户信息查询入口来使用。比如你后续业务中需要查询 <code>email</code> ，完全也可以直接调用这个方法。换句话说，这个方法不仅仅是在封装 <code>CustomerUserDetailsImpl</code> 时用得上，未来在其他场景中也很可能会复用，所以稍微 “富余” 一些是没问题的。</li>
</ol>
</blockquote>
<hr>
<h4 id="1-1-4-实现-UserDetails-接口"><a href="#1-1-4-实现-UserDetails-接口" class="headerlink" title="1.1.4. 实现 UserDetails 接口"></a>1.1.4. 实现 UserDetails 接口</h4><p>我们通常会定义一个类 <code>CustomerUserDetailsImpl</code> 来实现 Spring Security 提供的 <code>UserDetails</code> 接口。那么，这个类到底是做什么用的呢？我们先来看一下 <code>UserDetails</code> 接口的源码：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDetails</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Serializable</span> &#123;  <br><br>	<span class="hljs-comment">// 获取用户权限集合</span><br>    <span class="hljs-title class_">Collection</span>&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; <span class="hljs-title function_">getAuthorities</span>();  <br>    <br>    <span class="hljs-comment">// 获取密码（加密后的密码）</span><br>    <span class="hljs-title class_">String</span> <span class="hljs-title function_">getPassword</span>();  <br>    <br>	<span class="hljs-comment">// 获取用户名（如 &quot;admin&quot;）</span><br>    <span class="hljs-title class_">String</span> <span class="hljs-title function_">getUsername</span>();  <br>    <br>	<span class="hljs-comment">// 账户是否没过期（true 代表没过期，false 代表过期）</span><br>    <span class="hljs-keyword">default</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isAccountNonExpired</span>(<span class="hljs-params"></span>) &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 默认返回 true</span><br>    &#125;  <br>    <span class="hljs-comment">// 账户是否没锁定</span><br>    <span class="hljs-keyword">default</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isAccountNonLocked</span>(<span class="hljs-params"></span>) &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <br>    &#125;  <br>    <span class="hljs-comment">// 凭证（密码）是否没过期</span><br>    <span class="hljs-keyword">default</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isCredentialsNonExpired</span>(<span class="hljs-params"></span>) &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <br>    &#125;  <br>    <span class="hljs-comment">// 账户是否启用</span><br>    <span class="hljs-keyword">default</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isEnabled</span>(<span class="hljs-params"></span>) &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>Spring Security 是通过调用 <code>UserDetails</code> 接口中定义的方法来获取用户信息的（毕竟 Spring Security 并不了解你项目中具体使用了什么类、字段名是什么，对吧，所以不会直接从我们的 User Entity 中拿数据）。</p>
<p>但我们也注意到，<code>UserDetails</code> 毕竟只是一个接口，它的方法并没有默认实现和返回值。也就是说，当 Spring Security 调用这些接口方法时，由于接口本身没有具体实现，自然无法拿到到任何值。这也正是我们为什么需要实现一个 <code>CustomUserDetailsImpl</code> 类来实现这个接口的原因。我们必须为接口中的每个方法提供具体实现，确保它们能返回对应的值，这样当 Spring Security 调用这些方法时，才能拿到用户信息。</p>
<p>其实我们也发现了，像 <code>isAccountNonExpired()</code>、<code>isAccountNonLocked()</code>、<code>isCredentialsNonExpired()</code>、<code>isEnabled()</code> 这几个方法，Spring Security 是提供了默认值的；但另外三个关键方法（如 <code>getUsername()</code>、<code>getPassword()</code>、<code>getAuthorities()</code>）是没有默认实现的，也就是说我们至少必须实现这三个方法，否则编译会直接报错。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomerUserDetailsImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetails</span> &#123;  <br><br>    <span class="hljs-meta">@Override</span>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Collection</span>&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; <span class="hljs-title function_">getAuthorities</span>(<span class="hljs-params"></span>) &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <br>    &#125;  <br>  <br>    <span class="hljs-meta">@Override</span>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getPassword</span>(<span class="hljs-params"></span>) &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <br>    &#125;  <br>  <br>    <span class="hljs-meta">@Override</span>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getUsername</span>(<span class="hljs-params"></span>) &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <br>    &#125;  <br>  <br>    <span class="hljs-meta">@Override</span>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isAccountNonExpired</span>(<span class="hljs-params"></span>) &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">UserDetails</span>.<span class="hljs-property">super</span>.<span class="hljs-title function_">isAccountNonExpired</span>();  <br>    &#125;  <br>  <br>    <span class="hljs-meta">@Override</span>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isAccountNonLocked</span>(<span class="hljs-params"></span>) &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">UserDetails</span>.<span class="hljs-property">super</span>.<span class="hljs-title function_">isAccountNonLocked</span>();  <br>    &#125;  <br>  <br>    <span class="hljs-meta">@Override</span>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isCredentialsNonExpired</span>(<span class="hljs-params"></span>) &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">UserDetails</span>.<span class="hljs-property">super</span>.<span class="hljs-title function_">isCredentialsNonExpired</span>();  <br>    &#125;  <br>  <br>    <span class="hljs-meta">@Override</span>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isEnabled</span>(<span class="hljs-params"></span>) &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">UserDetails</span>.<span class="hljs-property">super</span>.<span class="hljs-title function_">isEnabled</span>();  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>那我们为什么非得实现 <code>UserDetails</code> 呢？你说 Spring Security 知不知道这些值，关我什么事？我自己知道就行了呗。但其实你仔细一想，我们就能发现 Spring Security 这么设计是有它的道理的，核心原因就在于：Spring Security 的整个认证和授权流程，底层都是围绕一个 <code>Authentication</code> 对象来构建的，而这个对象的核心信息，其实都来自我们实现的 <code>CustomerUserDetailsImpl</code></p>
<p>我们必须要搞清楚以下几点：</p>
<ol>
<li>Spring Security 是通过 <code>CustomerUserDetailsImpl</code> 来构建 <code>Authentication</code> 对象的</li>
<li>在登录流程中，通常有两种典型的方式：<ol>
<li>通过 <code>AuthenticationManager</code> 进行认证（自定义登录 API，使用 AuthenticationManager 进行认证逻辑）：<ol>
<li>Spring Security 会自动去校验用户提交的用户名和密码，是否与 <code>CustomerUserDetailsImpl</code> 中提供的用户名和密码相匹配；</li>
<li>如果匹配成功，Spring Security 就会自动将 <code>CustomerUserDetailsImpl</code> 封装为一个 <code>Authentication</code> 对象，并存入当前线程；</li>
<li>校验的时候，用户信息是从 <code>CustomerUserDetailsImpl</code> 中读取的，封装为 <code>Authentication</code> 对象的时候，其值也是从此读取的。</li>
<li>需要注意的是：这个过程中 Spring Security 还会自动帮你判断用户是否启用、是否锁定、密码是否过期等等。如果你选择下面的手动认证逻辑，那这些判断就必须你自己来实现。</li>
</ol>
</li>
<li>自定义认证逻辑（自定义登录 API，不用 <code>AuthenticationManager</code>，自己写认证逻辑）：<ol>
<li>你仍然需要自己去校验前端提交的用户名和密码，和 <code>CustomerUserDetailsImpl</code> 中提供的数据是否一致；</li>
<li>验证通过后，你需要手动将 <code>CustomerUserDetailsImpl</code> 封装为一个 <code>Authentication</code> 对象，并保存到当前线程中；</li>
<li>其实在校验阶段，用户名和密码放不放到 <code>CustomerUserDetailsImpl</code> 中都无所谓，你甚至可以直接从<code>User Entity</code> 中拿值来对比。更高级一点，你也可以使用扫码登录、验证码、OAuth2 等方式，不再局限于用户名密码；</li>
<li>但是，一旦你需要构建 <code>Authentication</code>，你最终还是得使用 <code>CustomUserDetailsImpl</code>，因为 <code>Authentication</code> 中的数据必须要从它那里来。</li>
<li>所以我们可以得出一个结论：在认证过程中不一定非得依赖 <code>CustomerUserDetailsImpl</code>，但在封装 <code>Authentication</code> 的过程中，最终数据必须来自这个实现类。</li>
</ol>
</li>
</ol>
</li>
<li>最后就是权限判断的问题。权限判断是根据当前线程中保存的 <code>Authentication</code> 对象来进行的，而这个对象里的权限信息，不就是我们 <code>CustomerUserDetailsImpl</code> 的 <code>getAuthorities()</code> 方法中返回的吗？所以说本质上这些权限数据，也都是从 <code>CustomerUserDetailsImpl</code> 里来的</li>
</ol>
<p>所以，如果我们使用了 Spring Security，那么实现 <code>CustomerUserDetailsImpl</code> 就显得尤为关键。那问题来了：我们到底是如何将 <code>UserMapper</code> 查询到的 <code>User</code> 对象中的信息，封装进 <code>CustomerUserDetailsImpl</code> 的？</p>
<p>首先思考下：如果是要把 <code>User</code> 对象中的属性同步到 <code>CustomerUserDetailsImpl</code> 中，我们一般会想到以下两种方式：</p>
<ol>
<li>显示赋值方式：<ol>
<li>我们可以先使用 <code>UserMapper</code> 查询出一个 <code>User</code> 对象，然后 <code>new</code> 一个 <code>CustomerUserDetailsImpl</code> 对象，接着再逐个地将 <code>User</code> 的属性赋值到这个对象中。这种方式直观易懂，但写起来繁琐冗长，尤其当字段较多时，容易出错。</li>
</ol>
</li>
<li>构造方法方式（推荐）：<ol>
<li>在 <code>CustomerUserDetailsImpl</code> 中定义一个以 <code>User</code> 为参数的构造方法，那么当我们 <code>new</code> 它的时候，直接传入一个 <code>User</code> 对象，构造函数内部再将 <code>User</code> 的各个属性赋值到当前对象中。这样封装更简洁、更优雅，也更利于后续维护</li>
</ol>
</li>
</ol>
<p>但这里我们需要特别注意一点：<code>CustomerUserDetailsImpl</code> 本质上并不是一个普通的属性容器（如果它只是一些简单的属性，那显式赋值和构造方法两种方式都可以使用）。它作为 <code>UserDetails</code> 的实现类，其核心职责是通过方法的返回值来向 Spring Security 暴露用户信息的（也就是说，它的用户数据并不是通过公共属性暴露的，而是通过接口方法提供的）</p>
<p>因此，我们在封装时更适合采用构造方法的方式。具体来说，就是在 <code>CustomerUserDetailsImpl</code> 中定义一个接收 <code>User</code> 对象的构造函数，在构造函数中将该 <code>User</code> 对象保存为内部私有字段。然后在 <code>getUsername()</code>、<code>getPassword()</code>、<code>getAuthorities()</code> 等方法中，直接返回这个 <code>User</code> 对象中的相应属性值，大致如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomerUserDetailsImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetails</span> &#123;<br><br>    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">User</span> user;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">CustomerUserDetailsImpl</span>(<span class="hljs-title class_">User</span> user) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span> = user;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getUsername</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">getUsername</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getPassword</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">getPassword</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Collection</span>&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; <span class="hljs-title function_">getAuthorities</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">getAuthorities</span>(); <br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isAccountNonExpired</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">getIsAccountnonexpired</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isAccountNonLocked</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">getIsAccountnonlocked</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isCredentialsNonExpired</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">getIsCredentialsnonexpired</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isEnabled</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">getIsEnabled</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>那我们写好这个类之后，只需要在某个方法中，先通过 <code>UserMapper</code> 查询出一个 <code>User</code> 对象，然后直接执行 <code>new CustomerUserDetailsImpl(user)</code>，就能创建出一个封装了用户信息的 <code>CustomerUserDetailsImpl</code> 实例。</p>
<p>其实这个步骤，Spring Security 早已帮我们考虑好了，它已经提供了一个专门的接口：<code>UserDetailsService</code>。我们只需要实现这个接口，并重写它的 <code>loadUserByUsername</code> 方法，在这个方法中使用 <code>UserMapper</code> 查询出对应的 <code>User</code>，然后直接 <code>return new CustomerUserDetailsImpl(user)</code> 即可。</p>
<p>这样一来，当我们调用这个方法的时候，它就会执行查询用户信息，并返回一个包含完整用户数据的 <code>CustomerUserDetailsImpl</code> 对象，供后续构建 <code>Authentication</code> 使用。</p>
<p>需要注意的是，<code>CustomerUserDetailsImpl</code> 并不属于传统意义上的三层架构（Controller-Service-Repository），严格来说，它应当放置在 <code>com.example.securitywithhttpsession.entity</code> 包下，作为用户实体信息的一个安全扩展模型。</p>
<p>此外，Spring Security 提供的 <code>UserDetails</code> 接口默认只包含七个核心字段：<code>username</code>、<code>password</code>、<code>isAccountNonExpired</code>、<code>isAccountNonLocked</code>、<code>isCredentialsNonExpired</code>、<code>isEnabled</code> 和 <code>authorities</code>。</p>
<p>如果你希望在 <code>Authentication</code> 中携带更多的信息（例如 <code>email</code> 和 <code>phoneNumber</code>），是可以通过扩展 <code>CustomerUserDetailsImpl</code> 来实现的。这样做的好处是：你可以直接从 <code>SecurityContext</code> 中获取 <code>Authentication</code>，再从中获取这些扩展信息，无需再根据 <code>username</code> 查询数据库。这种方式在某些业务中能显著简化逻辑，提高效率。</p>
<p>不过需要明确的是，Spring Security 的设计初衷并不是鼓励我们将过多的用户字段直接放进 <code>Authentication</code> 对象中。是否将这些字段一并封装，应该根据你的具体业务场景权衡决定，避免过度冗余或信息泄露风险。</p>
<p>最终，我们实现的代码就如下所示：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomerUserDetailsImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetails</span> &#123;<br><br>    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">User</span> user;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">CustomerUserDetailsImpl</span>(<span class="hljs-title class_">User</span> user) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span> = user;<br>    &#125;<br><br>    <span class="hljs-comment">// 必须实现的 3 个方法</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Collection</span>&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; <span class="hljs-title function_">getAuthorities</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">getAuthorities</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getPassword</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">getPassword</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getUsername</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">getUsername</span>();<br>    &#125;<br><br>    <span class="hljs-comment">// 可选择实现的 4 个方法</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isAccountNonExpired</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">getIsAccountnonexpired</span>() != <span class="hljs-literal">null</span> &amp;&amp; user.<span class="hljs-title function_">getIsAccountnonexpired</span>() != <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isAccountNonLocked</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">getIsAccountnonlocked</span>() != <span class="hljs-literal">null</span> &amp;&amp; user.<span class="hljs-title function_">getIsAccountnonlocked</span>() !=<span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isCredentialsNonExpired</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">getIsCredentialsnonexpired</span>() != <span class="hljs-literal">null</span> &amp;&amp; user.<span class="hljs-title function_">getIsCredentialsnonexpired</span>() != <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isEnabled</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">getIsEnabled</span>() != <span class="hljs-literal">null</span> &amp;&amp; user.<span class="hljs-title function_">getIsEnabled</span>() != <span class="hljs-number">0</span>;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 选择性扩展的字段</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getEmail</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">getEmail</span>();<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getPhoneNumber</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">getPhoneNumber</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>由于我们的 <code>User</code> 中字段是 <code>private Integer isAccountNonExpired;</code>，而接口方法 <code>public boolean isAccountNonExpired()</code> 需要返回 boolean 类型，所以在实现时必须手动判断，如：<code>return user.getIsAccountNonExpired() != null &amp;&amp; user.getIsAccountNonExpired() != 0;</code></li>
<li>其实没必要这么复杂，主要原因是我们在 <code>User</code> 中使用了 Integer 类型。对于 MyBatis，如果你把字段声明成 <code>private boolean isAccountNonExpired;</code> 在相同的 SQL 语句下，它会自动把数据库中的 TINYINT(1) 映射成 boolean 类型，这样我们只需直接返回：<code>return user.isAccountNonExpired();</code></li>
<li>这样写就不需要额外判断了，而且更简洁，也比较推荐。但既然代码已经写成这样，我们就保持现有实现，下面给你展示这种推荐的写法：</li>
</ol>
</blockquote>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// User Entity</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br><br>	<span class="hljs-comment">// users 表中的数据（用户基本信息）</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Integer</span> userId;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> username;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> password;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Boolean</span> isAccountNonExpired;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Boolean</span> isAccountNonLocked;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Boolean</span> isCredentialsNonExpired;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Boolean</span> isEnabled;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> email;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> phoneNumber;<br>    <br>	<span class="hljs-comment">// authorities 表中的数据（用户的权限，不要忘记添加这个）</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">SimpleGrantedAuthority</span>&gt; authorities;<br><br>    <span class="hljs-comment">// getter 方法</span><br>	<span class="hljs-comment">// setter 方法</span><br>	<span class="hljs-comment">// equals 方法</span><br>	<span class="hljs-comment">// hashCode 方法</span><br>	<span class="hljs-comment">// toString 方法</span><br>&#125;<br><br><span class="hljs-comment">// CustomerUserDetailsImpl</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomerUserDetailsImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetails</span> &#123;<br><br>    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">User</span> user;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">CustomerUserDetailsImpl</span>(<span class="hljs-title class_">User</span> user) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span> = user;<br>    &#125;<br><br>    <span class="hljs-comment">// 必须实现的 3 个方法</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Collection</span>&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; <span class="hljs-title function_">getAuthorities</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">getAuthorities</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getPassword</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">getPassword</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getUsername</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">getUsername</span>();<br>    &#125;<br><br>    <span class="hljs-comment">// 可选择实现的 4 个方法</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isAccountNonExpired</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">getIsAccountnonexpired</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isAccountNonLocked</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">getIsAccountnonlocked</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isCredentialsNonExpired</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">getIsCredentialsnonexpired</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isEnabled</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">getIsEnabled</span>();<br>    &#125;<br>    <br>    <span class="hljs-comment">// 选择性扩展的字段</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getEmail</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">getEmail</span>();<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getPhoneNumber</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">getPhoneNumber</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h4 id="1-1-5-实现-UserDetailsService-接口"><a href="#1-1-5-实现-UserDetailsService-接口" class="headerlink" title="1.1.5. 实现 UserDetailsService 接口"></a>1.1.5. 实现 UserDetailsService 接口</h4><p>我们一般创建 <code>CustomerUserDetailsImplService</code> 类，用于实现这个接口，并重写它的 <code>loadUserByUsername</code> 方法，在这个方法中使用 <code>UserMapper</code> 查询出对应的 <code>User</code>，然后直接 <code>return new CustomerUserDetailsImpl(user)</code> 即可。</p>
<p><code>CustomerUserDetailsImplService</code> 类位于 <code>com.example.securitywithhttpsession.service</code> 包下</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-title class_"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomerUserDetailsImplService</span> <span class="hljs-keyword"><span class="hljs-keyword">implements</span> <span class="hljs-type">UserDetailsService</span></span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserDetails loadUserByUsername(<span class="hljs-keyword">String</span> username) throws UsernameNotFoundException &#123;<br>        User user = userMapper.getUserByUserName(username);<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span><span class="hljs-type"></span> UsernameNotFoundException(<span class="hljs-string">&quot;user not found&quot;</span> + username);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span><span class="hljs-type"></span> CustomerUserDetailsImpl(user);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>写成 <code>private final UserMapper userMapper</code> 的话，就不能使用 <code>@Autowired</code> 这种方式进行注入，必须要使用构造注入的方式进行注入</li>
</ol>
</blockquote>
<hr>
<h4 id="1-1-6-进行-Spring-Security-配置"><a href="#1-1-6-进行-Spring-Security-配置" class="headerlink" title="1.1.6. 进行 Spring Security 配置"></a>1.1.6. 进行 Spring Security 配置</h4>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Java/" class="category-chain-item">Java</a>
  
  
    <span>></span>
    
  <a href="/categories/Java/Spring-%E7%94%9F%E6%80%81/" class="category-chain-item">Spring 生态</a>
  
  
    <span>></span>
    
  <a href="/categories/Java/Spring-%E7%94%9F%E6%80%81/Spring-Security/" class="category-chain-item">Spring Security</a>
  
  

  

  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>笔记：Spring Security</div>
      <div>https://wangjia5289.github.io/2025/05/18/笔记：Spring Security/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>霸天</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>May 18, 2025</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/05/18/%E7%AC%94%E8%AE%B0%EF%BC%9AJUC/" title="笔记：JUC">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">笔记：JUC</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/05/17/%E7%AC%94%E8%AE%B0%EF%BC%9ASpring%20Data%20Redis/" title="笔记：Spring Data Redis">
                        <span class="hidden-mobile">笔记：Spring Data Redis</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  



  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.utils.listenDOMLoaded(function() {
      Fluid.events.registerRefreshCallback(function() {
        if ('mermaid' in window) {
          mermaid.init();
        }
      });
    });
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  var relativeDate = function() {
    var updatedTime = document.getElementById('updated-time');
    if (updatedTime) {
      var text = updatedTime.textContent;
      var reg = /\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:Z|[+-]\d{2}:\d{2})/;
      var matchs = text.match(reg);
      if (matchs) {
        var relativeTime = moment(matchs[0]).fromNow();
        updatedTime.textContent = text.replace(reg, relativeTime);
      }
      updatedTime.style.display = '';
    }
  };
  Fluid.utils.createScript('https://lib.baomitu.com/moment.js/2.29.4/moment.min.js', function() {
    if (!'en'.startsWith('en')) {
      Fluid.utils.createScript('https://lib.baomitu.com/moment.js/2.29.4/locale/en.min.js', function() {
        relativeDate();
      });
    } else {
      relativeDate();
    }
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"display":{"superSample":2,"width":200,"height":350,"position":"left","hOffset":40,"vOffset":-20},"mobile":{"show":false,"scale":0.5},"react":{"opacityDefault":1,"opacityOnHover":0.5},"log":false});</script></body>
</html>
