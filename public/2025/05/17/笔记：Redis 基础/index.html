

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/ico.png">
  <link rel="icon" href="/img/ico.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#373737">
  <meta name="author" content="霸天">
  <meta name="keywords" content="">
  
    <meta name="description" content="理论1. 导图：Map：Redis 2. Redis 语法2.1. 系统命令12# 1. 心跳命令（检测该客户端与 Redis 的连接是正常）ping   集群命令1234567主从集群的哦，其他的无效可以动态设置，比如在 Redis 启动后执行：replicaof 192.168.1.100 6379要取消从属关系，恢复成主节点，执行：replicaof no one     2.2. 字符串键">
<meta property="og:type" content="article">
<meta property="og:title" content="笔记：Redis 基础">
<meta property="og:url" content="https://wangjia5289.github.io/2025/05/17/%E7%AC%94%E8%AE%B0%EF%BC%9ARedis%20%E5%9F%BA%E7%A1%80/index.html">
<meta property="og:site_name" content="夜阑卧听风吹雨,一枝梨花压心头">
<meta property="og:description" content="理论1. 导图：Map：Redis 2. Redis 语法2.1. 系统命令12# 1. 心跳命令（检测该客户端与 Redis 的连接是正常）ping   集群命令1234567主从集群的哦，其他的无效可以动态设置，比如在 Redis 启动后执行：replicaof 192.168.1.100 6379要取消从属关系，恢复成主节点，执行：replicaof no one     2.2. 字符串键">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9ARedis%20%E5%9F%BA%E7%A1%80/image-20250601162731128.png">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9ARedis%20%E5%9F%BA%E7%A1%80/image-20250601162633830.png">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9ARedis%20%E5%9F%BA%E7%A1%80/image-20250530162454124.png">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9ARedis%20%E5%9F%BA%E7%A1%80/image-20250530104631796.png">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9ARedis%20%E5%9F%BA%E7%A1%80/image-20250530160330698.png">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9ARedis%20%E5%9F%BA%E7%A1%80/image-20250530160555827.png">
<meta property="og:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9ARedis%20%E5%9F%BA%E7%A1%80/image-20250530161002181.png">
<meta property="article:published_time" content="2025-05-16T16:00:00.000Z">
<meta property="article:modified_time" content="2025-06-28T11:12:48.697Z">
<meta property="article:author" content="Ba Tian">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://wangjia5289.github.io/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9ARedis%20%E5%9F%BA%E7%A1%80/image-20250601162731128.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>笔记：Redis 基础 - 夜阑卧听风吹雨,一枝梨花压心头</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"wangjia5289.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 100vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/post.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="笔记：Redis 基础"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-05-17 00:00" pubdate>
          May 17, 2025 am
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          8.4k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          71 mins
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> views
        </span>
        

      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">笔记：Redis 基础</h1>
            
              <p id="updated-time" class="note note-info" style="display: none">
                
                  
                    Last updated on 2025-06-28T19:12:48+08:00
                  
                  

                
              </p>
            
            
              <div class="markdown-body">
                
                <h1 id="理论"><a href="#理论" class="headerlink" title="理论"></a>理论</h1><h2 id="1-导图：Map：Redis"><a href="#1-导图：Map：Redis" class="headerlink" title="1. 导图：Map：Redis"></a>1. 导图：<a href="Map%EF%BC%9ARedis.xmind">Map：Redis</a></h2><hr>
<h2 id="2-Redis-语法"><a href="#2-Redis-语法" class="headerlink" title="2. Redis 语法"></a>2. Redis 语法</h2><h3 id="2-1-系统命令"><a href="#2-1-系统命令" class="headerlink" title="2.1. 系统命令"></a>2.1. 系统命令</h3><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs autoit"><span class="hljs-meta"># 1. 心跳命令（检测该客户端与 Redis 的连接是正常）</span><br><span class="hljs-built_in">ping</span><br></code></pre></td></tr></table></figure>


<h3 id="集群命令"><a href="#集群命令" class="headerlink" title="集群命令"></a>集群命令</h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stata"><br>主从集群的哦，其他的无效<br>可以动态设置，比如在 Redis 启动后执行：<br>replicaof 192.168.1.100 6379<br><br>要取消从属关系，恢复成主节点，执行：<br>replicaof <span class="hljs-keyword">no</span> <span class="hljs-keyword">one</span><br></code></pre></td></tr></table></figure>



<hr>
<h3 id="2-2-字符串键值对命令"><a href="#2-2-字符串键值对命令" class="headerlink" title="2.2. 字符串键值对命令"></a>2.2. 字符串键值对命令</h3><p>&#x3D;&#x3D;1.插入字符串键值对&#x3D;&#x3D;</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 1. 设置单个键值对</span><br><span class="hljs-built_in">set</span> key value [NX|XX] [GET] [EX seconds|PX milliseconds|EXAT unix-time-seconds|PXAT unix-time-milliseconds|KEEPTTL]<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. NX：</span><br><span class="hljs-string">	1. 仅在键不存在时设置，等价于插入操作</span><br><span class="hljs-string">2. XX：</span><br><span class="hljs-string">	1. 仅在键已存在时设置，等价于更新操作</span><br><span class="hljs-string">3. GET: </span><br><span class="hljs-string">	1. 设置新值前，返回键当前的值（若不存在返回 `nil`），便于获取旧值做对比</span><br><span class="hljs-string">4. EX seconds：</span><br><span class="hljs-string">	1. 设置键在指定 “秒数” 后过期（相对时间）</span><br><span class="hljs-string">5. PX milliseconds：</span><br><span class="hljs-string">	1. 设置键在指定 “毫秒数” 后过期（相对时间）</span><br><span class="hljs-string">6. EXAT timestamp: </span><br><span class="hljs-string">	1. 设置键在指定 “秒级 Unix 时间戳” 时过期（绝对时间）</span><br><span class="hljs-string">7. PXAT milliseconds-timestamp: </span><br><span class="hljs-string">	1. 设置键在指定 “毫秒级 Unix 时间戳” 时过期（绝对时间）</span><br><span class="hljs-string">8. KEEPTTL: </span><br><span class="hljs-string">	1. 在更新键值时保留其原有 TTL（生存时间）不变</span><br><span class="hljs-string">	2. 不能与任何过期时间参数（如 EX、PX、EXAT、PXAT）同时使用——要么保留现有 TTL，要么设置新的过期时间，二者不可兼得。</span><br><span class="hljs-string">9. 举例：</span><br><span class="hljs-string">	1. SET mykey &quot;hello&quot; NX EX 10</span><br><span class="hljs-string">	2. SET session_token &quot;abc123&quot; EXAT 1717155600</span><br><span class="hljs-string">	3. SET cache_result &quot;ok&quot; PXAT 1717155600123</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br><span class="hljs-comment"># 2. 批量设置多个键值对</span><br>MSET key1 value1 key2 value2 key3 value3<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 举例：</span><br><span class="hljs-string">	1. MSET user:1 &quot;Alice&quot; user:2 &quot;Bob&quot; user:3 &quot;Carol&quot;</span><br><span class="hljs-string">2. 注意事项：</span><br><span class="hljs-string">	1. 不同于 Redis 管道（Pipeline），其是多条命令批量发送，非原子的</span><br><span class="hljs-string">	2. 而此命令是原子性的，一条命令设置多个键值对，所有键值对要么全部设置成功，要么全部失败</span><br><span class="hljs-string">	3. 当你使用 MSET 设置多个键时，不能使用 [NX|XX|GET|EX|PX|EXAT|PXAT|KEEPTTL] 这些选项</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br><span class="hljs-comment"># 3. 批量设置多个键值对（所有键必须不存在）</span><br>MSETNX key1 val1 key2 val2 key3 val3<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 注意事项：</span><br><span class="hljs-string">	1. 所有键都不存在时才执行，否则一个都不设置</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;2.删除字符串键值对&#x3D;&#x3D;</p>
<p>&#x3D;&#x3D;3.修改字符串键值对&#x3D;&#x3D;</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># 1. 数值操作（必须是数值字符串）</span><br><span class="hljs-attribute">SET</span> visits <span class="hljs-number">100</span>    # 初始值：<span class="hljs-number">100</span><br><span class="hljs-attribute">INCR</span> visits       # 数字递增：<span class="hljs-number">101</span><br><span class="hljs-attribute">INCRBY</span> visits <span class="hljs-number">50</span>  # 增加指定的整数：<span class="hljs-number">151</span><br><span class="hljs-attribute">DECR</span> visits       # 数字递减：<span class="hljs-number">150</span><br><span class="hljs-attribute">DECRBY</span> visits <span class="hljs-number">20</span>  # 减少指定的整数：<span class="hljs-number">130</span><br><br><br><span class="hljs-comment"># 2. 字符串追加</span><br><span class="hljs-attribute">APPEND</span> mykey <span class="hljs-string">&quot;world&quot;</span>  # 在末尾追加 <span class="hljs-string">&quot;world&quot;</span><br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;4.查询字符串键值对&#x3D;&#x3D;</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 1. 查询单个值</span><br>get key<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 举例：</span><br><span class="hljs-string">	1. get name</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br><span class="hljs-comment"># 2. 批量查询多个值</span><br>MGET key1 key2 key3<br><br><br><span class="hljs-comment"># 3. 获取字符串长度</span><br>STRLEN mykey<br><br><br><span class="hljs-comment"># 4. 查询剩余生存时间（以秒为单位）</span><br>System.out.println(Long.toString(System.currentTimeMillis()/<span class="hljs-number">1000</span>L));<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;5.其他命令&#x3D;&#x3D;</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs processing"># <span class="hljs-number">1.</span> 先 <span class="hljs-built_in">get</span> 再 <span class="hljs-built_in">set</span><br>getset <span class="hljs-built_in">key</span> value<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="3-Redis-管道"><a href="#3-Redis-管道" class="headerlink" title="3. Redis 管道"></a>3. Redis 管道</h2><p>Redis 管道是 Redis 提供的一种批量发送命令的机制，其核心目的是减少客户端与服务器之间的网络往返次数，从而显著提升性能。</p>
<p>比如执行如下命令，其处理流程是：客户端发送请求 ➜ 服务器接收并处理 ➜ 服务器返回结果 ➜ 客户端等待接收：</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-keyword">SET</span> name <span class="hljs-comment">&quot;Alice&quot;</span><br></code></pre></td></tr></table></figure>

<p>如果你连续发送 100 条命令，这个过程就得重复 100 次，网络延迟就会成为严重瓶颈。而使用管道机制，我们可以一次性把这 100 条命令打包发送，Redis 也会一口气处理完所有请求，然后将结果一并返回，效率大幅提升。</p>
<p>我们常常在 Java 代码中使用 Redis 管道操作（Pipelining）来提升性能：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-comment">// 以 Jedis 为例</span><br>Jedis jedis = <span class="hljs-keyword">new</span> Jedis(<span class="hljs-string">&quot;localhost&quot;</span>);<br>Pipeline pipeline = jedis.pipelined();<br><br>pipeline.<span class="hljs-keyword">set</span>(<span class="hljs-string">&quot;key1&quot;</span>, <span class="hljs-string">&quot;value1&quot;</span>);<br>pipeline.<span class="hljs-keyword">set</span>(<span class="hljs-string">&quot;key2&quot;</span>, <span class="hljs-string">&quot;value2&quot;</span>);<br>pipeline.<span class="hljs-keyword">get</span>(<span class="hljs-string">&quot;key1&quot;</span>);<br><br><span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">Object</span>&gt; results = pipeline.syncAndReturnAll();<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>管道不同于事务机制，它不具备原子性，也不能回滚，仅仅是提高通信效率、批量发送的一种手段</li>
</ol>
</blockquote>
<hr>
<h1 id="实操"><a href="#实操" class="headerlink" title="实操"></a>实操</h1><h2 id="1-服务把控"><a href="#1-服务把控" class="headerlink" title="1. 服务把控"></a>1. 服务把控</h2><h3 id="1-1-线程特性"><a href="#1-1-线程特性" class="headerlink" title="1.1. 线程特性"></a>1.1. 线程特性</h3><p>Redis 采用的是 “<strong>主线程执行命令 + 多线程处理部分辅助功能</strong>” 的架构。在数据读写方面，Redis 始终坚持使用一个主线程来执行命令。由于 Redis 直接操作的是内存，访问速度极快，即使只用单线程处理，也能获得非常高的性能。更关键的是，单线程模式无需考虑线程安全问题，不需要加锁，从而避免了锁竞争等开销，反而执行效率更高。</p>
<p>而针对一些可能拖慢主线程性能的任务，Redis 引入了 <strong>多线程或后台子进程</strong> 来“分担杂活”，提高整体响应能力，例如：</p>
<ol>
<li>&#x3D;&#x3D;网络 I&#x2F;O 处理&#x3D;&#x3D;：<ol>
<li>从 Redis 6.0 起，可在配置文件中通过 <code>io-threads</code> 参数启动若干专用网络线程（默认关闭）。</li>
<li>这些线程负责客户端的请求、建立连接、协议解析和回复发送，真正的主线程只调度命令执行，IO 线程直接做数据收发，避免高并发时主线程在网络上“排队”。</li>
</ol>
</li>
<li>&#x3D;&#x3D;异步删除大 Key&#x3D;&#x3D;：<ol>
<li>当删除非常大的对象（如超长列表、巨型哈希）时，命令执行后主线程只标记删除，并将释放内存的任务提交给后台“懒卸载”线程（通过 <code>lazyfree-threads</code> 配置）。</li>
<li>这些线程在空闲时异步清理对象，避免主线程因一次性大规模内存释放而卡顿。</li>
</ol>
</li>
<li>&#x3D;&#x3D;集群通信、数据同步相关的任务&#x3D;&#x3D;：<ol>
<li>在集群模式下，节点间心跳维护、槽迁移、故障检测等通信都由集群总线线程异步处理，主线程仅负责本地命令执行。</li>
<li>在主从模式下，主节点有专门的 I&#x2F;O 线程向从节点推送复制流，从节点也有 I&#x2F;O 线程接收。</li>
</ol>
</li>
<li>&#x3D;&#x3D;持久化&#x3D;&#x3D;：<ol>
<li>虽然 Redis 把数据放在内存中，但它也会周期性地将数据持久化到磁盘，比如通过 RDB 快照或 AOF 日志</li>
<li>这些写磁盘的操作相对耗时，因此 Redis 主进程 <code>fork()</code> 出一个子进程，该子进程负责异步进行持久化</li>
</ol>
</li>
</ol>
<hr>
<h2 id="2-环境搭建"><a href="#2-环境搭建" class="headerlink" title="2. 环境搭建"></a>2. 环境搭建</h2><h3 id="2-1-单机测试"><a href="#2-1-单机测试" class="headerlink" title="2.1. 单机测试"></a>2.1. 单机测试</h3><h4 id="2-1-1-集群特性"><a href="#2-1-1-集群特性" class="headerlink" title="2.1.1. 集群特性"></a>2.1.1. 集群特性</h4><h5 id="2-1-1-1-事务支持"><a href="#2-1-1-1-事务支持" class="headerlink" title="2.1.1.1. 事务支持"></a>2.1.1.1. 事务支持</h5><p>Redis 的事务机制本质上是<strong>单机级别的</strong>，在 Redis Cluster 模式下，其使用受到一定限制，不能保证跨节点的原子性</p>
<p>当我们调用 <code>MULTI</code> 时，表示开启一个事务，接下来的命令将依次进入事务队列，此时 Redis 不执行这些命令，而是返回 <code>QUEUED</code> 表示排队成功。直到我们执行 <code>EXEC</code>，所有排队命令才会被按顺序执行，并且执行期间不会被其他客户端打断，从而实现 “顺序一致、不可中断” 的效果</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs awk">WATCH account_A balance_B         <span class="hljs-comment"># 开始监视一个或多个 key，直到事务执行（EXEC）或被显式放弃（DISCARD）</span><br>val_A = GET account_A<br>val_B = GET balance_B<br><br><span class="hljs-keyword">if</span> val_A &gt;= <span class="hljs-number">100</span>:                   <br>    MULTI                         <span class="hljs-comment"># 开启事务</span><br>    DECRBY account_A <span class="hljs-number">100</span>          <span class="hljs-comment"># 发送多个命令（排队）</span><br>    INCRBY balance_B <span class="hljs-number">100</span><br>    EXEC                          <span class="hljs-comment"># 提交事务</span><br><span class="hljs-keyword">else</span>:<br>    DISCARD                       <span class="hljs-comment"># 余额不足，放弃事务</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 注意事项：</span><br><span class="hljs-string">	1. 如果在 WATCH 到 EXEC 之间，监视的任意 key被其他客户端修改了，事务提交时会自动失败（EXEC 返回 nil），但事务队列不会自动取消（简单来说：只是提交失败，事务不会自动取消），而 DISCARD 是让我们主动放弃事务 + 取消监视</span><br><span class="hljs-string">	2. 事务不是数据库那种全回滚事务，而是一旦某条命令出错，其前后命令仍然会照常执行，不会回滚。</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></td></tr></table></figure>

<hr>
<h4 id="2-1-2-Docker-环境部署"><a href="#2-1-2-Docker-环境部署" class="headerlink" title="2.1.2. Docker 环境部署"></a>2.1.2. Docker 环境部署</h4><p>&#x3D;&#x3D;1.创建宿主机数据挂载目录&#x3D;&#x3D;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p /mystudy/data/redis<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;2.启动 Redis 容器&#x3D;&#x3D;</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs awk">docker run -d \<br>  --name redis \<br>  -p <span class="hljs-number">6379</span>:<span class="hljs-number">6379</span> \<br>  -v <span class="hljs-regexp">/mystudy/</span>data<span class="hljs-regexp">/redis:/</span>data \<br>  redis:latest \<br>  redis-server --appendonly yes --bind <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span> --requirepass wq666666<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. --appendonly yes</span><br><span class="hljs-string">	1. 开启 AOF（Append Only File）持久化模式，简单可靠，适合这个场景</span><br><span class="hljs-string">2. --bind 0.0.0.0</span><br><span class="hljs-string">	1. 监听所有网卡</span><br><span class="hljs-string">	2. Redis 默认只监听 127.0.0.1，也就是说只有通过本机地址 127.0.0.1:6379 才能访问它，哪怕你用本机的其他 IP（比如 192.168.136.8:6379）也无法连接。</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></td></tr></table></figure>

<hr>
<h3 id="主从集群"><a href="#主从集群" class="headerlink" title="主从集群"></a>主从集群</h3><h4 id="集群概述"><a href="#集群概述" class="headerlink" title="集群概述"></a>集群概述</h4><p>主从集群是 Redis 最经典的集群模式，通常为一主多从架构：数据仅写入唯一的主节点，从节点通过复制机制同步主节点的数据，整个集群中只有一条主从复制链：</p>
<p><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9ARedis%20%E5%9F%BA%E7%A1%80/image-20250601162731128.png" srcset="/img/loading.gif" lazyload></p>
<p>即使构建出多个主从组合的“多主多从”结构，其本质仍是伪多主：各主节点之间没有任何协调机制，彼此独立，数据完全隔离，甚至不具备 Redis Cluster 所支持的数据分片能力。<br><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9ARedis%20%E5%9F%BA%E7%A1%80/image-20250601162633830.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<h4 id="集群特性"><a href="#集群特性" class="headerlink" title="集群特性"></a>集群特性</h4><h5 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h5><hr>
<h3 id="2-2-Redis-Cluster-集群"><a href="#2-2-Redis-Cluster-集群" class="headerlink" title="2.2. Redis Cluster 集群"></a>2.2. Redis Cluster 集群</h3><h4 id="2-2-1-集群概述"><a href="#2-2-1-集群概述" class="headerlink" title="2.2.1. 集群概述"></a>2.2.1. 集群概述</h4><p>Redis Cluster 是 Redis 官方提供的开源集群解决方案，通常采用主从架构搭建，并需要我们手动进行运维管理。它的最大特点在于，数据在写入时会被自动按哈希槽进行分区，直接分配到不同的主节点，随后，各主节点的数据由对应的从节点进行同步,而非像传统的大数据系统那样先进行分库分表处理。</p>
<hr>
<h4 id="2-2-2-集群特性"><a href="#2-2-2-集群特性" class="headerlink" title="2.2.2. 集群特性"></a>2.2.2. 集群特性</h4><h5 id="2-2-2-1-数据同步（单体一致性）"><a href="#2-2-2-1-数据同步（单体一致性）" class="headerlink" title="2.2.2.1. 数据同步（单体一致性）"></a>2.2.2.1. 数据同步（单体一致性）</h5><p>采用的是异步复制——主节点在写入成功后会立即返回；如果此时主节点宕机，而从节点尚未完成同步却被提升为主节点，就会导致数据丢失。这与 MySQL 类似，同样最多只能保障 <strong>单体一致性</strong>，实现分布式一致性中的 <strong>最终一致性</strong>，无法满足真正的强一致性的要求。</p>
<p>尽管在很多使用场景下，相比 MySQL，我们对 Redis 中数据的“是否存在”或“是否最新”已经更宽容一些，但对于诸如金融交易、秒杀等对一致性要求极高的业务场景，这种宽容是不可接受的，我们仍然必须追求严格的分布式一致性。</p>
<hr>
<h5 id="2-2-2-2-数据分布"><a href="#2-2-2-2-数据分布" class="headerlink" title="2.2.2.2. 数据分布"></a>2.2.2.2. 数据分布</h5><p>Redis Cluster 采用虚拟槽分区，所有键通过哈希函数（<code>CRC16[key] &amp; 16383</code>）映射到编号为 0 到 16383 的槽内，共计 16384 个槽（编号从 0 开始）<br><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9ARedis%20%E5%9F%BA%E7%A1%80/image-20250530162454124.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>数据仅分布在主节点上，不直接分区到从节点；从节点仅负责从对应主节点同步数据</li>
</ol>
</blockquote>
<hr>
<h5 id="2-2-2-3-事务支持"><a href="#2-2-2-3-事务支持" class="headerlink" title="2.2.2.3. 事务支持"></a>2.2.2.3. 事务支持</h5><p>Redis Cluster 只支持同一个节点（slot）内的事务操作，跨节点时会立即报错</p>
<p>这是因为 Redis Cluster 采用了<strong>虚拟槽位（hash slot）分区机制</strong>：每个 key 会通过哈希函数映射到某个槽位（slot），再由系统将槽位分配给不同的 Redis 节点。例如，以下命令：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">MSET <span class="hljs-keyword">user</span>:<span class="hljs-number">1</span>:<span class="hljs-type">name</span> Alice <span class="hljs-keyword">user</span>:<span class="hljs-number">2</span>:<span class="hljs-type">name</span> Bob<br></code></pre></td></tr></table></figure>

<p>如果 <code>user:1:name</code> 和 <code>user:2:name</code> 分别落在不同的槽位（slot），即分布在不同的节点上，Redis 会直接返回错误：<code>CROSSSLOT Keys in request don&#39;t hash to the same slot</code></p>
<p>如果项目对性能要求不高但需要强一致性的事务，使用单节点 Redis 即可满足需求；但如果系统规模较大且需要支持分布式事务，就需要考虑其他架构方案，而不是依赖 Redis Cluster 来解决（或许 Redis 初衷就算不是强一致性）</p>
<hr>
<h5 id="2-2-2-4-集群限制"><a href="#2-2-2-4-集群限制" class="headerlink" title="2.2.2.4. 集群限制"></a>2.2.2.4. 集群限制</h5><p>在使用 Redis Cluster 时，也只能使用 DB 0</p>
<h4 id="2-2-3-一主多从架构"><a href="#2-2-3-一主多从架构" class="headerlink" title="2.2.3. 一主多从架构"></a>2.2.3. 一主多从架构</h4><h5 id="2-2-3-1-节点列表"><a href="#2-2-3-1-节点列表" class="headerlink" title="2.2.3.1. 节点列表"></a>2.2.3.1. 节点列表</h5><table>
<thead>
<tr>
<th>IP</th>
<th>主机名</th>
<th>角色</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.136.8</td>
<td></td>
<td>master</td>
</tr>
<tr>
<td>192.168.136.9</td>
<td></td>
<td>slave</td>
</tr>
<tr>
<td>192.168.136.10</td>
<td></td>
<td>slave</td>
</tr>
</tbody></table>
<hr>
<h5 id="2-2-3-2-目录结构"><a href="#2-2-3-2-目录结构" class="headerlink" title="2.2.3.2. 目录结构"></a>2.2.3.2. 目录结构</h5><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-operator">/</span>mystudy<span class="hljs-operator">/</span>redis<span class="hljs-symbol">/</span><br>├── src<span class="hljs-symbol">/</span>              <span class="hljs-comment"># 源码和编译目录（解压后）</span><br>├── bin<span class="hljs-symbol">/</span>              <span class="hljs-comment"># 可执行文件（redis-server、redis-cli）</span><br>├── conf<span class="hljs-symbol">/</span>             <span class="hljs-comment"># 配置文件（redis7000.conf 等）</span><br>├── data<span class="hljs-symbol">/</span>             <span class="hljs-comment"># 数据目录（按端口分子目录）</span><br>│   ├── <span class="hljs-number">7000</span><span class="hljs-symbol">/</span><br>│   └── <span class="hljs-number">7001</span><span class="hljs-symbol">/</span><br>├── logs<span class="hljs-symbol">/</span>             <span class="hljs-comment"># 日志目录（按端口分子目录）</span><br>│   ├── <span class="hljs-number">7000</span><span class="hljs-symbol">/</span><br>│   └── <span class="hljs-number">7001</span><span class="hljs-symbol">/</span><br>└── redis-<span class="hljs-number">7.4</span>.<span class="hljs-number">0</span>.tar.gz         <span class="hljs-comment"># 原始 tar.gz 文件</span><br><br><br><span class="hljs-symbol">/mystudy/redis</span> <span class="hljs-symbol">/</span><br>├── redis <span class="hljs-symbol">/</span><br>├── redis-<span class="hljs-number">7.4</span>.<span class="hljs-number">0</span>.tar.gz<br><br><br><br><br></code></pre></td></tr></table></figure>

<hr>
<h5 id="2-2-3-3-环境准备"><a href="#2-2-3-3-环境准备" class="headerlink" title="2.2.3.3. 环境准备"></a>2.2.3.3. 环境准备</h5><h6 id="2-2-3-3-1-查看-Ubuntu-版本"><a href="#2-2-3-3-1-查看-Ubuntu-版本" class="headerlink" title="2.2.3.3.1. 查看 Ubuntu 版本"></a>2.2.3.3.1. 查看 Ubuntu 版本</h6><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">lsb_release -<span class="hljs-selector-tag">a</span><br></code></pre></td></tr></table></figure>

<hr>
<h6 id="2-2-3-3-2-下载软件"><a href="#2-2-3-3-2-下载软件" class="headerlink" title="2.2.3.3.2. 下载软件"></a>2.2.3.3.2. 下载软件</h6><p>在 <a target="_blank" rel="noopener" href="https://redis.io/downloads/#software">Redis 官方下载地址</a> 下载 Redis 安装包（<code>redis-7.4.0.tar.gz</code>）<br><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9ARedis%20%E5%9F%BA%E7%A1%80/image-20250530104631796.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<h6 id="2-2-3-3-3-相关工具"><a href="#2-2-3-3-3-相关工具" class="headerlink" title="2.2.3.3.3. 相关工具"></a>2.2.3.3.3. 相关工具</h6><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">sudo apt <span class="hljs-keyword">install </span>-y <span class="hljs-keyword">build-essential </span>pkg-<span class="hljs-built_in">config</span> tcl make libjemalloc-dev<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="2-2-3-3-4-时间同步"><a href="#2-2-3-3-4-时间同步" class="headerlink" title="2.2.3.3.4. 时间同步"></a>2.2.3.3.4. 时间同步</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. 安装 chrony</span><br><span class="hljs-built_in">sudo</span> apt install -y chrony<br><br><br><span class="hljs-comment"># 2. 启动并开启自启动 chrony</span><br><span class="hljs-built_in">sudo</span> systemctl <span class="hljs-built_in">enable</span> chrony &amp;&amp; <span class="hljs-built_in">sudo</span> systemctl start chrony<br></code></pre></td></tr></table></figure>

<hr>
<h6 id="2-2-3-3-5-开放端口"><a href="#2-2-3-3-5-开放端口" class="headerlink" title="2.2.3.3.5. 开放端口"></a>2.2.3.3.5. 开放端口</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 1. 开放 6379 ~ 6381、16379 ~ 16381 TCP 端口</span><br>sudo ufw allow proto tcp <span class="hljs-keyword">from</span> <span class="hljs-number">192.168</span><span class="hljs-number">.136</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> to <span class="hljs-built_in">any</span> port <span class="hljs-number">6379</span>:<span class="hljs-number">6381</span>,<span class="hljs-number">16379</span>:<span class="hljs-number">16381</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. proto tcp from 192.168.136.0/24</span><br><span class="hljs-string">	1. 仅允许来自 192.168.136.0/24 网段的机器访问这些端口</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>由于我们只有三台服务器，因此只需开放端口至 6381 和 16381。若有四台，则需开放至 6382 和 16382，依此类推</li>
</ol>
</blockquote>
<hr>
<h6 id="2-2-3-3-6-关闭-Swap-分区"><a href="#2-2-3-3-6-关闭-Swap-分区" class="headerlink" title="2.2.3.3.6. 关闭 Swap 分区"></a>2.2.3.3.6. 关闭 Swap 分区</h6><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 1. 将 内容注释</span><br>vim <span class="hljs-regexp">/etc/</span>fstab<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string"># 将此内容进行注释</span><br><span class="hljs-string"># /swap.img       none    swap    sw      0       0</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br><span class="hljs-comment"># 2. 立即关闭 Swap 分区</span><br>swapoff -a<br></code></pre></td></tr></table></figure>

<hr>
<h5 id="2-2-3-4-安装软件"><a href="#2-2-3-4-安装软件" class="headerlink" title="2.2.3.4. 安装软件"></a>2.2.3.4. 安装软件</h5><p>&#x3D;&#x3D;1.创建 &#x2F;mystudy&#x2F;redis 目录并进入&#x3D;&#x3D;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p /mystudy/redis<br><br><br><span class="hljs-built_in">cd</span> /mystudy/redis<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;2.上传安装包&#x3D;&#x3D;<br>上传 <code>redis-7.4.0.tar.gz</code> 到 <code>/mystudy/redis</code></p>
<p>&#x3D;&#x3D;3.解压安装包&#x3D;&#x3D;</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">sudo</span> tar -xvf redis-<span class="hljs-number">7</span>.<span class="hljs-number">4</span>.<span class="hljs-number">0</span>.tar.gz<br><br><br><span class="hljs-attribute">mv</span> redis-<span class="hljs-number">7</span>.<span class="hljs-number">4</span>.<span class="hljs-number">0</span> redis<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;4.编译第三方库&#x3D;&#x3D;</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">cd</span> /mystudy/redis/redis/deps<br><br><br><span class="hljs-keyword">make</span> hiredis linenoise <span class="hljs-keyword">lua</span> hdr_histogram fpconv jemalloc<br></code></pre></td></tr></table></figure>


<p>&#x3D;&#x3D;5.安装软件&#x3D;&#x3D;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /mystudy/redis/redis<br><br><br>make &amp;&amp; make install<br><br><br><span class="hljs-comment"># 查看 redis-server 是否安装并可执行</span><br><span class="hljs-built_in">which</span> redis-server<br></code></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意事项</p>
<ol>
<li>Redis 最终被安装到 <code>/mystudy/redis/redis</code> 目录下，但 <code>make &amp;&amp; make install</code> 会把一些 可执行文件  安装到 <code>/usr/local/bin/</code> 下：<ol>
<li>redis-server：<ol>
<li>Redis 服务器启动命令</li>
</ol>
</li>
<li>redis-cli：<ol>
<li>Redis 客户端工具</li>
</ol>
</li>
<li>redis-benchmark：<ol>
<li>Redis 性能测试工具</li>
</ol>
</li>
<li>redis-sentinel：<ol>
<li>Redis 集群相关</li>
</ol>
</li>
<li>redis-check-aof：<ol>
<li>修复有问题的 AOF 文件</li>
</ol>
</li>
<li>redis-check-dump：<ol>
<li>修复有问题的 dump.rdb 文件</li>
</ol>
</li>
</ol>
</li>
<li>如果编译失败，请先执行以下命令清理旧文件，然后重新安装：</li>
</ol>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /mystudy/redis/redis<br><br><br>make distclean<br></code></pre></td></tr></table></figure>

<hr>
<h5 id="2-2-3-5-创建相关目录（配置、数据、日志、pid）"><a href="#2-2-3-5-创建相关目录（配置、数据、日志、pid）" class="headerlink" title="2.2.3.5. 创建相关目录（配置、数据、日志、pid）"></a>2.2.3.5. 创建相关目录（配置、数据、日志、pid）</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">mkdir</span> -p /mystudy/redis/conf /mystudy/redis/data /mystudy/redis/logs /mystudy/redis/pid<br><br><br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">cp</span> /mystudy/redis/redis/redis.conf /mystudy/redis/conf<br></code></pre></td></tr></table></figure>

<hr>
<h1 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h1><h2 id="1-Redis-配置文件"><a href="#1-Redis-配置文件" class="headerlink" title="1. Redis 配置文件"></a>1. Redis 配置文件</h2><h3 id="1-1-Redis-配置文件位置"><a href="#1-1-Redis-配置文件位置" class="headerlink" title="1.1. Redis 配置文件位置"></a>1.1. Redis 配置文件位置</h3><p>Redis 可以在 <code>/mystudy/reids/reidis/redis.conf</code> 中进行配置</p>
<hr>
<h3 id="网络配置（NETWORK）"><a href="#网络配置（NETWORK）" class="headerlink" title="网络配置（NETWORK）"></a>网络配置（NETWORK）</h3><figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><code class="hljs julia"><span class="hljs-comment">################################## NETWORK #####################################</span><br>bind<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. Redis 监听的网络接口地址（网卡地址）</span><br><span class="hljs-string">2. 127.0.0.1 -::1（默认）：</span><br><span class="hljs-string">	1. 127.0.0.1 表示 IPV4 回环地址</span><br><span class="hljs-string">	2. - 表示即使该地址当前在网卡上不可见，也不会导致启动失败</span><br><span class="hljs-string">	3. ::1 表示 IPV6 回环地址</span><br><span class="hljs-string">	4. 即仅允许来自本机的 IPv4 和 IPv6 回环地址访问，适合本地开发或非集群部署（客户端程序 与 Redis 在同一台服务器上，否则无法通过网络访问 Redis 服务）</span><br><span class="hljs-string">3. 其他 具体 IP：</span><br><span class="hljs-string">	1. 如 192.168.136.8</span><br><span class="hljs-string">4. 0.0.0.0：</span><br><span class="hljs-string">	1. 所有地址</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br>protected-mode<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 是否启用保护模式</span><br><span class="hljs-string">2. yes（默认）：</span><br><span class="hljs-string">	1. 表示 启用保护模式</span><br><span class="hljs-string">	2. 当默认用户（default）未设置任何身份验证（即没有密码，也没有 ACL 授权）时，Redis 会仅接收来自本机回环地址（127.0.0.1、::1）或 Unix 文件通信接口的连接请求，拒绝任何非本机的 TCP 连接（外部连接会被拒绝）</span><br><span class="hljs-string">	3. 即便我们没使用默认用户，而是其他用户（设置密码或 ACL 授权），也会被拒绝</span><br><span class="hljs-string">3. no：</span><br><span class="hljs-string">	1. 表示 不启用保护模式</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br>enable-protected-configs<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 是否允许修改某些高风险配置项，如 dir、dbfilename、save、appendonly、bind、requirepass、user 等</span><br><span class="hljs-string">2. yes：</span><br><span class="hljs-string">	1. 允许</span><br><span class="hljs-string">3. no（默认）：</span><br><span class="hljs-string">	1. 不允许</span><br><span class="hljs-string">4. local：</span><br><span class="hljs-string">	1. 仅允许来自本机的连接执行</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br>enable-debug-command<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 是否允许使用 DEBUG 命令族，如 DEBUG SEGFAULT（可以让 Redis 故意崩溃）、DEBUG RELOAD、DEBUG HTSTATS 等。这些命令多数是为开发和调试设计的，在生产环境中很危险</span><br><span class="hljs-string">2. yes：</span><br><span class="hljs-string">	1. 允许</span><br><span class="hljs-string">3. no（默认）：</span><br><span class="hljs-string">	1. 不允许</span><br><span class="hljs-string">4. local：</span><br><span class="hljs-string">	1. 仅允许来自本机的连接执行</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br>enable-<span class="hljs-keyword">module</span>-command<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 是否允许使用 MODULE 命令族，如 MODULE LOAD、MODULE UNLOAD 等。加载模块的权限相当于动态向 Redis 注入 C 语言代码，安全风险极高。</span><br><span class="hljs-string">2. yes：</span><br><span class="hljs-string">	1. 允许</span><br><span class="hljs-string">3. no（默认）：</span><br><span class="hljs-string">	1. 不允许</span><br><span class="hljs-string">4. local：</span><br><span class="hljs-string">	1. 仅允许来自本机的连接执行</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br>port<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 监听的端口号</span><br><span class="hljs-string">2. 6379（默认）：</span><br><span class="hljs-string">	1. 单实例情况下，通常是 6379</span><br><span class="hljs-string">3. 6380 ~ ...：</span><br><span class="hljs-string">	1. 单机多实例情况下，通常是从 6380 开始，一个实例一个端口</span><br><span class="hljs-string">4. 0：</span><br><span class="hljs-string">	1. 关闭所有 TCP 监听，一般用于纯 Unix socket 模式（了解就好，集群搭建不能用 Unix socket 模式，只适用于单机模式）</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br>tcp-backlog<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. TCP 监听队列的大小。当客户端连接 Redis 时，如果 TCP 三次握手完成，但 Redis 还没来得及处理这个连接，且 Redis 正在忙着处理其他请求，这些连接就会被放入 backlog 队列等待。如果 backlog 队列满了，新来的连接将被操作系统直接拒绝</span><br><span class="hljs-string">2. 注意事项：</span><br><span class="hljs-string">	1. 即便我们配置了 tcp-backlog 为 10000，也不代表真的能排队 10000 个连接，因为 Linux 会对这个值进行隐性限制，主要由两个系统参数控制：</span><br><span class="hljs-string">		1. /proc/sys/net/core/somaxconn：</span><br><span class="hljs-string">			1. 定义内核中 TCP 监听队列（backlog）的最大长度</span><br><span class="hljs-string">			2. 查看该值：</span><br><span class="hljs-string">				1. cat /proc/sys/net/core/somaxconn </span><br><span class="hljs-string">			3. 修改该值：</span><br><span class="hljs-string">				1. 临时修改，重启失效：</span><br><span class="hljs-string">					1. sudo sysctl -w net.core.somaxconn=1024</span><br><span class="hljs-string">				2. 永久修改，重启生效：</span><br><span class="hljs-string">					1. 编辑 /etc/sysctl.conf</span><br><span class="hljs-string">					2. 加入 net.core.somaxconn = 1024</span><br><span class="hljs-string">					3. 执行 sudo sysctl -p</span><br><span class="hljs-string">		2. /proc/sys/net/ipv4/tcp_max_syn_backlog：</span><br><span class="hljs-string">			1. 定义 TCP 半连接队列的最大长度</span><br><span class="hljs-string">			2. 即 TCP 三次握手尚未完成的连接数，通常指服务器收到客户端 SYN 后回复 SYN+ACK，但尚未收到客户端最后 ACK 的连接，处于半连接状态，这些连接会被放到该队列中</span><br><span class="hljs-string">			3. 查看该值：</span><br><span class="hljs-string">				1. cat /proc/sys/net/ipv4/tcp_max_syn_backlog</span><br><span class="hljs-string">			4. 修改该值：</span><br><span class="hljs-string">				1. 临时修改，重启失效：</span><br><span class="hljs-string">					1. sudo sysctl -w net.ipv4.tcp_max_syn_backlog=2048</span><br><span class="hljs-string">				2. 永久修改，重启生效：</span><br><span class="hljs-string">					1. 编辑 /etc/sysctl.conf</span><br><span class="hljs-string">					2. 加入 net.ipv4.tcp_max_syn_backlog = 2048</span><br><span class="hljs-string">					3. 执行 sudo sysctl -p</span><br><span class="hljs-string">	2. 如果 tcp-backlog 设置为 1000，但 /proc/sys/net/core/somaxconn 是 500，那么 TCP 监听队列最大只能是 500。也就是说，要想支持更大的连接排队数，必须同时调整这几个参数，才能获得更高性能。</span><br><span class="hljs-string">	3. Redis 和 MySQL 都有连接池，连接池维护的是已经建立好的 “长连接”，我们复用这些连接。你可能会问：既然连接已经建立好并复用，为什么还需要配置 tcp-backlog？难道后续还会建立新连接？答案是：当业务瞬时产生大量连接时，如果连接池内的连接不够用，且连接池还没达到最大连接数限制，会创建新的连接；另外，短连接模式下频繁建立连接也会产生新连接，部分客户端也可能不支持连接池。</span><br><span class="hljs-string">	4. 当使用连接池时，客户端等待可用连接时，会在应用层维护一个等待队列（如线程等待或请求排队），这部分与内核的 tcp-backlog、somaxconn 等参数无关，属于应用层面的管理</span><br><span class="hljs-string">	5. 那我们直接配置 /proc/sys/net/core/somaxconn 就好了，为什么还要配置 tcp-backlog 呢？这是因为：</span><br><span class="hljs-string">		1. tcp-backlog 是 Redis 向内核 申请的监听队列长度，表示它期望内核为自己保留多少排队的连接数；</span><br><span class="hljs-string">		2. 而 /proc/sys/net/core/somaxconn 是 操作系统内核的全局上限，用于限制所有程序（包括 Redis）最大能使用多少连接排队空间</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br>unixsocket<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 配置 Redis 是否通过 Unix socket 接收连接，不是通过 TCP 连接（了解就好）</span><br><span class="hljs-string">2. Unix socket 只适用于本机通信，分布式或者 java 程序与 Redis 不在同机，不适合用这个，还是使用 tcp</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br>timeout<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 客户端空闲超时时间，以秒为单位</span><br><span class="hljs-string">2. 0（默认）：</span><br><span class="hljs-string">	1. 永不超时</span><br><span class="hljs-string">3. 其他 具体值：</span><br><span class="hljs-string">	1. 如 300 代表 5 分钟</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br>tcp-keepalive<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 每隔 多长时间 向客户端发送一次 TCP keepalive 包，以秒为单位。能有效防止死连接，例如有时客户端异常断开，但服务器端没收到关闭通知，以为连接还在使用，这时候连接变成 “死连接”，我们使用这种方式，就能探测客户端是否还在线，防止大量无效连接导致资源浪费</span><br><span class="hljs-string">2. 300（默认）：</span><br><span class="hljs-string">	1. 每隔 5 分钟 向客户端发送一次 TCP keepalive 包 </span><br><span class="hljs-string">3. 其他 具体值：</span><br><span class="hljs-string">	1. 如 60 代表 1 分钟</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br>socket-mark-id<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></td></tr></table></figure>

<hr>
<h3 id="TLS-SSL-配置（TLS-SSL）"><a href="#TLS-SSL-配置（TLS-SSL）" class="headerlink" title="TLS &#x2F; SSL 配置（TLS&#x2F;SSL）"></a>TLS &#x2F; SSL 配置（TLS&#x2F;SSL）</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure>

<hr>
<h3 id="通用配置（GENERAL）"><a href="#通用配置（GENERAL）" class="headerlink" title="通用配置（GENERAL）"></a>通用配置（GENERAL）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><code class="hljs python">daemonize<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. no：</span><br><span class="hljs-string">	1. Redis 以前台方式运行（前台方式运行，就是不以守护进行运行）</span><br><span class="hljs-string">2. yes：</span><br><span class="hljs-string">	1. Redis 以后台方式运行，并创建 pid 文件</span><br><span class="hljs-string">		1. 以后台方式运行，就是以守护进程运行</span><br><span class="hljs-string">		2. pid 就是 process ID（进程编号）的缩写，每个正在运行的进程在操作系统里都有一个唯一的数字标识，叫做 PID。</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br>supervised<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. Redis 如何与操作系统的 服务管理器 配合工作，主要是针对 Linux 下常见的两种服务管理工具：</span><br><span class="hljs-string">	1. Upstart：</span><br><span class="hljs-string">		1. 较老的服务管理系统</span><br><span class="hljs-string">	2. systemd：</span><br><span class="hljs-string">		1. 现代主流服务管理系统</span><br><span class="hljs-string">2. 其实就是决定 Redis 启动时，是否以及如何向服务管理器报告“我已经准备好了”，从而实现与服务管理器的配合，让它们准确掌握 Redis 的运行状态，方便后续管理和监控。</span><br><span class="hljs-string">	1. 重点是针对这种情况：如果不汇报状态，操作系统无法准确判断 Redis 是否启动成功。比如系统启动时，需要先启动 Redis，再启动依赖它的应用，但操作系统不知道 Redis 什么时候真正可用，可能会提前启动依赖服务，导致运行错误</span><br><span class="hljs-string">	2. 这和进程本身无关，仅仅是告诉操作系统 “我准备好了” 与否。无论是否汇报，只要 Redis 启动了，你都能找到它的进程 ID，并通过该 PID kill 进程</span><br><span class="hljs-string">3. no（默认）：</span><br><span class="hljs-string">	1. 不启用任何服务管理器的交互，不汇报状态</span><br><span class="hljs-string">4. upstart：</span><br><span class="hljs-string">	1. 适配 Upstart 服务管理系统</span><br><span class="hljs-string">5. systemd：</span><br><span class="hljs-string">	1. 适配 systemd 服务管理系统</span><br><span class="hljs-string">6. auto：</span><br><span class="hljs-string">	1. 自动检测当前环境变量（如通过 UPSTART_JOB 或 NOTIFY_SOCKET 判断），自动选择合适的 supervision 方法。</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br>pidfile<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. Redis 启动后，除了由操作系统分配进程号（PID），还会将该 PID 写入配置指定的 pidfile 文件中，主要用于后续进程管理和关闭操作。</span><br><span class="hljs-string">2. 需要注意，即使不写入 pidfile，Redis 进程本身依然会正常启动和运行，你仍然可以通过 ps aux | grep redis 等方式查到它。pidfile 的意义在于：当我们编写 shell 脚本来启动或停止 Redis 时，通常通过 cat redis.pid 获取 PID 后执行 kill 命令；或者在一台服务器上同时运行多个 Redis 实例时，通过不同的 pidfile 区分各自的进程。</span><br><span class="hljs-string">3. 另外，不需要提前手动创建 pid 文件，Redis 会在启动过程中自动生成该文件，只要确保其所在目录存在并具有写权限即可。</span><br><span class="hljs-string">4. /var/run/redis_6379.pid（默认）：</span><br><span class="hljs-string">	1. 默认路径</span><br><span class="hljs-string">5. 其他 路径：</span><br><span class="hljs-string">	1. 如 /mystudy/redis/pid/redis.pid</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br>loglevel<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 指定日志等级</span><br><span class="hljs-string">2. debug：</span><br><span class="hljs-string">	1. 最详细的级别，适合调试</span><br><span class="hljs-string">3. verbose：</span><br><span class="hljs-string">4. notice：</span><br><span class="hljs-string">	1. 输出适度的重要消息，推荐用于生产环境</span><br><span class="hljs-string">5. warning：</span><br><span class="hljs-string">	1. 只记录关键或严重问题</span><br><span class="hljs-string">6. nothing：</span><br><span class="hljs-string">	1. 不记录任何日志（几乎没人用，除非你追求极致的性能或又其他监控机制）</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br>logfile<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 指定日志文件的位置</span><br><span class="hljs-string">2. &quot;&quot;（默认）：</span><br><span class="hljs-string">	1. 代表日志输出到标准输出</span><br><span class="hljs-string">3. 其他 路劲：</span><br><span class="hljs-string">	1. 例如 /mystudy/redis/logs/redis.log</span><br><span class="hljs-string">4. 我们可以指定其他路径，如果你启用了 daemonize yes，而又没有指定日志文件，日志会被丢弃到 /dev/null。</span><br><span class="hljs-string">	1. daemonize 和我们的日志有什么关系？</span><br><span class="hljs-string">	2. 服务前台运行时，stdout 是终端，可以看到日志</span><br><span class="hljs-string">	3. 服务后台运行时，stdout 被重定向到 /dev/null，除非我们设置了 loglevel</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br>syslog-enabled<br><br><br>syslog-ident<br><br><br>syslog-facility<br><br><br>crash-log-enabled<br><br><br>crash-memcheck-enabled<br><br><br>databases<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 数据库的数量</span><br><span class="hljs-string">2. 可选值：</span><br><span class="hljs-string">	1. 16（默认）：</span><br><span class="hljs-string">		1. Redis 默认 16 个数据库</span><br><span class="hljs-string">	2. 其他 数值：</span><br><span class="hljs-string">		1. 例如 8</span><br><span class="hljs-string">3. 注意事项：</span><br><span class="hljs-string">	1. 虽然 Redis 提供了多个逻辑库，但很多实际项目中只使用 DB 0</span><br><span class="hljs-string">	2. 在使用 Redis Cluster 时，也只能使用 DB 0</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br>always-show-logo<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 是否在 Redis 启动时，显示 ASCII 艺术字 logo</span><br><span class="hljs-string">2. 可选值：</span><br><span class="hljs-string">	1. yes</span><br><span class="hljs-string">	2. no</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br>hide-user-data-<span class="hljs-keyword">from</span>-log<br><br><br><span class="hljs-built_in">set</span>-proc-title<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 是否修改 Redis 进程名，以便在系统工具如 top、ps aux 中显示更丰富的运行时信息，方便管理员快速了解进程状态</span><br><span class="hljs-string">2. 可选值：</span><br><span class="hljs-string">	1. yes（默认）：</span><br><span class="hljs-string">		1. Redis 会修改当前进程的标题（进程名），具体能修改成什么，看下面 proc-title-template</span><br><span class="hljs-string">	2. no：</span><br><span class="hljs-string">		1. Redis 进程名保持为启动时的原始名称，不显示附加的运行时状态信息</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br>proc-title-template<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 设置进程标题的模板</span><br><span class="hljs-string">2. 可选值：</span><br><span class="hljs-string">	1. &#123;title&#125; &#123;listen-addr&#125; &#123;server-mode&#125;（默认）：</span><br><span class="hljs-string">		1. 默认模板</span><br><span class="hljs-string">3. 候选值：</span><br><span class="hljs-string">	1. &#123;title&#125;：</span><br><span class="hljs-string">		1. 进程名称，如果是主进程就是执行命令名，子进程则显示子进程类型</span><br><span class="hljs-string">	2. &#123;listen-addr&#125;：</span><br><span class="hljs-string">		1. 监听的地址</span><br><span class="hljs-string">	3. &#123;server-mode&#125;：</span><br><span class="hljs-string">		1. 服务器特殊模式，比如 [sentinel] 表示哨兵模式，[cluster] 表示集群模式</span><br><span class="hljs-string">	4. &#123;port&#125;：</span><br><span class="hljs-string">		1. TCP 监听端口，若未开启则为 0</span><br><span class="hljs-string">	5. &#123;tls-port&#125;：</span><br><span class="hljs-string">		1. TLS 监听端口，若未开启则为 0</span><br><span class="hljs-string">	6. &#123;unixsocket&#125;：</span><br><span class="hljs-string">		1. Unix 域套接字路径，未使用则为空字符串。</span><br><span class="hljs-string">	7. &#123;config-file&#125;：</span><br><span class="hljs-string">		1. Redis 使用的配置文件名称</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>locale-collate<br><br></code></pre></td></tr></table></figure>

<hr>
<h3 id="1-2-RDB-配置（SNAPSHOTTING）"><a href="#1-2-RDB-配置（SNAPSHOTTING）" class="headerlink" title="1.2. RDB 配置（SNAPSHOTTING）"></a>1.2. RDB 配置（SNAPSHOTTING）</h3><figure class="highlight pony"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs pony">save <span class="hljs-number">3600</span> <span class="hljs-number">1</span> <span class="hljs-number">300</span> <span class="hljs-number">100</span> <span class="hljs-number">60</span> <span class="hljs-number">10000</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 3600 秒内（1小时）有 ≥ 1 次写操作，进入 RDB 快照保存</span><br><span class="hljs-string">2. 300 秒内（5分钟）有 ≥ 100 次写操作，进入 RDB 快照保存</span><br><span class="hljs-string">3. 60 秒内有 ≥ 10000 次写操作，进入 RDB 快照保存</span><br><span class="hljs-string">4. 可以写成 save &quot;&quot; 表示禁用 RDB 快照保存</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br>stop-writes-on-bgsave-<span class="hljs-keyword">error</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 是否当 Redis 在后台保存快照失败时停止接受写操作，目的是：强行提醒你 “写入的数据没有成功持久化”，别以为还很安全</span><br><span class="hljs-string">2. 可选值：</span><br><span class="hljs-string">	1. yes（默认）</span><br><span class="hljs-string">	2. no：</span><br><span class="hljs-string">		1. 如果你已经有很完善的监控，也可以改成 no</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br>rdbcompression<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 是否在保存 .rdb 文件时会使用 LZF 算法压缩字符串对象</span><br><span class="hljs-string">2. 可选值：</span><br><span class="hljs-string">	1. yes（默认）：</span><br><span class="hljs-string">		1. 能够节省磁盘空间，代价是保存过程稍微多耗些 CPU</span><br><span class="hljs-string">	2. no：</span><br><span class="hljs-string">		1. 更省 CPU，尤其适合 CPU 紧张的环境，但文件会变大</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br>rdbchecksum<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 是否在 RDB 文件末尾添加一个 CRC64 校验和</span><br><span class="hljs-string">2. 可选值：</span><br><span class="hljs-string">	1. yes（默认）：</span><br><span class="hljs-string">		1. 能够提高文件的可靠性，防止损坏导致读取出错</span><br><span class="hljs-string">	2. no：</span><br><span class="hljs-string">		1. 节省一点性能（10% 左右），但读取时不会校验是否损坏</span><br><span class="hljs-string">&quot;&quot;&quot;</span><span class="hljs-string">&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">sanitize-dump-payload</span><br><span class="hljs-string">&quot;</span><span class="hljs-string">&quot;&quot;</span><br><span class="hljs-number">1.</span> 控制 <span class="hljs-type">Redis</span> 在加载 <span class="hljs-type">RDB</span> 文件或执行 <span class="hljs-type">RESTORE</span> 命令时，是否对压缩结构（如 ziplist、listpack）做完整性检查，防止出现不一致或崩溃。<br><span class="hljs-number">2.</span> 可选值：<br>	<span class="hljs-number">1.</span> clients（默认）：<br>		<span class="hljs-number">1.</span> 只对客户端连接恢复的数据检查，推荐使用<br>	<span class="hljs-number">2.</span> yes：<br>		<span class="hljs-number">1.</span> 总是检查，最安全<br>	<span class="hljs-number">3.</span> no：<br>		<span class="hljs-number">1.</span> 不检查，性能最高，但风险高<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">dbfilename</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-number">1.</span> 保存快照的文件名<br><span class="hljs-number">2.</span> 可选值：<br>	<span class="hljs-number">1.</span> dump.rdb（默认）<br>	<span class="hljs-number">2.</span> 其他 文件名<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">rdb-del-sync-files</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-number">1.</span> 当 <span class="hljs-type">Redis</span> 实例既没有开启 <span class="hljs-type">RDB</span>，也没有开启 <span class="hljs-type">AOF</span> 时，是否要删除用于主从同步的临时 <span class="hljs-type">RDB</span> 文件<br><span class="hljs-number">2.</span> 可选值：<br>	<span class="hljs-number">1.</span> yes：<br>		<span class="hljs-number">1.</span> 删除在主从同步过程中创建的 <span class="hljs-type">RDB</span> 文件（就是我作为主节点，生成的用于发送给从节点并供其加载的那个 <span class="hljs-type">RDB</span> 文件）<br>	<span class="hljs-number">2.</span> no（默认）：<br>		<span class="hljs-number">1.</span> <span class="hljs-type">RDB</span> 同步文件保留在磁盘<br><span class="hljs-number">3.</span> 注意事项：<br>	<span class="hljs-number">1.</span> 你可能会好奇，既然我没有开启持久化，为什么主从同步还能正常进行？其实，主从同步的核心是数据复制，这个过程并不依赖于持久化文件，而是基于内存中的数据快照来传输。<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">dir </span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-number">1.</span> 保存 dump.rdb（和 <span class="hljs-type">AOF</span> 文件）的工作目录（工作目录，不包含文件名）<br><span class="hljs-number">2.</span> 可选值：<br>	<span class="hljs-number">1.</span> ./（默认）：<br>		<span class="hljs-number">1.</span> 即当前目录<br>		<span class="hljs-number">2.</span> 注意不是配置文件 redis.conf 所在的目录，而是指你启动 <span class="hljs-type">Redis</span> 服务器时所在的那个目录<br>	<span class="hljs-number">2.</span> 其他 目录：<br>		<span class="hljs-number">1.</span> 例如 /mystudy/redis/data<br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></td></tr></table></figure>

<hr>
<h3 id="主从复制配置（REPLICATION）"><a href="#主从复制配置（REPLICATION）" class="headerlink" title="主从复制配置（REPLICATION）"></a>主从复制配置（REPLICATION）</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs awk">replicaof<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 设置 当前 Redis 实例 为某个主节点的副本（从节点）</span><br><span class="hljs-string">2. 可选值：</span><br><span class="hljs-string">	1. 具体 IP 和 端口：</span><br><span class="hljs-string">		1. 例如 replicaof 192.168.1.10 6379</span><br><span class="hljs-string">3. 注意事项， </span><br><span class="hljs-string">	1. 只适用于传统的主从集群，Redis Cluster 集群下，Redis会忽略掉 replicaof 指令，因为 Redis Cluster 会维护自己的节点信息表（nodes.conf），主从关系记录在这里，而不是来自 replicaof 的配置。</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br>masteruser<br>masterauth<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. ACL 的用户名和密码</span><br><span class="hljs-string">2. 注意事项：</span><br><span class="hljs-string">	1. 这是基于 ACL 的，在 Redis 6 之前，只需要写 masterauth ，里面写主节点的密码即可</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br>replica-serve-stale-data<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 是否当副本即使与主节点失联了，也继续响应客户端的读请求</span><br><span class="hljs-string">2. 可选值：</span><br><span class="hljs-string">	1. yes（默认）：</span><br><span class="hljs-string">		1. 可能会返回旧数据</span><br><span class="hljs-string">	2. no：</span><br><span class="hljs-string">		1. 会拒绝大多数数据访问命令，只允许执行部分命令（如 INFO、REPLICAOF、AUTH、CONFIG 等管理命令）</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br>replica-read-only<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">1. 副本是否是只读的（读写分离）</span><br><span class="hljs-string">2. 可选值：</span><br><span class="hljs-string">	1. yes（默认）：</span><br><span class="hljs-string">		1. 读写分离</span><br><span class="hljs-string">	2. no</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br><br><br></code></pre></td></tr></table></figure>





















<h3 id="安全配置"><a href="#安全配置" class="headerlink" title="安全配置"></a>安全配置</h3><h2 id="2-常见分区方案"><a href="#2-常见分区方案" class="headerlink" title="2. 常见分区方案"></a>2. 常见分区方案</h2><p>哈西分区、一致性哈希分区、节点取余分区</p>
<table>
<thead>
<tr>
<th>分区方式</th>
<th>适用场景</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>范围分区</td>
<td>按时间、数字范围查询多</td>
<td>查询区间快</td>
<td>数据分布可能不均</td>
</tr>
<tr>
<td>列表分区</td>
<td>离散字段（国家、类型）</td>
<td>灵活</td>
<td>维护复杂，数据倾斜</td>
</tr>
<tr>
<td>哈希分区</td>
<td>数据均匀分布</td>
<td>负载均衡好</td>
<td>不适合范围查询</td>
</tr>
<tr>
<td>复合分区</td>
<td>复杂查询和负载均衡要求</td>
<td>灵活兼顾</td>
<td>复杂难管理</td>
</tr>
<tr>
<td>键值分区</td>
<td>Redis、分布式缓存</td>
<td>自动透明</td>
<td>受限于哈希算法</td>
</tr>
</tbody></table>
<h3 id="2-1-节点取余分区"><a href="#2-1-节点取余分区" class="headerlink" title="2.1. 节点取余分区"></a>2.1. 节点取余分区</h3><p>直接对某个字段（如用户ID）的数值进行取余运算（mod），根据节点总数确定数据存放的位置。举例来说，4个节点时，用户ID为12345，则计算：</p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">12345 </span>% <span class="hljs-number">4</span> = <span class="hljs-number">1</span>  → 数据落在节点 <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<p>该方法实现简单，定位快速，只需知道节点数量和 key 即可完成映射。数据在节点间分布较均匀，有效避免热点节点。</p>
<p>但其缺点也较明显：一旦节点数发生变化（如从4扩容到5），几乎所有 key 的映射结果都会改变，导致大量数据迁移。此外，均匀分布虽好，但会导致连续范围的数据被分散到不同节点，降低范围查询效率。</p>
<hr>
<h3 id="2-2-哈希分区"><a href="#2-2-哈希分区" class="headerlink" title="2.2. 哈希分区"></a>2.2. 哈希分区</h3><p>与节点取余分区类似，但不同之处在于，先对 key 进行哈希，无论 key 是数字还是字符串，都能统一处理。示例：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">hash</span>(<span class="hljs-string">&quot;user:123&quot;</span>) % <span class="hljs-number">3</span> = <span class="hljs-number">1</span>  → 数据落在节点 <span class="hljs-number">1</span>（key 是 user:<span class="hljs-number">123</span>）<br><span class="hljs-attribute">hash</span>(<span class="hljs-string">&quot;user:456&quot;</span>) % <span class="hljs-number">3</span> = <span class="hljs-number">0</span>  → 数据落在节点 <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<p>此方式简单高效，如果哈希函数的质量很高，可以实现良好的数据均匀分布。缺点与节点取余分区相同，即节点数变化时大规模数据重映射，以及范围查询效率受限。</p>
<hr>
<h3 id="2-3-一致性哈希分区"><a href="#2-3-一致性哈希分区" class="headerlink" title="2.3. 一致性哈希分区"></a>2.3. 一致性哈希分区</h3><p>把 key 和节点都映射到一个“虚拟哈希环”上，哈希空间范围从 0 到 2³²-1。每个 key 会被分配到它在环上顺时针遇到的第一个节点上。下面是一个典型的哈希环示意，key1 对应到 Node1：</p>
<p><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9ARedis%20%E5%9F%BA%E7%A1%80/image-20250530160330698.png" srcset="/img/loading.gif" lazyload></p>
<p>这种设计的好处是，当你增加或减少节点时，只有少量的 key 需要重新分配，避免了大量数据迁移的问题。不过需要注意的是，节点的位置也是通过哈希算出来的，分布不一定均匀，可能会导致某些节点压力比较大。比如，添加一个节点后，节点的分布可能像这样：</p>
<p><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9ARedis%20%E5%9F%BA%E7%A1%80/image-20250530160555827.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<h3 id="2-4-虚拟一致性哈希分区"><a href="#2-4-虚拟一致性哈希分区" class="headerlink" title="2.4. 虚拟一致性哈希分区"></a>2.4. 虚拟一致性哈希分区</h3><p>因为传统一致性哈希会出现有些节点“管得多”，有些“管得少”的情况，导致负载不平衡，所以引入了“虚拟节点”这个技巧。简单来说，就是给每个物理节点分配多个虚拟节点，让它们均匀分布在哈希环上，确保负载更平均。</p>
<p><img src="/source/_posts/%E7%AC%94%E8%AE%B0%EF%BC%9ARedis%20%E5%9F%BA%E7%A1%80/image-20250530161002181.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<h2 id="文件结构树"><a href="#文件结构树" class="headerlink" title="文件结构树"></a>文件结构树</h2><p>使用 Alt + 数字键：</p>
<ol>
<li>├：Alt + 195</li>
<li>─：Alt + 196</li>
<li>└：Alt + 192</li>
</ol>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/" class="category-chain-item">数据管理</a>
  
  
    <span>></span>
    
  <a href="/categories/%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/" class="category-chain-item">非关系型数据库</a>
  
  
    <span>></span>
    
  <a href="/categories/%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%94%AE%E5%80%BC%E5%9E%8B/" class="category-chain-item">键值型</a>
  
  
    <span>></span>
    
  <a href="/categories/%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%94%AE%E5%80%BC%E5%9E%8B/Redis/" class="category-chain-item">Redis</a>
  
  
    <span>></span>
    
  <a href="/categories/%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%94%AE%E5%80%BC%E5%9E%8B/Redis/Redis-%E5%9F%BA%E7%A1%80/" class="category-chain-item">Redis 基础</a>
  
  

  

  

  

  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>笔记：Redis 基础</div>
      <div>https://wangjia5289.github.io/2025/05/17/笔记：Redis 基础/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>霸天</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>May 17, 2025</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/05/18/%E7%AC%94%E8%AE%B0%EF%BC%9ASpring%20Security/" title="笔记：Spring Security">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">笔记：Spring Security</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/05/17/%E7%AC%94%E8%AE%B0%EF%BC%9ASpring%20Data%20Redis/" title="笔记：Spring Data Redis">
                        <span class="hidden-mobile">笔记：Spring Data Redis</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  



  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.utils.listenDOMLoaded(function() {
      Fluid.events.registerRefreshCallback(function() {
        if ('mermaid' in window) {
          mermaid.init();
        }
      });
    });
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  var relativeDate = function() {
    var updatedTime = document.getElementById('updated-time');
    if (updatedTime) {
      var text = updatedTime.textContent;
      var reg = /\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:Z|[+-]\d{2}:\d{2})/;
      var matchs = text.match(reg);
      if (matchs) {
        var relativeTime = moment(matchs[0]).fromNow();
        updatedTime.textContent = text.replace(reg, relativeTime);
      }
      updatedTime.style.display = '';
    }
  };
  Fluid.utils.createScript('https://lib.baomitu.com/moment.js/2.29.4/moment.min.js', function() {
    if (!'en'.startsWith('en')) {
      Fluid.utils.createScript('https://lib.baomitu.com/moment.js/2.29.4/locale/en.min.js', function() {
        relativeDate();
      });
    } else {
      relativeDate();
    }
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"display":{"superSample":2,"width":200,"height":350,"position":"left","hOffset":40,"vOffset":-20},"mobile":{"show":false,"scale":0.5},"react":{"opacityDefault":1,"opacityOnHover":0.5},"log":false});</script></body>
</html>
