### å¯¹ Spering WebFlux æ·±å…¥ç†è§£









### Reactive Streamsè§„èŒƒå®šä¹‰çš„å››ä¸ªæ ¸å¿ƒæ¥å£

1. Publisheræ˜¯æ•°æ®æºï¼Œè´Ÿè´£å‘å¸ƒæ•°æ®æµï¼›
	1. Flux å’Œ Mono å®ç°äº† Publisher
	2. ä¹Ÿå°±æ˜¯å“ªé‡Œåˆ›å»º Flux æˆ–è€… monoï¼Œé‚£ä¸ªå°±æ˜¯publisher
2. Subscriberæ˜¯æ•°æ®æ¶ˆè´¹è€…ï¼Œå¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®ï¼›
3. Subscriptionæ˜¯ä¸¤è€…ä¹‹é—´çš„æ¡¥æ¢ï¼Œæ§åˆ¶æ•°æ®æµé€Ÿç‡ï¼›
4. Processoråˆ™æ˜¯åŒæ—¶æ‰¿æ‹…å‘å¸ƒè€…å’Œè®¢é˜…è€…çš„ä¸­é—´å¤„ç†å•å…ƒ

# ä¸€ã€ç†è®º



---



---








è¿™ä¸ªé—®é¢˜é—®å¾—éå¸¸ç²¾å‡†ï¼ç­”æ¡ˆæ˜¯ï¼š

ğŸ‘‰ **Mono å’Œ Flux çš„æ–¹æ³•â€œå¾ˆå¤§ä¸€éƒ¨åˆ†æ˜¯ç›¸åŒçš„â€ï¼Œä½†å¹¶ä¸æ˜¯â€œå®Œå…¨ç›¸åŒâ€ã€‚**

è¿™æ˜¯å› ä¸ºï¼š

- `Mono<T>` æ˜¯ **æœ€å¤šåŒ…å«ä¸€ä¸ªå…ƒç´ ** çš„ Publisherï¼›
    
- `Flux<T>` æ˜¯ **å¯ä»¥åŒ…å« 0~N ä¸ªå…ƒç´ ** çš„ Publisherï¼›
    
- å®ƒä»¬éƒ½å®ç°äº† `Publisher<T>` æ¥å£ï¼Œå¹¶å…±äº« Reactor æä¾›çš„å¾ˆå¤šæ“ä½œç¬¦ï¼ˆæ¯”å¦‚ `map`ã€`flatMap`ã€`filter`ã€`doOnNext`ã€`onErrorResume` ç­‰ï¼‰ï¼Œ**æ‰€ä»¥ä½ ä¼šå‘ç°å¾ˆå¤šæ–¹æ³•â€œçœ‹èµ·æ¥ä¸€æ ·â€**ï¼›
    
- ä½†æ˜¯ï¼Œ**æŸäº›æ–¹æ³•åªå¯¹ `Flux` æœ‰æ„ä¹‰**ï¼Œæ¯”å¦‚å¤„ç†å¤šä¸ªå…ƒç´ ç›¸å…³çš„æ“ä½œï¼ˆ`take(n)`ã€`skip(n)`ã€`buffer(n)`ã€`window()` ç­‰ï¼‰ï¼Œè¿™äº›åœ¨ `Mono` ä¸Šå°±æ²¡å•¥ç”¨ã€‚
    

---

### âœ… å…±åŒæ–¹æ³•ï¼ˆMono å’Œ Flux éƒ½æœ‰ï¼‰

| æ–¹æ³•å                       | è¯´æ˜                          |
| ------------------------- | --------------------------- |
| `map(Function)`           | è½¬æ¢æµä¸­å…ƒç´                       |
| `flatMap(Function)`       | å¼‚æ­¥å±•å¼€å¦ä¸€ä¸ª Publisher           |
| `filter(Predicate)`       | è¿‡æ»¤å…ƒç´                         |
| `doOnNext(Consumer)`      | å…ƒç´ åˆ°è¾¾æ—¶æ‰§è¡Œæ“ä½œ                   |
| `onErrorResume(Function)` | å¼‚å¸¸å¤„ç†ï¼Œè¿”å›å¤‡ç”¨æµ                  |
| `defaultIfEmpty(T)`       | å¦‚æœä¸ºç©ºåˆ™æä¾›é»˜è®¤å€¼                  |
| `then()`                  | å¿½ç•¥å½“å‰æ•°æ®ï¼Œè½¬ä¸º `Mono<Void>` è§¦å‘æ‰§è¡Œ |
| `subscribe()`             | æ‰‹åŠ¨è§¦å‘è®¢é˜…ï¼ˆä¸€èˆ¬ç”¨äºé Web ç¯å¢ƒï¼‰        |

---

### âš ï¸ Flux ç‹¬æœ‰çš„æ–¹æ³•ï¼ˆMono æ²¡æœ‰æˆ–æ²¡æ„ä¹‰ï¼‰

|æ–¹æ³•å|è¯´æ˜|
|---|---|
|`take(n)`|åªå–å‰ n ä¸ªå…ƒç´ |
|`skip(n)`|è·³è¿‡å‰ n ä¸ªå…ƒç´ |
|`buffer(n)`|å°†å…ƒç´ åˆ†ç»„ä¸º List|
|`window(n)`|æŠŠå…ƒç´ æ‰“åŒ…æˆå¤šä¸ª Flux|
|`concatWith(Publisher)`|ä¸²è”å¤šä¸ª Publisher|
|`mergeWith(Publisher)`|åˆå¹¶å¤šä¸ªæµ|
|`zipWith(Publisher)`|å°†ä¸¤ä¸ªæµç»„åˆæˆä¸€ä¸ªæ–°çš„æµ|
|`groupBy(Function)`|æ ¹æ® key åˆ†ç»„|

è¿™äº›æ–¹æ³•è¦å¤„ç†å¤šä¸ªå…ƒç´ æ‰æœ‰æ„ä¹‰ï¼Œè€Œ `Mono` æœ€å¤šå°±ä¸€ä¸ªï¼Œæ‰€ä»¥ä¸æ”¯æŒæˆ–ä¸æ¨èã€‚

---

### ğŸ§  ä¸¾ä¸ªä¾‹å­è¯´æ˜å·®å¼‚

#### Mono ä½¿ç”¨ `map`ï¼š

```java
Mono<String> mono = Mono.just("hello")
                        .map(s -> s.toUpperCase()); // -> "HELLO"
```

#### Flux ä½¿ç”¨ `buffer`ï¼š

```java
Flux<Integer> flux = Flux.range(1, 10)
                         .buffer(3); // -> Flux<List<Integer>>ï¼Œæ¯3ä¸ªå…ƒç´ åˆ†ä¸€ç»„

flux.subscribe(System.out::println); 
// è¾“å‡ºï¼š[1,2,3], [4,5,6], [7,8,9], [10]
```

ä½ æƒ³æƒ³ï¼š`Mono.buffer(3)` æ˜¯ä¸æ˜¯å¾ˆæ²¡æ„ä¹‰ï¼Ÿå®ƒåªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œæ²¡å¾—åˆ†ç»„ã€‚

---

### ğŸ‘€ ç‰¹åˆ«æ³¨æ„ï¼š

æŸäº›æ–¹æ³•åœ¨ Mono ä¸Šå…¶å®ä¹Ÿæœ‰å®ç°ï¼Œä½†è¯­ä¹‰è¢«â€œé‡æ–°å®šä¹‰â€äº†ã€‚ä¾‹å¦‚ï¼š

```java
Mono.just("A").zipWith(Mono.just("B")) // åˆå¹¶ä¸¤ä¸ª Monoï¼Œå˜æˆ Mono<Tuple2<A, B>>
```

å®ƒä¹Ÿèƒ½â€œzipâ€ï¼Œä½†æ˜¯è¿”å›ä¸€ä¸ªå€¼è€Œä¸æ˜¯æµã€‚

---

### æ€»ç»“ä¸€å¥è¯ï¼š

> **Mono å’Œ Flux æ˜¯äº²å…„å¼Ÿï¼Œå…±ç”¨å¤§éƒ¨åˆ†æ–¹æ³•ï¼›ä½† Flux ä¸“é—¨å¤„ç†å¤šå…ƒç´ æµï¼Œæ‰€ä»¥è¿˜æœ‰ä¸€æ‰¹ Mono ç”¨ä¸ä¸Šçš„æ–¹æ³•ã€‚**

å¦‚æœä½ ç»å¸¸åˆ‡æ¢ Mono å’Œ Flux çš„ä½¿ç”¨ï¼Œè¦ç‰¹åˆ«æ³¨æ„è¿™äº›â€œåªé€‚ç”¨äºå¤šå…ƒç´ â€çš„æ“ä½œç¬¦ã€‚

éœ€è¦æˆ‘ç»™ä½ åˆ—ä¸€å¼ è¡¨æ ¼å¯¹ç…§å“ªäº›æ–¹æ³•åœ¨å“ªä¸ªç±»å‹ä¸Šæœ‰æˆ–æ²¡æœ‰ï¼Ÿ










# äºŒã€å®æ“


















## Spring WebFluxå…¨é¢ä½¿ç”¨æŒ‡å—ï¼šä»å…¥é—¨åˆ°ç²¾é€š

### ä¸€ã€Spring WebFluxæ ¸å¿ƒæ¦‚å¿µä¸ç‰¹æ€§

Spring WebFluxæ˜¯Springæ¡†æ¶å¯¹å“åº”å¼ç¼–ç¨‹çš„æ”¯æŒå®ç°ï¼Œå®ƒåŸºäºReactoråº“å®ç°äº†Reactive Streamsè§„èŒƒï¼Œæ”¯æŒéé˜»å¡å¼‚æ­¥ç¼–ç¨‹ã€‚

WebFluxçš„å“åº”å¼ç¼–ç¨‹æ¨¡å‹é€šè¿‡`Flux`å’Œ`Mono`ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶æ¥ç®¡ç†å¼‚æ­¥æ•°æ®æµï¼Œå…¶ä¸­`Flux`è¡¨ç¤ºåŒ…å«0åˆ°å¤šä¸ªå…ƒç´ çš„å¼‚æ­¥åºåˆ—ï¼Œ`Mono`è¡¨ç¤ºåŒ…å«0æˆ–1ä¸ªå…ƒç´ çš„å¼‚æ­¥åºåˆ—ã€‚è¿™ç§è®¾è®¡ä½¿å¾—åº”ç”¨èƒ½å¤Ÿåœ¨å¤„ç†å¤§é‡å¹¶å‘è¯·æ±‚æ—¶ä¿æŒä½å†…å­˜å ç”¨ï¼Œé¿å…çº¿ç¨‹é˜»å¡å¯¼è‡´çš„æ€§èƒ½é—®é¢˜ã€‚

èƒŒå‹æœºåˆ¶æ˜¯WebFluxçš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ï¼Œå®ƒå…è®¸ä¸‹æ¸¸æ¶ˆè´¹è€…æ§åˆ¶ä¸Šæ¸¸ç”Ÿäº§è€…çš„æ•°æ®æµé€Ÿï¼Œé˜²æ­¢èµ„æºè€—å°½ã€‚èƒŒå‹é€šè¿‡`SubmissionPublisher`å’Œ`Flow.Subscription`å®ç°ï¼Œè®¢é˜…è€…å¯ä»¥é€šçŸ¥å‘å¸ƒè€…å½“å‰å¯å¤„ç†çš„æ•°æ®é‡ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥é€šè¿‡`limitRate()`è¿ç®—ç¬¦é™åˆ¶é¢„å–æ•°æ®é‡ï¼Œæˆ–è€…ä½¿ç”¨`onBackpressureBuffer()`è‡ªå®šä¹‰ç¼“å†²åŒºç­–ç•¥å’Œæº¢å‡ºå¤„ç†æ–¹å¼ã€‚è¿™ç§æœºåˆ¶ç¡®ä¿åœ¨é«˜è´Ÿè½½æƒ…å†µä¸‹ï¼Œåº”ç”¨å¯ä»¥ä½¿ç”¨å›ºå®šçš„çº¿ç¨‹æ•°å’Œæœ‰é™çš„å†…å­˜èµ„æºæ¥å¤„ç†è¯·æ±‚ï¼Œé¿å…äº†ä¼ ç»ŸWebæ¡†æ¶å¸¸è§çš„çº¿ç¨‹æ± è€—å°½é—®é¢˜ã€‚

WebFluxæ”¯æŒå¤šç§WebæœåŠ¡å™¨ï¼ŒåŒ…æ‹¬Servletå®¹å™¨ï¼ˆå¦‚Tomcat 9.0+ï¼‰å’Œéé˜»å¡æœåŠ¡å™¨ï¼ˆå¦‚Nettyã€Undertowï¼‰ï¼Œå¹¶èƒ½å¤Ÿä¸HTTP/2åè®®æ— ç¼é›†æˆã€‚åœ¨æ€§èƒ½æ–¹é¢ï¼ŒWebFluxåŸºäºNettyçš„äº‹ä»¶å¾ªç¯æ¨¡å‹ï¼Œç›¸æ¯”Tomcatçš„çº¿ç¨‹é˜»å¡æ¨¡å‹ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹è¡¨ç°å‡ºè‰²ã€‚ä¾‹å¦‚ï¼Œå½“å¹¶å‘ç”¨æˆ·è¾¾åˆ°1000æ—¶ï¼ŒWebFluxçš„99%è¯·æ±‚å“åº”æ—¶é—´ä»èƒ½ä¿æŒåœ¨150msä»¥å†…ï¼Œè€Œä¼ ç»ŸSpring MVCçš„å“åº”æ—¶é—´å¯èƒ½é£™å‡è‡³500msä»¥ä¸Šï¼Œç”šè‡³å‡ºç°1000msçš„æç«¯æƒ…å†µã€‚

### äºŒã€ä¸¤ç§ç¼–ç¨‹æ¨¡å‹ï¼šæ³¨è§£æ§åˆ¶å™¨ä¸å‡½æ•°å¼ç«¯ç‚¹

WebFluxæä¾›äº†ä¸¤ç§ä¸»è¦çš„ç¼–ç¨‹æ¨¡å‹ï¼Œä»¥æ»¡è¶³ä¸åŒåœºæ™¯ä¸‹çš„å¼€å‘éœ€æ±‚ã€‚

**æ³¨è§£æ§åˆ¶å™¨æ¨¡å‹**ä¸ä¼ ç»Ÿçš„Spring MVCéå¸¸ç›¸ä¼¼ï¼Œå¼€å‘è€…å¯ä»¥ä½¿ç”¨ç†Ÿæ‚‰çš„`@RestController`ã€`@GetMapping`ç­‰æ³¨è§£æ¥å®šä¹‰æ§åˆ¶å™¨å’Œå¤„ç†æ–¹æ³•ã€‚ä¸»è¦åŒºåˆ«åœ¨äºè¿”å›ç±»å‹å¿…é¡»æ˜¯å“åº”å¼ç±»å‹ï¼ˆå¦‚`Mono`æˆ–`Flux`ï¼‰ï¼Œä»¥ä¿æŒéé˜»å¡å’Œå“åº”å¼çš„è¡Œä¸ºã€‚è¿™ç§æ¨¡å‹ç‰¹åˆ«é€‚åˆç†Ÿæ‚‰Spring MVCçš„å¼€å‘è€…ï¼Œæˆ–è€…éœ€è¦å¤„ç†å¤æ‚ä¸šåŠ¡é€»è¾‘çš„åœºæ™¯ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„æ³¨è§£æ§åˆ¶å™¨ç¤ºä¾‹ï¼š

```
@RestController
@RequestMapping("/users")
public class UserController {
    @Autowired
    private UserService userService;

    @GetMapping("/{id}")
    public Mono<User> getUserById(@PathVariable String id) {
        return userService.getUserById(id);
    }

    @GetMapping
    public Flux<User> getAllUsers() {
        return userService.getAllUsers();
    }
}
```

**å‡½æ•°å¼ç«¯ç‚¹æ¨¡å‹**åˆ™é‡‡ç”¨æ›´è½»é‡çº§çš„å‡½æ•°å¼ç¼–ç¨‹é£æ ¼ï¼Œé€šè¿‡`RouterFunction`å’Œ`HandlerFunction`æ¥å®šä¹‰è·¯ç”±å’Œå¤„ç†é€»è¾‘ã€‚è¿™ç§æ¨¡å‹å¼ºè°ƒä¸å˜æ€§å’Œå£°æ˜å¼ç¼–ç¨‹ï¼Œå‡å°‘äº†æ ·æ¿ä»£ç ï¼Œæ›´é€‚åˆæ„å»ºè½»é‡çº§APIæˆ–äº‹ä»¶æµåº”ç”¨ã€‚å‡½æ•°å¼æ¨¡å‹çš„é…ç½®é€šå¸¸åœ¨é…ç½®ç±»ä¸­å®Œæˆï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```
@Configuration
public class RouteConfig {
    @Bean
    public RouterFunction<ServerResponse> route(ExampleHandler handler) {
        return RouterFunctions.route()
                .GET("/user/{id}", accept(APPLICATION_JSON), handler::specificUser)
                .GET("/user", accept(APPLICATION_JSON), handler::allUsers)
                .build();
    }
}
```

åœ¨ä¸¤ç§æ¨¡å‹çš„å¯¹æ¯”ä¸­ï¼Œæ³¨è§£æ¨¡å‹çš„ä¼˜åŠ¿åœ¨äºä»£ç ç»“æ„ç›´è§‚ã€æ˜“äºç†è§£ï¼Œä¸”ä¸ä¼ ç»ŸSpring MVCå…¼å®¹æ€§å¥½ï¼›è€Œå‡½æ•°å¼æ¨¡å‹åˆ™æ›´åŠ ç®€æ´ã€å£°æ˜å¼ï¼Œé€‚åˆé…ç½®é©±åŠ¨å‹åº”ç”¨ï¼ˆå¦‚APIç½‘å…³ï¼‰å’Œè½»é‡çº§æœåŠ¡ã€‚ç„¶è€Œï¼Œéšç€è·¯ç”±å¤æ‚åº¦å¢åŠ ï¼Œå‡½æ•°å¼æ¨¡å‹çš„ç»´æŠ¤æˆæœ¬å¯èƒ½é«˜äºæ³¨è§£æ¨¡å‹ã€‚**é€‰æ‹©å“ªç§æ¨¡å‹å–å†³äºå›¢é˜Ÿç†Ÿæ‚‰ç¨‹åº¦ã€é¡¹ç›®è§„æ¨¡å’Œå…·ä½“éœ€æ±‚**ï¼Œä¸¤è€…åœ¨åº•å±‚éƒ½æ˜¯åŸºäºç›¸åŒçš„å“åº”å¼åŸºç¡€æ„å»ºçš„ã€‚




### ä¸‰ã€é«˜å¹¶å‘åœºæ™¯ä¸‹çš„WebFluxåº”ç”¨

åœ¨é«˜å¹¶å‘åœºæ™¯ä¸­ï¼ŒWebFluxçš„éé˜»å¡æ¶æ„å±•ç°å‡ºæ˜¾è‘—ä¼˜åŠ¿ã€‚åŸºäºNettyçš„äº‹ä»¶å¾ªç¯æ¨¡å‹ï¼ŒWebFluxèƒ½å¤Ÿé€šè¿‡å°‘é‡çº¿ç¨‹å¤„ç†å¤§é‡å¹¶å‘è¯·æ±‚ï¼Œé¿å…äº†ä¼ ç»ŸSpring MVCä¸­æ¯ä¸ªè¯·æ±‚å ç”¨ä¸€ä¸ªçº¿ç¨‹çš„èµ„æºæµªè´¹ã€‚ä¾‹å¦‚ï¼Œåœ¨å®æ—¶é£æ§ç³»ç»Ÿä¸­ï¼Œé€šè¿‡é“¾å¼å“åº”å¼æµå¤„ç†ï¼ŒWebFluxèƒ½å¤Ÿå®ç°ä½å»¶è¿Ÿçš„è¯·æ±‚å“åº”ã€‚

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä¸€ä¸ªWebFluxåº”ç”¨åœ¨4æ ¸8Gçš„ç¯å¢ƒä¸­å¯ä»¥è½»æ¾å¤„ç†5ä¸‡ä»¥ä¸Šçš„å¹¶å‘è¿æ¥ï¼Œè¿œè¶…ä¼ ç»ŸSpring MVCåŸºäºTomcatçš„æ¶æ„ã€‚ä¸‹è¡¨å±•ç¤ºäº†ä¸åŒæœåŠ¡å™¨åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ€§èƒ½å¯¹æ¯”ï¼š

| æœåŠ¡å™¨ | è¯·æ±‚å¤„ç†æ¨¡å‹ | æœ€å¤§è¿æ¥æ•°ï¼ˆ4C8Gï¼‰ |
|--------|--------------|-------------------|
| Tomcat | BIO/NIO      | çº¦5000            |
| Netty  | EventLoop    | çº¦50000           |
| Undertow | XNIO Worker | çº¦30000           |

ä¸ºäº†æœ€å¤§åŒ–WebFluxçš„å¹¶å‘å¤„ç†èƒ½åŠ›ï¼Œå¼€å‘è€…å¯ä»¥é‡‡å–ä»¥ä¸‹ä¼˜åŒ–ç­–ç•¥ï¼š
1. ä½¿ç”¨`SubmissionPublisher`å®ç°èƒŒå‹æ§åˆ¶ï¼Œç¡®ä¿ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…çš„é€Ÿç‡åŒ¹é…
2. åˆç†é…ç½®Nettyçº¿ç¨‹æ± ï¼ˆå¦‚`spring.netty.threads=8`ï¼‰ï¼Œæ ¹æ®ç³»ç»Ÿèµ„æºè°ƒæ•´çº¿ç¨‹æ•°é‡
3. é€‰æ‹©åˆé€‚çš„è°ƒåº¦å™¨ï¼ˆ`Schedulers.boundedElastic()`ç”¨äºI/Oå¯†é›†å‹æ“ä½œï¼Œ`Schedulers.parallel()`ç”¨äºCPUå¯†é›†å‹ä»»åŠ¡ï¼‰
4. é¿å…é˜»å¡æ“ä½œï¼Œç¡®ä¿æ‰€æœ‰å¤„ç†ç¯èŠ‚éƒ½æ˜¯éé˜»å¡çš„

æ­¤å¤–ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå†…å­˜æ³„æ¼å’Œæ— é™æµé—®é¢˜éœ€è¦ç‰¹åˆ«å…³æ³¨ã€‚é€šè¿‡`Hooks.onOperatorDebug()`å¢å¼ºæ—¥å¿—è®°å½•ï¼Œä½¿ç”¨`Flux.using()`ç®¡ç†èµ„æºç”Ÿå‘½å‘¨æœŸï¼Œä¸ºæ‰€æœ‰æ— é™æµæ·»åŠ `take()`æˆ–`timeout()`é™åˆ¶ï¼Œå¯ä»¥æœ‰æ•ˆé˜²æ­¢è¿™äº›é—®é¢˜ã€‚

### å››ã€IOå¯†é›†å‹ä»»åŠ¡çš„å“åº”å¼å¤„ç†

å¯¹äºI/Oå¯†é›†å‹ä»»åŠ¡ï¼ŒWebFluxçš„å“åº”å¼ç¼–ç¨‹æ¨¡å‹æä¾›äº†å¼ºå¤§çš„æ”¯æŒï¼Œä½¿å¾—å¼€å‘è€…èƒ½å¤Ÿæ›´é«˜æ•ˆåœ°å¤„ç†æ•°æ®åº“æŸ¥è¯¢ã€æ–‡ä»¶è¯»å†™å’Œå¤–éƒ¨APIè°ƒç”¨ç­‰æ“ä½œã€‚

**æ•°æ®åº“è®¿é—®**æ–¹é¢ï¼ŒWebFluxä¸Spring Data R2DBCç´§å¯†é›†æˆï¼Œå…è®¸å¼€å‘è€…ä½¿ç”¨å“åº”å¼æ•°æ®è®¿é—®åº“è¿›è¡Œéé˜»å¡æŸ¥è¯¢ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡R2dbcEntityTemplateå®ç°å¼‚æ­¥æŸ¥è¯¢ï¼š

```
@Service
public class UserService {
    private final R2dbcEntityTemplate r2dbcEntityTemplate;

    public UserService(R2dbcEntityTemplate r2dbcEntityTemplate) {
        this.r2dbcEntityTemplate = r2dbcEntityTemplate;
    }

    public Mono<User> getUserByEmail(String email) {
        return r2dbcEntityTemplate.select(
                Query.query(Criteria.where("email").is(email)),
                User.class
        ).singleOrEmpty();
    }
}
```

**å¤–éƒ¨APIè°ƒç”¨**åˆ™é€šè¿‡WebClientå®ç°ï¼Œæ”¯æŒéé˜»å¡ã€å¼‚æ­¥çš„HTTPè¯·æ±‚ã€‚WebClientç›¸æ¯”ä¼ ç»Ÿçš„RestTemplateå…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š
- éé˜»å¡I/Oï¼Œé€‚ç”¨äºé«˜å¹¶å‘åœºæ™¯
- å‡½æ•°å¼APIé£æ ¼ï¼Œä»£ç æ›´ç®€æ´
- æ›´å¥½åœ°æ”¯æŒæµå¼ä¼ è¾“
- æ”¹è¿›çš„é”™è¯¯å¤„ç†æœºåˆ¶

ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨WebClientè°ƒç”¨å¤–éƒ¨APIçš„ç¤ºä¾‹ï¼š

```
@Bean
public WebClient webClient(WebClient.Builder builder) {
    return builder.baseUrl("https://api.example.com")
            .defaultHeader("Authorization", "Bearer your-token")
            .exchangeStrategies(ExchangeStrategies.builder()
                    .codecs(configurer -> configurer.defaultCodecs()
                            .maxInMemorySize(16 * 1024 * 1024)) // è®¾ç½®æœ€å¤§å†…å­˜é™åˆ¶ä¸º16MB
                    .build())
            .build();
}

@Service
public class ApiService {
    private final WebClient webClient;

    public ApiService(WebClient webClient) {
        this.webClient = webClient;
    }

    public Mono<ApiResultDTO> fetchData() {
        return webClient.get()
                .uri("/data")
                .retrieve()
                .bodyToMono(ApiResultDTO.class)
                .timeout(Duration.ofSeconds(60));
    }
}
```

**æ–‡ä»¶å¤„ç†**åœºæ™¯ä¸‹ï¼ŒWebFluxæ”¯æŒæµå¼è¯»å†™ï¼Œå‡å°‘å†…å­˜å ç”¨ã€‚ä¾‹å¦‚ï¼Œå¤„ç†å¤§æ–‡ä»¶æ—¶å¯ä»¥é€šè¿‡`Flux.from()`å°†æ–‡ä»¶å†…å®¹åˆ†å‰²ä¸ºæ•°æ®å—ï¼Œé€æ­¥å¤„ç†ï¼š

```
@GetMapping("/file")
public Flux<DataBuffer> downloadFile() {
    return Flux.from(
            DataBufferUtils.read(
                    new ClassPathResource("largefile.txt"),
                    bufferFactory,
                    1024
            )
    );
}
```

è¿™ç§æµå¼å¤„ç†æ–¹å¼ç‰¹åˆ«é€‚åˆå¤„ç†å¤§æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½æˆ–å®æ—¶æ•°æ®æµï¼Œç›¸æ¯”ä¼ ç»ŸåŒæ­¥æ–¹å¼ï¼Œæ˜¾è‘—æé«˜äº†èµ„æºåˆ©ç”¨ç‡ã€‚

### äº”ã€å¾®æœåŠ¡æ¶æ„ä¸­çš„WebFluxé›†æˆ

åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒWebFluxèƒ½å¤Ÿä¸Spring Cloudç”Ÿæ€æ— ç¼é›†æˆï¼Œæä¾›é«˜æ•ˆçš„æœåŠ¡å‘ç°ã€é€šä¿¡å’Œæ²»ç†èƒ½åŠ›ã€‚

**æœåŠ¡ç½‘å…³**æ–¹é¢ï¼ŒSpring Cloud Gatewayæ˜¯å®˜æ–¹æ¨èçš„APIç½‘å…³è§£å†³æ–¹æ¡ˆï¼Œå®ƒåŸºäºWebFluxå’ŒReactoræ„å»ºï¼Œæ”¯æŒåŠ¨æ€è·¯ç”±ã€è°“è¯åŒ¹é…å’Œè¿‡æ»¤å™¨é“¾ã€‚ä»¥ä¸‹æ˜¯Spring Cloud Gatewayçš„è·¯ç”±é…ç½®ç¤ºä¾‹ï¼š

```
spring:
  cloud:
    gateway:
      routes:
        - id: my-first-route
          uri: lb://user-service
          predicates:
            - Path=/users/**
          filters:
            - AddRequestHeader=X-Request-Foo, Bar
            - CircuitBreaker=service-name
```

æ­¤é…ç½®å°†æ‰€æœ‰ä»¥`/users/`å¼€å¤´çš„è¯·æ±‚è·¯ç”±åˆ°è´Ÿè½½å‡è¡¡çš„`user-service`å®ä¾‹ï¼Œå¹¶æ·»åŠ è‡ªå®šä¹‰è¯·æ±‚å¤´å’Œç†”æ–­ä¿æŠ¤ã€‚ç›¸æ¯”ä¼ ç»Ÿçš„Zuulç½‘å…³ï¼ŒSpring Cloud GatewayåŸºäºWebFluxçš„éé˜»å¡æ¶æ„ï¼Œæä¾›äº†æ›´é«˜çš„æ€§èƒ½å’Œååé‡ã€‚

**æœåŠ¡é€šä¿¡**ä¸­ï¼ŒWebClientæ›¿ä»£äº†ä¼ ç»Ÿçš„RestTemplateï¼Œæ”¯æŒéé˜»å¡ã€å¼‚æ­¥çš„æœåŠ¡é—´è°ƒç”¨ã€‚ä¸Spring Cloud LoadBalancerç»“åˆæ—¶ï¼ŒWebClientèƒ½å¤Ÿè‡ªåŠ¨è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼š

```
@Bean
@LoadBalanced
public WebClient.Builder webClientBuilder() {
    return WebClient.builder();
}

@Service
public class OrderService {
    private final WebClient.Builder webClientBuilder;

    public OrderService(WebClient.Builder webClientBuilder) {
        this.webClientBuilder = webClientBuilder;
    }

    public Mono<String> fetchUser(String userId) {
        return webClientBuilder.build()
                .get()
                .uri("http://user-service/users/{id}", userId)
                .retrieve()
                .bodyToMono(String.class);
    }
}
```

**ç†”æ–­ä¸å®¹é”™**æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­çš„é‡è¦æœºåˆ¶ã€‚é€šè¿‡Resilience4jä¸WebFluxçš„é›†æˆï¼Œå¯ä»¥å®ç°æœåŠ¡è°ƒç”¨çš„ç†”æ–­ã€é‡è¯•å’Œé™æµã€‚ä»¥ä¸‹æ˜¯WebClientä¸Resilience4jçš„ç†”æ–­é›†æˆç¤ºä¾‹ï¼š

```
Mono.fromWebClient()
    .transformDeferred(CircuitBreakerOperator.of("service-name"))
    .onErrorResume(ex -> Mono.error(new CustomException()))
```

æ­¤ä»£ç ç‰‡æ®µå±•ç¤ºäº†å¦‚ä½•ä¸ºWebClientè¯·æ±‚æ·»åŠ ç†”æ–­ä¿æŠ¤ï¼Œå¹¶åœ¨å‘ç”Ÿé”™è¯¯æ—¶è¿›è¡Œæ¢å¤å¤„ç†ã€‚ç†”æ–­å™¨ä¼šæ ¹æ®é…ç½®çš„é˜ˆå€¼è‡ªåŠ¨åˆ‡æ¢çŠ¶æ€ï¼Œæä¾›å¼ºå¤§çš„å®¹é”™èƒ½åŠ›ã€‚

### å…­ã€SSEå®ç°ä¸äº‹ä»¶æµå¤„ç†

æœåŠ¡å™¨å‘é€äº‹ä»¶ï¼ˆServer-Sent Eventsï¼ŒSSEï¼‰æ˜¯ä¸€ç§å•å‘é€šä¿¡æœºåˆ¶ï¼Œå…è®¸æœåŠ¡å™¨å‘å®¢æˆ·ç«¯æ¨é€å®æ—¶æ•°æ®æµã€‚WebFluxæä¾›äº†SSEçš„è‡ªç„¶æ”¯æŒï¼Œèƒ½å¤Ÿè½»æ¾å®ç°ä½å»¶è¿Ÿçš„å®æ—¶æ•°æ®æ¨é€ã€‚

åœ¨**å‡½æ•°å¼æ¨¡å‹**ä¸­ï¼ŒSSEå¯ä»¥é€šè¿‡`RouterFunction`è¿”å›`Flux<String>`å®ç°ï¼ŒSpringä¼šè‡ªåŠ¨å°†å…¶è½¬æ¢ä¸ºäº‹ä»¶æµï¼š

```
@Bean
public RouterFunction<ServerResponse> route(ExampleHandler handler) {
    return RouterFunctions.route()
            .GET("/sse", handler::simpleSse)
            .build();
}

public Flux<String> simpleSse() {
    return Flux.interval(Duration.ofSeconds(1))
            .map(sequence -> "Current time: " + LocalTime.now());
}
```

åœ¨**æ³¨è§£æ¨¡å‹**ä¸­ï¼ŒSSEåˆ™é€šè¿‡`@GetMapping`è¿”å›`Flux<ServerSentEvent<T>>`å®ç°ï¼š

```
@GetMapping("/sse/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
public Flux<ServerSentEvent<String>> streamWithPing() {
    return Flux.interval(Duration.ofSeconds(1))
            .map(sequence -> {
                if (sequence % 5 == 0) {
                    // æ¯5ç§’å‘é€ä¸€æ¬¡å¿ƒè·³
                    return ServerSentEvent.builder()
                            .comment("ping")
                            .build();
                } else {
                    return ServerSentEvent.builder()
                            .data("Current time: " + LocalTime.now())
                            .build();
                }
            });
}
```

æ­¤ç¤ºä¾‹ä¸ä»…è¿”å›å®æ—¶æ—¶é—´ä¿¡æ¯ï¼Œè¿˜é€šè¿‡`comment()`æ–¹æ³•æ¯5ç§’å‘é€ä¸€æ¬¡å¿ƒè·³ï¼Œé˜²æ­¢SSEè¿æ¥å› é•¿æ—¶é—´æ— æ•°æ®ä¼ è¾“è€Œè¢«ä¸­æ–­ã€‚

SSEä¸WebSocketçš„ä¸»è¦åŒºåˆ«åœ¨äºï¼š
- SSEæ˜¯å•å‘é€šä¿¡ï¼Œä»…æ”¯æŒæœåŠ¡å™¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®
- SSEåŸºäºHTTPåè®®ï¼Œå®ç°ç®€å•
- WebSocketæ˜¯åŒå‘é€šä¿¡ï¼Œæ”¯æŒæ›´å¤æ‚çš„äº¤äº’åœºæ™¯

å¯¹äºéœ€è¦è½»é‡çº§å•å‘é€šä¿¡çš„åœºæ™¯ï¼Œå¦‚è‚¡ç¥¨ä»·æ ¼æ›´æ–°ã€ç³»ç»Ÿç›‘æ§æˆ–æ¨é€é€šçŸ¥ï¼ŒSSEæ˜¯Spring WebFluxçš„é¦–é€‰æ–¹æ¡ˆã€‚è€Œåœ¨éœ€è¦åŒå‘é€šä¿¡çš„åœºæ™¯ï¼Œå¦‚å®æ—¶èŠå¤©æˆ–åœ¨çº¿æ¸¸æˆï¼Œåˆ™å»ºè®®ä½¿ç”¨WebSocketã€‚

### ä¸ƒã€é”™è¯¯å¤„ç†æœºåˆ¶

WebFluxæä¾›äº†å¤šå±‚æ¬¡çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼ŒåŒ…æ‹¬å…¨å±€å¤„ç†ã€æ§åˆ¶å™¨å±‚å¤„ç†å’Œæ•°æ®æµå¤„ç†ã€‚

**å…¨å±€é”™è¯¯å¤„ç†**é€šè¿‡å®ç°`ErrorWebExceptionHandler`æ¥å£æ¥å®ç°ï¼Œå®ƒèƒ½å¤Ÿæ•è·åº”ç”¨ç¨‹åºä¸­æœªå¤„ç†çš„å¼‚å¸¸å¹¶æä¾›ç»Ÿä¸€çš„é”™è¯¯å“åº”ï¼š

```
@Configuration
public class GlobalErrorHandlerConfig {
    @Bean
    @Order(-2)
    public ErrorWebExceptionHandler globalErrorHandler() {
        return new GlobalErrorHandler();
    }

    private static class GlobalErrorHandler implements ErrorWebExceptionHandler {
        @Override
        public Mono<Void> handle(ServerWebExchange exchange, Throwable ex) {
            ServerRequest request = ServerRequest.create(exchange, HandlerStrategies.withDefaults().messageReaders());
            return renderErrorResponse(request, ex)
                    .flatMap(response -> response.writeTo(exchange, HandlerStrategies.withDefaults()));
        }

        private Mono<ServerResponse> renderErrorResponse(ServerRequest request, Throwable ex) {
            return ServerResponse.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .contentType(MediaType.APPLICATION_JSON)
                    .bodyValue(new ErrorResponse(ex.getMessage()));
        }
    }
}
```

æ­¤é…ç½®å°†æ‰€æœ‰æœªå¤„ç†çš„å¼‚å¸¸ç»Ÿä¸€è¿”å›500çŠ¶æ€ç çš„JSONé”™è¯¯å“åº”ã€‚

**æ•°æ®æµä¸­çš„é”™è¯¯å¤„ç†**åˆ™é€šè¿‡Reactoræä¾›çš„æ“ä½œç¬¦å®ç°ï¼Œå¦‚`onErrorResume`ã€`onErrorReturn`å’Œ`retry`ç­‰ã€‚ä¾‹å¦‚ï¼Œåœ¨å‡½æ•°å¼è·¯ç”±ä¸­ï¼š

```
public RouterFunction<ServerResponse> routes() {
    return RouterFunctions.route(RequestPredicates.GET("/example"), request -> 
            Mono.error(new RuntimeException("Something went wrong"))
                .onErrorResume(e -> ServerResponse.ok()
                        .contentType(APPLICATION_JSON)
                        .bodyValue("Error occurred"))
    );
}
```

æ­¤ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•åœ¨å‡½æ•°å¼è·¯ç”±ä¸­æ•è·ç‰¹å®šé”™è¯¯å¹¶è¿”å›è‡ªå®šä¹‰å“åº”ã€‚

**æ³¨è§£æ¨¡å‹ä¸­çš„é”™è¯¯å¤„ç†**å¯ä»¥é€šè¿‡`@ControllerAdvice`å®ç°ï¼Œè¿”å›å“åº”å¼ç±»å‹ï¼š

```
@ControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler(value = {ResponseStatusException.class})
    public Mono<ErrorResponse> handleResponseStatusException(ResponseStatusException ex) {
        return Mono.just(new ErrorResponse(ex.getStatusCode().value(), ex.getReason(), null));
    }

    @ExceptionHandler(value = {Exception.class})
    public Mono<ErrorResponse> handleException(Exception ex) {
        return Mono.just(new ErrorResponse(HttpStatus.INTERNAL_SERVER_ERROR.value(), "Internal Server Error", ExceptionUtils.getStackTrace(ex)));
    }
}
```

æ­¤é…ç½®èƒ½å¤Ÿæ•è·ä¸åŒç±»å‹çš„å¼‚å¸¸å¹¶è¿”å›ç›¸åº”çš„é”™è¯¯å“åº”ï¼Œé€‚ç”¨äºéœ€è¦ç»Ÿä¸€é”™è¯¯å¤„ç†é€»è¾‘çš„åœºæ™¯ã€‚

### å…«ã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

ä¸ºäº†å……åˆ†å‘æŒ¥WebFluxçš„æ€§èƒ½ä¼˜åŠ¿ï¼Œå¼€å‘è€…éœ€è¦é‡‡å–ä¸€ç³»åˆ—ä¼˜åŒ–ç­–ç•¥ã€‚

**èƒŒå‹ä¼˜åŒ–**æ˜¯å“åº”å¼åº”ç”¨çš„å…³é”®ã€‚é»˜è®¤ç¼“å†²åŒºå¤§å°ä¸º256ï¼Œå¯èƒ½ä¸é€‚åˆæ‰€æœ‰åœºæ™¯ï¼Œå¯ä»¥æ ¹æ®æ•°æ®ç‰¹å¾è°ƒæ•´ï¼š

```
Flux.range(1, 1000)
    .onBackpressureBuffer(500, BufferOverflowStrategy.DROP_OLDEST)
    .subscribe(...);
```

æ­¤ä»£ç ç‰‡æ®µå±•ç¤ºäº†å¦‚ä½•ä¸ºFluxæ•°æ®æµè®¾ç½®è‡ªå®šä¹‰ç¼“å†²åŒºå¤§å°å’Œæº¢å‡ºç­–ç•¥ï¼Œé˜²æ­¢ä¸‹æ¸¸æ¶ˆè´¹è€…è¢«ä¸Šæ¸¸ç”Ÿäº§è€…çš„æ•°æ®æ·¹æ²¡ã€‚

**è°ƒåº¦å™¨é…ç½®**å¯¹äºä¼˜åŒ–èµ„æºåˆ©ç”¨ç‡è‡³å…³é‡è¦ã€‚WebFluxæä¾›äº†å¤šç§è°ƒåº¦å™¨ç±»å‹ï¼Œé€‚ç”¨äºä¸åŒåœºæ™¯ï¼š

| è°ƒåº¦å™¨ç±»å‹ | é€‚ç”¨åœºæ™¯ | é…ç½®å»ºè®® |
|------------|----------|----------|
| parallel() | CPUå¯†é›†å‹ä»»åŠ¡ | æ ¸æ•°+1 |
| boundedElastic() | é˜»å¡I/Oæ“ä½œ | æ ¹æ®IOç­‰å¾…æ—¶é—´è°ƒæ•´ |
| single() | ä¸¥æ ¼é¡ºåºè¦æ±‚ | å•ä¸ªçº¿ç¨‹ |

å¯¹äºéœ€è¦å¤„ç†é˜»å¡æ“ä½œçš„åœºæ™¯ï¼ˆå¦‚åŒæ­¥æ•°æ®åº“è°ƒç”¨ï¼‰ï¼Œåº”ä½¿ç”¨`boundedElastic()`è°ƒåº¦å™¨ï¼š

```
Mono.fromCallable(() -> {
    try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {
        return executor.submit(() -> computeIntensiveTask()).get();
    }
})
.subscribeOn(Schedulers.boundedElastic())
```

æ­¤ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•ç»“åˆJava 21çš„è™šæ‹Ÿçº¿ç¨‹å’ŒWebFluxçš„è°ƒåº¦å™¨ä¼˜åŒ–CPUå¯†é›†å‹ä»»åŠ¡çš„å¤„ç†ã€‚

**WebClientä¼˜åŒ–**åŒ…æ‹¬è¿æ¥æ± é…ç½®å’Œè¶…æ—¶è®¾ç½®ï¼š

```
ConnectionProvider provider = ConnectionProvider.builder("custom")
        .maxConnections(100)
        .pendingAcquireTimeout(Duration.ofSeconds(30))
        .build();

WebClient webClient = WebClient.builder()
        .exchangeStrategies(ExchangeStrategies.builder()
                .codecs(configurer -> configurer.defaultCodecs()
                        .maxInMemorySize(16 * 1024 * 1024)) // è®¾ç½®æœ€å¤§å†…å­˜é™åˆ¶ä¸º16MB
        .build())
        .build();
```

è¿™äº›é…ç½®ä¼˜åŒ–äº†è¿æ¥æ± çš„å¤§å°å’Œç­‰å¾…è¶…æ—¶æ—¶é—´ï¼Œæé«˜äº†WebClientçš„èµ„æºåˆ©ç”¨ç‡å’Œå“åº”é€Ÿåº¦ã€‚

### ä¹ã€ä»å…¥é—¨åˆ°ç²¾é€šçš„å­¦ä¹ è·¯å¾„

ä¸ºäº†å…¨é¢æŒæ¡Spring WebFluxï¼Œå»ºè®®éµå¾ªä»¥ä¸‹å­¦ä¹ è·¯å¾„ï¼š

**å…¥é—¨é˜¶æ®µ**ï¼ˆ1-2å‘¨ï¼‰ï¼š
1. ç†è§£å“åº”å¼ç¼–ç¨‹çš„åŸºæœ¬æ¦‚å¿µå’ŒReactive Streamsè§„èŒƒ
2. å­¦ä¹ Spring WebFluxçš„ä¸¤ç§ç¼–ç¨‹æ¨¡å‹åŠå…¶æ ¸å¿ƒç»„ä»¶ï¼ˆFlux/Monoï¼‰
3. æŒæ¡åŸºç¡€è·¯ç”±é…ç½®å’Œç®€å•æ•°æ®æµå¤„ç†
4. ç†Ÿæ‚‰WebFluxä¸ä¼ ç»ŸSpring MVCçš„åŒºåˆ«å’Œä¼˜åŠ¿

**è¿›é˜¶é˜¶æ®µ**ï¼ˆ2-4å‘¨ï¼‰ï¼š
1. æ·±å…¥ç†è§£èƒŒå‹æœºåˆ¶åŠå…¶åœ¨å®é™…åº”ç”¨ä¸­çš„é…ç½®å’Œä¼˜åŒ–
2. å­¦ä¹ ä¸Spring Data R2DBCã€Spring Cloud Gatewayç­‰ç”Ÿæ€ç»„ä»¶çš„é›†æˆ
3. æŒæ¡SSEã€WebClientç­‰é«˜çº§ç‰¹æ€§å®ç°
4. ç†è§£é”™è¯¯å¤„ç†æœºåˆ¶å’Œå“åº”å¼æµä¸­çš„å¼‚å¸¸ä¼ é€’

**ç²¾é€šé˜¶æ®µ**ï¼ˆ4-8å‘¨ï¼‰ï¼š
1. ç ”ç©¶æ€§èƒ½è°ƒä¼˜ç­–ç•¥ï¼ŒåŒ…æ‹¬çº¿ç¨‹æ¨¡å‹ä¼˜åŒ–ã€èƒŒå‹é…ç½®å’Œå†…å­˜ç®¡ç†
2. æ¢ç´¢ä¸Spring Securityã€Spring Cloud Circuit Breakerç­‰ç»„ä»¶çš„æ·±åº¦é›†æˆ
3. å­¦ä¹ å“åº”å¼æµçš„é«˜çº§æ“ä½œç¬¦å’Œç»„åˆæ¨¡å¼
4. å®è·µå¤æ‚åº”ç”¨åœºæ™¯ï¼Œå¦‚å®æ—¶æ•°æ®å¤„ç†ã€å¾®æœåŠ¡ç½‘å…³å’Œå¤§è§„æ¨¡å¹¶å‘ç³»ç»Ÿ

**å­¦ä¹ èµ„æºæ¨è**ï¼š
- å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.spring.io/spring/docs/current/reference/html/web-reactive.html
- Spring Guidesï¼šhttps://spring.io/guides
- Baeldungæ•™ç¨‹ï¼šhttps://www.baeldung.com/spring-webflux
- ä¹¦ç±ï¼šã€ŠSpring in Action, Sixth Editionã€‹ï¼ˆæ¶µç›–WebFluxç›¸å…³å†…å®¹ï¼‰

### åã€æœªæ¥å‘å±•è¶‹åŠ¿ä¸æŠ€æœ¯å±•æœ›

éšç€Javaç”Ÿæ€çš„ä¸æ–­æ¼”è¿›ï¼ŒSpring WebFluxä¹Ÿå°†æŒç»­å‘å±•ã€‚Spring Framework 7.0å¼•å…¥äº†JSpecifyçš„ç©ºå€¼å®‰å…¨æ”¯æŒï¼Œæå‡äº†Kotlinå¼€å‘ä½“éªŒã€‚Spring Boot 3.5è®¡åˆ’æ•´åˆæ›´å¤šå“åº”å¼ä¼˜åŒ–ï¼Œå¦‚å¯¹Java 21è™šæ‹Ÿçº¿ç¨‹çš„æ·±åº¦æ”¯æŒï¼Œè¿›ä¸€æ­¥ç®€åŒ–å“åº”å¼åº”ç”¨çš„å¼€å‘å’Œéƒ¨ç½²ã€‚

åœ¨äº‘åŸç”Ÿå’Œå¾®æœåŠ¡æ¶æ„è¶‹åŠ¿ä¸‹ï¼ŒWebFluxæ­£æˆä¸ºæ„å»ºé«˜å¹¶å‘ã€ä½å»¶è¿ŸæœåŠ¡çš„æ ¸å¿ƒé€‰æ‹©ã€‚ç»“åˆSpring Cloud Gatewayã€Resilience4jå’ŒSpring Boot Actuatorç­‰ç»„ä»¶ï¼Œå¼€å‘è€…å¯ä»¥è½»æ¾æ„å»ºå…·æœ‰å¼ºå¤§ç›‘æ§å’Œå®¹é”™èƒ½åŠ›çš„å“åº”å¼å¾®æœåŠ¡ç³»ç»Ÿã€‚

æœªæ¥ï¼Œéšç€HTTP/3åè®®çš„æ™®åŠå’ŒJavaè™šæ‹ŸæœºæŠ€æœ¯çš„æ”¹è¿›ï¼ŒWebFluxæœ‰æœ›è¿›ä¸€æ­¥æå‡æ€§èƒ½è¡¨ç°ï¼Œä¸ºå¼€å‘è€…æä¾›æ›´é«˜æ•ˆçš„å“åº”å¼ç¼–ç¨‹ä½“éªŒã€‚åœ¨ä¼ä¸šçº§åº”ç”¨å¼€å‘ä¸­ï¼ŒWebFluxå°†ä¸ä¼ ç»ŸSpring MVCå¹¶å­˜ï¼Œä¸ºä¸åŒåœºæ™¯æä¾›æœ€ä½³è§£å†³æ–¹æ¡ˆã€‚

**æ€»ç»“**ï¼šSpring WebFluxé€šè¿‡å“åº”å¼ç¼–ç¨‹æ¨¡å‹ã€éé˜»å¡æ¶æ„å’ŒèƒŒå‹æœºåˆ¶ï¼Œä¸ºæ„å»ºé«˜æ€§èƒ½ã€é«˜å¹¶å‘çš„ç°ä»£Webåº”ç”¨æä¾›äº†å¼ºå¤§æ”¯æŒã€‚ä¸¤ç§ç¼–ç¨‹æ¨¡å‹ï¼ˆæ³¨è§£å’Œå‡½æ•°å¼ï¼‰å„æœ‰æ‰€é•¿ï¼Œé€‚ç”¨äºä¸åŒåœºæ™¯ã€‚åœ¨å¾®æœåŠ¡æ¶æ„å’Œå®æ—¶æ•°æ®å¤„ç†é¢†åŸŸï¼ŒWebFluxå±•ç°å‡ºç‹¬ç‰¹ä¼˜åŠ¿ã€‚é€šè¿‡ç†è§£å…¶æ ¸å¿ƒæ¦‚å¿µã€æŒæ¡é«˜çº§ä¸»é¢˜å’ŒæŒç»­ä¼˜åŒ–ï¼Œå¼€å‘è€…å¯ä»¥å……åˆ†å‘æŒ¥WebFluxçš„æ½œåŠ›ï¼Œæ„å»ºé«˜æ•ˆå¯é çš„å“åº”å¼åº”ç”¨ç³»ç»Ÿã€‚

è¯´æ˜ï¼šæŠ¥å‘Šå†…å®¹ç”±é€šä¹‰AIç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒã€‚













# è¡¥å……













#### âœ… ä¼ ç»Ÿçš„ç½‘ç»œè¯·æ±‚ï¼ˆæ¯”å¦‚ `HttpClient`ï¼‰ï¼š

- æ˜¯**é˜»å¡**çš„ã€‚
    
- å‘è¯·æ±‚åï¼Œå½“å‰çº¿ç¨‹**å¿…é¡»ç­‰åˆ°å“åº”å›æ¥**æ‰èƒ½ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚
    
- å¦‚æœä½ æŠŠå®ƒæ”¾åœ¨ä¸»çº¿ç¨‹é‡Œï¼Œå®ƒä¼šè®©çº¿ç¨‹â€œé—²ç€ç­‰â€ï¼Œæµªè´¹èµ„æºã€‚
    

#### âœ… `WebClient`ï¼ˆåŸºäº Reactor çš„ï¼‰ï¼š

- æ˜¯**éé˜»å¡**ã€**å¼‚æ­¥**çš„ã€‚
    
- å®ƒå‘èµ·è¯·æ±‚åï¼Œä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œè€Œæ˜¯**æ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°**ï¼Œç­‰æ•°æ®å›æ¥äº†å†æ‰§è¡Œå›è°ƒã€‚
    
- æ‰€ä»¥ï¼Œå®ƒå¯ä»¥ä¼˜é›…åœ°â€œæŒ‚åœ¨â€ reactive æµé‡Œï¼Œè€Œä¸ä¼šå¡ä½ä¸» reactive çº¿ç¨‹ï¼ˆæ¯”å¦‚ Netty çš„ event loopï¼‰ã€‚















### ç›´æ¥å›ç­”

**å…³é”®ç‚¹ï¼š**  
- ç ”ç©¶è¡¨æ˜ï¼ŒSpring WebFlux å’Œ Spring Web MVC éƒ½å¯ä»¥è¿”å›ç±»ä¼¼ç±»å‹ï¼ŒåŒ…æ‹¬ Mono å’Œ Fluxï¼Œä½†å¤„ç†æ–¹å¼ä¸åŒã€‚  
- Spring WebFlux æä¾›å®Œå…¨éé˜»å¡çš„ååº”å¼ç¼–ç¨‹æ¨¡å‹ï¼Œè€Œ Spring Web MVC åœ¨è¿”å›ååº”å¼ç±»å‹æ—¶å¯èƒ½æ¶‰åŠé˜»å¡æ“ä½œã€‚  
- Spring WebFlux æœ‰åŠŸèƒ½æ€§ç«¯ç‚¹å’Œ WebClient ç­‰ç‰¹æ€§ï¼ŒSpring Web MVC åˆ™æ›´é€‚åˆä¼ ç»Ÿé˜»å¡åº”ç”¨ã€‚

**Spring WebFlux ä¸ Spring Web MVC çš„è¿”å›ç±»å‹**  
Spring WebFlux å’Œ Spring Web MVC éƒ½å¯ä»¥è¿”å›å„ç§ç±»å‹ï¼ŒåŒ…æ‹¬å­—ç¬¦ä¸²ï¼ˆè§†å›¾åç§°ï¼‰ã€ResponseEntity ä»¥åŠååº”å¼ç±»å‹å¦‚ Mono å’Œ Fluxã€‚  
- åœ¨ Spring Web MVC ä¸­ï¼Œè¿”å› Mono æˆ– Flux å…è®¸å¼‚æ­¥å¤„ç†ï¼Œä½†åº•å±‚å¯èƒ½ä»ä¸ºé˜»å¡æ“ä½œã€‚  
- åœ¨ Spring WebFlux ä¸­ï¼Œè¿”å›è¿™äº›ç±»å‹æ˜¯å®Œå…¨éé˜»å¡çš„ï¼Œé€‚åˆé«˜å¹¶å‘åœºæ™¯ã€‚

**Spring WebFlux ç‹¬æœ‰çš„ç‰¹æ€§**  
Spring WebFlux æä¾›äº†ä¸€äº› Spring Web MVC æ²¡æœ‰çš„ç‰¹æ€§ï¼š  
- åŠŸèƒ½æ€§ç«¯ç‚¹ï¼ˆFunctional Endpointsï¼‰ï¼Œå…è®¸ä½¿ç”¨å‡½æ•°å¼ç¼–ç¨‹å®šä¹‰è·¯ç”±å’Œå¤„ç†ç¨‹åºã€‚  
- WebClientï¼Œç”¨äºéé˜»å¡çš„ HTTP è¯·æ±‚ï¼Œæ›¿ä»£ Spring MVC çš„ RestTemplateã€‚  
- ServerWebExchangeï¼Œååº”å¼è¯·æ±‚å’Œå“åº”çš„è¡¨ç¤ºã€‚  
- æ›´å¥½çš„ååº”å¼æ•°æ®è®¿é—®æ”¯æŒï¼Œå¦‚ä¸ MongoDBã€Cassandra çš„é›†æˆã€‚

**Spring Web MVC ç‹¬æœ‰çš„ç‰¹æ€§**  
Spring Web MVC æœ‰ Spring WebFlux æ²¡æœ‰çš„ä¸€äº›ç‰¹æ€§ï¼š  
- ç›´æ¥åŸºäº Servlet APIï¼Œé€‚åˆä¼ ç»Ÿé˜»å¡ I/O æ¨¡å‹ã€‚  
- æ›´å¤§çš„ç”Ÿæ€ç³»ç»Ÿï¼Œæ”¯æŒæ›´å¤šé˜»å¡æ“ä½œçš„ç¬¬ä¸‰æ–¹åº“ã€‚  
- è°ƒè¯•å’Œå¼€å‘å¯èƒ½æ›´ç®€å•ï¼Œé€‚åˆä¸ç†Ÿæ‚‰ååº”å¼ç¼–ç¨‹çš„å¼€å‘è€…ã€‚

æœ‰å…³æ›´å¤šç»†èŠ‚ï¼Œè¯·å‚é˜… [Spring Framework Web MVC æ–‡æ¡£](https://docs.spring.io/spring-framework/reference/web/webmvc.html) å’Œ [Spring Framework WebFlux æ–‡æ¡£](https://docs.spring.io/spring-framework/reference/web/webflux.html)ã€‚

---

### è°ƒæŸ¥ç¬”è®°

Spring WebFlux å’Œ Spring Web MVC æ˜¯ Spring ç”Ÿæ€ç³»ç»Ÿä¸­çš„ä¸¤ä¸ª web æ¡†æ¶ï¼Œåˆ†åˆ«é’ˆå¯¹ä¸åŒçš„ç¼–ç¨‹æ¨¡å‹å’Œä½¿ç”¨åœºæ™¯ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†çš„æ¯”è¾ƒï¼Œæ¶µç›–è¿”å›ç±»å‹ã€ç‰¹æ€§ä»¥åŠç±»å±‚æ¬¡çš„å·®å¼‚ï¼ŒåŸºäº 2025 å¹´ 5 æœˆ 5 æ—¥çš„æœ€æ–°ç ”ç©¶å’Œæ–‡æ¡£ã€‚

#### è¿”å›ç±»å‹çš„æ¯”è¾ƒ

ç ”ç©¶è¡¨æ˜ï¼ŒSpring WebFlux å’Œ Spring Web MVC éƒ½å¯ä»¥è¿”å›å¤šç§ç±»å‹ï¼ŒåŒ…æ‹¬å­—ç¬¦ä¸²ï¼ˆç”¨äºè§†å›¾åç§°ï¼‰ã€ModelAndViewã€ResponseEntity ä»¥åŠååº”å¼ç±»å‹å¦‚ Mono å’Œ Fluxã€‚  
- **Spring Web MVC çš„è¿”å›ç±»å‹ï¼š** æ ¹æ® [Spring Framework æ–‡æ¡£](https://docs.spring.io/spring-framework/reference/web/webmvc/mvc-controller/ann-methods/return-types.html)ï¼ŒSpring Web MVC æ”¯æŒä»¥ä¸‹è¿”å›ç±»å‹ï¼š  
  - `@ResponseBody`ï¼šé€šè¿‡ HttpMessageConverter è½¬æ¢ä¸ºå“åº”ã€‚  
  - `HttpEntity` æˆ– `ResponseEntity`ï¼šæŒ‡å®šå®Œæ•´çš„å“åº”ï¼ŒåŒ…æ‹¬å¤´éƒ¨å’Œä¸»ä½“ã€‚  
  - `String`ï¼šè§£æä¸ºè§†å›¾åç§°ï¼Œä½¿ç”¨ ViewResolverã€‚  
  - ååº”å¼ç±»å‹ï¼ˆå¦‚ Monoã€Fluxï¼‰ï¼šé€šè¿‡ ReactiveAdapterRegistry æ”¯æŒï¼Œå•å€¼ï¼ˆå¦‚ Monoï¼‰ç±»ä¼¼ DeferredResultï¼Œå¤šå€¼ï¼ˆå¦‚ Fluxï¼‰å¯ä»¥ä½œä¸ºæµæˆ–æ”¶é›†ä¸º Listã€‚  
  - å…¶ä»–ç±»å‹å¦‚ `void`ã€`Map`ã€`Model` ç­‰ï¼Œå…·ä½“å¤„ç†å–å†³äºä¸Šä¸‹æ–‡ã€‚  
  å°½ç®¡å¯ä»¥è¿”å› Mono å’Œ Fluxï¼Œä½† Spring Web MVC çš„åº•å±‚åŸºäº Servlet APIï¼Œå¯èƒ½æ¶‰åŠé˜»å¡æ“ä½œï¼Œå°¤å…¶æ˜¯åœ¨ä½¿ç”¨ä¼ ç»Ÿé˜»å¡æ•°æ®åº“æˆ–ç½‘ç»œ API æ—¶ã€‚

- **Spring WebFlux çš„è¿”å›ç±»å‹ï¼š** æ ¹æ® [Spring Framework æ–‡æ¡£](https://docs.spring.io/spring-framework/reference/web/webflux/controller/ann-methods/return-types.html)ï¼ŒSpring WebFlux æ”¯æŒç±»ä¼¼ç±»å‹ï¼Œä½†å¤„ç†æ–¹å¼å®Œå…¨éé˜»å¡ï¼š  
  - `@ResponseBody`ï¼šé€šè¿‡ HttpMessageWriter ç¼–ç å¹¶å†™å…¥å“åº”ã€‚  
  - `ResponseEntity`ï¼šæŒ‡å®šå®Œæ•´çš„å“åº”ï¼ŒåŒ…æ‹¬å¤´éƒ¨å’Œä¸»ä½“ã€‚  
  - `String`ï¼šè§£æä¸ºè§†å›¾åç§°ï¼Œæˆ–ç›´æ¥å†™å…¥å“åº”ä½“ã€‚  
  - ååº”å¼ç±»å‹ï¼ˆå¦‚ Monoã€Fluxï¼‰ï¼šè‡ªç„¶æ”¯æŒæµå¼å¤„ç†ï¼ŒFlux å¯ä»¥ä½œä¸ºæœåŠ¡å™¨å‘é€äº‹ä»¶ï¼ˆServer-Sent Eventsï¼‰æˆ– JSON æµè¾“å‡ºï¼Œç‰¹åˆ«é€‚åˆå¤„ç†å¤§é‡å¹¶å‘è¿æ¥ã€‚  
  å¯¹äº Fluxï¼Œè¿”å›å€¼å¯ä»¥æµå¼ä¼ è¾“ï¼Œä¸éœ€è¦ç¼“å†²ï¼Œæ•ˆç‡æ›´é«˜ï¼Œå°¤å…¶åœ¨åª’ä½“ç±»å‹å¦‚ `application/json+stream` æ—¶ã€‚

å› æ­¤ï¼Œè™½ç„¶ä¸¤è€…éƒ½å¯ä»¥è¿”å› Mono å’Œ Fluxï¼Œä½† Spring WebFlux çš„ååº”å¼æ ˆä½¿å…¶æ›´é€‚åˆé«˜å¹¶å‘ã€éé˜»å¡åœºæ™¯ï¼Œè€Œ Spring Web MVC çš„ååº”å¼æ”¯æŒæ›´å¤šæ˜¯å¼‚æ­¥å¤„ç†çš„é€‚é…ã€‚

#### ç‰¹æ€§æ¯”è¾ƒ

ä»¥ä¸‹æ˜¯ Spring WebFlux å’Œ Spring Web MVC åœ¨ç‰¹æ€§å’ŒåŠŸèƒ½ä¸Šçš„å·®å¼‚ï¼š

**Spring WebFlux ç‹¬æœ‰çš„ç‰¹æ€§ï¼š**  
- **ååº”å¼ç¼–ç¨‹æ¨¡å‹ï¼š** åŸºäº Project Reactorï¼Œæ”¯æŒ Mono å’Œ Fluxï¼Œé€‚åˆæ„å»ºå®Œå…¨éé˜»å¡çš„åº”ç”¨ã€‚  
- **åŠŸèƒ½æ€§ç«¯ç‚¹ï¼š** æä¾› RouterFunction å’Œ HandlerFunctionï¼Œå…è®¸ä½¿ç”¨å‡½æ•°å¼ç¼–ç¨‹å®šä¹‰è·¯ç”±å’Œå¤„ç†ç¨‹åºï¼Œé€‚åˆå°å‹åº”ç”¨æˆ–éœ€è¦å¤æ‚è·¯ç”±çš„åœºæ™¯ã€‚  
- **WebClientï¼š** éé˜»å¡çš„ HTTP å®¢æˆ·ç«¯ï¼Œæ›¿ä»£ Spring MVC çš„ RestTemplateï¼Œé€‚åˆååº”å¼å¾®æœåŠ¡é€šä¿¡ã€‚  
- **ServerWebExchangeï¼š** ååº”å¼è¯·æ±‚å’Œå“åº”çš„è¡¨ç¤ºï¼Œæ›¿ä»£ä¼ ç»Ÿçš„ HttpServletRequest å’Œ HttpServletResponseã€‚  
- **ååº”å¼æ•°æ®è®¿é—®ï¼š** ä¸ååº”å¼æ•°æ®åº“ï¼ˆå¦‚ MongoDBã€Cassandraï¼‰é›†æˆï¼Œæ”¯æŒ ReactiveCrudRepositoryï¼Œé€‚åˆæ„å»ºç«¯åˆ°ç«¯çš„éé˜»å¡åº”ç”¨ã€‚  
- **HTTP/2 å’ŒæœåŠ¡å™¨å‘é€äº‹ä»¶ï¼š** å¤©ç„¶æ”¯æŒ HTTP/2 å’ŒæœåŠ¡å™¨å‘é€äº‹ä»¶ï¼Œé€‚åˆå®æ—¶æ•°æ®æµåœºæ™¯ã€‚

**Spring Web MVC ç‹¬æœ‰çš„ç‰¹æ€§ï¼š**  
- **Servlet API é›†æˆï¼š** ç›´æ¥åŸºäº Servlet APIï¼Œé€‚åˆä¼ ç»Ÿ web åº”ç”¨å¼€å‘ï¼Œå…¼å®¹å¹¿æ³›çš„ servlet å®¹å™¨å¦‚ Tomcatã€Jetty å’Œ Undertowã€‚  
- **é˜»å¡ I/O æ¨¡å‹ï¼š** æ¯ä¸ªè¯·æ±‚ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹ï¼Œé€‚åˆé˜»å¡æ“ä½œçš„åœºæ™¯ï¼Œå¦‚ä¼ ç»Ÿ JDBC æˆ–é˜»å¡ç½‘ç»œ APIã€‚  
- **æ›´å¤§çš„ç”Ÿæ€ç³»ç»Ÿï¼š** æ”¯æŒæ›´å¤šé˜»å¡æ“ä½œçš„ç¬¬ä¸‰æ–¹åº“ï¼Œå†å²æ›´é•¿ï¼Œæ–‡æ¡£å’Œç¤¾åŒºèµ„æºæ›´ä¸°å¯Œã€‚  
- **è°ƒè¯•å’Œå¼€å‘ä¾¿åˆ©æ€§ï¼š** ä¼ ç»Ÿæ ˆçš„è°ƒè¯•å·¥å…·æ›´æˆç†Ÿï¼Œé€‚åˆä¸ç†Ÿæ‚‰ååº”å¼ç¼–ç¨‹çš„å¼€å‘è€…ã€‚

#### ç±»å’Œæ¥å£çš„å·®å¼‚

ä»¥ä¸‹æ˜¯ä¸¤è€…çš„å…·ä½“ç±»å·®å¼‚ï¼Œåæ˜ äº†å®ƒä»¬çš„ç¼–ç¨‹æ¨¡å‹å’Œæ¶æ„ï¼š

| **ç±»åˆ«**               | **Spring WebFlux ç‹¬æœ‰ç±»**                          | **Spring Web MVC ç‹¬æœ‰ç±»**                          |
|-------------------------|---------------------------------------------------|---------------------------------------------------|
| è¯·æ±‚/å“åº”å¤„ç†          | ServerWebExchange, RouterFunction, HandlerFunction | HttpServletRequest, HttpServletResponse           |
| HTTP å®¢æˆ·ç«¯            | WebClient                                         | RestTemplate                                      |
| è¿‡æ»¤å™¨                 | WebFilter                                         | Filter                                            |
| ä¼šè¯ç®¡ç†               | WebSession                                        | Session                                           |
| è·¯ç”±å’Œå¤„ç†             | N/A                                               | Controller (ä¼ ç»Ÿ MVC æ§åˆ¶å™¨)                      |

æ­¤å¤–ï¼Œä¸¤è€…å…±äº«ä¸€äº›æ³¨è§£å¦‚ @Controllerã€@RestControllerã€@GetMapping ç­‰ï¼Œä½† WebFlux çš„æ–¹æ³•ç­¾åæ›´å¸¸æ¶‰åŠ Mono å’Œ Fluxã€‚

#### ä½¿ç”¨åœºæ™¯å»ºè®®

- **Spring WebFlux é€‚åˆï¼š** é«˜è´Ÿè½½åœºæ™¯ã€éœ€è¦é«˜å¹¶å‘è¿æ¥çš„åº”ç”¨ï¼ˆå¦‚å¾®æœåŠ¡ã€å®æ—¶æ•°æ®æµï¼‰ã€ä»¥åŠå®Œå…¨éé˜»å¡çš„æ¶æ„ã€‚  
- **Spring Web MVC é€‚åˆï¼š** ä¼ ç»Ÿ web åº”ç”¨ã€é˜»å¡æ“ä½œè¾ƒå¤šçš„åœºæ™¯ã€ä»¥åŠå¼€å‘è€…æ›´ç†Ÿæ‚‰é˜»å¡ I/O æ¨¡å‹çš„æƒ…å†µã€‚

#### å­¦ä¹ æ›²çº¿å’Œå¼€å‘å»ºè®®

- Spring WebFlux çš„åˆ‡æ¢å¯èƒ½å…·æœ‰æŒ‘æˆ˜æ€§ï¼Œå°¤å…¶æ˜¯å¯¹äºéé˜»å¡ã€å‡½æ•°å¼å’Œå£°æ˜å¼ç¼–ç¨‹çš„ç†è§£ã€‚  
- å¦‚æœç°æœ‰åº”ç”¨ä½¿ç”¨ Spring MVC ä¸”è¿è¡Œè‰¯å¥½ï¼Œå»ºè®®ä¿æŒä¸å˜ï¼›å¯¹äºæ–°é¡¹ç›®ï¼Œè€ƒè™‘ WebFlux ä»¥åº”å¯¹æœªæ¥æ‰©å±•éœ€æ±‚ã€‚

#### è¯¦ç»†ç¤ºä¾‹

ä¾‹å¦‚ï¼Œåœ¨ Spring WebFlux ä¸­ï¼Œä¸€ä¸ªæ§åˆ¶å™¨å¯èƒ½å¦‚ä¸‹ï¼š  
```java
@RestController
public class ExampleController {
    @GetMapping("/data")
    public Flux<String> getData() {
        return Flux.just("data1", "data2", "data3");
    }
}
```
è¿™ä¼šä»¥æµå¼æ–¹å¼è¿”å›æ•°æ®ï¼Œéé˜»å¡ã€‚

è€Œåœ¨ Spring Web MVC ä¸­ï¼Œç±»ä¼¼åŠŸèƒ½å¯èƒ½å¦‚ä¸‹ï¼š  
```java
@RestController
public class ExampleController {
    @GetMapping("/data")
    public List<String> getData() {
        return Arrays.asList("data1", "data2", "data3");
    }
}
```
è¿™é‡Œæ˜¯é˜»å¡çš„ï¼Œè¿”å›ä¸€ä¸ªåˆ—è¡¨ã€‚

#### ç»“è®º

ç»¼ä¸Šæ‰€è¿°ï¼ŒSpring WebFlux å’Œ Spring Web MVC éƒ½å¯ä»¥è¿”å›ç±»ä¼¼ç±»å‹ï¼ŒåŒ…æ‹¬ Mono å’Œ Fluxï¼Œä½†å®ƒä»¬çš„å¤„ç†æ–¹å¼å’Œé€‚ç”¨åœºæ™¯ä¸åŒã€‚Spring WebFlux æä¾›æ›´ç°ä»£çš„ååº”å¼ç¼–ç¨‹æ¨¡å‹ï¼Œé€‚åˆé«˜å¹¶å‘å’Œéé˜»å¡éœ€æ±‚ï¼›Spring Web MVC åˆ™æ›´é€‚åˆä¼ ç»Ÿé˜»å¡åº”ç”¨ï¼Œç”Ÿæ€ç³»ç»Ÿæ›´æˆç†Ÿã€‚é€‰æ‹©å“ªä¸€ä¸ªå–å†³äºé¡¹ç›®çš„å…·ä½“éœ€æ±‚å’Œå¼€å‘å›¢é˜Ÿçš„æŠ€æœ¯æ ˆã€‚

---

### å…³é”®å¼•æ–‡  
- [Spring Framework Web MVC æ§åˆ¶å™¨è¿”å›ç±»å‹æ–‡æ¡£](https://docs.spring.io/spring-framework/reference/web/webmvc/mvc-controller/ann-methods/return-types.html)  
- [Spring Framework WebFlux æ§åˆ¶å™¨è¿”å›ç±»å‹æ–‡æ¡£](https://docs.spring.io/spring-framework/reference/web/webflux/controller/ann-methods/return-types.html)  
- [Spring Web MVC ä¸ Spring WebFlux å·®å¼‚åˆ†æ](https://symflower.com/en/company/blog/2024/spring-mvc-spring-webflux/)  
- [Spring WebFlux å…¥é—¨æŒ‡å—](https://www.baeldung.com/spring-webflux)  
- [Spring MVC å¼‚æ­¥ä¸ WebFlux æ¯”è¾ƒ](https://www.baeldung.com/spring-mvc-async-vs-webflux)
















# --------------------












ä¸€ä¸ªå®˜ç½‘ï¼Œä¸€èˆ¬éƒ½æ˜¯xxx.ioï¼Œä¾‹å¦‚spring.ioï¼Œconsul.io

![](image-20250501101605425.png)


![](image-20250501101620402.png)


æ˜ç™½äº†ï¼Œæˆ‘å°†ä¸ºä½ é‡æ–°æ•´ç†ä¸€ç‰ˆæ›´åŠ æ¸…æ™°ã€ç»“æ„åˆç†ã€æ ‡å‡†åŒ–ä¸”ç»“åˆäº†ä½ å½“å‰æ­¥éª¤ã€å®˜æ–¹æœ€ä½³å®è·µå’Œæˆ‘ä¼˜åŒ–å»ºè®®çš„ Elasticsearch 8.18 ä¸‰èŠ‚ç‚¹é›†ç¾¤éƒ¨ç½²æ–‡æ¡£ã€‚è¯·ç¨ç­‰ï¼Œæˆ‘æ•´ç†å¥½å¾ˆå¿«ç»™ä½ ã€‚

# Elasticsearch 8.18 ä¸‰èŠ‚ç‚¹é›†ç¾¤éƒ¨ç½²æŒ‡å—

## 1. æœåŠ¡å™¨å‡†å¤‡

1. **è®¾ç½®ä¸»æœºå**ï¼šåœ¨3å° Ubuntu 22.04 æœåŠ¡å™¨ä¸Šåˆ†åˆ«è®¾ç½®å”¯ä¸€ä¸»æœºåï¼ˆå¦‚ `node1`ã€`node2`ã€`node3`ï¼‰ï¼š
    
    ```bash
    sudo hostnamectl set-hostname node1
    ```
    
    ï¼ˆåœ¨å…¶ä»–èŠ‚ç‚¹ä¸Šåˆ†åˆ«è®¾ç½® `node2`ã€`node3`ï¼‰ ([ElasticSearchå­¦ä¹ ç¬”è®°ï¼ˆä¸‰ï¼‰Ubuntu 2204 server elasticsearché›†ç¾¤é…ç½®-CSDNåšå®¢](https://blog.csdn.net/alfiy/article/details/142693880#:~:text=0))ã€‚
    
2. **é…ç½® `/etc/hosts`**ï¼šç¼–è¾‘æ¯å°æœåŠ¡å™¨çš„ `/etc/hosts` æ–‡ä»¶ï¼ŒåŠ å…¥é›†ç¾¤å†…æ‰€æœ‰èŠ‚ç‚¹çš„ IP å’Œä¸»æœºåæ˜ å°„ï¼Œä¾‹å¦‚ï¼š
    
    ```bash
    192.168.1.1 node1
    192.168.1.2 node2
    192.168.1.3 node3
    ```
    
    ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹èƒ½é€šè¿‡ä¸»æœºåäº’ç›¸è§£æã€‚
    
3. **å…³é—­ Swap å¹¶ä¼˜åŒ–ç³»ç»Ÿå‚æ•°**ï¼šElasticsearch è¦æ±‚ç¦ç”¨äº¤æ¢åˆ†åŒºï¼Œå¦åˆ™ä¼šä¸¥é‡å½±å“æ€§èƒ½å’Œç¨³å®šæ€§ ([Disable swapping | Elastic Docs](https://www.elastic.co/guide/en/elasticsearch/reference/current/setup-configuration-memory.html#:~:text=Swapping%20is%20very%20bad%20for,operating%20system%20kill%20the%20node))ã€‚ä¸´æ—¶å…³é—­å¯æ‰§è¡Œï¼š
    
    ```bash
    sudo swapoff -a
    ```
    
    æ°¸ä¹…å…³é—­åˆ™éœ€ç¼–è¾‘ `/etc/fstab`ï¼Œæ³¨é‡Šæ‰åŒ…å« `swap` çš„è¡Œ ([Disable swapping | Elastic Docs](https://www.elastic.co/guide/en/elasticsearch/reference/current/setup-configuration-memory.html#:~:text=On%20Linux%20systems%2C%20you%20can,disable%20swap%20temporarily%20by%20running))ã€‚æ­¤å¤–ï¼Œå¯å‚è€ƒå®˜æ–¹æ–‡æ¡£è°ƒæ•´ `vm.max_map_count` ç­‰å†…æ ¸å‚æ•°ã€‚
    
4. **å¼€æ”¾å¿…è¦ç«¯å£**ï¼šç¡®ä¿é˜²ç«å¢™å…è®¸ 9200ï¼ˆHTTP/REST æ¥å£ï¼‰å’Œ 9300ï¼ˆèŠ‚ç‚¹é—´é€šä¿¡ï¼‰ç«¯å£çš„è®¿é—®ã€‚
    
5. **åˆ›å»º Elasticsearch ç”¨æˆ·**ï¼šå»ºè®®æ–°å»ºç³»ç»Ÿç”¨æˆ· `elasticsearch` æ¥è¿è¡ŒæœåŠ¡ï¼Œé¿å…ç›´æ¥ä½¿ç”¨ rootã€‚
    
    ```bash
    sudo adduser --system --group --no-create-home elasticsearch
    ```
    

## 2. ä¸‹è½½å¹¶å®‰è£… Elasticsearch

1. **ä¸‹è½½å®˜æ–¹å‹ç¼©åŒ…å¹¶æ ¡éªŒ**ï¼šåœ¨ä»»æ„ä¸€å°èŠ‚ç‚¹ä¸Šä¸‹è½½ Elasticsearch 8.18.0 çš„ tar åŒ…åŠå…¶æ ¡éªŒå’Œï¼ˆä»¥ä¸‹ä»¥ `8.18.0` ä¸ºä¾‹ï¼‰ï¼š
    
    ```bash
    wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.18.0-linux-x86_64.tar.gz
    wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.18.0-linux-x86_64.tar.gz.sha512
    sha512sum -c elasticsearch-8.18.0-linux-x86_64.tar.gz.sha512
    ```
    
    ä¸Šè¿°æ­¥éª¤ä¼šæ ¡éªŒä¸‹è½½åŒ…çš„å®Œæ•´æ€§ï¼Œåº”è¾“å‡ºâ€œOKâ€ ([Install Elasticsearch from archive on Linux or MacOS | Elastic Docs](https://www.elastic.co/docs/deploy-manage/deploy/self-managed/install-elasticsearch-from-archive-on-linux-macos#:~:text=wget%20https%3A%2F%2Fartifacts.elastic.co%2Fdownloads%2Felasticsearch%2Felasticsearch,9.0.0))ã€‚
    
2. **è§£å‹å¹¶è®¾ç½®ç›®å½•æƒé™**ï¼š
    
    ```bash
    sudo mkdir -p /usr/local/elasticsearch-8.18.0
    sudo tar -zxvf elasticsearch-8.18.0-linux-x86_64.tar.gz -C /usr/local/elasticsearch-8.18.0 --strip-components=1
    sudo chown -R elasticsearch:elasticsearch /usr/local/elasticsearch-8.18.0
    sudo chmod -R 750 /usr/local/elasticsearch-8.18.0
    ```
    
    å°†è§£å‹åçš„æ–‡ä»¶å½’ `elasticsearch` ç”¨æˆ·æ‰€æœ‰ï¼Œå¹¶é™åˆ¶æƒé™ã€‚
    
3. **åˆ›å»ºæ•°æ®å’Œæ—¥å¿—ç›®å½•**ï¼ˆå¯é€‰ï¼‰ï¼šç¡®ä¿ `elasticsearch` ç”¨æˆ·å¯¹æ•°æ®ç›®å½•å’Œæ—¥å¿—ç›®å½•æœ‰å†™æƒé™ã€‚
    

> **æ³¨æ„ï¼š** ä»¥ä¸Šæ­¥éª¤éœ€è¦åœ¨æ¯å°èŠ‚ç‚¹ä¸Šé‡å¤æ‰§è¡Œï¼Œä»¥ä¿è¯ä¸‰å°æœåŠ¡å™¨ä¸Šå®‰è£…çš„ ES ç‰ˆæœ¬å’Œç›®å½•ç»“æ„ä¸€è‡´ ([Install Elasticsearch from archive on Linux or MacOS | Elastic Docs](https://www.elastic.co/docs/deploy-manage/deploy/self-managed/install-elasticsearch-from-archive-on-linux-macos#:~:text=wget%20https%3A%2F%2Fartifacts.elastic.co%2Fdownloads%2Felasticsearch%2Felasticsearch,9.0.0))ã€‚

## 3. ç”Ÿæˆå¹¶åˆ†å‘ SSL è¯ä¹¦

ä¸ºå¯ç”¨èŠ‚ç‚¹é—´å’Œ HTTP å±‚çš„åŠ å¯†é€šä¿¡ï¼Œéœ€è¦åˆ›å»ºè‡ªå·±çš„è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰å¹¶ç”Ÿæˆè¯ä¹¦ã€‚

1. **ç”Ÿæˆ CA è¯ä¹¦**ï¼ˆåœ¨ä»»ä¸€èŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œå¦‚ node1ï¼‰ï¼š
    
    ```bash
    cd /usr/local/elasticsearch-8.18.0
    sudo -u elasticsearch bin/elasticsearch-certutil ca --out elastic-stack-ca.p12
    ```
    
    æ­¤å‘½ä»¤ä¼šæç¤ºè¾“å…¥å¯†ç å¹¶ç”Ÿæˆ `elastic-stack-ca.p12`ï¼ˆåŒ…å« CA è¯ä¹¦å’Œå¯†é’¥ï¼‰ã€‚**è¯·å¦¥å–„ä¿å­˜ CA å¯†é’¥åº“å¯†ç ï¼Œ**ç¡®ä¿ CA çš„ç§é’¥ä¸å¤–æ³„ã€‚
    
2. **ç”ŸæˆèŠ‚ç‚¹ä¼ è¾“å±‚è¯ä¹¦**ï¼šä½¿ç”¨ä¸Šè¿° CA ä¸ºæ¯ä¸ªèŠ‚ç‚¹ç”ŸæˆèŠ‚ç‚¹è¯ä¹¦ï¼ˆtransport å±‚ï¼‰ã€‚ä»¥ `node1` ä¸ºä¾‹ï¼š
    
    ```bash
    sudo -u elasticsearch bin/elasticsearch-certutil cert --name node1 --dns node1 --ip 192.168.1.1 --ca elastic-stack-ca.p12 --out node1.zip
    ```
    
    æŒ‰æç¤ºè¾“å…¥ CA å¯†ç åï¼Œä¼šç”Ÿæˆ `node1.zip`ï¼Œè§£å‹åå¾—åˆ° `node1/node1.p12`ï¼ŒåŒ…å«èŠ‚ç‚¹ç§é’¥å’Œè¯ä¹¦ã€‚å…¶ä»–èŠ‚ç‚¹ç±»ä¼¼å‘½ä»¤ï¼Œåªéœ€æ›¿æ¢ `--name`ã€`--dns` å’Œ `--ip`ã€‚
    
    _å°è´´å£«ï¼š_ ä¹Ÿå¯ä½¿ç”¨ YAML æ–‡ä»¶åŒæ—¶ç”Ÿæˆå¤šèŠ‚ç‚¹è¯ä¹¦ï¼Œå¦‚ `instances.yml` åˆ—å‡ºæ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯ï¼Œç„¶åæ‰§è¡Œ `elasticsearch-certutil cert --silent --in instances.yml --ca elastic-stack-ca.p12 --out all-nodes.zip` ([elasticsearch-certutil | Elastic Documentation](https://www.elastic.co/docs/reference/elasticsearch/command-line-tools/certutil#:~:text=When%20your%20YAML%20file%20is,For%20example))ã€‚
    
3. **ç”Ÿæˆ HTTP å±‚è¯ä¹¦**ï¼šä¸º HTTPS æ¥å£ç”Ÿæˆè¯ä¹¦ã€‚åœ¨ä»»æ„èŠ‚ç‚¹æ‰§è¡Œï¼š
    
    ```bash
    sudo -u elasticsearch bin/elasticsearch-certutil http
    ```
    
    å½“æç¤ºæ˜¯å¦ç”Ÿæˆ CSR æ—¶ï¼Œè¾“å…¥ `n`ï¼›ä½¿ç”¨å·²æœ‰ CA æ—¶è¾“å…¥ `y` å¹¶æŒ‡å®š `elastic-stack-ca.p12` åŠå…¶å¯†ç ï¼›ç„¶åè®¾ç½®è¯ä¹¦æœ‰æ•ˆæœŸï¼ˆå¦‚ `90D`ï¼‰ï¼›æœ€åè¯¢é—®æ˜¯å¦ä¸ºæ¯ä¸ªèŠ‚ç‚¹ç”Ÿæˆå•ç‹¬è¯ä¹¦æ—¶é€‰æ‹© `y`ã€‚  
    è¯¥è¿‡ç¨‹ä¼šç”Ÿæˆä¸€ä¸ª `.zip` åŒ…ï¼Œæ¯ä¸ªèŠ‚ç‚¹æ–‡ä»¶å¤¹å†…å«ä¸€ä¸ª `.p12` æ–‡ä»¶ï¼ˆä¾‹å¦‚ `node1/http/node1.p12`ï¼‰ã€‚
    
4. **åˆ†å‘è¯ä¹¦**ï¼šå°†ç”Ÿæˆçš„ä»¥ä¸‹æ–‡ä»¶å¤åˆ¶åˆ°å¯¹åº”èŠ‚ç‚¹çš„ Elasticsearch é…ç½®ç›®å½•ï¼ˆå¦‚ `/usr/local/elasticsearch-8.18.0/config/`ï¼‰ï¼Œå¹¶ç¡®ä¿æ–‡ä»¶å½’ `elasticsearch` ç”¨æˆ·æ‰€æœ‰ï¼š
    
    - **CA è¯ä¹¦**ï¼š`elastic-stack-ca.p12`ï¼ˆæ‰€æœ‰èŠ‚ç‚¹éœ€è¦ä¿¡ä»»çš„ CAï¼‰
        
    - **èŠ‚ç‚¹è¯ä¹¦**ï¼šå„èŠ‚ç‚¹å¯¹åº”çš„ `nodeX.p12`ï¼ˆtransport å±‚ä½¿ç”¨ï¼‰
        
    - **HTTP è¯ä¹¦**ï¼šå„èŠ‚ç‚¹å¯¹åº”çš„ HTTP `.p12`ï¼ˆHTTP å±‚ä½¿ç”¨ï¼‰
        
    
    å¯¹è¯ä¹¦æ–‡ä»¶èµ‹äºˆä¸¥æ ¼æƒé™ï¼Œä¾‹å¦‚ï¼š
    
    ```bash
    sudo chown elasticsearch:elasticsearch /usr/local/elasticsearch-8.18.0/config/*.p12
    sudo chmod 640 /usr/local/elasticsearch-8.18.0/config/*.p12
    ```
    
    **æ³¨æ„ï¼š** è¯ä¹¦æ–‡ä»¶ååº”ç®€å•æ— ç‰¹æ®Šå­—ç¬¦ï¼Œä¸”åœ¨é…ç½®ä¸­è·¯å¾„å¿…é¡»æ­£ç¡®å¯¹åº”ã€‚è¯ä¹¦çš„ CN/SAN å¿…é¡»åŒ…å«è¯¥èŠ‚ç‚¹çš„ä¸»æœºåæˆ– IPï¼Œå¦åˆ™å®‰å…¨è¿æ¥æ—¶ä¼šéªŒè¯å¤±è´¥ã€‚
    

## 4. Elasticsearch èŠ‚ç‚¹é…ç½®

ç¼–è¾‘æ¯å°èŠ‚ç‚¹çš„ `elasticsearch.yml`ï¼ˆä½äº `$ES_HOME/config/elasticsearch.yml`ï¼‰ï¼Œæ·»åŠ æˆ–ä¿®æ”¹ä»¥ä¸‹é…ç½®ï¼š

```yaml
cluster.name: my-es-cluster                     # é›†ç¾¤åç§°ï¼Œæ‰€æœ‰èŠ‚ç‚¹éœ€ä¸€è‡´
node.name: node1                                # å½“å‰èŠ‚ç‚¹åï¼ˆNode2/Node3 ä¸Šåˆ†åˆ«è®¾ä¸º node2/node3ï¼‰
network.host: 0.0.0.0                           # ç»‘å®šæ‰€æœ‰ç½‘ç»œæ¥å£ï¼ˆç”Ÿäº§å¯æŒ‡å®šå…·ä½“ IPï¼‰
http.port: 9200
transport.port: 9300
discovery.seed_hosts: ["node1","node2","node3"] # å…¶å®ƒèŠ‚ç‚¹åˆ—è¡¨
cluster.initial_master_nodes: ["node1","node2","node3"]  # **ä»…é¦–æ¬¡å¯åŠ¨æ—¶åœ¨ä¸»èŠ‚ç‚¹é…ç½®** ([Bootstrapping a cluster | Elastic Docs](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-bootstrap-cluster.html#:~:text=The%20initial%20set%20of%20master,eligible%20node))

path.data: /usr/local/elasticsearch-8.18.0/data
path.logs: /usr/local/elasticsearch-8.18.0/logs

xpack.security.enabled: true

# ä¼ è¾“å±‚ TLS/SSL é…ç½®ï¼ˆèŠ‚ç‚¹é—´é€šä¿¡ï¼‰
xpack.security.transport.ssl.enabled: true
xpack.security.transport.ssl.keystore.path: config/node1.p12      # èŠ‚ç‚¹è¯ä¹¦è·¯å¾„
xpack.security.transport.ssl.truststore.path: config/elastic-stack-ca.p12
xpack.security.transport.ssl.verification_mode: full              # éªŒè¯è¯ä¹¦ä¸»æœºåç­‰ ([Security settings in Elasticsearch | Elastic Documentation](https://www.elastic.co/docs/reference/elasticsearch/configuration-reference/security-settings#:~:text=,Performs%20no%20certificate%20validation))

# HTTP å±‚ TLS/SSL é…ç½®ï¼ˆå®¢æˆ·ç«¯è®¿é—®ï¼‰
xpack.security.http.ssl.enabled: true
xpack.security.http.ssl.keystore.path: config/node1.p12           # å¯å¤ç”¨èŠ‚ç‚¹è¯ä¹¦æˆ– HTTP è¯ä¹¦
xpack.security.http.ssl.truststore.path: config/elastic-stack-ca.p12
xpack.security.http.ssl.verification_mode: full                   # éªŒè¯å®¢æˆ·ç«¯è¯ä¹¦ï¼ˆé»˜è®¤ fullï¼‰ ([Security settings in Elasticsearch | Elastic Documentation](https://www.elastic.co/docs/reference/elasticsearch/configuration-reference/security-settings#:~:text=present%20one.%20Defaults%20to%20,verification_mode))
```

- **è¯´æ˜ï¼š**
    
    - `cluster.initial_master_nodes` åœ¨é›†ç¾¤ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶å¿…é¡»åœ¨ä¸»èŠ‚ç‚¹é…ç½®ï¼Œåˆ—å‡ºæ‰€æœ‰ä¸»èŠ‚ç‚¹å€™é€‰åç§° ([Bootstrapping a cluster | Elastic Docs](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-bootstrap-cluster.html#:~:text=The%20initial%20set%20of%20master,eligible%20node))ã€‚é›†ç¾¤å½¢æˆåå¯åˆ é™¤æ­¤è®¾ç½®ã€‚
        
    - å„èŠ‚ç‚¹åº”ä½¿ç”¨ç›¸åŒçš„ `cluster.name`ï¼Œä¸åŒçš„ `node.name`ã€‚
        
    - `transport.ssl.enabled: true` å¼ºåˆ¶å¼€å¯é›†ç¾¤å†…éƒ¨ TLS åŠ å¯† ([Security settings in Elasticsearch | Elastic Documentation](https://www.elastic.co/docs/reference/elasticsearch/configuration-reference/security-settings#:~:text=,xpack.security.transport.ssl.supported_protocols))ã€‚
        
    - å»ºè®®ä¿ç•™ `verification_mode: full`ï¼Œç¡®ä¿ä¸¥æ ¼éªŒè¯å¯¹ç«¯è¯ä¹¦æœ‰æ•ˆæ€§ï¼›**åˆ‡å‹¿**è®¾ç½®ä¸º `none`ï¼Œå¦åˆ™ä¼šä¸§å¤±å®‰å…¨ä¿æŠ¤ã€‚
        

ä¿®æ”¹å®Œæ¯•åï¼Œä¿å­˜æ–‡ä»¶å¹¶ç¡®ä¿ `elasticsearch` ç”¨æˆ·å¯¹é…ç½®æ–‡ä»¶å¯è¯»ã€‚

## 5. å¯åŠ¨é¡ºåºä¸æ³¨æ„äº‹é¡¹

1. **å¯åŠ¨ Node1**ï¼ˆä¸»èŠ‚ç‚¹ï¼‰ï¼š
    
    ```bash
    sudo -u elasticsearch /usr/local/elasticsearch-8.18.0/bin/elasticsearch -d
    ```
    
    - é¦–æ¬¡å¯åŠ¨æ—¶ï¼ŒElasticsearch ä¼šè‡ªåŠ¨æ‰§è¡Œå®‰å…¨åˆå§‹åŒ–ï¼Œå¹¶åœ¨æ—¥å¿—ä¸­è¾“å‡º `elastic` ç®¡ç†ç”¨æˆ·çš„åˆå§‹å¯†ç ï¼ˆè¯·**åŠ¡å¿…ä¿å­˜**ï¼‰ã€‚
        
    - å»ºè®®æŸ¥çœ‹ `$ES_HOME/logs/` ä¸‹çš„æ—¥å¿—ä»¥ç¡®è®¤å¯åŠ¨æˆåŠŸï¼Œæ— é”™è¯¯ã€‚
        
2. **å¯åŠ¨ Node2 å’Œ Node3**ï¼šå¾… Node1 æˆåŠŸå¯åŠ¨åï¼Œä¾æ¬¡åœ¨ Node2ã€Node3 ä¸Šæ‰§è¡ŒåŒæ ·çš„å¯åŠ¨å‘½ä»¤ï¼š
    
    ```bash
    sudo -u elasticsearch /usr/local/elasticsearch-8.18.0/bin/elasticsearch -d
    ```
    
    æ–°èŠ‚ç‚¹ä¼šè‡ªåŠ¨åŠ å…¥å·²æœ‰çš„é›†ç¾¤ã€‚
    
3. **æ³¨æ„äº‹é¡¹**ï¼š
    
    - ç¡®ä¿ `cluster.initial_master_nodes` ä»…åœ¨ Node1 çš„é¦–æ¬¡å¯åŠ¨æ—¶é…ç½®ï¼›åç»­é‡å¯æˆ–åŠ å…¥æ–°èŠ‚ç‚¹æ—¶ï¼Œä¸è¦é‡å¤ä½¿ç”¨è¯¥é…ç½®ã€‚
        
    - è‹¥å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ä¸­çš„é”™è¯¯æç¤ºï¼Œå¸¸è§é—®é¢˜åŒ…æ‹¬é…ç½®è·¯å¾„é”™è¯¯ã€è¯ä¹¦ä¸å¯è¯»ã€ç½‘ç»œè¿æ¥é—®é¢˜ç­‰ã€‚
        
    - **ä¿å­˜åˆå§‹å¯†ç **ï¼šNode1 å¯åŠ¨åæ—¥å¿—ä¼šæç¤º `elastic` ç”¨æˆ·åˆå§‹å¯†ç ï¼Œè¿™æ˜¯åç»­è®¿é—®é›†ç¾¤éœ€è¦ç”¨åˆ°çš„ ([elasticsearch-setup-passwords | Elastic Documentation](https://www.elastic.co/guide/en/elasticsearch/reference/current/setup-passwords.html#:~:text=Deprecated%20in%208))ã€‚
        

## 6. è®¾ç½®å†…ç½®ç”¨æˆ·å¯†ç 

Elasticsearch å®‰å…¨å¯ç”¨åï¼Œå¿…é¡»ä¸ºå†…ç½®ç”¨æˆ·ï¼ˆå¦‚ `elastic`ï¼‰è®¾ç½®å¯†ç ã€‚**æ³¨æ„ï¼š** 8.x ç‰ˆæœ¬å·²å¼ƒç”¨ `elasticsearch-setup-passwords`ï¼Œå»ºè®®ä½¿ç”¨ `elasticsearch-reset-password` å·¥å…· ([elasticsearch-setup-passwords | Elastic Documentation](https://www.elastic.co/guide/en/elasticsearch/reference/current/setup-passwords.html#:~:text=Deprecated%20in%208))ã€‚ä¾‹å¦‚ï¼Œä¸º `elastic` ç”¨æˆ·äº¤äº’å¼é‡ç½®å¯†ç ï¼š

```bash
sudo -u elasticsearch /usr/local/elasticsearch-8.18.0/bin/elasticsearch-reset-password -u elastic -i
```

ç³»ç»Ÿä¼šæç¤ºè¾“å…¥å¹¶ç¡®è®¤æ–°å¯†ç ã€‚å®Œæˆåï¼Œè¯·è®°ä¸‹æ­¤å¯†ç ï¼Œç”¨äºåç»­ç®¡ç†å’Œ API è¯·æ±‚ã€‚

## 7. é›†ç¾¤éªŒè¯

é…ç½®å®Œæˆåï¼Œå¯é€šè¿‡ä»¥ä¸‹å‘½ä»¤éªŒè¯é›†ç¾¤çŠ¶æ€ï¼š

- **é›†ç¾¤å¥åº·æ£€æŸ¥**ï¼š
    
    ```bash
    curl -u elastic:<your_password> -k https://node1:9200/_cluster/health?pretty
    ```
    
    æ­£å¸¸æƒ…å†µä¸‹ä¼šæ˜¾ç¤º `status: "green"`ï¼ˆæˆ–é»„è‰²ï¼‰å¹¶ä¸” `number_of_nodes: 3`ã€‚
    
- **åˆ—å‡ºèŠ‚ç‚¹ä¿¡æ¯**ï¼š
    
    ```bash
    curl -u elastic:<your_password> -k https://node1:9200/_cat/nodes?v
    ```
    
    ç»“æœåº”æ˜¾ç¤ºä¸‰å°èŠ‚ç‚¹çš„åç§°ã€è§’è‰²ã€ç‰ˆæœ¬ç­‰ä¿¡æ¯ï¼Œç¡®è®¤å®ƒä»¬éƒ½å·²åŠ å…¥é›†ç¾¤ã€‚
    
- **å…¶ä»–æµ‹è¯•**ï¼šå°è¯•åˆ›å»ºç´¢å¼•æˆ–å†™å…¥æ–‡æ¡£ï¼Œç¡®ä¿è¯»å†™æ­£å¸¸ï¼Œå¹¶å¯é€šè¿‡ HTTPS è®¿é—®é›†ç¾¤ï¼ˆå¯åŠ ä¸Š `-k` è·³è¿‡è¯ä¹¦éªŒè¯ï¼Œæˆ–ä½¿ç”¨ `--cacert` æŒ‡å®š CA è¯ä¹¦ï¼‰ã€‚
    

> **æç¤ºï¼š** ä½¿ç”¨è‡ªç­¾ CA æ—¶ï¼Œå®¢æˆ·ç«¯è®¿é—®éœ€è¦ä¿¡ä»»è¯¥ CAã€‚å¼€å‘æˆ–ç®€å•æµ‹è¯•æ—¶å¯é€šè¿‡ `-k` ç»•è¿‡éªŒè¯ï¼›ç”Ÿäº§ç¯å¢ƒåº”å°† CA è¯ä¹¦åŠ å…¥å®¢æˆ·ç«¯ä¿¡ä»»åˆ—è¡¨ã€‚

ç»è¿‡ä»¥ä¸Šæ­¥éª¤ï¼ŒElasticsearch 8.18 ä¸‰èŠ‚ç‚¹é›†ç¾¤å·²æˆåŠŸéƒ¨ç½²ï¼Œå¹¶å¯ç”¨äº† TLS åŠ å¯†å’Œç”¨æˆ·è®¤è¯ï¼Œç¬¦åˆç”Ÿäº§ç¯å¢ƒè¦æ±‚ã€‚åç»­å¯æ ¹æ®éœ€æ±‚ä¼˜åŒ– JVM å †å¤§å°ã€ç›‘æ§é…ç½®ç­‰ã€‚

**å‚è€ƒæ–‡æ¡£ï¼š** Elasticsearch å®˜æ–¹éƒ¨ç½²æŒ‡å—å’Œå®‰å…¨é…ç½®æ–‡æ¡£ ([Disable swapping | Elastic Docs](https://www.elastic.co/guide/en/elasticsearch/reference/current/setup-configuration-memory.html#:~:text=Swapping%20is%20very%20bad%20for,operating%20system%20kill%20the%20node)) ([Install Elasticsearch from archive on Linux or MacOS | Elastic Docs](https://www.elastic.co/docs/deploy-manage/deploy/self-managed/install-elasticsearch-from-archive-on-linux-macos#:~:text=wget%20https%3A%2F%2Fartifacts.elastic.co%2Fdownloads%2Felasticsearch%2Felasticsearch,9.0.0)) ([elasticsearch-certutil | Elastic Documentation](https://www.elastic.co/docs/reference/elasticsearch/command-line-tools/certutil#:~:text=When%20your%20YAML%20file%20is,For%20example)) ([Bootstrapping a cluster | Elastic Docs](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-bootstrap-cluster.html#:~:text=The%20initial%20set%20of%20master,eligible%20node)) ([Set up HTTPS | Elastic Docs](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-basic-setup-https.html#:~:text=2,TLS%20certificates%20for%20your%20nodes)) ([elasticsearch-setup-passwords | Elastic Documentation](https://www.elastic.co/guide/en/elasticsearch/reference/current/setup-passwords.html#:~:text=Deprecated%20in%208))ã€‚







å¥½é—®é¢˜ï¼ï¼  
åˆ›å»º Elasticsearchï¼ˆESï¼‰ç´¢å¼•æ—¶ï¼Œå…¶å®å°±åƒæ˜¯åœ¨å»ºä¸€æ ‹æ¥¼ï¼Œå¾—è€ƒè™‘å¥½å›¾çº¸ã€ææ–™ã€æ‰¿é‡ã€å¸ƒå±€ï¼Œä¸èƒ½éšä¾¿ä¹±ç›–ï¼ğŸ—ï¸  
æˆ‘ç»™ä½ æ€»ç»“æˆå‡ å¤§å—ï¼Œé€šä¿—+å¸¦ç‚¹å°å¹½é»˜è¯´ä¸€ä¸‹ï¼š

---

### 1. **ç´¢å¼•åç§°**ï¼ˆèµ·åå­—å¯ä¸æ˜¯å°äº‹ï¼‰

- **è¦æ±‚å°å†™**ï¼Œä¸èƒ½æœ‰ç©ºæ ¼ã€‚
    
- æœ€å¥½èƒ½è¡¨è¾¾æ¸…æ¥šç”¨é€”ï¼Œæ¯”å¦‚ï¼š`user_data_2025`ã€`order_logs_prod`ã€‚
    
- é¿å…åå­—å¤ªé•¿æˆ–å¤ªçŸ­ï¼Œåˆ«ä¸€çœ¼çœ‹ä¸å‡ºæ˜¯å•¥ã€‚
    

ğŸ‘‰ å°å»ºè®®ï¼šå¯ä»¥åŠ ä¸Šæ—¥æœŸã€ç¯å¢ƒæ ‡è¯†ï¼ˆdevã€prodï¼‰è¿™äº›å‰ç¼€åç¼€ï¼Œæ–¹ä¾¿ç®¡ç†ã€‚

---

### 2. **åˆ†ç‰‡å’Œå‰¯æœ¬æ•°é‡**ï¼ˆå»ºæ¥¼è¦æƒ³å¥½æˆ¿é—´æ€ä¹ˆåˆ†ï¼‰

- **ä¸»åˆ†ç‰‡ï¼ˆPrimary Shardï¼‰**ï¼šå†³å®šäº†ä½ çš„æ•°æ®å¦‚ä½•åˆ†å¼€å­˜ã€‚
    
- **å‰¯æœ¬åˆ†ç‰‡ï¼ˆReplica Shardï¼‰**ï¼šå¤‡ä»½ç”¨çš„ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½ï¼ŒèŠ‚ç‚¹æŒ‚äº†ä¹Ÿä¸æ€•ã€‚
    

ğŸ”µ å¸¸è§„å¥—è·¯ï¼š

- å°é¡¹ç›®æµ‹è¯•ï¼š`1ä¸»0å‰¯`
    
- æ­£å¼ç”Ÿäº§ï¼šçœ‹æ•°æ®é‡ï¼Œå‡ Gçš„å°æ•°æ®å¯ä»¥`1ä¸»1å‰¯`ï¼Œå‡ åG/ä¸ŠTçš„æ•°æ®è¦å¤šä¸»åˆ†ç‰‡ã€‚
    

âš¡ é‡è¦æç¤ºï¼š**ä¸»åˆ†ç‰‡æ•°ä¸€æ—¦å»ºå¥½ï¼Œå°±ä¸èƒ½æ”¹äº†ï¼ï¼ï¼ï¼ˆé™¤éç”¨ Reindexï¼‰**

---

### 3. **Mappingï¼ˆå­—æ®µå®šä¹‰ï¼‰**ï¼ˆç›–æ¥¼å¾—å…ˆå®šæ¯å±‚å¹²å•¥ï¼‰

- æ˜ç¡®æ¯ä¸ªå­—æ®µçš„æ•°æ®ç±»å‹ï¼Œæ¯”å¦‚ï¼š
    
    - `keyword`ï¼šé€‚åˆåšç²¾ç¡®åŒ¹é…ï¼ˆæ¯”å¦‚ç”¨æˆ·åã€IDï¼‰
        
    - `text`ï¼šé€‚åˆåšå…¨æ–‡æœç´¢ï¼ˆæ¯”å¦‚è¯„è®ºå†…å®¹ã€å•†å“æè¿°ï¼‰
        
    - `date`ã€`integer`ã€`boolean`ç­‰å…¶ä»–å¸¸ç”¨åŸºæœ¬ç±»å‹
        
- **ç¦æ‰ dynamic mapping**ï¼Œæˆ–è€…è®¾ç½®æˆ `strict`ï¼Œé˜²æ­¢æ•°æ®ä¹±é£ï¼š
    
    ```json
    {
      "mappings": {
        "dynamic": "strict",
        "properties": {
          "username": { "type": "keyword" },
          "age": { "type": "integer" },
          "bio": { "type": "text" }
        }
      }
    }
    ```
    

ğŸ‘‰ å¦‚æœä¸å°å¿ƒå¿˜äº†å®šä¹‰ï¼ŒESè‡ªå·±çŒœï¼Œæœ‰æ—¶å€™çŒœå¾—ä½ å¤´å¤§â€¦â€¦

---

### 4. **è®¾ç½®ï¼ˆsettingsï¼‰**ï¼ˆç›–æ¥¼æ—¶çš„æ–½å·¥ç»†èŠ‚ï¼‰

- æ¯”å¦‚ï¼š
    
    - `number_of_shards`
        
    - `number_of_replicas`
        
    - åˆ†è¯å™¨ï¼ˆanalyzerï¼‰ï¼šä¸­æ–‡éœ€è¦åŠ è‡ªå®šä¹‰åˆ†è¯å™¨ï¼Œæ¯”å¦‚ `ik_smart`ã€`ik_max_word`
        
    - åˆ·æ–°æ—¶é—´ï¼ˆ`refresh_interval`ï¼‰ï¼šå½±å“å†™å…¥æ€§èƒ½ï¼Œå†™å¤šè¯»å°‘æ—¶å¯ä»¥é€‚å½“å»¶é•¿ã€‚
        

---

### 5. **ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆILMï¼‰**ï¼ˆæ¥¼å»ºå¥½äº†ä¹Ÿè¦è€ƒè™‘å¯¿å‘½ï¼‰

- ä¸æ˜¯æ‰€æœ‰æ•°æ®éƒ½è¦ä¸€ç›´å­˜ç€ï¼Œæ¯”å¦‚æ—¥å¿—ã€ä¸´æ—¶æ•°æ®ï¼Œå¯ä»¥è®¾ç½®ï¼š
    
    - è¿‡æœŸååˆ é™¤
        
    - å†·çƒ­åˆ†å±‚å­˜å‚¨
        
    - è‡ªåŠ¨è½¬ç§»åˆ°ä½é€Ÿç£ç›˜
        

ğŸ‘‰ é˜²æ­¢ç¡¬ç›˜çˆ†ç‚¸ï¼Œæ•‘å‘½ç¥å™¨ï¼

---

### 6. **ç‰ˆæœ¬å…¼å®¹æ€§**

- Elasticsearchç‰ˆæœ¬ä¸åŒï¼ŒAPIç»†èŠ‚ä¹Ÿä¼šä¸åŒã€‚
    
- Mappingç»“æ„ã€å­—æ®µé™åˆ¶ã€åŠ¨æ€æ¨¡æ¿éƒ½æœ‰å¯èƒ½å˜åŒ–ã€‚
    

ï¼ˆæ¯”å¦‚8.xå’Œ7.xä¹‹é—´å°±æœ‰å¾ˆå¤šç ´åæ€§æ›´æ–°ï¼‰

---

### 7. **é¢å¤–çš„å°å¿ƒæ€ï¼ˆé«˜çº§æ“ä½œï¼‰**

- **Routing**ï¼šè‡ªå®šä¹‰æ•°æ®è·¯ç”±ï¼Œæ§åˆ¶æ•°æ®è½åœ¨å“ªä¸ªåˆ†ç‰‡ã€‚
    
- **Aliasï¼ˆåˆ«åï¼‰**ï¼šç»™ç´¢å¼•èµ·ä¸ªâ€œè‰ºåâ€ï¼Œæ–¹ä¾¿å‡çº§ä¸æ”¹ä»£ç ã€‚
    
- **Templateï¼ˆæ¨¡æ¿ï¼‰**ï¼šä¸€é”®åº”ç”¨ä¸€å¤§å †ç´¢å¼•è§„åˆ™ï¼Œçœäº‹å„¿ï¼
    

---

æ€»ç»“ä¸€ç‰ˆè¶…è½»é‡å¿ƒæ³•ç»™ä½ ï¼š

> åå­—è¦è§„èŒƒï¼Œåˆ†ç‰‡è¦åˆç†ï¼ŒMappingè¦æ¸…æ™°ï¼Œè®¾ç½®è¦å‘¨åˆ°ï¼Œç”Ÿå‘½å‘¨æœŸè¦è§„åˆ’ï¼Œç‰ˆæœ¬è¦å…¼å®¹ã€‚

---

è¦ä¸è¦æˆ‘é¡ºä¾¿ç»™ä½ ä¸¾ä¸ª**å®Œæ•´ç´¢å¼•åˆ›å»ºç¤ºä¾‹**ï¼ŸğŸ¤” æ¯”å¦‚æ¥ä¸€å¥—å¸¦ mappingã€settingsã€åˆ†è¯å™¨çš„â€œç”¨æˆ·æ•°æ®ç´¢å¼•â€ï¼Œè¶…å®ç”¨çš„é‚£ç§ï½  
è¦çš„è¯ç›´æ¥è¯´â€œæ¥ä¸€ä¸ªâ€ï¼ğŸš€



å¥½çš„ï¼Œæˆ‘æ¥ç»™ä½ è¯¦ç»†è®²ä¸€ä¸‹è¿™ä¸ªéƒ¨åˆ†ï¼Œå°½é‡ç»“åˆä»£ç ç¤ºä¾‹ï¼Œè¿˜æœ‰ Reindex çš„å®æ“ã€‚

---

## ğŸ”¥ åˆ†ç‰‡ï¼ˆShardï¼‰å’Œå‰¯æœ¬ï¼ˆReplicaï¼‰è¯¦ç»†è§£é‡Š

åœ¨ Elasticsearchï¼ˆç®€ç§° ESï¼‰é‡Œï¼Œ**åˆ†ç‰‡**å°±åƒæ˜¯æ•°æ®åº“é‡Œçš„è¡¨åˆ†åŒºã€‚æ•°æ®å¤ªå¤§ï¼Œæ”¾ä¸ä¸‹ä¸€å°æœºå™¨ï¼Œå°±æŒ‰åˆ†ç‰‡å­˜ä¸åŒåœ°æ–¹ã€‚

- **ä¸»åˆ†ç‰‡ï¼ˆPrimary Shardï¼‰**ï¼šå­˜çœŸå®æ•°æ®ï¼Œå¿…é¡»æœ‰ï¼
    
- **å‰¯æœ¬åˆ†ç‰‡ï¼ˆReplica Shardï¼‰**ï¼šä¸»åˆ†ç‰‡çš„æ‹·è´ã€‚å¯ä»¥æé«˜ï¼š
    
    - **é«˜å¯ç”¨æ€§**ï¼ˆä¸»æŒ‚äº†å‰¯æœ¬é¡¶ä¸Šï¼‰
        
    - **æŸ¥è¯¢æ€§èƒ½**ï¼ˆè¯»è¯·æ±‚å¯ä»¥èµ°å‰¯æœ¬ï¼‰
        

### ğŸ“¦ ä¸€ä¸ª Index çš„å­˜å‚¨ç¤ºæ„å›¾ï¼š

æ¯”å¦‚ï¼š

```
index: products
ä¸»åˆ†ç‰‡æ•°ï¼š3
å‰¯æœ¬æ•°ï¼š1
```

é‚£ä¹ˆç³»ç»Ÿä¼šç”Ÿæˆï¼š

- 3ä¸ªä¸»åˆ†ç‰‡
    
- æ¯ä¸ªä¸»åˆ†ç‰‡å¯¹åº”1ä¸ªå‰¯æœ¬
    

æ€»å…±æ˜¯ï¼š`3ï¼ˆä¸»ï¼‰+ 3ï¼ˆå‰¯æœ¬ï¼‰ = 6ä¸ª shard`ã€‚

---

## ğŸ› ï¸ å¦‚ä½•è®¾ç½®åˆ†ç‰‡å’Œå‰¯æœ¬ï¼Ÿï¼ˆå»ºç´¢å¼•çš„æ—¶å€™ï¼‰

**å»ºç´¢å¼•**æ—¶ï¼Œåˆ†ç‰‡æ•°ã€å‰¯æœ¬æ•°æ˜¯å¯ä»¥ç›´æ¥è®¾ç½®çš„ã€‚

```bash
PUT /products
{
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1
  }
}
```

- `number_of_shards`: ä¸»åˆ†ç‰‡æ•°
    
- `number_of_replicas`: æ¯ä¸ªä¸»åˆ†ç‰‡å¯¹åº”çš„å‰¯æœ¬æ•°
    

âš¡ **æ³¨æ„**ï¼š**ä¸»åˆ†ç‰‡æ•°é‡å»ºå¥½åå°±ä¸èƒ½æ”¹äº†ï¼ï¼**  
å‰¯æœ¬æ•°é‡å¯ä»¥åŠ¨æ€è°ƒæ•´ï¼ˆåé¢æ•™ä½ ï¼‰ã€‚

---

## ğŸš§ å‰¯æœ¬æ•°å¯ä»¥åŠ¨æ€æ”¹ï¼ç¤ºä¾‹ï¼š

å‡è®¾ä¸€å¼€å§‹è®¾ç½®äº†å‰¯æœ¬æ•°æ˜¯ `1`ï¼Œåæ¥æƒ³åŠ åˆ° `2`ï¼Œç›´æ¥æ›´æ–°å°±è¡Œï¼š

```bash
PUT /products/_settings
{
  "number_of_replicas": 2
}
```

è¿™ä¸ªä¸ä¼šå½±å“ä¸»åˆ†ç‰‡æ•°ï¼Œåªæ˜¯å¢åŠ å‰¯æœ¬æ•°é‡ã€‚

---

## âš™ï¸ ä¸»åˆ†ç‰‡æ•°ä¸€æ—¦å»ºå¥½ä¸èƒ½æ”¹æ€ä¹ˆåŠï¼ŸğŸ‘‰ Reindexï¼

**Reindex** = åˆ›å»ºä¸€ä¸ªæ–°ç´¢å¼•ï¼Œç„¶åæŠŠè€æ•°æ®è¿è¿‡å»ã€‚æ–°ç´¢å¼•å¯ä»¥é‡æ–°å®šä¹‰åˆ†ç‰‡æ•°ã€‚

æµç¨‹ç®€å•è®²ï¼š

1. åˆ›å»ºä¸€ä¸ªæ–°çš„ç´¢å¼•ï¼Œè®¾ç½®æ–°çš„åˆ†ç‰‡ã€å‰¯æœ¬
    
2. ç”¨ `_reindex` API æŠŠè€ç´¢å¼•æ•°æ®æ¬è¿‡å»
    
3. ï¼ˆå¯é€‰ï¼‰åˆ æ‰è€ç´¢å¼•
    
4. ï¼ˆå¯é€‰ï¼‰æ”¹åˆ«åæŒ‡åˆ°æ–°ç´¢å¼•ï¼ˆæ— ç¼åˆ‡æ¢ï¼‰
    

### ç¤ºä¾‹ï¼šReindexæ“ä½œ

å‡è®¾åŸæ¥æœ‰ä¸ª `products_old` ç´¢å¼•ï¼Œç°åœ¨è¦è°ƒæ•´åˆ†ç‰‡æ•°ï¼Œæ–°å»º `products_new`ï¼š

```bash
# 1. å»ºæ–°ç´¢å¼•
PUT /products_new
{
  "settings": {
    "number_of_shards": 5,
    "number_of_replicas": 1
  },
  "mappings": {
    "properties": {
      "name": { "type": "text" },
      "price": { "type": "float" }
    }
  }
}
```

---

```bash
# 2. Reindexæ•°æ®
POST /_reindex
{
  "source": {
    "index": "products_old"
  },
  "dest": {
    "index": "products_new"
  }
}
```

---

```bash
# 3. ï¼ˆå¯é€‰ï¼‰åˆ æ‰æ—§ç´¢å¼•
DELETE /products_old
```

---

```bash
# 4. ï¼ˆå¯é€‰ï¼‰è®¾ç½®åˆ«åï¼ŒæŒ‡å‘æ–°ç´¢å¼•
POST /_aliases
{
  "actions": [
    { "remove": { "index": "products_old", "alias": "products" }},
    { "add": { "index": "products_new", "alias": "products" }}
  ]
}
```

è¿™æ ·åº”ç”¨å±‚ï¼ˆæ¯”å¦‚ä½ çš„APIï¼‰å°±å¯ä»¥ç»§ç»­ç”¨ `products` è¿™ä¸ªåˆ«åï¼Œå®Œå…¨æ— æ„ŸçŸ¥åˆ‡æ¢ã€‚

---

## ğŸ¯ å°æ€»ç»“

|åœºæ™¯|æ¨èè®¾ç½®|
|:--|:--|
|å°å‹æµ‹è¯•é¡¹ç›®|`1ä¸»0å‰¯`|
|å°å‹ç”Ÿäº§é¡¹ç›®ï¼ˆå‡ Gæ•°æ®ï¼‰|`1ä¸»1å‰¯`|
|ä¸­å‹é¡¹ç›®ï¼ˆå‡ åGæ•°æ®ï¼‰|`3-5ä¸»ï¼Œ1-2å‰¯`|
|è¶…å¤§å‹é¡¹ç›®ï¼ˆç™¾G-ä¸ŠTï¼‰|çœ‹é›†ç¾¤è§„æ¨¡ï¼Œåˆç†åˆ†é…ï¼Œé€šå¸¸`5+`ä¸»åˆ†ç‰‡|

---

è¦ä¸è¦æˆ‘é¡ºä¾¿ç»™ä½ ç”»ä¸ªå›¾ï¼Ÿæ¯”å¦‚ Reindex æµç¨‹å›¾ï¼ŸğŸ‘€  
è¦çš„è¯å‘Šè¯‰æˆ‘ï½



å¥½çš„ï¼Œæˆ‘æ¥å¸®ä½ æ›´è¯¦ç»†ã€æ¸…æ™°åœ°è¡¨è¾¾ä¸€ä¸‹ï¼š

---

### ESä¸­çš„åˆ·æ–°æ—¶é—´ï¼ˆ`refresh_interval`ï¼‰

åœ¨Elasticsearchä¸­ï¼Œ`refresh_interval` æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„å‚æ•°ï¼Œæ§åˆ¶ç´¢å¼•ä¸­æ•°æ®ä»å†…å­˜ç¼“å†²åŒºåˆ·æ–°åˆ°ç£ç›˜ã€å¹¶å¯¹æœç´¢å¯è§çš„é¢‘ç‡ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯**å¤šä¹…å°†æ–°å†™å…¥çš„æ•°æ®"åˆ·"æˆå¯è¢«æœç´¢åˆ°çš„çŠ¶æ€**ã€‚

#### è¯¦ç»†è¯´æ˜ï¼š

- æ¯æ¬¡åˆ·æ–°ï¼ŒElasticsearch ä¼šæŠŠå†…å­˜ä¸­çš„æ–°æ–‡æ¡£å†™å…¥ä¸€ä¸ªæ–°çš„Luceneæ®µï¼ˆsegmentï¼‰ï¼Œå¹¶æ‰“å¼€è¿™ä¸ªæ®µä¾›æŸ¥è¯¢ä½¿ç”¨ã€‚
    
- åˆ·æ–°æ“ä½œæ˜¯**è½»é‡çº§**ä½†**ä»ç„¶æœ‰ä»£ä»·**çš„ï¼Œä¼šæ¶ˆè€—ä¸€å®šçš„IOã€CPUèµ„æºï¼Œå¹¶ä¸”é¢‘ç¹åˆ·æ–°ä¼šå¯¼è‡´ç”Ÿæˆå¤§é‡å°æ®µï¼Œä»è€Œå¼•å‘æ›´å¤šçš„åˆå¹¶ï¼ˆmergeï¼‰å¼€é”€ï¼Œè¿›è€Œå½±å“å†™å…¥æ€§èƒ½ã€‚
    

#### å½±å“ï¼š

- **åˆ·æ–°é¢‘ç‡é«˜ï¼ˆåˆ·æ–°é—´éš”çŸ­ï¼‰**
    
    - ä¼˜ç‚¹ï¼šæ–°å†™å…¥çš„æ•°æ®å‡ ä¹å¯ä»¥å®æ—¶æŸ¥è¯¢åˆ°ï¼ˆæ¥è¿‘å®æ—¶ï¼ŒReal-time Searchï¼‰ã€‚
        
    - ç¼ºç‚¹ï¼šç³»ç»Ÿå¼€é”€å¢åŠ ï¼Œå†™å…¥æ€§èƒ½ä¸‹é™ï¼Œç‰¹åˆ«æ˜¯åœ¨å†™å…¥é‡å¤§æ—¶ã€‚
        
- **åˆ·æ–°é¢‘ç‡ä½ï¼ˆåˆ·æ–°é—´éš”é•¿ï¼‰**
    
    - ä¼˜ç‚¹ï¼šå‡å°‘èµ„æºæ¶ˆè€—ï¼Œæé«˜å†™å…¥ååé‡ï¼Œé€‚åˆ**å†™å¤šè¯»å°‘**çš„åœºæ™¯ï¼Œæ¯”å¦‚æ—¥å¿—é‡‡é›†ã€æ‰¹é‡æ•°æ®å¯¼å…¥ã€‚
        
    - ç¼ºç‚¹ï¼šæ–°æ•°æ®éœ€è¦ç­‰å¾…æ›´é•¿æ—¶é—´æ‰èƒ½è¢«æ£€ç´¢åˆ°ã€‚
        

#### ä½¿ç”¨å»ºè®®ï¼š

- å¦‚æœåœºæ™¯æ˜¯**å†™å¤šè¯»å°‘**ï¼ˆä¾‹å¦‚æ—¥å¿—æ”¶é›†ã€æŒ‡æ ‡ä¸ŠæŠ¥ç­‰ï¼‰ï¼Œå¯ä»¥é€‚å½“**å»¶é•¿ `refresh_interval`**ï¼ˆæ¯”å¦‚è®¾ä¸º 30sã€1åˆ†é’Ÿï¼Œç”šè‡³æ›´é•¿ï¼‰ï¼Œä»¥ä¼˜åŒ–å†™å…¥æ€§èƒ½ã€‚
    
- å¦‚æœåœºæ™¯æ˜¯**è¯»å†™å¹¶é‡**æˆ–**è¯»å¤šå†™å°‘**ï¼ˆä¾‹å¦‚ç”µå•†å•†å“æ£€ç´¢ï¼‰ï¼Œåˆ™éœ€è¦ä¿æŒè¾ƒçŸ­çš„åˆ·æ–°é—´éš”ï¼ˆæ¯”å¦‚é»˜è®¤çš„ 1 ç§’ï¼‰ï¼Œç¡®ä¿æ•°æ®çš„å¯æœç´¢æ€§ã€‚
    

#### ç¤ºä¾‹é…ç½®ï¼š

```json
PUT /my-index/_settings
{
  "settings": {
    "refresh_interval": "30s"
  }
}
```

å¦‚æœä¸´æ—¶å†™å…¥å¤§é‡æ•°æ®ï¼ˆæ¯”å¦‚æ‰¹é‡å¯¼å…¥ï¼‰ï¼Œè¿˜å¯ä»¥åœ¨å¯¼å…¥æœŸé—´å°† `refresh_interval` è®¾ç½®ä¸º `-1`ï¼ˆå…³é—­åˆ·æ–°ï¼‰ï¼Œå¯¼å…¥å®Œæˆåå†æ¢å¤æ­£å¸¸çš„åˆ·æ–°é—´éš”ã€‚

ä¾‹å¦‚ï¼š

```bash
# å…³é—­åˆ·æ–°
PUT /my-index/_settings
{
  "settings": {
    "refresh_interval": "-1"
  }
}

# æ‰¹é‡å†™å…¥æ•°æ®...

# æ¢å¤åˆ·æ–°
PUT /my-index/_settings
{
  "settings": {
    "refresh_interval": "1s"
  }
}
```

---

è¦ä¸è¦æˆ‘é¡ºä¾¿å¸®ä½ è¡¥å……ä¸€ä¸‹ `refresh_interval` å’Œ `flush`ã€`merge` ç­‰å…¶ä»–æ¦‚å¿µçš„å…³ç³»ï¼Ÿå¦‚æœä½ æ˜¯å‡†å¤‡åšåˆ†äº«æˆ–è€…å†™æ–‡æ¡£çš„è¯ï¼Œè¿™æ ·å†…å®¹ä¼šæ›´å®Œæ•´ä¸€ç‚¹ã€‚è¦ç»§ç»­å—ï¼Ÿ








å…³äº **Elasticsearch çš„åˆ†åŒºï¼ˆshardï¼‰å’Œå‰¯æœ¬ï¼ˆreplicaï¼‰æ•°é‡è®¾ç½®**ï¼Œç¡®å®æ˜¯æœ‰ä¸€äº›**å¸¸è§è§„å¾‹**å’Œ**æ¨èåŸåˆ™**çš„ã€‚ç»™ä½ æ€»ç»“å¦‚ä¸‹ï¼š

---

# ğŸ“¦ åˆ†åŒºæ•°é‡ï¼ˆ`number_of_shards`ï¼‰

- **æ¯ä¸ª shard æœ€ç†æƒ³çš„æ•°æ®é‡**ï¼š**10GB ï½ 50GB** å·¦å³ã€‚
    
    - å¤ªå° â†’ æµªè´¹èµ„æºï¼ˆå¤ªå¤šç¢ç‰‡ï¼Œå†…å­˜å’Œç®¡ç†å¼€é”€å¤§ï¼‰
        
    - å¤ªå¤§ â†’ æŸ¥è¯¢æ…¢ï¼Œæ¢å¤æ…¢ï¼ˆè¶…å¤§ shard æ¢å¤æ—¶é—´é•¿ï¼‰
        
- **åˆå§‹ä¼°ç®—å…¬å¼**ï¼ˆå¸¸ç”¨ï¼‰ï¼š
    
    ```
    æ€»æ•°æ®é‡ / æ¯ä¸ª shard ç†æƒ³å¤§å° = shard æ€»æ•°
    ```
    
    å†ç»“åˆé›†ç¾¤èŠ‚ç‚¹æ•°é‡åˆç†åˆ†é…ã€‚
    
- **ç»éªŒå»ºè®®**ï¼š
    
    |åœºæ™¯|åˆ†åŒºæ•°é‡å»ºè®®|
    |:--|:--|
    |å°å‹é¡¹ç›®ï¼ˆå‡  GB ï½å‡ å GBï¼‰|é€šå¸¸è®¾ 1ï½5 ä¸ª shard å°±å¤Ÿäº†|
    |ä¸­å‹é¡¹ç›®ï¼ˆå‡ ç™¾ GB ï½å‡  TBï¼‰|æ ¹æ®èŠ‚ç‚¹æ•°é‡ã€æ•°æ®é‡é¢„ä¼°ï¼Œé€šå¸¸ 10ï½50 ä¸ª shard|
    |å¤§å‹é¡¹ç›®ï¼ˆæ•° TB ä»¥ä¸Šï¼‰|æ›´ç»†è‡´åˆ†åŒºï¼Œä½†æ³¨æ„ shard æ€»é‡ä¸è¦å¤ªå¤¸å¼ ï¼ˆå»ºè®®å•é›†ç¾¤ shard æ€»æ•°ï¼œ2ä¸‡ï¼‰|
    
- **æ³¨æ„äº‹é¡¹**ï¼š
    
    - shard æ•°é‡ä¸å¯åŠ¨æ€å‡å°‘ï¼ˆåªèƒ½å¢åŠ ï¼‰ï¼Œæ‰€ä»¥**å®å¯åˆæœŸå°‘é…ï¼ŒåæœŸç”¨ reindex è°ƒæ•´**ã€‚
        
    - è¿‡å¤šçš„å° shardï¼ˆæ¯ä¸ª shard å¾ˆå°ï¼‰ä¼šå¯¼è‡´ **small shard problem** â†’ é›†ç¾¤æ€§èƒ½ä¸‹é™ã€‚
        
    - å…¸å‹é”™è¯¯ï¼šæ¯å¤©å»ºä¸€ä¸ªæ–°ç´¢å¼•ï¼Œè¿˜è®¾å¾ˆå¤š shardï¼Œçˆ†ç‚¸å¢é•¿ã€‚ï¼ˆå°¤å…¶æ˜¯æ—¶é—´åºåˆ—æ•°æ®ï¼‰
        

---

# ğŸ›¡ å‰¯æœ¬æ•°é‡ï¼ˆ`number_of_replicas`ï¼‰

- **å‰¯æœ¬ä½œç”¨**ï¼š
    
    - å®¹ç¾ï¼šä¸»èŠ‚ç‚¹æŒ‚äº†å¯ä»¥å¿«é€Ÿåˆ‡æ¢
        
    - è¯»æ‰©å±•ï¼šå‰¯æœ¬ä¹Ÿå¯ä»¥æ‰¿æ‹…æŸ¥è¯¢è¯·æ±‚ï¼Œæå‡æŸ¥è¯¢å¹¶å‘æ€§èƒ½
        
- **å¸¸è§„è®¾ç½®**ï¼š
    
    - **ç”Ÿäº§ç¯å¢ƒå¸¸è§„ï¼š`1` å‰¯æœ¬**
        
        - ä¹Ÿå°±æ˜¯æ¯ä¸ª shard æœ‰ 1 ä»½å¤‡ä»½ï¼ˆä¸»+1å‰¯ï¼‰
            
    - **å¼€å‘ç¯å¢ƒæˆ–æµ‹è¯•ç¯å¢ƒï¼š`0` å‰¯æœ¬**
        
        - çœèµ„æºï¼Œä¸éœ€è¦é«˜å¯ç”¨
            
    - **é«˜å¯ç”¨è¦æ±‚æé«˜çš„åœºæ™¯ï¼š2 æˆ–æ›´å¤šå‰¯æœ¬**
        
        - æ¯”å¦‚é‡‘èã€æ”¿åŠ¡ã€æ ¸å¿ƒç³»ç»Ÿ
            
- **å‰¯æœ¬æ•°é‡ä¸èŠ‚ç‚¹æ•°é‡å…³ç³»**ï¼š
    
    - **å‰¯æœ¬æ•° + 1 â‰¤ èŠ‚ç‚¹æ•°**  
        ï¼ˆå› ä¸ºä¸»åˆ†ç‰‡å’Œå‰¯æœ¬ä¸èƒ½åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼‰
        
        - ä¸¾ä¾‹ï¼š
            
            - 3èŠ‚ç‚¹ï¼Œæœ€å¤šå¯ä»¥è®¾ 2 å‰¯æœ¬
                
            - 2èŠ‚ç‚¹ï¼Œæœ€å¤š 1 å‰¯æœ¬
                
            - 1èŠ‚ç‚¹ï¼ˆå•æœºï¼‰åªèƒ½è®¾ 0 å‰¯æœ¬æˆ–1å‰¯æœ¬ï¼ˆå®é™…æ— æ„ä¹‰ï¼‰
                

---

# âš¡ å¿«é€Ÿæ€»ç»“ä¸€å¥è¯

> **åˆ†åŒºæ•°é‡çœ‹æ•°æ®é‡ï¼Œå‰¯æœ¬æ•°é‡çœ‹é«˜å¯ç”¨éœ€æ±‚ã€‚**
> 
> å°æ•°æ®å°‘åˆ†ç‰‡ï¼Œå¤§æ•°æ®å¤šåˆ†ç‰‡ï¼ŒèŠ‚ç‚¹å¤šå¯é€‚å½“å¤šå‰¯æœ¬ã€‚

---

# ğŸ”¥ ä¸¾ä¾‹ï¼ˆçœŸå®åœºæ™¯ï¼‰

|åœºæ™¯|number_of_shards|number_of_replicas|
|:--|:--|:--|
|å°é¡¹ç›®ï¼ˆå‡  GBï¼‰|1ï½3|1|
|ä¸­å‹ç³»ç»Ÿï¼ˆ500GBï¼‰|5ï½10|1|
|å¤§å‹æœç´¢å¼•æ“ï¼ˆ10TBä»¥ä¸Šï¼‰|50ï½100ï¼ˆæ ¹æ®èŠ‚ç‚¹æ•°ï¼‰|1 æˆ– 2|
|æ—¥å¿—ç³»ç»Ÿï¼ˆæ¯å¤©æ–°å»ºç´¢å¼•ï¼‰|æ¯å¤© 1 ç´¢å¼• 1ï½5 shard|1|

---

å¦‚æœä½ æ„¿æ„å‘Šè¯‰æˆ‘ä½ å…·ä½“çš„**é›†ç¾¤è§„æ¨¡ï¼ˆèŠ‚ç‚¹æ•°ï¼‰**ã€**é¢„è®¡æ•°æ®é‡**ã€**è¯»å†™æ¯”ä¾‹**ï¼Œæˆ‘å¯ä»¥å¸®ä½ æ›´ç²¾å‡†åœ°æ¨èä¸€ä¸ªé…ç½®ï¼è¦ä¸è¦ç»§ç»­ï¼ŸğŸš€  
ï¼ˆæ¯”å¦‚ï¼šâ€œæˆ‘æœ‰3èŠ‚ç‚¹ï¼Œé¢„è®¡å­˜500GBï¼Œä¸€å¤©å†™å…¥10ä¸‡æ¡æ•°æ®ï¼Œè¯»æ¯”è¾ƒå¤šâ€ï¼Œç±»ä¼¼è¿™æ ·ï¼‰





![](image-20250427141955983.png)



Spring IOC
![](image-20250411081900692.png)





![](image-20250404143126869.png)


éš¾é“è¿œç¨‹æ“ä½œï¼Œåªèƒ½åˆ° ~ï¼Ÿï¼Ÿï¼Ÿ

![](image-20250404143521283.png)



å˜¿å˜¿å˜¿ï¼Œä¸æ˜¯