---
title: 笔记：本地图库小工具
date: 2025-06-16
categories:
  - 自研小工具
  - 本地图库小工具
tags: 
author: 霸天
layout: post
---
## 1. 创建存放图片的目录

目录路径：D:\文件集合\本地图库，向内存放一些图片

----


## 2. 编写 Py 代码

创建 `本地图库.py` 并编写代码：
```
import os
import threading
import random
from flask import Flask, send_from_directory, abort

app = Flask(__name__)
IMAGE_FOLDER = r'D:\文件集合\本地图库'
image_map = {}

def load_images():
    images = {}
    for filename in os.listdir(IMAGE_FOLDER):
        if filename.lower().endswith(('.jpg', '.jpeg', '.png', '.gif')):
            name = os.path.splitext(filename)[0]
            images[name] = filename
    return images

def refresh_images_periodically(interval=300):
    global image_map
    image_map = load_images()
    # 设定下一次5分钟后调用自己，实现循环
    threading.Timer(interval, refresh_images_periodically).start()

@app.route('/image/<name>')
def get_image(name):
    if name == 'random':
        if not image_map:
            abort(404)
        filename = random.choice(list(image_map.values()))
        return send_from_directory(IMAGE_FOLDER, filename)
    else:
        filename = image_map.get(name)
        if filename:
            return send_from_directory(IMAGE_FOLDER, filename)
        else:
            abort(404)

if __name__ == '__main__':
    # 启动时先扫描一次图片
    image_map = load_images()
    # 启动定时刷新任务，300秒即5分钟
    refresh_images_periodically(300)
    app.run(host='127.0.0.1', port=5000)
```

> [!NOTE] 注意事项
> 1. 安装 flask 依赖：
```
pip install flask -i https://pypi.tuna.tsinghua.edu.cn/simple
```

----


## 3. 打包为 exe

```
# 1. 安装打包工具
pip install pyinstaller


# 2. 打包代码
pyinstaller --onefile --windowed --icon="D:\文件集合\ICO\本地图库.ico" --distpath "D:\文件集合" "D:\文件集合\本地图库.py"
"""
1. --onefile
	1. 打包为单个 .exe 文件。
2. --windowed
	1. 确保 GUI 程序无控制台窗口
3. --distpath "D:\文件集合\"  "D:\文件集合\本地图库.py"
	1. D:\文件集合\ 是输出位置
	2. D:\文件集合\本地图库.py 是输入位置
"""
```

----


## 5. 获取本地图库中的图片

访问：
1. http://127.0.0.1:5000/image/image-name
2. http://127.0.0.1:5000/image/random

> [!NOTE] 注意事项
> 1. 无需带后缀，例如 `.jpg`、`.png` 等

----





下面给你一套通用的方案，把你的 Flask 脚本上传到 Ubuntu 云服务器并且实现开机自启动。

---

## 一、把脚本和图片目录传到云服务器

1. **打包代码**（在本地）
    
    ```bash
    cd D:\文件集合\本地图库
    rem 假设你的脚本叫 image_server.py，打包成 zip
    powershell Compress-Archive -Path image_server.py -DestinationPath image_server.zip
    ```
    
2. **用 SCP 上传到云服务器**（在本地 PowerShell 或 CMD）
    
    ```bash
    scp image_server.zip root@117.72.211.221:/home/root/
    ```
    
3. **解压并调整路径**（在云服务器）
    
    ```bash
    cd /home/root
    unzip image_server.zip
    mv 本地图库 /home/root/images          # 把 Windows 路径改成 Linux 目录
    sed -i 's|IMAGE_FOLDER = .\+|IMAGE_FOLDER = r"/home/root/images"|' image_server.py
    ```
    

---

## 二、配置 Python 环境

```bash
# 安装 Python3 与 venv
sudo apt update
sudo apt install -y python3 python3-venv

# 进入项目目录，创建虚拟环境


cd /home/root
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install flask
```

测试脚本能跑通：

```bash
python image_server.py
# 浏览器或 curl http://127.0.0.1:5000/image/random
```

确认返回图片正常后，按下一步。

---

## 三、用 systemd 把它做成服务，随开机启动

1. **创建 systemd 单元文件**  
    编辑 `/etc/systemd/system/images.service`，内容如下（确保路径和用户都换成实际值）：
    
```ini
    [Unit]
    Description=Flask Image Server
    After=network.target
    
    [Service]
    Type=simple
    WorkingDirectory=/home/root
    User=root
    # 激活虚拟环境并运行脚本
    ExecStart=/home/root/venv/bin/python /home/root/image_server.py
    Restart=on-failure
    RestartSec=5s
    
    [Install]
    WantedBy=multi-user.target
```
    
2. **让 systemd 识别并启动**
    
```bash
    sudo systemctl daemon-reload
    sudo systemctl enable images.service
    sudo systemctl start images.service
```
    
3. **检查状态 & 日志**
    
```bash
    sudo systemctl status image_server.service
    sudo journalctl -u image_server.service -f
```
    

---

### 四、（可选）使用 Gunicorn + Nginx 提升稳定性

如果你后续想放到公网并承载更高并发，建议用 [Gunicorn] + [Nginx]：

1. `pip install gunicorn`
    
2. 在 systemd 的 `ExecStart` 改成：
    
```
    ExecStart=/home/root/venv/bin/gunicorn -w 4 -b 127.0.0.1:5000 image_server:app
```
    
3. 配置 Nginx 反向代理 `/etc/nginx/sites-available/image_server`：
    
```nginx
server {
	listen 80;
	server_name your.domain.com;

	location / {
		proxy_pass http://127.0.0.1:5000;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
	}
}
```
    
    然后 `sudo ln -s … && sudo nginx -t && sudo systemctl reload nginx`。
    

---

这样，每次服务器重启后，你的 Flask 程序都会自动启动并监听 `127.0.0.1:5000`（或通过 Nginx 暴露）。如果有疑问，随时告诉我！





下面按照你最新的目录结构，给出一套完整的操作流程（Word 式标准步骤，不使用 Markdown）：

1. 修改脚本中图片目录路径  
    1.1 用编辑器打开 `/mystudy/images/images.py`  
    1.2 将文件顶部的
    
```
    IMAGE_FOLDER = r'D:\文件集合\本地图库'
```
    
改为
    
```
    IMAGE_FOLDER = '/mystudy/images/images'
```
    
1.3 保存并退出
    
2. 准备 Python 虚拟环境  
    2.1 在服务器上切换到脚本目录  
    cd /mystudy/images  
    2.2 创建并激活虚拟环境  
    python3 -m venv venv  
    source venv/bin/activate  
    2.3 安装依赖  
    pip install flask
    
3. 本地运行测试  
    3.1 确认脚本能正确启动  
    python images.py  
    3.2 在另一终端执行  
    curl [http://127.0.0.1:5000/image/random](http://127.0.0.1:5000/image/random)  
    ——若能返回图片，说明一切正常  
    3.3 按 Ctrl-C 停止服务
    
4. 为脚本创建 systemd 服务  
    4.1 新建文件 `/etc/systemd/system/images.service`，内容如下（请逐字复制）
    
```
[Unit]
Description=Flask Image Server
After=network.target

[Service]
Type=simple
WorkingDirectory=/mystudy/images
User=root
ExecStart=/mystudy/images/venv/bin/python /mystudy/images/images.py
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
```
    
4.2 保存后执行  
systemctl daemon-reload  
systemctl enable images.service  
systemctl start images.service

5. 验证服务状态  
5.1 查看运行状态  
systemctl status images.service  
——应显示 Active: active (running)  
5.2 查看实时日志  
journalctl -u images.service -f  
5.3 浏览器或 curl 测试  
curl [http://127.0.0.1:5000/image/random](http://127.0.0.1:5000/image/random)


完成以上步骤后，每次服务器重启，Flask 脚本都会自动启动并监听本机 5000 端口。




非常好，现在你的 Flask 服务已经 **成功启动并由 systemd 托管**，状态信息显示一切正常：

```
Active: active (running)
* Running on http://127.0.0.1:5000
```

### ✅ 下一步检查

你可以在云服务器上试一下：

```bash
curl http://127.0.0.1:5000/image/random
```

如果你看到一大串乱码（二进制图片），说明服务正常。

```
root@lavm-2xqib0dtxy:~# curl http://127.0.0.1:5000/image/random
Warning: Binary output can mess up your terminal. Use "--output -" to tell 
Warning: curl to output it to your terminal anyway, or consider "--output 
Warning: <FILE>" to save to a file.

```

---

### 🌐 如果你想让外部访问这个服务，有两个选项：

#### ✅ 方式 1：修改 Flask 监听公网

1. 修改 `/mystudy/images/images.py`：
    
    ```python
    app.run(host='0.0.0.0', port=5000)
    ```
    
2. 重启服务：
    
    ```bash
    sudo systemctl restart images.service
    ```
    
3. 确保你的云服务器防火墙/安全组已开放 **5000端口（TCP）**，你可以用：
    
    ```bash
    sudo ufw allow 5000/tcp
    ```
    
4. 现在你可以在任意机器上访问：
    
    ```
    http://你的云服务器IP:5000/image/random
    ```
    

---

#### ✅ 方式 2：保留内网监听 + 用 Nginx 转发（推荐）

更安全、专业的做法是：

1. Flask 保持监听 127.0.0.1:5000（不用修改）
    
2. 安装并配置 Nginx 转发外部请求到 Flask：
    
    ```bash
    sudo apt install nginx
    ```
    
3. 编辑配置文件 `/etc/nginx/sites-available/images`：
    
    ```
    server {
        listen 80;
        server_name your_domain_or_ip;
    
        location / {
            proxy_pass http://127.0.0.1:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
    ```
    
4. 启用站点并重启 Nginx：
    
    ```bash
    sudo ln -s /etc/nginx/sites-available/images /etc/nginx/sites-enabled/
    sudo nginx -t
    sudo systemctl reload nginx
    ```
    

然后你就可以通过：

```
http://你的云服务器IP/
```

来访问 Flask 提供的服务了。

---

你目前的部署状态已经 90% 完成，下一步就看你是希望「公网访问图片」，还是「本地脚本调用」来做什么用，如果需要我可以帮你继续优化部署结构。要不要我顺便也把 Gunicorn/Nginx 一起给你配置好？


访问： http://117.72.211.221:5000/image/random


