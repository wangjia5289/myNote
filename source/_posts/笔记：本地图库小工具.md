---
title: ç¬”è®°ï¼šæœ¬åœ°å›¾åº“å°å·¥å…·
date: 2025-06-16
categories:
  - è‡ªç ”å°å·¥å…·
  - æœ¬åœ°å›¾åº“å°å·¥å…·
tags: 
author: éœ¸å¤©
layout: post
---
## 1. åˆ›å»ºå­˜æ”¾å›¾ç‰‡çš„ç›®å½•

ç›®å½•è·¯å¾„ï¼šD:\æ–‡ä»¶é›†åˆ\æœ¬åœ°å›¾åº“ï¼Œå‘å†…å­˜æ”¾ä¸€äº›å›¾ç‰‡

----


## 2. ç¼–å†™ Py ä»£ç 

åˆ›å»º `æœ¬åœ°å›¾åº“.py` å¹¶ç¼–å†™ä»£ç ï¼š
```
import os
import threading
import random
from flask import Flask, send_from_directory, abort

app = Flask(__name__)
IMAGE_FOLDER = r'D:\æ–‡ä»¶é›†åˆ\æœ¬åœ°å›¾åº“'
image_map = {}

def load_images():
    images = {}
    for filename in os.listdir(IMAGE_FOLDER):
        if filename.lower().endswith(('.jpg', '.jpeg', '.png', '.gif')):
            name = os.path.splitext(filename)[0]
            images[name] = filename
    return images

def refresh_images_periodically(interval=300):
    global image_map
    image_map = load_images()
    # è®¾å®šä¸‹ä¸€æ¬¡5åˆ†é’Ÿåè°ƒç”¨è‡ªå·±ï¼Œå®ç°å¾ªç¯
    threading.Timer(interval, refresh_images_periodically).start()

@app.route('/image/<name>')
def get_image(name):
    if name == 'random':
        if not image_map:
            abort(404)
        filename = random.choice(list(image_map.values()))
        return send_from_directory(IMAGE_FOLDER, filename)
    else:
        filename = image_map.get(name)
        if filename:
            return send_from_directory(IMAGE_FOLDER, filename)
        else:
            abort(404)

if __name__ == '__main__':
    # å¯åŠ¨æ—¶å…ˆæ‰«æä¸€æ¬¡å›¾ç‰‡
    image_map = load_images()
    # å¯åŠ¨å®šæ—¶åˆ·æ–°ä»»åŠ¡ï¼Œ300ç§’å³5åˆ†é’Ÿ
    refresh_images_periodically(300)
    app.run(host='127.0.0.1', port=5000)
```

> [!NOTE] æ³¨æ„äº‹é¡¹
> 1. å®‰è£… flask ä¾èµ–ï¼š
```
pip install flask -i https://pypi.tuna.tsinghua.edu.cn/simple
```

----


## 3. æ‰“åŒ…ä¸º exe

```
# 1. å®‰è£…æ‰“åŒ…å·¥å…·
pip install pyinstaller


# 2. æ‰“åŒ…ä»£ç 
pyinstaller --onefile --windowed --icon="D:\æ–‡ä»¶é›†åˆ\ICO\æœ¬åœ°å›¾åº“.ico" --distpath "D:\æ–‡ä»¶é›†åˆ" "D:\æ–‡ä»¶é›†åˆ\æœ¬åœ°å›¾åº“.py"
"""
1. --onefile
	1. æ‰“åŒ…ä¸ºå•ä¸ª .exe æ–‡ä»¶ã€‚
2. --windowed
	1. ç¡®ä¿ GUI ç¨‹åºæ— æ§åˆ¶å°çª—å£
3. --distpath "D:\æ–‡ä»¶é›†åˆ\"  "D:\æ–‡ä»¶é›†åˆ\æœ¬åœ°å›¾åº“.py"
	1. D:\æ–‡ä»¶é›†åˆ\ æ˜¯è¾“å‡ºä½ç½®
	2. D:\æ–‡ä»¶é›†åˆ\æœ¬åœ°å›¾åº“.py æ˜¯è¾“å…¥ä½ç½®
"""
```

----


## 5. è·å–æœ¬åœ°å›¾åº“ä¸­çš„å›¾ç‰‡

è®¿é—®ï¼š
1. http://127.0.0.1:5000/image/image-name
2. http://127.0.0.1:5000/image/random

> [!NOTE] æ³¨æ„äº‹é¡¹
> 1. æ— éœ€å¸¦åç¼€ï¼Œä¾‹å¦‚ `.jpg`ã€`.png` ç­‰

----





ä¸‹é¢ç»™ä½ ä¸€å¥—é€šç”¨çš„æ–¹æ¡ˆï¼ŒæŠŠä½ çš„ Flask è„šæœ¬ä¸Šä¼ åˆ° Ubuntu äº‘æœåŠ¡å™¨å¹¶ä¸”å®ç°å¼€æœºè‡ªå¯åŠ¨ã€‚

---

## ä¸€ã€æŠŠè„šæœ¬å’Œå›¾ç‰‡ç›®å½•ä¼ åˆ°äº‘æœåŠ¡å™¨

1. **æ‰“åŒ…ä»£ç **ï¼ˆåœ¨æœ¬åœ°ï¼‰
    
    ```bash
    cd D:\æ–‡ä»¶é›†åˆ\æœ¬åœ°å›¾åº“
    rem å‡è®¾ä½ çš„è„šæœ¬å« image_server.pyï¼Œæ‰“åŒ…æˆ zip
    powershell Compress-Archive -Path image_server.py -DestinationPath image_server.zip
    ```
    
2. **ç”¨ SCP ä¸Šä¼ åˆ°äº‘æœåŠ¡å™¨**ï¼ˆåœ¨æœ¬åœ° PowerShell æˆ– CMDï¼‰
    
    ```bash
    scp image_server.zip root@117.72.211.221:/home/root/
    ```
    
3. **è§£å‹å¹¶è°ƒæ•´è·¯å¾„**ï¼ˆåœ¨äº‘æœåŠ¡å™¨ï¼‰
    
    ```bash
    cd /home/root
    unzip image_server.zip
    mv æœ¬åœ°å›¾åº“ /home/root/images          # æŠŠ Windows è·¯å¾„æ”¹æˆ Linux ç›®å½•
    sed -i 's|IMAGE_FOLDER = .\+|IMAGE_FOLDER = r"/home/root/images"|' image_server.py
    ```
    

---

## äºŒã€é…ç½® Python ç¯å¢ƒ

```bash
# å®‰è£… Python3 ä¸ venv
sudo apt update
sudo apt install -y python3 python3-venv

# è¿›å…¥é¡¹ç›®ç›®å½•ï¼Œåˆ›å»ºè™šæ‹Ÿç¯å¢ƒ


cd /home/root
python3 -m venv venv
source venv/bin/activate

# å®‰è£…ä¾èµ–
pip install flask
```

æµ‹è¯•è„šæœ¬èƒ½è·‘é€šï¼š

```bash
python image_server.py
# æµè§ˆå™¨æˆ– curl http://127.0.0.1:5000/image/random
```

ç¡®è®¤è¿”å›å›¾ç‰‡æ­£å¸¸åï¼ŒæŒ‰ä¸‹ä¸€æ­¥ã€‚

---

## ä¸‰ã€ç”¨ systemd æŠŠå®ƒåšæˆæœåŠ¡ï¼Œéšå¼€æœºå¯åŠ¨

1. **åˆ›å»º systemd å•å…ƒæ–‡ä»¶**  
    ç¼–è¾‘ `/etc/systemd/system/images.service`ï¼Œå†…å®¹å¦‚ä¸‹ï¼ˆç¡®ä¿è·¯å¾„å’Œç”¨æˆ·éƒ½æ¢æˆå®é™…å€¼ï¼‰ï¼š
    
```ini
    [Unit]
    Description=Flask Image Server
    After=network.target
    
    [Service]
    Type=simple
    WorkingDirectory=/home/root
    User=root
    # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒå¹¶è¿è¡Œè„šæœ¬
    ExecStart=/home/root/venv/bin/python /home/root/image_server.py
    Restart=on-failure
    RestartSec=5s
    
    [Install]
    WantedBy=multi-user.target
```
    
2. **è®© systemd è¯†åˆ«å¹¶å¯åŠ¨**
    
```bash
    sudo systemctl daemon-reload
    sudo systemctl enable images.service
    sudo systemctl start images.service
```
    
3. **æ£€æŸ¥çŠ¶æ€ & æ—¥å¿—**
    
```bash
    sudo systemctl status image_server.service
    sudo journalctl -u image_server.service -f
```
    

---

### å››ã€ï¼ˆå¯é€‰ï¼‰ä½¿ç”¨ Gunicorn + Nginx æå‡ç¨³å®šæ€§

å¦‚æœä½ åç»­æƒ³æ”¾åˆ°å…¬ç½‘å¹¶æ‰¿è½½æ›´é«˜å¹¶å‘ï¼Œå»ºè®®ç”¨ [Gunicorn] + [Nginx]ï¼š

1. `pip install gunicorn`
    
2. åœ¨ systemd çš„ `ExecStart` æ”¹æˆï¼š
    
```
    ExecStart=/home/root/venv/bin/gunicorn -w 4 -b 127.0.0.1:5000 image_server:app
```
    
3. é…ç½® Nginx åå‘ä»£ç† `/etc/nginx/sites-available/image_server`ï¼š
    
```nginx
server {
	listen 80;
	server_name your.domain.com;

	location / {
		proxy_pass http://127.0.0.1:5000;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
	}
}
```
    
    ç„¶å `sudo ln -s â€¦ && sudo nginx -t && sudo systemctl reload nginx`ã€‚
    

---

è¿™æ ·ï¼Œæ¯æ¬¡æœåŠ¡å™¨é‡å¯åï¼Œä½ çš„ Flask ç¨‹åºéƒ½ä¼šè‡ªåŠ¨å¯åŠ¨å¹¶ç›‘å¬ `127.0.0.1:5000`ï¼ˆæˆ–é€šè¿‡ Nginx æš´éœ²ï¼‰ã€‚å¦‚æœæœ‰ç–‘é—®ï¼Œéšæ—¶å‘Šè¯‰æˆ‘ï¼





ä¸‹é¢æŒ‰ç…§ä½ æœ€æ–°çš„ç›®å½•ç»“æ„ï¼Œç»™å‡ºä¸€å¥—å®Œæ•´çš„æ“ä½œæµç¨‹ï¼ˆWord å¼æ ‡å‡†æ­¥éª¤ï¼Œä¸ä½¿ç”¨ Markdownï¼‰ï¼š

1. ä¿®æ”¹è„šæœ¬ä¸­å›¾ç‰‡ç›®å½•è·¯å¾„  
    1.1 ç”¨ç¼–è¾‘å™¨æ‰“å¼€ `/mystudy/images/images.py`  
    1.2 å°†æ–‡ä»¶é¡¶éƒ¨çš„
    
```
    IMAGE_FOLDER = r'D:\æ–‡ä»¶é›†åˆ\æœ¬åœ°å›¾åº“'
```
    
æ”¹ä¸º
    
```
    IMAGE_FOLDER = '/mystudy/images/images'
```
    
1.3 ä¿å­˜å¹¶é€€å‡º
    
2. å‡†å¤‡ Python è™šæ‹Ÿç¯å¢ƒ  
    2.1 åœ¨æœåŠ¡å™¨ä¸Šåˆ‡æ¢åˆ°è„šæœ¬ç›®å½•  
    cd /mystudy/images  
    2.2 åˆ›å»ºå¹¶æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ  
    python3 -m venv venv  
    source venv/bin/activate  
    2.3 å®‰è£…ä¾èµ–  
    pip install flask
    
3. æœ¬åœ°è¿è¡Œæµ‹è¯•  
    3.1 ç¡®è®¤è„šæœ¬èƒ½æ­£ç¡®å¯åŠ¨  
    python images.py  
    3.2 åœ¨å¦ä¸€ç»ˆç«¯æ‰§è¡Œ  
    curl [http://127.0.0.1:5000/image/random](http://127.0.0.1:5000/image/random)  
    â€”â€”è‹¥èƒ½è¿”å›å›¾ç‰‡ï¼Œè¯´æ˜ä¸€åˆ‡æ­£å¸¸  
    3.3 æŒ‰ Ctrl-C åœæ­¢æœåŠ¡
    
4. ä¸ºè„šæœ¬åˆ›å»º systemd æœåŠ¡  
    4.1 æ–°å»ºæ–‡ä»¶ `/etc/systemd/system/images.service`ï¼Œå†…å®¹å¦‚ä¸‹ï¼ˆè¯·é€å­—å¤åˆ¶ï¼‰
    
```
[Unit]
Description=Flask Image Server
After=network.target

[Service]
Type=simple
WorkingDirectory=/mystudy/images
User=root
ExecStart=/mystudy/images/venv/bin/python /mystudy/images/images.py
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
```
    
4.2 ä¿å­˜åæ‰§è¡Œ  
systemctl daemon-reload  
systemctl enable images.service  
systemctl start images.service

5. éªŒè¯æœåŠ¡çŠ¶æ€  
5.1 æŸ¥çœ‹è¿è¡ŒçŠ¶æ€  
systemctl status images.service  
â€”â€”åº”æ˜¾ç¤º Active: active (running)  
5.2 æŸ¥çœ‹å®æ—¶æ—¥å¿—  
journalctl -u images.service -f  
5.3 æµè§ˆå™¨æˆ– curl æµ‹è¯•  
curl [http://127.0.0.1:5000/image/random](http://127.0.0.1:5000/image/random)


å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œæ¯æ¬¡æœåŠ¡å™¨é‡å¯ï¼ŒFlask è„šæœ¬éƒ½ä¼šè‡ªåŠ¨å¯åŠ¨å¹¶ç›‘å¬æœ¬æœº 5000 ç«¯å£ã€‚




éå¸¸å¥½ï¼Œç°åœ¨ä½ çš„ Flask æœåŠ¡å·²ç» **æˆåŠŸå¯åŠ¨å¹¶ç”± systemd æ‰˜ç®¡**ï¼ŒçŠ¶æ€ä¿¡æ¯æ˜¾ç¤ºä¸€åˆ‡æ­£å¸¸ï¼š

```
Active: active (running)
* Running on http://127.0.0.1:5000
```

### âœ… ä¸‹ä¸€æ­¥æ£€æŸ¥

ä½ å¯ä»¥åœ¨äº‘æœåŠ¡å™¨ä¸Šè¯•ä¸€ä¸‹ï¼š

```bash
curl http://127.0.0.1:5000/image/random
```

å¦‚æœä½ çœ‹åˆ°ä¸€å¤§ä¸²ä¹±ç ï¼ˆäºŒè¿›åˆ¶å›¾ç‰‡ï¼‰ï¼Œè¯´æ˜æœåŠ¡æ­£å¸¸ã€‚

```
root@lavm-2xqib0dtxy:~# curl http://127.0.0.1:5000/image/random
Warning: Binary output can mess up your terminal. Use "--output -" to tell 
Warning: curl to output it to your terminal anyway, or consider "--output 
Warning: <FILE>" to save to a file.

```

---

### ğŸŒ å¦‚æœä½ æƒ³è®©å¤–éƒ¨è®¿é—®è¿™ä¸ªæœåŠ¡ï¼Œæœ‰ä¸¤ä¸ªé€‰é¡¹ï¼š

#### âœ… æ–¹å¼ 1ï¼šä¿®æ”¹ Flask ç›‘å¬å…¬ç½‘

1. ä¿®æ”¹ `/mystudy/images/images.py`ï¼š
    
    ```python
    app.run(host='0.0.0.0', port=5000)
    ```
    
2. é‡å¯æœåŠ¡ï¼š
    
    ```bash
    sudo systemctl restart images.service
    ```
    
3. ç¡®ä¿ä½ çš„äº‘æœåŠ¡å™¨é˜²ç«å¢™/å®‰å…¨ç»„å·²å¼€æ”¾ **5000ç«¯å£ï¼ˆTCPï¼‰**ï¼Œä½ å¯ä»¥ç”¨ï¼š
    
    ```bash
    sudo ufw allow 5000/tcp
    ```
    
4. ç°åœ¨ä½ å¯ä»¥åœ¨ä»»æ„æœºå™¨ä¸Šè®¿é—®ï¼š
    
    ```
    http://ä½ çš„äº‘æœåŠ¡å™¨IP:5000/image/random
    ```
    

---

#### âœ… æ–¹å¼ 2ï¼šä¿ç•™å†…ç½‘ç›‘å¬ + ç”¨ Nginx è½¬å‘ï¼ˆæ¨èï¼‰

æ›´å®‰å…¨ã€ä¸“ä¸šçš„åšæ³•æ˜¯ï¼š

1. Flask ä¿æŒç›‘å¬ 127.0.0.1:5000ï¼ˆä¸ç”¨ä¿®æ”¹ï¼‰
    
2. å®‰è£…å¹¶é…ç½® Nginx è½¬å‘å¤–éƒ¨è¯·æ±‚åˆ° Flaskï¼š
    
    ```bash
    sudo apt install nginx
    ```
    
3. ç¼–è¾‘é…ç½®æ–‡ä»¶ `/etc/nginx/sites-available/images`ï¼š
    
    ```
    server {
        listen 80;
        server_name your_domain_or_ip;
    
        location / {
            proxy_pass http://127.0.0.1:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
    ```
    
4. å¯ç”¨ç«™ç‚¹å¹¶é‡å¯ Nginxï¼š
    
    ```bash
    sudo ln -s /etc/nginx/sites-available/images /etc/nginx/sites-enabled/
    sudo nginx -t
    sudo systemctl reload nginx
    ```
    

ç„¶åä½ å°±å¯ä»¥é€šè¿‡ï¼š

```
http://ä½ çš„äº‘æœåŠ¡å™¨IP/
```

æ¥è®¿é—® Flask æä¾›çš„æœåŠ¡äº†ã€‚

---

ä½ ç›®å‰çš„éƒ¨ç½²çŠ¶æ€å·²ç» 90% å®Œæˆï¼Œä¸‹ä¸€æ­¥å°±çœ‹ä½ æ˜¯å¸Œæœ›ã€Œå…¬ç½‘è®¿é—®å›¾ç‰‡ã€ï¼Œè¿˜æ˜¯ã€Œæœ¬åœ°è„šæœ¬è°ƒç”¨ã€æ¥åšä»€ä¹ˆç”¨ï¼Œå¦‚æœéœ€è¦æˆ‘å¯ä»¥å¸®ä½ ç»§ç»­ä¼˜åŒ–éƒ¨ç½²ç»“æ„ã€‚è¦ä¸è¦æˆ‘é¡ºä¾¿ä¹ŸæŠŠ Gunicorn/Nginx ä¸€èµ·ç»™ä½ é…ç½®å¥½ï¼Ÿ


è®¿é—®ï¼š http://117.72.211.221:5000/image/random


