---
title: 笔记：Socket
date: 2025-06-01
categories:
  - 网络服务
tags: 
author: 霸天
layout: post
---


```
[应用层（HTTP、HTTPS、DNS 查询、代码指令）]
   ↑ ↓
[传输层（TCP/UDP/Unix Socket）]
   ↑ ↓
[网络层（IPv4/IPv6 分片、路由）]
   ↑ ↓
[数据链路层（以太网帧 / WiFi 帧）]
   ↑ ↓
[物理层（电流/光信号 / 无线电波）]
```








## DNS 查询全链路剖析

==1.用户发起查询==
当你在浏览器中输入一个域名（例如 `www.example.com`）时，浏览器需要将 `www.example.com` 解析成具体的 IP 地址，然后根据 IP 加 端口进行访问（HTTP 默认 80，HTTPS 默认 443）

> [!NOTE] 注意事项
> 1. HTTP 的默认端口是：80
> 2. HTTPS 的默认端口是：443


==2.浏览器查看自己的 DNS缓存==
浏览器内部会首先在内存中查找 DNS 缓存，如果该域名已经解析过且缓存未过期，则直接使用缓存结果返回，不再进行后续查询。

> [!NOTE] 注意事项
> 1. 若缓存保存在内存中（未持久化），当操作系统（电脑）关闭后，其内存中的 DNS 缓存就会被清空
> 2. Chrome 查询缓存就是存储在浏览器进程的内存中


==3.操作系统检查 Hosts==
若浏览器未在自己的内存中找到 DNS 缓存，它会向操作系统（OS）发出“解析请求”，在操作系统内部，最先被检查的是本地的 `Hosts` 文件（如 Linux 下的 `/etc/hosts`，Windows 下的 `C:\Windows\System32\drivers\etc\hosts`）


==4.操作系统检查自己的 DNS 缓存==
如果 Hosts 文件中没有匹配项，OS 会继续查看它自己维护的 DNS 缓存（由系统级缓存守护进程提供，如 macOS 的 mDNSResponder、Windows 的 DNS Client service，或 Linux 上常见的 systemd-resolved、nscd、dnsmasq 等）


==5.操作系统向 DNS 服务器发起查询==
以上都没命中的话，OS 才会根据 `/etc/resolv.conf` 或系统设置，准备向配置好的 DNS（如运营商 DNS、公共 DNS）发起真实的 UDP（或在必要时 TCP）查询，拿到结果后再缓存到系统级 DNS 缓存，最后返回给浏览器。


==6.操作系统（应用层）构造 DNS 协议报文==






假设你在网络配置中将 BIND DNS 服务器设置为首选 DNS（例如 IP 为 192.168.1.100），而将 Google 的 8.8.8.8 设置为备用 DNS，整个解析过程如下：
1. ==用户发起查询== ：
	1. 当你在浏览器中输入一个域名（例如 `www.baidu.com`）时，浏览器开始向 DNS 系统发起解析请求。
2. ==浏览器 DNS 缓存检查==：
	1. 浏览器内部会首先在内存中查找 DNS 缓存，如果该域名已经解析过且缓存未过期，则直接使用缓存结果返回，不再进行后续查询。
	2. 注意：浏览器关闭后，其内存中的 DNS 缓存就会清空。
3. ==操作系统 DNS 缓存检查==：
	1. 如果浏览器缓存中没有有效记录，操作系统（例如 Linux、Windows、macOS）会检查系统级 DNS 缓存（通常存储在内存中）
	2. 注意：若缓存存储在内存中，操作系统关闭后，其内存中的 DNS 缓存就会被清空
4. ==首选 DNS 服务器介入==
	1. 当本地缓存均未命中时，操作系统将查询请求发送给配置的首选 DNS 服务器，即你部署的 BIND DNS 服务器（通过 UDP 53 端口，必要时使用 TCP 53）
	2. <font color="#00b0f0">BIND DNS 缓存查找</font>：
		1. BIND 首先在自身的内存缓存中查找该域名的解析记录。如果有且未过期，立即返回给操作系统
		2. 如果配置了 `dump-file`（例如 `dump-file "/var/named/data/cache_dump.db";`），BIND 会定期将内存中的缓存持久化到磁盘上，以便在重启后恢复缓存，但实际查询仍以内存数据为主
	3. <font color="#00b0f0">进行权威解析</font>：
		1. BIND 检查自己是否为该域名（例如 `baidu.com`）的权威 DNS 服务器。如果 BIND 是权威服务器，则直接返回 `www.baidu.com` 对应的 IP 地址。
		2. 注意：通常，权威服务器由域名注册方（如`baidu.com` 是由百度公司）提供和管理，负责提供最终解析记录
	4. <font color="#00b0f0">进行递归解析</font>：
		1. 若 BIND 不是 `baidu.com` 的权威服务器，但配置了递归解析功能，则开始以下步骤：
		2. <font color="#7030a0">根服务器查询</font>：
			1. BIND 向全球仅有 13 组的根服务器发起查询，根服务器不保存具体 IP，而只返回顶级域（如 `.com` 或 `.cn`）的位置信息
		3. <font color="#7030a0">TLD 查询</font>：
			1. 根据根服务器的指示，BIND 向 `.com` 顶级域名服务器发出请求，询问 `baidu.com` 的权威 DNS 服务器的地址。
			2. 注意，TLD 服务器同样不存储具体 IP 地址，而是维护其下属二级域名（如 `baidu.com`、`google.com`）的权威 DNS 服务器地址，并指引查询请求前往对应的权威服务器获取最终解析结果。
		4. <font color="#7030a0">权威服务器查询</font>：
			1. TLD 服务器返回 `baidu.com` 的权威服务器地址（如 `ns1.baidu.com`）后，BIND 再向该权威服务器发起查询，最终获得 `www.baidu.com` 的真实 IP 地址
		5. <font color="#7030a0">缓存查询结果</font>：
			1. 获得解析结果后，BIND 会将结果缓存在内存中（并按配置持久化到 `dump-file`，以便后续使用），然后返回给操作系统
5. ==备用 DNS 服务器介入==：
	1. 如果首选 DNS 服务器（你的 BIND）因超时或其它原因无法返回有效结果，操作系统会自动将查询请求转向备用 DNS 服务器，即 Google 的 8.8.8.8。
	2. 8.8.8.8 并非某个域名的权威服务器，而是一个高性能的递归 DNS 服务器集群，依托 Anycast 技术在全球部署。由于其庞大的用户基数，热门域名往往已被缓存，命中率极高，从而减少了向根服务器和 TLD 服务器逐级查询的需求。如果缓存中无匹配记录，8.8.8.8 将按照标准递归解析流程，从根服务器开始查询直至获取最终 IP 地址。
6. ==返回解析结果==：
	1. <font color="#00b0f0">操作系统接受</font>：
		1. 操作系统从首选或备用 DNS 获得域名对应的 IP 地址后，将结果返回给浏览器
	2. <font color="#00b0f0">浏览器建立连接</font>：
		1. 浏览器使用该 IP 地址与目标服务器建立 HTTP/HTTPS 连接（通常是 80/443 端口），进而加载网页内容

> [!NOTE] 注意事项
> 1. <font color="#00b0f0">Anycast 技术</font>：
> 	- Google 在全球部署了数百个 8.8.8.8 服务器节点，并采用 `Anycast` 技术进行流量调度。当你访问 8.8.8.8 时，请求会自动路由到距离你最近的服务器节点。例如，在中国访问时，流量会被引导至亚洲的 Google DNS 集群，而在美国访问时，则会连接到北美的节点。这样可以避免解析请求跨国或跨大洲传输，从而大幅提升解析速度，降低网络延迟
> 2. <font color="#00b0f0">DNS 查询的本质</font>：
> 	- 简单来说，DNS 查询的流程是：首先检查缓存，如果缓存中有结果，则直接返回 IP 地址；如果缓存没有，就会通过其他方法找到该域名的权威 DNS 服务器，查询其区域记录。区域记录中会存储该域名的 IP 地址，查询到后即可返回该 IP 地址。














## 浏览器访问 HTTPS 网站的全链路剖析

### 网站服务器获取 HTTPS 证书

---


### 用户向你的网站发起访问

用户访问你的网站（如 `https://www.example.com`），当用户在地址栏按下回车后，浏览器开始准备与 `www.example.com` 的 TCP 443 端口进行连接。





---















